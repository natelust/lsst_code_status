<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>ip_diffim</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
</head>
<body>
<h1 id="toc_0">Comparison of the ip_diffim repository</h1>

<div style="background-color:Aquamarine; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Summary of Repositories</h1>
<p>
Comparison run at 02:22PM on June 09, 2015<br>
There are <b>2973</b> differences between the two repositories<br><br>
Repository <b>/Users/nate/repos_hsc/ip_diffim/</b> <br> Revision <b>ba3cc03d93eea385436c8055be5ee0765830e4bd</b><br> Branch <b>master</b><br>Last commit was on <b>2015-04-25 13:16:04 -0400</b><br><br>
Repository <b>/Users/nate/repos_lsst/ip_diffim/</b> <br> Revision <b>16ef3cf6b1a52728d2618a6bc6358634ea530fc9</b><br> Branch <b>master</b><br>Last commit was on <b>2015-06-08 16:22:34 -0700</b><br><br>
</p>
</div>

<hr>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_hsc/ip_diffim/</h1>
<h2>src/dipoleAlgorithm.cc</h2>
<pre>
commit ba3cc03d93eea385436c8055be5ee0765830e4bd
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Sat Apr 25 13:16:04 2015 -0400

    Revert config value in test after change in defaults.
    
    We've changed the default for detection.returnOriginalFootprints,
    so we need to change the value in the test back to the old value
    to keep it happy.</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_lsst/ip_diffim/</h1>
<h2>examples/dipoleMeasTask.py</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
<h2>examples/snapPsfMatchTask.py</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
<h2>examples/modelPsfMatchTask.py</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
<h2>examples/imagePsfMatchTask.py</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
<h2>python/lsst/ip/diffim/dipole.i</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
<h2>src/DipoleAlgorithms.cc</h2>
<pre>
commit 16ef3cf6b1a52728d2618a6bc6358634ea530fc9
Merge: b562c8d 48e8530
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Mon Jun 8 16:22:34 2015 -0700

    Merge pull request #2 from lsst/tickets/DM-2636
    
    replace eups.productDir() calls with lsst.utils.getPackageDir(</pre>
</div>

<h1 id="toc_1">List of the files in common<a name="homelist"></a></h1>

<p>Files without links do not differ</p>

<ul>
<li><a href="#doc/doxygen.conf.in"><code>doc/doxygen.conf.in</code></a></li>
<li><code>examples/generateBadMatches1.py</code></li>
<li><code>include/lsst/ip/diffim/BasisLists.h</code></li>
<li><a href="#tests/BuildSingleKernelVisitor.py"><code>tests/BuildSingleKernelVisitor.py</code></a></li>
<li><a href="#python/lsst/ip/diffim/imagePsfMatch.py"><code>python/lsst/ip/diffim/imagePsfMatch.py</code></a></li>
<li><a href="#tests/KernelCandidateDetection.py"><code>tests/KernelCandidateDetection.py</code></a></li>
<li><a href="#tests/KernelCandidateAndSolution.py"><code>tests/KernelCandidateAndSolution.py</code></a></li>
<li><a href="#tests/BasisLists.py"><code>tests/BasisLists.py</code></a></li>
<li><a href="#python/lsst/ip/diffim/diffimLib.i"><code>python/lsst/ip/diffim/diffimLib.i</code></a></li>
<li><code>include/lsst/ip/diffim/KernelSumVisitor.h</code></li>
<li><code>examples/SConscript</code></li>
<li><code>tests/SConscript</code></li>
<li><a href="#tests/dipole.py"><code>tests/dipole.py</code></a></li>
<li><code>include/lsst/ip/diffim/KernelCandidateDetection.h</code></li>
<li><a href="#tests/KernelSumVisitor.py"><code>tests/KernelSumVisitor.py</code></a></li>
<li><a href="#tests/ModelPsfMatch.py"><code>tests/ModelPsfMatch.py</code></a></li>
<li><a href="#examples/jackknifeResampleSpatialKernel.py"><code>examples/jackknifeResampleSpatialKernel.py</code></a></li>
<li><a href="#tests/subtractExposures.py"><code>tests/subtractExposures.py</code></a></li>
<li><code>.gitignore</code></li>
<li><code>python/lsst/gdb/ip/__init__.py</code></li>
<li><code>python/lsst/ip/diffim/detail.i</code></li>
<li><a href="#python/lsst/ip/diffim/dipoleMeasurement.py"><code>python/lsst/ip/diffim/dipoleMeasurement.py</code></a></li>
<li><a href="#ups/ip_diffim.table"><code>ups/ip_diffim.table</code></a></li>
<li><code>examples/runModelToModel.py</code></li>
<li><a href="#examples/runMatchMaskedImages.py"><code>examples/runMatchMaskedImages.py</code></a></li>
<li><a href="#examples/compareKernelSizes.py"><code>examples/compareKernelSizes.py</code></a></li>
<li><code>include/lsst/ip/diffim.h</code></li>
<li><code>include/lsst/ip/diffim/KernelSolution.h</code></li>
<li><a href="#python/lsst/ip/diffim/modelPsfMatch.py"><code>python/lsst/ip/diffim/modelPsfMatch.py</code></a></li>
<li><code>examples/showAlardLupton.py</code></li>
<li><a href="#examples/debugSpatialModel.py"><code>examples/debugSpatialModel.py</code></a></li>
<li><code>python/lsst/ip/diffim/detail/diffimDetailLib.i</code></li>
<li><a href="#examples/runWarpExposure.py"><code>examples/runWarpExposure.py</code></a></li>
<li><a href="#tests/ImageStatistics.py"><code>tests/ImageStatistics.py</code></a></li>
<li><code>python/lsst/gdb/__init__.py</code></li>
<li><code>ups/ip_diffim.build</code></li>
<li><code>include/lsst/ip/diffim/BuildSingleKernelVisitor.h</code></li>
<li><code>python/lsst/gdb/ip/diffim/README</code></li>
<li><code>python/lsst/gdb/ip/diffim/printers.py</code></li>
<li><code>include/lsst/ip/diffim/ImageStatistics.h</code></li>
<li><code>tests/compareToHotpants/templateMI.fits</code></li>
<li><a href="#lib/libip_diffim.so-gdb.py"><code>lib/libip_diffim.so-gdb.py</code></a></li>
<li><code>examples/pixelAccess.cc</code></li>
<li><a href="#include/lsst/ip/diffim/DipoleAlgorithms.h"><code>include/lsst/ip/diffim/DipoleAlgorithms.h</code></a></li>
<li><code>include/lsst/ip/diffim/FindSetBits.h</code></li>
<li><a href="#python/lsst/ip/diffim/snapPsfMatch.py"><code>python/lsst/ip/diffim/snapPsfMatch.py</code></a></li>
<li><code>examples/maskedKernel.cc</code></li>
<li><a href="#python/lsst/ip/diffim/utils.py"><code>python/lsst/ip/diffim/utils.py</code></a></li>
<li><a href="#tests/FindSetBits.py"><code>tests/FindSetBits.py</code></a></li>
<li><a href="#python/lsst/ip/diffim/diaCatalogSourceSelector.py"><code>python/lsst/ip/diffim/diaCatalogSourceSelector.py</code></a></li>
<li><a href="#python/lsst/ip/diffim/diaSourceAnalysis.py"><code>python/lsst/ip/diffim/diaSourceAnalysis.py</code></a></li>
<li><code>src/KernelCandidate.cc</code></li>
<li><code>doc/SConscript</code></li>
<li><a href="#src/AssessSpatialKernelVisitor.cc"><code>src/AssessSpatialKernelVisitor.cc</code></a></li>
<li><code>SConstruct</code></li>
<li><code>python/lsst/gdb/ip/diffim/__init__.py</code></li>
<li><code>examples/runSubtractSnaps.py</code></li>
<li><a href="#examples/compareKernelTypes.py"><code>examples/compareKernelTypes.py</code></a></li>
<li><a href="#src/BuildSingleKernelVisitor.cc"><code>src/BuildSingleKernelVisitor.cc</code></a></li>
<li><a href="#tests/KernelPca.py"><code>tests/KernelPca.py</code></a></li>
<li><a href="#src/BuildSpatialKernelVisitor.cc"><code>src/BuildSpatialKernelVisitor.cc</code></a></li>
<li><code>examples/crossCorrelation.py</code></li>
<li><a href="#examples/compareLambdaTypes.py"><code>examples/compareLambdaTypes.py</code></a></li>
<li><code>include/lsst/ip/diffim/BuildSpatialKernelVisitor.h</code></li>
<li><a href="#python/lsst/ip/diffim/__init__.py"><code>python/lsst/ip/diffim/__init__.py</code></a></li>
<li><a href="#ups/ip_diffim.cfg"><code>ups/ip_diffim.cfg</code></a></li>
<li><a href="#src/KernelCandidateDetection.cc"><code>src/KernelCandidateDetection.cc</code></a></li>
<li><code>examples/generateBadMatches2.py</code></li>
<li><a href="#tests/ImageSubtract.py"><code>tests/ImageSubtract.py</code></a></li>
<li><code>tests/compareToHotpants/scienceMI.fits</code></li>
<li><a href="#examples/comparePcaKernel.py"><code>examples/comparePcaKernel.py</code></a></li>
<li><a href="#tests/diaCatalogSourceSelector.py"><code>tests/diaCatalogSourceSelector.py</code></a></li>
<li><a href="#python/lsst/ip/diffim/kernelCandidateQa.py"><code>python/lsst/ip/diffim/kernelCandidateQa.py</code></a></li>
<li><code>python/lsst/ip/diffim/SConscript</code></li>
<li><code>examples/spatialKernel.cc</code></li>
<li><a href="#python/lsst/ip/diffim/diffimTools.py"><code>python/lsst/ip/diffim/diffimTools.py</code></a></li>
<li><a href="#tests/SnapPsfMatch.py"><code>tests/SnapPsfMatch.py</code></a></li>
<li><code>include/lsst/ip/diffim/KernelCandidate.h</code></li>
<li><a href="#examples/runSubtractMaskedImages.py"><code>examples/runSubtractMaskedImages.py</code></a></li>
<li><code>include/lsst/ip/diffim/KernelPca.h</code></li>
<li><code>lib/SConscript</code></li>
<li><code>python/lsst/__init__.py</code></li>
<li><a href="#tests/BuildSpatialKernelVisitor.py"><code>tests/BuildSpatialKernelVisitor.py</code></a></li>
<li><code>python/lsst/ip/diffim/detail/SConscript</code></li>
<li><a href="#python/lsst/ip/diffim/makeRatingVector.py"><code>python/lsst/ip/diffim/makeRatingVector.py</code></a></li>
<li><a href="#src/KernelPca.cc"><code>src/KernelPca.cc</code></a></li>
<li><code>include/lsst/ip/diffim/AssessSpatialKernelVisitor.h</code></li>
<li><code>src/BasisLists.cc</code></li>
<li><a href="#python/lsst/ip/diffim/psfMatch.py"><code>python/lsst/ip/diffim/psfMatch.py</code></a></li>
<li><a href="#tests/compareToHotpants.py"><code>tests/compareToHotpants.py</code></a></li>
<li><a href="#tests/AssessSpatialKernelVisitor.py"><code>tests/AssessSpatialKernelVisitor.py</code></a></li>
<li><a href="#src/KernelSumVisitor.cc"><code>src/KernelSumVisitor.cc</code></a></li>
<li><code>include/lsst/ip/diffim/ImageSubtract.h</code></li>
<li><a href="#tests/ImagePsfMatch.py"><code>tests/ImagePsfMatch.py</code></a></li>
<li><code>src/ImageSubtract.cc</code></li>
<li><a href="#python/lsst/ip/diffim/makeKernelBasisList.py"><code>python/lsst/ip/diffim/makeKernelBasisList.py</code></a></li>
<li><code>python/lsst/ip/diffim/detail/__init__.py</code></li>
<li><a href="#tests/ipDiffimConfig.py"><code>tests/ipDiffimConfig.py</code></a></li>
<li><a href="#src/KernelSolution.cc"><code>src/KernelSolution.cc</code></a></li>
<li><a href="#examples/runSubtractExposures.py"><code>examples/runSubtractExposures.py</code></a></li>
<li><code>python/lsst/ip/__init__.py</code></li>
</ul>

<h1 id="toc_2"><a name="tests/BuildSingleKernelVisitor.py"/></a>tests/BuildSingleKernelVisitor.py</h1>

<h3 id="toc_3">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c96bb23c">c96bb23c</a> - import os, sys</div>
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#0dd5cee9">0dd5cee9</a> - import lsst.afw.display.ds9 as ds9</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#966eaa96">966eaa96</a> + #import lsst.afw.display.ds9 as ds9</div>
              ? +
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "DF"
                        self.subconfig = self.config.kernel.active
                
                        self.policy = pexConfig.makePolicy(self.subconfig)
                
                        self.policy.set("useRegularization", False)
                        self.policy.set("checkConditionNumber", False) # I am making shady kernels by hand
                        self.policy.set("useCoreStats", False) # I am making off-center resids
                        self.kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        self.size = 51
                        
                    def makeCandidate(self, kSum, x, y):
                        mi1 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi1.getVariance().set(1.0) # avoid NaNs
                        mi1.set(self.size//2, self.size//2, (1, 0x0, 1))
                        mi2 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi2.getVariance().set(1.0) # avoid NaNs
                        mi2.set(self.size//2, self.size//2, (kSum, 0x0, kSum))
                        kc = ipDiffim.makeKernelCandidate(x, y, mi1, mi2, self.policy)
                
                        return kc
                
                
                    def testWithOneBasis(self):
                        self.runWithOneBasis(False)
                        self.runWithOneBasis(True)
                        
                    def runWithOneBasis(self, useRegularization):
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                
                        if useRegularization:
                            hMat = ipDiffim.makeRegularizationMatrix(self.policy)
                            bskv = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy, hMat)
                        else:
                            bskv = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                
                        bskv.processCandidate(kc1)
                        bskv.processCandidate(kc2)
                        bskv.processCandidate(kc3)
                
                        # Initialized
                        self.assertEqual(kc1.isInitialized(), True)
                        self.assertEqual(kc2.isInitialized(), True)
                        self.assertEqual(kc3.isInitialized(), True)
                
                        # Is a solution
                        try:
                            kc1.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                            kc2.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                            kc3.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                        except Exception, e:
                            print e
                            self.fail()
                
                        # Its not the Pca one
                        try:
                            kc1.getKernelSolution(ipDiffim.KernelCandidateF.PCA)
                            kc2.getKernelSolution(ipDiffim.KernelCandidateF.PCA)
                            kc3.getKernelSolution(ipDiffim.KernelCandidateF.PCA)
                        except Exception, e:
                            pass
                        else:
                            self.fail()
                
                        # Processed all of them
                        self.assertEqual(bskv.getNProcessed(), 3)
                
                        # Rejected none
                        self.assertEqual(bskv.getNRejected(), 0)
                
                        # Skips built candidates
                        bskv.reset()
                        bskv.setSkipBuilt(True)
                        bskv.processCandidate(kc1)
                        bskv.processCandidate(kc2)
                        bskv.processCandidate(kc3)
                        # Processed none of them
                        self.assertEqual(bskv.getNProcessed(), 0)
                        
                        
                    def testWithThreeBases(self):
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                        bskv1 = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                        bskv1.processCandidate(kc1)
                        bskv1.processCandidate(kc2)
                        bskv1.processCandidate(kc3)
                        self.assertEqual(bskv1.getNProcessed(), 3)
                
                        # make sure orig solution is the current one
                        soln1_1 = kc1.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId()
                        soln2_1 = kc2.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId()
                        soln3_1 = kc3.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId()
                        self.assertEqual(soln1_1, kc1.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln2_1, kc2.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln3_1, kc3.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        
                        # do pca basis; visit manually since visitCandidates is still broken
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.KernelPcaVisitorF(imagePca)
                        kpv.processCandidate(kc1)
                        kpv.processCandidate(kc2)
                        kpv.processCandidate(kc3)
                        kpv.subtractMean()
                        imagePca.analyze()
                        eigenKernels = afwMath.KernelList()
                        eigenKernels.push_back(kpv.getEigenKernels()[0])
                        self.assertEqual(len(eigenKernels), 1) # the other eKernels are 0.0 and you can't get their coeffs!
                
                
                        # do twice to mimic a Pca loop
                        bskv2 = ipDiffim.BuildSingleKernelVisitorF(eigenKernels, self.policy)
                        bskv2.setSkipBuilt(False)
                        bskv2.processCandidate(kc1)
                        bskv2.processCandidate(kc2)
                        bskv2.processCandidate(kc3)
                        self.assertEqual(bskv2.getNProcessed(), 3)
                        
                        soln1_2 = kc1.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        soln2_2 = kc2.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        soln3_2 = kc3.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        # pca is recent
                        self.assertEqual(soln1_2, kc1.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln2_2, kc2.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln3_2, kc3.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        # orig is still orig
                        self.assertEqual(soln1_1, kc1.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId())
                        self.assertEqual(soln2_1, kc2.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId())
                        self.assertEqual(soln3_1, kc3.getKernelSolution(ipDiffim.KernelCandidateF.ORIG).getId())
                        # pca is not orig
                        self.assertNotEqual(soln1_2, soln1_1)
                        self.assertNotEqual(soln2_2, soln2_1)
                        self.assertNotEqual(soln3_2, soln3_1)
                
                
                        
                        # do twice to mimic a Pca loop
                        bskv3 = ipDiffim.BuildSingleKernelVisitorF(eigenKernels, self.policy)
                        bskv3.setSkipBuilt(False)
                        bskv3.processCandidate(kc1)
                        bskv3.processCandidate(kc2)
                        bskv3.processCandidate(kc3)
                        self.assertEqual(bskv3.getNProcessed(), 3)
                
                        soln1_3 = kc1.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        soln2_3 = kc2.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        soln3_3 = kc3.getKernelSolution(ipDiffim.KernelCandidateF.PCA).getId()
                        # pca is recent
                        self.assertEqual(soln1_3, kc1.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln2_3, kc2.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        self.assertEqual(soln3_3, kc3.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getId())
                        # pca is not previous pca
                        self.assertNotEqual(soln1_2, soln1_3)
                        self.assertNotEqual(soln2_2, soln2_3)
                        self.assertNotEqual(soln3_2, soln3_3)
                
                        
                    def testRejection(self):
                        # we need to construct a candidate whose shape does not
                        # match the underlying basis
                        # 
                        # so lets just make a kernel list with all the power in
                        # the center, but the candidate requires some off center
                        # power
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                        bskv1 = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                        bskv1.processCandidate(kc1)
                        bskv1.processCandidate(kc2)
                        bskv1.processCandidate(kc3)            
                        
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.KernelPcaVisitorF(imagePca)
                        kpv.processCandidate(kc1)
                        kpv.processCandidate(kc2)
                        kpv.processCandidate(kc3)
                        kpv.subtractMean()
                        imagePca.analyze()
                        eigenKernels = afwMath.KernelList()
                        eigenKernels.push_back(kpv.getEigenKernels()[0])
                        self.assertEqual(len(eigenKernels), 1)
                
                        # bogus candidate
                        mi1 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi1.getVariance().set(0.1)
                        mi1.set(self.size//2, self.size//2, (1, 0x0, 1))
                        mi2 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi2.getVariance().set(0.1)
                        # make it high enough to make the mean resids large
                        mi2.set(self.size//3, self.size//3, (self.size**2, 0x0, 1)) 
                        kc4 = ipDiffim.makeKernelCandidate(0, 0, mi1, mi2, self.policy)
                        self.assertEqual(kc4.getStatus(), afwMath.SpatialCellCandidate.UNKNOWN)
                
                        # process with eigenKernels
                        bskv2 = ipDiffim.BuildSingleKernelVisitorF(eigenKernels, self.policy)
                        bskv2.setSkipBuilt(False)
                        bskv2.processCandidate(kc1)
                        bskv2.processCandidate(kc2)
                        bskv2.processCandidate(kc3)
                        bskv2.processCandidate(kc4)
                
                        self.assertEqual(bskv2.getNProcessed(), 4)
                        self.assertEqual(bskv2.getNRejected(), 1)
                
                        self.assertEqual(kc1.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                        self.assertEqual(kc2.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                        self.assertEqual(kc3.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                        self.assertEqual(kc4.getStatus(), afwMath.SpatialCellCandidate.BAD)
                
                        
                    def testVisit(self, nCell = 3):
                        bskv = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                
                        sizeCellX = self.policy.get("sizeCellX")
                        sizeCellY = self.policy.get("sizeCellY")
                        
                        kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0, 0),
                                                                             afwGeom.Extent2I(sizeCellX * nCell,
                                                                                              sizeCellY * nCell)),
                                                               sizeCellX,
                                                               sizeCellY)
                        nTot = 0
                        for candX in range(nCell):
                            for candY in range(nCell):
                                if candX == nCell // 2 and candY == nCell // 2:
                                    kc = self.makeCandidate(100.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                else:
                                    kc = self.makeCandidate(1.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                kernelCellSet.insertCandidate(kc)
                                nTot += 1
                                
                        kernelCellSet.visitCandidates(bskv, 1)
                        self.assertEqual(bskv.getNProcessed(), nTot)
                        self.assertEqual(bskv.getNRejected(), 0)
                
                        for cell in kernelCellSet.getCellList():
                            for cand in cell.begin(False):
                                cand = ipDiffim.cast_KernelCandidateF(cand)
                                self.assertEqual(cand.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                
                
                    def tearDown(self):
                        del self.config
                        del self.policy
                        del self.kList
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="0dd5cee9"/></a>0dd5cee9</h3>

<pre>
commit 0dd5cee9bf7e24a40d6ca8abf457b37f3d3603bc
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Dec 9 23:24:14 2010 +0000

    Working on failing unit tests.  #1140.
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_4"><a name="python/lsst/ip/diffim/imagePsfMatch.py"/></a>python/lsst/ip/diffim/imagePsfMatch.py</h1>

<h3 id="toc_5">Diff:</h3>

<pre>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#3c6e3b17">3c6e3b17</a> - #</div>
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import numpy as np
                import lsst.daf.base as dafBase
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.geom as afwGeom
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#e2e589f5">e2e589f5</a> - import lsst.afw.detection as afwDetect</div>
                import lsst.pipe.base as pipeBase
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#3c6e3b17">3c6e3b17</a> - from lsst.meas.algorithms import (SourceDetectionTask, SourceMeasurementTask,</div>
              ?                                  -                     ^  ------------ ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#c0b62a68">c0b62a68</a> + from lsst.meas.algorithms import SourceDetectionTask, getBackground</div>
              ?                                                       ^^^^^^^^^   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#3c6e3b17">3c6e3b17</a> -                                   getBackground, BackgroundConfig)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#966eaa96">966eaa96</a> + from lsst.meas.base import SingleFrameMeasurementTask</div>
                from .makeKernelBasisList import makeKernelBasisList
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#d0a8d025">d0a8d025</a> - from .psfMatch import PsfMatch, PsfMatchConfigDF, PsfMatchConfigAL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#b5208fc7">b5208fc7</a> + from .psfMatch import PsfMatchTask, PsfMatchConfigDF, PsfMatchConfigAL</div>
              ?                               ++++
                from . import utils as diUtils 
                from . import diffimLib
                from . import diffimTools
                import lsst.afw.display.ds9 as ds9
                
                sigma2fwhm = 2. * np.sqrt(2. * np.log(2.))
                
                class ImagePsfMatchConfig(pexConfig.Config):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#8b7f49ff">8b7f49ff</a> +     """!Configuration for image-to-image Psf matching"""</div>
                    kernel = pexConfig.ConfigChoiceField(
                        doc="kernel type",
                        typemap=dict(
                            AL=PsfMatchConfigAL,
                            DF=PsfMatchConfigDF
                        ),
                        default="AL",
                    )
                    selectDetection = pexConfig.ConfigurableField(
                        target=SourceDetectionTask,
                        doc="Initial detections used to feed stars to kernel fitting",
                    )
                    selectMeasurement = pexConfig.ConfigurableField(
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#3c6e3b17">3c6e3b17</a> -         target=SourceMeasurementTask,</div>
              ?                 ^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#c0b62a68">c0b62a68</a> +         target=SingleFrameMeasurementTask,</div>
              ?                 ^^^^^^ ^^
                        doc="Initial measurements used to feed stars to kernel fitting",
                    )
                
                    def setDefaults(self):
                        # High sigma detections only
                        self.selectDetection.reEstimateBackground = False
                        self.selectDetection.thresholdValue = 10.0
                
                        # Minimal set of measurments for star selection
                        self.selectMeasurement.algorithms.names.clear()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#3c6e3b17">3c6e3b17</a> -         self.selectMeasurement.algorithms.names = ('flux.psf', 'flags.pixel', 'shape.sdss',</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#c0b62a68">c0b62a68</a> +         self.selectMeasurement.algorithms.names = ('base_SdssCentroid', 'base_PsfFlux', 'base_PixelFlags',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#e4ff6f80">e4ff6f80</a> -                                                    'flux.gaussian', 'skycoord')</div>
              ?                                                     ^^^^^^              ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#c0b62a68">c0b62a68</a> +                                                    'base_SdssShape', 'base_GaussianFlux', 'base_SkyCoord')</div>
              ?                                                     ^^^^^^^^^^^^^^^^^^^^^^^^       ++++    ++ +++  ^
                        self.selectMeasurement.slots.modelFlux = None
                        self.selectMeasurement.slots.apFlux = None
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#0bcc245e">0bcc245e</a> -         self.selectMeasurement.slots.calibFlux = None</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#b5208fc7">b5208fc7</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#b5208fc7">b5208fc7</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#b5208fc7">b5208fc7</a> + ## \page ImagePsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#b5208fc7">b5208fc7</a> + ## \ref ImagePsfMatchTask_ "ImagePsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#b5208fc7">b5208fc7</a> + ## \copybrief ImagePsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#b5208fc7">b5208fc7</a> + ## \}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#77ece2b8">77ece2b8</a> - class ImagePsfMatchTask(PsfMatch):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#ea0a71c3">ea0a71c3</a> + class ImagePsfMatchTask(PsfMatchTask):</div>
              ?                                 ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#f4985e17">f4985e17</a> -     """PSF-match images to reference images</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#f4985e17">f4985e17</a> -     Fits the following model:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#f4985e17">f4985e17</a> -     image to not convolve = (image to convolve convolved with PSF matching kernel) + background model</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#f4985e17">f4985e17</a> -     """</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#b5208fc7">b5208fc7</a> +     """!</div>
              ?        +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#b5208fc7">b5208fc7</a> + \anchor ImagePsfMatchTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#b5208fc7">b5208fc7</a> + \brief Psf-match two MaskedImages or Exposures using the sources in the images</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#f4985e17">f4985e17</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Contents Contents</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Purpose</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Initialize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_IO</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Config</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#b5208fc7">b5208fc7</a> +  - \ref ip_diffim_imagepsfmatch_Example</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Purpose   Description</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#b5208fc7">b5208fc7</a> + Build a Psf-matching kernel using two input images, either as MaskedImages (in which case they need</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#b5208fc7">b5208fc7</a> +     to be astrometrically aligned) or Exposures (in which case astrometric alignment will happen by</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#b5208fc7">b5208fc7</a> +     default but may be turned off).  This requires a list of input Sources which may be provided</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#b5208fc7">b5208fc7</a> + by the calling Task; if not, the Task will perform a coarse source detection and selection for this purpose.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#b5208fc7">b5208fc7</a> + Sources are vetted for signal-to-noise and masked pixels (in both the template and science image), and </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#b5208fc7">b5208fc7</a> + substamps around each acceptable source are extracted and used to create an instance of KernelCandidate.  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#b5208fc7">b5208fc7</a> + Each KernelCandidate is then placed within a lsst.afw.math.SpatialCellSet, which is used by an ensemble of </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#b5208fc7">b5208fc7</a> + lsst.afw.math.CandidateVisitor instances to build the Psf-matching kernel.   These visitors include, in </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#b5208fc7">b5208fc7</a> + the order that they are called: BuildSingleKernelVisitor, KernelSumVisitor, BuildSpatialKernelVisitor, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#b5208fc7">b5208fc7</a> + and AssessSpatialKernelVisitor.  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#b5208fc7">b5208fc7</a> + Sigma clipping of KernelCandidates is performed as follows: </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#b5208fc7">b5208fc7</a> +  - BuildSingleKernelVisitor, using the substamp diffim residuals from the per-source kernel fit,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#b5208fc7">b5208fc7</a> +     if PsfMatchConfig.singleKernelClipping is True</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#b5208fc7">b5208fc7</a> +  - KernelSumVisitor, using the mean and standard deviation of the kernel sum from all candidates,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#b5208fc7">b5208fc7</a> +     if PsfMatchConfig.kernelSumClipping is True</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#b5208fc7">b5208fc7</a> +  - AssessSpatialKernelVisitor, using the substamp diffim ressiduals from the spatial kernel fit,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#b5208fc7">b5208fc7</a> +     if PsfMatchConfig.spatialKernelClipping is True</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#b5208fc7">b5208fc7</a> + The actual solving for the kernel (and differential background model) happens in </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#b5208fc7">b5208fc7</a> + lsst.ip.diffim.PsfMatchTask._solve.  This involves a loop over the SpatialCellSet that first builds the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#b5208fc7">b5208fc7</a> + per-candidate matching kernel for the requested number of KernelCandidates per cell </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#b5208fc7">b5208fc7</a> + (PsfMatchConfig.nStarPerCell).  The quality of this initial per-candidate difference image is examined, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#b5208fc7">b5208fc7</a> + using moments of the pixel residuals in the difference image normalized by the square root of the variance </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#b5208fc7">b5208fc7</a> + (i.e. sigma); ideally this should follow a normal (0, 1) distribution, but the rejection thresholds are set </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#b5208fc7">b5208fc7</a> + by the config (PsfMatchConfig.candidateResidualMeanMax and PsfMatchConfig.candidateResidualStdMax).  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#b5208fc7">b5208fc7</a> + All candidates that pass this initial build are then examined en masse to find the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#b5208fc7">b5208fc7</a> + mean/stdev of the kernel sums across all candidates.  Objects that are significantly above or below the mean, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#b5208fc7">b5208fc7</a> + typically due to variability or sources that are saturated in one image but not the other, are also rejected.  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#b5208fc7">b5208fc7</a> + This threshold is defined by PsfMatchConfig.maxKsumSigma.  Finally, a spatial model is built using all</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#b5208fc7">b5208fc7</a> + currently-acceptable candidates, and the spatial model used to derive a second set of (spatial) residuals</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#b5208fc7">b5208fc7</a> + which are again used to reject bad candidates, using the same thresholds as above.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Initialize    Task initialization</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#b5208fc7">b5208fc7</a> + \copydoc \_\_init\_\_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_IO        Invoking the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#b5208fc7">b5208fc7</a> + There is no run() method for this Task.  Instead there are 4 methods that</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#b5208fc7">b5208fc7</a> + may be used to invoke the Psf-matching.  These are</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#b5208fc7">b5208fc7</a> + \link lsst.ip.diffim.imagePsfMatch.ImagePsfMatchTask.matchMaskedImages matchMaskedImages\endlink,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#b5208fc7">b5208fc7</a> + \link lsst.ip.diffim.imagePsfMatch.ImagePsfMatchTask.subtractMaskedImages subtractMaskedImages\endlink,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#b5208fc7">b5208fc7</a> + \link lsst.ip.diffim.imagePsfMatch.ImagePsfMatchTask.matchExposures matchExposures\endlink, and </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#b5208fc7">b5208fc7</a> + \link lsst.ip.diffim.imagePsfMatch.ImagePsfMatchTask.subtractExposures subtractExposures\endlink.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#b5208fc7">b5208fc7</a> + The methods that operate on lsst.afw.image.MaskedImage require that the images already be astrometrically</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#b5208fc7">b5208fc7</a> + aligned, and are the same shape.  The methods that operate on lsst.afw.image.Exposure allow for the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#b5208fc7">b5208fc7</a> + input images to be misregistered and potentially be different sizes; by default a </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#b5208fc7">b5208fc7</a> + lsst.afw.math.LanczosWarpingKernel is used to perform the astrometric alignment.  The methods </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#b5208fc7">b5208fc7</a> + that "match" images return a Psf-matched image, while the methods that "subtract" images </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#b5208fc7">b5208fc7</a> + return a Psf-matched and template subtracted image.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#b5208fc7">b5208fc7</a> + See each method's returned lsst.pipe.base.Struct for more details.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Config       Configuration parameters</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#b5208fc7">b5208fc7</a> + See \ref ImagePsfMatchConfig</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Metadata   Quantities set in Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#b5208fc7">b5208fc7</a> + See \ref ip_diffim_psfmatch_Metadata "PsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Debug     Debug variables</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#b5208fc7">b5208fc7</a> + The \link lsst.pipe.base.cmdLineTask.CmdLineTask command line task\endlink interface supports a</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#b5208fc7">b5208fc7</a> + flag \c -d/--debug to import \b debug.py from your \c PYTHONPATH.  The relevant contents of debug.py </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#b5208fc7">b5208fc7</a> + for this Task include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#b5208fc7">b5208fc7</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#b5208fc7">b5208fc7</a> +     import sys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#b5208fc7">b5208fc7</a> +     import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#b5208fc7">b5208fc7</a> +     def DebugInfo(name):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#b5208fc7">b5208fc7</a> +         di = lsstDebug.getInfo(name)   </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#25cc187d">25cc187d</a> +         if name == "lsst.ip.diffim.psfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#68061043">68061043</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#25cc187d">25cc187d</a> +             di.maskTransparency = 80          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#25cc187d">25cc187d</a> +             di.displayCandidates = True       # show all the candidates and residuals</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#25cc187d">25cc187d</a> +             di.displayKernelBasis = False     # show kernel basis functions</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#25cc187d">25cc187d</a> +             di.displayKernelMosaic = True     # show kernel realized across the image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#25cc187d">25cc187d</a> +             di.plotKernelSpatialModel = False # show coefficients of spatial model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#25cc187d">25cc187d</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#25cc187d">25cc187d</a> +         elif name == "lsst.ip.diffim.imagePsfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#68061043">68061043</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#b5208fc7">b5208fc7</a> +             di.maskTransparency = 30          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#b5208fc7">b5208fc7</a> +             di.displayTemplate = True         # show full (remapped) template</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#b5208fc7">b5208fc7</a> +             di.displaySciIm = True            # show science image to match to</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#b5208fc7">b5208fc7</a> +             di.displaySpatialCells = True     # show spatial cells</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#b5208fc7">b5208fc7</a> +             di.displayDiffIm = True           # show difference image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#b5208fc7">b5208fc7</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green) </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#b5208fc7">b5208fc7</a> +         elif name == "lsst.ip.diffim.diaCatalogSourceSelector":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#68061043">68061043</a> +             di.display = False                # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#b5208fc7">b5208fc7</a> +             di.maskTransparency = 30          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#b5208fc7">b5208fc7</a> +             di.displayExposure = True         # show exposure with candidates indicated</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#b5208fc7">b5208fc7</a> +             di.pauseAtEnd = False             # pause when done</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#b5208fc7">b5208fc7</a> +         return di</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#b5208fc7">b5208fc7</a> +     lsstDebug.Info = DebugInfo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#b5208fc7">b5208fc7</a> +     lsstDebug.frame = 1      </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#b5208fc7">b5208fc7</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#25cc187d">25cc187d</a> + Note that if you want addional logging info, you may add to your scripts:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#25cc187d">25cc187d</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#25cc187d">25cc187d</a> + import lsst.pex.logging as pexLog</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#25cc187d">25cc187d</a> + pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#25cc187d">25cc187d</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#25cc187d">25cc187d</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#b5208fc7">b5208fc7</a> + \section ip_diffim_imagepsfmatch_Example   A complete example of using ImagePsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#b5208fc7">b5208fc7</a> + This code is imagePsfMatchTask.py in the examples directory, and can be run as \em e.g.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#b5208fc7">b5208fc7</a> + \code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#b5208fc7">b5208fc7</a> + examples/imagePsfMatchTask.py --debug </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#b5208fc7">b5208fc7</a> + examples/imagePsfMatchTask.py --debug --mode="matchExposures"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#b5208fc7">b5208fc7</a> + examples/imagePsfMatchTask.py --debug --template /path/to/templateExp.fits --science /path/to/scienceExp.fits</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#b5208fc7">b5208fc7</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#b5208fc7">b5208fc7</a> + \dontinclude imagePsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#b5208fc7">b5208fc7</a> + Create a subclass of ImagePsfMatchTask that allows us to either match exposures, or subtract exposures:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#b5208fc7">b5208fc7</a> + \skip MyImagePsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#b5208fc7">b5208fc7</a> + \until self.subtractExposures</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#b5208fc7">b5208fc7</a> + And allow the user the freedom to either run the script in default mode, or point to their own images on disk.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#b5208fc7">b5208fc7</a> + Note that these images must be readable as an lsst.afw.image.Exposure:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#b5208fc7">b5208fc7</a> + \skip main</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#b5208fc7">b5208fc7</a> + \until parse_args</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#b5208fc7">b5208fc7</a> + We have enabled some minor display debugging in this script via the --debug option.  However, if you </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#b5208fc7">b5208fc7</a> + have an lsstDebug debug.py in your PYTHONPATH you will get additional debugging displays.  The following</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#b5208fc7">b5208fc7</a> + block checks for this script:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#b5208fc7">b5208fc7</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#b5208fc7">b5208fc7</a> + \until sys.stderr</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#b5208fc7">b5208fc7</a> + \dontinclude imagePsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#b5208fc7">b5208fc7</a> + Finally, we call a run method that we define below.  First set up a Config and modify some of the parameters.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#b5208fc7">b5208fc7</a> + E.g. use an "Alard-Lupton" sum-of-Gaussian basis, fit for a differential background, and use low order spatial</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#b5208fc7">b5208fc7</a> + variation in the kernel and background:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#b5208fc7">b5208fc7</a> + \skip run(args)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#b5208fc7">b5208fc7</a> + \until spatialBgOrder</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#b5208fc7">b5208fc7</a> + Make sure the images (if any) that were sent to the script exist on disk and are readable.  If no images</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#b5208fc7">b5208fc7</a> + are sent, make some fake data up for the sake of this example script (have a look at the code if you want</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#b5208fc7">b5208fc7</a> + more details on generateFakeImages):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#b5208fc7">b5208fc7</a> + \skip requested</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#b5208fc7">b5208fc7</a> + \until sizeCellY</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#b5208fc7">b5208fc7</a> + Create and run the Task:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#b5208fc7">b5208fc7</a> + \skip Create</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#b5208fc7">b5208fc7</a> + \until args.mode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#b5208fc7">b5208fc7</a> + And finally provide some optional debugging displays:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#b5208fc7">b5208fc7</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#b5208fc7">b5208fc7</a> + \until result.subtractedExposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#b5208fc7">b5208fc7</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#b5208fc7">b5208fc7</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#b5208fc7">b5208fc7</a> +     """    </div>
                    ConfigClass = ImagePsfMatchConfig
                
                    def __init__(self, *args, **kwargs):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#f4985e17">f4985e17</a> -         """Create a PsfMatchToImage</div>
              ?                    ^         --- ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#b5208fc7">b5208fc7</a> +         """!Create the ImagePsfMatchTask</div>
              ?            +       ++++++ ^^          ^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#6c0e8620">6c0e8620</a> -         @param config: see lsst.ip.diffim.PsfMatchConfig</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#f4985e17">f4985e17</a> -         @param logName: name by which messages are logged</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#b5208fc7">b5208fc7</a> +         \param *args arguments to be passed to lsst.ip.diffim.PsfMatchTask.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#b5208fc7">b5208fc7</a> +         \param **kwargs keyword arguments to be passed to lsst.ip.diffim.PsfMatchTask.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#3c6e3b17">3c6e3b17</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#b5208fc7">b5208fc7</a> +         Upon initialization, the kernel configuration is defined by self.config.kernel.active.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#b5208fc7">b5208fc7</a> +         The task creates an lsst.afw.math.Warper from the subConfig self.config.kernel.active.warpingConfig.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#b5208fc7">b5208fc7</a> +         A schema for the selection and measurement of candidate lsst.ip.diffim.KernelCandidates is</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#b5208fc7">b5208fc7</a> +         defined, and used to initize subTasks selectDetection (for candidate detection) and selectMeasurement</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#b5208fc7">b5208fc7</a> +         (for candidate measurement).</div>
                        """
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#77ece2b8">77ece2b8</a> -         PsfMatch.__init__(self, *args, **kwargs)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#ea0a71c3">ea0a71c3</a> +         PsfMatchTask.__init__(self, *args, **kwargs)</div>
              ?                 ++++
                        self.kConfig = self.config.kernel.active
                        self._warper = afwMath.Warper.fromConfig(self.kConfig.warpingConfig)
                        self.selectSchema = afwTable.SourceTable.makeMinimalSchema()
                        self.selectAlgMetadata = dafBase.PropertyList()
                        self.makeSubtask("selectDetection", schema=self.selectSchema)
                        self.makeSubtask("selectMeasurement", schema=self.selectSchema, algMetadata=self.selectAlgMetadata)
                
                    def getFwhmPix(self, psf):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#66ee18e0">66ee18e0</a> -         """Return the FWHM in pixels of a Psf"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#b5208fc7">b5208fc7</a> +         """!Return the FWHM in pixels of a Psf"""</div>
              ?            +
                        sigPix = psf.computeShape().getDeterminantRadius()
                        return sigPix * sigma2fwhm
                
                    @pipeBase.timeMethod
                    def matchExposures(self, templateExposure, scienceExposure,
                                       templateFwhmPix=None, scienceFwhmPix=None,
                                       candidateList=None, doWarping=True, convolveTemplate=True):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#f4985e17">f4985e17</a> -         """Warp and PSF-match an exposure to the reference</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#b5208fc7">b5208fc7</a> +         """!Warp and PSF-match an exposure to the reference</div>
              ?            +
                
                        Do the following, in order:
                        - Warp templateExposure to match scienceExposure,
                            if doWarping True and their WCSs do not already match
                        - Determine a PSF matching kernel and differential background model
                            that matches templateExposure to scienceExposure
                        - Convolve templateExposure by PSF matching kernel
                
                        @param templateExposure: Exposure to warp and PSF-match to the reference masked image
                        @param scienceExposure: Exposure whose WCS and PSF are to be matched to
                        @param templateFwhmPix: FWHM (in pixels) of the Psf in the template image (image to convolve)
                        @param scienceFwhmPix: FWHM (in pixels) of the Psf in the science image
                        @param candidateList: a list of footprints/maskedImages for kernel candidates; 
                                              if None then source detection is run.
                            - Currently supported: list of Footprints or measAlg.PsfCandidateF
                        @param doWarping: what to do if templateExposure's and scienceExposure's WCSs do not match:
                            - if True then warp templateExposure to match scienceExposure
                            - if False then raise an Exception
                        @param convolveTemplate: convolve the template image or the science image
                            - if True, templateExposure is warped if doWarping, templateExposure is convolved
                            - if False, templateExposure is warped if doWarping, scienceExposure is convolved
                
                        @return a pipeBase.Struct containing these fields:
                        - matchedImage: the PSF-matched exposure =
                            warped templateExposure convolved by psfMatchingKernel. This has:
                            - the same parent bbox, Wcs and Calib as scienceExposure
                            - the same filter as templateExposure
                            - no Psf (because the PSF-matching process does not compute one)
                        - psfMatchingKernel: the PSF matching kernel
                        - backgroundModel: differential background model
                        - kernelCellSet: SpatialCellSet used to solve for the PSF matching kernel
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#ec2f65f1">ec2f65f1</a> -         @raise RuntimeError if doWarping is False and templateExposure's and scienceExposure's</div>
              ?         ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#b5208fc7">b5208fc7</a> +         Raise a RuntimeError if doWarping is False and templateExposure's and scienceExposure's</div>
              ?         ^    ++
                            WCSs do not match
                        """
                        if not self._validateWcs(templateExposure, scienceExposure):
                            if doWarping:
                                self.log.info("Astrometrically registering template to science image")
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#68061043">68061043</a> +                 templatePsf = templateExposure.getPsf()</div>
                                templateExposure = self._warper.warpExposure(scienceExposure.getWcs(),
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#3c6e3b17">3c6e3b17</a> -                     templateExposure, destBBox=scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#9250fe88">9250fe88</a> +                     templateExposure, destBBox=scienceExposure.getBBox())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#68061043">68061043</a> +                 templateExposure.setPsf(templatePsf)</div>
                            else:
                                pexLog.Trace(self.log.getName(), 1, "ERROR: Input images not registered")
                                raise RuntimeError("Input images not registered")
                        if templateFwhmPix is None:
                            if not templateExposure.hasPsf():
                                self.log.warn("No estimate of Psf FWHM for template image")
                            else:
                                templateFwhmPix = self.getFwhmPix(templateExposure.getPsf())
                
                        if scienceFwhmPix is None:
                            if not scienceExposure.hasPsf():
                                self.log.warn("No estimate of Psf FWHM for science image")
                            else:
                                scienceFwhmPix = self.getFwhmPix(scienceExposure.getPsf())
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
354  <a href="#9624237e">9624237e</a> + </div>
                        kernelSize = makeKernelBasisList(self.kConfig, templateFwhmPix, scienceFwhmPix)[0].getWidth()
                        candidateList = self.makeCandidateList(templateExposure, scienceExposure, kernelSize, candidateList)
                
                        if convolveTemplate:
                            results = self.matchMaskedImages(
                                templateExposure.getMaskedImage(), scienceExposure.getMaskedImage(), candidateList,
                                templateFwhmPix=templateFwhmPix, scienceFwhmPix=scienceFwhmPix)
                        else:
                            results = self.matchMaskedImages(
                                scienceExposure.getMaskedImage(), templateExposure.getMaskedImage(), candidateList,
                                templateFwhmPix=scienceFwhmPix, scienceFwhmPix=templateFwhmPix)
                
                        psfMatchedExposure = afwImage.makeExposure(results.matchedImage, scienceExposure.getWcs())
                        psfMatchedExposure.setFilter(templateExposure.getFilter())
                        psfMatchedExposure.setCalib(scienceExposure.getCalib())
                        results.warpedExposure  = templateExposure
                        results.matchedExposure = psfMatchedExposure
                        return results
                
                    @pipeBase.timeMethod
                    def matchMaskedImages(self, templateMaskedImage, scienceMaskedImage, candidateList,
                                          templateFwhmPix=None, scienceFwhmPix=None):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#ec2f65f1">ec2f65f1</a> -         """PSF-match a MaskedImage (templateMaskedImage) to a reference MaskedImage (scienceMaskedImage)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
377  <a href="#b5208fc7">b5208fc7</a> +         """!PSF-match a MaskedImage (templateMaskedImage) to a reference MaskedImage (scienceMaskedImage)</div>
              ?            +
                
                        Do the following, in order:
                        - Determine a PSF matching kernel and differential background model
                            that matches templateMaskedImage to scienceMaskedImage
                        - Convolve templateMaskedImage by the PSF matching kernel
                
                        @param templateMaskedImage: masked image to PSF-match to the reference masked image;
                            must be warped to match the reference masked image
                        @param scienceMaskedImage: maskedImage whose PSF is to be matched to
                        @param templateFwhmPix: FWHM (in pixels) of the Psf in the template image (image to convolve)
                        @param scienceFwhmPix: FWHM (in pixels) of the Psf in the science image
                        @param candidateList: a list of footprints/maskedImages for kernel candidates; 
                                              if None then source detection is run.
                            - Currently supported: list of Footprints or measAlg.PsfCandidateF
                
                        @return a pipeBase.Struct containing these fields:
                        - psfMatchedMaskedImage: the PSF-matched masked image =
                            templateMaskedImage convolved with psfMatchingKernel.
                            This has the same xy0, dimensions and wcs as scienceMaskedImage.
                        - psfMatchingKernel: the PSF matching kernel
                        - backgroundModel: differential background model
                        - kernelCellSet: SpatialCellSet used to solve for the PSF matching kernel
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#f4985e17">f4985e17</a> -         @raise RuntimeError if input images have different dimensions</div>
              ?         ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
401  <a href="#b5208fc7">b5208fc7</a> +         Raise a RuntimeError if input images have different dimensions</div>
              ?         ^    ++
                        """
                
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                        displayTemplate = lsstDebug.Info(__name__).displayTemplate
                        displaySciIm = lsstDebug.Info(__name__).displaySciIm
                        displaySpatialCells = lsstDebug.Info(__name__).displaySpatialCells
                        maskTransparency = lsstDebug.Info(__name__).maskTransparency
                        if not maskTransparency:
                            maskTransparency = 0
                        ds9.setMaskTransparency(maskTransparency)
                
                        if not candidateList:
                            raise RuntimeError("Candidate list must be populated by makeCandidateList")
                
                        if not self._validateSize(templateMaskedImage, scienceMaskedImage):
                            pexLog.Trace(self.log.getName(), 1, "ERROR: Input images different size")
                            raise RuntimeError("Input images different size")
                
                        if display and displayTemplate:
                            ds9.mtv(templateMaskedImage, frame=lsstDebug.frame, title="Image to convolve")
                            lsstDebug.frame += 1
                
                        if display and  displaySciIm:
                            ds9.mtv(scienceMaskedImage, frame=lsstDebug.frame, title="Image to not convolve")
                            lsstDebug.frame += 1
                
                        kernelCellSet = self._buildCellSet(templateMaskedImage,
                                                           scienceMaskedImage,
                                                           candidateList)
                
                        if display and displaySpatialCells:
                            diUtils.showKernelSpatialCells(scienceMaskedImage, kernelCellSet,
                                                           symb="o", ctype=ds9.CYAN, ctypeUnused=ds9.YELLOW, ctypeBad=ds9.RED,
                                                           size=4, frame=lsstDebug.frame, title="Image to not convolve")
                            lsstDebug.frame += 1
                
                        if templateFwhmPix and scienceFwhmPix:
                            self.log.info("Matching Psf FWHM %.2f -> %.2f pix" % (templateFwhmPix, scienceFwhmPix))
                
                        if self.kConfig.useBicForKernelBasis:
                            tmpKernelCellSet = self._buildCellSet(templateMaskedImage,
                                                                  scienceMaskedImage,
                                                                  candidateList)
                            nbe = diffimTools.NbasisEvaluator(self.kConfig, templateFwhmPix, scienceFwhmPix)
                            bicDegrees = nbe(tmpKernelCellSet, self.log)
                            basisList = makeKernelBasisList(self.kConfig, templateFwhmPix, scienceFwhmPix,
                                                            alardDegGauss=bicDegrees[0], metadata=self.metadata)
                            del tmpKernelCellSet
                        else:
                            basisList = makeKernelBasisList(self.kConfig, templateFwhmPix, scienceFwhmPix,
                                                            metadata=self.metadata)
                
                        spatialSolution, psfMatchingKernel, backgroundModel = self._solve(kernelCellSet, basisList)
                
                
                
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#ec2f65f1">ec2f65f1</a> -         psfMatchedMaskedImage = afwImage.MaskedImageF(templateMaskedImage.getBBox(afwImage.PARENT))</div>
              ?                                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
460  <a href="#9250fe88">9250fe88</a> +         psfMatchedMaskedImage = afwImage.MaskedImageF(templateMaskedImage.getBBox())</div>
                        doNormalize = False
                        afwMath.convolve(psfMatchedMaskedImage, templateMaskedImage, psfMatchingKernel, doNormalize)
                        return pipeBase.Struct(
                            matchedImage=psfMatchedMaskedImage,
                            psfMatchingKernel=psfMatchingKernel,
                            backgroundModel=backgroundModel,
                            kernelCellSet=kernelCellSet,
                        )
                
                    @pipeBase.timeMethod
                    def subtractExposures(self, templateExposure, scienceExposure,
                                          templateFwhmPix=None, scienceFwhmPix=None,
                                          candidateList=None, doWarping=True, convolveTemplate=True):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#f4985e17">f4985e17</a> -         """Subtract two Exposures</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
474  <a href="#8b7f49ff">8b7f49ff</a> +         """!Register, Psf-match and subtract two Exposures</div>
                
                        Do the following, in order:
                        - Warp templateExposure to match scienceExposure, if their WCSs do not already match
                        - Determine a PSF matching kernel and differential background model
                            that matches templateExposure to scienceExposure
                        - PSF-match templateExposure to scienceExposure
                        - Compute subtracted exposure (see return values for equation).
                
                        @param templateExposure: exposure to PSF-match to scienceExposure
                        @param scienceExposure: reference Exposure
                        @param templateFwhmPix: FWHM (in pixels) of the Psf in the template image (image to convolve)
                        @param scienceFwhmPix: FWHM (in pixels) of the Psf in the science image
                        @param candidateList: a list of footprints/maskedImages for kernel candidates;
                                              if None then source detection is run.
                            - Currently supported: list of Footprints or measAlg.PsfCandidateF
                        @param doWarping: what to do if templateExposure's and scienceExposure's WCSs do not match:
                            - if True then warp templateExposure to match scienceExposure
                            - if False then raise an Exception
                        @param convolveTemplate: convolve the template image or the science image
                            - if True, templateExposure is warped if doWarping, templateExposure is convolved
                            - if False, templateExposure is warped if doWarping, scienceExposure is convolved
                
                        @return a pipeBase.Struct containing these fields:
                        - subtractedExposure: subtracted Exposure = scienceExposure - (matchedImage + backgroundModel)
                        - matchedImage: templateExposure after warping to match templateExposure (if doWarping true),
                            and convolving with psfMatchingKernel
                        - psfMatchingKernel: PSF matching kernel
                        - backgroundModel: differential background model
                        - kernelCellSet: SpatialCellSet used to determine PSF matching kernel
                        """
                        results = self.matchExposures(
                            templateExposure=templateExposure,
                            scienceExposure=scienceExposure,
                            templateFwhmPix=templateFwhmPix,
                            scienceFwhmPix=scienceFwhmPix,
                            candidateList=candidateList,
                            doWarping=doWarping,
                            convolveTemplate=convolveTemplate
                        )
                
                        subtractedExposure = afwImage.ExposureF(scienceExposure, True)
                        if convolveTemplate:
                            subtractedMaskedImage  = subtractedExposure.getMaskedImage()
                            subtractedMaskedImage -= results.matchedExposure.getMaskedImage()
                            subtractedMaskedImage -= results.backgroundModel
                        else:
                            subtractedExposure.setMaskedImage(results.warpedExposure.getMaskedImage())
                            subtractedMaskedImage  = subtractedExposure.getMaskedImage()
                            subtractedMaskedImage -= results.matchedExposure.getMaskedImage()
                            subtractedMaskedImage -= results.backgroundModel
                
                            # Preserve polarity of differences
                            subtractedMaskedImage *= -1
                
                            # Place back on native photometric scale
                            subtractedMaskedImage /= results.psfMatchingKernel.computeImage(
                                afwImage.ImageD(results.psfMatchingKernel.getDimensions()), False)
                
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                        displayDiffIm = lsstDebug.Info(__name__).displayDiffIm
                        maskTransparency = lsstDebug.Info(__name__).maskTransparency
                        if not maskTransparency:
                            maskTransparency = 0
                        ds9.setMaskTransparency(maskTransparency)
                        if display and displayDiffIm:
                            ds9.mtv(templateExposure, frame=lsstDebug.frame, title="Template")
                            lsstDebug.frame += 1
                            ds9.mtv(results.matchedExposure, frame=lsstDebug.frame, title="Matched template")
                            lsstDebug.frame += 1
                            ds9.mtv(scienceExposure, frame=lsstDebug.frame, title="Science Image")
                            lsstDebug.frame += 1
                            ds9.mtv(subtractedExposure, frame=lsstDebug.frame, title="Difference Image")
                            lsstDebug.frame += 1
                
                        results.subtractedExposure = subtractedExposure
                        return results
                
                    @pipeBase.timeMethod
                    def subtractMaskedImages(self, templateMaskedImage, scienceMaskedImage, candidateList,
                            templateFwhmPix=None, scienceFwhmPix=None):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
362  <a href="#f4985e17">f4985e17</a> -         """Subtract two MaskedImages</div>
              ?            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
556  <a href="#8b7f49ff">8b7f49ff</a> +         """!Psf-match and subtract two MaskedImages</div>
              ?            ^^^^^^^^^^^^^^^^
                
                        Do the following, in order:
                        - PSF-match templateMaskedImage to scienceMaskedImage
                        - Determine the differential background
                        - Return the difference: scienceMaskedImage -
                            ((warped templateMaskedImage convolved with psfMatchingKernel) + backgroundModel)
                
                        @param templateMaskedImage: MaskedImage to PSF-match to scienceMaskedImage
                        @param scienceMaskedImage: reference MaskedImage
                        @param templateFwhmPix: FWHM (in pixels) of the Psf in the template image (image to convolve)
                        @param scienceFwhmPix: FWHM (in pixels) of the Psf in the science image
                        @param candidateList: a list of footprints/maskedImages for kernel candidates;
                                              if None then source detection is run.
                            - Currently supported: list of Footprints or measAlg.PsfCandidateF
                
                        @return a pipeBase.Struct containing these fields:
                        - subtractedMaskedImage = scienceMaskedImage - (matchedImage + backgroundModel)
                        - matchedImage: templateMaskedImage convolved with psfMatchingKernel
                        - psfMatchingKernel: PSF matching kernel
                        - backgroundModel: differential background model
                        - kernelCellSet: SpatialCellSet used to determine PSF matching kernel
                        """
                        if not candidateList:
                            raise RuntimeError("Candidate list must be populated by makeCandidateList")
                
                        results = self.matchMaskedImages(
                            templateMaskedImage=templateMaskedImage,
                            scienceMaskedImage=scienceMaskedImage,
                            candidateList=candidateList,
                            templateFwhmPix=templateFwhmPix,
                            scienceFwhmPix=scienceFwhmPix,
                            )
                
                        subtractedMaskedImage  = afwImage.MaskedImageF(scienceMaskedImage, True)
                        subtractedMaskedImage -= results.matchedImage
                        subtractedMaskedImage -= results.backgroundModel
                        results.subtractedMaskedImage = subtractedMaskedImage
                
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                        displayDiffIm = lsstDebug.Info(__name__).displayDiffIm
                        maskTransparency = lsstDebug.Info(__name__).maskTransparency
                        if not maskTransparency:
                            maskTransparency = 0
                        ds9.setMaskTransparency(maskTransparency)
                        if display and displayDiffIm:
                            ds9.mtv(subtractedMaskedImage, frame=lsstDebug.frame)
                            lsstDebug.frame += 1
                
                        return results
                
                    def getSelectSources(self, exposure, sigma=None, doSmooth=True, idFactory=None):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
415  <a href="#3c6e3b17">3c6e3b17</a> -         """Get sources to use for Psf-matching</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
609  <a href="#b5208fc7">b5208fc7</a> +         """!Get sources to use for Psf-matching</div>
              ?            +
                
                        This method runs detection and measurement on an exposure.
                        The returned set of sources will be used as candidates for
                        Psf-matching.
                
                        @param exposure: Exposure on which to run detection/measurement
                        @param sigma: Detection threshold
                        @param doSmooth: Whether or not to smooth the Exposure with Psf before detection
                        @param idFactory: Factory for the generation of Source ids
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
425  <a href="#3c6e3b17">3c6e3b17</a> -         @param binSize: Binsize for background subtraction of Exposure</div>
                
                        @return source catalog containing candidates for the Psf-matching
                        """
                
                        if idFactory:
                            table = afwTable.SourceTable.make(self.selectSchema, idFactory)
                        else:
                            table = afwTable.SourceTable.make(self.selectSchema)
                        mi = exposure.getMaskedImage()
                
                        imArr = mi.getImage().getArray()
                        maskArr = mi.getMask().getArray()
                        miArr = np.ma.masked_array(imArr, mask=maskArr)
                        try:
                            bkgd = getBackground(mi, self.kConfig.afwBackgroundConfig).getImageF()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
441  <a href="#51d717fe">51d717fe</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
634  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            self.log.warn("Failed to get background model.  Falling back to median background estimation")
                            bkgd = np.ma.extras.median(miArr)
                
                
                        #Take off background for detection
                        mi -= bkgd
                        try:
                            table.setMetadata(self.selectAlgMetadata) 
                            detRet = self.selectDetection.makeSourceCatalog(
                                table=table,
                                exposure=exposure,
                                sigma=sigma,
                                doSmooth=doSmooth
                                )
                            selectSources = detRet.sources
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
457  <a href="#66ee18e0">66ee18e0</a> -             self.selectMeasurement.measure(exposure, selectSources)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
650  <a href="#9624237e">9624237e</a> +             self.selectMeasurement.run(measCat=selectSources, exposure=exposure)</div>
                        finally:
                            # Put back on the background in case it is needed down stream
                            mi += bkgd
                            del bkgd
                        return selectSources
                
                    def makeCandidateList(self, templateExposure, scienceExposure, kernelSize, candidateList=None):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
658  <a href="#8b7f49ff">8b7f49ff</a> +         """!Make a list of acceptable KernelCandidates</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
659  <a href="#8b7f49ff">8b7f49ff</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
465  <a href="#3c6e3b17">3c6e3b17</a> -         """Accept or generate a list of candidate sources for</div>
              ?         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
660  <a href="#8b7f49ff">8b7f49ff</a> +         Accept or generate a list of candidate sources for</div>
                        Psf-matching, and examine the Mask planes in both of the
                        images for indications of bad pixels
                
                        @param templateExposure: Exposure that will be convolved
                        @param scienceExposure: Exposure that will be matched-to
                        @param kernelSize: Dimensions of the Psf-matching Kernel, used to grow detection footprints
                        @param candidateList: List of Sources to examine
                
                        @return a list of dicts having a "source" and "footprint"
                        field for the Sources deemed to be appropriate for Psf
                        matching
                        """
                        if candidateList is None:
                            candidateList = self.getSelectSources(scienceExposure)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
675  <a href="#b3a497e9">b3a497e9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
676  <a href="#9624237e">9624237e</a> +         if len(candidateList) < 1:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
677  <a href="#9624237e">9624237e</a> +             raise RuntimeError("No candidates in candidateList")</div>
                
                        listTypes = set(type(x) for x in candidateList)
                        if (not len(listTypes) == 1) or (type(listTypes.pop()) != type(afwTable.SourceRecord)):
                            raise RuntimeError("Can only make candidate list from set of SourceRecords.  Got %s instead." \
                                                   % (type(candidateList[0])))
                        candidateList = diffimTools.sourceToFootprintList(candidateList,
                                                                          templateExposure, scienceExposure,
                                                                          kernelSize,
                                                                          self.kConfig.detectionConfig,
                                                                          self.log)
                        if len(candidateList) == 0:
                            raise RuntimeError("Cannot find any objects suitable for KernelCandidacy")
                
                        return candidateList
                
                    def _adaptCellSize(self, candidateList):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
496  <a href="#44b49b55">44b49b55</a> -         """ NOT IMPLEMENTED YET"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
694  <a href="#b5208fc7">b5208fc7</a> +         """! NOT IMPLEMENTED YET"""</div>
              ?            +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
497  <a href="#82ca02cf">82ca02cf</a> -         nCand = len(candidateList)</div>
                        return self.kConfig.sizeCellX, self.kConfig.sizeCellY
                
                    def _buildCellSet(self, templateMaskedImage, scienceMaskedImage, candidateList):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
501  <a href="#f4985e17">f4985e17</a> -         """Build a SpatialCellSet for use with the solve method</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
698  <a href="#b5208fc7">b5208fc7</a> +         """!Build a SpatialCellSet for use with the solve method</div>
              ?            +
                
                        @param templateMaskedImage: MaskedImage to PSF-matched to scienceMaskedImage
                        @param scienceMaskedImage: reference MaskedImage
                        @param candidateList: a list of footprints/maskedImages for kernel candidates;
                                              if None then source detection is run.
                            - Currently supported: list of Footprints or measAlg.PsfCandidateF
                
                        @return kernelCellSet: a SpatialCellSet for use with self._solve
                        """
                        if not candidateList:
                            raise RuntimeError("Candidate list must be populated by makeCandidateList")
                
                        sizeCellX, sizeCellY = self._adaptCellSize(candidateList)
                
                        # Object to store the KernelCandidates for spatial modeling
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
517  <a href="#ec2f65f1">ec2f65f1</a> -         kernelCellSet = afwMath.SpatialCellSet(templateMaskedImage.getBBox(afwImage.PARENT),</div>
              ?                                                                            ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
714  <a href="#9250fe88">9250fe88</a> +         kernelCellSet = afwMath.SpatialCellSet(templateMaskedImage.getBBox(),</div>
                                                               sizeCellX, sizeCellY)
                
                        policy = pexConfig.makePolicy(self.kConfig)
                        # Place candidates within the spatial grid
                        for cand in candidateList:
                            bbox = cand['footprint'].getBBox()
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
525  <a href="#ec2f65f1">ec2f65f1</a> -             tmi  = afwImage.MaskedImageF(templateMaskedImage, bbox, afwImage.PARENT)</div>
              ?                                                                   -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
722  <a href="#9250fe88">9250fe88</a> +             tmi  = afwImage.MaskedImageF(templateMaskedImage, bbox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
526  <a href="#ec2f65f1">ec2f65f1</a> -             smi  = afwImage.MaskedImageF(scienceMaskedImage, bbox, afwImage.PARENT)</div>
              ?                                                                  -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
723  <a href="#9250fe88">9250fe88</a> +             smi  = afwImage.MaskedImageF(scienceMaskedImage, bbox)</div>
                            cand = diffimLib.makeKernelCandidate(cand['source'], tmi, smi, policy)
                
                            self.log.logdebug("Candidate %d at %f, %f" % (cand.getId(), cand.getXCenter(), cand.getYCenter()))
                            kernelCellSet.insertCandidate(cand)
                
                        return kernelCellSet
                
                    def _validateSize(self, templateMaskedImage, scienceMaskedImage):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
535  <a href="#ff220272">ff220272</a> -         """Return True if two image-like objects are the same size</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
732  <a href="#b5208fc7">b5208fc7</a> +         """!Return True if two image-like objects are the same size</div>
              ?            +
                        """
                        return templateMaskedImage.getDimensions() == scienceMaskedImage.getDimensions()
                
                    def _validateWcs(self, templateExposure, scienceExposure):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
540  <a href="#d6757607">d6757607</a> -         """Return True if the WCS of the two Exposures have the same origin and extent</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
737  <a href="#b5208fc7">b5208fc7</a> +         """!Return True if the WCS of the two Exposures have the same origin and extent</div>
              ?            +
                        """
                        templateWcs    = templateExposure.getWcs() 
                        scienceWcs     = scienceExposure.getWcs()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
544  <a href="#ec2f65f1">ec2f65f1</a> -         templateBBox   = templateExposure.getBBox(afwImage.PARENT)</div>
              ?                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
741  <a href="#9250fe88">9250fe88</a> +         templateBBox   = templateExposure.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
545  <a href="#ec2f65f1">ec2f65f1</a> -         scienceBBox    = scienceExposure.getBBox(afwImage.PARENT)</div>
              ?                                                  ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
742  <a href="#9250fe88">9250fe88</a> +         scienceBBox    = scienceExposure.getBBox()</div>
                
                        # LLC
                        templateOrigin = templateWcs.pixelToSky(afwGeom.Point2D(templateBBox.getBegin()))
                        scienceOrigin  = scienceWcs.pixelToSky(afwGeom.Point2D(scienceBBox.getBegin()))
                
                        # URC
                        templateLimit  = templateWcs.pixelToSky(afwGeom.Point2D(templateBBox.getEnd()))
                        scienceLimit   = scienceWcs.pixelToSky(afwGeom.Point2D(scienceBBox.getEnd()))
                
                        self.log.info("Template Wcs : %f,%f -> %f,%f" %
                                      (templateOrigin[0], templateOrigin[1],
                                       templateLimit[0], templateLimit[1]))
                        self.log.info("Science Wcs : %f,%f -> %f,%f" %
                                      (scienceOrigin[0], scienceOrigin[1],
                                       scienceLimit[0], scienceLimit[1]))
                
                        templateBBox = afwGeom.Box2D(templateOrigin.getPosition(), templateLimit.getPosition())
                        scienceBBox  = afwGeom.Box2D(scienceOrigin.getPosition(), scienceLimit.getPosition())
                        if not (templateBBox.overlaps(scienceBBox)):
                            raise RuntimeError("Input images do not overlap at all")
                
                        if ( (templateOrigin.getPosition() != scienceOrigin.getPosition()) or
                             (templateLimit.getPosition()  != scienceLimit.getPosition())  or
                             (templateExposure.getDimensions() != scienceExposure.getDimensions())):
                            return False
                        return True
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="77ece2b8"/></a>77ece2b8</h3>

<pre>
commit 77ece2b8bf9aab07a7b5c50492a86a2cbc5ae32d
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 16:41:56 2012 -0800

    Initial work on making stages pipeBase.Tasks.
</pre>
<h3><a name="66ee18e0"/></a>66ee18e0</h3>

<pre>
commit 66ee18e036066f62dc6b114417ceaeb9b1b657a3
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 17:23:40 2013 -0700

    Moving calculation of Psf FWHM into subroutine, and background subtraction into a try block, to address more #2822 comments
</pre>
<h3><a name="e4ff6f80"/></a>e4ff6f80</h3>

<pre>
commit e4ff6f806dcb36c2405a8b7b3876fbca29374989
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 15 16:09:20 2013 -0800

    Added missing imports and fixed line lengths.  #2636
</pre>
<h3><a name="d6757607"/></a>d6757607</h3>

<pre>
commit d6757607d4cc6bda4a93fe0c1dbb2042e15ff0ba
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jan 8 10:15:53 2013 -0800

    Modified _validateWcs description; replaced print with log calls
</pre>
<h3><a name="d0a8d025"/></a>d0a8d025</h3>

<pre>
commit d0a8d0254f22daa45f892028cd7de33e07433d10
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Mar 1 16:24:33 2012 -0600

    Changes during coding of pipe_tasks tickets/1732
</pre>
<h3><a name="ff220272"/></a>ff220272</h3>

<pre>
commit ff2202729761b848f39992157126ed47d518aacf
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 14 14:17:10 2012 -0700

    Modified ImagePsfMatchTask as follows:
    - The four main methods originally called by run now return Structs so they are easier to use
    - Deprecated the run method (log a warning)
    - The subtract methods return the matched image
</pre>
<h3><a name="82ca02cf"/></a>82ca02cf</h3>

<pre>
commit 82ca02cfaad85a1fa8c007ba366b598ec07035c6
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Sep 20 16:47:16 2012 -0500

    Renamed footprints to candidateList
</pre>
<h3><a name="6c0e8620"/></a>6c0e8620</h3>

<pre>
commit 6c0e86208a8d9faa0707a44b415bb3c51559787c
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 11:18:27 2012 -0800

    Fixing formatting and removing all policy refs from psfMatch.
</pre>
<h3><a name="e2e589f5"/></a>e2e589f5</h3>

<pre>
commit e2e589f5af7e82fe6d8a0c8720c57417d73bc05b
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Sep 25 19:55:34 2012 -0500

    Accept list of Kernel Candidates for Psf matching.
</pre>
<h3><a name="51d717fe"/></a>51d717fe</h3>

<pre>
commit 51d717febe7c1b75c1afe93f5a98f01bb3b0d868
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Oct 24 16:54:17 2013 -0700

    Modifications to unit test ImagePsfMatch, fixing bugs in teh background subtraction of templates and type checking in getSelectSources, for the candidate list in makeCandidateList
</pre>
<h3><a name="0bcc245e"/></a>0bcc245e</h3>

<pre>
commit 0bcc245e9dbff086f29d34d9ee837e2ddcc4c902
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Dec 11 10:07:28 2014 -0500

    Adapt to addition of CalibFlux slot.
</pre>
<h3><a name="f4985e17"/></a>f4985e17</h3>

<pre>
commit f4985e17583972906ac5f8eeab3604304c0fed49
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 1 14:33:01 2012 -0800

    Converting to new swig; initial conversion to pex_config.
</pre>
<h3><a name="ec2f65f1"/></a>ec2f65f1</h3>

<pre>
commit ec2f65f1f72311b644f7ab2640a9f7f96912fdf4
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jan 8 14:36:44 2013 -0800

    Renaming of variables from e.g. "exposure to convolve" to "template exposure".  reads far easier.
</pre>
<h3><a name="44b49b55"/></a>44b49b55</h3>

<pre>
commit 44b49b55e61f889daba432ff51fea6bf1cef6155
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 15 11:02:49 2012 -0800

    Addressed a couple outstanding issues (nan in stats; stub for adaptive cell size; exiting too early when no spatial candidates) while I'm here.
</pre>
<h3><a name="3c6e3b17"/></a>3c6e3b17</h3>

<pre>
commit 3c6e3b171e276226d9832eec500f6bfc0700d9f0
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 15:35:53 2013 -0700

    Addressed all ticket comments from Paul and Serge.  Will build and run unit tests next.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="ea0a71c3"/></a>ea0a71c3</h3>

<pre>
commit ea0a71c39d9756c68dec41b2a16516d0015e5bf2
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jul 29 14:07:41 2014 -0700

    Renaming PsfMatch to PsfMatchTask within ip_diffim; PsfMatch=PsfMatchTask makes this change transparent for other packages
</pre>
<h3><a name="9624237e"/></a>9624237e</h3>

<pre>
commit 9624237e7f716fe6d3d68c664f8e0094298d7256
Author: Russell Owen <rowen@uw.edu>
Date:   Mon Mar 16 17:37:24 2015 -0700

    Fix a broken test and correct misordered arguments
</pre>
<h3><a name="8b7f49ff"/></a>8b7f49ff</h3>

<pre>
commit 8b7f49ff55c0cee47bd9688aa1017e14c72faaac
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:33:58 2014 -0700

    Fixing first-line of doxygen comments for PsfMatch methods
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
<h3><a name="68061043"/></a>68061043</h3>

<pre>
commit 68061043a76a0b92034dac1516e8d5b2cff3c5ec
Author: Andy Becker <acbecker@gmail.com>
Date:   Sun Aug 10 16:10:32 2014 -0700

    Adding Psf to the warped image in imagePsfMatch
</pre>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
<h3><a name="25cc187d"/></a>25cc187d</h3>

<pre>
commit 25cc187d60610c7a2389ea668fed73d484c06aae
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:23:44 2014 -0700

    Added addditional debugging and logging descriptions to the doxygen
</pre>
<h3><a name="f4985e17"/></a>f4985e17</h3>

<pre>
commit f4985e17583972906ac5f8eeab3604304c0fed49
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 1 14:33:01 2012 -0800

    Converting to new swig; initial conversion to pex_config.
</pre>
<h3><a name="b3a497e9"/></a>b3a497e9</h3>

<pre>
commit b3a497e98a5a28c0b7056eb58696f12cee049dad
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Thu Feb 14 16:26:34 2013 -0800

    Fixed unit tests and added detection and measurement code
</pre>
<h3><a name="b5208fc7"/></a>b5208fc7</h3>

<pre>
commit b5208fc704fc7aa1e617e3178a7b0462359ecb19
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 16:29:53 2014 -0700

    Initial Task documentation for ImagePsfMatchTask
</pre>
<h3><a name="3c6e3b17"/></a>3c6e3b17</h3>

<pre>
commit 3c6e3b171e276226d9832eec500f6bfc0700d9f0
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 15:35:53 2013 -0700

    Addressed all ticket comments from Paul and Serge.  Will build and run unit tests next.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_6"><a name="tests/KernelCandidateDetection.py"/></a>tests/KernelCandidateDetection.py</h1>

<h3 id="toc_7">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import os, sys
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#f144933a">f144933a</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 3)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.subconfig = self.config.kernel.active
                        self.policy    = pexConfig.makePolicy(self.subconfig)
                        self.kSize     = self.policy.getInt('kernelSize')
                
                        # gaussian reference kernel
                        self.gSize         = self.kSize
                        self.gaussFunction = afwMath.GaussianFunction2D(2, 3)
                        self.gaussKernel   = afwMath.AnalyticKernel(self.gSize, self.gSize, self.gaussFunction)
                
                        # known input images
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#48e85303">48e85303</a> +         try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#f144933a">f144933a</a> -         self.defDataDir = eups.productDir('afwdata')</div>
              ?                           ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#48e85303">48e85303</a> +             self.defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ? ++++                          ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#48e85303">48e85303</a> +         except Exception:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#48e85303">48e85303</a> +             self.defDataDir = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#48e85303">48e85303</a> + </div>
                        if self.defDataDir:
                            defImagePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                        "v5-e0-c011-a00.sci.fits")
                            self.templateImage  = afwImage.MaskedImageF(defImagePath)
                            self.scienceImage   = self.templateImage.Factory( self.templateImage.getDimensions() )
                            
                            afwMath.convolve(self.scienceImage, self.templateImage, self.gaussKernel, False)
                
                    def tearDown(self):
                        del self.config
                        del self.policy
                        del self.gaussFunction
                        del self.gaussKernel
                        if self.defDataDir:
                            del self.templateImage
                            del self.scienceImage 
                
                    def testGetCollection(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up; not running KernelCandidateDetection.py"
                            return
                
                        # NOTE - you need to subtract off background from the image
                        # you run detection on.  Here it is the template.
                        bgConfig = self.subconfig.afwBackgroundConfig
                        diffimTools.backgroundSubtract(bgConfig, [self.templateImage,])
                
                        detConfig = self.subconfig.detectionConfig
                        maskPlane = detConfig.badMaskPlanes[0]
                        maskVal   = afwImage.MaskU.getPlaneBitMask(maskPlane)
                
                        kcDetect = ipDiffim.KernelCandidateDetectionF(pexConfig.makePolicy(detConfig))
                        kcDetect.apply(self.templateImage, self.scienceImage)
                        fpList1 = kcDetect.getFootprints()
                
                        self.assertTrue(len(fpList1) != 0)
                
                        for fp in fpList1:
                            bbox = fp.getBBox()
                            tmi  = afwImage.MaskedImageF(self.templateImage, bbox, afwImage.LOCAL)
                            smi  = afwImage.MaskedImageF(self.scienceImage, bbox, afwImage.LOCAL)
                            tmask = tmi.getMask()
                            smask = smi.getMask()
                
                            for j in range(tmask.getHeight()):
                                for i in range(tmask.getWidth()):
                                    # No masked pixels in either image
                                    self.assertEqual(tmask.get(i, j), 0)
                                    self.assertEqual(smask.get(i, j), 0)
                
                        # add a masked pixel to the template image and make sure you don't get it
                        afwImage.MaskedImageF(self.templateImage, fpList1[0].getBBox(), afwImage.LOCAL).getMask().set(
                            tmask.getWidth()//2, tmask.getHeight()//2, maskVal)
                        kcDetect.apply(self.templateImage, self.scienceImage)
                        fpList2 = kcDetect.getFootprints()
                        self.assertTrue(len(fpList2) == (len(fpList1)-1))
                
                        # add a masked pixel to the science image and make sure you don't get it
                        afwImage.MaskedImageF(self.scienceImage, fpList1[1].getBBox(), afwImage.LOCAL).getMask().set(
                            smask.getWidth()//2, smask.getHeight()//2, maskVal)
                        afwImage.MaskedImageF(self.scienceImage, fpList1[2].getBBox(), afwImage.LOCAL).getMask().set(
                            smask.getWidth()//2, smask.getHeight()//2, maskVal)
                        kcDetect.apply(self.templateImage, self.scienceImage)
                        fpList3 = kcDetect.getFootprints()
                        self.assertTrue(len(fpList3) == (len(fpList1)-3))
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="f144933a"/></a>f144933a</h3>

<pre>
commit f144933a81777a2b2d010df08821336aac688881
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Oct 19 18:58:04 2009 +0000

    Fleshed out unit test.  #876.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_8"><a name="tests/KernelCandidateAndSolution.py"/></a>tests/KernelCandidateAndSolution.py</h1>

<h3 id="toc_9">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import os, sys
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                import lsst.afw.display.ds9 as ds9
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#c5dc5e53">c5dc5e53</a> - import numpy as num</div>
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class DiffimTestCases(unittest.TestCase):
                
                    def setUp(self):
                        schema = afwTable.SourceTable.makeMinimalSchema()
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#19d923ab">19d923ab</a> +         schema.setVersion(0)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#cca1e80e">cca1e80e</a> -         centroidKey = schema.addField("centroid", type="PointD")</div>
              ?        --------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#966eaa96">966eaa96</a> +         schema.addField("centroid", type="PointD")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#d07045ed">d07045ed</a> -         fluxKey = schema.addField("flux", type=float)</div>
              ?        ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#966eaa96">966eaa96</a> +         schema.addField("flux", type=float)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#d07045ed">d07045ed</a> -         fluxErrKey = schema.addField("flux.err", type=float)</div>
              ?        -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#966eaa96">966eaa96</a> +         schema.addField("flux.err", type=float)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#d07045ed">d07045ed</a> -         fluxFlagKey = schema.addField("flux.flags", type="Flag")</div>
              ?        --------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#966eaa96">966eaa96</a> +         schema.addField("flux.flags", type="Flag")</div>
                        self.table = afwTable.SourceTable.make(schema)
                        self.table.definePsfFlux("flux")
                        self.table.defineCentroid("centroid")
                        self.ss = afwTable.SourceCatalog(self.table)
                
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "DF"
                        self.subconfig = self.config.kernel.active
                
                        self.policy = pexConfig.makePolicy(self.subconfig)
                        self.policy.set('fitForBackground', True) # we are testing known background recovery here
                        self.policy.set('checkConditionNumber', False) # just in case
                        self.policy.set("useRegularization", False)
                
                        # known input images
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#48e85303">48e85303</a> +         try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#c5dc5e53">c5dc5e53</a> -         self.defDataDir = eups.productDir('afwdata')</div>
              ?                           ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#48e85303">48e85303</a> +             self.defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ? ++++                          ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#48e85303">48e85303</a> +         except Exception:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#48e85303">48e85303</a> +             self.defDataDir = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#48e85303">48e85303</a> + </div>
                        if self.defDataDir:
                            defSciencePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                          "v26-e0-c011-a10.sci.fits")
                            defTemplatePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                           "v5-e0-c011-a10.sci.fits")
                
                            scienceExposure  = afwImage.ExposureF(defSciencePath)
                            templateExposure = afwImage.ExposureF(defTemplatePath)
                            # set XY0 = 0
                            scienceExposure.getMaskedImage().setXY0(afwGeom.Point2I(0, 0))
                            templateExposure.getMaskedImage().setXY0(afwGeom.Point2I(0, 0))
                            # do the warping first so we don't have any masked pixels in the postage stamps
                            warper = afwMath.Warper.fromConfig(self.subconfig.warpingConfig)
                            templateExposure = warper.warpExposure(scienceExposure.getWcs(), templateExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#ce32daf2">ce32daf2</a> -                 destBBox = scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                    ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#9250fe88">9250fe88</a> +                 destBBox = scienceExposure.getBBox())</div>
                
                            # Change xy0
                            # Nice star at position 276, 717
                            # And should be at index 40, 40
                            # No masked pixels in this one
                            self.x02 = 276
                            self.y02 = 717
                            size     = 40
                            bbox2 = afwGeom.Box2I(afwGeom.Point2I(self.x02 - size, self.y02 - size),
                                                  afwGeom.Point2I(self.x02 + size, self.y02 + size))
                            self.scienceImage2  = afwImage.ExposureF(scienceExposure, bbox2, afwImage.LOCAL)
                            self.templateExposure2 = afwImage.ExposureF(templateExposure, bbox2, afwImage.LOCAL)
                
                    def addNoise(self, mi):
                        img       = mi.getImage()
                        seed      = int(afwMath.makeStatistics(mi.getVariance(), afwMath.MEDIAN).getValue())
                        rdm       = afwMath.Random(afwMath.Random.MT19937, seed)
                        rdmImage  = img.Factory(img.getDimensions())
                        afwMath.randomGaussianImage(rdmImage, rdm)
                        img      += rdmImage
                        return afwMath.makeStatistics(rdmImage, afwMath.MEAN).getValue(afwMath.MEAN)
                
                    def verifyDeltaFunctionSolution(self, solution, kSum = 1.0, bg = 0.0):
                        # when kSum = 1.0, this agrees to the default precision.  when
                        # kSum != 1.0 I need to go to only 4 digits.
                        #
                        # -5.4640810225678728e-06 != 0.0 within 7 places
                        #
                        bgSolution = solution.getBackground()
                        self.assertAlmostEqual(bgSolution, bg, 4)
                
                        # again when kSum = 1.0 this agrees.  otherwise
                        #
                        # 2.7000000605594079 != 2.7000000000000002 within 7 places
                        #
                        kSumSolution = solution.getKsum()
                        self.assertAlmostEqual(kSumSolution, kSum, 5)
                
                
                        kImage = solution.makeKernelImage()
                        for j in range(kImage.getHeight()):
                            for i in range(kImage.getWidth()):
                
                                if (i == kImage.getWidth() // 2) and (j == kImage.getHeight() // 2):
                                    self.assertAlmostEqual(kImage.get(i, j), kSum, 5)
                                else:
                                    self.assertAlmostEqual(kImage.get(i, j), 0., 5)
                
                    def testConstructor(self):
                        # Original and uninitialized
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02,
                                                       self.templateExposure2.getMaskedImage(),
                                                       self.scienceImage2.getMaskedImage(),
                                                       self.policy)
                
                        # Kernel not initialized
                        self.assertEqual(kc.isInitialized(), False)
                
                        # But this should be set on construction
                        try:
                            kc.getCandidateRating()
                        except Exception, e:
                            print e
                            self.fail()
                
                        # And these should be filled
                        try:
                            kc.getTemplateMaskedImage()
                            kc.getScienceMaskedImage()
                        except Exception, e:
                            print e
                            self.fail()
                
                        # And of the right type
                        self.assertEqual(type(kc.getTemplateMaskedImage()), type(afwImage.MaskedImageF()))
                        self.assertEqual(type(kc.getScienceMaskedImage()), type(afwImage.MaskedImageF()))
                
                        # None of these should work
                        for kType in (ipDiffim.KernelCandidateF.ORIG,
                                      ipDiffim.KernelCandidateF.PCA,
                                      ipDiffim.KernelCandidateF.RECENT):
                            for kMethod in (kc.getKernelSolution,
                                            kc.getKernel,
                                            kc.getBackground,
                                            kc.getKsum,
                                            kc.getKernelImage,
                                            kc.getDifferenceImage):
                                try:
                                    kMethod(kType)
                                except Exception, e:
                                    pass
                                else:
                                    self.fail()
                        try:
                            kc.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#c5dc5e53">c5dc5e53</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            pass
                        else:
                            self.fail()
                
                    def testSourceStats(self):
                        # Original and uninitialized
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                        source = self.ss.addNew()
                        source.setId(1)
                        source.set(self.table.getCentroidKey().getX(), 276)
                        source.set(self.table.getCentroidKey().getY(), 717)
                        source.set(self.table.getPsfFluxKey(), 1.)
                
                        kc = ipDiffim.KernelCandidateF(source,
                                                       self.templateExposure2.getMaskedImage(),
                                                       self.scienceImage2.getMaskedImage(),
                                                       self.policy)
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                
                
                    def testSourceConstructor(self):
                        # Original and uninitialized
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                        source = self.ss.addNew()
                        source.setId(1)
                        source.set(self.table.getCentroidKey().getX(), 276)
                        source.set(self.table.getCentroidKey().getY(), 717)
                        source.set(self.table.getPsfFluxKey(), 1.)
                
                        kc = ipDiffim.KernelCandidateF(source,
                                                       self.templateExposure2.getMaskedImage(),
                                                       self.scienceImage2.getMaskedImage(),
                                                       self.policy)
                
                        # Kernel not initialized
                        self.assertEqual(kc.isInitialized(), False)
                
                        #Check that the source is set
                        self.assertEqual(kc.getSource(), source)
                        self.assertEqual(kc.getCandidateRating(), source.getPsfFlux()) 
                
                        # But this should be set on construction
                        try:
                            kc.getCandidateRating()
                        except Exception, e:
                            print e
                            self.fail()
                
                        # And these should be filled
                        try:
                            kc.getTemplateMaskedImage()
                            kc.getScienceMaskedImage()
                        except Exception, e:
                            print e
                            self.fail()
                
                        # And of the right type
                        self.assertEqual(type(kc.getTemplateMaskedImage()), type(afwImage.MaskedImageF()))
                        self.assertEqual(type(kc.getScienceMaskedImage()), type(afwImage.MaskedImageF()))
                
                        # None of these should work
                        for kType in (ipDiffim.KernelCandidateF.ORIG,
                                      ipDiffim.KernelCandidateF.PCA,
                                      ipDiffim.KernelCandidateF.RECENT):
                            for kMethod in (kc.getKernelSolution,
                                            kc.getKernel,
                                            kc.getBackground,
                                            kc.getKsum,
                                            kc.getKernelImage,
                                            kc.getDifferenceImage):
                                try:
                                    kMethod(kType)
                                except Exception, e:
                                    pass
                                else:
                                    self.fail()
                        try:
                            kc.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#d07045ed">d07045ed</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            pass
                        else:
                            self.fail()
                
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                
                    def testDeltaFunctionScaled(self, scaling = 2.7, bg = 11.3):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        sIm  = afwImage.MaskedImageF(self.templateExposure2.getMaskedImage(), True)
                        sIm *= scaling
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02,
                                                       self.templateExposure2.getMaskedImage(),
                                                       sIm,
                                                       self.policy)
                
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        kc.build(kList)
                        self.verifyDeltaFunctionSolution(kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT),
                                                         kSum = scaling)
                
                
                        sIm  = afwImage.MaskedImageF(self.templateExposure2.getMaskedImage(), True)
                        sIm += bg
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02,
                                                       self.templateExposure2.getMaskedImage(),
                                                       sIm,
                                                       self.policy)
                
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        kc.build(kList)
                        self.verifyDeltaFunctionSolution(kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT),
                                                         bg = bg)
                
                    def testDeltaFunction(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        # Match an image to itself, with delta-function basis set
                        # No regularization
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02,
                                                       self.templateExposure2.getMaskedImage(),
                                                       self.templateExposure2.getMaskedImage(),
                                                       self.policy)
                
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                
                        # These should work
                        for kType in (ipDiffim.KernelCandidateF.ORIG,
                                      ipDiffim.KernelCandidateF.RECENT):
                            for kMethod in (kc.getKernelSolution,
                                            kc.getKernel,
                                            kc.getBackground,
                                            kc.getKsum,
                                            kc.getKernelImage,
                                            kc.getDifferenceImage):
                                try:
                                    kMethod(kType)
                                except Exception, e:
                                    print kMethod, e
                                    self.fail()
                                else:
                                    pass
                        try:
                            kc.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#c5dc5e53">c5dc5e53</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            print kMethod, e
                            self.fail()
                        else:
                            pass
                
                        # None of these should work
                        for kType in (ipDiffim.KernelCandidateF.PCA,):
                            for kMethod in (kc.getKernelSolution,
                                            kc.getKernel,
                                            kc.getBackground,
                                            kc.getKsum,
                                            kc.getKernelImage,
                                            kc.getImage,
                                            kc.getDifferenceImage):
                                try:
                                    kMethod(kType)
                                except Exception, e:
                                    pass
                                else:
                                    print kMethod
                                    self.fail()
                
                        self.verifyDeltaFunctionSolution(kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT))
                
                    def testGaussianWithNoise(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        # Convolve a real image with a gaussian and try and recover
                        # it.  Add noise and perform the same test.
                
                        gsize = self.policy.getInt("kernelSize")
                        gaussFunction = afwMath.GaussianFunction2D(2, 3)
                        gaussKernel   = afwMath.AnalyticKernel(gsize, gsize, gaussFunction)
                        kImageIn      = afwImage.ImageD(afwGeom.Extent2I(gsize, gsize))
                        kSumIn        = gaussKernel.computeImage(kImageIn, False)
                
                        imX, imY = self.templateExposure2.getMaskedImage().getDimensions()
                        smi = afwImage.MaskedImageF(afwGeom.Extent2I(imX, imY))
                        afwMath.convolve(smi, self.templateExposure2.getMaskedImage(), gaussKernel, False)
                
                        bbox = gaussKernel.shrinkBBox(smi.getBBox(afwImage.LOCAL))
                
                        tmi2 = afwImage.MaskedImageF(self.templateExposure2.getMaskedImage(), bbox, afwImage.LOCAL)
                        smi2 = afwImage.MaskedImageF(smi, bbox, afwImage.LOCAL)
                
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02, tmi2, smi2, self.policy)
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                        kImageOut = kc.getImage()
                
                        #ds9.mtv(kImageIn, frame=1)
                        #ds9.mtv(kImageOut, frame=2)
                
                        soln = kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                        self.assertAlmostEqual(soln.getKsum(), kSumIn)
                        # 8.7499380640430563e-06 != 0.0 within 7 places
                        self.assertAlmostEqual(soln.getBackground(), 0.0, 4)
                
                        for j in range(kImageOut.getHeight()):
                            for i in range(kImageOut.getWidth()):
                
                                # in the outskirts of the kernel, the ratio can get screwed because of low S/N
                                # e.g. 7.45817359824e-09 vs. 1.18062529402e-08
                                # in the guts of the kernel it should look closer
                                if kImageIn.get(i, j) > 1e-4:
                                    # sigh, too bad this sort of thing fails..
                                    # 0.99941584433815966 != 1.0 within 3 places
                                    self.assertAlmostEqual(kImageOut.get(i, j)/kImageIn.get(i, j), 1.0, 2)
                
                        # now repeat with noise added; decrease precision of comparison
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
392  <a href="#c7fd30f7">c7fd30f7</a> -         bkg = self.addNoise(smi2)</div>
              ?        ------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
396  <a href="#966eaa96">966eaa96</a> +         self.addNoise(smi2)</div>
                        kc = ipDiffim.KernelCandidateF(self.x02, self.y02, tmi2, smi2, self.policy)
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                        kImageOut = kc.getImage()
                
                        #ds9.mtv(kImageIn, frame=3)
                        #ds9.mtv(kImageOut, frame=4)
                
                
                        soln = kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                        self.assertAlmostEqual(soln.getKsum(), kSumIn, 3)
                        if not (self.policy.get("fitForBackground")):
                            self.assertEqual(soln.getBackground(), 0.0)
                
                        for j in range(kImageOut.getHeight()):
                            for i in range(kImageOut.getWidth()):
                                if kImageIn.get(i, j) > 1e-2:
                                    self.assertAlmostEqual(kImageOut.get(i, j), kImageIn.get(i, j), 2)
                
                
                    def testGaussian(self, imsize = 50):
                        # Convolve a delta function with a known gaussian; try to
                        # recover using delta-function basis
                
                        gsize = self.policy.getInt("kernelSize")
                        tsize = imsize + gsize
                
                        gaussFunction = afwMath.GaussianFunction2D(2, 3)
                        gaussKernel   = afwMath.AnalyticKernel(gsize, gsize, gaussFunction)
                        kImageIn      = afwImage.ImageD(afwGeom.Extent2I(gsize, gsize))
                        gaussKernel.computeImage(kImageIn, False)
                
                        # template image with a single hot pixel in the exact center
                        tmi = afwImage.MaskedImageF(afwGeom.Extent2I(tsize, tsize))
                        tmi.set(0, 0x0, 1e-4)
                        cpix = tsize // 2
                        tmi.set(cpix, cpix, (1, 0x0, 1))
                
                        # science image
                        smi = afwImage.MaskedImageF(tmi.getDimensions())
                        afwMath.convolve(smi, tmi, gaussKernel, False)
                
                        # get the actual kernel sum (since the image is not infinite)
                        gscaling = afwMath.makeStatistics(smi, afwMath.SUM).getValue(afwMath.SUM)
                
                        # grab only the non-masked subregion
                        bbox = gaussKernel.shrinkBBox(smi.getBBox(afwImage.LOCAL))
                
                        tmi2 = afwImage.MaskedImageF(tmi, bbox, afwImage.LOCAL)
                        smi2 = afwImage.MaskedImageF(smi, bbox, afwImage.LOCAL)
                
                        # make sure its a valid subregion!
                        for j in range(tmi2.getHeight()):
                            for i in range(tmi2.getWidth()):
                                self.assertEqual(tmi2.getMask().get(i, j), 0)
                                self.assertEqual(smi2.getMask().get(i, j), 0)
                
                
                        kc = ipDiffim.KernelCandidateF(0.0, 0.0, tmi2, smi2, self.policy)
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        kc.build(kList)
                        self.assertEqual(kc.isInitialized(), True)
                        kImageOut = kc.getImage()
                
                        soln = kc.getKernelSolution(ipDiffim.KernelCandidateF.RECENT)
                        self.assertAlmostEqual(soln.getKsum(), gscaling)
                        self.assertAlmostEqual(soln.getBackground(), 0.0)
                
                        for j in range(kImageOut.getHeight()):
                            for i in range(kImageOut.getWidth()):
                                self.assertAlmostEqual(kImageOut.get(i, j)/kImageIn.get(i, j), 1.0, 5)
                
                    def testZeroVariance(self, imsize = 50):
                        gsize = self.policy.getInt("kernelSize")
                        tsize = imsize + gsize
                
                        tmi = afwImage.MaskedImageF(afwGeom.Extent2I(tsize, tsize))
                        tmi.set(0, 0x0, 1.0)
                        cpix = tsize // 2
                        tmi.set(cpix, cpix, (1, 0x0, 0.0))
                        smi = afwImage.MaskedImageF(afwGeom.Extent2I(tsize, tsize))
                        smi.set(0, 0x0, 1.0)
                        smi.set(cpix, cpix, (1, 0x0, 0.0))
                
                        kList = ipDiffim.makeKernelBasisList(self.subconfig)
                        self.policy.set("constantVarianceWeighting", False)
                        kc = ipDiffim.KernelCandidateF(0.0, 0.0, tmi, smi, self.policy)
                        try:
                            kc.build(kList)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
483  <a href="#6e531f92">6e531f92</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
487  <a href="#9250fe88">9250fe88</a> +         except Exception:</div>
                            pass
                        else:
                            self.fail()
                
                    def testConstantWeighting(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        self.policy.set("fitForBackground", False)
                        self.testGaussian()
                        self.testGaussianWithNoise()
                
                    def testNoBackgroundFit(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        self.policy.set("constantVarianceWeighting", True)
                        self.testGaussian()
                
                    def testInsert(self):
                        mi = afwImage.MaskedImageF(afwGeom.Extent2I(10, 10))
                        kc = ipDiffim.makeKernelCandidate(0., 0., mi, mi, self.policy)
                        kc.setStatus(afwMath.SpatialCellCandidate.GOOD)
                
                        sizeCellX = self.policy.get("sizeCellX")
                        sizeCellY = self.policy.get("sizeCellY")
                        kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(1, 1)),
                                                               sizeCellX, sizeCellY)
                        kernelCellSet.insertCandidate(kc)
                        nSeen = 0
                        for cell in kernelCellSet.getCellList():
                            for cand in cell.begin(True):
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                self.assertEqual(cand.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                                nSeen += 1
                        self.assertEqual(nSeen, 1)
                
                    def dontTestDisp(self):
                        ds9.mtv(self.scienceImage2, frame=1)
                        ds9.mtv(self.templateExposure2, frame=2)
                
                
                    def tearDown(self):
                        del self.policy
                        del self.table
                        del self.ss
                        if self.defDataDir:
                            del self.scienceImage2
                            del self.templateExposure2
                
                #####
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="cca1e80e"/></a>cca1e80e</h3>

<pre>
commit cca1e80e719df66265e1492d127e9661ac244a35
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 22 16:09:49 2013 -0700

    Initial round of fixes to based on Paul's W13 review.
</pre>
<h3><a name="6e531f92"/></a>6e531f92</h3>

<pre>
commit 6e531f92149ce909c1a348e5182f6f65d9204f0d
Author: becker <becker@git.lsstcorp.org>
Date:   Wed May 11 18:24:29 2011 +0000

    Fixed zero-variance test.  #1140.
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
<h3><a name="c7fd30f7"/></a>c7fd30f7</h3>

<pre>
commit c7fd30f75b6aabc9baa004bfac209ff1710fbccd
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Apr 6 23:10:28 2010 +0000

    Unit tests.  #1140
</pre>
<h3><a name="c5dc5e53"/></a>c5dc5e53</h3>

<pre>
commit c5dc5e53193f5bd845039c1a3c567c6ec96d9dce
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Mar 27 00:24:41 2010 +0000

    Re-building unit tests.  #1140.
</pre>
<h3><a name="ce32daf2"/></a>ce32daf2</h3>

<pre>
commit ce32daf2c276e17ce69002d8206b70fea4bdac7e
Author: rowen <rowen@git.lsstcorp.org>
Date:   Fri Jun 3 22:31:48 2011 +0000

    Fix use of warper: need to specify destination bbox same as science image
</pre>
<h3><a name="d07045ed"/></a>d07045ed</h3>

<pre>
commit d07045ede6186a9d483fb2c65f8c880c7ffa7afd
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Wed Feb 6 14:45:40 2013 -0800

    Added source to KernelCandidate with proper constructor and unit test for new constructor
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="19d923ab"/></a>19d923ab</h3>

<pre>
commit 19d923ab86ca23eb96132abd2bb1dae7869cb17d
Author: pgee <pgee@pgeepc2.gateway.2wire.net>
Date:   Wed Aug 20 03:35:59 2014 -0700

    DM-958 change table.setVersion calls to schema.setVersion
</pre>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_10"><a name="tests/BasisLists.py"/></a>tests/BasisLists.py</h1>

<h3 id="toc_11">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#63b8ab67">63b8ab67</a> - import os</div>
                import numpy as num
                
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#63b8ab67">63b8ab67</a> - import eups</div>
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as logging
                import lsst.pex.config as pexConfig
                
                verbosity = 4
                logging.Trace_setVerbosity("lsst.ip.diffim", verbosity)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.configAL    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configAL.kernel.name = "AL"
                        self.subconfigAL = self.configAL.kernel.active
                
                        self.configDF    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDF.kernel.name = "DF"
                        self.subconfigDF = self.configDF.kernel.active
                
                        self.policyAL = pexConfig.makePolicy(self.subconfigAL)
                        self.policyDF = pexConfig.makePolicy(self.subconfigDF)
                
                        self.kSize    = self.policyAL.getInt("kernelSize")
                
                    def tearDown(self):
                        del self.configAL
                        del self.policyAL
                        del self.configDF
                        del self.policyDF
                
                    #
                    ### Delta function
                    #
                    
                    def deltaFunctionTest(self, ks):
                        # right shape
                        nk  = 0
                        for rowi in range(self.kSize):
                            for colj in range(self.kSize):
                                kernel = ks[nk]
                                kimage = afwImage.ImageD(kernel.getDimensions())
                                ksum   = kernel.computeImage(kimage, False)
                                self.assertEqual(ksum, 1.)
                
                                for rowk in range(self.kSize):
                                    for coll in range(self.kSize):
                                        if (rowi == rowk) and (colj == coll):
                                            self.assertEqual(kimage.get(coll, rowk), 1.)
                                        else:
                                            self.assertEqual(kimage.get(coll, rowk), 0.)
                                nk += 1
                        
                
                    def testMakeDeltaFunction(self):
                        ks = ipDiffim.makeDeltaFunctionBasisList(self.kSize, self.kSize)
                
                        # right size
                        self.assertEqual(len(ks), self.kSize * self.kSize)
                
                        # right shape
                        self.deltaFunctionTest(ks)
                
                
                    #
                    ### Alard Lupton
                    #
                
                    def alardLuptonTest(self, ks):
                        kim    = afwImage.ImageD(ks[0].getDimensions())
                        nBasis = len(ks)
                
                        # the first one sums to 1; the rest sum to 0
                        ks[0].computeImage(kim, False)
                        self.assertAlmostEqual(num.sum(num.ravel(kim.getArray())), 1.0)
                        
                        for k in range(1, nBasis):
                            ks[k].computeImage(kim, False)
                            self.assertAlmostEqual(num.sum(num.ravel(kim.getArray())), 0.0)
                
                        # the images dotted with themselves is 1, except for the first
                        for k in range(1, nBasis):
                            ks[k].computeImage(kim, False)
                            arr = kim.getArray()
                            self.assertAlmostEqual(num.sum(arr*arr), 1.0)
                
                    def testMakeAlardLupton(self):
                        nGauss   = self.policyAL.get("alardNGauss")
                        sigGauss = self.policyAL.getDoubleArray("alardSigGauss")
                        degGauss = self.policyAL.getIntArray("alardDegGauss")
                        self.assertEqual(len(sigGauss), nGauss)
                        self.assertEqual(len(degGauss), nGauss)
                        self.assertEqual(self.kSize % 2, 1)       # odd sized
                        kHalfWidth = self.kSize // 2
                
                        ks = ipDiffim.makeAlardLuptonBasisList(kHalfWidth, nGauss, sigGauss, degGauss)
                
                        # right size
                        nTot = 0
                        for deg in degGauss:
                            nTot += (deg + 1) * (deg + 2) / 2
                        self.assertEqual(len(ks), nTot)
                
                        # right orthogonality
                        self.alardLuptonTest(ks)
                
                    def testGenerateAlardLupton(self):
                        # defaults
                        ks = ipDiffim.generateAlardLuptonBasisList(self.subconfigAL)
                        self.alardLuptonTest(ks)
                
                        # send FWHM
                        ks = ipDiffim.generateAlardLuptonBasisList(self.subconfigAL, targetFwhmPix = 3.0, referenceFwhmPix = 4.0)
                        self.alardLuptonTest(ks)
                
                        
                    #
                    ### Make
                    #
                    def testMakeKernelBasisList(self):
                        ks = ipDiffim.makeKernelBasisList(self.subconfigAL)
                        self.alardLuptonTest(ks)
                
                        ks = ipDiffim.makeKernelBasisList(self.subconfigDF)
                        self.deltaFunctionTest(ks)
                        
                    #
                    ### Renormalize
                    #
                
                    def testRenormalize(self):
                        # inputs
                        gauss1 = afwMath.GaussianFunction2D(2, 2)
                        gauss2 = afwMath.GaussianFunction2D(3, 4)
                        gauss3 = afwMath.GaussianFunction2D(0.2, 0.25)
                        gaussKernel1 = afwMath.AnalyticKernel(self.kSize, self.kSize, gauss1)
                        gaussKernel2 = afwMath.AnalyticKernel(self.kSize, self.kSize, gauss2)
                        gaussKernel3 = afwMath.AnalyticKernel(self.kSize, self.kSize, gauss3)
                        kimage1 = afwImage.ImageD(gaussKernel1.getDimensions())
                        ksum1   = gaussKernel1.computeImage(kimage1, False)
                        kimage2 = afwImage.ImageD(gaussKernel2.getDimensions())
                        ksum2   = gaussKernel2.computeImage(kimage2, False)
                        kimage3 = afwImage.ImageD(gaussKernel3.getDimensions())
                        ksum3   = gaussKernel3.computeImage(kimage3, False)
                        self.assertTrue(ksum1 != 1.)
                        self.assertTrue(ksum2 != 1.)
                        self.assertTrue(ksum3 != 1.)
                        # no constraints on first kernels norm
                        self.assertTrue(num.sum(num.ravel(kimage2.getArray())**2 ) != 1.)
                        self.assertTrue(num.sum(num.ravel(kimage3.getArray())**2 ) != 1.)
                        basisListIn = afwMath.KernelList()
                        basisListIn.push_back(gaussKernel1)
                        basisListIn.push_back(gaussKernel2)
                        basisListIn.push_back(gaussKernel3)
                        
                        # outputs
                        basisListOut = ipDiffim.renormalizeKernelList(basisListIn)
                        gaussKernel1 = basisListOut[0]
                        gaussKernel2 = basisListOut[1]
                        gaussKernel3 = basisListOut[2]
                        ksum1 = gaussKernel1.computeImage(kimage1, False)
                        ksum2 = gaussKernel2.computeImage(kimage2, False)
                        ksum3 = gaussKernel3.computeImage(kimage3, False)
                        self.assertAlmostEqual(ksum1, 1.)
                        self.assertAlmostEqual(ksum2, 0.)
                        self.assertAlmostEqual(ksum3, 0.)
                        # no constraints on first kernels norm
                        self.assertAlmostEqual(num.sum(num.ravel(kimage2.getArray())**2 ), 1.)
                        self.assertAlmostEqual(num.sum(num.ravel(kimage3.getArray())**2 ), 1.)
                
                    #
                    ### Regularize
                    #
                
                    def testCentralRegularization(self):
                        # 
                        self.policyDF.set("regularizationType", "centralDifference")
                        try:
                            self.policyDF.set("centralRegularizationStencil", 1)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # stencil of 1 not allowed
                            pass
                        else:
                            self.fail()
                            
                        self.policyDF.set("centralRegularizationStencil", 5)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # stencil of 5 allowed
                            print e
                            self.fail()
                        else:
                            pass
                
                        self.policyDF.set("centralRegularizationStencil", 9)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # stencil of 9 allowed
                            print e
                            self.fail()
                        else:
                            pass
                
                        self.policyDF.set("regularizationBorderPenalty", -1.0)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # border penalty > 0
                            pass
                        else:
                            self.fail()
                
                        self.policyDF.set("regularizationBorderPenalty", 0.0)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # border penalty > 0
                            print e
                            self.fail()
                        else:
                            pass
                
                    def testForwardRegularization(self):
                        self.policyDF.set("regularizationType", "forwardDifference")
                        self.policyDF.set("forwardRegularizationOrders", 0)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # order 1..3 allowed
                            pass
                        else:
                            self.fail()
                
                        self.policyDF.set("forwardRegularizationOrders", 1)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # order 1..3 allowed
                            print e
                            self.fail()
                        else:
                            pass
                
                        self.policyDF.set("forwardRegularizationOrders", 4)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
                        except Exception, e: # order 1..3 allowed
                            pass
                        else:
                            self.fail()
                
                        self.policyDF.set("forwardRegularizationOrders", 1)
                        self.policyDF.add("forwardRegularizationOrders", 2)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#63b8ab67">63b8ab67</a> -         except Exception, e: # order 1..3 allowed</div>
              ?                         ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#966eaa96">966eaa96</a> +         except Exception as e: # order 1..3 allowed</div>
              ?                         ^^^
                            print e
                            self.fail()
                        else:
                            pass
                
                    def testBadRegularization(self):
                        try:
                            self.policyDF.set("regularizationType", "foo")
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#f6e5715f">f6e5715f</a> -             h = ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
              ?            ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#966eaa96">966eaa96</a> +             ipDiffim.makeRegularizationMatrix(self.policyDF)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#0dd5cee9">0dd5cee9</a> -         except Exception, e: # invalid option</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#966eaa96">966eaa96</a> +         except Exception: # invalid option</div>
                            pass
                        else:
                            self.fail()
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="f6e5715f"/></a>f6e5715f</h3>

<pre>
commit f6e5715f33ef83a5f8aef6978ce2fdb5e0c906d2
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 15:26:02 2012 -0800

    Secound round of unit test conversions
</pre>
<h3><a name="0dd5cee9"/></a>0dd5cee9</h3>

<pre>
commit 0dd5cee9bf7e24a40d6ca8abf457b37f3d3603bc
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Dec 9 23:24:14 2010 +0000

    Working on failing unit tests.  #1140.
</pre>
<h3><a name="63b8ab67"/></a>63b8ab67</h3>

<pre>
commit 63b8ab679ad1ecbd5ebc835dc606bf59d2fca153
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Mar 23 22:23:06 2010 +0000

    Getting unit tests working.  Again.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_12"><a name="python/lsst/ip/diffim/diffimLib.i"/></a>python/lsst/ip/diffim/diffimLib.i</h1>

<h3 id="toc_13">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                
                /*
                 * LSST Data Management System
                 * Copyright 2008, 2009, 2010 LSST Corporation.
                 *
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
                 *
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
                 *
                 * You should have received a copy of the LSST License Statement and 
                 * the GNU General Public License along with this program.  If not, 
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
                
                %define diffimLib_DOCSTRING
                "
                Python bindings for lsst::ip::diffim code
                "
                %enddef
                
                %feature("autodoc", "1");
                %module(docstring=diffimLib_DOCSTRING, package="lsst.ip.diffim") diffimLib
                
                // Avoid Swig bug exposed in Ticket 640
                // http://dev.lsstcorp.org/trac/ticket/640
                %ignore lsst::ip::diffim::FindSetBits::operator();
                %ignore lsst::ip::diffim::ImageStatistics::operator();
                
                // Reference for this file is at http://dev.lsstcorp.org/trac/wiki/SwigFAQ 
                // Nice practical example is at
                //     http://dev.lsstcorp.org/trac/browser/DMS/afw/trunk/python/lsst/afw/image/imageLib.i 
                
                // Suppress swig complaints
                #pragma SWIG nowarn=314                 // print is a python keyword (--> _print)
                #pragma SWIG nowarn=362                 // operator=  ignored
                
                // Remove warnings
                // Nothing known about 'boost::bad_any_cast'
                namespace boost {
                    class bad_any_cast; 
                }
                
                /* handle C++ arguments that should be outputs in python */
                %apply int& OUTPUT { int& };
                %apply float& OUTPUT { float& };
                %apply double& OUTPUT { double& };
                
                %{
                #include "boost/shared_ptr.hpp"
                
                
                #include "lsst/pex/exceptions.h"
                #include "lsst/pex/logging.h"
                #include "lsst/afw/detection.h"
                #include "lsst/afw/math.h"
                #include "lsst/afw/geom.h" 
                #include "lsst/afw/image.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#d07045ed">d07045ed</a> - #include "lsst/afw/table/Source.h"</div>
              ?                         -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/afw/table.h"</div>
                #include "lsst/afw/cameraGeom.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#3d087587">3d087587</a> - #include "lsst/meas/algorithms.h"</div>
              ?                      --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base.h"</div>
              ?                     +  +
                
                #include "lsst/ip/diffim.h"
                %}
                
                /******************************************************************************/
                
                /* Eigen / numpy.  Info comes from $AFW_DIR/include/lsst/afw/numpyTypemaps.h */
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#0d27e6a4">0d27e6a4</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#0d27e6a4">0d27e6a4</a> + %include "lsst/p_lsstSwig.i"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#0d27e6a4">0d27e6a4</a> + %initializeNumPy(ip_diffim)</div>
                %{
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#c2996dc8">c2996dc8</a> - #define PY_ARRAY_UNIQUE_SYMBOL LSST_IP_DIFFIM_NUMPY_ARRAY_API</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#c2996dc8">c2996dc8</a> - #include "numpy/arrayobject.h"</div>
                #include "ndarray/swig.h"
                #include "ndarray/swig/eigen.h"
                %}
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#c2996dc8">c2996dc8</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#c2996dc8">c2996dc8</a> - %init %{</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#c2996dc8">c2996dc8</a> -     import_array();</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#c2996dc8">c2996dc8</a> - %}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#c2996dc8">c2996dc8</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#f91a6177">f91a6177</a> - %include "lsst/p_lsstSwig.i"</div>
                %include "ndarray.i"
                
                %template(PtrEigenMatrixXd) boost::shared_ptr<Eigen::MatrixXd>;
                %template(PtrEigenVectorXd) boost::shared_ptr<Eigen::VectorXd>;
                %declareNumPyConverters(Eigen::MatrixXd);
                %declareNumPyConverters(Eigen::VectorXd);
                %shared_ptr(Eigen::MatrixXd);
                %shared_ptr(Eigen::VectorXd);
                
                %include "lsst/daf/base/persistenceMacros.i"
                %include "lsst/pex/config.h"            // LSST_CONTROL_FIELD.
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#c0b62a68">c0b62a68</a> + %include "lsst/meas/base/constants.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#c0b62a68">c0b62a68</a> + %include "lsst/meas/base/exceptions.i"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#c0b62a68">c0b62a68</a> + %include "lsst/meas/base/utilities.i"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#c0b62a68">c0b62a68</a> + %include "lsst/meas/base/Algorithm.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#c0b62a68">c0b62a68</a> + </div>
                %import  "lsst/afw/image/imageLib.i"
                %import  "lsst/afw/math/mathLib.i"
                %import  "lsst/afw/math/objectVectors.i"
                %import  "lsst/afw/detection/detectionLib.i"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#3d087587">3d087587</a> - %import  "lsst/meas/algorithms/algorithmsLib.i"</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#0de0385e">0de0385e</a> - </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#c0b62a68">c0b62a68</a> + %include "lsst/afw/image/Exposure.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#c0b62a68">c0b62a68</a> + %include "lsst/afw/table/Source.h"</div>
                %lsst_exceptions();
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#109bd96b">109bd96b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#2fbdb6cf">2fbdb6cf</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#98787c6e">98787c6e</a> - %pythoncode %{</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#109bd96b">109bd96b</a> - import lsst.utils</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#109bd96b">109bd96b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#109bd96b">109bd96b</a> - def version(HeadURL = r"$HeadURL$"):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#109bd96b">109bd96b</a> -     """Return a version given a HeadURL string. If a different version is setup, return that too"""</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#109bd96b">109bd96b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#109bd96b">109bd96b</a> -     version_svn = lsst.utils.guessSvnVersion(HeadURL)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#109bd96b">109bd96b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#109bd96b">109bd96b</a> -     try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#109bd96b">109bd96b</a> -         import eups</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#109bd96b">109bd96b</a> -     except ImportError:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#109bd96b">109bd96b</a> -         return version_svn</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#109bd96b">109bd96b</a> -     else:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#109bd96b">109bd96b</a> -         try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#109bd96b">109bd96b</a> -             version_eups = eups.setup("ip_diffim")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#109bd96b">109bd96b</a> -         except AttributeError:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#109bd96b">109bd96b</a> -             return version_svn</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#109bd96b">109bd96b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#109bd96b">109bd96b</a> -     if version_eups == version_svn:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#109bd96b">109bd96b</a> -         return version_svn</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#109bd96b">109bd96b</a> -     else:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#109bd96b">109bd96b</a> -         return "%s (setup: %s)" % (version_svn, version_eups)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#98787c6e">98787c6e</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#98787c6e">98787c6e</a> - %}</div>
                
                /******************************************************************************/
                
                %template(pair_Kernel_double)   std::pair<lsst::afw::math::Kernel::Ptr, double>;
                %template(pair_Kernel_Function) std::pair<lsst::afw::math::LinearCombinationKernel::Ptr,
                                                          lsst::afw::math::Kernel::SpatialFunctionPtr>;
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/FindSetBits.h"
                %}
                
                %include "lsst/ip/diffim/FindSetBits.h"
                
                %template(FindSetBitsU)
                    lsst::ip::diffim::FindSetBits<lsst::afw::image::Mask<lsst::afw::image::MaskPixel> >;
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/ImageStatistics.h"
                %}
                
                %include "lsst/ip/diffim/ImageStatistics.h"
                
                %template(ImageStatisticsI)
                    lsst::ip::diffim::ImageStatistics<int>;
                %template(ImageStatisticsF)
                    lsst::ip::diffim::ImageStatistics<float>;
                %template(ImageStatisticsD)
                    lsst::ip::diffim::ImageStatistics<double>;
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/ImageSubtract.h"
                %}
                
                %include "lsst/ip/diffim/ImageSubtract.h"
                
                
                %define %convolveAndSubtract(PIXEL_T)
                   %template(convolveAndSubtract)
                       lsst::ip::diffim::convolveAndSubtract<PIXEL_T, double>;
                   %template(convolveAndSubtract)
                       lsst::ip::diffim::convolveAndSubtract<PIXEL_T, lsst::afw::math::Function2<double> const&>;
                %enddef
                
                %convolveAndSubtract(float);
                #if 0
                %convolveAndSubtract(double);  // image subtraction on double images??!?  Not instantiated in .cc either
                #endif
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/KernelSolution.h"
                %}
                
                
                %define %KernelSolutionPtrs(NAME, TYPE)
                %shared_ptr(lsst::ip::diffim::StaticKernelSolution<TYPE>);
                %shared_ptr(lsst::ip::diffim::MaskedKernelSolution<TYPE>);
                %shared_ptr(lsst::ip::diffim::RegularizedKernelSolution<TYPE>);
                %enddef
                
                %define %KernelSolutions(NAME, TYPE)
                %template(StaticKernelSolution##NAME) lsst::ip::diffim::StaticKernelSolution<TYPE>;
                %template(MaskedKernelSolution##NAME) lsst::ip::diffim::MaskedKernelSolution<TYPE>;
                %template(RegularizedKernelSolution##NAME) lsst::ip::diffim::RegularizedKernelSolution<TYPE>;
                %enddef
                
                %shared_ptr(lsst::ip::diffim::KernelSolution);
                %shared_ptr(lsst::ip::diffim::SpatialKernelSolution);
                
                %KernelSolutionPtrs(F, float);
                
                %include "lsst/ip/diffim/KernelSolution.h"
                
                %KernelSolutions(F, float);
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/KernelCandidateDetection.h"
                %}
                
                %define %KernelCandidateDetectionPtr(NAME, TYPE)
                %shared_ptr(lsst::ip::diffim::KernelCandidateDetection<TYPE>);
                %enddef
                
                %define %KernelCandidateDetection(NAME, TYPE)
                %template(KernelCandidateDetection##NAME) lsst::ip::diffim::KernelCandidateDetection<TYPE>;
                %enddef
                
                %KernelCandidateDetectionPtr(F, float);
                
                %include "lsst/ip/diffim/KernelCandidateDetection.h"
                
                %KernelCandidateDetection(F, float);
                /******************************************************************************/
                
                %define %IMAGE(PIXTYPE)
                lsst::afw::image::Image<PIXTYPE>
                %enddef
                
                %define %KernelCandidatePtr(NAME, TYPE)
                %shared_ptr(lsst::ip::diffim::KernelCandidate<TYPE>);
                
                %enddef
                
                %define %KernelCandidate(NAME, TYPE)
                %template(KernelCandidate##NAME) lsst::ip::diffim::KernelCandidate<TYPE>;
                %template(makeKernelCandidate) lsst::ip::diffim::makeKernelCandidate<TYPE>;
                %inline %{
                    lsst::ip::diffim::KernelCandidate<TYPE>::Ptr
                        cast_KernelCandidate##NAME(lsst::afw::math::SpatialCellCandidate::Ptr candidate) {
                        return boost::dynamic_pointer_cast<lsst::ip::diffim::KernelCandidate<TYPE> >(candidate);
                    }
                %}
                %enddef
                
                %include "lsst/ip/diffim/KernelCandidate.h"
                %KernelCandidatePtr(F, float);
                
                %include "lsst/ip/diffim/KernelCandidate.h"
                
                %KernelCandidate(F, float);
                
                /******************************************************************************/
                
                %{
                #include "lsst/ip/diffim/BasisLists.h"
                %}
                
                %include "lsst/ip/diffim/BasisLists.h"
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#3d087587">3d087587</a> - /******************************************************************************/</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#3d087587">3d087587</a> - %{</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#3d087587">3d087587</a> - #include "lsst/ip/diffim/DipoleAlgorithms.h"</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#3d087587">3d087587</a> - %}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#3d087587">3d087587</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleCentroidControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleFluxControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleCentroidAlgorithm)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleCentroidControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleFluxAlgorithm)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::DipoleFluxControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::NaiveDipoleCentroidControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::NaiveDipoleFluxControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#3d087587">3d087587</a> - %shared_ptr(lsst::ip::diffim::PsfDipoleFluxControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#3d087587">3d087587</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#3d087587">3d087587</a> - %include "lsst/ip/diffim/DipoleAlgorithms.h"</div>
              ?                          ^     ^^^^^ ------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#c0b62a68">c0b62a68</a> + %include  "lsst/ip/diffim/dipole.i"</div>
              ?         +                 ^     ^
                
                /******************************************************************************/
                
                %include "lsst/ip/diffim/detail.i"
                
                /******************************************************************************/
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="0de0385e"/></a>0de0385e</h3>

<pre>
commit 0de0385e7056b6f60c531b80c2cc76d89e8cbbe6
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Sep 25 20:47:30 2009 +0000

    Removed old Pca code.  Added test case for spatial cells being used
    with SpatialKernels.  Added package header file.  #876.
</pre>
<h3><a name="109bd96b"/></a>109bd96b</h3>

<pre>
commit 109bd96b9bc7942af46bcbb13b1e97004a648989
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Mar 5 20:41:18 2009 +0000

    Merging of ticket #354 to trunk.
</pre>
<h3><a name="c2996dc8"/></a>c2996dc8</h3>

<pre>
commit c2996dc8c25c55882307ea93bd2fe3d535121b68
Author: becker <becker@git.lsstcorp.org>
Date:   Wed May 26 17:47:36 2010 +0000

    Eigen/numarray issue fixed.  #1140.
</pre>
<h3><a name="98787c6e"/></a>98787c6e</h3>

<pre>
commit 98787c6e8c247da98cdc954fd3c2e1de425f8016
Author: rallsman <rallsman@git.lsstcorp.org>
Date:   Fri Apr 4 18:09:55 2008 +0000

    Initial source modification for ip/diffim.
</pre>
<h3><a name="f91a6177"/></a>f91a6177</h3>

<pre>
commit f91a61773e9787a35a003870ad239ab2b24bd434
Author: rowen <rowen@git.lsstcorp.org>
Date:   Mon Apr 18 18:59:03 2011 +0000

    Fixed some errors the compiler caught. diffimLib.i still needs some work.
</pre>
<h3><a name="2fbdb6cf"/></a>2fbdb6cf</h3>

<pre>
commit 2fbdb6cf0e8568f90f527bf7bc15f5128227305b
Author: becker <becker@git.lsstcorp.org>
Date:   Tue May 25 23:51:42 2010 +0000

    Added kernel build() to KernelSolution.  Stuck on Eigen Swig issue.  #1140.
</pre>
<h3><a name="3d087587"/></a>3d087587</h3>

<pre>
commit 3d0875871dfaf89026609741d419e049ae6f55c0
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jan 28 17:27:18 2013 -0800

    Initial swig wrapping of dipole algorithms.  Commenting out PsfDipoleFluxControl until implementation.
</pre>
<h3><a name="d07045ed"/></a>d07045ed</h3>

<pre>
commit d07045ede6186a9d483fb2c65f8c880c7ffa7afd
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Wed Feb 6 14:45:40 2013 -0800

    Added source to KernelCandidate with proper constructor and unit test for new constructor
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
<h3><a name="0d27e6a4"/></a>0d27e6a4</h3>

<pre>
commit 0d27e6a4bdcd06c84cad2f7b37ef6cf47fcfee11
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Apr 8 17:16:12 2015 -0400

    Utilize new numeric scalar typemaps and NumPy initialization macro
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_14"><a name="tests/dipole.py"/></a>tests/dipole.py</h1>

<h3 id="toc_15">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#fd69e815">fd69e815</a> - # </div>
              ?  -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c0b62a68">c0b62a68</a> + #</div>
                # LSST Data Management System
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#fd69e815">fd69e815</a> - # Copyright 2008, 2009, 2010 LSST Corporation.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#c0b62a68">c0b62a68</a> + # Copyright 2008-2015 AURA/LSST</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#fd69e815">fd69e815</a> - # </div>
              ?  -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#c0b62a68">c0b62a68</a> + #</div>
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#fd69e815">fd69e815</a> - # </div>
              ?  -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#c0b62a68">c0b62a68</a> + #</div>
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#fd69e815">fd69e815</a> - # </div>
              ?  -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#c0b62a68">c0b62a68</a> + #</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#fd69e815">fd69e815</a> - # You should have received a copy of the LSST License Statement and </div>
              ?                                                                    -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#c0b62a68">c0b62a68</a> + # You should have received a copy of the LSST License Statement and</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#fd69e815">fd69e815</a> - # the GNU General Public License along with this program.  If not, </div>
              ?                                                                   -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#c0b62a68">c0b62a68</a> + # the GNU General Public License along with this program.  If not,</div>
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import unittest
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#966eaa96">966eaa96</a> + </div>
                import numpy as np
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#966eaa96">966eaa96</a> + </div>
                import lsst.utils.tests as tests
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#966eaa96">966eaa96</a> + import lsst.daf.base as dafBase</div>
                import lsst.afw.display.ds9 as ds9
                import lsst.afw.image as afwImage
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#fd69e815">fd69e815</a> + import lsst.afw.geom as afwGeom</div>
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#fd69e815">fd69e815</a> - import lsst.afw.detection as afwDet</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#fd69e815">fd69e815</a> - import lsst.afw.geom as afwGeom</div>
                import lsst.afw.math as afwMath
                import lsst.meas.algorithms as measAlg
                import lsst.ip.diffim as ipDiffim
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#fd69e815">fd69e815</a> - import lsst.ip.diffim.diffimTools as diffimTools</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#fd69e815">fd69e815</a> - #display = True</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#fd69e815">fd69e815</a> - try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#fd69e815">fd69e815</a> -     display</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#fd69e815">fd69e815</a> - except:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#fd69e815">fd69e815</a> -     display = False</div>
              ? ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#966eaa96">966eaa96</a> + display = False</div>
                np.random.seed(666)
                sigma2fwhm = 2. * np.sqrt(2. * np.log(2.))
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#c0b62a68">c0b62a68</a> + def makePluginAndCat(alg, name, control, metadata=False, centroid=None):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#c0b62a68">c0b62a68</a> +     schema = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#c0b62a68">c0b62a68</a> +     if centroid:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#c0b62a68">c0b62a68</a> +         schema.addField(centroid + "_x", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#c0b62a68">c0b62a68</a> +         schema.addField(centroid + "_y", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#c0b62a68">c0b62a68</a> +         schema.addField(centroid + "_flag", type='Flag')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#c0b62a68">c0b62a68</a> +     if metadata:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#c0b62a68">c0b62a68</a> +         plugin = alg(control, name, schema, dafBase.PropertySet())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#c0b62a68">c0b62a68</a> +     else:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#c0b62a68">c0b62a68</a> +         plugin = alg(control, name, schema)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#c0b62a68">c0b62a68</a> +     cat = afwTable.SourceCatalog(schema)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#c0b62a68">c0b62a68</a> +     if centroid:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#c0b62a68">c0b62a68</a> +         cat.defineCentroid(centroid)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#c0b62a68">c0b62a68</a> +     return plugin, cat</div>
                
                def createDipole(w, h, xc, yc, scaling = 100.0, fracOffset = 1.2):
                    # Make random noise image: set image plane to normal distribution
                    image = afwImage.MaskedImageF(w,h)
                    image.set(0)
                    array = image.getImage().getArray()
                    array[:,:] = np.random.randn(w,h)
                    # Set variance to 1.0
                    var   = image.getVariance()
                    var.set(1.0)
                
                    if display:
                        ds9.mtv(image, frame=1, title="Original image")
                        ds9.mtv(image.getVariance(), frame=2, title="Original variance")
                
                    # Create Psf for dipole creation and measurement
                    psfSize = 17
                    psf = measAlg.DoubleGaussianPsf(psfSize, psfSize, 2.0, 3.5, 0.1)
                    psfFwhmPix = sigma2fwhm * psf.computeShape().getDeterminantRadius()
                    psfim = psf.computeImage().convertF()
                    psfim *= scaling / psf.computePeak()
                    psfw, psfh = psfim.getDimensions()
                    psfSum = np.sum(psfim.getArray())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#c0b62a68">c0b62a68</a> + </div>
                    # Create the dipole, offset by fracOffset of the Psf FWHM (pixels)
                    offset = fracOffset * psfFwhmPix // 2
                    array  = image.getImage().getArray()
                    xp, yp = xc - psfw//2 + offset, yc - psfh//2 + offset
                    array[yp:yp+psfh, xp:xp+psfw] += psfim.getArray()
                
                    xn, yn = xc - psfw//2 - offset, yc - psfh//2 - offset
                    array[yn:yn+psfh, xn:xn+psfw] -= psfim.getArray()
                
                    if display:
                        ds9.mtv(image, frame=3, title="With dipole")
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#c0b62a68">c0b62a68</a> + </div>
                    # Create an exposure, detect positive and negative peaks separately
                    exp = afwImage.makeExposure(image)
                    exp.setPsf(psf)
                    config = measAlg.SourceDetectionConfig()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#ba3cc03d">ba3cc03d</a> -     config.returnOriginalFootprints = True</div>
                    config.thresholdPolarity = "both"
                    config.reEstimateBackground = False
                    schema = afwTable.SourceTable.makeMinimalSchema()
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#19d923ab">19d923ab</a> +     schema.setVersion(0)</div>
                    task = measAlg.SourceDetectionTask(schema, config=config)
                    table = afwTable.SourceTable.make(schema)
                    results = task.makeSourceCatalog(table, exp)
                    if display:
                        ds9.mtv(image, frame=4, title="Detection plane")
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#c0b62a68">c0b62a68</a> + </div>
                    # Merge them together
                    assert(len(results.sources) == 2)
                    fpSet = results.fpSets.positive
                    fpSet.merge(results.fpSets.negative, 0, 0, False)
                    sources = afwTable.SourceCatalog(table)
                    fpSet.makeSources(sources)
                    assert(len(sources) == 1)
                    s = sources[0]
                    assert(len(s.getFootprint().getPeaks()) == 2)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#c0b62a68">c0b62a68</a> + </div>
                    return psf, psfSum, exp, s
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#c0b62a68">c0b62a68</a> + </div>
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                class DipoleAlgorithmTest(unittest.TestCase):
                    """ A test case for dipole algorithms"""
                    def setUp(self):
                        self.w, self.h = 100, 100 # size of image
                        self.xc, self.yc = 50, 50 # location of center of dipole
                
                    def tearDown(self):
                        pass
                
                    def testNaiveDipoleCentroid(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#fd69e815">fd69e815</a> -         alg = ipDiffim.NaiveDipoleCentroidControl()</div>
              ?         ^ -            -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#c0b62a68">c0b62a68</a> +         control = ipDiffim.DipoleCentroidControl()</div>
              ?         ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#fd69e815">fd69e815</a> - </div>
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#c0b62a68">c0b62a68</a> +         plugin, cat = makePluginAndCat(ipDiffim.NaiveDipoleCentroid, "test", control, centroid="centroid")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#c0b62a68">c0b62a68</a> +         source = cat.addNew()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_x", 50)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_y", 50)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#fd69e815">fd69e815</a> -         schema  = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#fd69e815">fd69e815</a> -         msb     = measAlg.MeasureSourcesBuilder()\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(alg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#fd69e815">fd69e815</a> -         ms      = msb.build(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#fd69e815">fd69e815</a> -         table   = afwTable.SourceTable.make(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#fd69e815">fd69e815</a> -         source  = table.makeRecord()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#fd69e815">fd69e815</a> -         </div>
                        source.setFootprint(s.getFootprint())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#fd69e815">fd69e815</a> -         ms.apply(source, exposure, afwGeom.Point2D(self.xc, self.yc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#fd69e815">fd69e815</a> -         for key in (".pos", ".pos.err", ".pos.flags", ".neg", ".neg.err", ".neg.flags"):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#c0b62a68">c0b62a68</a> +         plugin.measure(source, exposure)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#c0b62a68">c0b62a68</a> +         for key in ("_pos_x", "_pos_y", "_pos_xSigma", "_pos_ySigma", "_pos_flag",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#c0b62a68">c0b62a68</a> +             "_neg_x", "_neg_y", "_neg_xSigma", "_neg_ySigma", "_neg_flag"):</div>
                            try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#fd69e815">fd69e815</a> -                 source.get(alg.name+key)</div>
              ?                            ^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#c0b62a68">c0b62a68</a> +                 source.get("test"+key)</div>
              ?                            ^^ +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#fd69e815">fd69e815</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                self.fail()
                
                    def testNaiveDipoleFluxControl(self):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#fd69e815">fd69e815</a> +         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#fd69e815">fd69e815</a> -         alg = ipDiffim.NaiveDipoleFluxControl()</div>
              ?         ^ -            -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#c0b62a68">c0b62a68</a> +         control = ipDiffim.DipoleFluxControl()</div>
              ?         ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#fd69e815">fd69e815</a> - </div>
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#c0b62a68">c0b62a68</a> +         plugin, cat = makePluginAndCat(ipDiffim.NaiveDipoleFlux, "test", control, centroid="centroid")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#c0b62a68">c0b62a68</a> +         source = cat.addNew()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_x", 50)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_y", 50)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#fd69e815">fd69e815</a> -         schema  = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#fd69e815">fd69e815</a> -         msb     = measAlg.MeasureSourcesBuilder()\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(alg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#fd69e815">fd69e815</a> -         ms      = msb.build(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#fd69e815">fd69e815</a> -         table   = afwTable.SourceTable.make(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#fd69e815">fd69e815</a> -         source  = table.makeRecord()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#fd69e815">fd69e815</a> -         </div>
                        source.setFootprint(s.getFootprint())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#fd69e815">fd69e815</a> -         ms.apply(source, exposure, afwGeom.Point2D(self.xc, self.yc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#8a966ce1">8a966ce1</a> -         for key in (".pos", ".pos.err", ".pos.flags", ".neg", ".neg.err", </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#8a966ce1">8a966ce1</a> -                     ".neg.flags", ".npos", ".nneg"):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#c0b62a68">c0b62a68</a> +         plugin.measure(source, exposure)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#c0b62a68">c0b62a68</a> +         for key in ("_pos_flux", "_pos_fluxSigma", "_pos_flag", "_npos",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#c0b62a68">c0b62a68</a> +             "_neg_flux", "_neg_fluxSigma", "_neg_flag", "_nneg"):</div>
                            try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#fd69e815">fd69e815</a> -                 source.get(alg.name+key)</div>
              ?                            ^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#c0b62a68">c0b62a68</a> +                 source.get("test"+key)</div>
              ?                            ^^ +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#fd69e815">fd69e815</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                self.fail()
                
                    def testPsfDipoleFluxControl(self):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#c0b62a68">c0b62a68</a> +         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#fd69e815">fd69e815</a> +         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#fd69e815">fd69e815</a> -         alg = ipDiffim.PsfDipoleFluxControl()</div>
              ?         ^ -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#c0b62a68">c0b62a68</a> +         control = ipDiffim.PsfDipoleFluxControl()</div>
              ?         ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#fd69e815">fd69e815</a> - </div>
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#c0b62a68">c0b62a68</a> +         plugin, cat = makePluginAndCat(ipDiffim.PsfDipoleFlux, "test", control, centroid="centroid")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#c0b62a68">c0b62a68</a> +         source = cat.addNew()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_x", 50)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_y", 50)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#fd69e815">fd69e815</a> -         schema  = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#fd69e815">fd69e815</a> -         msb     = measAlg.MeasureSourcesBuilder()\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(alg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#fd69e815">fd69e815</a> -         ms      = msb.build(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#fd69e815">fd69e815</a> -         table   = afwTable.SourceTable.make(schema)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#fd69e815">fd69e815</a> -         source  = table.makeRecord()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#fd69e815">fd69e815</a> -         </div>
                        source.setFootprint(s.getFootprint())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#fd69e815">fd69e815</a> -         ms.apply(source, exposure, afwGeom.Point2D(self.xc, self.yc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#fd69e815">fd69e815</a> -         for key in (".pos", ".pos.err", ".pos.flags", ".neg", ".neg.err", ".neg.flags"):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#c0b62a68">c0b62a68</a> +         plugin.measure(source, exposure)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#c0b62a68">c0b62a68</a> +         for key in ("_pos_flux", "_pos_fluxSigma", "_pos_flag",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#c0b62a68">c0b62a68</a> +             "_neg_flux", "_neg_fluxSigma", "_neg_flag"):</div>
                            try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#fd69e815">fd69e815</a> -                 source.get(alg.name+key)</div>
              ?                            ^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#c0b62a68">c0b62a68</a> +                 source.get("test"+key)</div>
              ?                            ^^ +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#fd69e815">fd69e815</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                self.fail()
                
                    def testAll(self):
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#fd69e815">fd69e815</a> -         source = self.measureDipole(s, exposure)</div>
              ?        ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#966eaa96">966eaa96</a> +         self.measureDipole(s, exposure)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#fd69e815">fd69e815</a> -     def XXX_testPsfDipoleIter(self, scaling=100., fracOffset=0.5):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#8a966ce1">8a966ce1</a> -         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc, </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#8a966ce1">8a966ce1</a> -                                                 scaling=scaling, fracOffset=fracOffset)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#fd69e815">fd69e815</a> -         source = self.measureDipole(s, exposure)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#fd69e815">fd69e815</a> -         # Recreate the simultaneous joint Psf fit in python</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#fd69e815">fd69e815</a> -         fp     = source.getFootprint()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#fd69e815">fd69e815</a> -         peaks  = fp.getPeaks()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#fd69e815">fd69e815</a> -         speaks = [(p.getPeakValue(), p) for p in peaks]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#fd69e815">fd69e815</a> -         speaks.sort() </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#fd69e815">fd69e815</a> -         dpeaks = [speaks[0][1], speaks[-1][1]]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#fd69e815">fd69e815</a> -         import pylab</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#fd69e815">fd69e815</a> -         sp1     = pylab.figure().add_subplot(111)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#fd69e815">fd69e815</a> -         sp2     = pylab.figure().add_subplot(111)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#fd69e815">fd69e815</a> -         sp3     = pylab.figure().add_subplot(111)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#fd69e815">fd69e815</a> -         psf = exposure.getPsf()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#1d2154bc">1d2154bc</a> -         psfSigPix = psf.computeShape().getDeterminantRadius()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#fd69e815">fd69e815</a> -         psfFwhmPix = psfSigPix * sigma2fwhm </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#fd69e815">fd69e815</a> -         offset = fracOffset * psfFwhmPix // 2</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#fd69e815">fd69e815</a> -         xp, yp = self.xc + offset, self.yc + offset</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#fd69e815">fd69e815</a> -         xn, yn = self.xc - offset, self.yc - offset</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#fd69e815">fd69e815</a> -         xframe = 1</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#fd69e815">fd69e815</a> -         for shift in [0.1, 0.5, 1.0,]:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#fd69e815">fd69e815</a> -             #shift  = 0.1</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#fd69e815">fd69e815</a> -             chi2dofs  = []</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#fd69e815">fd69e815</a> -             sigmas    = []</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#fd69e815">fd69e815</a> -             totfluxes = []</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#fd69e815">fd69e815</a> -             results   = []</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#fd69e815">fd69e815</a> -             for dnegCenterX in np.arange(-shift, 2*shift-0.01, shift):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#fd69e815">fd69e815</a> -                 for dnegCenterY in np.arange(-shift, 2*shift-0.01, shift):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#fd69e815">fd69e815</a> -                     for dposCenterX in np.arange(-shift, 2*shift-0.01, shift):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#fd69e815">fd69e815</a> -                         for dposCenterY in np.arange(-shift, 2*shift-0.01, shift):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#fd69e815">fd69e815</a> -                             negCenter = afwGeom.Point2D(xn + dnegCenterX, yn + dnegCenterY)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#fd69e815">fd69e815</a> -                             posCenter = afwGeom.Point2D(xp + dposCenterX, yp + dposCenterY)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#1d2154bc">1d2154bc</a> -                             negPsf = psf.computeImage(negCenter).convertF()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#1d2154bc">1d2154bc</a> -                             posPsf = psf.computeImage(posCenter).convertF()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#1d2154bc">1d2154bc</a> -                             negPeak = psf.computePeak(negCenter)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#1d2154bc">1d2154bc</a> -                             posPeak = psf.computePeak(posCenter)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#1d2154bc">1d2154bc</a> -                             negPsf /= negPeak</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#1d2154bc">1d2154bc</a> -                             posPsf /= posPeak</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#fd69e815">fd69e815</a> -                             model    = afwImage.ImageF(fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#fd69e815">fd69e815</a> -                             negModel = afwImage.ImageF(fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#fd69e815">fd69e815</a> -                             posModel = afwImage.ImageF(fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#fd69e815">fd69e815</a> -                             # The center of the Psf should be at negCenter, posCenter</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#fd69e815">fd69e815</a> -                             negPsfBBox = negPsf.getBBox(afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#fd69e815">fd69e815</a> -                             posPsfBBox = posPsf.getBBox(afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#fd69e815">fd69e815</a> -                             modelBBox  = model.getBBox(afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#fd69e815">fd69e815</a> -                             # Portion of the negative Psf that overlaps the montage</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#1d2154bc">1d2154bc</a> -                             negOverlapBBox = afwGeom.Box2I(negPsfBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#1d2154bc">1d2154bc</a> -                             negOverlapBBox.clip(modelBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#1d2154bc">1d2154bc</a> -                             self.assertFalse(negOverlapBBox.isEmpty())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#fd69e815">fd69e815</a> -                             # Portion of the positivePsf that overlaps the montage</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#1d2154bc">1d2154bc</a> -                             posOverlapBBox = afwGeom.Box2I(posPsfBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#1d2154bc">1d2154bc</a> -                             posOverlapBBox.clip(modelBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#1d2154bc">1d2154bc</a> -                             self.assertFalse(posOverlapBBox.isEmpty())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#fd69e815">fd69e815</a> -                             negPsfSubim    = type(negPsf)(negPsf, negOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#fd69e815">fd69e815</a> -                             modelSubim     = type(model)(model, negOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#fd69e815">fd69e815</a> -                             negModelSubim  = type(negModel)(negModel, negOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#fd69e815">fd69e815</a> -                             modelSubim    += negPsfSubim  # just for debugging</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#fd69e815">fd69e815</a> -                             negModelSubim += negPsfSubim  # for fitting</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#fd69e815">fd69e815</a> -                             posPsfSubim    = type(posPsf)(posPsf, posOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#fd69e815">fd69e815</a> -                             modelSubim     = type(model)(model, posOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#fd69e815">fd69e815</a> -                             posModelSubim  = type(posModel)(posModel, posOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#fd69e815">fd69e815</a> -                             modelSubim    += posPsfSubim</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#fd69e815">fd69e815</a> -                             posModelSubim += posPsfSubim</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#fd69e815">fd69e815</a> -                             data = afwImage.ImageF(exposure.getMaskedImage().getImage(), fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#fd69e815">fd69e815</a> -                             var = afwImage.ImageF(exposure.getMaskedImage().getVariance(), fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#fd69e815">fd69e815</a> -                             matrixNorm = 1. / np.sqrt(np.median(var.getArray()))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#fd69e815">fd69e815</a> -                             posPsfSum = np.sum(posPsf.getArray())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#fd69e815">fd69e815</a> -                             negPsfSum = np.sum(negPsf.getArray())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#8a966ce1">8a966ce1</a> -                             M = np.array((np.ravel(negModel.getArray()), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#8a966ce1">8a966ce1</a> -                                           np.ravel(posModel.getArray()))).T.astype(np.float64)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#fd69e815">fd69e815</a> -                             B = np.array((np.ravel(data.getArray()))).astype(np.float64)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#fd69e815">fd69e815</a> -                             M *= matrixNorm</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#fd69e815">fd69e815</a> -                             B *= matrixNorm</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#fd69e815">fd69e815</a> -                             # Numpy solution</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#fd69e815">fd69e815</a> -                             fneg0, fpos0 = np.linalg.lstsq(M, B)[0]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#fd69e815">fd69e815</a> -                     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#fd69e815">fd69e815</a> -                             # Afw solution</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#fd69e815">fd69e815</a> -                             lsq = afwMath.LeastSquares.fromDesignMatrix(M, B, afwMath.LeastSquares.DIRECT_SVD)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#fd69e815">fd69e815</a> -                             fneg, fpos = lsq.getSolution()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#fd69e815">fd69e815</a> -                             dfneg = np.sqrt(lsq.getCovariance()[0][0])</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#fd69e815">fd69e815</a> -                             dfpos = np.sqrt(lsq.getCovariance()[1][1])</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#fd69e815">fd69e815</a> -                             dftot = np.sqrt(dfneg**2 + dfpos**2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#fd69e815">fd69e815</a> -    </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#fd69e815">fd69e815</a> -                             # Recreate model</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#fd69e815">fd69e815</a> -                             fitted    = afwImage.ImageF(fp.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#fd69e815">fd69e815</a> -                             negFit    = type(negPsf)(negPsf, negOverlapBBox, afwImage.PARENT, True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#fd69e815">fd69e815</a> -                             negFit   *= float(fneg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#fd69e815">fd69e815</a> -                             posFit    = type(posPsf)(posPsf, posOverlapBBox, afwImage.PARENT, True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#fd69e815">fd69e815</a> -                             posFit   *= float(fpos)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#fd69e815">fd69e815</a> -                             </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#fd69e815">fd69e815</a> -                             fitSubim  = type(fitted)(fitted, negOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#fd69e815">fd69e815</a> -                             fitSubim += negFit</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#fd69e815">fd69e815</a> -                             fitSubim  = type(fitted)(fitted, posOverlapBBox, afwImage.PARENT)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#fd69e815">fd69e815</a> -                             fitSubim += posFit</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#fd69e815">fd69e815</a> -                             </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#fd69e815">fd69e815</a> -                             fitted   -= data</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#fd69e815">fd69e815</a> -                             fitted   *= fitted</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#fd69e815">fd69e815</a> -                             fitted   /= var</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#fd69e815">fd69e815</a> -                             chi2      = np.sum(fitted.getArray())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#fd69e815">fd69e815</a> -                             npts      = fitted.getArray().shape[0] * fitted.getArray().shape[1]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#fd69e815">fd69e815</a> -                             chi2dof   = chi2/(npts - 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#fd69e815">fd69e815</a> -                             #print "%.3f" % (chi2dof)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#fd69e815">fd69e815</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
300  <a href="#fd69e815">fd69e815</a> -                             chi2dofs.append(chi2dof)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
301  <a href="#fd69e815">fd69e815</a> -                             sigmas.append((fpos+fneg)/dftot)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#fd69e815">fd69e815</a> -                             totfluxes.append(fpos+fneg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#fd69e815">fd69e815</a> -                             results.append( (chi2dof, ((fpos+fneg)/dftot)) )</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#8a966ce1">8a966ce1</a> -             sp1.hist(chi2dofs, bins=10**(np.arange(-1, 2.0, 0.1)), alpha=0.1/shift, </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#8a966ce1">8a966ce1</a> -                      label="shift=%.1f (%.2f,%.2f)" % (shift, np.mean(chi2dofs), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#8a966ce1">8a966ce1</a> -                                                        np.std(chi2dofs)))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#8a966ce1">8a966ce1</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#fd69e815">fd69e815</a> -             sp2.hist(sigmas, alpha=0.1/shift, label="shift=%.1f (%.2f,%.2f)" % (shift, np.mean(sigmas), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#fd69e815">fd69e815</a> -                                                                                 np.std(sigmas)))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#fd69e815">fd69e815</a> -             print 1.0 * len(np.where(np.abs(sigmas)>5)[0]) / len(sigmas)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#fd69e815">fd69e815</a> -             sp3.hist(totfluxes, alpha=0.1/shift, label="shift=%.1f (%.2f,%.2f)" % (shift, np.mean(totfluxes), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#fd69e815">fd69e815</a> -                                                                                    np.std(totfluxes)))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#fd69e815">fd69e815</a> -             sp2.axvline(x=scaling)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#fd69e815">fd69e815</a> -             results.sort()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#fd69e815">fd69e815</a> -             print results[0], results[1], results[2]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#fd69e815">fd69e815</a> -         sp1.set_title("chi2/dof (dipole sep = %.1f FWHM)" % (fracOffset))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#fd69e815">fd69e815</a> -         sp2.set_title("(positive+negative)/unc (dipole sep = %.1f FWHM)" % (fracOffset))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#fd69e815">fd69e815</a> -         sp3.set_title("positive+negative flux (dipole sep = %.1f FWHM)" % (fracOffset))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#fd69e815">fd69e815</a> -         sp1.legend()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#fd69e815">fd69e815</a> -         sp2.legend()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#fd69e815">fd69e815</a> -         sp3.legend()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#fd69e815">fd69e815</a> -         pylab.show()</div>
                
                    def _makeModel(self, exposure, psf, fp, negCenter, posCenter):
                
                        negPsf = psf.computeImage(negCenter).convertF()
                        posPsf = psf.computeImage(posCenter).convertF()
                        negPeak = psf.computePeak(negCenter)
                        posPeak = psf.computePeak(posCenter)
                        negPsf /= negPeak
                        posPsf /= posPeak
                
                        model    = afwImage.ImageF(fp.getBBox())
                        negModel = afwImage.ImageF(fp.getBBox())
                        posModel = afwImage.ImageF(fp.getBBox())
                
                        # The center of the Psf should be at negCenter, posCenter
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
342  <a href="#fd69e815">fd69e815</a> -         negPsfBBox = negPsf.getBBox(afwImage.PARENT)</div>
              ?                                     ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#9250fe88">9250fe88</a> +         negPsfBBox = negPsf.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#fd69e815">fd69e815</a> -         posPsfBBox = posPsf.getBBox(afwImage.PARENT)</div>
              ?                                     ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#9250fe88">9250fe88</a> +         posPsfBBox = posPsf.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
344  <a href="#fd69e815">fd69e815</a> -         modelBBox  = model.getBBox(afwImage.PARENT)</div>
              ?                                    ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#9250fe88">9250fe88</a> +         modelBBox  = model.getBBox()</div>
                
                        # Portion of the negative Psf that overlaps the montage
                        negOverlapBBox = afwGeom.Box2I(negPsfBBox)
                        negOverlapBBox.clip(modelBBox)
                        self.assertFalse(negOverlapBBox.isEmpty())
                
                        # Portion of the positivePsf that overlaps the montage
                        posOverlapBBox = afwGeom.Box2I(posPsfBBox)
                        posOverlapBBox.clip(modelBBox)
                        self.assertFalse(posOverlapBBox.isEmpty())
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#fd69e815">fd69e815</a> -         negPsfSubim    = type(negPsf)(negPsf, negOverlapBBox, afwImage.PARENT)</div>
              ?                                                             -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#9250fe88">9250fe88</a> +         negPsfSubim    = type(negPsf)(negPsf, negOverlapBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
357  <a href="#fd69e815">fd69e815</a> -         modelSubim     = type(model)(model, negOverlapBBox, afwImage.PARENT)</div>
              ?                                                           -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#9250fe88">9250fe88</a> +         modelSubim     = type(model)(model, negOverlapBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#fd69e815">fd69e815</a> -         negModelSubim  = type(negModel)(negModel, negOverlapBBox, afwImage.PARENT)</div>
              ?                                                                 -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#9250fe88">9250fe88</a> +         negModelSubim  = type(negModel)(negModel, negOverlapBBox)</div>
                        modelSubim    += negPsfSubim  # just for debugging
                        negModelSubim += negPsfSubim  # for fitting
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
362  <a href="#fd69e815">fd69e815</a> -         posPsfSubim    = type(posPsf)(posPsf, posOverlapBBox, afwImage.PARENT)</div>
              ?                                                             -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#9250fe88">9250fe88</a> +         posPsfSubim    = type(posPsf)(posPsf, posOverlapBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
363  <a href="#fd69e815">fd69e815</a> -         modelSubim     = type(model)(model, posOverlapBBox, afwImage.PARENT)</div>
              ?                                                           -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#9250fe88">9250fe88</a> +         modelSubim     = type(model)(model, posOverlapBBox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
364  <a href="#fd69e815">fd69e815</a> -         posModelSubim  = type(posModel)(posModel, posOverlapBBox, afwImage.PARENT)</div>
              ?                                                                 -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#9250fe88">9250fe88</a> +         posModelSubim  = type(posModel)(posModel, posOverlapBBox)</div>
                        modelSubim    += posPsfSubim
                        posModelSubim += posPsfSubim
                
                        data = afwImage.ImageF(exposure.getMaskedImage().getImage(), fp.getBBox())
                        var = afwImage.ImageF(exposure.getMaskedImage().getVariance(), fp.getBBox())
                        matrixNorm = 1. / np.sqrt(np.median(var.getArray()))
                
                        if display:
                            ds9.mtv(model, frame=5, title="Unfitted model")
                            ds9.mtv(data, frame=6, title="Data")
                
                        posPsfSum = np.sum(posPsf.getArray())
                        negPsfSum = np.sum(negPsf.getArray())
                
                        M = np.array((np.ravel(negModel.getArray()), np.ravel(posModel.getArray()))).T.astype(np.float64)
                        B = np.array((np.ravel(data.getArray()))).astype(np.float64)
                        M *= matrixNorm
                        B *= matrixNorm
                
                        # Numpy solution
                        fneg0, fpos0 = np.linalg.lstsq(M, B)[0]
                
                        # Afw solution
                        lsq = afwMath.LeastSquares.fromDesignMatrix(M, B, afwMath.LeastSquares.DIRECT_SVD)
                        fneg, fpos = lsq.getSolution()
                
                        # Should be exaxtly the same as each other
                        self.assertAlmostEqual(1e-2*fneg0,  1e-2*fneg)
                        self.assertAlmostEqual(1e-2*fpos0,  1e-2*fpos)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
394  <a href="#fd69e815">fd69e815</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#c0b62a68">c0b62a68</a> + </div>
                        # Recreate model
                        fitted  = afwImage.ImageF(fp.getBBox())
                        negFit  = type(negPsf)(negPsf, negOverlapBBox, afwImage.PARENT, True)
                        negFit *= float(fneg)
                        posFit  = type(posPsf)(posPsf, posOverlapBBox, afwImage.PARENT, True)
                        posFit *= float(fpos)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
402  <a href="#fd69e815">fd69e815</a> -         fitSubim  = type(fitted)(fitted, negOverlapBBox, afwImage.PARENT)</div>
              ?                                                        -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#9250fe88">9250fe88</a> +         fitSubim  = type(fitted)(fitted, negOverlapBBox)</div>
                        fitSubim += negFit
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
404  <a href="#fd69e815">fd69e815</a> -         fitSubim  = type(fitted)(fitted, posOverlapBBox, afwImage.PARENT)</div>
              ?                                                        -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#9250fe88">9250fe88</a> +         fitSubim  = type(fitted)(fitted, posOverlapBBox)</div>
                        fitSubim += posFit
                        if display:
                            ds9.mtv(fitted, frame=7, title="Fitted model")
                
                        fitted   -= data
                
                        if display:
                            ds9.mtv(fitted, frame=8, title="Residuals")
                
                        fitted   *= fitted
                        fitted   /= var
                
                        if display:
                            ds9.mtv(fitted, frame=9, title="Chi2")
                
                        return fneg, negPsfSum, fpos, posPsfSum, fitted
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
421  <a href="#fd69e815">fd69e815</a> -         </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
422  <a href="#fd69e815">fd69e815</a> -     def testRecentroid(self, scaling=100.):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
423  <a href="#fd69e815">fd69e815</a> -         # When the dipoles are closer, you really need to recentroid to get a good fit</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
424  <a href="#8a966ce1">8a966ce1</a> -         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc, </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
425  <a href="#8a966ce1">8a966ce1</a> -                                                 scaling=scaling, fracOffset=1.0)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
426  <a href="#fd69e815">fd69e815</a> -         source = self.measureDipole(s, exposure)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
427  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
428  <a href="#fd69e815">fd69e815</a> -         # Recreate the simultaneous joint Psf fit in python (but at bad centroid!)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
429  <a href="#fd69e815">fd69e815</a> -         fp     = source.getFootprint()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
430  <a href="#fd69e815">fd69e815</a> -         peaks  = fp.getPeaks()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
431  <a href="#fd69e815">fd69e815</a> -         speaks = [(p.getPeakValue(), p) for p in peaks]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
432  <a href="#fd69e815">fd69e815</a> -         speaks.sort() </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
433  <a href="#fd69e815">fd69e815</a> -         dpeaks = [speaks[0][1], speaks[-1][1]]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
434  <a href="#fd69e815">fd69e815</a> -         negCenter = afwGeom.Point2D(dpeaks[0].getFx(), dpeaks[0].getFy())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
435  <a href="#fd69e815">fd69e815</a> -         posCenter = afwGeom.Point2D(dpeaks[1].getFx(), dpeaks[1].getFy())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
436  <a href="#8a966ce1">8a966ce1</a> -         fneg0, negPsfSum0, fpos0, posPsfSum0, residIm0 = \</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
437  <a href="#8a966ce1">8a966ce1</a> -             self._makeModel(exposure, psf, fp, negCenter, posCenter)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
438  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
439  <a href="#fd69e815">fd69e815</a> -         # Now do it at the best centroid found by PsfDipoleFlux </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
440  <a href="#fd69e815">fd69e815</a> -         negCenter = source.get("flux.dipole.psf.neg.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
441  <a href="#fd69e815">fd69e815</a> -         posCenter = source.get("flux.dipole.psf.pos.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
442  <a href="#8a966ce1">8a966ce1</a> -         fneg1, negPsfSum1, fpos1, posPsfSum1, residIm1 = \</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
443  <a href="#8a966ce1">8a966ce1</a> -             self._makeModel(exposure, psf, fp, negCenter, posCenter)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
444  <a href="#fd69e815">fd69e815</a> -         </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
445  <a href="#fd69e815">fd69e815</a> -         # First off, make sure that the original centroid is wrong</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
446  <a href="#fd69e815">fd69e815</a> -         self.assertNotAlmostEqual(1e-2*scaling, -1e-2*fneg0, 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
447  <a href="#fd69e815">fd69e815</a> -         self.assertNotAlmostEqual(1e-2*scaling,  1e-2*fpos0, 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
448  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
449  <a href="#fd69e815">fd69e815</a> -         # And then that PsfDipoleFlux does a much better job by recentroiding</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
450  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-2*scaling, -1e-2*fneg1, 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
451  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-2*scaling,  1e-2*fpos1, 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
452  <a href="#fd69e815">fd69e815</a> -         </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
453  <a href="#fd69e815">fd69e815</a> -         # And that my python implementation gets the same solution as PsfDipoleFlux</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
454  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-4*fneg1*negPsfSum1, 1e-4*source.get("flux.dipole.psf.neg"), 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
455  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-4*fpos1*posPsfSum1, 1e-4*source.get("flux.dipole.psf.pos"), 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
456  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
457  <a href="#fd69e815">fd69e815</a> -         # Second fit is better</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
458  <a href="#8a966ce1">8a966ce1</a> -         chi2dof0 = np.sum(residIm0.getArray()) / (residIm0.getArray().shape[0] * </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
459  <a href="#8a966ce1">8a966ce1</a> -                                                   residIm0.getArray().shape[1] - 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
460  <a href="#8a966ce1">8a966ce1</a> -         chi2dof1 = np.sum(residIm1.getArray()) / (residIm1.getArray().shape[0] * </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
461  <a href="#8a966ce1">8a966ce1</a> -                                                   residIm1.getArray().shape[1] - 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
462  <a href="#fd69e815">fd69e815</a> -         self.assertTrue(chi2dof0 > chi2dof1)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
463  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
464  <a href="#fd69e815">fd69e815</a> -         # And same as PsfDipoleFlux</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
465  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(chi2dof1, source.get("flux.dipole.psf.chi2dof"), 2)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
466  <a href="#fd69e815">fd69e815</a> - </div>
                
                    def testPsfDipoleFit(self, scaling=100.):
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc, scaling=scaling)
                        source = self.measureDipole(s, exposure)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
471  <a href="#fd69e815">fd69e815</a> - </div>
                        # Recreate the simultaneous joint Psf fit in python
                        fp     = source.getFootprint()
                        peaks  = fp.getPeaks()
                        speaks = [(p.getPeakValue(), p) for p in peaks]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
476  <a href="#fd69e815">fd69e815</a> -         speaks.sort() </div>
              ?                      -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#c0b62a68">c0b62a68</a> +         speaks.sort()</div>
                        dpeaks = [speaks[0][1], speaks[-1][1]]
                
                        negCenter = afwGeom.Point2D(dpeaks[0].getFx(), dpeaks[0].getFy())
                        posCenter = afwGeom.Point2D(dpeaks[1].getFx(), dpeaks[1].getFy())
                
                        fneg, negPsfSum, fpos, posPsfSum, residIm = self._makeModel(exposure, psf, fp, negCenter, posCenter)
                
                        # Should be close to the same as the inputs; as fracOffset
                        # gets smaller this will be worse.  This works for scaling =
                        # 100.
                        self.assertAlmostEqual(1e-2*scaling, -1e-2*fneg, 2)
                        self.assertAlmostEqual(1e-2*scaling,  1e-2*fpos, 2)
                
                        # Now compare the LeastSquares results fitted here to the C++
                        # implementation: Since total flux is returned, and this is of
                        # order 1e4 for this default test, scale back down so that
                        # assertAlmostEqual behaves reasonably (the comparison to 2
                        # places means to 0.01).  Also note that PsfDipoleFlux returns
                        # the total flux, while here we are just fitting for the
                        # scaling of the Psf.  Therefore the comparison is
                        # fneg*negPsfSum to flux.dipole.psf.neg.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
498  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-4*fneg*negPsfSum, 1e-4*source.get("flux.dipole.psf.neg"), 2)</div>
              ?                                                                       ^^^^^     ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(1e-4*fneg*negPsfSum, 1e-4*source.get("ip_diffim_PsfDipoleFlux_neg_flux"), 2)</div>
              ?                                                                      +++++ ^^^^^^^^     ^^^^^   +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
499  <a href="#fd69e815">fd69e815</a> -         self.assertAlmostEqual(1e-4*fpos*posPsfSum, 1e-4*source.get("flux.dipole.psf.pos"), 2)</div>
              ?                                                                       ^^^^^     ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(1e-4*fpos*posPsfSum, 1e-4*source.get("ip_diffim_PsfDipoleFlux_pos_flux"), 2)</div>
              ?                                                                      +++++ ^^^^^^^^     ^^^^^   +++++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
501  <a href="#fd69e815">fd69e815</a> -         # Not a Nan in chi2/dof</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
502  <a href="#fd69e815">fd69e815</a> -         self.assertTrue(np.isfinite(source.get("flux.dipole.psf.chi2dof")))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#c0b62a68">c0b62a68</a> +         self.assertTrue(source.get("ip_diffim_PsfDipoleFlux_pos_fluxSigma") > 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#c0b62a68">c0b62a68</a> +         self.assertTrue(source.get("ip_diffim_PsfDipoleFlux_neg_fluxSigma") > 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_neg_flag"), False)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_pos_flag"), False)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_centroid_x"), 50.0, 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_centroid_y"), 50.0, 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_neg_centroid_x"), negCenter[0], 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_neg_centroid_y"), negCenter[1], 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_pos_centroid_x"), posCenter[0], 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#c0b62a68">c0b62a68</a> +         self.assertAlmostEqual(source.get("ip_diffim_PsfDipoleFlux_pos_centroid_y"), posCenter[1], 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_neg_flag"), False)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_pos_flag"), False)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#c0b62a68">c0b62a68</a> +         self.assertTrue(source.get("ip_diffim_PsfDipoleFlux_chi2dof") > 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_flags_maxpix"), False)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#09f5006c">09f5006c</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#09f5006c">09f5006c</a> +     def testMaxPixelFlag(self):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#09f5006c">09f5006c</a> +         psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#c0b62a68">c0b62a68</a> +         msConfig = ipDiffim.DipoleMeasurementConfig()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#c0b62a68">c0b62a68</a> +         #   This tests is run with the default sfm algorithms as well as Dipole</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#c0b62a68">c0b62a68</a> +         schema = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_x", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_y", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_flag", type='Flag')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#63017c44">63017c44</a> +         msConfig.plugins.names = ["base_GaussianCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_NaiveDipoleCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_NaiveDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_PsfDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#c0b62a68">c0b62a68</a> +         ]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
341  <a href="#63017c44">63017c44</a> +         msConfig.slots.psfFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
342  <a href="#63017c44">63017c44</a> +         msConfig.slots.modelFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#63017c44">63017c44</a> +         msConfig.slots.apFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
344  <a href="#63017c44">63017c44</a> +         msConfig.slots.instFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
345  <a href="#63017c44">63017c44</a> +         msConfig.slots.shape = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
346  <a href="#63017c44">63017c44</a> +         msConfig.slots.centroid = "base_GaussianCentroid"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
347  <a href="#c0b62a68">c0b62a68</a> +         msConfig.plugins['ip_diffim_PsfDipoleFlux'].maxPixels = 10</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
348  <a href="#c0b62a68">c0b62a68</a> +         task = ipDiffim.DipoleMeasurementTask(schema, config=msConfig)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
349  <a href="#c0b62a68">c0b62a68</a> +         measCat = afwTable.SourceCatalog(schema)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
350  <a href="#c0b62a68">c0b62a68</a> +         measCat.defineCentroid("centroid")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
351  <a href="#c0b62a68">c0b62a68</a> +         source = measCat.addNew()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
352  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_x", self.xc)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
353  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_y", self.yc)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
354  <a href="#09f5006c">09f5006c</a> +         source.setFootprint(s.getFootprint())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
355  <a href="#c0b62a68">c0b62a68</a> +         # Then run the default SFM task.  Results not checked</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#c0b62a68">c0b62a68</a> +         task.run(measCat, exposure)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
357  <a href="#c0b62a68">c0b62a68</a> +         self.assertEqual(source.get("ip_diffim_PsfDipoleFlux_flags_maxpix"), True)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#c0b62a68">c0b62a68</a> + </div>
                
                    def measureDipole(self, s, exp):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
361  <a href="#c0b62a68">c0b62a68</a> +         msConfig = ipDiffim.DipoleMeasurementConfig()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
505  <a href="#fd69e815">fd69e815</a> -         schema  = afwTable.SourceTable.makeMinimalSchema()</div>
              ?                -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
362  <a href="#c0b62a68">c0b62a68</a> +         schema = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
506  <a href="#fd69e815">fd69e815</a> -         msb     = measAlg.MeasureSourcesBuilder()\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
507  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(ipDiffim.NaiveDipoleCentroidControl())\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
508  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(ipDiffim.NaiveDipoleFluxControl())\</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
509  <a href="#fd69e815">fd69e815</a> -                    .addAlgorithm(ipDiffim.PsfDipoleFluxControl())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
510  <a href="#fd69e815">fd69e815</a> -         ms      = msb.build(schema)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
363  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_x", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
364  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_y", type=float)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
365  <a href="#c0b62a68">c0b62a68</a> +         schema.addField("centroid_flag", type='Flag')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
366  <a href="#63017c44">63017c44</a> +         msConfig.plugins.names = ["base_GaussianCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
367  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_NaiveDipoleCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
368  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_NaiveDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
369  <a href="#c0b62a68">c0b62a68</a> +             "ip_diffim_PsfDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
370  <a href="#c0b62a68">c0b62a68</a> +         ]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
371  <a href="#63017c44">63017c44</a> +         msConfig.slots.psfFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
372  <a href="#63017c44">63017c44</a> +         msConfig.slots.modelFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
373  <a href="#63017c44">63017c44</a> +         msConfig.slots.apFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
374  <a href="#63017c44">63017c44</a> +         msConfig.slots.instFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
375  <a href="#63017c44">63017c44</a> +         msConfig.slots.shape = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
376  <a href="#63017c44">63017c44</a> +         msConfig.slots.centroid = "base_GaussianCentroid"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
377  <a href="#c0b62a68">c0b62a68</a> +         task = ipDiffim.DipoleMeasurementTask(schema, config=msConfig)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
511  <a href="#fd69e815">fd69e815</a> -         table   = afwTable.SourceTable.make(schema)</div>
              ?          ------                  ^ ^ ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
378  <a href="#c0b62a68">c0b62a68</a> +         measCat = afwTable.SourceCatalog(schema)</div>
              ?         ++++++                   ^ ^^ ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
512  <a href="#fd69e815">fd69e815</a> -         source  = table.makeRecord()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
379  <a href="#c0b62a68">c0b62a68</a> +         measCat.defineCentroid("centroid")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
380  <a href="#c0b62a68">c0b62a68</a> +         source = measCat.addNew()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
381  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_x", self.xc)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
382  <a href="#c0b62a68">c0b62a68</a> +         source.set("centroid_y", self.yc)</div>
                        source.setFootprint(s.getFootprint())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
514  <a href="#fd69e815">fd69e815</a> -         ms.apply(source, exp, afwGeom.Point2D(self.xc, self.yc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
515  <a href="#fd69e815">fd69e815</a> -         return source </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
384  <a href="#c0b62a68">c0b62a68</a> +         # Then run the default SFM task.  Results not checked</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
385  <a href="#c0b62a68">c0b62a68</a> +         task.run(measCat, exp)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
386  <a href="#c0b62a68">c0b62a68</a> +         return measCat[0]</div>
                
                    def testDipoleAnalysis(self):
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
                        source = self.measureDipole(s, exposure)
                        dpAnalysis = ipDiffim.DipoleAnalysis()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
521  <a href="#fd69e815">fd69e815</a> -         results = dpAnalysis(source)</div>
              ?        ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
392  <a href="#966eaa96">966eaa96</a> +         dpAnalysis(source)</div>
                
                    def testDipoleDeblender(self):
                        psf, psfSum, exposure, s = createDipole(self.w, self.h, self.xc, self.yc)
                        source = self.measureDipole(s, exposure)
                        dpDeblender = ipDiffim.DipoleDeblender()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
527  <a href="#fd69e815">fd69e815</a> -         deblendSource = dpDeblender(source, exposure)</div>
              ?        ----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
398  <a href="#966eaa96">966eaa96</a> +         dpDeblender(source, exposure)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
528  <a href="#fd69e815">fd69e815</a> -         </div>
                
                class DipoleMeasurementTaskTest(unittest.TestCase):
                    """A test case for the DipoleMeasurementTask.  Essentially just
                    test the classification flag since the invididual algorithms are
                    tested above"""
                    def setUp(self):
                        self.config = ipDiffim.DipoleMeasurementConfig()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
536  <a href="#fd69e815">fd69e815</a> -         self.config.algorithms.names.add("centroid.dipole.naive")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
537  <a href="#fd69e815">fd69e815</a> -         self.config.algorithms.names.add("flux.dipole.naive")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
538  <a href="#fd69e815">fd69e815</a> -         self.config.algorithms.names.add("flux.dipole.psf")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
406  <a href="#63017c44">63017c44</a> +         self.config.plugins.names = ["base_GaussianCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#63017c44">63017c44</a> +             "ip_diffim_NaiveDipoleCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#63017c44">63017c44</a> +             "ip_diffim_NaiveDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#63017c44">63017c44</a> +             "ip_diffim_PsfDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#63017c44">63017c44</a> +         ]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
411  <a href="#63017c44">63017c44</a> +         self.config.slots.psfFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#63017c44">63017c44</a> +         self.config.slots.modelFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
413  <a href="#63017c44">63017c44</a> +         self.config.slots.apFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
414  <a href="#63017c44">63017c44</a> +         self.config.slots.instFlux = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
415  <a href="#63017c44">63017c44</a> +         self.config.slots.shape = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
416  <a href="#63017c44">63017c44</a> +         self.config.slots.centroid = "base_GaussianCentroid"</div>
                
                    def tearDown(self):
                        del self.config
                
                    def testMeasure(self):
                        schema = afwTable.SourceTable.makeMinimalSchema()
                        dipoleFlag = ipDiffim.DipoleMeasurementTask._ClassificationFlag
                        schema.addField(dipoleFlag, "F", "probability of being a dipole")
                        task = ipDiffim.DipoleMeasurementTask(schema, config=self.config)
                        table = afwTable.SourceTable.make(schema)
                        sources = afwTable.SourceCatalog(table)
                        source = sources.addNew()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
551  <a href="#fd69e815">fd69e815</a> -     </div>
                        # make fake image
                        psf, psfSum, exposure, s = createDipole(100, 100, 50, 50)
                
                        # set it in source with the appropriate schema
                        source.setFootprint(s.getFootprint())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
557  <a href="#fd69e815">fd69e815</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
558  <a href="#fd69e815">fd69e815</a> -         task.run(exposure, sources)</div>
              ?                          ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
434  <a href="#c0b62a68">c0b62a68</a> +         task.run(sources, exposure)</div>
              ?                  +++++++++
                        self.assertEqual(source.get(dipoleFlag), 1.0)
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DipoleAlgorithmTest)
                    suites += unittest.makeSuite(DipoleMeasurementTaskTest)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(shouldExit = False):
                    """Run the tests"""
                    tests.run(suite(), shouldExit)
                
                if __name__ == "__main__":
                    run(True)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="8a966ce1"/></a>8a966ce1</h3>

<pre>
commit 8a966ce11b186727f265b1366f672c504e20ddcf
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 12 14:19:38 2013 -0800

    Fixing line lengths to be <= 110 characters.  #2595
</pre>
<h3><a name="fd69e815"/></a>fd69e815</h3>

<pre>
commit fd69e815370f8de52db9a754e3415d556c4f4d9b
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 8 12:17:06 2013 -0800

    Unit test for DipoleAlgorithm and DipoleMeasurementTask.  #2595
</pre>
<h3><a name="ba3cc03d"/></a>ba3cc03d</h3>

<pre>
commit ba3cc03d93eea385436c8055be5ee0765830e4bd
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Sat Apr 25 13:16:04 2015 -0400

    Revert config value in test after change in defaults.
    
    We've changed the default for detection.returnOriginalFootprints,
    so we need to change the value in the test back to the old value
    to keep it happy.
</pre>
<h3><a name="1d2154bc"/></a>1d2154bc</h3>

<pre>
commit 1d2154bc369768169a08cd7a0b30a79a8cdcec46
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Tue Apr 23 18:18:58 2013 -0400

    Update new code to reflect lower-level API changes made on next
    
     - Removed createPsf usage
    
     - Change in measurement algorithm construction API
    
     - Psf no longer has getKernel, and PsfAttributes is deprecated
    
     - No more external aperture corrections
    
     - Psf::computeImage no longer normalizes to peak by default
    
     - Can't rely on SourceMeasurementTask.run() to call classify() anymore
    
     - Sizes coming out of Psf::computeShape aren't quite the same as
    those produced by PsfAttributes
    
     - Use bbox.clip to find bounding box overlaps
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="19d923ab"/></a>19d923ab</h3>

<pre>
commit 19d923ab86ca23eb96132abd2bb1dae7869cb17d
Author: pgee <pgee@pgeepc2.gateway.2wire.net>
Date:   Wed Aug 20 03:35:59 2014 -0700

    DM-958 change table.setVersion calls to schema.setVersion
</pre>
<h3><a name="09f5006c"/></a>09f5006c</h3>

<pre>
commit 09f5006c4747e914f968221af3c4fefc821e8d1e
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Mar 11 14:52:48 2014 -0500

    Adding test to check new max pixels flag
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
<h3><a name="fd69e815"/></a>fd69e815</h3>

<pre>
commit fd69e815370f8de52db9a754e3415d556c4f4d9b
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 8 12:17:06 2013 -0800

    Unit test for DipoleAlgorithm and DipoleMeasurementTask.  #2595
</pre>
<h3><a name="63017c44"/></a>63017c44</h3>

<pre>
commit 63017c44a037040f39b2d90fe6b815b58cb68d4a
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Sun Mar 1 14:24:39 2015 -0600

    Responses to PR from Simon and John
</pre>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_16"><a name="tests/KernelSumVisitor.py"/></a>tests/KernelSumVisitor.py</h1>

<h3 id="toc_17">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c96bb23c">c96bb23c</a> - import os, sys</div>
                import unittest
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#c96bb23c">c96bb23c</a> + </div>
                import lsst.utils.tests as tests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#c96bb23c">c96bb23c</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.geom as afwGeom
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 3)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "DF"
                        self.subconfig = self.config.kernel.active
                
                        self.policy = pexConfig.makePolicy(self.subconfig)
                        self.kList  = ipDiffim.makeKernelBasisList(self.subconfig)
                
                    def makeCandidate(self, kSum, x, y, size = 51):
                        mi1 = afwImage.MaskedImageF(afwGeom.Extent2I(size, size))
                        mi1.getVariance().set(1.0) # avoid NaNs
                        mi1.set(size//2, size//2, (1, 0x0, 1))
                        mi2 = afwImage.MaskedImageF(afwGeom.Extent2I(size, size))
                        mi2.getVariance().set(1.0) # avoid NaNs
                        mi2.set(size//2, size//2, (kSum, 0x0, kSum))
                        kc = ipDiffim.makeKernelCandidate(x, y, mi1, mi2, self.policy)
                        return kc
                    
                    def tearDown(self):
                        del self.policy
                        del self.kList
                
                    def testAggregate(self, kSums = [1., 1., 1., 1., 2., 3., 4.]):
                        ksv = ipDiffim.KernelSumVisitorF(self.policy)
                        ksv.setMode(ipDiffim.KernelSumVisitorF.AGGREGATE)
                
                        # should fail, kernel not initialized
                        kc = self.makeCandidate(1, 0.0, 0.0) 
                        try:
                            ksv.processCandidate(kc)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#c7fd30f7">c7fd30f7</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
                            pass
                        else:
                            self.fail()
                            
                        for kSum in kSums:
                            kc = self.makeCandidate(kSum, 0., 0.)
                            kc.build(self.kList)
                            self.assertAlmostEqual(kSum, kc.getKsum(ipDiffim.KernelCandidateF.RECENT))
                            ksv.processCandidate(kc)
                
                        for method in (ksv.getNRejected,
                                       ksv.getkSumMean,
                                       ksv.getkSumStd,
                                       ksv.getdkSumMax,
                                       ksv.getkSumNpts):
                            self.assertEqual(method(), 0.0)
                
                        ksv.processKsumDistribution()
                
                        self.assertEqual(ksv.getNRejected(), 0)
                        self.assertAlmostEqual(ksv.getkSumMean(),
                                               afwMath.makeStatistics(kSums, afwMath.MEANCLIP).getValue(afwMath.MEANCLIP))
                        self.assertAlmostEqual(ksv.getkSumStd(),
                                               afwMath.makeStatistics(kSums, afwMath.STDEVCLIP).getValue(afwMath.STDEVCLIP))
                        self.assertEqual(ksv.getdkSumMax(),
                                         self.policy.get("maxKsumSigma") * ksv.getkSumStd())
                        self.assertEqual(ksv.getkSumNpts(), len(kSums))
                
                
                    def testReject(self):
                        self.doReject(clipping = False)
                        self.doReject(clipping = True)
                
                    def doReject(self, clipping, kSums = [1., 1., 1., 1., 2., 3., 4., 50.]):
                        self.policy.set("kernelSumClipping", clipping)
                        ksv = ipDiffim.KernelSumVisitorF(self.policy)
                        ksv.setMode(ipDiffim.KernelSumVisitorF.AGGREGATE)
                        kcList = []
                
                        for kSum in kSums:
                            kc = self.makeCandidate(kSum, 0., 0.)
                            kc.build(self.kList)
                            kc.setStatus(afwMath.SpatialCellCandidate.GOOD)
                            self.assertAlmostEqual(kSum, kc.getKsum(ipDiffim.KernelCandidateF.RECENT))
                            ksv.processCandidate(kc)
                            kcList.append(kc)
                
                        ksv.processKsumDistribution()
                        
                        ksv.setMode(ipDiffim.KernelSumVisitorF.REJECT)
                        for kc in kcList:
                            ksv.processCandidate(kc)
                            if clipping and kc == kcList[-1]:
                                self.assertEqual(kc.getStatus(), afwMath.SpatialCellCandidate.BAD)
                            else:
                                self.assertEqual(kc.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                
                        if clipping: 
                            self.assertEqual(ksv.getNRejected(), 1)
                        else:
                            self.assertEqual(ksv.getNRejected(), 0)
                
                
                    def testVisit(self, nCell = 3):
                        ksv = ipDiffim.makeKernelSumVisitor(self.policy)
                
                        sizeCellX = self.policy.get("sizeCellX")
                        sizeCellY = self.policy.get("sizeCellY")
                        
                        kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0,
                                                                                             0),
                                                                             afwGeom.Extent2I(sizeCellX * nCell,
                                                                                              sizeCellY * nCell)),
                                                               sizeCellX,
                                                               sizeCellY)
                        
                        for candX in range(nCell):
                            for candY in range(nCell):
                                if candX == nCell // 2 and candY == nCell // 2:
                                    kc = self.makeCandidate(100.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                else:
                                    kc = self.makeCandidate(1.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                kc.build(self.kList)
                                kernelCellSet.insertCandidate(kc)
                
                        ksv.setMode(ipDiffim.KernelSumVisitorF.AGGREGATE)
                        kernelCellSet.visitCandidates(ksv, 1)
                        ksv.processKsumDistribution()
                        ksv.setMode(ipDiffim.KernelSumVisitorF.REJECT)
                        kernelCellSet.visitCandidates(ksv, 1)
                
                        self.assertEqual(ksv.getNRejected(), 1)
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c7fd30f7"/></a>c7fd30f7</h3>

<pre>
commit c7fd30f75b6aabc9baa004bfac209ff1710fbccd
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Apr 6 23:10:28 2010 +0000

    Unit tests.  #1140
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_18"><a name="tests/ModelPsfMatch.py"/></a>tests/ModelPsfMatch.py</h1>

<h3 id="toc_19">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import unittest
                import lsst.utils.tests as tests
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#47b13664">47b13664</a> - import lsst.afw.detection as afwDet</div>
                import lsst.ip.diffim as ipDiffim
                import lsst.meas.algorithms as measAlg
                
                import lsst.pex.logging as pexLog
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class PsfMatchTestCases(unittest.TestCase):
                
                    def setUp(self):
                        self.config    = ipDiffim.ModelPsfMatchTask.ConfigClass()
                        self.subconfig = self.config.kernel.active
                        self.subconfig.scaleByFwhm = False
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#81111946">81111946</a> +         self.subconfig.kernelSize = 9</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#81111946">81111946</a> +         self.subconfig.kernelSizeMin = 9</div>
                
                        self.imsize = 2 * self.subconfig.sizeCellX
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#4e585250">4e585250</a> -         self.ksize  = self.subconfig.kernelSizeMin</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#81111946">81111946</a> +         self.ksize  = 11</div>
                        self.sigma1 = 2.0
                        self.sigma2 = 3.7
                        self.exp    = afwImage.ExposureF(afwGeom.Extent2I(self.imsize, self.imsize))
                        self.exp.setPsf(measAlg.DoubleGaussianPsf(self.ksize, self.ksize, self.sigma1))
                
                    def testTooBig(self):
                        self.subconfig.kernelSize = self.ksize
                        psf = measAlg.DoubleGaussianPsf(self.ksize, self.ksize, self.sigma2)
                        psfMatch = ipDiffim.ModelPsfMatchTask(config=self.config)
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#77ece2b8">77ece2b8</a> -             results = psfMatch.run(self.exp, psf)</div>
              ?            ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#966eaa96">966eaa96</a> +             psfMatch.run(self.exp, psf)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#54c067e4">54c067e4</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            pass
                        else:
                            self.fail()
                
                    def testMatch(self):
                        for order in (0, 1):
                            for ksum in (0.5, 1.0, 2.7):
                                self.runMatch(kOrder = order, kSumIn = ksum)
                        
                    def runMatch(self, kOrder = 0, kSumIn = 3.7):
                        self.subconfig.spatialKernelOrder = kOrder 
                
                        psf = measAlg.DoubleGaussianPsf(self.ksize, self.ksize, self.sigma2)
                        psfMatch = ipDiffim.ModelPsfMatchTask(config=self.config)
                        results = psfMatch.run(self.exp, psf, kernelSum = kSumIn)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#307b43ce">307b43ce</a> -         matchedExp     = results.psfMatchedExposure</div>
                        matchingKernel = results.psfMatchingKernel
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#307b43ce">307b43ce</a> -         kernelCellSet  = results.kernelCellSet</div>
                
                        kImage = afwImage.ImageD(matchingKernel.getDimensions())
                        kSumOut = matchingKernel.computeImage(kImage, False)
                
                        self.assertAlmostEqual(kSumIn, kSumOut)
                
                    def tearDown(self):
                        del self.exp
                        del self.subconfig
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(PsfMatchTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="54c067e4"/></a>54c067e4</h3>

<pre>
commit 54c067e4b3787e53e9588fb6f8210a2c48c1dea5
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 9 18:29:22 2012 -0800

    Final model-to-model matching figured out.
</pre>
<h3><a name="77ece2b8"/></a>77ece2b8</h3>

<pre>
commit 77ece2b8bf9aab07a7b5c50492a86a2cbc5ae32d
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 16:41:56 2012 -0800

    Initial work on making stages pipeBase.Tasks.
</pre>
<h3><a name="4e585250"/></a>4e585250</h3>

<pre>
commit 4e5852509d8fbf32da2a94bc183cb78d9fa1d60f
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Apr 4 11:56:28 2013 -0700

    Fixing failing unit tests.
</pre>
<h3><a name="47b13664"/></a>47b13664</h3>

<pre>
commit 47b136649cf465a2cdd2ee53053fdf8f8f43dbf9
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 8 16:52:38 2012 -0800

    Model to model matching unit tests
</pre>
<h3><a name="307b43ce"/></a>307b43ce</h3>

<pre>
commit 307b43cea0c1bbad988abb0644a5d8fa76343d74
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 16:57:23 2012 -0800

    ModelPsfMatch unit test works!  On to the rest...
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="81111946"/></a>81111946</h3>

<pre>
commit 81111946cc0fd1c91b1caccb9f3e2d922a9a8811
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Aug 11 11:24:34 2014 -0700

    Minor change to unit test regarding psf and kernel sizes
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_20"><a name="examples/jackknifeResampleSpatialKernel.py"/></a>examples/jackknifeResampleSpatialKernel.py</h1>

<h3 id="toc_21">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#efc59e9e">efc59e9e</a> - import pdb</div>
                import sys
                import unittest
                import lsst.utils.tests as tests
                 
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#48e85303">48e85303</a> + import lsst.utils</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#447ace4a">447ace4a</a> - import eups</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#35b48d0c">35b48d0c</a> - import lsst.afw.geom as afwGeom</div>
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
                import lsst.afw.display.ds9 as ds9
                
                verbosity = 3
                pexLog.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                display   = False
                writefits = False
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#447ace4a">447ace4a</a> - defDataDir = eups.productDir('afwdata')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#48e85303">48e85303</a> + try:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#48e85303">48e85303</a> +     defDataDir = lsst.utils.getPackageDir('afwdata')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#48e85303">48e85303</a> + except Exception:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#48e85303">48e85303</a> +     defDataDir = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#48e85303">48e85303</a> + </div>
                if defDataDir:
                    defTemplatePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                   "v5-e0-c011-a00.sci")
                    defSciencePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                  "v26-e0-c011-a00.sci")
                
                # THIS IS "LEAVE-ONE-OUT" CROSS VALIDATION OF THE SPATIAL KERNEL
                
                class DiffimTestCases(unittest.TestCase):
                    def setUp(self):
                        if not defDataDir:
                            return
                        
                        self.configAL    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configAL.kernel.name = "AL"
                        self.subconfigAL = self.configAL.kernel.active
                
                        self.configDF    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDF.kernel.name = "DF"
                        self.subconfigDF = self.configDF.kernel.active
                
                        self.configDFr    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDFr.kernel.name = "DF"
                        self.subconfigDFr = self.configDFr.kernel.active
                
                        self.subconfigDF.useRegularization = False
                        self.subconfigDFr.useRegularization = True
                        
                        self.scienceExposure   = afwImage.ExposureF(defSciencePath)
                        self.templateExposure  = afwImage.ExposureF(defTemplatePath)
                
                        warper = afwMath.Warper.fromConfig(self.subconfigAL.warpingConfig)
                        self.templateExposure = warper.warpExposure(self.scienceExposure.getWcs(), self.templateExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#ba091865">ba091865</a> -                                                     destBBox = self.scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                                             ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#9250fe88">9250fe88</a> +                                                     destBBox = self.scienceExposure.getBBox())</div>
                
                        self.scienceMaskedImage = self.scienceExposure.getMaskedImage()
                        self.templateMaskedImage = self.templateExposure.getMaskedImage()
                        self.dStats = ipDiffim.ImageStatisticsF()
                        
                        bgConfig = self.subconfigAL.afwBackgroundConfig
                        diffimTools.backgroundSubtract(bgConfig,[self.templateMaskedImage,
                                                                 self.scienceMaskedImage])
                
                    def stats(self, cid, diffim, core=5):
                        self.dStats.apply(diffim)
                        pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                     "Candidate %d : Residuals all (%d px): %.3f +/- %.3f" % (cid,
                                                                                              self.dStats.getNpix(),
                                                                                              self.dStats.getMean(),
                                                                                              self.dStats.getRms()))
                
                        
                        self.dStats.apply(diffim, core)
                        pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                     "Candidate %d : Residuals core (%d px): %.3f +/- %.3f" % (cid,
                                                                                               self.dStats.getNpix(),
                                                                                               self.dStats.getMean(),
                                                                                               self.dStats.getRms()))
                        
                    def assess(self, cand, kFn1, bgFn1, kFn2, bgFn2, frame0):
                        tmi   = cand.getTemplateMaskedImage()
                        smi   = cand.getScienceMaskedImage()
                        
                        im1   = afwImage.ImageD(kFn1.getDimensions())
                        kFn1.computeImage(im1, False,
                                          afwImage.indexToPosition(int(cand.getXCenter())),
                                          afwImage.indexToPosition(int(cand.getYCenter())))
                        fk1   = afwMath.FixedKernel(im1)
                        bg1   = bgFn1(afwImage.indexToPosition(int(cand.getXCenter())),
                                      afwImage.indexToPosition(int(cand.getYCenter())))
                        d1    = ipDiffim.convolveAndSubtract(tmi, smi, fk1, bg1)
                
                        ####
                        
                        im2   = afwImage.ImageD(kFn2.getDimensions())
                        kFn2.computeImage(im2, False,
                                          afwImage.indexToPosition(int(cand.getXCenter())),
                                          afwImage.indexToPosition(int(cand.getYCenter())))
                        fk2   = afwMath.FixedKernel(im2)
                        bg2   = bgFn2(afwImage.indexToPosition(int(cand.getXCenter())),
                                      afwImage.indexToPosition(int(cand.getYCenter())))
                        d2    = ipDiffim.convolveAndSubtract(tmi, smi, fk2, bg2)
                
                        if display:
                            ds9.mtv(tmi, frame=frame0+0)
                            ds9.dot("Cand %d" % (cand.getId()), 0, 0, frame=frame0+0)
                            
                            ds9.mtv(smi, frame=frame0+1)
                            ds9.mtv(im1, frame=frame0+2)
                            ds9.mtv(d1,  frame=frame0+3)
                            ds9.mtv(im2, frame=frame0+4)
                            ds9.mtv(d2,  frame=frame0+5)
                
                        pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                     "Full Spatial Model")
                        self.stats(cand.getId(), d1)
                
                        pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                     "N-1 Spatial Model")
                        self.stats(cand.getId(), d2)
                            
                    def setStatus(self, cellSet, cid, value):
                        # ideally
                        # cellSet.getCandidateById(id).setStatus(value)
                        for cell in cellSet.getCellList():
                            for cand in cell.begin(False):
                                cand = ipDiffim.cast_KernelCandidateF(cand)
                                if (cand.getId() == cid):
                                    cand.setStatus(value)
                                    return cand
                
                    def jackknifeResample(self, psfmatch, results):
                        
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#9132c9cd">9132c9cd</a> -         diffim  = results.subtractedImage</div>
                        kernel  = results.psfMatchingKernel
                        bg      = results.backgroundModel
                        cellSet = results.kernelCellSet
                        
                        goodList = []
                        for cell in cellSet.getCellList():
                            print
                            for cand in cell.begin(False):
                                cand = ipDiffim.cast_KernelCandidateF(cand)
                
                                if cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                    goodList.append(cand.getId())
                                else:
                                    # This is so that UNKNOWNs are not processed
                                    cand.setStatus(afwMath.SpatialCellCandidate.BAD)
                
                        nStarPerCell = self.config.nStarPerCell
                        policy = pexConfig.makePolicy(self.config)
                        for idx in range(len(goodList)):
                            cid   = goodList[idx]
                
                            print # clear the screen
                            pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                         "Removing candidate %d" % (cid))
                            
                            cand = self.setStatus(cellSet, cid, afwMath.SpatialCellCandidate.BAD)
                
                            # From _solve
                            regionBBox = cellSet.getBBox()
                            spatialkv  = ipDiffim.BuildSpatialKernelVisitorF(kernel.getKernelList(), regionBBox, policy)
                            cellSet.visitCandidates(spatialkv, nStarPerCell)
                            spatialkv.solveLinearEquation()
                            jkKernel, jkBg = spatialkv.getSolutionPair()
                
                            #jkResults = psfmatch._solve(cellSet, kernel.getKernelList())
                            #jkKernel  = jkResults[1]
                            #jkBg      = jkResults[2]
                
                            # lots of windows
                            # self.assess(cand, kernel, bg, jkKernel, jkBg, 6*idx+1)
                
                            # only 6 windows
                            self.assess(cand, kernel, bg, jkKernel, jkBg, 1)
                
                            self.setStatus(cellSet, cid, afwMath.SpatialCellCandidate.GOOD)
                       
                
                    def runTest(self, mode):
                        pexLog.Trace("lsst.ip.diffim.JackknifeResampleKernel", 1,
                                     "Mode %s" % (mode))
                        if mode == "DF":
                            self.config = self.subconfigDF
                        elif mode == "DFr":
                            self.config = self.subconfigDFr
                        elif mode == "AL":
                            self.config = self.subconfigAL
                        else:
                            raise
                
                        psfmatch = ipDiffim.ImagePsfMatchTask(self.config)
                        results  = psfmatch.run(self.templateMaskedImage,
                                                self.scienceMaskedImage, 
                                                "subtractMaskedImages")
                        self.jackknifeResample(psfmatch, results)
                        
                    def test(self):
                        if not defDataDir:
                            print >> sys.stderr, "Warning: afwdata not set up; not running JackknifeResampleSpatialKernel.py"
                            return
                        
                        self.runTest(mode="AL")
                
                    def tearDown(self):
                        del self.subconfigAL
                        del self.subconfigDF
                        del self.subconfigDFr
                        del self.scienceExposure
                        del self.templateExposure
                        del self.scienceMaskedImage
                        del self.templateMaskedImage
                        del self.dStats
                #####
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    if len(sys.argv) > 3:
                        defTemplatePath = sys.argv[1]
                        defSciencePath  = sys.argv[2]
                
                    if '-d' in sys.argv:
                        display = True
                
                    run(True)
                
                # python tests/JackknifeResampleSpatialKernel.py -d
                # python tests/JackknifeResampleSpatialKernel.py $AFWDATA_DIR/CFHT/D4/cal-53535-i-797722_1_tmpl
                # ... $AFWDATA_DIR/CFHT/D4/cal-53535-i-797722_1 -d
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="9132c9cd"/></a>9132c9cd</h3>

<pre>
commit 9132c9cd2605cd146d2deaa5a007c777d0d7ac34
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Feb 27 13:51:04 2012 -0800

    During subtraction, return "subtractedImage" not "matchedImage"
</pre>
<h3><a name="efc59e9e"/></a>efc59e9e</h3>

<pre>
commit efc59e9e500288a569c008ea7b3ada3a26195942
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Dec 18 23:26:01 2009 +0000

    Python code up to standards.
</pre>
<h3><a name="ba091865"/></a>ba091865</h3>

<pre>
commit ba0918653421659be5c0e545ea256357bfa0df36
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 15 15:26:30 2012 -0800

    All scripts in examples run.
</pre>
<h3><a name="447ace4a"/></a>447ace4a</h3>

<pre>
commit 447ace4a70309f146eafa9faeb621d1e3753d375
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Oct 24 00:44:15 2009 +0000

    added unit test to validate spatial kernel model.  #876.
</pre>
<h3><a name="35b48d0c"/></a>35b48d0c</h3>

<pre>
commit 35b48d0c13a034ca1391534936066d1322681c1d
Author: rowen <rowen@git.lsstcorp.org>
Date:   Mon Apr 18 20:26:34 2011 +0000

    Many fixes for afw #1556
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_22"><a name="tests/subtractExposures.py"/></a>tests/subtractExposures.py</h1>

<h3 id="toc_23">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#efc59e9e">efc59e9e</a> - import pdb</div>
                import sys
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#43787663">43787663</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#b3a497e9">b3a497e9</a> - import lsst.afw.detection as afwDet</div>
                import lsst.meas.algorithms as measAlg
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as logging
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#a544e252">a544e252</a> - import lsst.pex.config as pexConfig</div>
                import lsst.ip.diffim.diffimTools as diffimTools
                
                
                verbosity = 5
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                logging.Trace_setVerbosity('ImagePsfMatchTask', verbosity)
                
                display = False
                
                class DiffimTestCases(unittest.TestCase):
                
                    # D = I - (K.x.T + bg)
                
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "AL"
                        self.subconfig = self.config.kernel.active
                
                        # Some of the tests are sensitive to the centroids returned by
                        # "stdev" vs "pixel_stdev"
                        self.subconfig.detectionConfig.detThresholdType = "stdev"
                
                        # Impacts some of the test values
                        self.subconfig.constantVarianceWeighting = True
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#48e85303">48e85303</a> +         try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#43787663">43787663</a> -         self.defDataDir = eups.productDir('afwdata')</div>
              ?                           ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#48e85303">48e85303</a> +             self.defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ? ++++                          ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#48e85303">48e85303</a> +         except Exception:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#48e85303">48e85303</a> +             self.defDataDir = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#48e85303">48e85303</a> + </div>
                        if self.defDataDir:
                
                            defTemplatePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                           "v5-e0-c011-a00.sci.fits")
                            defSciencePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                          "v26-e0-c011-a00.sci.fits")
                
                            self.scienceImage   = afwImage.ExposureF(defSciencePath)
                            self.templateImage  = afwImage.ExposureF(defTemplatePath)
                
                            bgConfig = self.subconfig.afwBackgroundConfig
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#57b19673">57b19673</a> -             bgConfig.useApprox = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#57b19673">57b19673</a> -             bgConfig.binSize = 512</div>
                            diffimTools.backgroundSubtract(bgConfig,
                                                           [self.templateImage.getMaskedImage(),
                                                            self.scienceImage.getMaskedImage()])
                
                            self.offset   = 1500
                            self.bbox     = afwGeom.Box2I(afwGeom.Point2I(0, self.offset),
                                                          afwGeom.Point2I(511, 2046))
                            self.subconfig.spatialKernelOrder = 1
                            self.subconfig.spatialBgOrder = 0
                
                            # Take a stab at a PSF.  This is needed to get the KernelCandidateList if you don't provide one.
                            ksize  = 21
                            sigma = 2.0
                            self.psf = measAlg.DoubleGaussianPsf(ksize, ksize, sigma)
                            self.scienceImage.setPsf(self.psf)
                
                    def tearDown(self):
                        del self.config
                        if self.defDataDir:
                            del self.scienceImage
                            del self.templateImage
                            del self.psf
                
                    def testModelType(self):
                        self.runModelType(fitForBackground = True)
                        self.runModelType(fitForBackground = False)
                
                    def runModelType(self, fitForBackground):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        self.subconfig.fitForBackground = fitForBackground
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#b3a497e9">b3a497e9</a> -         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                            -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#9250fe88">9250fe88</a> +         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#b3a497e9">b3a497e9</a> -         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                           -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#9250fe88">9250fe88</a> +         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox)</div>
                
                        self.subconfig.spatialModelType = 'chebyshev1'
                        psfmatch1 = ipDiffim.ImagePsfMatchTask(config=self.config)
                        results1 = psfmatch1.subtractExposures(templateSubImage, scienceSubImage, doWarping = True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#45c4be7e">45c4be7e</a> -         differenceExposure1 = results1.subtractedExposure</div>
                        spatialKernel1      = results1.psfMatchingKernel
                        backgroundModel1    = results1.backgroundModel
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#44353598">44353598</a> -         kernelCellSet1      = results1.kernelCellSet</div>
                
                        self.subconfig.spatialModelType = 'polynomial'
                        psfmatch2 = ipDiffim.ImagePsfMatchTask(config=self.config)
                        results2 = psfmatch2.subtractExposures(templateSubImage, scienceSubImage, doWarping = True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#45c4be7e">45c4be7e</a> -         differenceExposure2 = results2.subtractedExposure</div>
                        spatialKernel2      = results2.psfMatchingKernel
                        backgroundModel2    = results2.backgroundModel
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#44353598">44353598</a> -         kernelCellSet2      = results2.kernelCellSet</div>
                
                        # Got the types right?
                        self.assertTrue(
                            spatialKernel1.getSpatialFunctionList()[0].toString().startswith('Chebyshev1Function2')
                            )
                        self.assertTrue(
                            spatialKernel2.getSpatialFunctionList()[0].toString().startswith('PolynomialFunction2')
                            )
                
                        # First order term has zero spatial variation and sum = kernel sum
                        kp1par0 = spatialKernel1.getSpatialFunctionList()[0].getParameters()
                        kp2par0 = spatialKernel2.getSpatialFunctionList()[0].getParameters()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#795b28ed">795b28ed</a> -         self.assertAlmostEqual(kp1par0[0], kp2par0[0], 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#16590662">16590662</a> +         self.assertAlmostEqual(kp1par0[0], kp2par0[0], delta=1e-5)</div>
              ?                                                        +++++++++
                        for i in range(1, len(kp1par0)):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(kp1par0[i], 0.0, 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(kp1par0[i], 0.0, delta=1e-5)</div>
              ?                                                     +++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(kp1par0[i], kp2par0[i], 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(kp1par0[i], kp2par0[i], delta=1e-5)</div>
              ?                                                            +++++++++
                
                        if fitForBackground:
                            # Nterms (zeroth order model)
                            self.assertEqual(backgroundModel1.getNParameters(), 1)
                            self.assertEqual(backgroundModel2.getNParameters(), 1)
                
                            # Same value of function coefficients (different to 0.001 level)
                            self.assertAlmostEqual(backgroundModel1.getParameters()[0],
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#5c1ee4ef">5c1ee4ef</a> -                                    backgroundModel2.getParameters()[0], 3)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#16590662">16590662</a> +                                    backgroundModel2.getParameters()[0], delta=1e-3)</div>
              ?                                                                         +++++++++
                
                            # Functions evaluate to same value at origin (0.001 difference)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#5c1ee4ef">5c1ee4ef</a> -             self.assertAlmostEqual(backgroundModel1(0, 0), backgroundModel2(0, 0), 3)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(backgroundModel1(0, 0), backgroundModel2(0, 0), delta=1e-3)</div>
              ?                                                                                    +++++++++
                
                            # At at different location within image
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#5c1ee4ef">5c1ee4ef</a> -             self.assertAlmostEqual(backgroundModel1(10, 10), backgroundModel2(10, 10), 3)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(backgroundModel1(10, 10), backgroundModel2(10, 10), delta=1e-3)</div>
              ?                                                                                        +++++++++
                
                        else:
                            # More improtant is the kernel needs to be then same when realized at a coordinate
                            kim1 = afwImage.ImageD(spatialKernel1.getDimensions())
                            kim2 = afwImage.ImageD(spatialKernel2.getDimensions())
                            ksum1 = spatialKernel1.computeImage(kim1, False, 0.0, 0.0)
                            ksum2 = spatialKernel2.computeImage(kim2, False, 0.0, 0.0)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#b5c9a415">b5c9a415</a> -             self.assertAlmostEqual(ksum1, ksum2, 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(ksum1, ksum2, delta=1e-5)</div>
              ?                                                  +++++++++
                            for y in range(kim1.getHeight()):
                                for x in range(kim1.getHeight()):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#208d4002">208d4002</a> -                     self.assertAlmostEqual(kim1.get(x, y), kim2.get(x, y), 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#16590662">16590662</a> +                     self.assertAlmostEqual(kim1.get(x, y), kim2.get(x, y), delta=1e-1)</div>
              ?                                                                            +++++++++
                
                            # Nterms (zeroth order)
                            self.assertEqual(backgroundModel1.getNParameters(), 1)
                            self.assertEqual(backgroundModel2.getNParameters(), 1)
                
                            # Zero value in function
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel1.getParameters()[0], 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel1.getParameters()[0], 0.0, delta=1e-7)</div>
              ?                                                                            ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel2.getParameters()[0], 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel2.getParameters()[0], 0.0, delta=1e-7)</div>
              ?                                                                            ++++++++++++
                
                            # Function evaluates to zero
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel1(0, 0), 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel1(0, 0), 0.0, delta=1e-7)</div>
              ?                                                               ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel2(0, 0), 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel2(0, 0), 0.0, delta=1e-7)</div>
              ?                                                               ++++++++++++
                
                            # Spatially...
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel1(10, 10), 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel1(10, 10), 0.0, delta=1e-7)</div>
              ?                                                                 ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#795b28ed">795b28ed</a> -             self.assertAlmostEqual(backgroundModel2(10, 10), 0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#7b0bfeb8">7b0bfeb8</a> +             self.assertAlmostEqual(backgroundModel2(10, 10), 0.0, delta=1e-7)</div>
              ?                                                                 ++++++++++++
                
                    def testWarping(self):
                        # Should fail since images are not aligned
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#b3a497e9">b3a497e9</a> -         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                            -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#9250fe88">9250fe88</a> +         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#b3a497e9">b3a497e9</a> -         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                           -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#9250fe88">9250fe88</a> +         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox)</div>
                        psfmatch = ipDiffim.ImagePsfMatchTask(config=self.config)
                        try:
                            psfmatch.subtractExposures(templateSubImage, scienceSubImage, doWarping = False)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#58addddb">58addddb</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#9250fe88">9250fe88</a> +         except Exception:</div>
                            pass
                        else:
                            self.fail()
                
                    def testXY0(self):
                        self.runXY0('polynomial')
                        self.runXY0('chebyshev1')
                
                    def runXY0(self, poly, fitForBackground = False):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        self.subconfig.spatialModelType = poly
                        self.subconfig.fitForBackground = fitForBackground
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#95fdadee">95fdadee</a> -         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                            -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#9250fe88">9250fe88</a> +         templateSubImage = afwImage.ExposureF(self.templateImage, self.bbox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#95fdadee">95fdadee</a> -         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox, afwImage.PARENT)</div>
              ?                                                                           -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#9250fe88">9250fe88</a> +         scienceSubImage  = afwImage.ExposureF(self.scienceImage, self.bbox)</div>
                
                        # Have an XY0
                        psfmatch  = ipDiffim.ImagePsfMatchTask(config=self.config)
                        results1  = psfmatch.subtractExposures(templateSubImage, scienceSubImage, doWarping = True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#45c4be7e">45c4be7e</a> -         differenceExposure1 = results1.subtractedExposure</div>
                        spatialKernel1      = results1.psfMatchingKernel
                        backgroundModel1    = results1.backgroundModel
                        kernelCellSet1      = results1.kernelCellSet
                
                        # And then take away XY0
                        templateSubImage.setXY0(afwGeom.Point2I(0, 0)) 
                        scienceSubImage.setXY0(afwGeom.Point2I(0, 0))
                        results2  = psfmatch.subtractExposures(templateSubImage, scienceSubImage, doWarping = True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#45c4be7e">45c4be7e</a> -         differenceExposure2 = results2.subtractedExposure</div>
                        spatialKernel2      = results2.psfMatchingKernel
                        backgroundModel2    = results2.backgroundModel
                        kernelCellSet2      = results2.kernelCellSet
                
                        # need to count up the candidates first, since its a running tally
                        count = 0
                        for cell in kernelCellSet1.getCellList():
                            for cand1 in cell.begin(False):
                                count += 1
                
                        for cell in kernelCellSet1.getCellList():
                            for cand1 in cell.begin(False):
                                if cand1.getStatus() == afwMath.SpatialCellCandidate.UNKNOWN:
                                    continue
                                if cand1.getStatus() == afwMath.SpatialCellCandidate.BAD:
                                    continue
                
                                cand1 = ipDiffim.cast_KernelCandidateF(cand1)
                                cand2 = ipDiffim.cast_KernelCandidateF(kernelCellSet2.getCandidateById(cand1.getId()+count))
                
                                # positions are nearly the same (different at the 0.01 pixel level)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#5c1ee4ef">5c1ee4ef</a> -                 self.assertAlmostEqual(cand1.getXCenter(), cand2.getXCenter(), 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#16590662">16590662</a> +                 self.assertAlmostEqual(cand1.getXCenter(), cand2.getXCenter(), delta=1e-1)</div>
              ?                                                                                +++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#5c1ee4ef">5c1ee4ef</a> -                 self.assertAlmostEqual(cand1.getYCenter(), cand2.getYCenter() + self.offset, 1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#16590662">16590662</a> +                 self.assertAlmostEqual(cand1.getYCenter(), cand2.getYCenter() + self.offset, delta=1e-1)</div>
              ?                                                                                              +++++++++
                
                                # kernels are the same
                                im1   = cand1.getKernelImage(ipDiffim.KernelCandidateF.RECENT)
                                im2   = cand2.getKernelImage(ipDiffim.KernelCandidateF.RECENT)
                                for y in range(im1.getHeight()):
                                    for x in range(im1.getWidth()):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#914dc5f4">914dc5f4</a> -                         self.assertAlmostEqual(im1.get(x, y), im2.get(x, y))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#7b0bfeb8">7b0bfeb8</a> +                         self.assertAlmostEqual(im1.get(x, y), im2.get(x, y), delta=1e-7)</div>
              ?                                                                            ++++++++++++
                
                        # Spatial fits are the same
                        skp1 = spatialKernel1.getSpatialParameters()
                        skp2 = spatialKernel2.getSpatialParameters()
                        bgp1 = backgroundModel1.getParameters()
                        bgp2 = backgroundModel2.getParameters()
                
                        # first term = kernel sum, 0, 0
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#b5c9a415">b5c9a415</a> -         self.assertAlmostEqual(skp1[0][0], skp2[0][0], 6)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#16590662">16590662</a> +         self.assertAlmostEqual(skp1[0][0], skp2[0][0], delta=1e-6)</div>
              ?                                                        +++++++++
                
                        # On other terms, the spatial terms are the same, the zpt terms are different
                        for nk in range(1, len(skp1)):
                
                            # Zeropoint
                            if poly == 'polynomial':
                                self.assertNotEqual(skp1[nk][0], skp2[nk][0])
                            elif poly == 'chebyshev1':
                                # Cheby remaps coords, so model should be the same!
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#4f69bfaa">4f69bfaa</a> -                 self.assertAlmostEqual(skp1[nk][0], skp2[nk][0], 4)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#16590662">16590662</a> +                 self.assertAlmostEqual(skp1[nk][0], skp2[nk][0], delta=1e-4)</div>
              ?                                                                  +++++++++
                            else:
                                self.fail()
                
                            # Spatial terms
                            for np in range(1, len(skp1[nk])):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#85679c87">85679c87</a> -                 self.assertAlmostEqual(skp1[nk][np], skp2[nk][np], 4)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#16590662">16590662</a> +                 self.assertAlmostEqual(skp1[nk][np], skp2[nk][np], delta=1e-4)</div>
              ?                                                                    +++++++++
                
                        for np in range(len(bgp1)):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#85679c87">85679c87</a> -             self.assertAlmostEqual(bgp1[np], bgp2[np], 4)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#16590662">16590662</a> +             self.assertAlmostEqual(bgp1[np], bgp2[np], delta=1e-4)</div>
              ?                                                        +++++++++
                
                #####
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="795b28ed"/></a>795b28ed</h3>

<pre>
commit 795b28ed7224606207ca49c8109b01577aad3f17
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 7 12:17:14 2012 -0800

    subtractExposures unit test.
</pre>
<h3><a name="5c1ee4ef"/></a>5c1ee4ef</h3>

<pre>
commit 5c1ee4ef3551a0c8c4135deccf3104d67747267d
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Oct 25 11:54:14 2013 -0500

    Fixing broken unit tests when afwdata is set up
</pre>
<h3><a name="44353598"/></a>44353598</h3>

<pre>
commit 4435359899872b98c16c6f307acf9f7e3ad7990a
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 17:23:31 2012 -0800

    All unit tests pass.
</pre>
<h3><a name="208d4002"/></a>208d4002</h3>

<pre>
commit 208d4002beb37e63fe059d0559ea4bc8361aa303
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Apr 16 16:54:07 2013 -0500

    Fixed tests that failed when afwdata was setup.
</pre>
<h3><a name="914dc5f4"/></a>914dc5f4</h3>

<pre>
commit 914dc5f436225f5d8bdc170aa48b744439eb0bda
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Jun 14 22:42:14 2010 +0000

    Fixed unit test SubtractExpoures.  #1140.
</pre>
<h3><a name="58addddb"/></a>58addddb</h3>

<pre>
commit 58addddb6533136d7aa41f6da4bfe31605f90ed9
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Jun 14 23:08:10 2010 +0000

    added doWarping flag to subtractExposures.  #1140.
</pre>
<h3><a name="85679c87"/></a>85679c87</h3>

<pre>
commit 85679c875fe4939572d4f2ee32f34348cba0d79f
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Dec 12 15:26:21 2011 -0800

    Getting failing unit tests to pass.  One was for deprecated SdqaRating, the other was for precision of comparison.
</pre>
<h3><a name="43787663"/></a>43787663</h3>

<pre>
commit 43787663c16a175e3410e4e310f614f310980529
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Dec 16 22:40:32 2009 +0000

    Added final unit test for XY0 testing.  #876.
</pre>
<h3><a name="45c4be7e"/></a>45c4be7e</h3>

<pre>
commit 45c4be7e577f7807abf4e3e3a4b79c2601a7137b
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Oct 4 14:40:20 2012 -0500

    Sigh, stupid unit test failures (and one legit bug fix)
</pre>
<h3><a name="95fdadee"/></a>95fdadee</h3>

<pre>
commit 95fdadee758122a4d9c7f665481b60a20a9b689c
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Jun 29 23:44:46 2011 +0000

    Update to include policy tuning for different use cases.  Works with afw r21963.  Will upgrade afw to recent tagged version and verify package builds against it.
</pre>
<h3><a name="57b19673"/></a>57b19673</h3>

<pre>
commit 57b19673488ac33f17461fcdeeffdd6203f64d9c
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Mon Apr 20 16:57:34 2015 +0900

    Set tests to use original background config params.
</pre>
<h3><a name="efc59e9e"/></a>efc59e9e</h3>

<pre>
commit efc59e9e500288a569c008ea7b3ada3a26195942
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Dec 18 23:26:01 2009 +0000

    Python code up to standards.
</pre>
<h3><a name="4f69bfaa"/></a>4f69bfaa</h3>

<pre>
commit 4f69bfaa2d64ff15ab4d84c3328f0d20e5859da2
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Apr 16 16:27:39 2013 -0500

    Difference of -1.07588747689e-07 was causing a failed self.assertAlmostEqual
</pre>
<h3><a name="b5c9a415"/></a>b5c9a415</h3>

<pre>
commit b5c9a41517408baa46538faf3eaea09143e7ee2d
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Oct 11 16:47:15 2012 -0500

    Tweaking sensitive almostEqual unit tests.  Were failing on upgrade to Eigen 3.1.1+1.
</pre>
<h3><a name="a544e252"/></a>a544e252</h3>

<pre>
commit a544e2528210d5009d1153e3fe9b7864c34989c6
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Feb 6 14:49:33 2012 -0800

    Additional work on unit tests
</pre>
<h3><a name="b3a497e9"/></a>b3a497e9</h3>

<pre>
commit b3a497e98a5a28c0b7056eb58696f12cee049dad
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Thu Feb 14 16:26:34 2013 -0800

    Fixed unit tests and added detection and measurement code
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7b0bfeb8"/></a>7b0bfeb8</h3>

<pre>
commit 7b0bfeb819c3f98136149264efaf84eeb9404a0f
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jul 28 17:46:51 2014 -0500

    Responding to KTs code review of DM-1001
</pre>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
<h3><a name="16590662"/></a>16590662</h3>

<pre>
commit 16590662a0ee2f19586820b04f6aba5efbd44003
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jul 28 14:34:50 2014 -0500

    Modify assertAlmostEqual in tests/subtractExposures.py
    
    Unit tests that rely on assertAlmostEqual with the "places"
    argument are notoriously sensitive to differences in platform
    and compiler.  I am using them here to test whether two
    numbers are the same to within some tolerance.  This ticket
    modifies the default behavior to instead use the "delta"
    arguement, equivalent to replacing
    
      self.assertAlmostEqual(skp1[nk][np], skp2[nk][np], 4)
    
    with
    
      self.assertTrue(abs(skp1[nk][np]-skp2[nk][np]) < 10**-4)
    
    with the actual change being
    
      self.assertAlmostEqual(skp1[nk][np], skp2[nk][np], delta=1e-4)
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_24"><a name="python/lsst/ip/diffim/dipoleMeasurement.py"/></a>python/lsst/ip/diffim/dipoleMeasurement.py</h1>

<h3 id="toc_25">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010, 2011 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import numpy as np
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.detection as afwDetect
                import lsst.pipe.base as pipeBase
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#05fd57a9">05fd57a9</a> - import lsst.meas.algorithms as measAlg</div>
                import lsst.meas.deblender.baseline as deblendBaseline
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#5f129851">5f129851</a> - from lsst.meas.algorithms import SourceMeasurementTask, SourceMeasurementConfig</div>
              ?                 --------          ^^ ^                   ^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#c0b62a68">c0b62a68</a> + from lsst.meas.base import SingleFrameMeasurementTask, SingleFrameMeasurementConfig</div>
              ?                +  +         ^^^^^^ ^^                   ^^^^^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#2221d837">2221d837</a> + import lsst.afw.display.ds9 as ds9                </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#c0b62a68">c0b62a68</a> + __all__ = ("DipoleMeasurementConfig", "DipoleMeasurementTask", "DipoleAnalysis", "DipoleDeblender")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#c0b62a68">c0b62a68</a> + </div>
                
                class DipoleClassificationConfig(pexConfig.Config):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#2221d837">2221d837</a> +     """!Classification of detected diaSources as dipole or not"""</div>
                    minSn = pexConfig.Field(
                        doc="Minimum quadrature sum of positive+negative lobe S/N to be considered a dipole",
                        dtype=float, default=np.sqrt(2) * 5.0, 
                        )
                    maxFluxRatio = pexConfig.Field(
                        doc = "Maximum flux ratio in either lobe to be considered a dipole",
                        dtype = float, default = 0.65
                        )
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#5f129851">5f129851</a> - class DipoleMeasurementConfig(SourceMeasurementConfig):</div>
              ?                                ^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#c0b62a68">c0b62a68</a> + class DipoleMeasurementConfig(SingleFrameMeasurementConfig):</div>
              ?                                ^^^^^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#2221d837">2221d837</a> +     """!Measurement of detected diaSources as dipoles"""</div>
                    classification = pexConfig.ConfigField(
                        dtype=DipoleClassificationConfig,
                        doc="Dipole classification config"
                        )
                
                    def setDefaults(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#e065f290">e065f290</a> -         self.algorithms.names.add("centroid.dipole.naive")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#e065f290">e065f290</a> -         self.algorithms.names.add("flux.dipole.naive")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#e065f290">e065f290</a> -         self.algorithms.names.add("flux.dipole.psf")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#c0b62a68">c0b62a68</a> +         return</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#c0b62a68">c0b62a68</a> +         self.plugins = ["ipdiffim_NaiveDipoleCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#c0b62a68">c0b62a68</a> +             "ipdiffim_NaiveDipoleFlux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#c0b62a68">c0b62a68</a> +             "ipdiffim_PsfDipoleFlux"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#c0b62a68">c0b62a68</a> +         ]</div>
                        self.doReplaceWithNoise = False
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#2221d837">2221d837</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#2221d837">2221d837</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#2221d837">2221d837</a> + ## \page DipoleMeasurementTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#2221d837">2221d837</a> + ## \ref DipoleMeasurementTask_ "DipoleMeasurementTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#2221d837">2221d837</a> + ## \copybrief DipoleMeasurementTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#2221d837">2221d837</a> + ## \}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#5f129851">5f129851</a> - class DipoleMeasurementTask(SourceMeasurementTask):</div>
              ?                              ^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#c0b62a68">c0b62a68</a> + class DipoleMeasurementTask(SingleFrameMeasurementTask):</div>
              ?                              ^^^^^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#2221d837">2221d837</a> +     """!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#2221d837">2221d837</a> + \anchor DipoleMeasurementTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#2221d837">2221d837</a> + \brief Measurement of Sources, specifically ones from difference images, for characterization as dipoles</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Contents Contents</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Purpose</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Initialize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_IO</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Config</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#2221d837">2221d837</a> +  - \ref ip_diffim_dipolemeas_Example</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Purpose   Description</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#2221d837">2221d837</a> + This class provies a specialized set of Source measurements that allow the user to test the hypothesis that</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#2221d837">2221d837</a> + the Source is a dipole.  This includes a set of measurements derived from intermediate base classes </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#2221d837">2221d837</a> + DipoleCentroidAlgorithm and DipoleFluxAlgorithm.  Their respective algorithm control classes are defined in</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#2221d837">2221d837</a> + DipoleCentroidControl and DipoleFluxControl.  Each centroid and flux measurement will have .neg (negative)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#2221d837">2221d837</a> + and .pos (positive lobe) fields.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#2221d837">2221d837</a> + The first set of measurements uses a "naive" alrogithm for centroid and flux measurements, implemented in</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#2221d837">2221d837</a> + NaiveDipoleCentroidControl and NaiveDipoleFluxControl.  The algorithm uses a naive 3x3 weighted moment around</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#2221d837">2221d837</a> + the nominal centroids of each peak in the Source Footprint.  These algorithms fill the table fields </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#2221d837">2221d837</a> + centroid.dipole.naive.* and flux.dipole.naive.*.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#2221d837">2221d837</a> + The second set of measurements undertakes a joint-Psf model on the negative and positive lobe simultaneously.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#2221d837">2221d837</a> + This fit simultaneously solves for the negative and positive lobe centroids and fluxes using non-linear</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#2221d837">2221d837</a> + least squares minimization.  The fields are stored in table elements flux.dipole.psf.*.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Initialize    Task initialization</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#2221d837">2221d837</a> + \copydoc \_\_init\_\_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_IO        Invoking the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#2221d837">2221d837</a> + \copydoc run</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Config       Configuration parameters</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#2221d837">2221d837</a> + See \ref DipoleMeasurementConfig and \ref DipoleClassificationConfig</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Metadata   Quantities set in Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#2221d837">2221d837</a> + No specific values are set in the Task metadata.  However, the Source schema are modified to store the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#2221d837">2221d837</a> + results of the dipole-specific measurements.  These additional fields include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#2221d837">2221d837</a> +  . classification.dipole : probability of being a dipole</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.pos : unweighted 3x3 first moment centroid</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.pos.err : covariance matrix for centroid.dipole.naive.pos</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.pos.flags : set if the centroid.dipole.naive.pos measurement did not fully succeed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.neg : unweighted 3x3 first moment centroid</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.neg.err : covariance matrix for centroid.dipole.naive.neg</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#2221d837">2221d837</a> +  . centroid.dipole.naive.neg.flags : set if the centroid.dipole.naive.neg measurement did not fully succeed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.pos : raw flux counts</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.pos.err : uncertainty for flux.dipole.naive.pos</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.pos.flags : set if the flux.dipole.naive.pos measurement failed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.neg : raw flux counts</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.neg.err : uncertainty for flux.dipole.naive.neg</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.neg.flags : set if the flux.dipole.naive.neg measurement failed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.npos : number of positive pixels</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#2221d837">2221d837</a> +  . flux.dipole.naive.nneg : number of negative pixels</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos : jointly fitted psf flux counts</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos.err : uncertainty for flux.dipole.psf.pos</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos.flags : set if the flux.dipole.psf.pos measurement failed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg : jointly fitted psf flux counts</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg.err : uncertainty for flux.dipole.psf.neg</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg.flags : set if the flux.dipole.psf.neg measurement failed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.chi2dof : chi2 per degree of freedom of fit</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.centroid : average of the postive and negative lobe positions</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.centroid.err : covariance matrix for flux.dipole.psf.centroid</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.centroid.flags : set if the flux.dipole.psf.centroid measurement did not fully succeed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg.centroid : psf fitted center of negative lobe</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg.centroid.err : covariance matrix for flux.dipole.psf.neg.centroid</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.neg.centroid.flags : set if the flux.dipole.psf.neg.centroid measurement did not fully succeed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos.centroid : psf fitted center of positive lobe</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos.centroid.err : covariance matrix for flux.dipole.psf.pos.centroid</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.pos.centroid.flags : set if the flux.dipole.psf.pos.centroid measurement did not fully succeed</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#2221d837">2221d837</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#2221d837">2221d837</a> +  . flux.dipole.psf.flags.maxpix : set if too large a footprint was sent to the algorithm</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Debug     Debug variables</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#2221d837">2221d837</a> + The \link lsst.pipe.base.cmdLineTask.CmdLineTask command line task\endlink interface supports a</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#2221d837">2221d837</a> + flag \c -d/--debug to import \b debug.py from your \c PYTHONPATH.  The relevant contents of debug.py </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#2221d837">2221d837</a> + for this Task include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#2221d837">2221d837</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#2221d837">2221d837</a> +     import sys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#2221d837">2221d837</a> +     import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#2221d837">2221d837</a> +     def DebugInfo(name):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#2221d837">2221d837</a> +         di = lsstDebug.getInfo(name)   </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#2221d837">2221d837</a> +         if name == "lsst.ip.diffim.dipoleMeasurement":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#2221d837">2221d837</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#2221d837">2221d837</a> +             di.maskTransparency = 90          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#2221d837">2221d837</a> +             di.displayDiaSources = True       # show exposure with dipole results</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#2221d837">2221d837</a> +         return di</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#2221d837">2221d837</a> +     lsstDebug.Info = DebugInfo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#2221d837">2221d837</a> +     lsstDebug.frame = 1      </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#2221d837">2221d837</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#2221d837">2221d837</a> + \section ip_diffim_dipolemeas_Example   A complete example of using DipoleMeasurementTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#2221d837">2221d837</a> + This code is dipoleMeasTask.py in the examples directory, and can be run as \em e.g.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#2221d837">2221d837</a> + \code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#2221d837">2221d837</a> + examples/dipoleMeasTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#2221d837">2221d837</a> + examples/dipoleMeasTask.py --debug </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#2221d837">2221d837</a> + examples/dipoleMeasTask.py --debug --image /path/to/image.fits</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#2221d837">2221d837</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#2221d837">2221d837</a> + \dontinclude dipoleMeasTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#2221d837">2221d837</a> + Start the processing by parsing the command line, where the user has the option of enabling debugging output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#2221d837">2221d837</a> + and/or sending their own image for demonstration (in case they have not downloaded the afwdata package).</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#2221d837">2221d837</a> + \skip main</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#2221d837">2221d837</a> + \until run</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#2221d837">2221d837</a> + \dontinclude dipoleMeasTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#2221d837">2221d837</a> + The processing occurs in the run function.  We first extract an exposure from disk or afwdata, displaying</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#2221d837">2221d837</a> + it if requested:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#2221d837">2221d837</a> + \skip args</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#2221d837">2221d837</a> + \until mtv</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#2221d837">2221d837</a> + Create a default source schema that we will append fields to as we add more algorithms:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#2221d837">2221d837</a> + \skip makeMinimalSchema</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#2221d837">2221d837</a> + \until makeMinimalSchema</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#2221d837">2221d837</a> + Create the detection and measurement Tasks, with some minor tweaking of their configs:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#2221d837">2221d837</a> + \skip Create</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#2221d837">2221d837</a> + \until measureTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#2221d837">2221d837</a> + Having fully initialied the schema, we create a Source table from it:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#2221d837">2221d837</a> + \skip output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#2221d837">2221d837</a> + \until SourceTable</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#2221d837">2221d837</a> + Run detection:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#2221d837">2221d837</a> + \skip Process</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#2221d837">2221d837</a> + \until detectionTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#2221d837">2221d837</a> + Because we are looking for dipoles, we need to merge the positive and negative detections:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#2221d837">2221d837</a> + \skip Merge</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#2221d837">2221d837</a> + \until numNeg</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#2221d837">2221d837</a> + Finally, perform measurement (both standard and dipole-specialized) on the merged sources:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#2221d837">2221d837</a> + \skip measureTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#2221d837">2221d837</a> + \until measureTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#2221d837">2221d837</a> + Optionally display debugging information:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#2221d837">2221d837</a> + \skip Display</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#2221d837">2221d837</a> + \until displayDipoles</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#2221d837">2221d837</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#2221d837">2221d837</a> +     """</div>
                    ConfigClass = DipoleMeasurementConfig
                    _DefaultName = "dipoleMeasurement"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#5f129851">5f129851</a> -     _ClassificationFlag = "classification.dipole"</div>
              ?                                          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#c0b62a68">c0b62a68</a> +     _ClassificationFlag = "classification_dipole"</div>
              ?                                          ^
                
                    def __init__(self, schema, algMetadata=None, **kwds):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#5f129851">5f129851</a> -         """Create the task, adding necessary fields to the given schema.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#2221d837">2221d837</a> +         """!Create the Task, and add Task-specific fields to the provided measurement table schema.</div>
                
                        @param[in,out] schema        Schema object for measurement fields; modified in-place.
                        @param[in,out] algMetadata   Passed to MeasureSources object to be filled with 
                                                     metadata by algorithms (e.g. radii for aperture photometry).
                        @param         **kwds        Passed to Task.__init__.
                        """
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#5f129851">5f129851</a> -         SourceMeasurementTask.__init__(self, schema, algMetadata, **kwds)</div>
              ?          ^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#c0b62a68">c0b62a68</a> +         SingleFrameMeasurementTask.__init__(self, schema, algMetadata, **kwds)</div>
              ?          ^^^^^^ ^^
                        self.dipoleAnalysis = DipoleAnalysis()
                
                    @pipeBase.timeMethod
                    def classify(self, sources):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#2221d837">2221d837</a> +         """!Create the records needed for dipole classification, and run classifier</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#2221d837">2221d837</a> +         @param[in,out] sources       The diaSources to run classification on; modified in in-place</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#2221d837">2221d837</a> +         """</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#2221d837">2221d837</a> + </div>
                        self.log.log(self.log.INFO, "Classifying %d sources" % len(sources))
                        if not sources:
                            return
                
                        ctrl = self.config.classification
                        try:
                            key = sources[0].getSchema().find(self._ClassificationFlag).getKey()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#5f129851">5f129851</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            self.log.warn("Key %s not found in table" % (self._ClassificationFlag))            
                            return
                
                        for source in sources:
                            passesSn = self.dipoleAnalysis.getSn(source) > ctrl.minSn
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#5f129851">5f129851</a> -             negFlux   = np.abs(source.get("flux.dipole.psf.neg"))</div>
              ?                                             ^^^^^     ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#c0b62a68">c0b62a68</a> +             negFlux   = np.abs(source.get("ip_diffim_PsfDipoleFlux_neg_flux"))</div>
              ?                                            +++++ ^^^^^^^^     ^^^^^   +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#5f129851">5f129851</a> -             posFlux   = np.abs(source.get("flux.dipole.psf.pos"))</div>
              ?                                             ^^^^^     ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#c0b62a68">c0b62a68</a> +             posFlux   = np.abs(source.get("ip_diffim_PsfDipoleFlux_pos_flux"))</div>
              ?                                            +++++ ^^^^^^^^     ^^^^^   +++++
                            totalFlux = negFlux + posFlux
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#5f129851">5f129851</a> -             passesFluxNeg = (negFlux / (negFlux + posFlux)) < ctrl.maxFluxRatio</div>
              ?                                        ^^^^^ --------     -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#966eaa96">966eaa96</a> +             passesFluxNeg = (negFlux / totalFlux) < ctrl.maxFluxRatio</div>
              ?                                        ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#5f129851">5f129851</a> -             passesFluxPos = (posFlux / (negFlux + posFlux)) < ctrl.maxFluxRatio</div>
              ?                                        ^^^^^ --------     -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#966eaa96">966eaa96</a> +             passesFluxPos = (posFlux / totalFlux) < ctrl.maxFluxRatio</div>
              ?                                        ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#5f129851">5f129851</a> - </div>
                            if (passesSn and passesFluxPos and passesFluxNeg):
                                val = 1.0
                            else:
                                val = 0.0
                
                            source.set(key, val)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#1d2154bc">1d2154bc</a> -     def run(self, exposure, sources, **kwds):</div>
              ?                             ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#c0b62a68">c0b62a68</a> +     def run(self, sources, exposure, **kwds):</div>
              ?                   +++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#2221d837">2221d837</a> +         """!Run dipole measurement and classification</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#2221d837">2221d837</a> +         @param sources       diaSources that will be measured using dipole measurement</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#63017c44">63017c44</a> +         @param exposure      Exposure on which the diaSources were detected</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#c0b62a68">c0b62a68</a> +         @param **kwds        Sent to SingleFrameMeasurementTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#2221d837">2221d837</a> +         """</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#1d2154bc">1d2154bc</a> -         SourceMeasurementTask.run(self, exposure, sources, **kwds)</div>
              ?          ^^ ^                                     ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#63017c44">63017c44</a> +         SingleFrameMeasurementTask.run(self, sources, exposure, **kwds)</div>
              ?          ^^^^^^ ^^                           +++++++++
                        self.classify(sources)
                
                #########
                # Other Support classs
                #########
                
                class SourceFlagChecker(object):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#2221d837">2221d837</a> +     """!Functor class to check whether a diaSource has flags set that should cause it to be labeled bad."""</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#8a966ce1">8a966ce1</a> -     """A functor to check whether a difference image source has any</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#8a966ce1">8a966ce1</a> -     flags set that should cause it to be labeled bad."""</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#8a966ce1">8a966ce1</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#8a966ce1">8a966ce1</a> -     def __init__(self, sources, badFlags=['flags.pixel.edge', </div>
              ?                                          ^^^^^^^^^^^ ^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#2221d837">2221d837</a> +     def __init__(self, sources, badFlags=None):</div>
              ?                                          ^^^ ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#8a966ce1">8a966ce1</a> -                                           'flags.pixel.interpolated.center', </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#8a966ce1">8a966ce1</a> -                                           'flags.pixel.saturated.center']):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#2221d837">2221d837</a> +         """!Constructor</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#2221d837">2221d837</a> +         @param sources     Sources that will be measured</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#2221d837">2221d837</a> +         @param badFlags    A list of flags that will be used to determine if there was a measurement problem</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#2221d837">2221d837</a> +         The list of badFlags will be used to make a list of keys to check for measurement flags on.  By</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#2221d837">2221d837</a> +         default the centroid keys are added to this list"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#c0b62a68">c0b62a68</a> +         self.badFlags = ['base_PixelFlags_flag_edge', 'base_PixelFlags_flag_interpolatedCenter', 'base_PixelFlags_flag_saturatedCenter']</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
341  <a href="#2221d837">2221d837</a> +         if badFlags is not None:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
342  <a href="#2221d837">2221d837</a> +             for flag in badFlags:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#2221d837">2221d837</a> +                 self.badFlags.append(flag)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#1ebf700c">1ebf700c</a> -         self.keys = [sources.getSchema().find(name).key for name in badFlags]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
344  <a href="#2221d837">2221d837</a> +         self.keys = [sources.getSchema().find(name).key for name in self.badFlags]</div>
              ?                                                                     +++++
                        self.keys.append(sources.table.getCentroidFlagKey())
                
                    def __call__(self, source):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
348  <a href="#2221d837">2221d837</a> +         """!Call the source flag checker on a single Source</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
349  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
350  <a href="#2221d837">2221d837</a> +         @param source      Source that will be examined"""</div>
                        for k in self.keys:
                            if source.get(k):
                                return False
                        return True
                
                class DipoleAnalysis(object):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#5f129851">5f129851</a> -     """A functor to check for dipoles in difference image source tables."""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
357  <a href="#2221d837">2221d837</a> +     """!Functor class that provides (S/N, position, orientation) of measured dipoles"""</div>
                    def __init__(self):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
359  <a href="#2221d837">2221d837</a> +         """!Constructor"""</div>
                        pass
                
                    def __call__(self, source):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
363  <a href="#2221d837">2221d837</a> +         """!Parse information returned from dipole measurement</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
364  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
365  <a href="#2221d837">2221d837</a> +         @param source  The source that will be examined"""</div>
                        return self.getSn(source), self.getCentroid(source), self.getOrientation(source)
                
                    def getSn(self, source):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#5f129851">5f129851</a> -         posflux = source.get("flux.dipole.psf.pos")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#5f129851">5f129851</a> -         posfluxErr = source.get("flux.dipole.psf.pos.err")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#5f129851">5f129851</a> -         negflux = source.get("flux.dipole.psf.neg")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#5f129851">5f129851</a> -         negfluxErr = source.get("flux.dipole.psf.neg.err")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
369  <a href="#2221d837">2221d837</a> +         """!Get the total signal-to-noise of the dipole; total S/N is from positive and negative lobe</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
370  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
371  <a href="#2221d837">2221d837</a> +         @param source  The source that will be examined"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
372  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
373  <a href="#c0b62a68">c0b62a68</a> +         posflux = source.get("ip_diffim_PsfDipoleFlux_pos_flux")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
374  <a href="#c0b62a68">c0b62a68</a> +         posfluxErr = source.get("ip_diffim_PsfDipoleFlux_pos_fluxSigma")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
375  <a href="#c0b62a68">c0b62a68</a> +         negflux = source.get("ip_diffim_PsfDipoleFlux_neg_flux")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
376  <a href="#c0b62a68">c0b62a68</a> +         negfluxErr = source.get("ip_diffim_PsfDipoleFlux_neg_fluxSigma")</div>
                
                        # Not a dipole!
                        if (posflux < 0) is (negflux < 0):
                            return 0
                
                        return np.sqrt((posflux/posfluxErr)**2 + (negflux/negfluxErr)**2)
                
                    def getCentroid(self, source):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#5f129851">5f129851</a> -         negCen = source.get("flux.dipole.psf.neg.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#5f129851">5f129851</a> -         posCen = source.get("flux.dipole.psf.pos.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#5f129851">5f129851</a> -         if (False in np.isfinite(negCen)) or (False in np.isfinite(posCen)):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
385  <a href="#2221d837">2221d837</a> +         """!Get the centroid of the dipole; average of positive and negative lobe</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
386  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
387  <a href="#2221d837">2221d837</a> +         @param source  The source that will be examined"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
388  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
389  <a href="#c0b62a68">c0b62a68</a> +         negCenX = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_x")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
390  <a href="#c0b62a68">c0b62a68</a> +         negCenY = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_y")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#c0b62a68">c0b62a68</a> +         posCenX = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_x")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
392  <a href="#c0b62a68">c0b62a68</a> +         posCenY = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_y")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
393  <a href="#c0b62a68">c0b62a68</a> +         if (np.isinf(negCenX) or np.isinf(negCenY) or np.isinf(posCenX) or np.isinf(posCenY)):</div>
                            return None
                        
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#5f129851">5f129851</a> -         center = afwGeom.Point2D(0.5*(negCen[0]+posCen[0]),</div>
              ?                                             ^^^       ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
396  <a href="#c0b62a68">c0b62a68</a> +         center = afwGeom.Point2D(0.5*(negCenX+posCenX),</div>
              ?                                             ^       ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#5f129851">5f129851</a> -                                  0.5*(negCen[1]+posCen[1]))</div>
              ?                                             ^^^       ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
397  <a href="#c0b62a68">c0b62a68</a> +                                  0.5*(negCenY+posCenY))</div>
              ?                                             ^       ^
                        return center
                
                    def getOrientation(self, source):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#5f129851">5f129851</a> -         negCen = source.get("flux.dipole.psf.neg.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#5f129851">5f129851</a> -         posCen = source.get("flux.dipole.psf.pos.centroid")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#5f129851">5f129851</a> -         if (False in np.isfinite(negCen)) or (False in np.isfinite(posCen)):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
401  <a href="#2221d837">2221d837</a> +         """!Calculate the orientation of dipole; vector from negative to positive lobe</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
402  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
403  <a href="#2221d837">2221d837</a> +         @param source  The source that will be examined"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
404  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
405  <a href="#c0b62a68">c0b62a68</a> +         negCenX = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_x")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
406  <a href="#c0b62a68">c0b62a68</a> +         negCenY = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_y")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#c0b62a68">c0b62a68</a> +         posCenX = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_x")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#c0b62a68">c0b62a68</a> +         posCenY = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_y")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#c0b62a68">c0b62a68</a> +         if (np.isinf(negCenX) or np.isinf(negCenY) or np.isinf(posCenX) or np.isinf(posCenY)):</div>
                            return None
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#5f129851">5f129851</a> -         dx, dy = posCen[0]-negCen[0], posCen[1]-negCen[1]</div>
              ?                        ^^^       ^^^        ^^^       ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#c0b62a68">c0b62a68</a> +         dx, dy = posCenX-negCenX, posCenY-negCenY</div>
              ?                        ^       ^        ^       ^
                        angle  = afwGeom.Angle(np.arctan2(dx, dy), afwGeom.radians)
                        return angle
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#5f129851">5f129851</a> -     def displayDipoles(self, exposure, sources, frame=1):</div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
416  <a href="#2221d837">2221d837</a> +     def displayDipoles(self, exposure, sources):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#5f129851">5f129851</a> -         import lsst.afw.display.ds9 as ds9                </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
417  <a href="#2221d837">2221d837</a> +         """!Display debugging information on the detected dipoles</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
418  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
419  <a href="#2221d837">2221d837</a> +         @param exposure  Image the dipoles were measured on</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
420  <a href="#2221d837">2221d837</a> +         @param sources   The set of diaSources that were measured"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
421  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
422  <a href="#2221d837">2221d837</a> +         import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
423  <a href="#2221d837">2221d837</a> +         display = lsstDebug.Info(__name__).display</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
424  <a href="#2221d837">2221d837</a> +         displayDiaSources = lsstDebug.Info(__name__).displayDiaSources</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
425  <a href="#2221d837">2221d837</a> +         maskTransparency = lsstDebug.Info(__name__).maskTransparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
426  <a href="#2221d837">2221d837</a> +         if not maskTransparency:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
427  <a href="#2221d837">2221d837</a> +             maskTransparency = 90</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
428  <a href="#2221d837">2221d837</a> +         ds9.setMaskTransparency(maskTransparency)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#5f129851">5f129851</a> -         ds9.mtv(exposure, frame=frame)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
429  <a href="#2221d837">2221d837</a> +         ds9.mtv(exposure, frame=lsstDebug.frame)</div>
              ?                                 ++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
430  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
431  <a href="#2221d837">2221d837</a> +         if display and displayDiaSources:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#5f129851">5f129851</a> -         with ds9.Buffering():</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
432  <a href="#2221d837">2221d837</a> +             with ds9.Buffering():</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#5f129851">5f129851</a> -             for source in sources:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
433  <a href="#2221d837">2221d837</a> +                 for source in sources:</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#5f129851">5f129851</a> -                 cen = source.get("flux.dipole.psf.centroid")</div>
              ?                                    ^^^^^     ^^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
434  <a href="#c0b62a68">c0b62a68</a> +                     cenX, cenY = source.get("ipdiffim_DipolePsfFlux_centroid")</div>
              ? ++++                   +++++++               ++++ ^^^^^     ^  ^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#5f129851">5f129851</a> -                 if (False in np.isfinite(cen)):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
435  <a href="#2221d837">2221d837</a> +                     if np.isinf(cenX) or np.isinf(cenY):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#5f129851">5f129851</a> -                     cen = source.getCentroid()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
436  <a href="#2221d837">2221d837</a> +                         cenX, cenY = source.getCentroid()</div>
              ? ++++                       +++++++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#1ebf700c">1ebf700c</a> -                 isdipole = source.get("classification.dipole")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
438  <a href="#2221d837">2221d837</a> +                     isdipole = source.get("classification.dipole")</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#1ebf700c">1ebf700c</a> -                 if isdipole:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
439  <a href="#2221d837">2221d837</a> +                     if isdipole and np.isfinite(isdipole):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
440  <a href="#2221d837">2221d837</a> +                         # Dipole</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#1ebf700c">1ebf700c</a> -                     ctype= "green"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
441  <a href="#2221d837">2221d837</a> +                         ctype= "green"</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#8a966ce1">8a966ce1</a> -                     print "DIPOLE: %.1f,%.1f %.1f,%.1f" % (</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#8a966ce1">8a966ce1</a> -                         cen.getX(), cen.getY(), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#8a966ce1">8a966ce1</a> -                         source.get("flux.dipole.psf.neg"), </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#8a966ce1">8a966ce1</a> -                         source.get("flux.dipole.psf.pos"))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#1ebf700c">1ebf700c</a> -                 else:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
442  <a href="#2221d837">2221d837</a> +                     else:</div>
              ? ++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
443  <a href="#2221d837">2221d837</a> +                         # Not dipole</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#5f129851">5f129851</a> -                     ctype = "red"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
444  <a href="#2221d837">2221d837</a> +                         ctype = "red"</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#5f129851">5f129851</a> -                     print "NOT DIPOLE: %.1f,%.1f" % (cen.getX(), cen.getY())</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#5f129851">5f129851</a> -                 ds9.dot("o", cen.getX(), cen.getY(), size=2, ctype=ctype, frame=frame)</div>
              ?                                 ---- --     ---- --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
446  <a href="#2221d837">2221d837</a> +                     ds9.dot("o", cenX, cenY, size=2, ctype=ctype, frame=lsstDebug.frame)</div>
              ? ++++                                                                    ++++++++++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#5f129851">5f129851</a> -                 negCen = source.get("flux.dipole.psf.neg.centroid")</div>
              ?                                       ^^^^^     ^^^^^   ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
448  <a href="#c0b62a68">c0b62a68</a> +                     negCenX = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_x")</div>
              ? ++++                      +               +++++ ^^^^^^^^     ^^^^^   ^        ++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
449  <a href="#c0b62a68">c0b62a68</a> +                     negCenY = source.get("ip_diffim_PsfDipoleFlux_neg_centroid_y")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#5f129851">5f129851</a> -                 posCen = source.get("flux.dipole.psf.pos.centroid")</div>
              ?                                       ^^^^^     ^^^^^   ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
450  <a href="#c0b62a68">c0b62a68</a> +                     posCenX = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_x")</div>
              ? ++++                      +               +++++ ^^^^^^^^     ^^^^^   ^        ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#5f129851">5f129851</a> -                 if (False in np.isfinite(negCen)) or (False in np.isfinite(posCen)):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
451  <a href="#c0b62a68">c0b62a68</a> +                     posCenY = source.get("ip_diffim_PsfDipoleFlux_pos_centroid_y")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
452  <a href="#2221d837">2221d837</a> +                     if (np.isinf(negCenX) or np.isinf(negCenY) or np.isinf(posCenX) or np.isinf(posCenY)):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#5f129851">5f129851</a> -                     continue</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
453  <a href="#2221d837">2221d837</a> +                         continue</div>
              ? ++++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#8a966ce1">8a966ce1</a> -                 ds9.line([(negCen.getX(), negCen.getY()),(posCen.getX(), posCen.getY())], </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#8a966ce1">8a966ce1</a> -                          ctype="yellow", frame=frame)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#5f129851">5f129851</a> -             </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#5f129851">5f129851</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
455  <a href="#2221d837">2221d837</a> +                     ds9.line([(negCenX, negCenY), (posCenX, posCenY)], ctype="yellow", frame=lsstDebug.frame)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
456  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
457  <a href="#2221d837">2221d837</a> +             lsstDebug.frame += 1</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
458  <a href="#2221d837">2221d837</a> + </div>
                
                
                class DipoleDeblender(object):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#5f129851">5f129851</a> -     """A functor to deblend a source as a dipole, and return a new</div>
              ?        ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
462  <a href="#2221d837">2221d837</a> +     """!Functor to deblend a source as a dipole, and return a new source with deblended footprints.  </div>
              ?        ^^                                                        ++++++++++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#5f129851">5f129851</a> -        source with deblended footprints.  This necessarily overrides</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#5f129851">5f129851</a> -        some of the functionality from</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
463  <a href="#2221d837">2221d837</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
464  <a href="#2221d837">2221d837</a> +        This necessarily overrides some of the functionality from</div>
                       meas_algorithms/python/lsst/meas/algorithms/deblend.py since we
                       need a single source that contains the blended peaks, not
                       multiple children sources.  This directly calls the core
                       deblending code deblendBaseline.deblend (optionally _fitPsf for
                       debugging).
                
                       Not actively being used, but there is a unit test for it in 
                       dipoleAlgorithm.py.
                    """
                    def __init__(self):
                        # Set up defaults to send to deblender
                
                        # Always deblend as Psf
                        self.psfChisqCut1 = self.psfChisqCut2 = self.psfChisqCut2b = np.inf 
                        self.log = pexLog.Log(pexLog.Log.getDefaultLog(), 
                                              'lsst.ip.diffim.DipoleDeblender', pexLog.Log.INFO)
                        self.sigma2fwhm = 2. * np.sqrt(2. * np.log(2.))
                
                    def __call__(self, source, exposure):
                        fp     = source.getFootprint()
                        peaks  = fp.getPeaks()
                        peaksF = [pk.getF() for pk in peaks]
                        fbb    = fp.getBBox()
                        fmask  = afwImage.MaskU(fbb)
                        fmask.setXY0(fbb.getMinX(), fbb.getMinY())
                        afwDetect.setMaskFromFootprint(fmask, fp, 1)
                
                        psf        = exposure.getPsf()
                        psfSigPix  = psf.computeShape().getDeterminantRadius()
                        psfFwhmPix = psfSigPix * self.sigma2fwhm 
                        subimage   = afwImage.ExposureF(exposure, fbb, True)
                        cpsf       = deblendBaseline.CachingPsf(psf)
                
                        # if fewer than 2 peaks, just return a copy of the source
                        if len(peaks) < 2:
                            return source.getTable().copyRecord(source)
                
                        # make sure you only deblend 2 peaks; take the brighest and faintest
                        speaks = [(p.getPeakValue(), p) for p in peaks]
                        speaks.sort() 
                        dpeaks = [speaks[0][1], speaks[-1][1]]
                
                        # and only set these peaks in the footprint (peaks is mutable)
                        peaks.clear()
                        for peak in dpeaks:
                            peaks.append(peak)
                
                        if True:
                            # Call top-level deblend task
                            fpres = deblendBaseline.deblend(fp, exposure.getMaskedImage(), psf, psfFwhmPix,
                                                            log = self.log,
                                                            psfChisqCut1 = self.psfChisqCut1,
                                                            psfChisqCut2 = self.psfChisqCut2,
                                                            psfChisqCut2b = self.psfChisqCut2b)
                        else:
                            # Call lower-level _fit_psf task
                
                            # Prepare results structure
                            fpres = deblendBaseline.PerFootprint()
                            fpres.peaks = []
                            for pki,pk in enumerate(dpeaks):
                                pkres = deblendBaseline.PerPeak()
                                pkres.peak = pk
                                pkres.pki = pki
                                fpres.peaks.append(pkres)
                            
                            for pki,(pk,pkres,pkF) in enumerate(zip(dpeaks, fpres.peaks, peaksF)):
                                self.log.logdebug('Peak %i' % pki)
                                deblendBaseline._fitPsf(fp, fmask, pk, pkF, pkres, fbb, dpeaks, peaksF, self.log, 
                                                         cpsf, psfFwhmPix, 
                                                         subimage.getMaskedImage().getImage(), 
                                                         subimage.getMaskedImage().getVariance(), 
                                                         self.psfChisqCut1, self.psfChisqCut2, self.psfChisqCut2b)
                
                
                        deblendedSource = source.getTable().copyRecord(source)
                        deblendedSource.setParent(source.getId())
                        peakList        = deblendedSource.getFootprint().getPeaks()
                        peakList.clear()
                
                        for i, peak in enumerate(fpres.peaks):
                            if peak.psfFitFlux > 0:
                                suffix = "pos"
                            else:
                                suffix = "neg"
                            c = peak.psfFitCenter
                            self.log.info("deblended.centroid.dipole.psf.%s %f %f" % (
                                suffix, c[0], c[1]))
                            self.log.info("deblended.chi2dof.dipole.%s %f" % (
                                suffix, peak.psfFitChisq / peak.psfFitDof))
                            self.log.info("deblended.flux.dipole.psf.%s %f" % (
                                suffix, peak.psfFitFlux * np.sum(peak.templateMaskedImage.getImage().getArray())))
                            peakList.append(peak.peak)
                        return deblendedSource
                        
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="5f129851"/></a>5f129851</h3>

<pre>
commit 5f129851baaa70fc33b4b83d82b68c39393a689b
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 8 10:22:00 2013 -0800

    Creating class for dipole measurment, so we can override the classification method.  This method will be optimized for dipoles.  #2595
</pre>
<h3><a name="1d2154bc"/></a>1d2154bc</h3>

<pre>
commit 1d2154bc369768169a08cd7a0b30a79a8cdcec46
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Tue Apr 23 18:18:58 2013 -0400

    Update new code to reflect lower-level API changes made on next
    
     - Removed createPsf usage
    
     - Change in measurement algorithm construction API
    
     - Psf no longer has getKernel, and PsfAttributes is deprecated
    
     - No more external aperture corrections
    
     - Psf::computeImage no longer normalizes to peak by default
    
     - Can't rely on SourceMeasurementTask.run() to call classify() anymore
    
     - Sizes coming out of Psf::computeShape aren't quite the same as
    those produced by PsfAttributes
    
     - Use bbox.clip to find bounding box overlaps
</pre>
<h3><a name="1ebf700c"/></a>1ebf700c</h3>

<pre>
commit 1ebf700c8fe62056104fc1309ed6c867b0f8523b
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 8 11:06:05 2013 -0800

    Moved SourceFlagChecker into dipoleMeasurement.  #2595
</pre>
<h3><a name="05fd57a9"/></a>05fd57a9</h3>

<pre>
commit 05fd57a99d27088ffde605369360a4f1883d5dbd
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 8 11:19:15 2013 -0800

    Unit test fix.  #2595
</pre>
<h3><a name="8a966ce1"/></a>8a966ce1</h3>

<pre>
commit 8a966ce11b186727f265b1366f672c504e20ddcf
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 12 14:19:38 2013 -0800

    Fixing line lengths to be <= 110 characters.  #2595
</pre>
<h3><a name="e065f290"/></a>e065f290</h3>

<pre>
commit e065f290344ebf2a6578a0871126c90f07dacb93
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 12 16:24:36 2013 -0800

    Set defaults for dipole measurements in DipoleMeasurementConfig  #2595
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
<h3><a name="2221d837"/></a>2221d837</h3>

<pre>
commit 2221d83708299028c32cd514a32bca0e218f4a25
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Aug 11 09:07:24 2014 -0700

    Task documentation and example script for DipoleMeasurementTask
</pre>
<h3><a name="63017c44"/></a>63017c44</h3>

<pre>
commit 63017c44a037040f39b2d90fe6b815b58cb68d4a
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Sun Mar 1 14:24:39 2015 -0600

    Responses to PR from Simon and John
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_26"><a name="ups/ip_diffim.table"/></a>ups/ip_diffim.table</h1>

<h3 id="toc_27">Diff:</h3>

<pre>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#0489d6ec">0489d6ec</a> - setupRequired(afw >= 6.1.0.0)</div>
              ?                  -----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#edf74dbc">edf74dbc</a> + setupRequired(afw)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#0489d6ec">0489d6ec</a> - setupRequired(meas_algorithms >= 6.1.0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c0b62a68">c0b62a68</a> + setupRequired(meas_base)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#699a8d1f">699a8d1f</a> - setupRequired(meas_deblender >= 6.1.0.0)</div>
              ?                             -----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#edf74dbc">edf74dbc</a> + setupRequired(meas_deblender)</div>
                setupRequired(numpy)
                setupRequired(pex_config)
                setupRequired(pipe_base)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#48e85303">48e85303</a> + setupRequired(utils)</div>
                
                setupOptional(afwdata)
                setupOptional(matplotlib)
                
                envPrepend(LD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)
                envPrepend(DYLD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)
                envPrepend(PYTHONPATH, ${PRODUCT_DIR}/python) 
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="0489d6ec"/></a>0489d6ec</h3>

<pre>
commit 0489d6ecd73b87105aacf2fb7392612905b02ab7
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Nov 27 10:50:54 2012 -0800

    Fixed table to depend on 6.1 packages.
</pre>
<h3><a name="699a8d1f"/></a>699a8d1f</h3>

<pre>
commit 699a8d1f60d194541b0d5a3017ae1cbe8379df3a
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 14 11:25:07 2013 -0800

    Fixed dependency on meas_deblender; on master.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
<h3><a name="edf74dbc"/></a>edf74dbc</h3>

<pre>
commit edf74dbce4b2d495fd9c4e73ffbc22e438ec44da
Author: Mario Juric <mjuric@lsst.org>
Date:   Wed Mar 5 16:29:17 2014 -0600

    removed explicit versions from the table file.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_28"><a name="examples/runMatchMaskedImages.py"/></a>examples/runMatchMaskedImages.py</h1>

<h3 id="toc_29">Diff:</h3>

<pre>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#610143fd">610143fd</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import sys
                import os
                import optparse
                
                import lsst.afw.image as afwImage
                import lsst.afw.display.ds9 as ds9
                
                from lsst.pex.logging import Trace
                from lsst.pex.logging import Log
                
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                
                def main():
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#610143fd">610143fd</a> -     imageProcDir = eups.productDir('ip_diffim')</div>
              ?                    ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#48e85303">48e85303</a> +     imageProcDir = lsst.utils.getPackageDir('ip_diffim')</div>
              ?                    ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#610143fd">610143fd</a> -     if imageProcDir == None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#610143fd">610143fd</a> -         print 'Error: could not set up ip_diffim'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#610143fd">610143fd</a> -         sys.exit(1)</div>
                
                    defSciencePath  = None
                    defTemplatePath = None
                    defOutputPath   = 'matchedImage.fits'
                    defVerbosity    = 5
                    defFwhm         = 3.5
                    
                    usage = """usage: %%prog [options] [scienceImage [templateImage [outputImage]]]]
                
                Notes:
                - image arguments are paths to MaskedImage fits files
                - image arguments must NOT include the final _img.fits
                - the result is science image matched template image
                - the template image is convolved, the science image is not
                - default scienceMaskedImage=%s
                - default templateMaskedImage=%s
                - default outputImage=%s 
                """ % (defSciencePath, defTemplatePath, defOutputPath)
                    
                    parser = optparse.OptionParser(usage)
                    parser.add_option('-v', '--verbosity', type=int, default=defVerbosity,
                                      help='verbosity of Trace messages')
                    parser.add_option('-d', '--display', action='store_true', default=False,
                                      help='display the images')
                    parser.add_option('-b', '--bg', action='store_true', default=False,
                                      help='subtract backgrounds')
                    parser.add_option('--fwhmS', type=float,
                                      help='Science Image Psf Fwhm (pixel)')
                    parser.add_option('--fwhmT', type=float,
                                      help='Template Image Psf Fwhm (pixel)')
                                      
                    (options, args) = parser.parse_args()
                    
                    def getArg(ind, defValue):
                        if ind < len(args):
                            return args[ind]
                        return defValue
                    
                    sciencePath     = getArg(0, defSciencePath)
                    templatePath    = getArg(1, defTemplatePath)
                    outputPath      = getArg(2, defOutputPath)
                
                    if sciencePath == None or templatePath == None:
                        parser.print_help()
                        sys.exit(1)
                    
                    print 'Science image: ', sciencePath
                    print 'Template image:', templatePath
                    print 'Output image:  ', outputPath
                
                    fwhmS = defFwhm
                    if options.fwhmS:
                        print 'FwhmS =', options.fwhmS
                        fwhmS = options.fwhmS
                
                    fwhmT = defFwhm
                    if options.fwhmT:
                        print 'Fwhmt =', options.fwhmT
                        fwhmT = options.fwhmT
                
                    display = False
                    if options.display:
                        print 'Display =', options.display
                        display = True
                
                    bgSub = False
                    if options.bg:
                        print 'Background subtract =', options.bg
                        bgSub = True
                
                    if options.verbosity > 0:
                        print 'Verbosity =', options.verbosity
                        Trace.setVerbosity('lsst.ip.diffim', options.verbosity)
                        
                    ####
                        
                    templateMaskedImage = afwImage.MaskedImageF(templatePath)
                    scienceMaskedImage  = afwImage.MaskedImageF(sciencePath)
                
                    config = ipDiffim.ImagePsfMatch.ConfigClass()
                    config.kernel.name = "AL"
                    subconfig = config.kernel.active
                
                    if bgSub:
                        diffimTools.backgroundSubtract(subconfig.afwBackgroundConfig,
                                                       [templateMaskedImage, scienceMaskedImage])
                    else:
                        if subconfig.fitForBackground == False:
                            print 'NOTE: no background subtraction at all is requested'
                
                    psfmatch = ipDiffim.ImagePsfMatch(subconfig)
                    results  = psfmatch.matchMaskedImages(templateMaskedImage, scienceMaskedImage,
                                                          templateFwhmPix = fwhmT, scienceFwhmPix = fwhmS)
                
                    matchMaskedImage = results[0]
                    matchMaskedImage.writeFits(outputPath)
                
                    if False:
                        spatialKernel = results[1]
                        print spatialKernel.getSpatialParameters()
                    
                    if display:
                        ds9.mtv(differenceMaskedImage)
                
                def run():
                    Log.getDefaultLog()
                    main()
                
                if __name__ == '__main__':
                    run()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="610143fd"/></a>610143fd</h3>

<pre>
commit 610143fd91ffb96bd28d402467b0076448c6ddb8
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 15 11:07:44 2012 -0800

    Better example script for matching images
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_30"><a name="examples/compareKernelSizes.py"/></a>examples/compareKernelSizes.py</h1>

<h3 id="toc_31">Diff:</h3>

<pre>
                import numpy as np
                import matplotlib.pyplot as plt
                import sys
                from lsst.pipe.tasks.imageDifference import ImageDifferenceTask
                
                # This test uses the kernel sum and spatial model condition number as
                # metrics to determine how big the stamps need to be, as a function of
                # the kernel size.
                
                # Run like a Task, as in:
                # compareKernelSizes.py . --id visit=865833781 raft=2,2 sensor=1,1 --configfile imageDifferenceConfig.py --output=tmplsstdiff 
                
                kSizes = np.arange(13, 33, 2)
                gSizes = np.arange(2, 5, 0.25)
                
                kSums  = []
                cNums  = []
                
                for kSize in kSizes:
                    for gSize in gSizes:
                        fpGrowPix = int(gSize * kSize / 2 + 0.5)  # this is a grow radius
                
                        # Specializations for this test
                        task_args = sys.argv[1:]
                        task_args.append("--config")
                        task_args.append("subtract.kernel.active.kernelSize=%d" % (kSize))
                        task_args.append("subtract.kernel.active.detectionConfig.fpGrowMin=%d" % (fpGrowPix-1))
                        task_args.append("subtract.kernel.active.detectionConfig.fpGrowPix=%d" % (fpGrowPix))
                        task_args.append("subtract.kernel.active.detectionConfig.fpGrowMax=%d" % (fpGrowPix+1))
                        task_args.append("doDetection=False")
                        task_args.append("doMeasurement=False")
                
                        ## Hack around the lack of metadata being returned in cmdLineTask
                        tmp = ImageDifferenceTask()
                        parsedCmd = tmp._makeArgumentParser().parse_args(config=tmp.ConfigClass(), args=task_args, log=tmp.log, override=tmp.applyOverrides)
                        task = ImageDifferenceTask(name = ImageDifferenceTask._DefaultName, config=parsedCmd.config, log=parsedCmd.log)
                        results = task.run(parsedCmd.dataRefList[0])
                
                        try:
                            kSum = task.subtract.metadata.get("spatialKernelSum")
                            cNum = task.subtract.metadata.get("spatialConditionNum")
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#a6115c39">a6115c39</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            kSums.append(np.inf)
                            cNums.append(np.inf)
                        else:
                            kSums.append(kSum)
                            cNums.append(cNum)
                        
                fig = plt.figure()
                data = np.array(kSums).reshape(len(kSizes), len(gSizes)).T
                ymin = kSizes.min()
                ymax = kSizes.max()
                xmin = gSizes.min()
                xmax = gSizes.max()
                im1 = plt.imshow(data, origin='lower', cmap=plt.cm.jet, extent=[ymin, ymax, xmin, xmax], interpolation="nearest", aspect="auto")
                plt.title("Kernel Sum")
                plt.xlabel("Kernel Size")
                plt.ylabel("Stamp Grow")
                plt.colorbar(im1, ax = fig.gca(), orientation="horizontal")
                
                fig = plt.figure()
                data = np.array(np.log10(cNums)).reshape(len(kSizes), len(gSizes)).T
                ymin = kSizes.min()
                ymax = kSizes.max()
                xmin = gSizes.min()
                xmax = gSizes.max()
                im2 = plt.imshow(data, origin='lower', cmap=plt.cm.jet, extent=[ymin, ymax, xmin, xmax], interpolation="nearest", aspect="auto")
                plt.title("log10(Condition Number)")
                plt.xlabel("Kernel Size")
                plt.ylabel("Stamp Grow")
                plt.colorbar(im2, ax = fig.gca(), orientation="horizontal")
                
                plt.show()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="a6115c39"/></a>a6115c39</h3>

<pre>
commit a6115c390955e1806ff9c3bf1e53f2e8a75565f7
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jan 14 17:30:52 2013 -0800

    Added task-based example on how to test ip_diffim config.  Moved metadata
    generation to a better location.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_32"><a name="python/lsst/ip/diffim/modelPsfMatch.py"/></a>python/lsst/ip/diffim/modelPsfMatch.py</h1>

<h3 id="toc_33">Diff:</h3>

<pre>
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import numpy as num
                import diffimLib
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                import lsst.meas.algorithms as measAlg
                import lsst.pipe.base as pipeBase
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#54c067e4">54c067e4</a> - import diffimTools</div>
                from makeKernelBasisList import makeKernelBasisList
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#54c067e4">54c067e4</a> - from psfMatch import PsfMatch, PsfMatchConfigAL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#1a612250">1a612250</a> + from psfMatch import PsfMatchTask, PsfMatchConfigAL</div>
              ?                              ++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#1a612250">1a612250</a> + from . import utils as diUtils </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#1a612250">1a612250</a> + import lsst.afw.display.ds9 as ds9</div>
                
                sigma2fwhm = 2. * num.sqrt(2. * num.log(2.))
                
                class ModelPsfMatchConfig(pexConfig.Config):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#54c067e4">54c067e4</a> -     # We can determine the widths of the Psfs, thus can optmize the</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#d0a8d025">d0a8d025</a> -     # Alard-Lupton gaussian widths. </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#8b7f49ff">8b7f49ff</a> +     """!Configuration for model-to-model Psf matching"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#8b7f49ff">8b7f49ff</a> + </div>
                    kernel = pexConfig.ConfigChoiceField(
                        doc = "kernel type",
                        typemap = dict(
                            AL = PsfMatchConfigAL,
                            ),
                        default = "AL",
                    )
                
                    def setDefaults(self):
                        # No sigma clipping
                        self.kernel.active.singleKernelClipping = False
                        self.kernel.active.kernelSumClipping = False
                        self.kernel.active.spatialKernelClipping = False
                        self.kernel.active.checkConditionNumber = False
                        
                        # Variance is ill defined
                        self.kernel.active.constantVarianceWeighting = True
                
                        # Psfs are typically small; reduce the kernel size
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#1a612250">1a612250</a> +         self.kernel.active.kernelSizeMin = 11</div>
                        self.kernel.active.kernelSize = 11
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#1a612250">1a612250</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#1a612250">1a612250</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#1a612250">1a612250</a> + ## \page ModelPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#1a612250">1a612250</a> + ## \ref ModelPsfMatchTask_ "ModelPsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#1a612250">1a612250</a> + ## \copybrief ModelPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#1a612250">1a612250</a> + ## \}</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#77ece2b8">77ece2b8</a> - class ModelPsfMatchTask(PsfMatch):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#ea0a71c3">ea0a71c3</a> + class ModelPsfMatchTask(PsfMatchTask):</div>
              ?                                 ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#f4985e17">f4985e17</a> -     """PSF-match PSF models to reference PSF models</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#1a612250">1a612250</a> +     """!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#1a612250">1a612250</a> + \anchor ModelPsfMatchTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#1a612250">1a612250</a> + \brief Matching of two model Psfs, and application of the Psf-matching kernel to an input Exposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Contents Contents</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Purpose</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Initialize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_IO</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Config</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#1a612250">1a612250</a> +  - \ref ip_diffim_modelpsfmatch_Example</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Purpose   Description</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#1a612250">1a612250</a> + This Task differs from ImagePsfMatchTask in that it matches two Psf _models_, by realizing</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#1a612250">1a612250</a> + them in an Exposure-sized SpatialCellSet and then inserting each Psf-image pair into KernelCandidates.  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#1a612250">1a612250</a> + Because none of the pairs of sources that are to be matched should be invalid, all sigma clipping is </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#1a612250">1a612250</a> + turned off in ModelPsfMatchConfig.  And because there is no tracked _variance_ in the Psf images, the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#1a612250">1a612250</a> + debugging and logging QA info should be interpreted with caution.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#1a612250">1a612250</a> + One item of note is that the sizes of Psf models are fixed (e.g. its defined as a 21x21 matrix).  When the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#1a612250">1a612250</a> + Psf-matching kernel is being solved for, the Psf "image" is convolved with each kernel basis function,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#1a612250">1a612250</a> + leading to a loss of information around the borders.  This pixel loss will be problematic for the numerical</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#1a612250">1a612250</a> + stability of the kernel solution if the size of the convolution kernel (set by ModelPsfMatchConfig.kernelSize)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#1a612250">1a612250</a> + is much bigger than: psfSize//2.  Thus the sizes of Psf-model matching kernels are typically smaller</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#1a612250">1a612250</a> + than their image-matching counterparts.  If the size of the kernel is too small, the convolved stars will</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#1a612250">1a612250</a> + look "boxy"; if the kernel is too large, the kernel solution will be "noisy".  This is a trade-off that</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#1a612250">1a612250</a> + needs careful attention for a given dataset.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#1a612250">1a612250</a> + The primary use case for this Task is in matching an Exposure to a constant-across-the-sky Psf model for the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#1a612250">1a612250</a> + purposes of image coaddition.  It is important to note that in the code, the "template" Psf is the Psf</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#1a612250">1a612250</a> + that the science image gets matched to.  In this sense the order of template and science image are </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#1a612250">1a612250</a> + reversed, compared to ImagePsfMatchTask, which operates on the template image.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Initialize    Task initialization</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#1a612250">1a612250</a> + \copydoc \_\_init\_\_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_IO        Invoking the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#1a612250">1a612250</a> + \copydoc run</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Config       Configuration parameters</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#1a612250">1a612250</a> + See \ref ModelPsfMatchConfig</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Metadata   Quantities set in Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#1a612250">1a612250</a> + See \ref ip_diffim_psfmatch_Metadata "PsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Debug     Debug variables</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#1a612250">1a612250</a> + The \link lsst.pipe.base.cmdLineTask.CmdLineTask command line task\endlink interface supports a</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#1a612250">1a612250</a> + flag \c -d/--debug to import \b debug.py from your \c PYTHONPATH.  The relevant contents of debug.py </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#1a612250">1a612250</a> + for this Task include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#1a612250">1a612250</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#1a612250">1a612250</a> +     import sys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#1a612250">1a612250</a> +     import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#1a612250">1a612250</a> +     def DebugInfo(name):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#1a612250">1a612250</a> +         di = lsstDebug.getInfo(name)   </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#1a612250">1a612250</a> +         if name == "lsst.ip.diffim.psfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#1a612250">1a612250</a> +             di.display = True                 # global</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#1a612250">1a612250</a> +             di.maskTransparency = 80          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#1a612250">1a612250</a> +             di.displayCandidates = True       # show all the candidates and residuals</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#1a612250">1a612250</a> +             di.displayKernelBasis = False     # show kernel basis functions</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#1a612250">1a612250</a> +             di.displayKernelMosaic = True     # show kernel realized across the image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#1a612250">1a612250</a> +             di.plotKernelSpatialModel = False # show coefficients of spatial model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#1a612250">1a612250</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#1a612250">1a612250</a> +         elif name == "lsst.ip.diffim.modelPsfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#1a612250">1a612250</a> +             di.display = True                 # global</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#1a612250">1a612250</a> +             di.maskTransparency = 30          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#1a612250">1a612250</a> +             di.displaySpatialCells = True     # show spatial cells before the fit</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#1a612250">1a612250</a> +         return di</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#1a612250">1a612250</a> +     lsstDebug.Info = DebugInfo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#1a612250">1a612250</a> +     lsstDebug.frame = 1      </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#1a612250">1a612250</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#1a612250">1a612250</a> + Note that if you want addional logging info, you may add to your scripts:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#1a612250">1a612250</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#1a612250">1a612250</a> + import lsst.pex.logging as pexLog</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#1a612250">1a612250</a> + pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#1a612250">1a612250</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#1a612250">1a612250</a> + \section ip_diffim_modelpsfmatch_Example   A complete example of using ModelPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#1a612250">1a612250</a> + This code is modelPsfMatchTask.py in the examples directory, and can be run as \em e.g.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#1a612250">1a612250</a> + \code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#1a612250">1a612250</a> + examples/modelPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#1a612250">1a612250</a> + examples/modelPsfMatchTask.py --debug </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#1a612250">1a612250</a> + examples/modelPsfMatchTask.py --debug --template /path/to/templateExp.fits --science /path/to/scienceExp.fits</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#1a612250">1a612250</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#1a612250">1a612250</a> + \dontinclude modelPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#1a612250">1a612250</a> + Create a subclass of ModelPsfMatchTask that accepts two exposures.  Note that the "template" exposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#1a612250">1a612250</a> + contains the Psf that will get matched to, and the "science" exposure is the one that will be convolved:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#1a612250">1a612250</a> + \skip MyModelPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#1a612250">1a612250</a> + \until return</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#1a612250">1a612250</a> + And allow the user the freedom to either run the script in default mode, or point to their own images on disk.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#1a612250">1a612250</a> + Note that these images must be readable as an lsst.afw.image.Exposure:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#1a612250">1a612250</a> + \skip main</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#1a612250">1a612250</a> + \until parse_args</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#1a612250">1a612250</a> + We have enabled some minor display debugging in this script via the --debug option.  However, if you </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#1a612250">1a612250</a> + have an lsstDebug debug.py in your PYTHONPATH you will get additional debugging displays.  The following</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#1a612250">1a612250</a> + block checks for this script:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#1a612250">1a612250</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#1a612250">1a612250</a> + \until sys.stderr</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#1a612250">1a612250</a> + \dontinclude modelPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#1a612250">1a612250</a> + Finally, we call a run method that we define below.  First set up a Config and modify some of the parameters.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#1a612250">1a612250</a> + In particular we don't want to "grow" the sizes of the kernel or KernelCandidates, since we are operating with</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#1a612250">1a612250</a> + fixed--size images (i.e. the size of the input Psf models).</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#1a612250">1a612250</a> + \skip run(args)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#1a612250">1a612250</a> + \until False</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#1a612250">1a612250</a> + Make sure the images (if any) that were sent to the script exist on disk and are readable.  If no images</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#1a612250">1a612250</a> + are sent, make some fake data up for the sake of this example script (have a look at the code if you want</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#1a612250">1a612250</a> + more details on generateFakeData):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#1a612250">1a612250</a> + \skip requested</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#1a612250">1a612250</a> + \until sizeCellY</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#1a612250">1a612250</a> + Display the two images if --debug:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#1a612250">1a612250</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#1a612250">1a612250</a> + \until Science</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#1a612250">1a612250</a> + Create and run the Task:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#1a612250">1a612250</a> + \skip Create</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#1a612250">1a612250</a> + \until result</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#1a612250">1a612250</a> + And finally provide optional debugging display of the Psf-matched (via the Psf models) science image:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#1a612250">1a612250</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#1a612250">1a612250</a> + \until result.psfMatchedExposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#1a612250">1a612250</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#1a612250">1a612250</a> + </div>
                    """
                    ConfigClass = ModelPsfMatchConfig
                
                    def __init__(self, *args, **kwargs):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#f4985e17">f4985e17</a> -         """Create a PsfMatchToModel</div>
              ?                              ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#1a612250">1a612250</a> +         """!Create a ModelPsfMatchTask</div>
              ?            +         +++++         ^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#6c0e8620">6c0e8620</a> -         @param config: see lsst.ip.diffim.PsfMatchConfig</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#f4985e17">f4985e17</a> -         @param logName: name by which messages are logged</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#1a612250">1a612250</a> +         \param *args arguments to be passed to lsst.ip.diffim.PsfMatchTask.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#1a612250">1a612250</a> +         \param **kwargs keyword arguments to be passed to lsst.ip.diffim.PsfMatchTask.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#1a612250">1a612250</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#1a612250">1a612250</a> +         Upon initialization, the kernel configuration is defined by self.config.kernel.active.  This Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#1a612250">1a612250</a> +         does have a run() method, which is the default way to call the Task.</div>
                        """
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#77ece2b8">77ece2b8</a> -         PsfMatch.__init__(self, *args, **kwargs)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#1a612250">1a612250</a> +         PsfMatchTask.__init__(self, *args, **kwargs)</div>
              ?                 ++++
                        self.kConfig = self.config.kernel.active
                
                    @pipeBase.timeMethod
                    def run(self, exposure, referencePsfModel, kernelSum=1.0):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#f4985e17">f4985e17</a> -         """PSF-match an exposure to a PSF model.</div>
              ?             ^^                       ----      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#1a612250">1a612250</a> +         """!Psf-match an exposure to a model Psf</div>
              ?            + ^^                             ^^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#f4985e17">f4985e17</a> -         @param exposure: Exposure to PSF-match to the reference masked image;</div>
              ?                                       ^^                         ^^^ ^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#1a612250">1a612250</a> +         @param exposure: Exposure to Psf-match to the reference Psf model;</div>
              ?                                       ^^                        ++++ ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#f4985e17">f4985e17</a> -             must contain a PSF model and must be warped to match the reference masked image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#1a612250">1a612250</a> +             it must return a valid PSF model via exposure.getPsf()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#54c067e4">54c067e4</a> -         @param referencePsfModel: PSF model to match to (an afwDetection.Psf)</div>
              ?                                    ^^                          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#1a612250">1a612250</a> +         @param referencePsfModel: The Psf model to match to (an lsst.afw.detection.Psf)</div>
              ?                                   ++++ ^^                       +++++   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#1a612250">1a612250</a> +         @param kernelSum: A multipicative factor to apply to the kernel sum (default=1.0)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#cca1e80e">cca1e80e</a> -         @param kernelSum: A multipicative factor reflecting the difference in</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#f4985e17">f4985e17</a> -             zeropoints between the images; kernelSum = zpt(science) / zpt(ref)</div>
                
                        @return
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#f4985e17">f4985e17</a> -         - psfMatchedExposure: the PSF-matched exposure.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#f4985e17">f4985e17</a> -             This has the same parent bbox, Wcs, Calib and Filter as exposure but no psf.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#f4985e17">f4985e17</a> -             In theory the psf should equal referencePsfModel but the match is likely not exact.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#1a612250">1a612250</a> +         - psfMatchedExposure: the Psf-matched Exposure.  This has the same parent bbox, Wcs, Calib and </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#1a612250">1a612250</a> +             Filter as the input Exposure but no Psf.  In theory the Psf should equal referencePsfModel but </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#1a612250">1a612250</a> +             the match is likely not exact.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#f4985e17">f4985e17</a> -         - psfMatchingKernel: the PSF matching kernel</div>
              ?                                   ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#1a612250">1a612250</a> +         - psfMatchingKernel: the spatially varying Psf-matching kernel</div>
              ?                                  ++++++++++++++++++ ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#f4985e17">f4985e17</a> -         - kernelCellSet: SpatialCellSet used to solve for the PSF matching kernel</div>
              ?                                                                ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#1a612250">1a612250</a> +         - kernelCellSet: SpatialCellSet used to solve for the Psf-matching kernel</div>
              ?                                                                ^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#f4985e17">f4985e17</a> -         @raise RuntimeError if exposure does not contain a PSF model"</div>
              ?         ^^                                                  ^^      -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#1a612250">1a612250</a> +         Raise a RuntimeError if the Exposure does not contain a Psf model</div>
              ?         ^    ++                 ++ ++                            ^^
                        """
                        if not exposure.hasPsf():
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#f4985e17">f4985e17</a> -             raise RuntimeError("exposure does not contain a PSF model")</div>
              ?                                                              ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#1a612250">1a612250</a> +             raise RuntimeError("exposure does not contain a Psf model")</div>
              ?                                                              ^^
                
                        maskedImage = exposure.getMaskedImage()
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#77ece2b8">77ece2b8</a> -         self.log.log(pexLog.Log.INFO, "compute PSF-matching kernel")</div>
              ?                                                 ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#1a612250">1a612250</a> +         self.log.log(pexLog.Log.INFO, "compute Psf-matching kernel")</div>
              ?                                                 ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#f4985e17">f4985e17</a> -         kernelCellSet = self._buildCellSet(referencePsfModel,</div>
              ?                                                             ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#1a612250">1a612250</a> +         kernelCellSet = self._buildCellSet(exposure, referencePsfModel)</div>
              ?                                            ++++++++++                 ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#f4985e17">f4985e17</a> -                                            exposure.getBBox(afwImage.PARENT),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#54c067e4">54c067e4</a> -                                            exposure.getPsf())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#47b13664">47b13664</a> -         width, height = referencePsfModel.getKernel().getDimensions()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#1a612250">1a612250</a> +         width, height = referencePsfModel.getLocalKernel().getDimensions()</div>
              ?                                              +++++
                        psfAttr1 = measAlg.PsfAttributes(exposure.getPsf(), width//2, height//2)
                        psfAttr2 = measAlg.PsfAttributes(referencePsfModel, width//2, height//2)
                        s1 = psfAttr1.computeGaussianWidth(psfAttr1.ADAPTIVE_MOMENT) # gaussian sigma in pixels
                        s2 = psfAttr2.computeGaussianWidth(psfAttr2.ADAPTIVE_MOMENT) # gaussian sigma in pixels
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#47b13664">47b13664</a> -         fwhm1 = s1 * sigma2fwhm</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#1a612250">1a612250</a> +         fwhm1 = s1 * sigma2fwhm # science Psf</div>
              ?                                ++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#47b13664">47b13664</a> -         fwhm2 = s2 * sigma2fwhm</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#1a612250">1a612250</a> +         fwhm2 = s2 * sigma2fwhm # template Psf</div>
              ?                                +++++++++++++++
                
                        basisList = makeKernelBasisList(self.kConfig, fwhm1, fwhm2, metadata = self.metadata)
                        spatialSolution, psfMatchingKernel, backgroundModel = self._solve(kernelCellSet, basisList)
                
                        if psfMatchingKernel.isSpatiallyVarying():
                            sParameters = num.array(psfMatchingKernel.getSpatialParameters())
                            sParameters[0][0] = kernelSum
                            psfMatchingKernel.setSpatialParameters(sParameters)
                        else:
                            kParameters = num.array(psfMatchingKernel.getKernelParameters())
                            kParameters[0] = kernelSum
                            psfMatchingKernel.setKernelParameters(kParameters)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#77ece2b8">77ece2b8</a> -         self.log.log(pexLog.Log.INFO, "PSF-match science exposure to reference")</div>
              ?                                         ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#1a612250">1a612250</a> +         self.log.log(pexLog.Log.INFO, "Psf-match science exposure to reference")</div>
              ?                                         ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#f4985e17">f4985e17</a> -         psfMatchedExposure = afwImage.ExposureF(exposure.getBBox(afwImage.PARENT), exposure.getWcs())</div>
              ?                                                                  ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#9250fe88">9250fe88</a> +         psfMatchedExposure = afwImage.ExposureF(exposure.getBBox(), exposure.getWcs())</div>
                        psfMatchedExposure.setFilter(exposure.getFilter())
                        psfMatchedExposure.setCalib(exposure.getCalib())
                        psfMatchedMaskedImage = psfMatchedExposure.getMaskedImage()
                
                        # Normalize the psf-matching kernel while convolving since its magnitude is meaningless
                        # when PSF-matching one model to another.
                        doNormalize = True
                        afwMath.convolve(psfMatchedMaskedImage, maskedImage, psfMatchingKernel, doNormalize)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#cca1e80e">cca1e80e</a> - </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#1a612250">1a612250</a> +         </div>
                        self.log.log(pexLog.Log.INFO, "done")
                        return pipeBase.Struct(psfMatchedExposure=psfMatchedExposure,
                                               psfMatchingKernel=psfMatchingKernel,
                                               kernelCellSet=kernelCellSet,
                                               metadata=self.metadata)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#8d282063">8d282063</a> -     def _diagnostic(self,kernelCellSet, spatialSolution, spatialKernel, spatialBg):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
301  <a href="#1a612250">1a612250</a> +     def _diagnostic(self, kernelCellSet, spatialSolution, spatialKernel, spatialBg):</div>
              ?                          +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#8b7f49ff">8b7f49ff</a> +         """!Print diagnostic information on spatial kernel and background fit</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#8b7f49ff">8b7f49ff</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#8d282063">8d282063</a> -         """The debugging diagnostics are not really useful here, since we have no variance"""</div>
              ?         ---                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#8b7f49ff">8b7f49ff</a> +         The debugging diagnostics are not really useful here, since the images we are matching have</div>
              ?                                                                     +++++++++++  +++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#1a612250">1a612250</a> +         no variance.  Thus override the _diagnostic method to generate no logging information"""</div>
                        return
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#54c067e4">54c067e4</a> -     def _buildCellSet(self, referencePsfModel, scienceBBox, sciencePsfModel):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#1a612250">1a612250</a> +     def _buildCellSet(self, exposure, referencePsfModel):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#f4985e17">f4985e17</a> -         """Build a SpatialCellSet for use with the solve method</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#1a612250">1a612250</a> +         """!Build a SpatialCellSet for use with the solve method</div>
              ?            +
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#1a612250">1a612250</a> +         @param exposure: The science exposure that will be convolved; must contain a Psf</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#54c067e4">54c067e4</a> -         @param referencePsfModel: PSF model to match to (an afwDetection.Psf)</div>
              ?                                    ^^                  ----------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#1a612250">1a612250</a> +         @param referencePsfModel: Psf model to match to</div>
              ?                                    ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#f4985e17">f4985e17</a> -         @param scienceBBox: parent bounding box on science image</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#f4985e17">f4985e17</a> -         @param sciencePsfModel: PSF model for science image</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#f4985e17">f4985e17</a> -         @return kernelCellSet: a SpatialCellSet for use with self._solve</div>
              ?                                                 ^ ^    ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#1a612250">1a612250</a> +         @return kernelCellSet: a SpatialCellSet to be used by self._solve</div>
              ?                                                 ^ ^^^    ^^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#f4985e17">f4985e17</a> -         @raise RuntimeError if reference PSF model and science PSF model have different dimensions</div>
              ?         ^^                                ^^                    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#1a612250">1a612250</a> +         Raise a RuntimeError if the reference Psf model and science Psf model have different dimensions</div>
              ?         ^    ++                ++++            ^^                    ^^
                        """
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#9250fe88">9250fe88</a> +         scienceBBox = exposure.getBBox()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#1a612250">1a612250</a> +         sciencePsfModel = exposure.getPsf()</div>
                        # The Psf base class does not support getKernel() in general, as there are some Psf
                        # classes for which this is not meaningful.
                        # Many Psfs we use in practice are KernelPsfs, and this algorithm will work fine for them,
                        # but someday it should probably be modified to support arbitrary Psfs.
                        referencePsfModel = measAlg.KernelPsf.swigConvert(referencePsfModel)
                        sciencePsfModel = measAlg.KernelPsf.swigConvert(sciencePsfModel)
                        if referencePsfModel is None or sciencePsfModel is None:
                            raise RuntimeError("ERROR: Psf matching is only implemented for KernelPsfs")
                        if (referencePsfModel.getKernel().getDimensions() != sciencePsfModel.getKernel().getDimensions()):
                            pexLog.Trace(self.log.getName(), 1,
                                         "ERROR: Dimensions of reference Psf and science Psf different; exiting")
                            raise RuntimeError, "ERROR: Dimensions of reference Psf and science Psf different; exiting"
                
                        psfWidth, psfHeight = referencePsfModel.getKernel().getDimensions()
                        maxKernelSize = min(psfWidth, psfHeight) - 1
                        if maxKernelSize % 2 == 0:
                            maxKernelSize -= 1
                        if self.kConfig.kernelSize > maxKernelSize:
                            raise ValueError, "Kernel size (%d) too big to match Psfs of size %d; reduce to at least %d" % (
                                self.kConfig.kernelSize, psfWidth, maxKernelSize)
                
                        # Infer spatial order of Psf model!
                        #
                        # Infer from the number of spatial parameters.
                        # (O + 1) * (O + 2) / 2 = N
                        # O^2 + 3 * O + 2 * (1 - N) = 0
                        #
                        # Roots are [-3 +/- sqrt(9 - 8 * (1 - N))] / 2
                        #
                        nParameters = sciencePsfModel.getKernel().getNSpatialParameters()
                        root        = num.sqrt(9 - 8 * (1 - nParameters))
                        if (root != root // 1):            # We know its an integer solution
                            pexLog.Trace(self.log.getName(), 3, "Problem inferring spatial order of image's Psf")
                        else:
                            order       = (root - 3) / 2
                            if (order != order // 1):
                                pexLog.Trace(self.log.getName(), 3, "Problem inferring spatial order of image's Psf")
                            else:
                                pexLog.Trace(self.log.getName(), 2, "Spatial order of Psf = %d; matching kernel order = %d" % (
                                        order, self.kConfig.spatialKernelOrder))
                
                        regionSizeX, regionSizeY = scienceBBox.getDimensions()
                        scienceX0,   scienceY0   = scienceBBox.getMin()
                
                        sizeCellX = self.kConfig.sizeCellX
                        sizeCellY = self.kConfig.sizeCellY
                
                        kernelCellSet = afwMath.SpatialCellSet(
                            afwGeom.Box2I(afwGeom.Point2I(scienceX0, scienceY0),
                                          afwGeom.Extent2I(regionSizeX, regionSizeY)),
                            sizeCellX, sizeCellY
                            )
                
                        nCellX    = regionSizeX // sizeCellX
                        nCellY    = regionSizeY // sizeCellY
                        dimenR    = referencePsfModel.getKernel().getDimensions()
                        dimenS    = sciencePsfModel.getKernel().getDimensions()
                
                        policy = pexConfig.makePolicy(self.kConfig)
                        for row in range(nCellY):
                            # place at center of cell
                            posY = sizeCellY * row + sizeCellY // 2 + scienceY0
                
                            for col in range(nCellX):
                                # place at center of cell
                                posX = sizeCellX * col + sizeCellX // 2 + scienceX0
                
                                pexLog.Trace(self.log.getName(), 5, "Creating Psf candidate at %.1f %.1f" % (posX, posY))
                
                                # reference kernel image, at location of science subimage
                                kernelImageR = referencePsfModel.computeImage(afwGeom.Point2D(posX, posY)).convertF()
                                kernelMaskR   = afwImage.MaskU(dimenR)
                                kernelMaskR.set(0)
                                kernelVarR    = afwImage.ImageF(dimenR)
                                kernelVarR.set(1.0)
                                referenceMI   = afwImage.MaskedImageF(kernelImageR, kernelMaskR, kernelVarR)
                
                                # kernel image we are going to convolve
                                kernelImageS = sciencePsfModel.computeImage(afwGeom.Point2D(posX, posY)).convertF()
                                kernelMaskS   = afwImage.MaskU(dimenS)
                                kernelMaskS.set(0)
                                kernelVarS    = afwImage.ImageF(dimenS)
                                kernelVarS.set(1.0)
                                scienceMI     = afwImage.MaskedImageF(kernelImageS, kernelMaskS, kernelVarS)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#f4985e17">f4985e17</a> -                 #referenceMI.writeFits('ref_%d_%d.fits' % (row, col))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#f4985e17">f4985e17</a> -                 #scienceMI.writeFits('sci_%d_%d.fits' % (row, col))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#cca1e80e">cca1e80e</a> - </div>
                                # The image to convolve is the science image, to the reference Psf.
                                kc = diffimLib.makeKernelCandidate(posX, posY, scienceMI, referenceMI, policy)
                                kernelCellSet.insertCandidate(kc)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#1a612250">1a612250</a> +         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#1a612250">1a612250</a> +         import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#1a612250">1a612250</a> +         display = lsstDebug.Info(__name__).display</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
411  <a href="#1a612250">1a612250</a> +         displaySpatialCells = lsstDebug.Info(__name__).displaySpatialCells</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#1a612250">1a612250</a> +         maskTransparency = lsstDebug.Info(__name__).maskTransparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
413  <a href="#1a612250">1a612250</a> +         if not maskTransparency:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
414  <a href="#1a612250">1a612250</a> +             maskTransparency = 0</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
415  <a href="#1a612250">1a612250</a> +         ds9.setMaskTransparency(maskTransparency)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
416  <a href="#1a612250">1a612250</a> +         if display and displaySpatialCells:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
417  <a href="#1a612250">1a612250</a> +             diUtils.showKernelSpatialCells(exposure.getMaskedImage(), kernelCellSet,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
418  <a href="#1a612250">1a612250</a> +                 symb="o", ctype=ds9.CYAN, ctypeUnused=ds9.YELLOW, ctypeBad=ds9.RED,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
419  <a href="#1a612250">1a612250</a> +                 size=4, frame=lsstDebug.frame, title="Image to be convolved")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
420  <a href="#1a612250">1a612250</a> +             lsstDebug.frame += 1</div>
                        return kernelCellSet
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="77ece2b8"/></a>77ece2b8</h3>

<pre>
commit 77ece2b8bf9aab07a7b5c50492a86a2cbc5ae32d
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 16:41:56 2012 -0800

    Initial work on making stages pipeBase.Tasks.
</pre>
<h3><a name="d0a8d025"/></a>d0a8d025</h3>

<pre>
commit d0a8d0254f22daa45f892028cd7de33e07433d10
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Mar 1 16:24:33 2012 -0600

    Changes during coding of pipe_tasks tickets/1732
</pre>
<h3><a name="cca1e80e"/></a>cca1e80e</h3>

<pre>
commit cca1e80e719df66265e1492d127e9661ac244a35
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 22 16:09:49 2013 -0700

    Initial round of fixes to based on Paul's W13 review.
</pre>
<h3><a name="54c067e4"/></a>54c067e4</h3>

<pre>
commit 54c067e4b3787e53e9588fb6f8210a2c48c1dea5
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 9 18:29:22 2012 -0800

    Final model-to-model matching figured out.
</pre>
<h3><a name="6c0e8620"/></a>6c0e8620</h3>

<pre>
commit 6c0e86208a8d9faa0707a44b415bb3c51559787c
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 11:18:27 2012 -0800

    Fixing formatting and removing all policy refs from psfMatch.
</pre>
<h3><a name="47b13664"/></a>47b13664</h3>

<pre>
commit 47b136649cf465a2cdd2ee53053fdf8f8f43dbf9
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 8 16:52:38 2012 -0800

    Model to model matching unit tests
</pre>
<h3><a name="f4985e17"/></a>f4985e17</h3>

<pre>
commit f4985e17583972906ac5f8eeab3604304c0fed49
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 1 14:33:01 2012 -0800

    Converting to new swig; initial conversion to pex_config.
</pre>
<h3><a name="8d282063"/></a>8d282063</h3>

<pre>
commit 8d282063b7e720a80d8d5a24318fa0fe8978dabe
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed May 2 12:53:03 2012 -0700

    Minor changes to diagnostic function, whcih doesn't mean anything for Model matching.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="ea0a71c3"/></a>ea0a71c3</h3>

<pre>
commit ea0a71c39d9756c68dec41b2a16516d0015e5bf2
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jul 29 14:07:41 2014 -0700

    Renaming PsfMatch to PsfMatchTask within ip_diffim; PsfMatch=PsfMatchTask makes this change transparent for other packages
</pre>
<h3><a name="1a612250"/></a>1a612250</h3>

<pre>
commit 1a6122502ce5143b5b37c76de1fdd797b8a7c3da
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:24:43 2014 -0700

    Adding Task documentation and example script for ModelPsfMatchTask
</pre>
<h3><a name="8b7f49ff"/></a>8b7f49ff</h3>

<pre>
commit 8b7f49ff55c0cee47bd9688aa1017e14c72faaac
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:33:58 2014 -0700

    Fixing first-line of doxygen comments for PsfMatch methods
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_34"><a name="examples/debugSpatialModel.py"/></a>examples/debugSpatialModel.py</h1>

<h3 id="toc_35">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import os
                import sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#c30625fc">c30625fc</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.pex.logging as pexLogging
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#90e28cf3">90e28cf3</a> - import lsst.pex.config as pexConfig</div>
                
                import lsst.afw.display.ds9 as ds9
                import lsst.afw.display.utils as displayUtils
                
                subBackground = True
                display = True
                fwhm = 6.8
                warp = True
                
                verbosity = 5
                pexLogging.Trace_setVerbosity("lsst.ip.diffim", verbosity)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#2d286cf2">2d286cf2</a> - defDataDir   = eups.productDir("afwdata") </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#2d286cf2">2d286cf2</a> - imageProcDir = eups.productDir("ip_diffim")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#48e85303">48e85303</a> + defDataDir = lsst.utils.getPackageDir('afwdata')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#48e85303">48e85303</a> + imageProcDir = lsst.utils.getPackageDir('ip_diffim')</div>
                
                if len(sys.argv) == 1:
                    defSciencePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                  "v26-e0-c011-a10.sci")
                    defTemplatePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                   "v5-e0-c011-a10.sci")
                elif len(sys.argv) == 3:
                    defSciencePath  = sys.argv[1]
                    defTemplatePath = sys.argv[2]
                else:
                    sys.exit(1)
                    
                defOutputPath    = "diffImage"
                templateExposure = afwImage.ExposureF(defTemplatePath)
                scienceExposure  = afwImage.ExposureF(defSciencePath)
                
                config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                config.kernel.name = "AL"
                subconfig = config.kernel.active
                
                
                if warp:
                    warper = afwMath.Warper.fromConfig(subconfig.warpingConfig)
                    templateExposure = warper.warpExposure(scienceExposure.getWcs(), templateExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#90e28cf3">90e28cf3</a> -                                            destBBox = scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                               ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#9250fe88">9250fe88</a> +                                            destBBox = scienceExposure.getBBox())</div>
                if subBackground:
                    # Do in AFW
                    diffimTools.backgroundSubtract(subconfig.afwBackgroundConfig,
                                                   [templateExposure.getMaskedImage(),
                                                    scienceExposure.getMaskedImage()])
                    subconfig.fitForBackground = False
                else:
                    # Do in IP_DIFFIM
                    subconfig.fitForBackground = True
                    
                
                frame  = 0
                ds9.mtv(templateExposure, frame=frame, title = "Template")
                frame += 1
                ds9.mtv(scienceExposure, frame=frame, title = "Sci Im")
                
                psfmatch = ipDiffim.ImagePsfMatchTask(config=config)
                try:
                    results = psfmatch.run(templateExposure.getMaskedImage(),
                                           scienceExposure.getMaskedImage(),
                                           "subtractMaskedImages")
                    diffim        = results.subtractedImage
                    spatialKernel = results.psfMatchingKernel
                    spatialBg     = results.backgroundModel
                    kernelCellSet = results.kernelCellSet
                except Exception, e:
                    print 'FAIL'
                    sys.exit(1)
                
                if False:
                    print spatialKernel.getSpatialFunctionList()[0].toString()
                    print spatialKernel.getKernelParameters()
                    print spatialKernel.getSpatialParameters()
                    import pdb; pdb.set_trace()
                
                # Lets see what we got
                if display:
                    mos = displayUtils.Mosaic()
                
                    # Inputs
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(False): # False = include bad candidates
                            cand  = ipDiffim.cast_KernelCandidateF(cand)
                            rchi2 = cand.getChi2()
                
                            # No kernels made
                            if cand.getStatus() == afwMath.SpatialCellCandidate.UNKNOWN:
                                continue
                
                            try:
                                im = cand.getKernelImage(ipDiffim.KernelCandidateF.RECENT)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#c30625fc">c30625fc</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                continue
                            
                            if cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                statStr = "Good"
                            elif cand.getStatus() == afwMath.SpatialCellCandidate.BAD:
                                statStr = "Bad"
                            mos.append(im, "#%d: %.1f (%s)" % (cand.getId(), rchi2, statStr))
                
                    mosaic = mos.makeMosaic()
                    frame += 1
                    ds9.mtv(mosaic, frame=frame, title = "Raw Kernels")
                    mos.drawLabels(frame=frame)
                
                    # KernelCandidates
                    frame += 1
                    diffimTools.displayCandidateResults(kernelCellSet, frame)
                
                    # Bases
                    mos.reset()
                    basisList = spatialKernel.getKernelList()
                    for idx in range(len(basisList)):
                        kernel = basisList[idx]
                        im   = afwImage.ImageD(spatialKernel.getDimensions())
                        ksum = kernel.computeImage(im, False)
                        mos.append(im, "K%d" % (idx))
                    mosaic = mos.makeMosaic()
                    frame += 1
                    ds9.mtv(mosaic, frame=frame, title = "Kernel Bases")
                    mos.drawLabels(frame=frame)
                        
                
                    # Spatial model
                    mos.reset()
                    width = templateExposure.getWidth()
                    height = templateExposure.getHeight()
                    stamps = []
                    stampInfo = []
                    for x in (0, width//2, width):
                        for y in (0, height//2, height):
                            im   = afwImage.ImageD(spatialKernel.getDimensions())
                            ksum = spatialKernel.computeImage(im,
                                                              False,
                                                              afwImage.indexToPosition(x),
                                                              afwImage.indexToPosition(y))
                            mos.append(im, "x=%d y=%d kSum=%.2f" % (x, y, ksum))
                
                    mosaic = mos.makeMosaic()
                    frame += 1
                    ds9.mtv(mosaic, frame=frame, title = "Spatial Kernels")
                    mos.drawLabels(frame=frame)
                            
                
                    # Background
                    backgroundIm  = afwImage.ImageF(afwGeom.Extent2I(templateExposure.getWidth(), templateExposure.getHeight()), 0)
                    backgroundIm += spatialBg
                    frame += 1
                    ds9.mtv(backgroundIm, frame=frame, title = "Background model")
                
                    # Diffim!
                    diffIm = ipDiffim.convolveAndSubtract(templateExposure.getMaskedImage(),
                                                          scienceExposure.getMaskedImage(),
                                                          spatialKernel,
                                                          spatialBg)
                    frame += 1
                    ds9.mtv(diffIm, frame=frame, title = "Diffim")
                
                
                # examples/runSpatialModel.py $AFWDATA_DIR/DC3a-Sim/sci/v5-e0/v5-e0-c011-a00.sci
                # ... $AFWDATA_DIR/DC3a-Sim/sci/v26-e0/v26-e0-c011-a00.sci
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="90e28cf3"/></a>90e28cf3</h3>

<pre>
commit 90e28cf34e728828131b6bb1cd4b4295ac52360d
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 15 12:11:25 2012 -0800

    Finishing up last examples/ upgrades to pex_config
</pre>
<h3><a name="2d286cf2"/></a>2d286cf2</h3>

<pre>
commit 2d286cf2235f899966402a73c136364277fba165
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Oct 7 22:49:10 2009 +0000

    Example script to run the new spatial modeling.
</pre>
<h3><a name="c30625fc"/></a>c30625fc</h3>

<pre>
commit c30625fc4586b0573812e25041416843247dc499
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Apr 27 18:05:05 2011 +0000

    Removing old example code, updating relevant example code.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_36"><a name="examples/runWarpExposure.py"/></a>examples/runWarpExposure.py</h1>

<h3 id="toc_37">Diff:</h3>

<pre>
                import sys
                import optparse
                import lsst.afw.math as afwMath
                import lsst.afw.image as afwImage
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#9250fe88">9250fe88</a> + import lsst.ip.diffim as ipDiffim</div>
                import lsst.daf.base as dafBase
                from lsst.pex.logging import Log
                
                def main():
                    usage = """runWarpExposure.py refExposure towarpExposure outputExposure"""
                    parser = optparse.OptionParser(usage)
                    (options, args) = parser.parse_args()
                    
                    def getArg(ind):
                        if ind < len(args):
                            return args[ind]
                    
                    refWcsPath  = getArg(0)
                    toWarpPath  = getArg(1)
                    warpedPath  = getArg(2)
                
                    if refWcsPath == None or toWarpPath == None or warpedPath == None:
                        parser.print_help()
                        sys.exit(1)
                         
                    print 'Reference exposure: ', refWcsPath
                    print 'Exposure to be warped: ', toWarpPath
                    print 'Output exposure:  ', warpedPath
                
                    refWcsExposure = afwImage.ExposureF(refWcsPath)
                    toWarpExposure = afwImage.ExposureF(toWarpPath)
                
                    config = ipDiffim.ImagePsfMatchTask.ConfigClass()
                    subconfig = config.kernel.active
                    warper = afwMath.Warper.fromConfig(subconfig.warpingConfig)
                    warpedExposure = warper.warpExposure(refWcsExposure.getWcs(), 
                                                         toWarpExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#5661161d">5661161d</a> -                                          destBBox = refWcsExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                            ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#9250fe88">9250fe88</a> +                                          destBBox = refWcsExposure.getBBox())</div>
                    warpedExposure.writeFits(warpedPath)
                    
                def run():
                    Log.getDefaultLog()
                    memId0 = dafBase.Citizen_getNextMemId()
                    main()
                    # check for memory leaks
                    if dafBase.Citizen_census(0, memId0) != 0:
                        print dafBase.Citizen_census(0, memId0), 'Objects leaked:'
                        print dafBase.Citizen_census(dafBase.cout, memId0)
                
                if __name__ == '__main__':
                    run()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="5661161d"/></a>5661161d</h3>

<pre>
commit 5661161d9a81c27b5a0ce524f083cea533088013
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Jul 11 22:42:01 2011 +0000

    Example warp exposure code.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_38"><a name="tests/ImageStatistics.py"/></a>tests/ImageStatistics.py</h1>

<h3 id="toc_39">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#6ec2c185">6ec2c185</a> - import os</div>
                import unittest
                import lsst.utils.tests as tests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#6ec2c185">6ec2c185</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as logging
                import lsst.pex.config as pexConfig
                import numpy as num
                
                verbosity = 1
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.subconfig = self.config.kernel["DF"]
                        self.policy = pexConfig.makePolicy(self.subconfig)
                
                    def tearDown(self):
                        del self.policy
                
                    def testImageStatisticsNan(self, core=3):
                        numArray = num.zeros((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                mi.set( i, j, (numArray[j][i], 0x0, 0) )
                
                        # inverse variance weight of 0 is NaN
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                        self.assertEqual(imstat.getNpix(), 0)
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi, core)
                        self.assertEqual(imstat.getNpix(), 0)
                
                    def testImageStatisticsZero(self):
                        numArray = num.zeros((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                mi.set( i, j, (numArray[j][i], 0x0, 1) )
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                
                        self.assertEqual(imstat.getMean(), 0)
                        self.assertEqual(imstat.getRms(), 0)
                        self.assertEqual(imstat.getNpix(), 20*20)
                
                    def testImageStatisticsOne(self):
                        numArray = num.ones((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                mi.set( i, j, (numArray[j][i], 0x0, 1) )
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                
                        self.assertEqual(imstat.getMean(), 1)
                        self.assertEqual(imstat.getRms(), 0)
                        self.assertEqual(imstat.getNpix(), 20*20)
                
                    def testImageStatisticsCore(self, core=3):
                        numArray = num.ones((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                mi.set( i, j, (numArray[j][i], 0x0, 1) )
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi, core)
                
                        self.assertEqual(imstat.getMean(), 1)
                        self.assertEqual(imstat.getRms(), 0)
                        self.assertEqual(imstat.getNpix(), (2*core+1)**2 )
                
                    def testImageStatisticsGeneral(self):
                        numArray = num.ones((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                val = i + 2.3 * j
                                mi.set( i, j, (val, 0x0, 1) )
                                numArray[j][i] = val
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                
                        self.assertAlmostEqual(imstat.getMean(), numArray.mean())
                        # note that these don't agree exactly...
                        self.assertAlmostEqual(imstat.getRms(), numArray.std(), 1)
                        self.assertEqual(imstat.getNpix(), 20 * 20)
                
                        afwStat = afwMath.makeStatistics(mi.getImage(), afwMath.MEAN | afwMath.STDEV)
                        self.assertAlmostEqual(imstat.getMean(), afwStat.getValue(afwMath.MEAN))
                        # even though these do
                        self.assertAlmostEqual(imstat.getRms(), afwStat.getValue(afwMath.STDEV))
                
                    def testImageStatisticsMask1(self):
                        # Mask value that gets ignored
                        maskPlane = self.policy.getStringArray("badMaskPlanes")[0]
                        maskVal   = afwImage.MaskU.getPlaneBitMask(maskPlane)
                        numArray = num.ones((20, 19))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                val = i + 2.3 * j
                                
                                if i == 19:
                                    mi.set( i, j, (val, maskVal, 1) )
                                else:
                                    mi.set( i, j, (val, 0x0, 1) )
                                    numArray[j][i] = val
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                
                        self.assertAlmostEqual(imstat.getMean(), numArray.mean())
                        # note that these don't agree exactly...
                        self.assertAlmostEqual(imstat.getRms(), numArray.std(), 1)
                        self.assertEqual(imstat.getNpix(), 20 * (20 - 1))
                
                    def testImageStatisticsMask2(self):
                        # Mask value that does not get ignored
                        maskPlanes = self.policy.getStringArray("badMaskPlanes")
                        for maskPlane in ("BAD", "EDGE", "CR", "SAT", "INTRP"):
                            if maskPlane not in maskPlanes:
                                maskVal = afwImage.MaskU.getPlaneBitMask(maskPlane)
                                break
                        self.assertTrue(maskVal > 0)
                
                        numArray = num.ones((20, 20))
                        mi       = afwImage.MaskedImageF(afwGeom.Extent2I(20, 20))
                        for j in range(mi.getHeight()):
                            for i in range(mi.getWidth()):
                                val = i + 2.3 * j
                                
                                if i == 19:
                                    mi.set( i, j, (val, maskVal, 1) )
                                    numArray[j][i] = val
                                else:
                                    mi.set( i, j, (val, 0x0, 1) )
                                    numArray[j][i] = val
                
                        imstat = ipDiffim.ImageStatisticsF(self.policy)
                        imstat.apply(mi)
                
                        self.assertAlmostEqual(imstat.getMean(), numArray.mean())
                        # note that these don't agree exactly...
                        self.assertAlmostEqual(imstat.getRms(), numArray.std(), 1)
                        self.assertEqual(imstat.getNpix(), 20 * 20)
                
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6ec2c185"/></a>6ec2c185</h3>

<pre>
commit 6ec2c185f694175d08be9b3649a3a226bd75f95f
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Mar 10 23:34:10 2009 +0000

    Working on unit test code; incomplete.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_40"><a name="lib/libip_diffim.so-gdb.py"/></a>lib/libip_diffim.so-gdb.py</h1>

<h3 id="toc_41">Diff:</h3>

<pre>
                import os.path, sys
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import gdb
                #
                # Adjust the load path to include lsst.gdb, bypassing the regular lsstimport mechanism as
                # the version of python running within gdb may not be the same as we are using for lsst processing
                #
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#48e85303">48e85303</a> + ipDiffimDir = lsst.utils.getPackageDir('ip_diffim')</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#6eaca236">6eaca236</a> - printerDir = os.path.join(os.environ["IP_DIFFIM_DIR"], "python", "lsst", "gdb")</div>
              ?                           ^^^^^^  -------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#48e85303">48e85303</a> + printerDir = os.path.join(ipDiffimDir, "python", "lsst", "gdb")</div>
              ?                           ^^^^^^^^^
                if printerDir not in sys.path:
                    sys.path.append(printerDir)
                
                import ip.diffim.printers
                
                ip.diffim.printers.register(gdb.current_objfile())
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6eaca236"/></a>6eaca236</h3>

<pre>
commit 6eaca2362ee2264a79ab48b0ea6c3e667528271b
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 11:44:30 2012 -0800

    Copied gdb printing infrastructure from afw/meas_algorithms
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_42"><a name="include/lsst/ip/diffim/DipoleAlgorithms.h"/></a>include/lsst/ip/diffim/DipoleAlgorithms.h</h1>

<h3 id="toc_43">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#9ff7a214">9ff7a214</a> - /* </div>
              ?   -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#c0b62a68">c0b62a68</a> + /*</div>
                 * LSST Data Management System
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#9ff7a214">9ff7a214</a> -  * Copyright 2008, 2009, 2010 LSST Corporation.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#c0b62a68">c0b62a68</a> +  * Copyright 2008-2015 AURA/LSST</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#9ff7a214">9ff7a214</a> -  * </div>
              ?   -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c0b62a68">c0b62a68</a> +  *</div>
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#9ff7a214">9ff7a214</a> -  * </div>
              ?   -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#c0b62a68">c0b62a68</a> +  *</div>
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#9ff7a214">9ff7a214</a> -  * </div>
              ?   -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#c0b62a68">c0b62a68</a> +  *</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#9ff7a214">9ff7a214</a> -  * You should have received a copy of the LSST License Statement and </div>
              ?                                                                     -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#c0b62a68">c0b62a68</a> +  * You should have received a copy of the LSST License Statement and</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#9ff7a214">9ff7a214</a> -  * the GNU General Public License along with this program.  If not, </div>
              ?                                                                    -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#c0b62a68">c0b62a68</a> +  * the GNU General Public License along with this program.  If not,</div>
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#9ff7a214">9ff7a214</a> -  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#c0b62a68">c0b62a68</a> + </div>
                #ifndef LSST_IP_DIFFIM_DIPOLEALGORITHMS_H
                #define LSST_IP_DIFFIM_DIPOLEALGORITHMS_H
                //!
                // Control/algorithm hierarchy for dipole measurement.
                //
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#c0b62a68">c0b62a68</a> + #include <stdio.h></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#c0b62a68">c0b62a68</a> + #include <execinfo.h></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#c0b62a68">c0b62a68</a> + #include <signal.h></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#c0b62a68">c0b62a68</a> + #include <stdlib.h></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#c0b62a68">c0b62a68</a> + #include <unistd.h></div>
                #include "lsst/base.h"
                #include "lsst/pex/config.h"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#c0b62a68">c0b62a68</a> + #include "ndarray/eigen.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/afw/table/Source.h"</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#9ff7a214">9ff7a214</a> - #include "lsst/meas/algorithms/Algorithm.h"</div>
              ?                      --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base/Algorithm.h"</div>
              ?                     +  +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base/FluxUtilities.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base/CentroidUtilities.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base/FlagHandler.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#c0b62a68">c0b62a68</a> + #include "lsst/meas/base/InputUtilities.h"</div>
                
                namespace lsst {
                namespace ip {
                namespace diffim {
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#9ff7a214">9ff7a214</a> - class DipoleCentroidControl;</div>
              ?                            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#c0b62a68">c0b62a68</a> + class DipoleCentroidControl {</div>
              ?                            ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#c0b62a68">c0b62a68</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#c0b62a68">c0b62a68</a> +     explicit DipoleCentroidControl() {}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#c0b62a68">c0b62a68</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#9ff7a214">9ff7a214</a> - class DipoleFluxControl;</div>
              ?                        ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#c0b62a68">c0b62a68</a> + class DipoleFluxControl {</div>
              ?                        ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#c0b62a68">c0b62a68</a> + public:</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#c0b62a68">c0b62a68</a> +     explicit DipoleFluxControl() {}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#c0b62a68">c0b62a68</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#c0b62a68">c0b62a68</a> + /**</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#c0b62a68">c0b62a68</a> +  *  @brief C++ control object for PSF dipole fluxes.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#c0b62a68">c0b62a68</a> +  */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#c0b62a68">c0b62a68</a> + class PsfDipoleFluxControl : public DipoleFluxControl {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#c0b62a68">c0b62a68</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#c0b62a68">c0b62a68</a> +     LSST_CONTROL_FIELD(maxPixels, int, "Maximum number of pixels to apply the measurement to");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#c0b62a68">c0b62a68</a> +     LSST_CONTROL_FIELD(stepSizeCoord, float, "Default initial step size for coordinates in non-linear fitter");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#c0b62a68">c0b62a68</a> +     LSST_CONTROL_FIELD(stepSizeFlux, float, "Default initial step size for flux in non-linear fitter");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#c0b62a68">c0b62a68</a> +     LSST_CONTROL_FIELD(errorDef, double, "How many sigma the error bars of the non-linear fitter represent");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#c0b62a68">c0b62a68</a> +     LSST_CONTROL_FIELD(maxFnCalls, int, "Maximum function calls for non-linear fitter; 0 = unlimited");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#c0b62a68">c0b62a68</a> +     PsfDipoleFluxControl() : DipoleFluxControl(), maxPixels(500),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#c0b62a68">c0b62a68</a> +                              stepSizeCoord(0.1), stepSizeFlux(1.0), errorDef(1.0), maxFnCalls(100000) {}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#c0b62a68">c0b62a68</a> + };</div>
                
                /**
                 *  @brief Intermediate base class for algorithms that compute a centroid.
                 */
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#9ff7a214">9ff7a214</a> - class DipoleCentroidAlgorithm : public meas::algorithms::Algorithm {</div>
              ?                                               --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#63017c44">63017c44</a> + class DipoleCentroidAlgorithm : public meas::base::SimpleAlgorithm {</div>
              ?                                              +  +  ++++++
                public:
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#c0b62a68">c0b62a68</a> +     enum {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#63017c44">63017c44</a> +         FAILURE=meas::base::FlagHandler::FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#c0b62a68">c0b62a68</a> +         POS_FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#c0b62a68">c0b62a68</a> +         NEG_FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#c0b62a68">c0b62a68</a> +         N_FLAGS</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#c0b62a68">c0b62a68</a> +     };</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#c0b62a68">c0b62a68</a> +     typedef DipoleCentroidControl Control;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#c0b62a68">c0b62a68</a> +     DipoleCentroidAlgorithm(Control const & ctrl, std::string const & name,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#c0b62a68">c0b62a68</a> +         afw::table::Schema & schema, std::string const & doc);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#c0b62a68">c0b62a68</a> +     typedef meas::base::CentroidResultKey ResultKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#9ff7a214">9ff7a214</a> +     /// @brief Return the standard centroid keys registered by this algorithm.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getPositiveKeys() const { return _positiveKeys; }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getNegativeKeys() const { return _negativeKeys; }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#9ff7a214">9ff7a214</a> + protected:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#9ff7a214">9ff7a214</a> +     /// @brief Initialize with a manually-constructed key tuple.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#c0b62a68">c0b62a68</a> +     DipoleCentroidAlgorithm(Control const & ctrl, std::string const & name, afw::table::Schema & schema,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#c0b62a68">c0b62a68</a> +        std::string const & doc, ResultKey const & positiveKeys, ResultKey const & negativeKeys);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#c0b62a68">c0b62a68</a> +     Control _ctrl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#63017c44">63017c44</a> +     meas::base::FluxResultKey _fluxResultKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#63017c44">63017c44</a> +     meas::base::FlagHandler _flagHandler;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#63017c44">63017c44</a> +     meas::base::SafeCentroidExtractor _centroidExtractor;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#c0b62a68">c0b62a68</a> +     ResultKey _positiveKeys;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#c0b62a68">c0b62a68</a> +     ResultKey _negativeKeys;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#9ff7a214">9ff7a214</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#9ff7a214">9ff7a214</a> + /**</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#9ff7a214">9ff7a214</a> +  *  @brief Intermediate base class for algorithms that compute a flux.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#9ff7a214">9ff7a214</a> +  */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#63017c44">63017c44</a> + class DipoleFluxAlgorithm : public meas::base::SimpleAlgorithm {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#9ff7a214">9ff7a214</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#c0b62a68">c0b62a68</a> +     enum {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#63017c44">63017c44</a> +         FAILURE=meas::base::FlagHandler::FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#c0b62a68">c0b62a68</a> +         POS_FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#c0b62a68">c0b62a68</a> +         NEG_FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#c0b62a68">c0b62a68</a> +         N_FLAGS</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#c0b62a68">c0b62a68</a> +     };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#c0b62a68">c0b62a68</a> +     /// A typedef to the Control object for this algorithm, defined above.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#c0b62a68">c0b62a68</a> +     /// The control object contains the configuration parameters for this algorithm.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#c0b62a68">c0b62a68</a> +     typedef DipoleFluxControl Control;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#c0b62a68">c0b62a68</a> +     DipoleFluxAlgorithm(Control const & ctrl, std::string const & name, afw::table::Schema & schema,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#c0b62a68">c0b62a68</a> +         std::string const & doc);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#c0b62a68">c0b62a68</a> +     // A typedef for the FunctorKey which returns the result of this algorithm</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#63017c44">63017c44</a> +     typedef meas::base::FluxResultKey ResultKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#9ff7a214">9ff7a214</a> +     /// @brief Return the standard flux keys registered by this algorithm.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getPositiveKeys() const { return _positiveKeys; }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getNegativeKeys() const { return _negativeKeys; }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#c0b62a68">c0b62a68</a> + protected:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#c0b62a68">c0b62a68</a> +     /// @brief Initialize with a manually-constructed result key.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#c0b62a68">c0b62a68</a> +     DipoleFluxAlgorithm(Control const & ctrl, std::string const & name,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#c0b62a68">c0b62a68</a> +                         afw::table::Schema & schema, std::string const & doc,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#c0b62a68">c0b62a68</a> +                         ResultKey const & positiveKeys, ResultKey const & negativeKeys);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#c0b62a68">c0b62a68</a> +     Control _ctrl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#63017c44">63017c44</a> +     meas::base::FluxResultKey _fluxResultKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#63017c44">63017c44</a> +     meas::base::FlagHandler _flagHandler;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#63017c44">63017c44</a> +     meas::base::SafeCentroidExtractor _centroidExtractor;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#c0b62a68">c0b62a68</a> +     ResultKey _positiveKeys;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#c0b62a68">c0b62a68</a> +     ResultKey _negativeKeys;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#9ff7a214">9ff7a214</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#9ff7a214">9ff7a214</a> + inline DipoleCentroidAlgorithm::DipoleCentroidAlgorithm(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#c0b62a68">c0b62a68</a> +     Control const & ctrl, std::string const & name, afw::table::Schema & schema, std::string const & doc</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#9ff7a214">9ff7a214</a> +     ) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#c0b62a68">c0b62a68</a> +     _ctrl(ctrl),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#c0b62a68">c0b62a68</a> +     _centroidExtractor(schema, name, true)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#c0b62a68">c0b62a68</a> + {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#63017c44">63017c44</a> +     static boost::array<meas::base::FlagDefinition,N_FLAGS> const flagDefs = {{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#c0b62a68">c0b62a68</a> +         {"flag", "general failure flag, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#c0b62a68">c0b62a68</a> +         {"pos_flag", "failure flag for positive, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#c0b62a68">c0b62a68</a> +         {"neg_flag", "failure flag for negative, set if anything went wrong"}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#c0b62a68">c0b62a68</a> +     }};</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#c0b62a68">c0b62a68</a> +     _flagHandler = meas::base::FlagHandler::addFields(schema, name, flagDefs.begin(), flagDefs.end());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#c0b62a68">c0b62a68</a> +     meas::base::CentroidResultKey::addFields(schema, name+"_pos", doc+": positive lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#c0b62a68">c0b62a68</a> +     meas::base::CentroidResultKey::addFields(schema, name+"_neg", doc+": negative lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#c0b62a68">c0b62a68</a> +     _positiveKeys = ResultKey(schema[name+"_pos"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#c0b62a68">c0b62a68</a> +     _negativeKeys = ResultKey(schema[name+"_neg"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#c0b62a68">c0b62a68</a> + }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#9ff7a214">9ff7a214</a> + inline DipoleCentroidAlgorithm::DipoleCentroidAlgorithm(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#c0b62a68">c0b62a68</a> +         Control const & ctrl, std::string const & name, afw::table::Schema & schema, std::string const & doc,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#c0b62a68">c0b62a68</a> +         ResultKey const & positiveKeys, ResultKey const & negativeKeys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#9ff7a214">9ff7a214</a> +     ) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#c0b62a68">c0b62a68</a> +     _ctrl(ctrl),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#c0b62a68">c0b62a68</a> +     _centroidExtractor(schema, name, true)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#c0b62a68">c0b62a68</a> + {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#c0b62a68">c0b62a68</a> +     meas::base::CentroidResultKey::addFields(schema, name+"_pos", doc + ": positive lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#c0b62a68">c0b62a68</a> +     meas::base::CentroidResultKey::addFields(schema, name+"_neg", doc + ": negative lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#63017c44">63017c44</a> +     static boost::array<meas::base::FlagDefinition,N_FLAGS> const flagDefs = {{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#c0b62a68">c0b62a68</a> +         {"flag", "general failure flag, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#c0b62a68">c0b62a68</a> +         {"pos_flag", "failure flag for positive, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#c0b62a68">c0b62a68</a> +         {"neg_flag", "failure flag for negative, set if anything went wrong"}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#c0b62a68">c0b62a68</a> +     }};</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#c0b62a68">c0b62a68</a> +     _flagHandler = meas::base::FlagHandler::addFields(schema, name, flagDefs.begin(), flagDefs.end());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#c0b62a68">c0b62a68</a> +     _positiveKeys = ResultKey(schema[name+"_pos"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#c0b62a68">c0b62a68</a> +     _negativeKeys = ResultKey(schema[name+"_neg"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#9ff7a214">9ff7a214</a> + }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#9ff7a214">9ff7a214</a> + inline DipoleFluxAlgorithm::DipoleFluxAlgorithm(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#63017c44">63017c44</a> +     Control const & ctrl, std::string const & name, afw::table::Schema & schema,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#c0b62a68">c0b62a68</a> +         std::string const & doc, ResultKey const & positiveKeys, ResultKey const & negativeKeys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#9ff7a214">9ff7a214</a> +     ) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#c0b62a68">c0b62a68</a> +     _ctrl(ctrl),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#c0b62a68">c0b62a68</a> +     _centroidExtractor(schema, name, false)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#c0b62a68">c0b62a68</a> + {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#63017c44">63017c44</a> +     static boost::array<meas::base::FlagDefinition,N_FLAGS> const flagDefs = {{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#c0b62a68">c0b62a68</a> +         {"flag", "general failure flag, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#c0b62a68">c0b62a68</a> +         {"pos_flag", "failure flag for positive, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#c0b62a68">c0b62a68</a> +         {"neg_flag", "failure flag for negative, set if anything went wrong"}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#c0b62a68">c0b62a68</a> +     }};</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#c0b62a68">c0b62a68</a> +     _flagHandler = meas::base::FlagHandler::addFields(schema, name, flagDefs.begin(), flagDefs.end());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#c0b62a68">c0b62a68</a> +     meas::base::FluxResultKey::addFields(schema, name+"_pos", doc+": positive lobe");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#c0b62a68">c0b62a68</a> +     meas::base::FluxResultKey::addFields(schema, name+"_neg", doc+": negative lobe");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#c0b62a68">c0b62a68</a> +     _positiveKeys = ResultKey(positiveKeys);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#c0b62a68">c0b62a68</a> +     _negativeKeys = ResultKey(negativeKeys);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#c0b62a68">c0b62a68</a> + }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#9ff7a214">9ff7a214</a> + inline DipoleFluxAlgorithm::DipoleFluxAlgorithm(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#63017c44">63017c44</a> +     Control const & ctrl, std::string const & name, afw::table::Schema & schema,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#c0b62a68">c0b62a68</a> +         std::string const & doc</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#9ff7a214">9ff7a214</a> +     ) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#c0b62a68">c0b62a68</a> +     _ctrl(ctrl),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#c0b62a68">c0b62a68</a> +     _centroidExtractor(schema, name, false)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#c0b62a68">c0b62a68</a> + {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#63017c44">63017c44</a> +     static boost::array<meas::base::FlagDefinition,N_FLAGS> const flagDefs = {{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#c0b62a68">c0b62a68</a> +         {"flag", "general failure flag, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#c0b62a68">c0b62a68</a> +         {"pos_flag", "failure flag for positive, set if anything went wrong"},</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#c0b62a68">c0b62a68</a> +         {"neg_flag", "failure flag for negative, set if anything went wrong"}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#c0b62a68">c0b62a68</a> +     }};</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#c0b62a68">c0b62a68</a> +     _flagHandler = meas::base::FlagHandler::addFields(schema, name, flagDefs.begin(), flagDefs.end());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#c0b62a68">c0b62a68</a> +     meas::base::FluxResultKey::addFields(schema, name+"_pos", doc+": positive lobe");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#c0b62a68">c0b62a68</a> +     meas::base::FluxResultKey::addFields(schema, name+"_neg", doc+": negative lobe");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#c0b62a68">c0b62a68</a> +     _positiveKeys = ResultKey(schema[name+"_pos"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#c0b62a68">c0b62a68</a> +     _negativeKeys = ResultKey(schema[name+"_neg"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#9ff7a214">9ff7a214</a> + }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#c0b62a68">c0b62a68</a> + /*</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#c0b62a68">c0b62a68</a> + class that knows how to calculate centroids as a simple unweighted first</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#c0b62a68">c0b62a68</a> +  * moment of the 3x3 region around the peaks</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#9ff7a214">9ff7a214</a> +  */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#c0b62a68">c0b62a68</a> + class NaiveDipoleFlux : public DipoleFluxAlgorithm {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#9ff7a214">9ff7a214</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#c0b62a68">c0b62a68</a> +     typedef DipoleFluxControl Control;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#c0b62a68">c0b62a68</a> +     NaiveDipoleFlux(Control const & ctrl, std::string const & name, afw::table::Schema & schema) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#c0b62a68">c0b62a68</a> +         DipoleFluxAlgorithm(ctrl, name, schema, "raw flux counts"),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#c0b62a68">c0b62a68</a> +         _numPositiveKey(schema.addField<int>(name+"_npos", "number of positive pixels", "dn")),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#c0b62a68">c0b62a68</a> +         _numNegativeKey(schema.addField<int>(name+"_nneg", "number of negative pixels", "dn"))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#c0b62a68">c0b62a68</a> +     {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#c0b62a68">c0b62a68</a> +     }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#c0b62a68">c0b62a68</a> +     void measure(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#c0b62a68">c0b62a68</a> +         afw::image::Exposure<float> const & exposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#9ff7a214">9ff7a214</a> +     ) const;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#c0b62a68">c0b62a68</a> +     void fail(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#63017c44">63017c44</a> +         meas::base::MeasurementError * error=NULL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#c0b62a68">c0b62a68</a> +     ) const;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#a4775afa">a4775afa</a> + private:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#a4775afa">a4775afa</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#c0b62a68">c0b62a68</a> +     Control _ctrl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#c0b62a68">c0b62a68</a> +     afw::table::Key<int> _numPositiveKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#c0b62a68">c0b62a68</a> +     afw::table::Key<int> _numNegativeKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#9ff7a214">9ff7a214</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#9ff7a214">9ff7a214</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#9ff7a214">9ff7a214</a> + /**</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#c0b62a68">c0b62a68</a> +  *  @brief Intermediate base class for algorithms that compute a centroid.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#9ff7a214">9ff7a214</a> +  */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#c0b62a68">c0b62a68</a> + class NaiveDipoleCentroid : public DipoleCentroidAlgorithm {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#9ff7a214">9ff7a214</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#c0b62a68">c0b62a68</a> +     enum {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#63017c44">63017c44</a> +         FAILURE=meas::base::FlagHandler::FAILURE,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#c0b62a68">c0b62a68</a> +         POS_FLAGS,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#c0b62a68">c0b62a68</a> +         NEG_FLAGS,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#c0b62a68">c0b62a68</a> +         N_FLAGS</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#c0b62a68">c0b62a68</a> +     };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#c0b62a68">c0b62a68</a> +     NaiveDipoleCentroid(Control const & ctrl, std::string const & name, afw::table::Schema & schema);</div>
                    /**
                     *  @brief Tuple type that holds the keys that define a standard centroid algorithm.
                     *
                     *  Algorithms are encouraged to add additional flags as appropriate, but these are required.
                     */
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#c0b62a68">c0b62a68</a> +     typedef meas::base::CentroidResultKey ResultKey;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#9ff7a214">9ff7a214</a> -     typedef afw::table::KeyTuple<afw::table::Centroid> KeyTuple;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#1d2154bc">1d2154bc</a> -     /// @copydoc meas::algorithms::Algorithm::getControl</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#9ff7a214">9ff7a214</a> -     DipoleCentroidControl const & getControl() const;</div>
                
                    /// @brief Return the standard centroid keys registered by this algorithm.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#9ff7a214">9ff7a214</a> -     KeyTuple const & getPositiveKeys() const { return _positiveKeys; }</div>
              ?        -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getPositiveKeys() const { return _positiveKeys; }</div>
              ?     ++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#9ff7a214">9ff7a214</a> -     KeyTuple const & getNegativeKeys() const { return _negativeKeys; }</div>
              ?        -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#c0b62a68">c0b62a68</a> +     ResultKey const & getNegativeKeys() const { return _negativeKeys; }</div>
              ?     ++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#c0b62a68">c0b62a68</a> +     void measure(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#c0b62a68">c0b62a68</a> +         afw::image::Exposure<float> const & exposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#c0b62a68">c0b62a68</a> +     ) const;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#c0b62a68">c0b62a68</a> +     void fail(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#63017c44">63017c44</a> +         meas::base::MeasurementError * error=NULL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#9ff7a214">9ff7a214</a> +     ) const;</div>
                
                protected:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#9ff7a214">9ff7a214</a> - </div>
                    /// @brief Initialize with a manually-constructed key tuple.
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#a4775afa">a4775afa</a> +     NaiveDipoleCentroid(Control const & ctrl, std::string const & name, afw::table::Schema & schema,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#a4775afa">a4775afa</a> +         ResultKey const & positiveKeys, ResultKey const & negativeKeys);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#9ff7a214">9ff7a214</a> -     DipoleCentroidAlgorithm(DipoleCentroidControl const & ctrl, KeyTuple const & positiveKeys,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#9ff7a214">9ff7a214</a> -         KeyTuple const & negativeKeys);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#9ff7a214">9ff7a214</a> -     /// @brief Initialize using afw::table::addCentroid field to fill out repetitive descriptions.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#8a966ce1">8a966ce1</a> -     DipoleCentroidAlgorithm(DipoleCentroidControl const & ctrl, </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#8a966ce1">8a966ce1</a> -                             afw::table::Schema & schema, char const * doc);</div>
                
                private:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#9ff7a214">9ff7a214</a> -     KeyTuple _positiveKeys;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#9ff7a214">9ff7a214</a> -     KeyTuple _negativeKeys;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#9ff7a214">9ff7a214</a> - };</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#9ff7a214">9ff7a214</a> - class DipoleCentroidControl : public meas::algorithms::AlgorithmControl {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#c0b62a68">c0b62a68</a> +     Control _ctrl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#63017c44">63017c44</a> +     meas::base::FluxResultKey _fluxResultKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#63017c44">63017c44</a> +     meas::base::FlagHandler _flagHandler;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#63017c44">63017c44</a> +     meas::base::SafeCentroidExtractor _centroidExtractor;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#9ff7a214">9ff7a214</a> + };</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#9ff7a214">9ff7a214</a> -     PTR(DipoleCentroidControl) clone() const {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#9ff7a214">9ff7a214</a> -         return boost::static_pointer_cast<DipoleCentroidControl>(_clone());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#9ff7a214">9ff7a214</a> + /**</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#c0b62a68">c0b62a68</a> +  * Implementation of Psf dipole flux</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#9ff7a214">9ff7a214</a> +  */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#c0b62a68">c0b62a68</a> + class PsfDipoleFlux : public DipoleFluxAlgorithm {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#9ff7a214">9ff7a214</a> + public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#c0b62a68">c0b62a68</a> +     typedef PsfDipoleFluxControl Control;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#c0b62a68">c0b62a68</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#c0b62a68">c0b62a68</a> +     PsfDipoleFlux(PsfDipoleFluxControl const & ctrl, std::string const & name, afw::table::Schema & schema) :</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#c0b62a68">c0b62a68</a> +         DipoleFluxAlgorithm(ctrl, name, schema, "jointly fitted psf flux counts"),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#c0b62a68">c0b62a68</a> +         _ctrl(ctrl),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#c0b62a68">c0b62a68</a> +         _chi2dofKey(schema.addField<float>(name+"_chi2dof",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#c0b62a68">c0b62a68</a> +                                            "chi2 per degree of freedom of fit")),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#c0b62a68">c0b62a68</a> +         _flagMaxPixelsKey(schema.addField<afw::table::Flag>(name+"_flags_maxpix",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#c0b62a68">c0b62a68</a> +                                                             "set if too large a footprint was sent to the algorithm"))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#c0b62a68">c0b62a68</a> +     {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#c0b62a68">c0b62a68</a> +         meas::base::CentroidResultKey::addFields(schema, name+"_pos_centroid", "psf fitted center of positive lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#c0b62a68">c0b62a68</a> +         meas::base::CentroidResultKey::addFields(schema, name+"_neg_centroid", "psf fitted center of negative lobe", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#c0b62a68">c0b62a68</a> +         meas::base::CentroidResultKey::addFields(schema, name+"_centroid", "average of negative and positive lobe positions", meas::base::SIGMA_ONLY);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#63017c44">63017c44</a> +         _posCentroid = meas::base::CentroidResultKey(schema[name+"_pos_centroid"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#63017c44">63017c44</a> +         _negCentroid = meas::base::CentroidResultKey(schema[name+"_neg_centroid"]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#63017c44">63017c44</a> +         _avgCentroid = meas::base::CentroidResultKey(schema[name+"_centroid"]);</div>
                    }
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#c0b62a68">c0b62a68</a> +     std::pair<double,int> chi2(afw::table::SourceRecord & source,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#c0b62a68">c0b62a68</a> +                 afw::image::Exposure<float> const & exposure,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#c0b62a68">c0b62a68</a> +                 double negCenterX, double negCenterY, double negFlux,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#c0b62a68">c0b62a68</a> +                 double posCenterX, double poCenterY, double posFlux</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#c0b62a68">c0b62a68</a> +                 ) const;</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#9ff7a214">9ff7a214</a> - protected:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#9ff7a214">9ff7a214</a> -     explicit DipoleCentroidControl(std::string const & name_, double priority=0.0) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#9ff7a214">9ff7a214</a> -         AlgorithmControl(name_, priority) {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#9ff7a214">9ff7a214</a> - };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#c0b62a68">c0b62a68</a> +     void measure(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
341  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
342  <a href="#c0b62a68">c0b62a68</a> +         afw::image::Exposure<float> const & exposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#9ff7a214">9ff7a214</a> +     ) const;</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
345  <a href="#c0b62a68">c0b62a68</a> +     void fail(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
346  <a href="#c0b62a68">c0b62a68</a> +         afw::table::SourceRecord & measRecord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
347  <a href="#63017c44">63017c44</a> +         meas::base::MeasurementError * error=NULL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
348  <a href="#c0b62a68">c0b62a68</a> +     ) const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#9ff7a214">9ff7a214</a> - /**</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#9ff7a214">9ff7a214</a> -  *  @brief Intermediate base class for algorithms that compute a flux.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#9ff7a214">9ff7a214</a> -  */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#9ff7a214">9ff7a214</a> - class DipoleFluxAlgorithm : public meas::algorithms::Algorithm {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#9ff7a214">9ff7a214</a> -     /**</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#9ff7a214">9ff7a214</a> -      *  @brief Tuple type that holds the keys that define a standard flux algorithm.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#9ff7a214">9ff7a214</a> -      *</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#9ff7a214">9ff7a214</a> -      *  Algorithms are encouraged to add additional flags as appropriate, but these are required.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#9ff7a214">9ff7a214</a> -      */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#9ff7a214">9ff7a214</a> -     typedef afw::table::KeyTuple<afw::table::Flux> KeyTuple;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#1d2154bc">1d2154bc</a> -     /// @copydoc meas::algorithms::Algorithm::getControl</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#9ff7a214">9ff7a214</a> -     DipoleFluxControl const & getControl() const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#9ff7a214">9ff7a214</a> -     /// @brief Return the standard flux keys registered by this algorithm.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#9ff7a214">9ff7a214</a> -     KeyTuple const & getPositiveKeys() const { return _positiveKeys; }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#9ff7a214">9ff7a214</a> -     KeyTuple const & getNegativeKeys() const { return _negativeKeys; }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#9ff7a214">9ff7a214</a> - protected:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#9ff7a214">9ff7a214</a> -     /// @brief Initialize with a manually-constructed key tuple.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#9ff7a214">9ff7a214</a> -     DipoleFluxAlgorithm(DipoleFluxControl const & ctrl, KeyTuple const & positiveKeys,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#9ff7a214">9ff7a214</a> -                         KeyTuple const & negativeKeys);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#9ff7a214">9ff7a214</a> -     /// @brief Initialize using afw::table::addFlux field to fill out repetitive descriptions.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#8a966ce1">8a966ce1</a> -     DipoleFluxAlgorithm(DipoleFluxControl const & ctrl, </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#8a966ce1">8a966ce1</a> -                         afw::table::Schema & schema, char const * doc);</div>
                
                private:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#9ff7a214">9ff7a214</a> -     KeyTuple _positiveKeys;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#9ff7a214">9ff7a214</a> -     KeyTuple _negativeKeys;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#9ff7a214">9ff7a214</a> - };</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#9ff7a214">9ff7a214</a> - class DipoleFluxControl : public meas::algorithms::AlgorithmControl {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
352  <a href="#c0b62a68">c0b62a68</a> +     Control _ctrl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
353  <a href="#c0b62a68">c0b62a68</a> +     afw::table::Key<float> _chi2dofKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
354  <a href="#63017c44">63017c44</a> +     meas::base::CentroidResultKey  _avgCentroid;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
355  <a href="#63017c44">63017c44</a> +     meas::base::CentroidResultKey  _negCentroid;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#63017c44">63017c44</a> +     meas::base::CentroidResultKey  _posCentroid;</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#c0b62a68">c0b62a68</a> +     afw::table::Key< afw::table::Flag > _flagMaxPixelsKey;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#8a966ce1">8a966ce1</a> -     PTR(DipoleFluxControl) clone() const { </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#8a966ce1">8a966ce1</a> -         return boost::static_pointer_cast<DipoleFluxControl>(_clone()); }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#9ff7a214">9ff7a214</a> - protected:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#9ff7a214">9ff7a214</a> -     explicit DipoleFluxControl(std::string const & name_, double priority=2.0) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#9ff7a214">9ff7a214</a> -         AlgorithmControl(name_, priority) {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#9ff7a214">9ff7a214</a> - };</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#9ff7a214">9ff7a214</a> - inline DipoleCentroidAlgorithm::DipoleCentroidAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#9ff7a214">9ff7a214</a> -     DipoleCentroidControl const & ctrl, KeyTuple const & positiveKeys, KeyTuple const & negativeKeys</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#9ff7a214">9ff7a214</a> -     ) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#9ff7a214">9ff7a214</a> -     Algorithm(ctrl), _positiveKeys(positiveKeys), _negativeKeys(negativeKeys)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#9ff7a214">9ff7a214</a> - {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#9ff7a214">9ff7a214</a> - inline DipoleCentroidAlgorithm::DipoleCentroidAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#9ff7a214">9ff7a214</a> -     DipoleCentroidControl const & ctrl, afw::table::Schema & schema, char const * doc</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#9ff7a214">9ff7a214</a> -     ) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#9ff7a214">9ff7a214</a> -     Algorithm(ctrl), _positiveKeys(afw::table::addCentroidFields(schema, ctrl.name + ".pos", doc)),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#ffeb3ca1">ffeb3ca1</a> -     _negativeKeys(afw::table::addCentroidFields(schema, ctrl.name + ".neg", doc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#9ff7a214">9ff7a214</a> - {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#9ff7a214">9ff7a214</a> - inline DipoleCentroidControl const & DipoleCentroidAlgorithm::getControl() const {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#9ff7a214">9ff7a214</a> -     return static_cast<DipoleCentroidControl const &>(Algorithm::getControl());</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#9ff7a214">9ff7a214</a> - }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
359  <a href="#c0b62a68">c0b62a68</a> + };</div>
              ?  +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#9ff7a214">9ff7a214</a> - inline DipoleFluxAlgorithm::DipoleFluxAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#9ff7a214">9ff7a214</a> -     DipoleFluxControl const & ctrl, KeyTuple const & positiveKeys, KeyTuple const & negativeKeys</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#9ff7a214">9ff7a214</a> -     ) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#9ff7a214">9ff7a214</a> -     Algorithm(ctrl), _positiveKeys(positiveKeys), _negativeKeys(negativeKeys)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#9ff7a214">9ff7a214</a> - {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#9ff7a214">9ff7a214</a> - inline DipoleFluxAlgorithm::DipoleFluxAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#9ff7a214">9ff7a214</a> -     DipoleFluxControl const & ctrl, afw::table::Schema & schema, char const * doc</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#9ff7a214">9ff7a214</a> -     ) :</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#9ff7a214">9ff7a214</a> -     Algorithm(ctrl), _positiveKeys(afw::table::addFluxFields(schema, ctrl.name + ".pos", doc)),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#ffeb3ca1">ffeb3ca1</a> -     _negativeKeys(afw::table::addFluxFields(schema, ctrl.name + ".neg", doc))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#9ff7a214">9ff7a214</a> - {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#9ff7a214">9ff7a214</a> - inline DipoleFluxControl const & DipoleFluxAlgorithm::getControl() const {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#9ff7a214">9ff7a214</a> -     return static_cast<DipoleFluxControl const &>(Algorithm::getControl());</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#9ff7a214">9ff7a214</a> - }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#9ff7a214">9ff7a214</a> - /**</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#9ff7a214">9ff7a214</a> -  *  @brief C++ control object for naive dipole centroid.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#9ff7a214">9ff7a214</a> -  */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#9ff7a214">9ff7a214</a> - class NaiveDipoleCentroidControl : public DipoleCentroidControl {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#40cbcfb2">40cbcfb2</a> -     NaiveDipoleCentroidControl() : DipoleCentroidControl("centroid.dipole.naive") {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#9ff7a214">9ff7a214</a> - private:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::AlgorithmControl) _clone() const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::Algorithm) _makeAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#9ff7a214">9ff7a214</a> -         afw::table::Schema & schema, PTR(daf::base::PropertyList) const & metadata</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#9ff7a214">9ff7a214</a> -     ) const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#9ff7a214">9ff7a214</a> - };</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#9ff7a214">9ff7a214</a> - /**</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#9ff7a214">9ff7a214</a> -  *  @brief C++ control object for naive dipole fluxes.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#9ff7a214">9ff7a214</a> -  */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#9ff7a214">9ff7a214</a> - class NaiveDipoleFluxControl : public DipoleFluxControl {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#40cbcfb2">40cbcfb2</a> -     NaiveDipoleFluxControl() : DipoleFluxControl("flux.dipole.naive") {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#9ff7a214">9ff7a214</a> - private:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::AlgorithmControl) _clone() const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::Algorithm) _makeAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#9ff7a214">9ff7a214</a> -         afw::table::Schema & schema, PTR(daf::base::PropertyList) const & metadata</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#9ff7a214">9ff7a214</a> -     ) const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#9ff7a214">9ff7a214</a> - };</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#9ff7a214">9ff7a214</a> - /**</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#0ca251b6">0ca251b6</a> -  *  @brief C++ control object for PSF dipole fluxes.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#9ff7a214">9ff7a214</a> -  */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#9ff7a214">9ff7a214</a> - class PsfDipoleFluxControl : public DipoleFluxControl {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#9ff7a214">9ff7a214</a> - public:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#01750b38">01750b38</a> -     LSST_CONTROL_FIELD(maxPixels, int, "Maximum number of pixels to apply the measurement to");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#01750b38">01750b38</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#01750b38">01750b38</a> -     PsfDipoleFluxControl() : DipoleFluxControl("flux.dipole.psf"), maxPixels(500) {}</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#9ff7a214">9ff7a214</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#9ff7a214">9ff7a214</a> - private:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::AlgorithmControl) _clone() const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#9ff7a214">9ff7a214</a> -     virtual PTR(meas::algorithms::Algorithm) _makeAlgorithm(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#9ff7a214">9ff7a214</a> -         afw::table::Schema & schema, PTR(daf::base::PropertyList) const & metadata</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#9ff7a214">9ff7a214</a> -     ) const;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#9ff7a214">9ff7a214</a> - };</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#9ff7a214">9ff7a214</a> - </div>
                
                }}}// namespace lsst::ip::diffim
                
                #endif // !LSST_IP_DIFFIM_DIPOLEALGORITHMS_H
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="40cbcfb2"/></a>40cbcfb2</h3>

<pre>
commit 40cbcfb2a88b28901b135f9e88693a32bfdbaa11
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 12 15:58:16 2013 -0800

    Removed background tweak, doxygen comments, and peak sorting (peaks should already be sorted).  #2595
</pre>
<h3><a name="9ff7a214"/></a>9ff7a214</h3>

<pre>
commit 9ff7a2146cffaa10da68d57069907ba60d54bbd0
Author: Paul Price <price@astro.princeton.edu>
Date:   Mon Jan 28 18:17:40 2013 -0500

    Add algorithms to characterise dipoles.
</pre>
<h3><a name="1d2154bc"/></a>1d2154bc</h3>

<pre>
commit 1d2154bc369768169a08cd7a0b30a79a8cdcec46
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Tue Apr 23 18:18:58 2013 -0400

    Update new code to reflect lower-level API changes made on next
    
     - Removed createPsf usage
    
     - Change in measurement algorithm construction API
    
     - Psf no longer has getKernel, and PsfAttributes is deprecated
    
     - No more external aperture corrections
    
     - Psf::computeImage no longer normalizes to peak by default
    
     - Can't rely on SourceMeasurementTask.run() to call classify() anymore
    
     - Sizes coming out of Psf::computeShape aren't quite the same as
    those produced by PsfAttributes
    
     - Use bbox.clip to find bounding box overlaps
</pre>
<h3><a name="ffeb3ca1"/></a>ffeb3ca1</h3>

<pre>
commit ffeb3ca101cad421ea16172777b0b7d3c991d76b
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jan 28 17:56:10 2013 -0800

    Renamed the suffixes for negative flux flag names.
</pre>
<h3><a name="0ca251b6"/></a>0ca251b6</h3>

<pre>
commit 0ca251b66b4fa95776f15a43aaea97f983161f5b
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jan 29 13:51:02 2013 -0800

    Initial implementation of Psf dipole measurement in python.
</pre>
<h3><a name="8a966ce1"/></a>8a966ce1</h3>

<pre>
commit 8a966ce11b186727f265b1366f672c504e20ddcf
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 12 14:19:38 2013 -0800

    Fixing line lengths to be <= 110 characters.  #2595
</pre>
<h3><a name="01750b38"/></a>01750b38</h3>

<pre>
commit 01750b3832593e485dd93332c408a2fa42228bbd
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 28 17:07:23 2013 -0600

    Added control variable setting maximum number of pixels for PsfDipoleFlux to measure.  #2636
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="a4775afa"/></a>a4775afa</h3>

<pre>
commit a4775afa92cd165f745c060b5405670b696070e5
Author: John Swinbank <swinbank@princeton.edu>
Date:   Sun Mar 1 21:22:00 2015 -0500

    Remove overload on SimpleAlgorithm::measure(N).
    
    Following convention in meas_base.
</pre>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
<h3><a name="9ff7a214"/></a>9ff7a214</h3>

<pre>
commit 9ff7a2146cffaa10da68d57069907ba60d54bbd0
Author: Paul Price <price@astro.princeton.edu>
Date:   Mon Jan 28 18:17:40 2013 -0500

    Add algorithms to characterise dipoles.
</pre>
<h3><a name="63017c44"/></a>63017c44</h3>

<pre>
commit 63017c44a037040f39b2d90fe6b815b58cb68d4a
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Sun Mar 1 14:24:39 2015 -0600

    Responses to PR from Simon and John
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_44"><a name="python/lsst/ip/diffim/snapPsfMatch.py"/></a>python/lsst/ip/diffim/snapPsfMatch.py</h1>

<h3 id="toc_45">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import lsst.pex.config as pexConfig
                from psfMatch import PsfMatchConfigDF, PsfMatchConfigAL
                from imagePsfMatch import ImagePsfMatchTask, ImagePsfMatchConfig
                
                class SnapPsfMatchConfigDF(PsfMatchConfigDF):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#9a8b565a">9a8b565a</a> -     """Version of Psf Matching optimized for snap subtraction"""</div>
              ?        ^ ^^    ---   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#fdd998a1">fdd998a1</a> +     """Delta-function Psf-matching config optimized for snap subtraction"""</div>
              ?        ^ ^^^^^^^^^       ^^       +++++++
                    def setDefaults(self):
                        PsfMatchConfigDF.setDefaults(self)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#a8fe2a5f">a8fe2a5f</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#9a8b565a">9a8b565a</a> -         # No spatial variation in model</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#9a8b565a">9a8b565a</a> -         self.spatialKernelOrder = 0</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#cca1e80e">cca1e80e</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#9a8b565a">9a8b565a</a> -         # Don't fit for differential background</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#9a8b565a">9a8b565a</a> -         self.fitForBackground = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#9a8b565a">9a8b565a</a> -         # Small kernel size</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#9a8b565a">9a8b565a</a> -         self.kernelSize = 7</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#9a8b565a">9a8b565a</a> -         # With zero spatial order don't worry about spatial clipping</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#9a8b565a">9a8b565a</a> -         self.spatialKernelClipping = False</div>
                
                        # No regularization
                        self.useRegularization = False
                
                        # Pca
                        self.usePcaForSpatialKernel = True
                        self.subtractMeanForPca = True
                        self.numPrincipalComponents = 5
                
                class SnapPsfMatchConfigAL(PsfMatchConfigAL):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#9a8b565a">9a8b565a</a> -     """Version of Psf Matching optimized for snap subtraction"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#fdd998a1">fdd998a1</a> +     """Sum-of-Gaussian (Alard-Lupton) Psf-matching config optimized for snap subtraction"""</div>
                    def setDefaults(self):
                        PsfMatchConfigAL.setDefaults(self)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#a8fe2a5f">a8fe2a5f</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#9a8b565a">9a8b565a</a> -         # No spatial variation in model</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#9a8b565a">9a8b565a</a> -         self.spatialKernelOrder = 0</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#cca1e80e">cca1e80e</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#9a8b565a">9a8b565a</a> -         # Don't fit for differential background</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#9a8b565a">9a8b565a</a> -         self.fitForBackground = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#9a8b565a">9a8b565a</a> -         # Small kernel size</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#9a8b565a">9a8b565a</a> -         self.kernelSize = 7</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#9a8b565a">9a8b565a</a> -         # With zero spatial order don't worry about spatial clipping</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#9a8b565a">9a8b565a</a> -         self.spatialKernelClipping = False</div>
                
                        # Simple basis set
                        self.alardNGauss = 2
                        self.alardDegGauss = (4, 2)
                        self.alardSigGauss = (1.0, 2.5)
                
                class SnapPsfMatchConfig(ImagePsfMatchConfig):
                    kernel = pexConfig.ConfigChoiceField(
                        doc = "kernel type",
                        typemap = dict(
                            AL = SnapPsfMatchConfigAL,
                            DF = SnapPsfMatchConfigDF
                        ),
                        default = "AL",
                    )
                
                    doWarping = pexConfig.Field(
                        dtype = bool,
                        doc   = "Warp the snaps?",
                        default = False
                    )
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#fdd998a1">fdd998a1</a> +     def setDefaults(self):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#fdd998a1">fdd998a1</a> +         ImagePsfMatchConfig.setDefaults(self)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#fdd998a1">fdd998a1</a> +         # No spatial variation in model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#fdd998a1">fdd998a1</a> +         self.kernel.active.spatialKernelOrder = 0</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#fdd998a1">fdd998a1</a> +         # Don't fit for differential background</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#fdd998a1">fdd998a1</a> +         self.kernel.active.fitForBackground = False</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#fdd998a1">fdd998a1</a> +         # Small kernel size</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#fdd998a1">fdd998a1</a> +         self.kernel.active.kernelSize = 7</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#fdd998a1">fdd998a1</a> +         # With zero spatial order don't worry about spatial clipping</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#fdd998a1">fdd998a1</a> +         self.kernel.active.spatialKernelClipping = False</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#fdd998a1">fdd998a1</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#fdd998a1">fdd998a1</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#fdd998a1">fdd998a1</a> + ## \page SnapPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#fdd998a1">fdd998a1</a> + ## \ref SnapPsfMatchTask_ "SnapPsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#fdd998a1">fdd998a1</a> + ## \copybrief SnapPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#fdd998a1">fdd998a1</a> + ## \}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#fdd998a1">fdd998a1</a> + </div>
                class SnapPsfMatchTask(ImagePsfMatchTask):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#fdd998a1">fdd998a1</a> +     """!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#fdd998a1">fdd998a1</a> + \anchor SnapPsfMatchTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#fdd998a1">fdd998a1</a> + \brief Image-based Psf-matching of two subsequent snaps from the same visit</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Contents Contents</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Purpose</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Initialize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_IO</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Config</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#fdd998a1">fdd998a1</a> +  - \ref ip_diffim_snappsfmatch_Example</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Purpose   Description</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#fdd998a1">fdd998a1</a> + \copybrief SnapPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#fdd998a1">fdd998a1</a> + This Task differs from ImagePsfMatchTask in that it matches two Exposures assuming that the images have</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#fdd998a1">fdd998a1</a> + been acquired very closely in time.  Under this assumption, the astrometric misalignments and/or</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#fdd998a1">fdd998a1</a> + relative distortions should be within a pixel, and the Psf-shapes should be very similar.  As a </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#fdd998a1">fdd998a1</a> + consequence, the default configurations for this class assume a very simple solution.  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#fdd998a1">fdd998a1</a> +  . The spatial variation in the kernel (SnapPsfMatchConfig.spatialKernelOrder) is assumed to be zero </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#fdd998a1">fdd998a1</a> +  . With no spatial variation, we turn of the spatial clipping loops (SnapPsfMatchConfig.spatialKernelClipping)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#fdd998a1">fdd998a1</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#fdd998a1">fdd998a1</a> +  . The differential background is _not_ fit for (SnapPsfMatchConfig.fitForBackground)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#fdd998a1">fdd998a1</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#fdd998a1">fdd998a1</a> +  . The kernel is expected to be appx. a delta function, and has a small size (SnapPsfMatchConfig.kernelSize)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#fdd998a1">fdd998a1</a> +  </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#fdd998a1">fdd998a1</a> + The sub-configurations for the Alard-Lupton (SnapPsfMatchConfigAL) and delta-function (SnapPsfMatchConfigDF)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#fdd998a1">fdd998a1</a> + bases also are designed to generate a small, simple kernel.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Initialize    Task initialization</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#fdd998a1">fdd998a1</a> + Initialization is the same as base class ImagePsfMatch.__init__, with the difference being that the Task's</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#fdd998a1">fdd998a1</a> + ConfigClass is SnapPsfMatchConfig.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_IO        Invoking the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#fdd998a1">fdd998a1</a> + The Task is only configured to have a subtractExposures method, which in turn calls </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#fdd998a1">fdd998a1</a> + ImagePsfMatchTask.subtractExposures.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Config       Configuration parameters</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#fdd998a1">fdd998a1</a> + See \ref SnapPsfMatchConfig, which uses either \ref SnapPsfMatchConfigDF and \ref SnapPsfMatchConfigAL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#fdd998a1">fdd998a1</a> + as its active configuration.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Metadata   Quantities set in Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#fdd998a1">fdd998a1</a> + See \ref ip_diffim_psfmatch_Metadata "PsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Debug     Debug variables</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#fdd998a1">fdd998a1</a> + The \link lsst.pipe.base.cmdLineTask.CmdLineTask command line task\endlink interface supports a</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#fdd998a1">fdd998a1</a> + flag \c -d/--debug to import \b debug.py from your \c PYTHONPATH.  The relevant contents of debug.py </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#fdd998a1">fdd998a1</a> + for this Task include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#fdd998a1">fdd998a1</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#fdd998a1">fdd998a1</a> +     import sys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#fdd998a1">fdd998a1</a> +     import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#fdd998a1">fdd998a1</a> +     def DebugInfo(name):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#fdd998a1">fdd998a1</a> +         di = lsstDebug.getInfo(name)   </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#fdd998a1">fdd998a1</a> +         if name == "lsst.ip.diffim.psfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#fdd998a1">fdd998a1</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#fdd998a1">fdd998a1</a> +             di.maskTransparency = 80          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#fdd998a1">fdd998a1</a> +             di.displayCandidates = True       # show all the candidates and residuals</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#fdd998a1">fdd998a1</a> +             di.displayKernelBasis = False     # show kernel basis functions</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#fdd998a1">fdd998a1</a> +             di.displayKernelMosaic = True     # show kernel realized across the image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#fdd998a1">fdd998a1</a> +             di.plotKernelSpatialModel = False # show coefficients of spatial model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#fdd998a1">fdd998a1</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#fdd998a1">fdd998a1</a> +         elif name == "lsst.ip.diffim.imagePsfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#fdd998a1">fdd998a1</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#fdd998a1">fdd998a1</a> +             di.maskTransparency = 30          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#fdd998a1">fdd998a1</a> +             di.displayTemplate = True         # show full (remapped) template</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#fdd998a1">fdd998a1</a> +             di.displaySciIm = True            # show science image to match to</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#fdd998a1">fdd998a1</a> +             di.displaySpatialCells = True     # show spatial cells</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#fdd998a1">fdd998a1</a> +             di.displayDiffIm = True           # show difference image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#fdd998a1">fdd998a1</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green) </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#fdd998a1">fdd998a1</a> +         elif name == "lsst.ip.diffim.diaCatalogSourceSelector":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#fdd998a1">fdd998a1</a> +             di.display = False                # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#fdd998a1">fdd998a1</a> +             di.maskTransparency = 30          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#fdd998a1">fdd998a1</a> +             di.displayExposure = True         # show exposure with candidates indicated</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#fdd998a1">fdd998a1</a> +             di.pauseAtEnd = False             # pause when done</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#fdd998a1">fdd998a1</a> +         return di</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#fdd998a1">fdd998a1</a> +     lsstDebug.Info = DebugInfo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#fdd998a1">fdd998a1</a> +     lsstDebug.frame = 1      </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#fdd998a1">fdd998a1</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#fdd998a1">fdd998a1</a> + Note that if you want addional logging info, you may add to your scripts:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#fdd998a1">fdd998a1</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#fdd998a1">fdd998a1</a> + import lsst.pex.logging as pexLog</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#fdd998a1">fdd998a1</a> + pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#fdd998a1">fdd998a1</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#fdd998a1">fdd998a1</a> + \section ip_diffim_snappsfmatch_Example   A complete example of using SnapPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#fdd998a1">fdd998a1</a> + This code is snapPsfMatchTask.py in the examples directory, and can be run as \em e.g.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#fdd998a1">fdd998a1</a> + \code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#fdd998a1">fdd998a1</a> + examples/snapPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#fdd998a1">fdd998a1</a> + examples/snapPsfMatchTask.py --debug </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#fdd998a1">fdd998a1</a> + examples/snapPsfMatchTask.py --debug --template /path/to/templateExp.fits --science /path/to/scienceExp.fits</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#fdd998a1">fdd998a1</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#fdd998a1">fdd998a1</a> + \dontinclude snapPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#fdd998a1">fdd998a1</a> + First, create a subclass of SnapPsfMatchTask that accepts two exposures.  Ideally these exposures would have </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#fdd998a1">fdd998a1</a> + been taken back-to-back, such that the pointing/background/Psf does not vary substantially between the two:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#fdd998a1">fdd998a1</a> + \skip MySnapPsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#fdd998a1">fdd998a1</a> + \until return</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#fdd998a1">fdd998a1</a> + And allow the user the freedom to either run the script in default mode, or point to their own images on disk.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#fdd998a1">fdd998a1</a> + Note that these images must be readable as an lsst.afw.image.Exposure:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#fdd998a1">fdd998a1</a> + \skip main</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#fdd998a1">fdd998a1</a> + \until parse_args</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#fdd998a1">fdd998a1</a> + We have enabled some minor display debugging in this script via the --debug option.  However, if you </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#fdd998a1">fdd998a1</a> + have an lsstDebug debug.py in your PYTHONPATH you will get additional debugging displays.  The following</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#fdd998a1">fdd998a1</a> + block checks for this script:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#fdd998a1">fdd998a1</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#fdd998a1">fdd998a1</a> + \until sys.stderr</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#fdd998a1">fdd998a1</a> + \dontinclude snapPsfMatchTask.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#fdd998a1">fdd998a1</a> + Finally, we call a run method that we define below.  First set up a Config and choose the basis set to use:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#fdd998a1">fdd998a1</a> + \skip run(args)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#fdd998a1">fdd998a1</a> + \until AL</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#fdd998a1">fdd998a1</a> + Make sure the images (if any) that were sent to the script exist on disk and are readable.  If no images</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#fdd998a1">fdd998a1</a> + are sent, make some fake data up for the sake of this example script (have a look at the code if you want</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#fdd998a1">fdd998a1</a> + more details on generateFakeImages; as a detail of how the fake images were made, you do have to fit for a </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#fdd998a1">fdd998a1</a> + differential background):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#fdd998a1">fdd998a1</a> + \skip requested</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#fdd998a1">fdd998a1</a> + \until sizeCellY</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#fdd998a1">fdd998a1</a> + Display the two images if --debug:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#fdd998a1">fdd998a1</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#fdd998a1">fdd998a1</a> + \until Science</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#fdd998a1">fdd998a1</a> + Create and run the Task:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#fdd998a1">fdd998a1</a> + \skip Create</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#fdd998a1">fdd998a1</a> + \until result</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#fdd998a1">fdd998a1</a> + And finally provide optional debugging display of the Psf-matched (via the Psf models) science image:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#fdd998a1">fdd998a1</a> + \skip args.debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#fdd998a1">fdd998a1</a> + \until result.subtractedExposure</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#fdd998a1">fdd998a1</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#fdd998a1">fdd998a1</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#fdd998a1">fdd998a1</a> +     """</div>
                    ConfigClass = SnapPsfMatchConfig
                
                    # Override ImagePsfMatchTask.subtractExposures to set doWarping on config.doWarping
                    def subtractExposures(self, templateExposure, scienceExposure,
                                          templateFwhmPix = None, scienceFwhmPix = None,
                                          candidateList = None):
                        return ImagePsfMatchTask.subtractExposures(self,
                            templateExposure = templateExposure,
                            scienceExposure = scienceExposure,
                            templateFwhmPix = templateFwhmPix,
                            scienceFwhmPix = scienceFwhmPix,
                            candidateList = candidateList,
                            doWarping = self.config.doWarping,
                        )
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="9a8b565a"/></a>9a8b565a</h3>

<pre>
commit 9a8b565a2257570cc7c685089f89b480a4911342
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 22 10:49:09 2012 -0800

    Config uses registries now.
</pre>
<h3><a name="cca1e80e"/></a>cca1e80e</h3>

<pre>
commit cca1e80e719df66265e1492d127e9661ac244a35
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 22 16:09:49 2013 -0700

    Initial round of fixes to based on Paul's W13 review.
</pre>
<h3><a name="a8fe2a5f"/></a>a8fe2a5f</h3>

<pre>
commit a8fe2a5f78304d89ed070235e491a44b95fcd627
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Mar 2 17:21:44 2012 -0600

    Nasty feature of pexConfig that requires derived classes to call setDefaults() of their parent class, unless that parent class is Config.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="fdd998a1"/></a>fdd998a1</h3>

<pre>
commit fdd998a1a8b77b50f23e9b39e03d2305e16b5221
Author: Andy Becker <acbecker@gmail.com>
Date:   Sun Aug 10 16:10:55 2014 -0700

    Documenting SnapPsfMatchTask
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_46"><a name="python/lsst/ip/diffim/utils.py"/></a>python/lsst/ip/diffim/utils.py</h1>

<h3 id="toc_47">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                """Support utilities for Measuring sources"""
                import numpy as np
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#6a7af963">6a7af963</a> - import lsst.pex.exceptions as pexExcept</div>
                import lsst.pex.logging as pexLog
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#6a7af963">6a7af963</a> - import lsst.daf.base as dafBase</div>
                import lsst.afw.detection as afwDet
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.table as afwTable
                import lsst.afw.display.ds9 as ds9
                import lsst.afw.display.utils as displayUtils
                import lsst.meas.algorithms as measAlg
                from . import diffimLib
                from . import diffimTools
                
                keptPlots = False                       # Have we arranged to keep spatial plots open?
                
                def showSourceSet(sSet, xy0=(0, 0), frame=0, ctype=ds9.GREEN, symb="+", size=2):
                    """Draw the (XAstrom, YAstrom) positions of a set of Sources.  Image has the given XY0"""
                
                    with ds9.Buffering():
                        for s in sSet:
                            xc, yc = s.getXAstrom() - xy0[0], s.getYAstrom() - xy0[1]
                
                            if symb == "id":
                                ds9.dot(str(s.getId()), xc, yc, frame=frame, ctype=ctype, size=size)
                            else:
                                ds9.dot(symb, xc, yc, frame=frame, ctype=ctype, size=size)
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                #
                # Kernel display utilities
                #
                def showKernelSpatialCells(maskedIm, kernelCellSet, showChi2=False, symb="o",
                                           ctype=None, ctypeUnused=None, ctypeBad=None, size=3,
                                           frame=None, title="Spatial Cells"):
                    """Show the SpatialCells.  If symb is something that ds9.dot
                    understands (e.g. "o"), the top nMaxPerCell candidates will be
                    indicated with that symbol, using ctype and size"""
                
                    ds9.mtv(maskedIm, frame=frame, title=title)
                    with ds9.Buffering():
                        origin = [-maskedIm.getX0(), -maskedIm.getY0()]
                        for cell in kernelCellSet.getCellList():
                            displayUtils.drawBBox(cell.getBBox(), origin=origin, frame=frame)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#6a7af963">6a7af963</a> -             i = 0</div>
                            goodies = ctypeBad is None
                            for cand in cell.begin(goodies):
                                cand = diffimLib.cast_KernelCandidateF(cand)
                                xc, yc = cand.getXCenter() + origin[0], cand.getYCenter() + origin[1]
                                if cand.getStatus() == afwMath.SpatialCellCandidate.BAD:
                                    color = ctypeBad
                                elif cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                    color = ctype
                                elif cand.getStatus() == afwMath.SpatialCellCandidate.UNKNOWN:
                                    color = ctypeUnused
                                else:
                                    continue
                
                                if color:
                                    ds9.dot(symb, xc, yc, frame=frame, ctype=color, size=size)
                
                                    if showChi2:
                                        rchi2 = cand.getChi2()
                                        if rchi2 > 1e100:
                                            rchi2 = np.nan
                                        ds9.dot("%d %.1f" % (cand.getId(), rchi2),
                                                xc - size, yc - size - 4, frame=frame, ctype=color, size=size)
                
                
                def showDiaSources(sources, exposure, isFlagged, isDipole, frame=None):
                    """Display Dia Sources
                    """
                    #
                    # Show us the ccandidates
                    #
                    # Too many mask planes in diffims
                    for plane in ("BAD", "CR", "EDGE", "INTERPOlATED", "INTRP", "SAT", "SATURATED"):
                        ds9.setMaskPlaneVisibility(plane, False)
                
                    mos = displayUtils.Mosaic()
                    for i in range(len(sources)):
                        source = sources[i]
                        badFlag = isFlagged[i]
                        dipoleFlag = isDipole[i]
                        bbox = source.getFootprint().getBBox()
                        stamp = exposure.Factory(exposure, bbox, True)
                        im = displayUtils.Mosaic(gutter=1, background=0, mode="x")
                        im.append(stamp.getMaskedImage())
                        lab = "%.1f,%.1f:" % (source.getX(), source.getY())
                        if badFlag:
                            ctype = ds9.RED
                            lab += "BAD"
                        if dipoleFlag:
                            ctype = ds9.YELLOW
                            lab += "DIPOLE"
                        if not badFlag and not dipoleFlag:
                            ctype = ds9.GREEN
                            lab += "OK"
                        mos.append(im.makeMosaic(), lab, ctype)
                        #print source.getId()
                    title = "Dia Sources"
                    mosaicImage = mos.makeMosaic(frame=frame, title=title)
                    return mosaicImage
                
                def showKernelCandidates(kernelCellSet, kernel, background, frame=None, showBadCandidates=True,
                                         resids=False, kernels=False):
                    """Display the Kernel candidates.
                    If kernel is provided include spatial model and residuals;  
                    If chi is True, generate a plot of residuals/sqrt(variance), i.e. chi
                    """
                
                    #
                    # Show us the ccandidates
                    #
                    if kernels:
                        mos = displayUtils.Mosaic(gutter=5, background=0)
                    else:
                        mos = displayUtils.Mosaic(gutter=5, background=-1)
                    #
                    candidateCenters = []
                    candidateCentersBad = []
                    candidateIndex = 0
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(False): # include bad candidates
                            cand = diffimLib.cast_KernelCandidateF(cand)
                
                            # Original difference image; if does not exist, skip candidate
                            try:
                                resid = cand.getDifferenceImage(diffimLib.KernelCandidateF.ORIG)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#efdc8e9c">efdc8e9c</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                continue
                
                            rchi2 = cand.getChi2()
                            if rchi2 > 1e100:
                                rchi2 = np.nan
                
                            if not showBadCandidates and cand.isBad():
                                continue
                
                            im_resid = displayUtils.Mosaic(gutter=1, background=-0.5, mode="x")
                
                            try:
                                im = cand.getScienceMaskedImage()
                                im = im.Factory(im, True)
                                im.setXY0(cand.getScienceMaskedImage().getXY0())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#dbc5a8d2">dbc5a8d2</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                continue
                            if (not resids and not kernels):
                                im_resid.append(im.Factory(im, True))
                            try:
                                im = cand.getTemplateMaskedImage()
                                im = im.Factory(im, True)
                                im.setXY0(cand.getTemplateMaskedImage().getXY0())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#dbc5a8d2">dbc5a8d2</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                continue
                            if (not resids and not kernels):
                                im_resid.append(im.Factory(im, True))
                
                            # Difference image with original basis
                            if resids:
                                var = resid.getVariance()
                                var = var.Factory(var, True)
                                np.sqrt(var.getArray(), var.getArray()) # inplace sqrt
                                resid = resid.getImage()
                                resid /= var
                                bbox = kernel.shrinkBBox(resid.getBBox())
                                resid = resid.Factory(resid, bbox, True)
                            elif kernels:
                                kim = cand.getKernelImage(diffimLib.KernelCandidateF.ORIG).convertF()
                                resid = kim.Factory(kim, True)
                            im_resid.append(resid)
                
                            # residuals using spatial model
                            ski  = afwImage.ImageD(kernel.getDimensions())
                            kernel.computeImage(ski, False, int(cand.getXCenter()), int(cand.getYCenter()))
                            sk   = afwMath.FixedKernel(ski)
                            sbg  = 0.0
                            if background:
                                sbg = background(int(cand.getXCenter()), int(cand.getYCenter()))
                            sresid = cand.getDifferenceImage(sk, sbg)
                            resid  = sresid
                            if resids:
                                resid = sresid.getImage()
                                resid /= var
                                bbox = kernel.shrinkBBox(resid.getBBox())
                                resid = resid.Factory(resid, bbox, True)
                            elif kernels:
                                kim = ski.convertF()
                                resid = kim.Factory(kim, True)
                            im_resid.append(resid)
                
                            im = im_resid.makeMosaic()
                
                            lab = "%d chi^2 %.1f" % (cand.getId(), rchi2)
                            ctype = ds9.RED if cand.isBad() else ds9.GREEN
                
                            mos.append(im, lab, ctype)
                
                            if False and np.isnan(rchi2):
                                ds9.mtv(cand.getScienceMaskedImage.getImage(), title="candidate", frame=1)
                                print "rating",  cand.getCandidateRating()
                
                            im = cand.getScienceMaskedImage()
                            center = (candidateIndex, cand.getXCenter() - im.getX0(), cand.getYCenter() - im.getY0())
                            candidateIndex += 1
                            if cand.isBad():
                                candidateCentersBad.append(center)
                            else:
                                candidateCenters.append(center)
                
                    if resids:
                        title = "chi Diffim"
                    elif kernels:
                        title = "Kernels"
                    else:
                        title = "Candidates & residuals"
                    mosaicImage = mos.makeMosaic(frame=frame, title=title)
                
                    return mosaicImage
                
                def showKernelBasis(kernel, frame=None):
                    """Display a Kernel's basis images
                    """
                    mos = displayUtils.Mosaic()
                
                    for k in kernel.getKernelList():
                        im = afwImage.ImageD(k.getDimensions())
                        k.computeImage(im, False)
                        mos.append(im)
                    mos.makeMosaic(frame=frame, title="Kernel Basis Images")
                
                    return mos
                
                ###############
                
                def plotKernelSpatialModel(kernel, kernelCellSet, showBadCandidates=True, 
                                           numSample=128, keepPlots=True, maxCoeff = 10):
                    """Plot the Kernel spatial model."""
                
                    try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#dbc5a8d2">dbc5a8d2</a> -         import numpy as num</div>
                        import matplotlib.pyplot as plt
                        import matplotlib.colors
                    except ImportError, e:
                        print "Unable to import numpy and matplotlib: %s" % e
                        return
                
                    x0 = kernelCellSet.getBBox().getBeginX()
                    y0 = kernelCellSet.getBBox().getBeginY()
                
                    candPos = list()
                    candFits = list()
                    badPos = list()
                    badFits = list()
                    candAmps = list()
                    badAmps = list()
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(False):
                            cand = diffimLib.cast_KernelCandidateF(cand)
                            if not showBadCandidates and cand.isBad():
                                continue
                            candCenter = afwGeom.PointD(cand.getXCenter(), cand.getYCenter())
                            try:
                                im = cand.getTemplateMaskedImage()
                            except Exception, e:
                                continue
                
                            targetFits = badFits if cand.isBad() else candFits
                            targetPos = badPos if cand.isBad() else candPos
                            targetAmps = badAmps if cand.isBad() else candAmps
                
                            # compare original and spatial kernel coefficients
                            kp0 = np.array(cand.getKernel(diffimLib.KernelCandidateF.ORIG).getKernelParameters())
                            amp = cand.getCandidateRating()
                
                            targetFits = badFits if cand.isBad() else candFits
                            targetPos = badPos if cand.isBad() else candPos
                            targetAmps = badAmps if cand.isBad() else candAmps
                
                            targetFits.append(kp0)
                            targetPos.append(candCenter)
                            targetAmps.append(amp)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#6a7af963">6a7af963</a> -     numCandidates = len(candFits)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#dbc5a8d2">dbc5a8d2</a> -     numBasisFuncs = kernel.getNBasisKernels()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#6a7af963">6a7af963</a> - </div>
                    xGood = np.array([pos.getX() for pos in candPos]) - x0
                    yGood = np.array([pos.getY() for pos in candPos]) - y0
                    zGood = np.array(candFits)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#6c88a9ee">6c88a9ee</a> -     ampGood = np.array(candAmps)</div>
                
                    xBad = np.array([pos.getX() for pos in badPos]) - x0
                    yBad = np.array([pos.getY() for pos in badPos]) - y0
                    zBad = np.array(badFits)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#6c88a9ee">6c88a9ee</a> -     ampBad = np.array(badAmps)</div>
                    numBad = len(badPos)
                
                    xRange = np.linspace(0, kernelCellSet.getBBox().getWidth(), num=numSample)
                    yRange = np.linspace(0, kernelCellSet.getBBox().getHeight(), num=numSample)
                
                    if maxCoeff:
                        maxCoeff = min(maxCoeff, kernel.getNKernelParameters())
                    else:
                        maxCoeff = kernel.getNKernelParameters()
                
                    for k in range(maxCoeff):
                        func = kernel.getSpatialFunction(k)
                        dfGood = zGood[:,k] - np.array([func(pos.getX(), pos.getY()) for pos in candPos])
                        yMin = dfGood.min()
                        yMax = dfGood.max()
                        if numBad > 0:
                            dfBad = zBad[:,k] - np.array([func(pos.getX(), pos.getY()) for pos in badPos])
                            # Can really screw up the range...
                            yMin = min([yMin, dfBad.min()])
                            yMax = max([yMax, dfBad.max()])
                        yMin -= 0.05 * (yMax - yMin)
                        yMax += 0.05 * (yMax - yMin)
                
                        fRange = np.ndarray((len(xRange), len(yRange)))
                        for j, yVal in enumerate(yRange):
                            for i, xVal in enumerate(xRange):
                                fRange[j][i] = func(xVal, yVal)
                
                        fig = plt.figure(k)
                
                        fig.clf()
                        try:
                            fig.canvas._tkcanvas._root().lift() # == Tk's raise, but raise is a python reserved word
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
354  <a href="#6a7af963">6a7af963</a> -         except:                                 # protect against API changes</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
345  <a href="#966eaa96">966eaa96</a> +         except Exception:                                 # protect against API changes</div>
              ?               ++++++++++
                            pass
                
                        fig.suptitle('Kernel component %d' % k)
                
                        # LL
                        ax = fig.add_axes((0.1, 0.05, 0.35, 0.35))
                        vmin = fRange.min() # - 0.05 * np.fabs(fRange.min())
                        vmax = fRange.max() # + 0.05 * np.fabs(fRange.max())
                        norm = matplotlib.colors.Normalize(vmin=vmin, vmax=vmax)
                        im = ax.imshow(fRange, aspect='auto', norm=norm,
                                       extent=[0, kernelCellSet.getBBox().getWidth()-1,
                                               0, kernelCellSet.getBBox().getHeight()-1])
                        ax.set_title('Spatial polynomial')
                        plt.colorbar(im, orientation='horizontal', ticks=[vmin, vmax])
                
                        # UL
                        ax = fig.add_axes((0.1, 0.55, 0.35, 0.35))
                        ax.plot(-2.5*np.log10(candAmps), zGood[:,k], 'b+')
                        if numBad > 0:
                            ax.plot(-2.5*np.log10(badAmps), zBad[:,k], 'r+')
                        ax.set_title("Basis Coefficients")
                        ax.set_xlabel("Instr mag")
                        ax.set_ylabel("Coeff")
                
                        # LR
                        ax = fig.add_axes((0.55, 0.05, 0.35, 0.35))
                        ax.set_autoscale_on(False)
                        ax.set_xbound(lower=0, upper=kernelCellSet.getBBox().getHeight())
                        ax.set_ybound(lower=yMin, upper=yMax)
                        ax.plot(yGood, dfGood, 'b+')
                        if numBad > 0:
                            ax.plot(yBad, dfBad, 'r+')
                        ax.axhline(0.0)
                        ax.set_title('dCoeff (indiv-spatial) vs. y')
                
                        # UR
                        ax = fig.add_axes((0.55, 0.55, 0.35, 0.35))
                        ax.set_autoscale_on(False)
                        ax.set_xbound(lower=0, upper=kernelCellSet.getBBox().getWidth())
                        ax.set_ybound(lower=yMin, upper=yMax)
                        ax.plot(xGood, dfGood, 'b+')
                        if numBad > 0:
                            ax.plot(xBad, dfBad, 'r+')
                        ax.axhline(0.0)
                        ax.set_title('dCoeff (indiv-spatial) vs. x')
                
                        fig.show()
                
                    global keptPlots
                    if keepPlots and not keptPlots:
                        # Keep plots open when done
                        def show():
                            print "%s: Please close plots when done." % __name__
                            try:
                                plt.show()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#6a7af963">6a7af963</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
401  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                pass
                            print "Plots closed, exiting..."
                        import atexit
                        atexit.register(show)
                        keptPlots = True
                
                
                def showKernelMosaic(bbox, kernel, nx=7, ny=None, frame=None, title=None, 
                                     showCenter=True, showEllipticity=True):
                    """Show a mosaic of Kernel images.
                    """
                    mos = displayUtils.Mosaic()
                
                    x0 = bbox.getBeginX()
                    y0 = bbox.getBeginY()
                    width = bbox.getWidth()
                    height = bbox.getHeight()
                
                    if not ny:
                        ny = int(nx*float(height)/width + 0.5)
                        if not ny:
                            ny = 1
                
                    schema = afwTable.SourceTable.makeMinimalSchema()
                    control = measAlg.GaussianCentroidControl()
                    centroider = measAlg.MeasureSourcesBuilder().addAlgorithm(control).build(schema)
                    sdssShape = measAlg.SdssShapeControl()
                    shaper = measAlg.MeasureSourcesBuilder().addAlgorithm(sdssShape).build(schema)
                    table = afwTable.SourceTable.make(schema)
                    table.defineCentroid(control.name)
                    table.defineShape(sdssShape.name)
                
                    centers = []
                    shapes = []
                    for iy in range(ny):
                        for ix in range(nx):
                            x = int(ix*(width-1)/(nx-1)) + x0
                            y = int(iy*(height-1)/(ny-1)) + y0
                
                            im = afwImage.ImageD(kernel.getDimensions())
                            ksum = kernel.computeImage(im, False, x, y)
                            lab = "Kernel(%d,%d)=%.2f" % (x, y, ksum) if False else ""
                            mos.append(im, lab)
                
                            exp = afwImage.makeExposure(afwImage.makeMaskedImage(im))
                            w, h = im.getWidth(), im.getHeight()
                            cen = afwGeom.PointD(w//2, h//2)
                            src = table.makeRecord()
                            foot = afwDet.Footprint(exp.getBBox())
                            src.setFootprint(foot)
                
                            centroider.apply(src, exp, cen)
                            centers.append((src.getX(), src.getY()))
                
                            shaper.apply(src, exp, cen)
                            shapes.append((src.getIxx(), src.getIxy(), src.getIyy()))
                
                    mos.makeMosaic(frame=frame, title=title if title else "Model Kernel", mode=nx)
                
                    if centers and frame is not None:
                        i = 0
                        with ds9.Buffering():
                            for cen, shape in zip(centers, shapes):
                                bbox = mos.getBBox(i); i += 1
                                xc, yc = cen[0] + bbox.getMinX(),  cen[1] + bbox.getMinY()
                                if showCenter:
                                    ds9.dot("+", xc, yc,  ctype=ds9.BLUE, frame=frame)
                
                                if showEllipticity:
                                    ixx, ixy, iyy = shape
                                    ds9.dot("@:%g,%g,%g" % (ixx, ixy, iyy), xc, yc, frame=frame, ctype=ds9.RED)
                
                    return mos
                
                def plotPixelResiduals(exposure, warpedTemplateExposure, diffExposure, kernelCellSet,
                                       kernel, background, testSources, config,
                                       origVariance = False, nptsFull = 1e6, keepPlots = True, titleFs=14):
                    """Plot diffim residuals for LOCAL and SPATIAL models"""
                    candidateResids = []
                    spatialResids   = []
                    nonfitResids    = []
                
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(True): # only look at good ones
                            # Be sure
                            if not (cand.getStatus() == afwMath.SpatialCellCandidate.GOOD):
                                continue
                
                            cand    = diffimLib.cast_KernelCandidateF(cand)
                            diffim  = cand.getDifferenceImage(diffimLib.KernelCandidateF.ORIG)
                            orig    = cand.getScienceMaskedImage()
                
                            ski     = afwImage.ImageD(kernel.getDimensions())
                            kernel.computeImage(ski, False, int(cand.getXCenter()), int(cand.getYCenter()))
                            sk      = afwMath.FixedKernel(ski)
                            sbg     = background(int(cand.getXCenter()), int(cand.getYCenter()))
                            sdiffim = cand.getDifferenceImage(sk, sbg)
                
                            # trim edgs due to convolution
                            bbox    = kernel.shrinkBBox(diffim.getBBox())
                            tdiffim  = diffim.Factory(diffim, bbox)
                            torig    = orig.Factory(orig, bbox)
                            tsdiffim = sdiffim.Factory(sdiffim, bbox)
                
                            if origVariance:
                                candidateResids.append(np.ravel(tdiffim.getImage().getArray() /
                                                                np.sqrt(torig.getVariance().getArray())))
                                spatialResids.append(np.ravel(tsdiffim.getImage().getArray() /
                                                              np.sqrt(torig.getVariance().getArray())))
                            else:
                                candidateResids.append(np.ravel(tdiffim.getImage().getArray() /
                                                                np.sqrt(tdiffim.getVariance().getArray())))
                                spatialResids.append(np.ravel(tsdiffim.getImage().getArray() /
                                                              np.sqrt(tsdiffim.getVariance().getArray())))
                
                    fullIm   = diffExposure.getMaskedImage().getImage().getArray()
                    fullMask = diffExposure.getMaskedImage().getMask().getArray()
                    if origVariance:
                        fullVar  = exposure.getMaskedImage().getVariance().getArray()
                    else:
                        fullVar  = diffExposure.getMaskedImage().getVariance().getArray()
                
                    bitmaskBad  = 0
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
534  <a href="#11ed452e">11ed452e</a> -     bitmaskBad |= afwImage.MaskU.getPlaneBitMask('NO_DATA')</div>
              ?                                                   ^^^ ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
525  <a href="#7054ff7a">7054ff7a</a> +     bitmaskBad |= afwImage.MaskU.getPlaneBitMask('EDGE')</div>
              ?                                                   ^ ^^
                    bitmaskBad |= afwImage.MaskU.getPlaneBitMask('SAT')
                    idx = np.where((fullMask & bitmaskBad) == 0)
                    stride = int(len(idx[0]) // nptsFull)
                    sidx = idx[0][::stride], idx[1][::stride]
                    allResids = fullIm[sidx] / np.sqrt(fullVar[sidx])
                
                    testFootprints = diffimTools.sourceToFootprintList(testSources, warpedTemplateExposure, 
                                                                       exposure, config, pexLog.getDefaultLog())
                    for fp in testFootprints:
                        subexp = diffExposure.Factory(diffExposure, fp["footprint"].getBBox())
                        subim  = subexp.getMaskedImage().getImage()
                        if origVariance:
                            subvar = afwImage.ExposureF(exposure, fp["footprint"].getBBox()).getMaskedImage().getVariance()
                        else:
                            subvar = subexp.getMaskedImage().getVariance()
                        nonfitResids.append(np.ravel(subim.getArray() / np.sqrt(subvar.getArray())))
                
                    candidateResids = np.ravel(np.array(candidateResids))
                    spatialResids   = np.ravel(np.array(spatialResids))
                    nonfitResids    = np.ravel(np.array(nonfitResids))
                
                    try:
                        import pylab
                        from matplotlib.font_manager import FontProperties
                    except ImportError, e:
                        print "Unable to import pylab: %s" % e
                        return
                
                    fig = pylab.figure()
                    fig.clf()
                    try:
                        fig.canvas._tkcanvas._root().lift() # == Tk's raise, but raise is a python reserved word
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
567  <a href="#7054ff7a">7054ff7a</a> -     except:                                 # protect against API changes</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
558  <a href="#966eaa96">966eaa96</a> +     except Exception:                                 # protect against API changes</div>
              ?           ++++++++++
                        pass
                    if origVariance:
                        fig.suptitle("Diffim residuals: Normalized by sqrt(input variance)", fontsize=titleFs)
                    else:
                        fig.suptitle("Diffim residuals: Normalized by sqrt(diffim variance)", fontsize=titleFs)
                
                    sp1 = pylab.subplot(221)
                    sp2 = pylab.subplot(222, sharex=sp1, sharey=sp1)
                    sp3 = pylab.subplot(223, sharex=sp1, sharey=sp1)
                    sp4 = pylab.subplot(224, sharex=sp1, sharey=sp1)
                    xs  = np.arange(-5, 5.05, 0.1)
                    ys  = 1. / np.sqrt(2 * np.pi) * np.exp( -0.5 * xs**2 )
                
                    sp1.hist(candidateResids, bins=xs, normed=True, alpha=0.5, label="N(%.2f, %.2f)"
                             % (np.mean(candidateResids), np.var(candidateResids)))
                    sp1.plot(xs, ys, "r-", lw=2, label="N(0,1)")
                    sp1.set_title("Candidates: basis fit", fontsize=titleFs-2)
                    sp1.legend(loc=1, fancybox=True, shadow=True, prop = FontProperties(size=titleFs-6))
                
                    sp2.hist(spatialResids, bins=xs, normed=True, alpha=0.5, label="N(%.2f, %.2f)"
                             % (np.mean(spatialResids), np.var(spatialResids)))
                    sp2.plot(xs, ys, "r-", lw=2, label="N(0,1)")
                    sp2.set_title("Candidates: spatial fit", fontsize=titleFs-2)
                    sp2.legend(loc=1, fancybox=True, shadow=True, prop = FontProperties(size=titleFs-6))
                
                    sp3.hist(nonfitResids, bins=xs, normed=True, alpha=0.5, label="N(%.2f, %.2f)"
                             % (np.mean(nonfitResids), np.var(nonfitResids)))
                    sp3.plot(xs, ys, "r-", lw=2, label="N(0,1)")
                    sp3.set_title("Control sample: spatial fit", fontsize=titleFs-2)
                    sp3.legend(loc=1, fancybox=True, shadow=True, prop = FontProperties(size=titleFs-6))
                
                    sp4.hist(allResids, bins=xs, normed=True, alpha=0.5, label="N(%.2f, %.2f)"
                             % (np.mean(allResids), np.var(allResids)))
                    sp4.plot(xs, ys, "r-", lw=2, label="N(0,1)")
                    sp4.set_title("Full image (subsampled)", fontsize=titleFs-2)
                    sp4.legend(loc=1, fancybox=True, shadow=True, prop = FontProperties(size=titleFs-6))
                
                    pylab.setp(sp1.get_xticklabels()+sp1.get_yticklabels(), fontsize=titleFs-4)
                    pylab.setp(sp2.get_xticklabels()+sp2.get_yticklabels(), fontsize=titleFs-4)
                    pylab.setp(sp3.get_xticklabels()+sp3.get_yticklabels(), fontsize=titleFs-4)
                    pylab.setp(sp4.get_xticklabels()+sp4.get_yticklabels(), fontsize=titleFs-4)
                
                    sp1.set_xlim(-5, 5)
                    sp1.set_ylim(0, 0.5)
                    fig.show()
                
                    global keptPlots
                    if keepPlots and not keptPlots:
                        # Keep plots open when done
                        def show():
                            print "%s: Please close plots when done." % __name__
                            try:
                                pylab.show()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
621  <a href="#7054ff7a">7054ff7a</a> -             except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
612  <a href="#966eaa96">966eaa96</a> +             except Exception:</div>
              ?                   ++++++++++
                                pass
                            print "Plots closed, exiting..."
                        import atexit
                        atexit.register(show)
                        keptPlots = True
                
                def calcCentroid(arr):
                    """Calculate first moment of a (kernel) image"""
                    y, x = arr.shape
                    sarr = arr*arr
                    xarr = np.asarray([[el for el in range(x)] for el2 in range(y)])
                    yarr = np.asarray([[el2 for el in range(x)] for el2 in range(y)])
                    narr = xarr*sarr
                    sarrSum = sarr.sum()
                    centx = narr.sum()/sarrSum
                    narr = yarr*sarr
                    centy = narr.sum()/sarrSum
                    return centx, centy
                
                def calcWidth(arr, centx, centy):
                    """Calculate second moment of a (kernel) image"""
                    y, x = arr.shape
                    #Square the flux so we don't have to deal with negatives
                    sarr = arr*arr
                    xarr = np.asarray([[el for el in range(x)] for el2 in range(y)])
                    yarr = np.asarray([[el2 for el in range(x)] for el2 in range(y)])
                    narr = sarr*np.power((xarr - centx), 2.)
                    sarrSum = sarr.sum()
                    xstd = np.sqrt(narr.sum()/sarrSum)
                    narr = sarr*np.power((yarr - centy), 2.)
                    ystd = np.sqrt(narr.sum()/sarrSum)
                    return xstd, ystd
                
                def printSkyDiffs(sources, wcs):
                    """Print differences in sky coordinates between source Position and its Centroid mapped through Wcs"""
                    for s in sources:
                        sCentroid = s.getCentroid()
                        sPosition = s.getCoord().getPosition()
                        dra = 3600*(sPosition.getX() - wcs.pixelToSky(sCentroid.getX(),
                                                                      sCentroid.getY()).getPosition().getX())/0.2
                        ddec = 3600*(sPosition.getY() - wcs.pixelToSky(sCentroid.getX(),
                                                                       sCentroid.getY()).getPosition().getY())/0.2
                        if np.isfinite(dra) and np.isfinite(ddec):
                            print dra, ddec
                
                def makeRegions(sources, outfilename, wcs=None):
                    """Create regions file for ds9 from input source list"""
                    fh = open(outfilename, "w")
                    fh.write("global color=red font=\"helvetica 10 normal\" select=1 highlite=1 edit=1 move=1 delete=1 include=1 fixed=0 source\nfk5\n")
                    for s in sources:
                        if wcs:
                            (ra, dec) = wcs.pixelToSky(s.getCentroid().getX(), s.getCentroid().getY()).getPosition()
                        else:
                            (ra, dec) = s.getCoord().getPosition()
                        if np.isfinite(ra) and np.isfinite(dec):
                            fh.write("circle(%f,%f,2\")\n"%(ra,dec))
                    fh.flush()
                    fh.close()
                
                def showSourceSetSky(sSet, wcs, xy0, frame=0, ctype=ds9.GREEN, symb="+", size=2):
                    """Draw the (RA, Dec) positions of a set of Sources. Image has the XY0."""
                    with ds9.Buffering():
                        for s in sSet:
                            (xc, yc) = wcs.skyToPixel(s.getCoord().getRa(), s.getCoord().getDec())
                            xc -= xy0[0]
                            yc -= xy0[1]
                            ds9.dot(symb, xc, yc, frame=frame, ctype=ctype, size=size)
                
                def plotWhisker(results, newWcs):
                    """Plot whisker diagram of astromeric offsets between results.matches"""
                    refCoordKey = results.matches[0].first.getTable().getCoordKey()
                    inCentroidKey = results.matches[0].second.getTable().getCentroidKey()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
694  <a href="#8d937697">8d937697</a> -     sids      = [m.first.getId() for m in results.matches]</div>
                    positions = [m.first.get(refCoordKey) for m in results.matches]
                    residuals = [m.first.get(refCoordKey).getOffsetFrom(
                                       newWcs.pixelToSky(m.second.get(inCentroidKey))) for
                                       m in results.matches]
                    import matplotlib.pyplot as plt
                    fig = plt.figure()
                    sp = fig.add_subplot(1, 1, 0)
                    xpos = [x[0].asDegrees() for x in positions]
                    ypos = [x[1].asDegrees() for x in positions]
                    xpos.append(0.02*(max(xpos) - min(xpos)) + min(xpos))
                    ypos.append(0.98*(max(ypos) - min(ypos)) + min(ypos))
                    xidxs = np.isfinite(xpos)
                    yidxs = np.isfinite(ypos)
                    X = np.asarray(xpos)[xidxs]
                    Y = np.asarray(ypos)[yidxs]
                    distance = [x[1].asArcseconds() for x in residuals]
                    distance.append(0.2)
                    distance = np.asarray(distance)[xidxs]
                    #NOTE: This assumes that the bearing is measured positive from +RA through North.
                    #From the documentation this is not clear.
                    bearing = [x[0].asRadians() for x in residuals]
                    bearing.append(0)
                    bearing = np.asarray(bearing)[xidxs]
                    U = (distance*np.cos(bearing))
                    V = (distance*np.sin(bearing))
                    sp.quiver(X, Y, U, V)
                    sp.set_title("WCS Residual")
                    plt.show()
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="8d937697"/></a>8d937697</h3>

<pre>
commit 8d93769718362553b4af5c28d34122863b587409
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Tue Feb 26 13:26:25 2013 -0800

    Mostly changes to utils for metrics and debugging
</pre>
<h3><a name="6c88a9ee"/></a>6c88a9ee</h3>

<pre>
commit 6c88a9ee2149837eb78719e897d4dce10dbc1daa
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 13 16:51:49 2013 -0800

    Added KernelCandidateQa aggregate method that updates the task metadata with summary statistics.  #2636
</pre>
<h3><a name="11ed452e"/></a>11ed452e</h3>

<pre>
commit 11ed452e41a541f79f5ddb941d163affb60b717d
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri May 23 14:52:38 2014 -0400

    Adapt to new mask bit NO_DATA replacing EDGE (DM-669)
    
    NO_DATA means a warp/coadd pixel doesn't map to a CCD.
    EDGE means a pixel is near the edge and couldn't be searched
    for sources.
</pre>
<h3><a name="dbc5a8d2"/></a>dbc5a8d2</h3>

<pre>
commit dbc5a8d21b36979df85b0bfc4b595483d0935b27
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 2 20:42:59 2012 -0500

    Updated the debugging hooks extensively.
</pre>
<h3><a name="efdc8e9c"/></a>efdc8e9c</h3>

<pre>
commit efdc8e9cbaef76b6886f71784d70157225ad6a94
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Jan 28 14:41:29 2013 -0800

    Minor debugging exit for bad kernelcandidates
</pre>
<h3><a name="6a7af963"/></a>6a7af963</h3>

<pre>
commit 6a7af9639541236610eb7de61c2cf71846a3fcc8
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 2 12:15:54 2012 -0500

    Copying utils from meas_alg; need to specialize for ip_diffim.
</pre>
<h3><a name="7054ff7a"/></a>7054ff7a</h3>

<pre>
commit 7054ff7a2548cbd2165c38b8eb7cc1456685802a
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 3 13:50:58 2012 -0500

    Enabling debugging plots showing the resids in the diffims.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
<h3><a name="7054ff7a"/></a>7054ff7a</h3>

<pre>
commit 7054ff7a2548cbd2165c38b8eb7cc1456685802a
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 3 13:50:58 2012 -0500

    Enabling debugging plots showing the resids in the diffims.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_48"><a name="tests/FindSetBits.py"/></a>tests/FindSetBits.py</h1>

<h3 id="toc_49">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#6ec2c185">6ec2c185</a> - import os</div>
                
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#6ec2c185">6ec2c185</a> - import eups</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#6ec2c185">6ec2c185</a> - import lsst.afw.detection as afwDetection</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as logging
                
                verbosity = 1
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        pass
                        
                    def tearDown(self):
                        pass
                
                    def testNoMask(self):
                        mask = afwImage.MaskU(afwGeom.Extent2I(20, 20))
                        mask.set(0)
                        fsb  = ipDiffim.FindSetBitsU()
                
                        bbox = afwGeom.Box2I(afwGeom.Point2I(0, 10),
                                             afwGeom.Point2I(9, 12))
                        fsb.apply(afwImage.MaskU(mask, bbox, afwImage.LOCAL))
                
                        self.assertEqual(fsb.getBits(), 0)
                
                    def testOneMask(self):
                        mask = afwImage.MaskU(afwGeom.Extent2I(20, 20))
                        mask.set(0)
                        bitmaskBad = mask.getPlaneBitMask('BAD')
                        fsb = ipDiffim.FindSetBitsU()
                
                        bbox     = afwGeom.Box2I(afwGeom.Point2I(9, 10),
                                                 afwGeom.Point2I(11, 12))
                        submask  = afwImage.MaskU(mask, bbox, afwImage.LOCAL)
                        submask |= bitmaskBad
                
                        bbox2    = afwGeom.Box2I(afwGeom.Point2I(8, 8),
                                                 afwGeom.Point2I(19, 19))
                        fsb.apply(afwImage.MaskU(mask, bbox2, afwImage.LOCAL))
                
                        self.assertEqual(fsb.getBits(), bitmaskBad)
                
                    def testManyMask(self):
                        mask = afwImage.MaskU(afwGeom.Extent2I(20, 20))
                        mask.set(0)
                        bitmaskBad = mask.getPlaneBitMask('BAD')
                        bitmaskSat = mask.getPlaneBitMask('SAT')
                        fsb = ipDiffim.FindSetBitsU()
                
                        bbox      = afwGeom.Box2I(afwGeom.Point2I(9, 10),
                                                  afwGeom.Point2I(11, 12))
                        submask   = afwImage.MaskU(mask, bbox, afwImage.LOCAL)
                        submask  |= bitmaskBad
                
                        bbox2     = afwGeom.Box2I(afwGeom.Point2I(8, 8),
                                                  afwGeom.Point2I(19, 19))
                        submask2  = afwImage.MaskU(mask, bbox2, afwImage.LOCAL)
                        submask2 |= bitmaskSat
                
                        bbox3     = afwGeom.Box2I(afwGeom.Point2I(0, 0),
                                                  afwGeom.Point2I(19, 19))
                        fsb.apply(afwImage.MaskU(mask, bbox3, afwImage.LOCAL))
                
                        self.assertEqual(fsb.getBits(), bitmaskBad | bitmaskSat)
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6ec2c185"/></a>6ec2c185</h3>

<pre>
commit 6ec2c185f694175d08be9b3649a3a226bd75f95f
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Mar 10 23:34:10 2009 +0000

    Working on unit test code; incomplete.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_50"><a name="python/lsst/ip/diffim/diaCatalogSourceSelector.py"/></a>python/lsst/ip/diffim/diaCatalogSourceSelector.py</h1>

<h3 id="toc_51">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import numpy as np
                import lsst.pex.config as pexConfig
                import lsst.afw.display.ds9 as ds9
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#7e2a022d">7e2a022d</a> - import lsst.afw.math as afwMath</div>
                import lsst.meas.algorithms as measAlg
                import lsst.pex.logging as pexLog
                
                class DiaCatalogSourceSelectorConfig(pexConfig.Config):
                    # Selection cuts on the input source catalog
                    fluxLim = pexConfig.Field(
                        doc = "specify the minimum psfFlux for good Kernel Candidates",
                        dtype = float,
                        default = 0.0,
                        check = lambda x: x >= 0.0,
                    )
                    fluxMax = pexConfig.Field(
                        doc = "specify the maximum psfFlux for good Kernel Candidates (ignored if == 0)",
                        dtype = float,
                        default = 0.0,
                        check = lambda x: x >= 0.0,
                    )
                    badPixelFlags = pexConfig.ListField(
                        doc = "Kernel candidate objects may not have any of these bits set",
                        dtype = str,
                        default = ["flags.pixel.edge", "flags.pixel.interpolated.center", "flags.pixel.saturated.center", "flags.badcentroid"],
                        )
                    # Selection cuts on the reference catalog
                    selectStar = pexConfig.Field(
                        doc = "Select objects that are flagged as stars",
                        dtype = bool,
                        default = True
                    )
                    selectGalaxy = pexConfig.Field(
                        doc = "Select objects that are flagged as galaxies",
                        dtype = bool,
                        default = False
                    )
                    includeVariable = pexConfig.Field(
                        doc = "Include objects that are known to be variable",
                        dtype = bool,
                        default = False
                    )
                    grMin = pexConfig.Field(
                        doc = "Minimum g-r color for selection (inclusive)",
                        dtype = float,
                        default = 0.0
                    )
                    grMax = pexConfig.Field(
                        doc = "Maximum g-r color for selection (inclusive)",
                        dtype = float,
                        default = 3.0
                    )
                
                class CheckSource(object):
                    """A functor to check whether a source has any flags set that should cause it to be labeled bad."""
                
                    def __init__(self, table, fluxLim, fluxMax, badPixelFlags):
                        self.keys = [table.getSchema().find(name).key for name in badPixelFlags]
                        self.fluxLim = fluxLim
                        self.fluxMax = fluxMax
                
                    def __call__(self, source):
                        for k in self.keys:
                            if source.get(k):
                                return False
                        if self.fluxLim != None and source.getPsfFlux() < self.fluxLim: # ignore faint objects
                            return False
                        if self.fluxMax != 0.0 and source.getPsfFlux() > self.fluxMax: # ignore bright objects
                            return False
                        return True
                
                class DiaCatalogSourceSelector(object):
                    ConfigClass = DiaCatalogSourceSelectorConfig
                
                    def __init__(self, config=None):
                        """Construct a source selector that uses a reference catalog
                        
                        @param[in] config: An instance of ConfigClass
                        """
                        if not config:
                            config = DiaCatalogSourceSelector.ConfigClass()
                        self.config = config
                        self.log = pexLog.Log(pexLog.Log.getDefaultLog(),
                                              'lsst.ip.diffim.DiaCatalogSourceSelector', pexLog.Log.INFO)
                
                    def selectSources(self, exposure, sources, matches=None):
                        """Return a list of Sources for Kernel candidates 
                        
                        @param[in] exposure: the exposure containing the sources
                        @param[in] sources: a source list containing sources that may be candidates
                        @param[in] matches: a match vector as produced by meas_astrom; not optional
                                            (passing None just allows us to handle the exception better here
                                            than in calling code)
                        
                        @return kernelCandidateSourceList: a list of sources to be used as kernel candidates
                 
                        """
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                        displayExposure = lsstDebug.Info(__name__).displayExposure
                        pauseAtEnd = lsstDebug.Info(__name__).pauseAtEnd
                
                        if matches is None:
                            raise RuntimeError(
                                "Cannot use catalog source selector without running astrometry."
                                )
                
                        mi = exposure.getMaskedImage()
                        
                        if display:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#7e2a022d">7e2a022d</a> -             frames = {}</div>
                            if displayExposure:
                                ds9.mtv(mi, title="Kernel candidates", frame=lsstDebug.frame)
                        #
                        # Look for flags in each Source
                        #
                        isGoodSource = CheckSource(sources, self.config.fluxLim, self.config.fluxMax, self.config.badPixelFlags)
                
                        #
                        # Go through and find all the acceptable candidates in the catalogue
                        #
                        kernelCandidateSourceList = []
                
                        doColorCut = True
                        with ds9.Buffering():
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#3651742b">3651742b</a> +             refSchema = matches[0][0].schema</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#3651742b">3651742b</a> +             rRefFluxField = measAlg.getRefFluxField(refSchema, "r")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#3651742b">3651742b</a> +             gRefFluxField = measAlg.getRefFluxField(refSchema, "g")</div>
                            for ref, source, d in matches:
                                if not isGoodSource(source):
                                    symb, ctype = "+", ds9.RED
                                else:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#3617cdfe">3617cdfe</a> -                     isStar = ref.get("stargal")</div>
              ?                                        ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#3651742b">3651742b</a> +                     isStar = not ref.get("resolved")</div>
              ?                             ++++          ++ ^ +++
                                    isVar = not ref.get("photometric")
                                    gMag = None
                                    rMag = None
                                    if doColorCut:
                                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#6dc36238">6dc36238</a> -                             gMag = -2.5 * np.log10(ref.get("g"))</div>
              ?                                                            - ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#3651742b">3651742b</a> +                             gMag = -2.5 * np.log10(ref.get(gRefFluxField))</div>
              ?                                                             ^^^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#6dc36238">6dc36238</a> -                             rMag = -2.5 * np.log10(ref.get("r"))</div>
              ?                                                            - ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#3651742b">3651742b</a> +                             rMag = -2.5 * np.log10(ref.get(rRefFluxField))</div>
              ?                                                             ^^^^^^^^^^^^
                                        except KeyError:
                                            self.log.warn("Cannot cut on color info; fields 'g' and 'r' do not exist")
                                            doColorCut = False
                                            isRightColor = True
                                        else:
                                            isRightColor = (gMag-rMag) >= self.config.grMin and (gMag-rMag) <= self.config.grMax
                                        
                                    isRightType  = (self.config.selectStar and isStar) or (self.config.selectGalaxy and not isStar)
                                    isRightVar   = (self.config.includeVariable) or (self.config.includeVariable is isVar)
                                    if isRightType and isRightVar and isRightColor:
                                        kernelCandidateSourceList.append(source)
                                        symb, ctype = "+", ds9.GREEN
                                    else:
                                        symb, ctype = "o", ds9.BLUE
                
                                if display and displayExposure:
                                    ds9.dot(symb, source.getX() - mi.getX0(), source.getY() - mi.getY0(),
                                            size=4, ctype=ctype, frame=lsstDebug.frame)
                
                        if display:
                            lsstDebug.frame += 1
                            if pauseAtEnd:
                                raw_input("Continue? y[es] p[db] ")
                
                        return kernelCandidateSourceList
                
                measAlg.starSelectorRegistry.register("diacatalog", DiaCatalogSourceSelector)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6dc36238"/></a>6dc36238</h3>

<pre>
commit 6dc362387bfbea5b31dc1f602014a2550c564d7a
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Oct 28 14:13:53 2013 -0500

    Final changes to code base to get imageDifferenceWinter2013.py to run end-to-end.
</pre>
<h3><a name="7e2a022d"/></a>7e2a022d</h3>

<pre>
commit 7e2a022d524893f9b7a54fd4e7de44bb13c68745
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Jan 25 11:30:28 2013 -0800

    Added DiaCatalogSourceSelector for source selection optimised for image subtraction.  Includes cuts on source flags, and referece object flags.
</pre>
<h3><a name="3617cdfe"/></a>3617cdfe</h3>

<pre>
commit 3617cdfe973a32cbedb40d394f99d750004da4cf
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Jan 25 14:07:00 2013 -0800

    Removed selectSources() exception block in response to Jim's review.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="3651742b"/></a>3651742b</h3>

<pre>
commit 3651742b1648a539e7cdf9ab1b5c70ff13ba7ff0
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:39:56 2015 -0700

    Updated code for new reference object schema
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_52"><a name="python/lsst/ip/diffim/diaSourceAnalysis.py"/></a>python/lsst/ip/diffim/diaSourceAnalysis.py</h1>

<h3 id="toc_53">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                from __future__ import division
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#c95bc1bc">c95bc1bc</a> - import os</div>
                from optparse import OptionParser
                import lsst.afw.image                    as afwImage
                import lsst.afw.geom                     as afwGeom
                import lsst.afw.detection                as afwDet
                import lsst.pex.policy                   as pexPolicy
                import lsst.pex.logging                  as pexLog 
                import lsst.daf.persistence              as dafPersist
                import lsst.daf.base                     as dafBase
                import numpy as num
                import lsst.afw.display.ds9 as ds9
                import lsst.pex.config as pexConfig
                
                scaling = 5
                
                def parseOptions():
                    """Parse the command line options."""
                    parser = OptionParser(
                            usage="""%prog cdDiffSources crDiffExposure
                            
                Read in sources and test for junk""")
                    options, args = parser.parse_args()
                    if len(args) != 2:
                        parser.error("incorrect number of arguments")
                    return options, args
                
                def readSourceSet(boostFile):
                    loc = dafPersist.LogicalLocation(boostFile)
                    storageList = dafPersist.StorageList()
                    additionalData = dafBase.PropertySet()
                    persistence = dafPersist.Persistence.getPersistence(pexPolicy.Policy())
                    storageList.append(persistence.getRetrieveStorage("BoostStorage", loc))
                    psvptr = persistence.unsafeRetrieve("PersistableSourceVector", storageList, additionalData)
                    psv = afwDet.PersistableSourceVector.swigConvert(psvptr)
                    return psv.getSources()
                
                class DiaSourceAnalystConfig(pexConfig.Config):
                    srcBadMaskPlanes = pexConfig.ListField(
                        dtype = str,
                        doc = """Mask planes that lead to an invalid detection.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#11ed452e">11ed452e</a> -                  Options: NO_DATA EDGE SAT BAD CR INTRP</div>
              ?                           --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#98f06938">98f06938</a> +                  Options: EDGE SAT BAD CR INTRP</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#11ed452e">11ed452e</a> -                  E.g. : NO_DATA SAT BAD allows CR-masked and interpolated pixels""",</div>
              ?                         ^^^ ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#98f06938">98f06938</a> +                  E.g. : EDGE SAT BAD allows CR-masked and interpolated pixels""",</div>
              ?                         ^ ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#11ed452e">11ed452e</a> -         default = ("NO_DATA", "SAT", "BAD")</div>
              ?                     ^^^ ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#98f06938">98f06938</a> +         default = ("EDGE", "SAT", "BAD")</div>
              ?                     ^ ^^
                    )
                    fBadPixels = pexConfig.Field(
                        dtype = float,
                        doc = "Fraction of bad pixels allowed in footprint",
                        default = 0.1
                    )
                    fluxPolarityRatio = pexConfig.Field(
                        dtype = float,
                        doc = "Minimum fraction of flux in correct-polarity pixels",
                        default = 0.75
                    )
                    nPolarityRatio = pexConfig.Field(
                        dtype = float,
                        doc = "Minimum fraction of correct-polarity pixels in unmasked subset",
                        default = 0.7
                    )
                    nMaskedRatio = pexConfig.Field(
                        dtype = float,
                        doc = "Minimum fraction of correct-polarity unmasked to masked pixels",
                        default = 0.6,
                    )
                    nGoodRatio =  pexConfig.Field(
                        dtype = float,
                        doc = "Minimum fraction of correct-polarity unmasked to all pixels",
                        default = 0.5
                    )
                
                
                class DiaSourceAnalyst(object):
                    def __init__(self, config):
                        self.config = config
                            
                        self.bitMask = 0
                        srcBadMaskPlanes = self.config.srcBadMaskPlanes
                        for maskPlane in srcBadMaskPlanes:
                            self.bitMask |= afwImage.MaskU_getPlaneBitMask(maskPlane) 
                        
                    def countDetected(self, mask):
                        idxP = num.where(mask & afwImage.MaskU_getPlaneBitMask("DETECTED"))
                        idxN = num.where(mask & afwImage.MaskU_getPlaneBitMask("DETECTED_NEGATIVE"))
                        return len(idxP[0]), len(idxN[0])
                        
                    def countMasked(self, mask):
                        idxM = num.where(mask & self.bitMask)
                        return len(idxM[0])
                        
                    def countPolarity(self, mask, pixels):
                        unmasked = ((mask & self.bitMask) == 0)
                        idxP  = num.where( (pixels >= 0) & unmasked)
                        idxN  = num.where( (pixels < 0)  & unmasked)
                        fluxP = num.sum(pixels[idxP])
                        fluxN = num.sum(pixels[idxN])
                        #import pdb; pdb.set_trace()
                        return len(idxP[0]), len(idxN[0]), fluxP, fluxN
                        
                    def testSource(self, source, subMi):
                        imArr, maArr, varArr   = subMi.getArrays()    
                        flux                   = source.getApFlux()
                        
                        nPixels                = subMi.getWidth() * subMi.getHeight()
                        nPos, nNeg, fPos, fNeg = self.countPolarity(maArr, imArr)
                        nDetPos, nDetNeg       = self.countDetected(maArr)
                        nMasked                = self.countMasked(maArr)
                        assert (nPixels == (nMasked + nPos + nNeg))
                        
                        # 1) Too many pixels in the detection are masked  
                        fMasked    = (nMasked / nPixels)
                        fMaskedTol = self.config.fBadPixels
                        if fMasked > fMaskedTol:
                            pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                                "Candidate %d : BAD fBadPixels %.2f > %.2f" % (source.getId(), fMasked, fMaskedTol))
                            return False
                            
                        if flux > 0:
                            # positive-going source
                            fluxRatio  = fPos / (fPos + abs(fNeg))
                            ngoodRatio = nPos / nPixels
                            maskRatio  = nPos / (nPos + nMasked)
                            npolRatio  = nPos / (nPos + nNeg)
                        else:
                            # negative-going source
                            fluxRatio  = abs(fNeg)/ (fPos + abs(fNeg))
                            ngoodRatio = nNeg / nPixels
                            maskRatio  = nNeg / (nNeg + nMasked)
                            npolRatio  = nNeg / (nNeg + nPos)
                        
                        # 2) Not enough flux in unmasked correct-polarity pixels
                        fluxRatioTolerance = self.config.fluxPolarityRatio
                        if fluxRatio < fluxRatioTolerance:
                            pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                                "Candidate %d : BAD flux polarity %.2f < %.2f (pos=%.2f neg=%.2f)" % (source.getId(), 
                                fluxRatio, fluxRatioTolerance, fPos, fNeg))
                            return False
                        
                        # 3) Not enough unmasked pixels of correct polarity
                        polarityTolerance = self.config.nPolarityRatio
                        if npolRatio < polarityTolerance:
                            pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                                "Candidate %d : BAD polarity count %.2f < %.2f (pos=%d neg=%d)" % (source.getId(), 
                                npolRatio, polarityTolerance, nPos, nNeg))
                            return False
                            
                        # 4) Too many masked vs. correct polarity pixels
                        maskedTolerance = self.config.nMaskedRatio
                        if maskRatio < maskedTolerance:
                            pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                                "Candidate %d : BAD unmasked count %.2f < %.2f (pos=%d neg=%d mask=%d)" % (source.getId(), 
                                maskRatio, maskedTolerance, nPos, nNeg, nMasked))
                            return False
                
                        # 5) Too few unmasked, correct polarity pixels
                        ngoodTolerance = self.config.nGoodRatio
                        if ngoodRatio < ngoodTolerance:
                            pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                                "Candidate %d : BAD good pixel count %.2f < %.2f (pos=%d neg=%d tot=%d)" % (source.getId(), 
                                ngoodRatio, ngoodTolerance, nPos, nNeg, nPixels))
                            return False
                                    
                        pexLog.Trace("lsst.ip.diffim.DiaSourceAnalysis", 1,
                            "Candidate %d : OK flux=%.2f nPos=%d nNeg=%d nTot=%d nDetPos=%d nDetNeg=%d fPos=%.2f fNeg=%2f" % (source.getId(),
                            flux, nPos, nNeg, nPixels, nDetPos, nDetNeg, fPos, fNeg))
                        return True                                        
                        
                
                def main():
                    """Main program"""
                    options, args = parseOptions()
                    (crDiffSourceFile, crDiffExposureFile) = args
                
                    crDiffSources = readSourceSet(crDiffSourceFile)
                    crDiffExposure = afwImage.ExposureF(crDiffExposureFile)
                    #import pdb; pdb.set_trace()
                    
                    analyst = DiaSourceAnalyst()
                    
                    expX0 = crDiffExposure.getX0()
                    expY0 = crDiffExposure.getY0()
                    expX1 = expX0 + crDiffExposure.getWidth() - 1
                    expY1 = expY0 + crDiffExposure.getHeight() - 1
                    
                    for i in range(crDiffSources.size()):
                        crDiffSource = crDiffSources[i]
                
                        # This segfaults; revisit once the stack stabilizes
                        #footprint    = crDiffSource.getFootprint()
                        #bbox         = footprint.getBBox()
                        
                        xAstrom      = crDiffSource.getXAstrom()
                        yAstrom      = crDiffSource.getYAstrom()
                        Ixx          = max(1.0, crDiffSource.getIxx())
                        Iyy          = max(1.0, crDiffSource.getIyy())
                        x0           = max(expX0, int(xAstrom - scaling * Ixx))
                        x1           = min(expX1, int(xAstrom + scaling * Ixx))
                        y0           = max(expY0, int(yAstrom - scaling * Iyy))
                        y1           = min(expY1, int(yAstrom + scaling * Iyy))
                        bbox         = afwGeom.Box2I(afwGeom.Point2I(x0, y0),
                                                     afwGeom.Point2I(x1, y1))
                        subExp       = afwImage.ExposureF(crDiffExposure, bbox)
                        subMi        = subExp.getMaskedImage()
                        imArr, maArr, varArr = subMi.getArrays()
                
                        if analyst.testSource(crDiffSource, subMi):
                            ds9.mtv(subExp, frame=1)
                            raw_input('Next: ')
                if __name__ == "__main__":
                    main()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c95bc1bc"/></a>c95bc1bc</h3>

<pre>
commit c95bc1bccda2ed922b482d49166a3159c7810f68
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Oct 18 22:24:11 2011 +0000

    QA on DIA sources.
</pre>
<h3><a name="11ed452e"/></a>11ed452e</h3>

<pre>
commit 11ed452e41a541f79f5ddb941d163affb60b717d
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri May 23 14:52:38 2014 -0400

    Adapt to new mask bit NO_DATA replacing EDGE (DM-669)
    
    NO_DATA means a warp/coadd pixel doesn't map to a CCD.
    EDGE means a pixel is near the edge and couldn't be searched
    for sources.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="98f06938"/></a>98f06938</h3>

<pre>
commit 98f06938888ae37e8473088773259594be5f49c6
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 11:30:26 2012 -0800

    Remove all policy files; mv diaAnalysis from using policy to config.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_54"><a name="src/AssessSpatialKernelVisitor.cc"/></a>src/AssessSpatialKernelVisitor.cc</h1>

<h3 id="toc_55">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file AssessSpatialKernelVisitor.cc
                 *
                 * @brief Implementation of AssessSpatialKernelVisitor
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                
                #include "lsst/afw/math.h"
                #include "lsst/afw/image.h"
                #include "lsst/pex/policy/Policy.h"
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/ImageSubtract.h"
                #include "lsst/ip/diffim/KernelCandidate.h"
                #include "lsst/ip/diffim/AssessSpatialKernelVisitor.h"
                
                #define DEBUG_IMAGES 0
                
                namespace afwMath        = lsst::afw::math;
                namespace afwImage       = lsst::afw::image;
                namespace pexLogging     = lsst::pex::logging; 
                namespace pexPolicy      = lsst::pex::policy; 
                namespace pexExcept      = lsst::pex::exceptions; 
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                namespace detail {
                    /**
                     * @class AssessSpatialKernelVisitor
                     * @ingroup ip_diffim
                     *
                     * @brief Asseses the quality of a candidate given a spatial kernel and background model
                     *
                     * @code
                        detail::AssessSpatialKernelVisitor<PixelT> spatialKernelAssessor(spatialKernel, 
                                                                                         spatialBackground, 
                                                                                         policy);
                        spatialKernelAssessor.reset();
                        kernelCells.visitCandidates(&spatialKernelAssessor, nStarPerCell);
                        nRejected = spatialKernelAssessor.getNRejected();
                     * @endcode
                     *
                     * @note Evaluates the spatial kernel and spatial background at the location of
                     * each candidate, and computes the resulting difference image.  Sets candidate
                     * as afwMath::SpatialCellCandidate::GOOD/BAD if requested by the Policy.
                     * 
                     */
                    template<typename PixelT>
                    AssessSpatialKernelVisitor<PixelT>::AssessSpatialKernelVisitor(
                        lsst::afw::math::LinearCombinationKernel::Ptr spatialKernel,   ///< Spatially varying kernel model
                        lsst::afw::math::Kernel::SpatialFunctionPtr spatialBackground, ///< Spatially varying backgound model
                        lsst::pex::policy::Policy const& policy                        ///< Policy file directing behavior
                        ) : 
                        afwMath::CandidateVisitor(),
                        _spatialKernel(spatialKernel),
                        _spatialBackground(spatialBackground),
                        _policy(policy),
                        _imstats(ImageStatistics<PixelT>(_policy)),
                        _nGood(0),
                        _nRejected(0),
                        _nProcessed(0),
                        _useCoreStats(_policy.getBool("useCoreStats")),
                        _coreRadius(_policy.getInt("candidateCoreRadius"))
                    {};
                
                    template<typename PixelT>
                    void AssessSpatialKernelVisitor<PixelT>::processCandidate(
                        lsst::afw::math::SpatialCellCandidate *candidate
                        ) {
                        
                        KernelCandidate<PixelT> *kCandidate = dynamic_cast<KernelCandidate<PixelT> *>(candidate);
                        if (kCandidate == NULL) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#c67c91dd">c67c91dd</a> -             throw LSST_EXCEPT(pexExcept::LogicErrorException,</div>
              ?                                                    ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::LogicError,</div>
                                              "Failed to cast SpatialCellCandidate to KernelCandidate");
                        }
                        if (!(kCandidate->isInitialized())) {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            pexLogging::TTrace<3>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                  "Cannot process candidate %d, continuing", kCandidate->getId());
                            return;
                        }
                        
                        pexLogging::TTrace<2>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                              "Processing candidate %d", kCandidate->getId());
                
                        /* 
                           Note - this is a hack until the Kernel API is upgraded by the
                           Davis crew.  I need a "local" version of the spatially varying
                           Kernel
                        */
                        afwImage::Image<double> kImage(_spatialKernel->getDimensions());
                        double kSum = _spatialKernel->computeImage(kImage, false, 
                                                                   kCandidate->getXCenter(), kCandidate->getYCenter());
                        boost::shared_ptr<afwMath::Kernel>
                            kernelPtr(new afwMath::FixedKernel(kImage));
                        /* </hack> */
                        
                        double background = (*_spatialBackground)(kCandidate->getXCenter(), kCandidate->getYCenter());
                        
                        MaskedImageT diffim = kCandidate->getDifferenceImage(kernelPtr, background);
                
                        if (DEBUG_IMAGES) {
                            kImage.writeFits(str(boost::format("askv_k%d.fits") % kCandidate->getId()));
                            diffim.writeFits(str(boost::format("askv_d%d.fits") % kCandidate->getId()));
                        }
                
                        /* Official resids */
                        try {
                            if (_useCoreStats) 
                                _imstats.apply(diffim, _coreRadius);
                            else
                                _imstats.apply(diffim);
                        } catch (pexExcept::Exception& e) {
                            pexLogging::TTrace<3>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                  "Unable to calculate imstats for Candidate %d", kCandidate->getId()); 
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            return;
                        }
                
                        _nProcessed += 1;
                        
                        pexLogging::TTrace<5>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                              "Chi2 = %.3f", _imstats.getVariance());
                        pexLogging::TTrace<5>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate",
                                              "X = %.2f Y = %.2f",
                                              kCandidate->getXCenter(), 
                                              kCandidate->getYCenter());
                        pexLogging::TTrace<5>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate",
                                              "Kernel Sum = %.3f", kSum);
                        pexLogging::TTrace<5>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate",
                                              "Background = %.3f", background);
                        pexLogging::TTrace<3>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate",
                                              "Candidate %d resids = %.3f +/- %.3f sigma (%d pix)",
                                              kCandidate->getId(),
                                              _imstats.getMean(),
                                              _imstats.getRms(),
                                              _imstats.getNpix());
                        
                        bool meanIsNan = std::isnan(_imstats.getMean());
                        bool rmsIsNan  = std::isnan(_imstats.getRms());
                        if (meanIsNan || rmsIsNan) {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            pexLogging::TTrace<4>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                  "Rejecting candidate %d, encountered NaN",
                                                  kCandidate->getId());
                            _nRejected += 1;
                            return;
                        }
                        
                        if (_policy.getBool("spatialKernelClipping")) {            
                            if (fabs(_imstats.getMean()) > _policy.getDouble("candidateResidualMeanMax")) {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                      "Rejecting candidate %d; bad mean residual : |%.3f| > %.3f",
                                                      kCandidate->getId(),
                                                      _imstats.getMean(),
                                                      _policy.getDouble("candidateResidualMeanMax"));
                                _nRejected += 1;
                            }
                            else if (_imstats.getRms() > _policy.getDouble("candidateResidualStdMax")) {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                      "Rejecting candidate %d; bad residual rms : %.3f > %.3f",
                                                      kCandidate->getId(),
                                                      _imstats.getRms(),
                                                      _policy.getDouble("candidateResidualStdMax"));
                                _nRejected += 1;
                            }
                            else {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::GOOD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                      "Spatial kernel OK");
                                _nGood += 1;
                            }
                        }
                        else {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::GOOD);
                            pexLogging::TTrace<6>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                  "Sigma clipping not enabled");
                            _nGood += 1;
                        }
                
                        /* Core resids for debugging */
                        if (!(_useCoreStats)) {
                            try {
                                _imstats.apply(diffim, _coreRadius);
                            } catch (pexExcept::Exception& e) {
                                pexLogging::TTrace<3>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate", 
                                                      "Unable to calculate core imstats for Candidate %d", 
                                                      kCandidate->getId()); 
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                return;
                            }
                            pexLogging::TTrace<4>("lsst.ip.diffim.AssessSpatialKernelVisitor.processCandidate",
                                                  "Candidate %d core resids = %.3f +/- %.3f sigma (%d pix)",
                                                  kCandidate->getId(),
                                                  _imstats.getMean(),
                                                  _imstats.getRms(),
                                                  _imstats.getNpix());
                        }
                    }
                
                    typedef float PixelT;
                    template class AssessSpatialKernelVisitor<PixelT>;
                
                }}}} // end of namespace lsst::ip::diffim::detail
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c67c91dd"/></a>c67c91dd</h3>

<pre>
commit c67c91dd4e81b9b72be671a573ee8a5c541bd30b
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Feb 27 21:32:29 2010 +0000

    Moved Visitor code into separate declaration and implementation files.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_56"><a name="examples/compareKernelTypes.py"/></a>examples/compareKernelTypes.py</h1>

<h3 id="toc_57">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#efc59e9e">efc59e9e</a> - import pdb</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#efc59e9e">efc59e9e</a> - import sys</div>
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#ecf3294f">ecf3294f</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.pex.config as pexConfig
                import lsst.ip.diffim as ipDiffim
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#b0fef8cd">b0fef8cd</a> - import lsst.ip.diffim.diffimTools as diffimTools</div>
                import lsst.pex.logging as logging
                
                import lsst.afw.display.ds9 as ds9
                
                verbosity = 5
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                display = True
                writefits = False
                
                fitForBackground = False
                constantVarianceWeighting = True
                
                # This one compares DeltaFunction and AlardLupton kernels
                defSciencePath = None
                defTemplatePath = None
                
                class DiffimTestCases(unittest.TestCase):
                    # D = I - (K.x.T + bg)
                    def setUp(self):
                        self.configAL    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configAL.kernel.name = "AL"
                        self.subconfigAL = self.configAL.kernel.active
                
                        self.configDF    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDF.kernel.name = "DF"
                        self.subconfigDF = self.configDF.kernel.active
                
                        self.configDFr    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDFr.kernel.name = "DF"
                        self.subconfigDFr = self.configDFr.kernel.active
                
                        self.subconfigDF.useRegularization  = False
                        self.subconfigDFr.useRegularization = True
                        self.subconfigDFr.lambdaValue       = 1000.0
                
                        self.subconfigAL.fitForBackground  = fitForBackground
                        self.subconfigDF.fitForBackground  = fitForBackground
                        self.subconfigDFr.fitForBackground = fitForBackground
                
                        self.subconfigAL.constantVarianceWeighting  = constantVarianceWeighting
                        self.subconfigDF.constantVarianceWeighting  = constantVarianceWeighting 
                        self.subconfigDFr.constantVarianceWeighting = constantVarianceWeighting
                
                        self.kListAL  = ipDiffim.makeKernelBasisList(self.subconfigAL)
                        self.kListDF  = ipDiffim.makeKernelBasisList(self.subconfigDF)
                        self.kListDFr = ipDiffim.makeKernelBasisList(self.subconfigDFr)
                        self.hMatDFr  = ipDiffim.makeRegularizationMatrix(pexConfig.makePolicy(self.subconfigDFr))
                
                        self.bskvAL  = ipDiffim.BuildSingleKernelVisitorF(self.kListAL, pexConfig.makePolicy(self.subconfigAL))
                        self.bskvDF  = ipDiffim.BuildSingleKernelVisitorF(self.kListDF, pexConfig.makePolicy(self.subconfigDF))
                        self.bskvDFr = ipDiffim.BuildSingleKernelVisitorF(self.kListDFr,  pexConfig.makePolicy(self.subconfigDF), 
                                                                          self.hMatDFr) 
                
                        defSciencePath = globals()['defSciencePath']
                        defTemplatePath = globals()['defTemplatePath']
                        if defSciencePath and defTemplatePath:
                            self.scienceExposure   = afwImage.ExposureF(defSciencePath)
                            self.templateExposure  = afwImage.ExposureF(defTemplatePath)
                        else:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#ed716748">ed716748</a> -             defDataDir = eups.productDir('afwdata')</div>
              ?                          ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#48e85303">48e85303</a> +             defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ?                          ^^^^^ ^^^  ^^^^^ ^^^^
                            defSciencePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                          "v26-e0-c011-a00.sci")
                            defTemplatePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                           "v5-e0-c011-a00.sci")
                            
                            self.scienceExposure   = afwImage.ExposureF(defSciencePath)
                            self.templateExposure  = afwImage.ExposureF(defTemplatePath)
                            warper = afwMath.Warper.fromConfig(self.subconfigAL.warpingConfig)
                            self.templateExposure = warper.warpExposure(self.scienceExposure.getWcs(), self.templateExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#2b800296">2b800296</a> -                                                         destBBox = self.scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                                                 ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#9250fe88">9250fe88</a> +                                                         destBBox = self.scienceExposure.getBBox())</div>
                
                
                        # image statistics
                        self.dStats  = ipDiffim.ImageStatisticsF()
                
                        #
                        tmi = self.templateExposure.getMaskedImage()
                        smi = self.scienceExposure.getMaskedImage()
                
                
                        # Object detection
                        detConfig = self.subconfigAL.detectionConfig
                        detPolicy = pexConfig.makePolicy(detConfig)
                        detPolicy.set("detThreshold", 50.)
                        detPolicy.set("detThresholdType", "stdev")
                        detPolicy.set("detOnTemplate", False)
                        kcDetect = ipDiffim.KernelCandidateDetectionF(detPolicy)
                        kcDetect.apply(tmi, smi)
                        self.footprints = kcDetect.getFootprints()
                
                        
                    def tearDown(self):
                        del self.kListAL
                        del self.kListDF
                        del self.kListDFr
                        del self.hMatDFr
                        del self.bskvAL
                        del self.bskvDF
                        del self.bskvDFr
                        del self.scienceExposure
                        del self.templateExposure
                        del self.footprints
                
                    def apply(self, policy, visitor, xloc, yloc, tmi, smi):
                        kc     = ipDiffim.makeKernelCandidate(xloc, yloc, tmi, smi, policy)
                        visitor.processCandidate(kc)
                        kim    = kc.getKernelImage(ipDiffim.KernelCandidateF.RECENT)
                        diffIm = kc.getDifferenceImage(ipDiffim.KernelCandidateF.RECENT)
                        kSum   = kc.getKsum(ipDiffim.KernelCandidateF.RECENT)
                        bg     = kc.getBackground(ipDiffim.KernelCandidateF.RECENT)
                
                        bbox = kc.getKernel(ipDiffim.KernelCandidateF.RECENT).shrinkBBox(diffIm.getBBox(afwImage.LOCAL))
                        diffIm = afwImage.MaskedImageF(diffIm, bbox, afwImage.LOCAL)
                        self.dStats.apply(diffIm)
                        
                        dmean = afwMath.makeStatistics(diffIm.getImage(),    afwMath.MEAN).getValue()
                        dstd  = afwMath.makeStatistics(diffIm.getImage(),    afwMath.STDEV).getValue()
                        vmean = afwMath.makeStatistics(diffIm.getVariance(), afwMath.MEAN).getValue()
                        return kSum, bg, dmean, dstd, vmean, kim, diffIm, kc
                        
                    def applyVisitor(self, invert=False, xloc=397, yloc=580):
                        print '# %.2f %.2f' % (xloc, yloc)
                
                        imsize = int(3 * self.subconfigAL.kernelSize)
                
                        # chop out a region around a known object
                        bbox = afwGeom.Box2I(afwGeom.Point2I(xloc - imsize/2,
                                                             yloc - imsize/2),
                                             afwGeom.Point2I(xloc + imsize/2,
                                                             yloc + imsize/2) )
                
                        # sometimes the box goes off the image; no big deal...
                        try:
                            if invert:
                                tmi  = afwImage.MaskedImageF(self.scienceExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                                smi  = afwImage.MaskedImageF(self.templateExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                            else:
                                smi  = afwImage.MaskedImageF(self.scienceExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                                tmi  = afwImage.MaskedImageF(self.templateExposure.getMaskedImage(), bbox, afwImage.LOCAL)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#efc59e9e">efc59e9e</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#9250fe88">9250fe88</a> +         except Exception:</div>
                            return None
                
                        #
                        ###
                        #
                
                        # delta function kernel
                        resultsDF = self.apply(pexConfig.makePolicy(self.subconfigDF), self.bskvDF, xloc, yloc, tmi, smi)
                        kSumDF, bgDF, dmeanDF, dstdDF, vmeanDF, kImageOutDF, diffImDF, kcDF = resultsDF
                        kcDF.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.EIGENVALUE)
                        kcDF.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.SVD)
                        print 'DF Diffim residuals : %.2f +/- %.2f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                    self.dStats.getRms(),
                                                                                                    kSumDF, bgDF,
                                                                                                    dmeanDF, dstdDF, vmeanDF)
                        if display:
                            ds9.mtv(tmi, frame=1) # ds9 switches frame 0 and 1 for some reason
                            ds9.mtv(smi, frame=0)
                            ds9.mtv(kImageOutDF, frame=2)
                            ds9.mtv(diffImDF, frame=3)
                        if writefits:
                            tmi.writeFits('t')
                            smi.writeFits('s')
                            kImageOutDF.writeFits('kDF.fits')
                            diffImDF.writeFits('dDF')
                
                        #
                        ###
                        #
                
                        # regularized delta function kernel
                        resultsDFr = self.apply(pexConfig.makePolicy(self.subconfigDFr), self.bskvDFr, xloc, yloc, tmi, smi)
                        kSumDFr, bgDFr, dmeanDFr, dstdDFr, vmeanDFr, kImageOutDFr, diffImDFr, kcDFr = resultsDFr
                        kcDFr.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.EIGENVALUE)
                        kcDFr.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.SVD)
                        print 'DFr Diffim residuals : %.2f +/- %.2f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                     self.dStats.getRms(),
                                                                                                     kSumDFr, bgDFr,
                                                                                                     dmeanDFr, dstdDFr, vmeanDFr)
                        if display:
                            ds9.mtv(tmi, frame=4)
                            ds9.mtv(smi, frame=5)
                            ds9.mtv(kImageOutDFr, frame=6)
                            ds9.mtv(diffImDFr, frame=7)
                        if writefits:
                            kImageOutDFr.writeFits('kDFr.fits')
                            diffImDFr.writeFits('dDFr')
                
                        #
                        ###
                        #
                
                        # alard-lupton kernel
                        resultsAL = self.apply(pexConfig.makePolicy(self.subconfigAL), self.bskvAL, xloc, yloc, tmi, smi)
                        kSumAL, bgAL, dmeanAL, dstdAL, vmeanAL, kImageOutAL, diffImAL, kcAL = resultsAL
                        kcAL.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.EIGENVALUE)
                        kcAL.getKernelSolution(ipDiffim.KernelCandidateF.RECENT).getConditionNumber(
                            ipDiffim.KernelSolution.SVD)
                        print 'AL Diffim residuals : %.2f +/- %.2f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                    self.dStats.getRms(),
                                                                                                    kSumAL, bgAL,
                                                                                                    dmeanAL, dstdAL, vmeanAL)
                        # outputs
                        if display:
                            ds9.mtv(tmi, frame=8)
                            ds9.mtv(smi, frame=9)
                            ds9.mtv(kImageOutAL, frame=10)
                            ds9.mtv(diffImAL, frame=11)
                        if writefits:
                            kImageOutAL.writeFits('kAL.fits')
                            diffImAL.writeFits('dAL')
                
                        raw_input('Next: ')
                
                    def testFunctor(self):
                        for fp in self.footprints:
                            # note this returns the kernel images
                            self.applyVisitor(invert=False, 
                                              xloc= int(0.5 * ( fp.getBBox().getMinX() + fp.getBBox().getMaxX() )),
                                              yloc= int(0.5 * ( fp.getBBox().getMinY() + fp.getBBox().getMaxY() )))
                       
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    from optparse import OptionParser
                    parser = OptionParser()
                    parser.add_option('-n', dest='nodisplay', action='store_true', default=False)
                    parser.add_option('-w', dest='writefits', action='store_true', default=False)
                    parser.add_option('-t', dest='defTemplatePath')
                    parser.add_option('-i', dest='defSciencePath')
                    (opt, args) = parser.parse_args()
                
                    display = not opt.nodisplay
                    writefits = opt.writefits
                    if opt.defTemplatePath and opt.defSciencePath:
                        defTemplatePath = opt.defTemplatePath
                        defSciencePath = opt.defSciencePath
                        
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="efc59e9e"/></a>efc59e9e</h3>

<pre>
commit efc59e9e500288a569c008ea7b3ada3a26195942
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Dec 18 23:26:01 2009 +0000

    Python code up to standards.
</pre>
<h3><a name="ecf3294f"/></a>ecf3294f</h3>

<pre>
commit ecf3294f06003b0db278b7e6b0258c62c021845c
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Oct 13 02:56:10 2009 +0000

    updateing examples and added swig wrapper; #876
</pre>
<h3><a name="ed716748"/></a>ed716748</h3>

<pre>
commit ed7167486f2c6e6add76fa89a827f61d4236f1f8
Author: becker <becker@git.lsstcorp.org>
Date:   Tue May 17 22:12:23 2011 +0000

    For in the code for deconvolution situations.  #1140.
</pre>
<h3><a name="b0fef8cd"/></a>b0fef8cd</h3>

<pre>
commit b0fef8cd608cc3b96cee491625d0a7d1fae5b885
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Apr 28 00:01:03 2010 +0000

    updates to regularization.  #1140.
</pre>
<h3><a name="2b800296"/></a>2b800296</h3>

<pre>
commit 2b800296714d12ad336b61ebdcc4b93b4a4cd141
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Feb 13 14:37:54 2012 -0800

    Fixing code in examples.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_58"><a name="src/BuildSingleKernelVisitor.cc"/></a>src/BuildSingleKernelVisitor.cc</h1>

<h3 id="toc_59">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file BuildSingleKernelVisitor.h
                 *
                 * @brief Implementation of BuildSingleKernelVisitor 
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                
                #include "boost/shared_ptr.hpp" 
                #include "Eigen/Core"
                
                #include "lsst/afw/math.h"
                #include "lsst/afw/image.h"
                
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/policy/Policy.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/ImageSubtract.h"
                #include "lsst/ip/diffim/KernelCandidate.h"
                #include "lsst/ip/diffim/BuildSingleKernelVisitor.h"
                
                #define DEBUG_MATRIX 0
                
                namespace afwMath        = lsst::afw::math;
                namespace afwImage       = lsst::afw::image;
                namespace pexLogging     = lsst::pex::logging; 
                namespace pexPolicy      = lsst::pex::policy; 
                namespace pexExcept      = lsst::pex::exceptions; 
                namespace ipDiffim       = lsst::ip::diffim;
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                namespace detail {
                
                    /**
                     * @class BuildSingleKernelVisitor
                     * @ingroup ip_diffim
                     *
                     * @brief Builds the convolution kernel for a given candidate
                     *
                     * @code
                        Policy::Ptr policy(new Policy);
                        policy->set("constantVarianceWeighting", false);
                        policy->set("iterateSingleKernel", false);
                        policy->set("singleKernelClipping", true);
                        policy->set("candidateResidualMeanMax", 0.25);
                        policy->set("candidateResidualStdMax", 1.25);
                    
                        detail::BuildSingleKernelVisitor<PixelT> singleKernelFitter(*policy);
                        int nRejected = -1;
                        while (nRejected != 0) {
                            singleKernelFitter.reset();
                            kernelCells.visitCandidates(&singleKernelFitter, nStarPerCell);
                            nRejected = singleKernelFitter.getNRejected();
                        }
                     * @endcode
                     *
                     * @note Visits each current candidate in a afwMath::SpatialCellSet, and
                     * builds its kernel using its build() method.  We don't build the kernel
                     * for *every* candidate since this is computationally expensive, only when
                     * its the current candidate in the cell.  During the course of building the
                     * kernel, it also assesses the quality of the difference image.  If it is
                     * determined to be bad (based on the Policy paramters) the candidate is
                     * flagged as afwMath::SpatialCellCandidate::BAD; otherwise its marked as
                     * afwMath::SpatialCellCandidate::GOOD.  Keeps a running sample of all the
                     * new candidates it visited that turned out to be bad.
                     *
                     * @note Because this visitor does not have access to the next candidate in the
                     * cell, it must be called iteratively until no candidates are rejected.  This
                     * ensures that the current candidate of every cell has an initialized Kernel.
                     * This also requires that this class re-Visit all the cells after any other
                     * Visitors with the ability to mark something as BAD.
                     *
                     * @note Because we are frequently re-Visiting entirely GOOD candidates during
                     * these iterations, the option of _skipBuilt=true will enable the user to *not*
                     * rebuilt the kernel on every visit.
                     *
                     * @note For the particular use case of creating a Pca basis from the raw
                     * kernels, we want to re-Visit each candidate and re-fit the kernel using
                     * this Pca basis.  This requires the user to setSkipBuilt(false) so that
                     * the candidate is reprocessed with this new basis.
                     * 
                     */
                    template<typename PixelT>
                    BuildSingleKernelVisitor<PixelT>::BuildSingleKernelVisitor(
                        lsst::afw::math::KernelList const& basisList,   ///< List of basis kernels
                            ///< for resulting LinearCombinationKernel
                        lsst::pex::policy::Policy const& policy  ///< Policy file directing behavior
                        ) :
                        afwMath::CandidateVisitor(),
                        _basisList(basisList),
                        _policy(policy),
                        _hMat(),
                        _imstats(ImageStatistics<PixelT>(_policy)),
                        _skipBuilt(true),
                        _nRejected(0),
                        _nProcessed(0),
                        _useRegularization(false),
                        _useCoreStats(_policy.getBool("useCoreStats")),
                        _coreRadius(_policy.getInt("candidateCoreRadius"))
                    {};
                
                    template<typename PixelT>
                    BuildSingleKernelVisitor<PixelT>::BuildSingleKernelVisitor(
                        lsst::afw::math::KernelList const& basisList,   ///< List of basis kernels
                            ///< for resulting LinearCombinationKernel
                        lsst::pex::policy::Policy const& policy,  ///< Policy file directing behavior
                        boost::shared_ptr<Eigen::MatrixXd> hMat   ///< Regularization matrix
                        ) :
                        afwMath::CandidateVisitor(),
                        _basisList(basisList),
                        _policy(policy),
                        _hMat(hMat),
                        _imstats(ImageStatistics<PixelT>(_policy)),
                        _skipBuilt(true),
                        _nRejected(0),
                        _nProcessed(0),
                        _useRegularization(true),
                        _useCoreStats(_policy.getBool("useCoreStats")),
                        _coreRadius(_policy.getInt("candidateCoreRadius"))
                    {};
                
                    
                    template<typename PixelT>
                    void BuildSingleKernelVisitor<PixelT>::processCandidate(
                        lsst::afw::math::SpatialCellCandidate *candidate
                        ) {
                        
                        ipDiffim::KernelCandidate<PixelT> *kCandidate = 
                            dynamic_cast<ipDiffim::KernelCandidate<PixelT> *>(candidate);
                        if (kCandidate == NULL) {
                            pexLogging::TTrace<3>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Failed to cast SpatialCellCandidate to KernelCandidate %d", 
                                                  kCandidate->getId());
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#c67c91dd">c67c91dd</a> -             throw LSST_EXCEPT(pexExcept::LogicErrorException,</div>
              ?                                                    ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::LogicError,</div>
                                              "Failed to cast SpatialCellCandidate to KernelCandidate");
                        }
                        
                        if (_skipBuilt and kCandidate->isInitialized()) {
                            return;
                        }
                        
                        pexLogging::TTrace<2>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                              "Processing candidate %d", kCandidate->getId());
                        pexLogging::TTrace<5>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate",
                                              "X = %.2f Y = %.2f",
                                              kCandidate->getXCenter(), 
                                              kCandidate->getYCenter());
                                              
                        /* Build its kernel here */
                        try {
                            if (_useRegularization)
                                kCandidate->build(_basisList, _hMat);
                            else
                                kCandidate->build(_basisList);
                
                        } catch (pexExcept::Exception &e) {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Unable to process candidate %d; exception caught (%s)", 
                                                  kCandidate->getId(),
                                                  e.what());
                            _nRejected += 1;
                            return;
                        } 
                
                        if (kCandidate->getStatus() == afwMath::SpatialCellCandidate::BAD) {
                            pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Candidate %d Returned BAD upon build, exiting", 
                                                  kCandidate->getId());
                            _nRejected += 1;
                            return;
                        }
                            
                         
                         /* 
                         * Make diffim and set chi2 from result.  Note that you need to use the
                         * most recent kernel
                         */
                        MaskedImageT diffim = kCandidate->getDifferenceImage(ipDiffim::KernelCandidate<PixelT>::RECENT);
                        try {
                            if (_useCoreStats) 
                                _imstats.apply(diffim, _coreRadius);
                            else
                                _imstats.apply(diffim);
                        } catch (pexExcept::Exception& e) {
                            pexLogging::TTrace<3>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Unable to calculate imstats for Candidate %d", kCandidate->getId()); 
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            return;
                        }
                        _nProcessed += 1;
                
                        kCandidate->setChi2(_imstats.getVariance());
                        
                        /* When using a Pca basis, we don't reset the kernel or background,
                           so we need to evaluate these locally for the Trace */
                        double kSum = kCandidate->getKsum(ipDiffim::KernelCandidate<PixelT>::RECENT);
                        double background = kCandidate->getBackground(ipDiffim::KernelCandidate<PixelT>::RECENT);
                        
                        pexLogging::TTrace<5>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                              "Chi2 = %.3f", kCandidate->getChi2());
                        pexLogging::TTrace<5>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate",
                                              "Kernel Sum = %.3f", kSum);
                        pexLogging::TTrace<5>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate",
                                              "Background = %.3f", background);
                        pexLogging::TTrace<3>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate",
                                              "Candidate %d resids = %.3f +/- %.3f sigma (%d pix)",
                                              kCandidate->getId(),
                                              _imstats.getMean(),
                                              _imstats.getRms(),
                                              _imstats.getNpix());
                        
                        bool meanIsNan = std::isnan(_imstats.getMean());
                        bool rmsIsNan  = std::isnan(_imstats.getRms());
                        if (meanIsNan || rmsIsNan) {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Rejecting candidate %d, encountered NaN",
                                                  kCandidate->getId());
                            _nRejected += 1;
                            return;
                        }
                        
                        if (_policy.getBool("singleKernelClipping")) {
                            if (fabs(_imstats.getMean()) > _policy.getDouble("candidateResidualMeanMax")) {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                      "Rejecting candidate %d; bad mean residual : |%.3f| > %.3f",
                                                      kCandidate->getId(),
                                                      _imstats.getMean(),
                                                      _policy.getDouble("candidateResidualMeanMax"));
                                _nRejected += 1;
                            }
                            else if (_imstats.getRms() > _policy.getDouble("candidateResidualStdMax")) {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                      "Rejecting candidate %d; bad residual rms : %.3f > %.3f",
                                                      kCandidate->getId(),
                                                      _imstats.getRms(),
                                                      _policy.getDouble("candidateResidualStdMax"));
                                _nRejected += 1;
                            }
                            else {
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::GOOD);
                                pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                      "Source kernel OK");
                            }
                        }
                        else {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::GOOD);
                            pexLogging::TTrace<6>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                  "Sigma clipping not enabled");
                        }
                        
                        /* Core resids for debugging */
                        if (!(_useCoreStats)) {
                            try {
                                _imstats.apply(diffim, _coreRadius);
                            } catch (pexExcept::Exception& e) {
                                pexLogging::TTrace<3>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate", 
                                                      "Unable to calculate core imstats for Candidate %d", 
                                                      kCandidate->getId()); 
                                kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                return;
                            }
                            pexLogging::TTrace<4>("lsst.ip.diffim.BuildSingleKernelVisitor.processCandidate",
                                                  "Candidate %d core resids = %.3f +/- %.3f sigma (%d pix)",
                                                  kCandidate->getId(),
                                                  _imstats.getMean(),
                                                  _imstats.getRms(),
                                                  _imstats.getNpix());
                        }
                        
                    }
                
                    typedef float PixelT;
                
                    template class BuildSingleKernelVisitor<PixelT>;
                
                    template boost::shared_ptr<BuildSingleKernelVisitor<PixelT> >
                    makeBuildSingleKernelVisitor<PixelT>(lsst::afw::math::KernelList const&,
                                                         lsst::pex::policy::Policy const&);
                
                    template boost::shared_ptr<BuildSingleKernelVisitor<PixelT> >
                    makeBuildSingleKernelVisitor<PixelT>(lsst::afw::math::KernelList const&,
                                                         lsst::pex::policy::Policy const&,
                                                         boost::shared_ptr<Eigen::MatrixXd>);
                
                }}}} // end of namespace lsst::ip::diffim::detail
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c67c91dd"/></a>c67c91dd</h3>

<pre>
commit c67c91dd4e81b9b72be671a573ee8a5c541bd30b
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Feb 27 21:32:29 2010 +0000

    Moved Visitor code into separate declaration and implementation files.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_60"><a name="tests/KernelPca.py"/></a>tests/KernelPca.py</h1>

<h3 id="toc_61">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c96bb23c">c96bb23c</a> - import os, sys</div>
                import unittest
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#c96bb23c">c96bb23c</a> + </div>
                import lsst.utils.tests as tests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#c96bb23c">c96bb23c</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.geom as afwGeom
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#2b197d36">2b197d36</a> - import lsst.afw.display.ds9 as ds9</div>
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "DF"
                        self.subconfig = self.config.kernel.active
                
                        self.kList  = ipDiffim.makeKernelBasisList(self.subconfig)
                        self.policy = pexConfig.makePolicy(self.subconfig)
                        self.policy.set("useRegularization", False)
                
                    def tearDown(self):
                        del self.config
                        del self.policy
                        del self.kList
                
                    def makeCandidate(self, kSum, x, y, size = 51):
                        mi1 = afwImage.MaskedImageF(afwGeom.Extent2I(size, size))
                        mi1.getVariance().set(1.0) # avoid NaNs
                        mi1.set(size//2, size//2, (1, 0x0, 1))
                        mi2 = afwImage.MaskedImageF(afwGeom.Extent2I(size, size))
                        mi2.getVariance().set(1.0) # avoid NaNs
                        mi2.set(size//2, size//2, (kSum, 0x0, kSum))
                        kc = ipDiffim.makeKernelCandidate(x, y, mi1, mi2, self.policy)
                        return kc
                
                    def testGaussian(self, size = 51):
                        gaussFunction = afwMath.GaussianFunction2D(2, 3)
                        gaussKernel   = afwMath.AnalyticKernel(size, size, gaussFunction)
                        
                        imagePca1 = ipDiffim.KernelPcaD()  # mean subtract
                        imagePca2 = ipDiffim.KernelPcaD()  # don't mean subtract
                        kpv1      = ipDiffim.KernelPcaVisitorF(imagePca1)
                        kpv2      = ipDiffim.KernelPcaVisitorF(imagePca2)
                
                        kRefIm    = None
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#2b197d36">2b197d36</a> -         frame = 0</div>
                        for i in range(100):
                            kImage1 = afwImage.ImageD(gaussKernel.getDimensions())
                            gaussKernel.computeImage(kImage1, False)
                            kImage1 *= 10000  # to get some decent peak source counts
                            kImage1 += 10     # to get some sky background noise
                
                            if kRefIm == None:
                                kRefIm = kImage1
                
                            kImage1 = diffimTools.makePoissonNoiseImage(kImage1)
                            kImage2 = afwImage.ImageD(kImage1, True)
                
                            imagePca1.addImage(kImage1, 1.0)
                            imagePca2.addImage(kImage2, 1.0)
                                           
                        kpv1.subtractMean()
                
                        imagePca1.analyze()
                        imagePca2.analyze()
                
                        pcaBasisList1 = kpv1.getEigenKernels()
                        pcaBasisList2 = kpv2.getEigenKernels()
                        
                        eVal1 = imagePca1.getEigenValues()
                        eVal2 = imagePca2.getEigenValues()
                
                        # First term is far more signficant without mean subtraction
                        self.assertTrue(eVal2[0] > eVal1[0])
                
                        # Last term basically zero with mean subtraction
                        self.assertAlmostEqual(eVal1[-1], 0.0)
                
                        # Extra image with mean subtraction
                        self.assertTrue(len(pcaBasisList1) == (len(eVal1) + 1))
                
                        # Same shape
                        self.assertTrue(len(pcaBasisList2) == len(eVal2))
                
                        # Mean kernel close to kRefIm
                        kImageM = afwImage.ImageD(gaussKernel.getDimensions())
                        pcaBasisList1[0].computeImage(kImageM, False)
                        for y in range(kRefIm.getHeight()):
                            for x in range(kRefIm.getWidth()):
                                self.assertTrue( abs(kRefIm.get(x, y) - kImageM.get(x, y)) / kRefIm.get(x, y) < 0.2 )
                
                        # First mean-unsubtracted Pca kernel close to kRefIm (normalized to peak of 1.0)
                        kImage0 = afwImage.ImageD(gaussKernel.getDimensions())
                        pcaBasisList2[0].computeImage(kImage0, False)
                        maxVal  = afwMath.makeStatistics(kRefIm, afwMath.MAX).getValue(afwMath.MAX)
                        kRefIm /= maxVal
                        for y in range(kRefIm.getHeight()):
                            for x in range(kRefIm.getWidth()):
                                self.assertTrue( abs(kRefIm.get(x, y) - kImage0.get(x, y)) / kRefIm.get(x, y) < 0.2 )
                
                    def testImagePca(self):
                        # Test out the ImagePca behavior
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc1.build(self.kList)
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc2.build(self.kList)
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                        kc3.build(self.kList)
                
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.KernelPcaVisitorF(imagePca)
                        kpv.processCandidate(kc1)
                        kpv.processCandidate(kc2)
                        kpv.processCandidate(kc3)
                
                        imagePca.analyze()
                        eigenImages = imagePca.getEigenImages()
                        # NOTE : this needs to be changed once ticket #1649 is resolved
                        for i in range(len(eigenImages)):
                            for j in range(i, len(eigenImages)):
                                print i, j, afwImage.innerProduct(eigenImages[i], eigenImages[j])
                        
                       
                    def testEigenValues(self):
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc1.build(self.kList)
                
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc2.build(self.kList)
                
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                        kc3.build(self.kList)
                
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.KernelPcaVisitorF(imagePca)
                        kpv.processCandidate(kc1)
                        kpv.processCandidate(kc2)
                        kpv.processCandidate(kc3)
                
                        imagePca.analyze()
                        eigenImages = imagePca.getEigenImages()
                        eigenValues = imagePca.getEigenValues()
                
                        # took in 3 images
                        self.assertEqual(len(eigenImages), 3)
                        self.assertEqual(len(eigenValues), 3)
                
                        # all the same shape, only 1 eigenvalue
                        self.assertAlmostEqual(eigenValues[0], 1.0)
                        self.assertAlmostEqual(eigenValues[1], 0.0)
                        self.assertAlmostEqual(eigenValues[2], 0.0)
                        
                    def testMeanSubtraction(self):
                        kc1 = self.makeCandidate(1, 0.0, 0.0)
                        kc1.build(self.kList)
                
                        kc2 = self.makeCandidate(2, 0.0, 0.0)
                        kc2.build(self.kList)
                
                        kc3 = self.makeCandidate(3, 0.0, 0.0)
                        kc3.build(self.kList)
                
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.KernelPcaVisitorF(imagePca)
                        kpv.processCandidate(kc1)
                        kpv.processCandidate(kc2)
                        kpv.processCandidate(kc3)
                        kpv.subtractMean() # subtract it *from* imagePca
                
                        imagePca.analyze()
                        eigenImages = imagePca.getEigenImages()
                        eigenValues = imagePca.getEigenValues()
                
                        # took in 3 images
                        self.assertEqual(len(eigenImages), 3)
                        self.assertEqual(len(eigenValues), 3)
                
                        # all the same shape, mean subtracted, so *no* eigenvalues
                        self.assertAlmostEqual(eigenValues[0], 0.0)
                        self.assertAlmostEqual(eigenValues[1], 0.0)
                        self.assertAlmostEqual(eigenValues[2], 0.0)
                
                        # finally, since imagePca normalizes by the sum, this should
                        # have central pixel value 1.0 and the rest 0.0
                        imageMean = kpv.returnMean()
                        rows = imageMean.getHeight()
                        cols = imageMean.getWidth()
                        for y in range(rows):
                            for x in range(cols):
                                if x == cols // 2 and y == rows // 2:
                                    self.assertAlmostEqual(imageMean.get(x, y), 1.0)
                                else:
                                    self.assertAlmostEqual(imageMean.get(x, y), 0.0)
                
                    def testVisit(self, nCell = 3):
                        imagePca = ipDiffim.KernelPcaD()
                        kpv = ipDiffim.makeKernelPcaVisitor(imagePca)
                
                        sizeCellX = self.policy.get("sizeCellX")
                        sizeCellY = self.policy.get("sizeCellY")
                        
                        kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0,
                                                                                             0),
                                                                             afwGeom.Extent2I(sizeCellX * nCell,
                                                                                              sizeCellY * nCell)),
                                                               sizeCellX,
                                                               sizeCellY)
                        
                        for candX in range(nCell):
                            for candY in range(nCell):
                                if candX == nCell // 2 and candY == nCell // 2:
                                    kc = self.makeCandidate(100.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                else:
                                    kc = self.makeCandidate(1.0,
                                                            candX * sizeCellX + sizeCellX // 2,
                                                            candY * sizeCellY + sizeCellY // 2)
                                kc.build(self.kList)
                                kernelCellSet.insertCandidate(kc)
                
                        kernelCellSet.visitCandidates(kpv, 1)
                        imagePca.analyze()
                        eigenImages = imagePca.getEigenImages()
                        eigenValues = imagePca.getEigenValues()
                
                        # took in 3 images
                        self.assertEqual(len(eigenImages), nCell * nCell)
                        self.assertEqual(len(eigenValues), nCell * nCell)
                
                        # all the same shape, only 1 eigenvalue
                        self.assertAlmostEqual(eigenValues[0], 1.0)
                        self.assertAlmostEqual(eigenValues[1], 0.0)
                        self.assertAlmostEqual(eigenValues[2], 0.0)
                        
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="2b197d36"/></a>2b197d36</h3>

<pre>
commit 2b197d360007a6c1f238d0d6e68149b046ce0f00
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 17 11:24:13 2012 -0800

    Added additional Pca test.
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_62"><a name="src/BuildSpatialKernelVisitor.cc"/></a>src/BuildSpatialKernelVisitor.cc</h1>

<h3 id="toc_63">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file BuildSpatialKernelVisitor.h
                 *
                 * @brief Implementation of BuildSpatialKernelVisitor 
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                
                #include "boost/shared_ptr.hpp" 
                #include "boost/timer.hpp" 
                
                #include "Eigen/Core"
                #include "Eigen/Cholesky"
                #include "Eigen/LU"
                #include "Eigen/QR"
                
                #include "lsst/afw/math.h"
                #include "lsst/afw/geom.h"
                #include "lsst/pex/policy/Policy.h"
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/KernelCandidate.h"
                #include "lsst/ip/diffim/KernelSolution.h"
                #include "lsst/ip/diffim/BuildSpatialKernelVisitor.h"
                
                namespace afwMath        = lsst::afw::math;
                namespace afwGeom        = lsst::afw::geom;
                namespace pexLogging     = lsst::pex::logging; 
                namespace pexPolicy      = lsst::pex::policy; 
                namespace pexExcept      = lsst::pex::exceptions; 
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                namespace detail {
                    /**
                     * @class BuildSpatialKernelVisitor
                     * @ingroup ip_diffim
                     *
                     * @brief Creates a spatial kernel and background from a list of candidates
                     *
                     * @code
                        Policy::Ptr policy(new Policy);
                        policy->set("spatialKernelOrder", spatialKernelOrder);
                        policy->set("spatialBgOrder", spatialBgOrder);
                        policy->set("kernelBasisSet", "delta-function");
                        policy->set("usePcaForSpatialKernel", true);
                    
                        detail::BuildSpatialKernelVisitor<PixelT> spatialKernelFitter(*basisListToUse, 
                                                                                      *policy);
                        kernelCells.visitCandidates(&spatialKernelFitter, nStarPerCell);
                        spatialKernelFitter.solveLinearEquation();
                        std::pair<afwMath::LinearCombinationKernel::Ptr, 
                            afwMath::Kernel::SpatialFunctionPtr> kb = spatialKernelFitter.getKernelSolution();
                        spatialKernel     = kb.first;
                        spatialBackground = kb.second; 
                     * @endcode
                     *
                     * @note After visiting all candidates, solveLinearEquation() must be called to
                     * trigger the matrix math.
                     *
                     * @note The user has the option to enfore conservation of the kernel sum across
                     * the image through the policy.  In this case, all terms but the first are fit
                     * for spatial variation.  This requires a little extra code to make sure the
                     * matrices are the correct size, and that it is accessing the appropriate terms
                     * in the matrices when creating the spatial models.
                     * 
                     */
                    template<typename PixelT>
                    BuildSpatialKernelVisitor<PixelT>::BuildSpatialKernelVisitor(
                        lsst::afw::math::KernelList const& basisList, ///< Basis functions used in the fit
                        lsst::afw::geom::Box2I const& regionBBox,     ///< Spatial region over which the function is fit
                        lsst::pex::policy::Policy policy              ///< Policy file directing behavior
                        ) :
                        afwMath::CandidateVisitor(),
                        _kernelSolution(),
                        _nCandidates(0) 
                    {
                        int spatialKernelOrder = policy.getInt("spatialKernelOrder");
                        afwMath::Kernel::SpatialFunctionPtr spatialKernelFunction;
                
                        int fitForBackground = policy.getBool("fitForBackground");
                        int spatialBgOrder   = fitForBackground ? policy.getInt("spatialBgOrder") : 0;
                        afwMath::Kernel::SpatialFunctionPtr background;
                
                        std::string spatialModelType = policy.getString("spatialModelType");
                        if (spatialModelType == "chebyshev1") {
                            spatialKernelFunction = afwMath::Kernel::SpatialFunctionPtr(
                                new afwMath::Chebyshev1Function2<double>(spatialKernelOrder, afwGeom::Box2D(regionBBox))
                                );
                            background = afwMath::Kernel::SpatialFunctionPtr(
                                new afwMath::Chebyshev1Function2<double>(spatialBgOrder, afwGeom::Box2D(regionBBox))
                                );
                
                        }
                        else if (spatialModelType == "polynomial") {
                            spatialKernelFunction = afwMath::Kernel::SpatialFunctionPtr(
                                new afwMath::PolynomialFunction2<double>(spatialKernelOrder)
                                );
                            background = afwMath::Kernel::SpatialFunctionPtr(
                                new afwMath::PolynomialFunction2<double>(spatialBgOrder)
                                );
                        }
                        else {
                            throw LSST_EXCEPT(pexExcept::Exception,
                                              str(boost::format("Invalid type (%s) for spatial models") % 
                                                  spatialModelType));
                        }
                
                        /* */
                
                        _kernelSolution = boost::shared_ptr<SpatialKernelSolution>(
                            new SpatialKernelSolution(basisList, spatialKernelFunction, background, policy));
                    };
                    
                    
                    template<typename PixelT>
                    void BuildSpatialKernelVisitor<PixelT>::processCandidate(
                        lsst::afw::math::SpatialCellCandidate *candidate
                        ) {
                        KernelCandidate<PixelT> *kCandidate = dynamic_cast<KernelCandidate<PixelT> *>(candidate);
                        if (kCandidate == NULL) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#c67c91dd">c67c91dd</a> -             throw LSST_EXCEPT(pexExcept::LogicErrorException,</div>
              ?                                                    ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::LogicError,</div>
                                              "Failed to cast SpatialCellCandidate to KernelCandidate");
                        }
                        if (!(kCandidate->isInitialized())) {
                            kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                            pexLogging::TTrace<3>("lsst.ip.diffim.BuildSpatialKernelVisitor.processCandidate", 
                                                  "Cannot process candidate %d, continuing", kCandidate->getId());
                            return;
                        }
                        
                        pexLogging::TTrace<6>("lsst.ip.diffim.BuildSpatialKernelVisitor.processCandidate", 
                                              "Processing candidate %d", kCandidate->getId());
                        _nCandidates += 1;
                
                        /* 
                           Build the spatial kernel from the most recent fit, e.g. if its Pca
                           you want to build a spatial model on the Pca basis, not original
                           basis 
                        */
                        _kernelSolution->addConstraint(kCandidate->getXCenter(),
                                                       kCandidate->getYCenter(),
                                                       kCandidate->getKernelSolution(
                                                           KernelCandidate<PixelT>::RECENT
                                                           )->getM(),
                                                       kCandidate->getKernelSolution(
                                                           KernelCandidate<PixelT>::RECENT
                                                           )->getB());
                        
                    }
                
                    template<typename PixelT>
                    void BuildSpatialKernelVisitor<PixelT>::solveLinearEquation() {
                        _kernelSolution->solve();
                    }
                
                    template<typename PixelT>
                    std::pair<afwMath::LinearCombinationKernel::Ptr, afwMath::Kernel::SpatialFunctionPtr>
                    BuildSpatialKernelVisitor<PixelT>::getSolutionPair() {
                        return _kernelSolution->getSolutionPair();
                    }
                
                    typedef float PixelT;
                    template class BuildSpatialKernelVisitor<PixelT>;
                  
                }}}} // end of namespace lsst::ip::diffim::detail
                    
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c67c91dd"/></a>c67c91dd</h3>

<pre>
commit c67c91dd4e81b9b72be671a573ee8a5c541bd30b
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Feb 27 21:32:29 2010 +0000

    Moved Visitor code into separate declaration and implementation files.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_64"><a name="examples/compareLambdaTypes.py"/></a>examples/compareLambdaTypes.py</h1>

<h3 id="toc_65">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#6b86b9d9">6b86b9d9</a> - import pdb</div>
                import sys
                import unittest
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#9250fe88">9250fe88</a> + </div>
                import lsst.utils.tests as tests
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#6b86b9d9">6b86b9d9</a> - import numpy as num</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#6b86b9d9">6b86b9d9</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.pex.logging as logging
                import lsst.pex.config as pexConfig
                
                import lsst.afw.display.ds9 as ds9
                
                verbosity = 7
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                display = True
                writefits = False
                
                # This one compares DeltaFunction kernels of different types; iterate lambdaVal for different strengths
                
                CFHTTORUN = 'cal-53535-i-797722_1'
                
                class DiffimTestCases(unittest.TestCase):
                    
                    # D = I - (K.x.T + bg)
                    def setUp(self, CFHT=True):
                        lambdaValue = 1.0
                
                        self.config1    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config1.kernel.name = "DF"
                        self.subconfig1 = self.config1.kernel.active
                
                        self.config2    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config2.kernel.name = "DF"
                        self.subconfig2 = self.config2.kernel.active
                
                        self.config3    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config3.kernel.name = "DF"
                        self.subconfig3 = self.config3.kernel.active
                
                        self.config4    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config4.kernel.name = "DF"
                        self.subconfig4 = self.config4.kernel.active
                
                        self.subconfig1.useRegularization = False
                        
                        self.subconfig2.useRegularization = True
                        self.subconfig2.lambdaType = "absolute"
                        self.subconfig2.lambdaValue = lambdaValue
                        self.subconfig2.regularizationType = "centralDifference"
                        self.subconfig2.centralRegularizationStencil = 5
                
                        self.subconfig3.useRegularization = True
                        self.subconfig3.lambdaType = "absolute"
                        self.subconfig3.lambdaValue = lambdaValue
                        self.subconfig3.regularizationType = "centralDifference"
                        self.subconfig3.centralRegularizationStencil = 9
                
                        self.subconfig4.useRegularization = True
                        self.subconfig4.lambdaType = "absolute"
                        self.subconfig4.lambdaValue = lambdaValue
                        self.subconfig4.regularizationType = "forwardDifference"
                        self.subconfig4.forwardRegularizationOrders = [1, 2]
                
                        
                
                        self.kList1 = ipDiffim.makeKernelBasisList(self.subconfig1)
                        self.bskv1  = ipDiffim.BuildSingleKernelVisitorF(self.kList1, pexConfig.makePolicy(self.subconfig1))
                
                        self.kList2 = ipDiffim.makeKernelBasisList(self.subconfig2)
                        self.hMat2  = ipDiffim.makeRegularizationMatrix(pexConfig.makePolicy(self.subconfig2))
                        self.bskv2  = ipDiffim.BuildSingleKernelVisitorF(self.kList2, pexConfig.makePolicy(self.subconfig2), self.hMat2)
                
                        self.kList3 = ipDiffim.makeKernelBasisList(self.subconfig3)
                        self.hMat3  = ipDiffim.makeRegularizationMatrix(pexConfig.makePolicy(self.subconfig3))
                        self.bskv3  = ipDiffim.BuildSingleKernelVisitorF(self.kList3, pexConfig.makePolicy(self.subconfig3), self.hMat3)
                
                        self.kList4 = ipDiffim.makeKernelBasisList(self.subconfig4)
                        self.hMat4  = ipDiffim.makeRegularizationMatrix(pexConfig.makePolicy(self.subconfig4))
                        self.bskv4  = ipDiffim.BuildSingleKernelVisitorF(self.kList4, pexConfig.makePolicy(self.subconfig4), self.hMat4)
                
                        # known input images
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#6b86b9d9">6b86b9d9</a> -         defDataDir = eups.productDir('afwdata')</div>
              ?                      ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#48e85303">48e85303</a> +         defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ?                      ^^^^^ ^^^  ^^^^^ ^^^^
                        if CFHT:
                            defSciencePath  = os.path.join(defDataDir, 'CFHT', 'D4', CFHTTORUN)
                            defTemplatePath = os.path.join(defDataDir, 'CFHT', 'D4', CFHTTORUN+'_tmpl')
                
                            # no need to remap
                            self.scienceExposure   = afwImage.ExposureF(defSciencePath)
                            self.templateExposure  = afwImage.ExposureF(defTemplatePath)
                        else:
                            defSciencePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v26-e0",
                                                          "v26-e0-c011-a00.sci")
                            defTemplatePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                           "v5-e0-c011-a00.sci")
                            
                            self.scienceExposure   = afwImage.ExposureF(defSciencePath)
                            self.templateExposure  = afwImage.ExposureF(defTemplatePath)
                            warper = afwMath.Warper.fromConfig(self.subconfig1.warpingConfig)
                            self.templateExposure = warper.warpExposure(self.scienceExposure.getWcs(), self.templateExposure,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#34a6008a">34a6008a</a> -                                                         destBBox = self.scienceExposure.getBBox(afwImage.PARENT))</div>
              ?                                                                                                 ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#9250fe88">9250fe88</a> +                                                         destBBox = self.scienceExposure.getBBox())</div>
                
                        diffimTools.backgroundSubtract(self.subconfig1.afwBackgroundConfig,
                                                       [self.scienceExposure.getMaskedImage(),
                                                        self.templateExposure.getMaskedImage()])
                
                        # image statistics
                        self.dStats  = ipDiffim.ImageStatisticsF()
                
                        #
                        tmi = self.templateExposure.getMaskedImage()
                        smi = self.scienceExposure.getMaskedImage()
                        
                        detConfig = self.subconfig1.detectionConfig
                        detPolicy = pexConfig.makePolicy(detConfig)
                        detPolicy.set("detThreshold", 50.)
                        detPolicy.set("detOnTemplate", False)
                        kcDetect = ipDiffim.KernelCandidateDetectionF(detPolicy)
                        kcDetect.apply(tmi, smi)
                        self.footprints = kcDetect.getFootprints()
                        
                    def tearDown(self):
                        del self.subconfig1
                        del self.subconfig2
                        del self.subconfig3
                        del self.subconfig4
                        del self.kList1
                        del self.kList2
                        del self.kList3
                        del self.kList4
                        del self.hMat2
                        del self.bskv1
                        del self.bskv2
                        del self.bskv3
                        del self.bskv4
                        del self.scienceExposure
                        del self.templateExposure
                
                    def apply(self, policy, visitor, xloc, yloc, tmi, smi):
                        kc     = ipDiffim.makeKernelCandidate(xloc, yloc, tmi, smi, policy)
                        visitor.processCandidate(kc)
                        kim    = kc.getKernelImage(ipDiffim.KernelCandidateF.RECENT)
                        diffIm = kc.getDifferenceImage(ipDiffim.KernelCandidateF.RECENT)
                        kSum   = kc.getKsum(ipDiffim.KernelCandidateF.RECENT)
                        bg     = kc.getBackground(ipDiffim.KernelCandidateF.RECENT)
                
                        bbox = kc.getKernel(ipDiffim.KernelCandidateF.RECENT).shrinkBBox(diffIm.getBBox(afwImage.LOCAL))
                        diffIm = afwImage.MaskedImageF(diffIm, bbox, afwImage.LOCAL)
                        self.dStats.apply(diffIm)
                        
                        dmean = afwMath.makeStatistics(diffIm.getImage(),    afwMath.MEAN).getValue()
                        dstd  = afwMath.makeStatistics(diffIm.getImage(),    afwMath.STDEV).getValue()
                        vmean = afwMath.makeStatistics(diffIm.getVariance(), afwMath.MEAN).getValue()
                        return kSum, bg, dmean, dstd, vmean, kim, diffIm, kc
                        
                    def applyVisitor(self, invert=False, xloc=397, yloc=580):
                        print '# %.2f %.2f' % (xloc, yloc)
                        #if xloc != 1312 and yloc != 160:
                        #    return
                        
                        imsize = int(3 * self.subconfig1.kernelSize)
                
                        # chop out a region around a known object
                        bbox = afwGeom.Box2I(afwGeom.Point2I(xloc - imsize/2,
                                                             yloc - imsize/2),
                                             afwGeom.Point2I(xloc + imsize/2,
                                                             yloc + imsize/2) )
                
                        # sometimes the box goes off the image; no big deal...
                        try:
                            if invert:
                                tmi  = afwImage.MaskedImageF(self.scienceExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                                smi  = afwImage.MaskedImageF(self.templateExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                            else:
                                smi  = afwImage.MaskedImageF(self.scienceExposure.getMaskedImage(), bbox, afwImage.LOCAL)
                                tmi  = afwImage.MaskedImageF(self.templateExposure.getMaskedImage(), bbox, afwImage.LOCAL)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#6b86b9d9">6b86b9d9</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#9250fe88">9250fe88</a> +         except Exception:</div>
                            return None
                
                        # delta function kernel
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, 'DF run')
                        results1 = self.apply(pexConfig.makePolicy(self.subconfig1), self.bskv1, xloc, yloc, tmi, smi)
                        kSum1, bg1, dmean1, dstd1, vmean1, kImageOut1, diffIm1, kc1 = results1
                        res = 'DF residuals : %.3f +/- %.3f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                             self.dStats.getRms(),
                                                                                             kSum1, bg1,
                                                                                             dmean1, dstd1, vmean1)
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, res)
                        if display:
                            ds9.mtv(tmi, frame=1) # ds9 switches frame 0 and 1 for some reason
                            ds9.mtv(smi, frame=0)
                            ds9.mtv(kImageOut1, frame=2)
                            ds9.mtv(diffIm1, frame=3)
                        if writefits:
                            tmi.writeFits('t.fits')
                            smi.writeFits('s.fits')
                            kImageOut1.writeFits('k1.fits')
                            diffIm1.writeFits('d1.fits')
                
                        # regularized delta function kernel
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, 'DFrC5 run')
                        results2 = self.apply(pexConfig.makePolicy(self.subconfig2), self.bskv2, xloc, yloc, tmi, smi)
                        kSum2, bg2, dmean2, dstd2, vmean2, kImageOut2, diffIm2, kc2 = results2
                        res = 'DFrC5 residuals : %.3f +/- %.3f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                self.dStats.getRms(),
                                                                                                kSum2, bg2,
                                                                                                dmean2, dstd2, vmean2)
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, res)
                        if display:
                            ds9.mtv(tmi, frame=4)
                            ds9.mtv(smi, frame=5)
                            ds9.mtv(kImageOut2, frame=6)
                            ds9.mtv(diffIm2, frame=7)
                        if writefits:
                            kImageOut2.writeFits('k2.fits')
                            diffIm2.writeFits('d2')
                
                
                        # regularized delta function kernel
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, 'DFrC9 run')
                        results3 = self.apply(pexConfig.makePolicy(self.subconfig3), self.bskv3, xloc, yloc, tmi, smi)
                        kSum3, bg3, dmean3, dstd3, vmean3, kImageOut3, diffIm3, kc3 = results3
                        res = 'DFrC9 residuals : %.3f +/- %.3f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                self.dStats.getRms(),
                                                                                                kSum3, bg3,
                                                                                                dmean3, dstd3, vmean3)
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, res)
                        if display:
                            ds9.mtv(tmi, frame=8)
                            ds9.mtv(smi, frame=9)
                            ds9.mtv(kImageOut3, frame=10)
                            ds9.mtv(diffIm3, frame=11)
                        if writefits:
                            kImageOut2.writeFits('k3.fits')
                            diffIm2.writeFits('d3')
                
                        # regularized delta function kernel
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, 'DFrF12 run')
                        results4 = self.apply(pexConfig.makePolicy(self.subconfig4), self.bskv4, xloc, yloc, tmi, smi)
                        kSum4, bg4, dmean4, dstd4, vmean4, kImageOut4, diffIm4, kc4 = results4
                        res = 'DFrF12 residuals : %.3f +/- %.3f; %.2f, %.2f; %.2f %.2f, %.2f' % (self.dStats.getMean(),
                                                                                                 self.dStats.getRms(),
                                                                                                 kSum4, bg4,
                                                                                                 dmean4, dstd4, vmean4)
                        logging.Trace("lsst.ip.diffim.compareLambdaTypes", 1, res)
                        if display:
                            ds9.mtv(tmi, frame=12)
                            ds9.mtv(smi, frame=13)
                            ds9.mtv(kImageOut4, frame=14)
                            ds9.mtv(diffIm4, frame=15)
                        if writefits:
                            kImageOut2.writeFits('k4.fits')
                            diffIm2.writeFits('d4')
                
                
                        raw_input('Next: ')
                
                    def testFunctor(self):
                        for fp in self.footprints:
                            # note this returns the kernel images
                            self.applyVisitor(invert=False, 
                                              xloc= int(0.5 * ( fp.getBBox().getMinX() + fp.getBBox().getMaxX() )),
                                              yloc= int(0.5 * ( fp.getBBox().getMinY() + fp.getBBox().getMaxY() )))
                       
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    if '-d' in sys.argv:
                        display = True
                    if '-w' in sys.argv:
                        writefits = True
                
                    if len(sys.argv) > 1:
                        CFHTTORUN = sys.argv[1]
                
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6b86b9d9"/></a>6b86b9d9</h3>

<pre>
commit 6b86b9d92082b143453e1a51065b01f213121f2f
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Apr 13 18:33:51 2011 +0000

    example code
</pre>
<h3><a name="34a6008a"/></a>34a6008a</h3>

<pre>
commit 34a6008a067d12ac23be3fb18973822226866b4f
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 15 11:36:59 2012 -0800

    Fixed cross-correlation scripts and comparison of regularization types
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_66"><a name="python/lsst/ip/diffim/__init__.py"/></a>python/lsst/ip/diffim/<strong>init</strong>.py</h1>

<h3 id="toc_67">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                from .version import *
                
                # c wrapper
                from .diffimLib import *
                
                # python code
                from psfMatch import *
                from imagePsfMatch import *
                from modelPsfMatch import *
                from snapPsfMatch import *
                from diaSourceAnalysis import *
                from makeKernelBasisList import *
                from diaCatalogSourceSelector import *
                from dipoleMeasurement import *
                from diffimTools import *
                from kernelCandidateQa import *
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#c0b62a68">c0b62a68</a> + from lsst.meas.base import wrapSimpleAlgorithm</div>
                
                # automatically register ip_diffim Algorithms
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#6956e0d1">6956e0d1</a> - import lsst.meas.algorithms</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#6956e0d1">6956e0d1</a> - lsst.meas.algorithms.AlgorithmRegistry.register("centroid.dipole.naive", NaiveDipoleCentroidControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#6956e0d1">6956e0d1</a> - lsst.meas.algorithms.AlgorithmRegistry.register("flux.dipole.naive", NaiveDipoleFluxControl)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#6956e0d1">6956e0d1</a> - lsst.meas.algorithms.AlgorithmRegistry.register("flux.dipole.psf", PsfDipoleFluxControl)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#c0b62a68">c0b62a68</a> + wrapSimpleAlgorithm(NaiveDipoleCentroid, Control=DipoleCentroidControl, executionOrder=0.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#c0b62a68">c0b62a68</a> + wrapSimpleAlgorithm(NaiveDipoleFlux, Control=DipoleFluxControl, executionOrder=2.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#c0b62a68">c0b62a68</a> + wrapSimpleAlgorithm(PsfDipoleFlux, Control=PsfDipoleFluxControl, executionOrder=2.0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#c0b62a68">c0b62a68</a> + </div>
                del lsst # cleanup namespace
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="6956e0d1"/></a>6956e0d1</h3>

<pre>
commit 6956e0d109421a99b9c8f8a554e463d813a6ca9b
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 5 09:40:01 2013 -0800

    Automatically register ip_diffim Algorithms in __init__.py.  #2595
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_68"><a name="ups/ip_diffim.cfg"/></a>ups/ip_diffim.cfg</h1>

<h3 id="toc_69">Diff:</h3>

<pre>
                # -*- python -*-
                
                import lsst.sconsUtils
                
                dependencies = {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#4f492088">4f492088</a> -     "required": ["meas_algorithms", "afw", "numpy"],</div>
              ?                         --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c0b62a68">c0b62a68</a> +     "required": ["meas_base", "afw", "numpy"],</div>
              ?                        +  +
                    "buildRequired": ["boost_test", "swig"],
                }
                
                config = lsst.sconsUtils.Configuration(
                    __file__,
                    headers=["lsst/ip/diffim.h"],
                    hasDoxygenInclude=False,
                    hasSwigFiles=True,
                )
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="4f492088"/></a>4f492088</h3>

<pre>
commit 4f4920881e1acbc27eb952396ba61384f70becd6
Author: Paul Price <price@astro.princeton.edu>
Date:   Mon Jan 28 18:17:53 2013 -0500

    Now we need meas_algorithms.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="c0b62a68"/></a>c0b62a68</h3>

<pre>
commit c0b62a6871d3e2e5587df3626ef9a9c4fdc321f5
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Mon Jan 5 12:24:21 2015 -0800

    DM-980 Move ip_diffim to meas_base framework
    
     Please enter the commit message for your changes. Lines starting
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_70"><a name="src/KernelCandidateDetection.cc"/></a>src/KernelCandidateDetection.cc</h1>

<h3 id="toc_71">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file
                 *
                 * @brief Implementation of KernelCandidateDetection class
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                
                #include "lsst/afw/geom.h"
                #include "lsst/afw/image.h"
                #include "lsst/afw/detection.h"
                #include "lsst/pex/exceptions/Exception.h"
                #include "lsst/pex/policy/Policy.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/FindSetBits.h"
                #include "lsst/ip/diffim/KernelCandidateDetection.h"
                
                namespace afwGeom   = lsst::afw::geom;
                namespace afwImage  = lsst::afw::image;
                namespace afwDetect = lsst::afw::detection;
                namespace pexLog    = lsst::pex::logging; 
                namespace pexExcept = lsst::pex::exceptions; 
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                
                    
                    template <typename PixelT>
                    KernelCandidateDetection<PixelT>::KernelCandidateDetection(
                        lsst::pex::policy::Policy const& policy
                        ) :
                        _policy(policy), 
                        _badBitMask(0), 
                        _footprints(std::vector<lsst::afw::detection::Footprint::Ptr>()) {
                
                        std::vector<std::string> detBadMaskPlanes = _policy.getStringArray("badMaskPlanes");
                        for (std::vector<std::string>::iterator mi = detBadMaskPlanes.begin(); 
                             mi != detBadMaskPlanes.end(); ++mi){
                            try {
                                _badBitMask |= afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask(*mi);
                            } catch (pexExcept::Exception& e) {
                                pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection",
                                                  "Cannot update bad bit mask with %s", (*mi).c_str());
                                pexLog::TTrace<7>("lsst.ip.diffim.KernelCandidateDetection",
                                                  e.what());
                            }
                        }
                        pexLog::TTrace<4>("lsst.ip.diffim.KernelCandidateDetection", 
                                          "Using bad bit mask %d", _badBitMask);
                    }
                        
                        
                
                    /** 
                     * @brief Runs Detection on a single image for significant peaks, and checks
                     * returned Footprints for Masked pixels.
                     *
                     * @note Accepts two MaskedImages, one of which is to be convolved to match the
                     * other.  The Detection package is run on either the image to be convolved
                     * (assumed to be higher S/N than the other image), or the image to not be
                     * convolved (assumed lower S/N; however if you run detection on a very deep
                     * template, you might not have significant S/N objects in the science image).
                     * The subimages associated with each returned Footprint in both images are
                     * checked for Masked pixels; Footprints containing Masked pixels are rejected.
                     * The Footprints are grown by an amount specified in the Policy.  The
                     * acceptible Footprints are returned in a vector.
                     *
                     * @return Vector of "clean" Footprints around which Image Subtraction
                     * Kernels will be built.
                     *
                     */
                    template <typename PixelT>
                    void KernelCandidateDetection<PixelT>::apply(
                        MaskedImagePtr const& templateMaskedImage,
                        MaskedImagePtr const& scienceMaskedImage
                        ) {
                        
                        // Parse the Policy
                        int fpNpixMin                = _policy.getInt("fpNpixMin");
                        int fpGrowPix                = _policy.getInt("fpGrowPix");
                        
                        bool detOnTemplate           = _policy.getBool("detOnTemplate");
                        double detThreshold          = _policy.getDouble("detThreshold");
                        std::string detThresholdType = _policy.getString("detThresholdType");
                
                        /* reset private variables */
                        _footprints.clear();
                
                        // List of Footprints
                        boost::shared_ptr<std::vector<afwDetect::Footprint::Ptr> > footprintListInPtr;
                
                        // Find detections
                        afwDetect::Threshold threshold = 
                            afwDetect::createThreshold(detThreshold, detThresholdType);
                
                        if (detOnTemplate == true) {
                            afwDetect::FootprintSet footprintSet(
                                *(templateMaskedImage), 
                                threshold,
                                "",
                                fpNpixMin);
                            // Get the associated footprints
                
                            footprintListInPtr = footprintSet.getFootprints();
                            pexLog::TTrace<4>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                              "Found %d total footprints in template above %.3f %s",
                                              footprintListInPtr->size(), detThreshold, detThresholdType.c_str());
                        }
                        else {
                            afwDetect::FootprintSet footprintSet(
                                *(scienceMaskedImage), 
                                threshold,
                                "",
                                fpNpixMin);
                            
                            footprintListInPtr = footprintSet.getFootprints();
                            pexLog::TTrace<4>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                              "Found %d total footprints in science image above %.3f %s",
                                              footprintListInPtr->size(), detThreshold, detThresholdType.c_str());
                        }    
                        
                        // Iterate over footprints, look for "good" ones
                        for (std::vector<afwDetect::Footprint::Ptr>::iterator i = footprintListInPtr->begin(); 
                             i != footprintListInPtr->end(); ++i) {
                            
                            pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                              "Processing footprint %d", (*i)->getId());
                            growCandidate((*i), fpGrowPix, templateMaskedImage, scienceMaskedImage);
                        }
                        
                        if (_footprints.size() == 0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Unable to find any footprints for Psf matching");
                        }
                        
                        pexLog::TTrace<1>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                          "Found %d clean footprints above threshold %.3f",
                                          _footprints.size(), detThreshold);
                        
                    }
                    
                    template <typename PixelT>
                    bool KernelCandidateDetection<PixelT>::growCandidate(
                        lsst::afw::detection::Footprint::Ptr fp, 
                        int fpGrowPix,
                        MaskedImagePtr const& templateMaskedImage,
                        MaskedImagePtr const& scienceMaskedImage
                        ) {
                        int fpNpixMax = _policy.getInt("fpNpixMax");
                
                        /* Functor to search through the images for masked pixels within *
                         * candidate footprints.  Might want to consider changing the default
                         * mask planes it looks through.
                         */
                        FindSetBits<afwImage::Mask<afwImage::MaskPixel> > fsb;
                        
                        afwGeom::Box2I fpBBox = fp->getBBox();
                        /* Failure Condition 1) 
                         * 
                         * Footprint has too many pixels off the bat.  We don't want to throw
                         * away these guys, they have alot of signal!  Lets just use the core of
                         * it.
                         * 
                         */
                        if (fp->getNpix() > fpNpixMax) {
                            pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                              "Footprint has too many pix: %d (max =%d)", 
                                              fp->getNpix(), fpNpixMax);
                            
                            int xc = int(0.5 * (fpBBox.getMinX() + fpBBox.getMaxX()));
                            int yc = int(0.5 * (fpBBox.getMinY() + fpBBox.getMaxY()));
                            afwDetect::Footprint::Ptr fpCore(
                                new afwDetect::Footprint(afwGeom::Box2I(afwGeom::Point2I(xc, yc), afwGeom::Extent2I(1,1)))
                                );
                            return growCandidate(fpCore, fpGrowPix, templateMaskedImage, scienceMaskedImage);
                        } 
                
                        pexLog::TTrace<8>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                          "Original footprint in parent : %d,%d -> %d,%d -> %d,%d",
                                          fpBBox.getMinX(), fpBBox.getMinY(), 
                                          int(0.5 * (fpBBox.getMinX() + fpBBox.getMaxX())),
                                          int(0.5 * (fpBBox.getMinY() + fpBBox.getMaxY())),
                                          fpBBox.getMaxX(), fpBBox.getMaxY());
                        
                        /* Grow the footprint
                         * flag true  = isotropic grow   = slow
                         * flag false = 'manhattan grow' = fast
                         * 
                         * The manhattan masks are rotated 45 degree w.r.t. the coordinate
                         * system.  They intersect the vertices of the rectangle that would
                         * connect pixels (X0,Y0) (X1,Y0), (X0,Y1), (X1,Y1).
                         * 
                         * The isotropic masks do take considerably longer to grow and are
                         * basically elliptical.  X0, X1, Y0, Y1 delimit the extent of the
                         * ellipse.
                         * 
                         * In both cases, since the masks aren't rectangles oriented with
                         * the image coordinate system, when we DO extract such rectangles
                         * as subimages for kernel fitting, some corner pixels can be found
                         * in multiple subimages.
                         * 
                         */
                        afwDetect::Footprint::Ptr fpGrow = 
                            afwDetect::growFootprint(fp, fpGrowPix, false);
                        
                        /* Next we look at the image within this Footprint.  
                         */
                        afwGeom::Box2I fpGrowBBox = fpGrow->getBBox();
                        pexLog::TTrace<8>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                          "Grown footprint in parent : %d,%d -> %d,%d -> %d,%d",
                                          fpGrowBBox.getMinX(), fpGrowBBox.getMinY(), 
                                          int(0.5 * (fpGrowBBox.getMinX() + fpGrowBBox.getMaxX())),
                                          int(0.5 * (fpGrowBBox.getMinY() + fpGrowBBox.getMaxY())),
                                          fpGrowBBox.getMaxX(), fpGrowBBox.getMaxY());
                
                        /* Failure Condition 2) 
                         * Grown off the image
                         */
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#ec2f65f1">ec2f65f1</a> -         if (!(templateMaskedImage->getBBox(afwImage::PARENT).contains(fpGrowBBox))) {</div>
              ?                                            ----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#9250fe88">9250fe88</a> +         if (!(templateMaskedImage->getBBox().contains(fpGrowBBox))) {</div>
                            pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                              "Footprint grown off image"); 
                            return false;
                        }
                        
                        /* Grab subimages; report any exception */
                        bool subimageHasFailed = false;
                        try {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#ec2f65f1">ec2f65f1</a> -             afwImage::MaskedImage<PixelT> templateSubimage(*templateMaskedImage, fpGrowBBox, </div>
              ?                                                                                            ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#9250fe88">9250fe88</a> +             afwImage::MaskedImage<PixelT> templateSubimage(*templateMaskedImage, fpGrowBBox);</div>
              ?                                                                                            ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#1fdd0bb7">1fdd0bb7</a> -                                                              afwImage::PARENT);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#ec2f65f1">ec2f65f1</a> -             afwImage::MaskedImage<PixelT> scienceSubimage(*scienceMaskedImage, fpGrowBBox, </div>
              ?                                                                                          ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#9250fe88">9250fe88</a> +             afwImage::MaskedImage<PixelT> scienceSubimage(*scienceMaskedImage, fpGrowBBox);</div>
              ?                                                                                          ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#1fdd0bb7">1fdd0bb7</a> -                                                                 afwImage::PARENT);</div>
                            
                            // Search for any masked pixels within the footprint
                            fsb.apply(*(templateSubimage.getMask()));
                            if (fsb.getBits() & _badBitMask) {
                                pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                                  "Footprint has masked pix (vals=%d) in image to convolve", 
                                                  fsb.getBits()); 
                                subimageHasFailed = true;
                            }
                            
                            fsb.apply(*(scienceSubimage.getMask()));
                            if (fsb.getBits() & _badBitMask) {
                                pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply", 
                                                  "Footprint has masked pix (vals=%d) in image not to convolve", 
                                                  fsb.getBits());
                                subimageHasFailed = true;
                            }
                            
                        } catch (pexExcept::Exception& e) {
                            pexLog::TTrace<6>("lsst.ip.diffim.KernelCandidateDetection.apply",
                                              "Exception caught extracting Footprint");
                            pexLog::TTrace<7>("lsst.ip.diffim.KernelCandidateDetection.apply",
                                              e.what());
                            subimageHasFailed = true;
                        }
                        if (subimageHasFailed) {
                            return false;
                        } else {
                            /* We have a good candidate */
                            _footprints.push_back(fpGrow);
                            return true;
                        }
                    }
                
                /***********************************************************************************************************/
                //
                // Explicit instantiations
                //
                    typedef float PixelT;
                    template class KernelCandidateDetection<PixelT>;
                
                }}} // end of namespace lsst::ip::diffim
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="1fdd0bb7"/></a>1fdd0bb7</h3>

<pre>
commit 1fdd0bb7e8e67d1a5e7ab119e8445801cc89de8e
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Apr 19 21:45:56 2011 +0000

    Additional edits to clean up the BBox LOCAL vs. PARENT change.  #1140.
</pre>
<h3><a name="ec2f65f1"/></a>ec2f65f1</h3>

<pre>
commit ec2f65f1f72311b644f7ab2640a9f7f96912fdf4
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jan 8 14:36:44 2013 -0800

    Renaming of variables from e.g. "exposure to convolve" to "template exposure".  reads far easier.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_72"><a name="tests/ImageSubtract.py"/></a>tests/ImageSubtract.py</h1>

<h3 id="toc_73">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#efc59e9e">efc59e9e</a> - import pdb</div>
                import sys
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#6ec2c185">6ec2c185</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as logging
                
                verbosity = 4
                logging.Trace_setVerbosity('lsst.ip.diffim', verbosity)
                
                # This one tests convolve and subtract
                
                class DiffimTestCases(unittest.TestCase):
                    
                    # D = I - (K.x.T + bg)
                        
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "AL"
                        self.subconfig = self.config.kernel.active
                        self.kSize     = self.subconfig.kernelSize
                
                        # gaussian reference kernel
                        self.gSize         = self.kSize
                        self.gaussFunction = afwMath.GaussianFunction2D(2, 3)
                        self.gaussKernel   = afwMath.AnalyticKernel(self.gSize, self.gSize, self.gaussFunction)
                
                        # known input images
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#48e85303">48e85303</a> +         try:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#bc154744">bc154744</a> -         self.defDataDir = eups.productDir('afwdata')</div>
              ?                           ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#48e85303">48e85303</a> +             self.defDataDir = lsst.utils.getPackageDir('afwdata')</div>
              ? ++++                          ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#48e85303">48e85303</a> +         except Exception:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#48e85303">48e85303</a> +             self.defDataDir = None</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#48e85303">48e85303</a> + </div>
                        if self.defDataDir:
                            defImagePath = os.path.join(self.defDataDir, "DC3a-Sim", "sci", "v5-e0",
                                                        "v5-e0-c011-a00.sci.fits")
                            self.templateImage  = afwImage.MaskedImageF(defImagePath)
                            self.scienceImage   = self.templateImage.Factory( self.templateImage.getDimensions() )
                            
                            afwMath.convolve(self.scienceImage, self.templateImage, self.gaussKernel, False)
                
                    def tearDown(self):
                        del self.subconfig
                        del self.gaussFunction
                        del self.gaussKernel
                        if self.defDataDir:
                            del self.templateImage
                            del self.scienceImage
                
                    def runConvolveAndSubtract1(self, bgVal = 0, xloc = 408, yloc = 580):
                        imsize = int(5 * self.kSize)
                
                        p0 = afwGeom.Point2I(xloc - imsize/2, yloc - imsize/2)
                        p1 = afwGeom.Point2I(xloc + imsize/2, yloc + imsize/2)
                        bbox = afwGeom.Box2I(p0, p1)
                
                        tmi     = afwImage.MaskedImageF(self.templateImage, bbox, afwImage.LOCAL)
                        smi     = afwImage.MaskedImageF(self.scienceImage, bbox, afwImage.LOCAL)
                        diffIm  = ipDiffim.convolveAndSubtract(tmi, smi, self.gaussKernel, bgVal)
                
                        bbox = self.gaussKernel.shrinkBBox(diffIm.getBBox(afwImage.LOCAL))
                        diffIm2 = afwImage.MaskedImageF(diffIm, bbox, afwImage.LOCAL)
                
                        # image is empty (or the additional background you subtracted off)
                        for j in range(diffIm2.getHeight()):
                            for i in range(diffIm2.getWidth()):
                                self.assertAlmostEqual(diffIm2.getImage().get(i, j), -1.*bgVal, 3)
                
                    def runConvolveAndSubtract2(self, bgOrder=0, xloc = 408, yloc = 580):
                        imsize = int(5 * self.kSize)
                
                        p0 = afwGeom.Point2I(xloc - imsize/2, yloc - imsize/2)
                        p1 = afwGeom.Point2I(xloc + imsize/2, yloc + imsize/2)
                        bbox = afwGeom.Box2I(p0, p1)
                
                        tmi     = afwImage.MaskedImageF(self.templateImage, bbox, afwImage.LOCAL)
                        smi     = afwImage.MaskedImageF(self.scienceImage, bbox, afwImage.LOCAL)
                        bgFunc  = afwMath.PolynomialFunction2D(bgOrder)  # coeffs are 0. by default
                        diffIm  = ipDiffim.convolveAndSubtract(tmi, smi, self.gaussKernel, bgFunc)
                
                        bbox = self.gaussKernel.shrinkBBox(diffIm.getBBox(afwImage.LOCAL))
                        diffIm2 = afwImage.MaskedImageF(diffIm, bbox, afwImage.LOCAL)
                        for j in range(diffIm2.getHeight()):
                            for i in range(diffIm2.getWidth()):
                                self.assertAlmostEqual(diffIm2.getImage().get(i, j), 0., 4)
                
                
                    def testConvolveAndSubtract(self):
                        if not self.defDataDir:
                            print >> sys.stderr, "Warning: afwdata is not set up"
                            return
                
                        self.runConvolveAndSubtract1(bgVal=0)
                        self.runConvolveAndSubtract1(bgVal=10)
                        # this one uses a function
                        self.runConvolveAndSubtract2(bgOrder=0)
                        self.runConvolveAndSubtract2(bgOrder=2)
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="efc59e9e"/></a>efc59e9e</h3>

<pre>
commit efc59e9e500288a569c008ea7b3ada3a26195942
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Dec 18 23:26:01 2009 +0000

    Python code up to standards.
</pre>
<h3><a name="bc154744"/></a>bc154744</h3>

<pre>
commit bc15474449bb3d27993b65dcf80dd9955f365e53
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Sep 21 18:55:23 2009 +0000

    Updated unit tests to fail gracefull if afwdata is not set up.  #918.
</pre>
<h3><a name="6ec2c185"/></a>6ec2c185</h3>

<pre>
commit 6ec2c185f694175d08be9b3649a3a226bd75f95f
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Mar 10 23:34:10 2009 +0000

    Working on unit test code; incomplete.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_74"><a name="examples/comparePcaKernel.py"/></a>examples/comparePcaKernel.py</h1>

<h3 id="toc_75">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import os
                import sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#3d72c087">3d72c087</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image.imageLib as afwImage
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLogging
                import lsst.pex.config as pexConfig
                import lsst.afw.display.ds9 as ds9
                
                display = True
                
                verbosity = 5
                pexLogging.Trace_setVerbosity("lsst.ip.diffim", verbosity)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#3d72c087">3d72c087</a> - defDataDir   = eups.productDir("afwdata") </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#3d72c087">3d72c087</a> - imageProcDir = eups.productDir("ip_diffim")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#48e85303">48e85303</a> + defDataDir   = lsst.utils.getPackageDir('afwdata')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#48e85303">48e85303</a> + imageProcDir = lsst.utils.getPackageDir('ip_diffim')</div>
                
                if len(sys.argv) == 1:
                    defTemplatePath = os.path.join(defDataDir, "CFHT", "D4", "cal-53535-i-797722_2_tmpl")
                    defSciencePath  = os.path.join(defDataDir, "CFHT", "D4", "cal-53535-i-797722_2")
                    templateMaskedImage = afwImage.MaskedImageF(defTemplatePath)
                    scienceMaskedImage  = afwImage.MaskedImageF(defSciencePath)
                    bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(512, 512))
                    templateMaskedImage = afwImage.MaskedImageF(templateMaskedImage, bbox, afwImage.LOCAL)
                    scienceMaskedImage  = afwImage.MaskedImageF(scienceMaskedImage, bbox, afwImage.LOCAL)
                    
                elif len(sys.argv) == 3:
                    defTemplatePath = sys.argv[1]
                    defSciencePath  = sys.argv[2]
                    templateMaskedImage = afwImage.MaskedImageF(defTemplatePath)
                    scienceMaskedImage  = afwImage.MaskedImageF(defSciencePath)
                else:
                    sys.exit(1)
                    
                
                configAL    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                configAL.kernel.name = "AL"
                subconfigAL = configAL.kernel.active
                
                configDF    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                configDF.kernel.name = "DF"
                subconfigDF = configDF.kernel.active
                
                configDFr    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                configDFr.kernel.name = "DF"
                subconfigDFr = configDFr.kernel.active
                
                subconfigDF.useRegularization  = False
                subconfigDFr.useRegularization = True
                
                for param in [["spatialKernelOrder", 0],
                              ["spatialBgOrder", 0],
                              ["usePcaForSpatialKernel", True],
                              ["fitForBackground", True]]:
                    exec("subconfigAL.%s = %s" % (param[0], param[1]))
                    exec("subconfigDF.%s = %s" % (param[0], param[1]))
                    exec("subconfigDFr.%s = %s" % (param[0], param[1]))
                
                detConfig = subconfigAL.detectionConfig
                kcDetect = ipDiffim.KernelCandidateDetectionF(pexConfig.makePolicy(detConfig))
                kcDetect.apply(templateMaskedImage, scienceMaskedImage)
                footprints = kcDetect.getFootprints()
                
                # delta function
                psfmatch1 = ipDiffim.ImagePsfMatchTask(config=configDF)
                results1  = psfmatch1.run(templateMaskedImage, scienceMaskedImage, 
                                          "subtractMaskedImages", candidateList = footprints)
                diffim1        = results1.subtractedImage
                spatialKernel1 = results1.psfMatchingKernel
                spatialBg1     = results1.backgroundModel
                kernelCellSet1 = results1.kernelCellSet
                
                # alard lupton
                psfmatch2 = ipDiffim.ImagePsfMatchTask(config=configAL)
                results2  = psfmatch2.run(templateMaskedImage, scienceMaskedImage, 
                                          "subtractMaskedImages", candidateList = footprints)
                diffim2        = results2.subtractedImage
                spatialKernel2 = results2.psfMatchingKernel
                spatialBg2     = results2.backgroundModel
                kernelCellSet2 = results2.kernelCellSet
                
                # regularized delta function
                psfmatch3 = ipDiffim.ImagePsfMatchTask(config=configDFr)
                results3  = psfmatch3.run(templateMaskedImage, scienceMaskedImage, 
                                          "subtractMaskedImages", candidateList = footprints)
                diffim3        = results3.subtractedImage
                spatialKernel3 = results3.psfMatchingKernel
                spatialBg3     = results3.backgroundModel
                kernelCellSet3 = results3.kernelCellSet
                
                
                basisList1 = spatialKernel1.getKernelList()
                basisList2 = spatialKernel2.getKernelList()
                basisList3 = spatialKernel3.getKernelList()
                
                frame = 1
                for idx in range(min(5, len(basisList1))):
                    kernel = basisList1[idx]
                    im     = afwImage.ImageD(spatialKernel1.getDimensions())
                    ksum   = kernel.computeImage(im, False)    
                    ds9.mtv(im, frame=frame)
                    frame += 1
                
                for idx in range(min(5, len(basisList2))):
                    kernel = basisList2[idx]
                    im     = afwImage.ImageD(spatialKernel2.getDimensions())
                    ksum   = kernel.computeImage(im, False)    
                    ds9.mtv(im, frame=frame)
                    frame += 1
                
                
                for idx in range(min(5, len(basisList3))):
                    kernel = basisList3[idx]
                    im     = afwImage.ImageD(spatialKernel3.getDimensions())
                    ksum   = kernel.computeImage(im, False)    
                    ds9.mtv(im, frame=frame)
                    frame += 1
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="3d72c087"/></a>3d72c087</h3>

<pre>
commit 3d72c087dadc0403b5671fb0bdfe761e2590335b
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Oct 23 17:33:31 2009 +0000

    Adding 2 examples.  #876.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_76"><a name="tests/diaCatalogSourceSelector.py"/></a>tests/diaCatalogSourceSelector.py</h1>

<h3 id="toc_77">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import unittest
                import numpy as np
                import lsst.utils.tests as tests
                import lsst.afw.table as afwTable
                import lsst.afw.coord as afwCoord
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#3651742b">3651742b</a> + from lsst.meas.algorithms import LoadReferenceObjectsTask, getRefFluxField</div>
                import lsst.ip.diffim as ipDiffim
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#3651742b">3651742b</a> + </div>
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                class DiaCatalogSourceSelectorTest(unittest.TestCase):
                
                    def setUp(self):
                        self.sourceSelector = ipDiffim.DiaCatalogSourceSelector()
                        self.exposure = afwImage.ExposureF()
                
                    def tearDown(self):
                        del self.sourceSelector
                        del self.exposure
                
                    def makeRefCatalog(self):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#3651742b">3651742b</a> +         schema = LoadReferenceObjectsTask.makeMinimalSchema(filterNameList=["g", "r"],</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#3651742b">3651742b</a> +             addFluxSigma=False, addIsPhotometric=True, addIsResolved=True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#7e2a022d">7e2a022d</a> -         schema = afwTable.SourceTable.makeMinimalSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#7e2a022d">7e2a022d</a> -         schema.addField("g", type="D")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#7e2a022d">7e2a022d</a> -         schema.addField("r", type="D")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#7e2a022d">7e2a022d</a> -         schema.addField("stargal", type="Flag")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#7e2a022d">7e2a022d</a> -         schema.addField("photometric", type="Flag")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#7e2a022d">7e2a022d</a> -         catalog = afwTable.SourceCatalog(schema)</div>
              ?                             ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#3651742b">3651742b</a> +         catalog = afwTable.SimpleCatalog(schema)</div>
              ?                             ^^^^
                        return catalog
                
                    def makeSrcCatalog(self):
                        schema = afwTable.SourceTable.makeMinimalSchema()
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#19d923ab">19d923ab</a> +         schema.setVersion(0)</div>
                        schema.addField("flux", type=float)
                        schema.addField("flux.err", type=float)
                        for flag in self.sourceSelector.config.badPixelFlags:
                            schema.addField(flag, type="Flag")
                        table = afwTable.SourceTable.make(schema)
                        table.definePsfFlux("flux")
                        catalog = afwTable.SourceCatalog(table)
                        return catalog
                
                    def makeMatches(self, refCat, srcCat, nSrc):
                        for i in range(nSrc):
                
                            refSrc = refCat.addNew()
                            srcSrc = srcCat.addNew()
                            
                            coord  = afwCoord.Coord(afwGeom.Point2D(*np.random.randn(2)), afwGeom.degrees)
                            
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#7e2a022d">7e2a022d</a> -             refSrc.set("g", 10**(-0.4*18))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#3651742b">3651742b</a> +             refSrc.set("g_flux", 10**(-0.4*18))</div>
              ?                          +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#7e2a022d">7e2a022d</a> -             refSrc.set("r", 10**(-0.4*18))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#3651742b">3651742b</a> +             refSrc.set("r_flux", 10**(-0.4*18))</div>
              ?                          +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#7e2a022d">7e2a022d</a> -             refSrc.set("stargal", True)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#3651742b">3651742b</a> +             refSrc.set("resolved", False)</div>
                            refSrc.set("photometric", True)
                            refSrc.set("coord", coord)
                
                            srcSrc.setCoord(coord)
                            srcSrc.set(srcSrc.getTable().getPsfFluxKey(), 10.)
                            srcSrc.set(srcSrc.getTable().getPsfFluxErrKey(), 1.)
                            for flag in self.sourceSelector.config.badPixelFlags:
                                srcSrc.set(flag, False)
                
                        mat = afwTable.matchRaDec(refCat, srcCat, 1.0 * afwGeom.arcseconds, False)
                        self.assertEqual(len(mat), nSrc)
                        return mat
                
                    def testCuts(self):
                        nSrc     = 5
                
                        refCat   = self.makeRefCatalog()
                        srcCat   = self.makeSrcCatalog()
                
                        matches = self.makeMatches(refCat, srcCat, nSrc)
                        sources = self.sourceSelector.selectSources(self.exposure, srcCat, matches)
                        self.assertEqual(len(sources), nSrc)
                
                        # Set one of the source flags to be bad
                        matches[0].second.set(self.sourceSelector.config.badPixelFlags[0], True)
                        sources = self.sourceSelector.selectSources(self.exposure, srcCat, matches)
                        self.assertEqual(len(sources), nSrc-1)
                
                        # Set one of the ref flags to be bad
                        matches[1].first.set("photometric", False)
                        sources = self.sourceSelector.selectSources(self.exposure, srcCat, matches)
                        self.assertEqual(len(sources), nSrc-2)
                
                        # Set one of the colors to be bad
                        grMin = self.sourceSelector.config.grMin
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#3651742b">3651742b</a> +         rFluxField = getRefFluxField(refCat.schema, "r")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#3651742b">3651742b</a> +         gFluxField = getRefFluxField(refCat.schema, "g")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#7e2a022d">7e2a022d</a> -         gFlux = 10**(-0.4 * (grMin - 0.1)) * matches[2].first.get("r")</div>
              ?                                                                   - ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#3651742b">3651742b</a> +         gFlux = 10**(-0.4 * (grMin - 0.1)) * matches[2].first.get(rFluxField)</div>
              ?                                                                    ^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#7e2a022d">7e2a022d</a> -         matches[2].first.set("g", gFlux)</div>
              ?                              - ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#3651742b">3651742b</a> +         matches[2].first.set(gFluxField, gFlux)</div>
              ?                               ^^^^^^^^^
                        sources = self.sourceSelector.selectSources(self.exposure, srcCat, matches)
                        self.assertEqual(len(sources), nSrc-3)
                
                        # Set one of the types to be bad
                        if self.sourceSelector.config.selectStar and not self.sourceSelector.config.selectGalaxy:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#eca0bdaf">eca0bdaf</a> -             matches[3].first.set("stargal", False)</div>
              ?                                    ^^^^^    ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#3651742b">3651742b</a> +             matches[3].first.set("resolved", True)</div>
              ?                                   ++ ^ +++   ^^^
                            sources = self.sourceSelector.selectSources(self.exposure, srcCat, matches)
                            self.assertEqual(len(sources), nSrc-4)
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiaCatalogSourceSelectorTest)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(shouldExit = False):
                    """Run the tests"""
                    tests.run(suite(), shouldExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="eca0bdaf"/></a>eca0bdaf</h3>

<pre>
commit eca0bdaf376bee62323c9e04078b676e62b6b4d0
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Jan 25 11:40:35 2013 -0800

    Added an additional star/galaxy test.
</pre>
<h3><a name="7e2a022d"/></a>7e2a022d</h3>

<pre>
commit 7e2a022d524893f9b7a54fd4e7de44bb13c68745
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Jan 25 11:30:28 2013 -0800

    Added DiaCatalogSourceSelector for source selection optimised for image subtraction.  Includes cuts on source flags, and referece object flags.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="19d923ab"/></a>19d923ab</h3>

<pre>
commit 19d923ab86ca23eb96132abd2bb1dae7869cb17d
Author: pgee <pgee@pgeepc2.gateway.2wire.net>
Date:   Wed Aug 20 03:35:59 2014 -0700

    DM-958 change table.setVersion calls to schema.setVersion
</pre>
<h3><a name="3651742b"/></a>3651742b</h3>

<pre>
commit 3651742b1648a539e7cdf9ab1b5c70ff13ba7ff0
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:39:56 2015 -0700

    Updated code for new reference object schema
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_78"><a name="python/lsst/ip/diffim/kernelCandidateQa.py"/></a>python/lsst/ip/diffim/kernelCandidateQa.py</h1>

<h3 id="toc_79">Diff:</h3>

<pre>
                #
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                """Quality Assessment class for Kernel Candidates"""
                import numpy as np
                import numpy.ma as ma
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.table as afwTable
                import lsst.afw.math as afwMath
                from . import diffimLib
                from .utils import calcCentroid, calcWidth
                
                class KernelCandidateQa(object):
                
                    def __init__(self, nKernelSpatial):
                        """Class to undertake QA of KernelCandidates after modeling of
                        the Psf-matching kernel.  Both directly--fitted diffim (LOCAL)
                        and spatially--interpolated kernel diffim (SPATIAL) metrics
                        are calculated, based on the distribution of residuals in the
                        KernelCandidates stamp.
                
                        @param nKernelSpatial : Number of terms in the spatial model; needed to initialize per-basis QA arrays
                        """
                        self.fields = []
                        self.fields.append(afwTable.Field["PointD"]("RegisterRefPosition",
                                                              "Position of reference object for registration (radians)."))
                        #TODO check units of the following angles
                        self.fields.append(afwTable.Field["Angle"]("RegisterResidualBearing",
                                                              "Angle of residual wrt declination parallel in radians"))
                
                        self.fields.append(afwTable.Field["Angle"]("RegisterResidualDistance",
                                                              "Offset of residual in radians"))
                        metricMap = self.makeMetricMap()
                
                        for kType in ("LOCAL", "SPATIAL"):
                            for k in metricMap:
                                commentAndUnit = metricMap[k]['comment']
                                self.fields.append(afwTable.Field[metricMap[k]['type']](k%(kType), *commentAndUnit))
                
                        self.fields.append(afwTable.Field["I"]("KCKernelStatus_LOCAL",
                                                               "Status of the KernelCandidate"))
                
                        self.fields.append(afwTable.Field["ArrayD"]("KernelCoeffValues_LOCAL",
                                                                    "Original basis coefficients",
                                                                    nKernelSpatial))
                
                        self.fields.append(afwTable.Field["F"]("BackgroundValue_LOCAL",
                                                               "Evaluation of background model at this point"))
                
                        self.fields.append(afwTable.Field["F"]("KCDiffimMseKernel_SPATIAL",
                                                               "Mean squared error of spatial kernel estimate"))
                
                    def makeMetricMap(self):
                        nameList = ['KCDiffimMean_%s', 'KCDiffimMedian_%s', 'KCDiffimIQR_%s', 'KCDiffimStDev_%s',
                                    'KCDiffimKSD_%s', 'KCDiffimKSProb_%s', 'KCDiffimADA2_%s', 'KCDiffimADCrit_%s',
                                    'KCDiffimADSig_%s', 'KCDiffimChiSq_%s', 'KCDiffimMseResids_%s', 'KCKernelCentX_%s',
                                    'KCKernelCentY_%s', 'KCKernelStdX_%s', 'KCKernelStdY_%s', 'KernelCandidateId_%s']
                        typeList = ['F', 'F', 'F', 'F', 'F', 'F', 'F', 'ArrayD', 'ArrayD', 'F', 'F', 'F',
                                    'F', 'F', 'F', 'I']
                        commentList = [("Mean of KernelCandidate diffim", "sigma"),
                                       ("Median of KernelCandidate diffim", "sigma"),
                                       ("Inner quartile range of KernelCandidate diffim", "sigma"),
                                       ("Standard deviation of KernelCandidate diffim","sigma"),
                                       ("D from K-S test of diffim pixels relative to Normal", ),
                                       ("Prob from K-S test of diffim pixels relative to Normal", "likelihood"),
                                       ("Anderson-Darling test statistic of diffim pixels relative to Normal", ),
                                       ("Critical values for the significance levels in KCDiffimADSig.  If A2 is greater "+\
                                       "than this number, hypothesis that the distributions are similar can be rejected.", 5),
                                       ("Anderson-Darling significance levels for the Normal distribution", 5),
                                       ("Reduced chi^2 of the residual.", "likelihood"),
                                       ("Mean squared error in diffim : Variance + Bias**2",),
                                       ("Centroid in X for this Kernel", "pixels"),
                                       ("Centroid in Y for this Kernel", "pixels"),
                                       ("Standard deviation in X for this Kernel", "pixels"),
                                       ("Standard deviation in Y for this Kernel", "pixels"),
                                       ("Id for this KernelCandidate",)]
                        metricMap = {}
                        for name, mtype, comment in zip(nameList, typeList, commentList):
                            metricMap[name] = {'type':mtype, 'comment':comment}
                
                        return metricMap
                
                
                    def addToSchema(self, inSourceCatalog):
                        """Add the to-be-generated QA keys to the Source schema"""
                        schema = inSourceCatalog.getSchema()
                        inKeys = []
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#3c6e3b17">3c6e3b17</a> -         fluxKey = inSourceCatalog.getPsfFluxKey()</div>
              ?          ^^^^ ^                             ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#3d326827">3d326827</a> +         psfDef = inSourceCatalog.getPsfFluxDefinition()</div>
              ?         ++ ^ ^                             ^ ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#3c6e3b17">3c6e3b17</a> -         centroidKey = inSourceCatalog.getCentroidKey()</div>
              ?                 ^ ^                              ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#3d326827">3d326827</a> +         centroidDef = inSourceCatalog.getCentroidDefinition()</div>
              ?                 ^ ^                              ^ ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#3c6e3b17">3c6e3b17</a> -         shapeKey = inSourceCatalog.getShapeKey()</div>
              ?              ^ ^                           ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#3d326827">3d326827</a> +         shapeDef = inSourceCatalog.getShapeDefinition()</div>
              ?              ^ ^                           ^ ^^^^^^^^
                        for n in schema.getNames():
                            inKeys.append(schema[n].asKey())
                
                        for field in self.fields:
                            schema.addField(field)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#3c6e3b17">3c6e3b17</a> - </div>
                        outSourceCatalog = afwTable.SourceCatalog(schema)
                        for source in inSourceCatalog:
                            rec = outSourceCatalog.addNew()
                            for k in inKeys:
                                if k.getTypeString() == 'Coord':
                                    rec.setCoord(source.getCoord())
                                else:
                                    setter = getattr(rec, "set"+k.getTypeString())
                                    getter = getattr(source, "get"+k.getTypeString())
                                    setter(k, getter(k))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#3c6e3b17">3c6e3b17</a> -         outSourceCatalog.definePsfFlux(fluxKey)</div>
              ?                                         ^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#3d326827">3d326827</a> +         outSourceCatalog.definePsfFlux(psfDef)</div>
              ?                                        ++ ^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#3c6e3b17">3c6e3b17</a> -         outSourceCatalog.defineCentroid(centroidKey)</div>
              ?                                                 ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#3d326827">3d326827</a> +         outSourceCatalog.defineCentroid(centroidDef)</div>
              ?                                                 ^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#3c6e3b17">3c6e3b17</a> -         outSourceCatalog.defineShape(shapeKey)</div>
              ?                                           ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#3d326827">3d326827</a> +         outSourceCatalog.defineShape(shapeDef)</div>
              ?                                           ^ ^
                        return outSourceCatalog
                
                    def _calculateStats(self, di, dof=0.):
                        """Calculate the core QA statistics on a difference image"""
                        mask = di.getMask()
                        maskArr = di.getMask().getArray()
                
                        # Create a mask using BAD,SAT,EDGE pixels.  Keep detections
                        maskArr &= (mask.getPlaneBitMask("BAD")|mask.getPlaneBitMask("SAT")|mask.getPlaneBitMask("EDGE"))
                
                        # Mask out values based on maskArr
                        diArr = ma.array(di.getImage().getArray(), mask=maskArr)
                        varArr = ma.array(di.getVariance().getArray(), mask=maskArr)
                
                        # Normalize by sqrt variance, units are in sigma
                        diArr /= np.sqrt(varArr)
                        mean = diArr.mean()
                
                        # This is the maximum-likelihood extimate of the variance stdev**2
                        stdev = diArr.std()
                        median = ma.extras.median(diArr)
                
                        # Compute IQR of just un-masked data
                        data = ma.getdata(diArr[~diArr.mask])
                        iqr = np.percentile(data, 75.) - np.percentile(data, 25.)
                
                        #Calculte chisquare of the residual
                        chisq=np.sum(np.power(data, 2.))
                
                        # Mean squared error: variance + bias**2
                        # Bias = |data - model| = mean of diffim
                        # Variance = |(data - model)**2| = mean of diffim**2
                        bias = mean
                        variance = np.power(data, 2.).mean()
                        mseResids = bias**2 + variance
                
                        # If scipy is not set up, return zero for the stats
                        try:
                            #In try block because of risk of divide by zero
                            rchisq=chisq/(len(data)-1-dof)
                            # K-S test on the diffim to a Normal distribution
                            import scipy.stats
                            D, prob = scipy.stats.kstest(data, 'norm')
                
                            A2, crit, sig = scipy.stats.anderson(data, 'norm')
                            # Anderson Darling statistic cand be inf for really non-Gaussian distributions.
                            if np.isinf(A2) or np.isnan(A2):
                                A2 = 9999.
                        except ZeroDivisionError:
                            D = 0.
                            prob = 0.
                            A2 = 0.
                            crit = np.zeros(5)
                            sig = np.zeros(5)
                            rchisq = 0
                
                        return {"mean": mean, "stdev": stdev, "median": median, "iqr": iqr,
                                "D": D, "prob": prob, "A2": A2, "crit": crit, "sig": sig,
                                "rchisq": rchisq, "mseResids": mseResids}
                
                
                    def apply(self, candidateList, spatialKernel, spatialBackground, dof=0):
                        """Evaluate the QA metrics for all KernelCandidates in the
                        candidateList; set the values of the metrics in their
                        associated Sources"""
                        for kernelCandidate in candidateList:
                            source = kernelCandidate.getSource()
                            schema = source.schema
                
                            # Calculate ORIG stats (original basis fit)
                            if kernelCandidate.getStatus() != afwMath.SpatialCellCandidate.UNKNOWN:
                                kType = getattr(diffimLib.KernelCandidateF, "ORIG")
                                di = kernelCandidate.getDifferenceImage(kType)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#3c6e3b17">3c6e3b17</a> -                 kernel = kernelCandidate.getKernel(kType)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#3c6e3b17">3c6e3b17</a> -                 kstatus = kernelCandidate.getStatus()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#3c6e3b17">3c6e3b17</a> -                 backgroundValue = kernelCandidate.getBackground(kType)</div>
                                kernelValues = kernelCandidate.getKernel(kType).getKernelParameters()
                                kernelValues = np.asarray(kernelValues)
                
                                lkim = kernelCandidate.getKernelImage(kType)
                                centx, centy = calcCentroid(lkim.getArray())
                                stdx, stdy = calcWidth(lkim.getArray(), centx, centy)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#3c6e3b17">3c6e3b17</a> -                 solution = kernelCandidate.getKernelSolution(kType)</div>
                                # NOTE
                                # What is the difference between kernelValues and solution?
                
                                localResults = self._calculateStats(di, dof=dof)
                
                                metrics = {"KCDiffimMean_LOCAL":localResults["mean"],
                                           "KCDiffimMedian_LOCAL":localResults["median"],
                                           "KCDiffimIQR_LOCAL":localResults["iqr"],
                                           "KCDiffimStDev_LOCAL":localResults["stdev"],
                                           "KCDiffimKSD_LOCAL":localResults["D"],
                                           "KCDiffimKSProb_LOCAL":localResults["prob"],
                                           "KCDiffimADA2_LOCAL":localResults["A2"],
                                           "KCDiffimADCrit_LOCAL":localResults["crit"],
                                           "KCDiffimADSig_LOCAL":localResults["sig"],
                                           "KCDiffimChiSq_LOCAL":localResults["rchisq"],
                                           "KCDiffimMseResids_LOCAL":localResults["mseResids"],
                                           "KCKernelCentX_LOCAL":centx,
                                           "KCKernelCentY_LOCAL":centy,
                                           "KCKernelStdX_LOCAL":stdx,
                                           "KCKernelStdY_LOCAL":stdy,
                                           "KernelCandidateId_LOCAL":kernelCandidate.getId(),
                                           "KernelCoeffValues_LOCAL":kernelValues}
                                for k in metrics.keys():
                                    key = schema[k].asKey()
                                    setter = getattr(source, "set"+key.getTypeString())
                                    setter(key, metrics[k])
                            else:
                                try:
                                    kType = getattr(diffimLib.KernelCandidateF, "ORIG")
                                    lkim = kernelCandidate.getKernelImage(kType)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#3c6e3b17">3c6e3b17</a> -                 except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#966eaa96">966eaa96</a> +                 except Exception:</div>
              ?                       ++++++++++
                                    lkim = None
                
                            # Calculate spatial model evaluated at each position, for
                            # all candidates
                            skim  = afwImage.ImageD(spatialKernel.getDimensions())
                            spatialKernel.computeImage(skim, False, kernelCandidate.getXCenter(),
                                                       kernelCandidate.getYCenter())
                            centx, centy = calcCentroid(skim.getArray())
                            stdx, stdy = calcWidth(skim.getArray(), centx, centy)
                
                            sk = afwMath.FixedKernel(skim)
                            sbg = spatialBackground(kernelCandidate.getXCenter(), kernelCandidate.getYCenter())
                            di = kernelCandidate.getDifferenceImage(sk, sbg)
                            spatialResults = self._calculateStats(di, dof=dof)
                
                            # Kernel mse
                            if lkim is not None:
                                skim     -= lkim
                                bias      = np.mean(skim.getArray())
                                variance  = np.mean(np.power(skim.getArray(), 2.))
                                mseKernel = bias**2 + variance
                            else:
                                mseKernel = -99.999
                
                            metrics = {"KCDiffimMean_SPATIAL":spatialResults["mean"],
                                       "KCDiffimMedian_SPATIAL":spatialResults["median"],
                                       "KCDiffimIQR_SPATIAL":spatialResults["iqr"],
                                       "KCDiffimStDev_SPATIAL":spatialResults["stdev"],
                                       "KCDiffimKSD_SPATIAL":spatialResults["D"],
                                       "KCDiffimKSProb_SPATIAL":spatialResults["prob"],
                                       "KCDiffimADA2_SPATIAL":spatialResults["A2"],
                                       "KCDiffimADCrit_SPATIAL":spatialResults["crit"],
                                       "KCDiffimADSig_SPATIAL":spatialResults["sig"],
                                       "KCDiffimChiSq_SPATIAL":spatialResults["rchisq"],
                                       "KCDiffimMseResids_SPATIAL":spatialResults["mseResids"],
                                       "KCDiffimMseKernel_SPATIAL":mseKernel,
                                       "KCKernelCentX_SPATIAL":centx,
                                       "KCKernelCentY_SPATIAL":centy,
                                       "KCKernelStdX_SPATIAL":stdx,
                                       "KCKernelStdY_SPATIAL":stdy,
                                       "KernelCandidateId_SPATIAL":kernelCandidate.getId()}
                            for k in metrics.keys():
                                key = schema[k].asKey()
                                setter = getattr(source, "set"+key.getTypeString())
                                setter(key, metrics[k])
                
                    def aggregate(self, sourceCatalog, metadata, wcsresids, diaSources=None):
                        """Generate aggregate metrics (e.g. total numbers of false
                        positives) from all the Sources in the sourceCatalog"""
                        for source in sourceCatalog:
                            sourceId = source.getId()
                            if sourceId in wcsresids.keys():
                                #Note that the residuals are not delta RA, delta Dec
                                #From the source code "bearing (angle wrt a declination parallel) and distance
                                coord, resids = wcsresids[sourceId]
                                key = source.schema["RegisterResidualBearing"].asKey()
                                setter = getattr(source, "set"+key.getTypeString())
                                setter(key, resids[0])
                                key = source.schema["RegisterResidualDistance"].asKey()
                                setter = getattr(source, "set"+key.getTypeString())
                                setter(key, resids[1])
                                key = source.schema["RegisterRefPosition"].asKey()
                                setter = getattr(source, "set"+key.getTypeString())
                                setter(key, afwGeom.Point2D(coord.getRa().asRadians(),
                                                            coord.getDec().asRadians()))
                        if diaSources:
                            metadata.add("NFalsePositivesTotal", len(diaSources))
                            nRefMatch = 0
                            nSrcMatch = 0
                            nunmatched = 0
                            for source in diaSources:
                                refId = source.get("refMatchId")
                                srcId = source.get("srcMatchId")
                                if refId > 0:
                                    nRefMatch += 1
                                if srcId > 0:
                                    nSrcMatch += 1
                                if refId == 0 and srcId == 0:
                                    nunmatched += 1
                            metadata.add("NFalsePositivesRefAssociated", nRefMatch)
                            metadata.add("NFalsePositivesSrcAssociated", nSrcMatch)
                            metadata.add("NFalsePositivesUnassociated", nunmatched)
                        for kType in ("LOCAL", "SPATIAL"):
                            for sName in ("KCDiffimMean", "KCDiffimMedian", "KCDiffimIQR", "KCDiffimStDev",
                                          "KCDiffimKSProb", "KCDiffimADSig", "KCDiffimChiSq",
                                          "KCDiffimMseResids", "KCDiffimMseKernel"):
                                if sName == "KCDiffimMseKernel" and kType == "LOCAL":
                                    continue
                                kName = "%s_%s" % (sName, kType)
                                vals = np.array([s.get(kName) for s in sourceCatalog])
                                idx = np.isfinite(vals)
                                metadata.add("%s_MEAN" % (kName), np.mean(vals[idx]))
                                metadata.add("%s_MEDIAN" % (kName), np.median(vals[idx]))
                                metadata.add("%s_STDEV" % (kName), np.std(vals[idx]))
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="3c6e3b17"/></a>3c6e3b17</h3>

<pre>
commit 3c6e3b171e276226d9832eec500f6bfc0700d9f0
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 15:35:53 2013 -0700

    Addressed all ticket comments from Paul and Serge.  Will build and run unit tests next.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="3d326827"/></a>3d326827</h3>

<pre>
commit 3d32682725b0dd114e89afd9c8ceeb5422af71e5
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Thu Sep 25 03:11:15 2014 -0500

    Fix to make this script consistent with new slot API
</pre>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_80"><a name="python/lsst/ip/diffim/diffimTools.py"/></a>python/lsst/ip/diffim/diffimTools.py</h1>

<h3 id="toc_81">Diff:</h3>

<pre>
                #
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                # python
                import time
                import os
                from collections import Counter
                import numpy as np
                
                # all the c++ level classes and routines
                import diffimLib
                
                # all the other LSST packages
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.table as afwTable
                import lsst.afw.detection as afwDetect
                import lsst.afw.math.mathLib as afwMath
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#099e4cee">099e4cee</a> - import lsst.meas.algorithms as measAlg</div>
                from .makeKernelBasisList import makeKernelBasisList 
                
                # Helper functions for ipDiffim; mostly viewing of results and writing
                # debugging info to disk.
                
                #######
                # Add noise
                #######
                
                def makeFlatNoiseImage(mi, seedStat = afwMath.MAX):
                    img       = mi.getImage()
                    seed      = int(10. * afwMath.makeStatistics(mi.getImage(), seedStat).getValue() + 1)
                    rdm       = afwMath.Random(afwMath.Random.MT19937, seed)
                    rdmImage  = img.Factory(img.getDimensions())
                    afwMath.randomGaussianImage(rdmImage, rdm)
                    return rdmImage
                
                def makePoissonNoiseImage(im):
                    """Return a Poisson noise image based on im
                
                    Uses numpy.random; you may wish to call numpy.random.seed first.
                
                    @warning This uses an undocumented numpy API (the documented API
                    uses a single float expectation value instead of an array).
                
                    @param[in] im image; the output image has the same dimensions and shape
                        and its expectation value is the value of im at each pixel
                    """
                    import numpy.random as rand
                    imArr = im.getArray()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#94d7fa6b">94d7fa6b</a> -     noiseIm = im.Factory(im.getBBox(afwImage.PARENT))</div>
              ?                                     ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#9250fe88">9250fe88</a> +     noiseIm = im.Factory(im.getBBox())</div>
                    noiseArr = noiseIm.getArray()
                
                    intNoiseArr = rand.poisson(imArr)
                    noiseArr[:, :] = intNoiseArr.astype(noiseArr.dtype)
                    return noiseIm
                
                #######
                # Make fake images for testing; one is a delta function (or narrow
                # gaussian) and the other is a convolution of this with a spatially
                # varying kernel.
                #######
                def fakeCoeffs():
                    kCoeffs = ((  1.0,     0.0,       0.0),
                               (  0.005,  -0.000001,  0.000001),
                               (  0.005,   0.000004,  0.000004),
                               ( -0.001,  -0.000030,  0.000030),
                               ( -0.001,   0.000015,  0.000015),
                               ( -0.005,  -0.000050,  0.000050))
                    return kCoeffs
                
                def makeFakeKernelSet(sizeCell = 128, nCell = 3,
                                      deltaFunctionCounts = 1.e4, tGaussianWidth = 1.0,
                                      addNoise = True, bgValue = 100., display = False):
                
                    from . import imagePsfMatch
                    configFake               = imagePsfMatch.ImagePsfMatchConfig()
                    configFake.kernel.name   = "AL"
                    subconfigFake            = configFake.kernel.active
                    subconfigFake.alardNGauss   = 1
                    subconfigFake.alardSigGauss = [2.5,]
                    subconfigFake.alardDegGauss = [2,]
                    subconfigFake.sizeCellX     = sizeCell
                    subconfigFake.sizeCellY     = sizeCell
                    subconfigFake.spatialKernelOrder = 1
                    subconfigFake.spatialModelType = "polynomial"
                    subconfigFake.singleKernelClipping = False   # variance is a hack
                    subconfigFake.spatialKernelClipping = False  # variance is a hack
                    if bgValue > 0.0:
                        subconfigFake.fitForBackground = True
                
                    policyFake = pexConfig.makePolicy(subconfigFake)
                
                    basisList = makeKernelBasisList(subconfigFake)
                    kSize     = subconfigFake.kernelSize
                
                    # This sets the final extent of each convolved delta function
                    gaussKernelWidth   = sizeCell // 2
                
                    # This sets the scale over which pixels are correlated in the
                    # spatial convolution; should be at least as big as the kernel you
                    # are trying to fit for
                    spatialKernelWidth = kSize
                
                    # Number of bad pixels due to convolutions
                    border = (gaussKernelWidth + spatialKernelWidth)//2
                
                    # Make a fake image with a matrix of delta functions
                    totalSize = nCell * sizeCell + 2 * border
                    tim       = afwImage.ImageF(afwGeom.Extent2I(totalSize, totalSize))
                    for x in range(nCell):
                        for y in range(nCell):
                            tim.set(x * sizeCell + sizeCell // 2 + border - 1,
                                    y * sizeCell + sizeCell // 2 + border - 1,
                                    deltaFunctionCounts)
                
                    # Turn this into stars with a narrow width; conserve counts
                    gaussFunction = afwMath.GaussianFunction2D(tGaussianWidth, tGaussianWidth)
                    gaussKernel   = afwMath.AnalyticKernel(gaussKernelWidth, gaussKernelWidth, gaussFunction)
                    cim = afwImage.ImageF(tim.getDimensions())
                    afwMath.convolve(cim, tim, gaussKernel, True)
                    tim = cim
                
                    # Trim off border pixels
                    bbox = gaussKernel.shrinkBBox(tim.getBBox(afwImage.LOCAL))
                    tim  = afwImage.ImageF(tim, bbox, afwImage.LOCAL)
                
                    # Now make a science image which is this convolved with some
                    # spatial function.  Use input basis list.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#4c42be0e">4c42be0e</a> -     sOrder   = 1</div>
                    polyFunc = afwMath.PolynomialFunction2D(1)
                    kCoeffs  = fakeCoeffs()
                    nToUse   = min(len(kCoeffs), len(basisList))
                
                    # Make the full convolved science image
                    sKernel = afwMath.LinearCombinationKernel(afwMath.KernelList(basisList[:nToUse]), polyFunc)
                    sKernel.setSpatialParameters(kCoeffs[:nToUse])
                    sim = afwImage.ImageF(tim.getDimensions())
                    afwMath.convolve(sim, tim, sKernel, True)
                
                    # Get the good subregion
                    bbox = sKernel.shrinkBBox(sim.getBBox(afwImage.LOCAL))
                
                    # Add background
                    sim  += bgValue
                
                    # Watch out for negative values
                    tim  += 2 * np.abs(np.min(tim.getArray()))
                
                    # Add noise?
                    if addNoise:
                        sim   = makePoissonNoiseImage(sim)
                        tim   = makePoissonNoiseImage(tim) 
                
                    # And turn into MaskedImages
                    sim   = afwImage.ImageF(sim, bbox, afwImage.LOCAL)
                    svar  = afwImage.ImageF(sim, True)
                    smask = afwImage.MaskU(sim.getDimensions())
                    smask.set(0x0)
                    sMi   = afwImage.MaskedImageF(sim, smask, svar)
                
                    tim   = afwImage.ImageF(tim, bbox, afwImage.LOCAL)
                    tvar  = afwImage.ImageF(tim, True)
                    tmask = afwImage.MaskU(tim.getDimensions())
                    tmask.set(0x0)
                    tMi   = afwImage.MaskedImageF(tim, tmask, tvar)
                
                    if display:
                        import lsst.afw.display.ds9 as ds9
                        ds9.mtv(tMi, frame=1)
                        ds9.mtv(sMi, frame=2)
                
                    # Finally, make a kernelSet from these 2 images
                    kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0, 0),
                                                                         afwGeom.Extent2I(sizeCell * nCell,
                                                                                          sizeCell * nCell)),
                                                           sizeCell,
                                                           sizeCell)
                    stampHalfWidth = 2 * kSize
                    for x in range(nCell):
                        for y in range(nCell):
                            xCoord = x * sizeCell + sizeCell // 2
                            yCoord = y * sizeCell + sizeCell // 2
                            p0 = afwGeom.Point2I(xCoord - stampHalfWidth,
                                                 yCoord - stampHalfWidth)
                            p1 = afwGeom.Point2I(xCoord + stampHalfWidth,
                                                 yCoord + stampHalfWidth)
                            bbox = afwGeom.Box2I(p0, p1)
                            tsi = afwImage.MaskedImageF(tMi, bbox, afwImage.LOCAL)
                            ssi = afwImage.MaskedImageF(sMi, bbox, afwImage.LOCAL)
                
                            kc = diffimLib.makeKernelCandidate(xCoord, yCoord, tsi, ssi, policyFake)
                            kernelCellSet.insertCandidate(kc)
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#d1d02620">d1d02620</a> +     tMi.setXY0(0,0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#d1d02620">d1d02620</a> +     sMi.setXY0(0,0)</div>
                    return tMi, sMi, sKernel, kernelCellSet, configFake
                
                
                #######
                # Background subtraction for ip_diffim
                #######
                
                def backgroundSubtract(config, maskedImages):
                    backgrounds = []
                    t0 = time.time()
                    algorithm   = config.algorithm
                    binsize     = config.binSize
                    undersample = config.undersampleStyle
                    bctrl       = afwMath.BackgroundControl(algorithm)
                    bctrl.setUndersampleStyle(undersample)
                    for maskedImage in maskedImages:
                        bctrl.setNxSample(maskedImage.getWidth()//binsize + 1)
                        bctrl.setNySample(maskedImage.getHeight()//binsize + 1)
                        image   = maskedImage.getImage() 
                        backobj = afwMath.makeBackground(image, bctrl)
                
                        image  -= backobj.getImageF()
                        backgrounds.append(backobj.getImageF())
                        del backobj
                
                    t1 = time.time()
                    pexLog.Trace("lsst.ip.diffim.backgroundSubtract", 1,
                                 "Total time for background subtraction : %.2f s" % (t1-t0))
                    return backgrounds
                
                #######
                # More coarse debugging
                #######
                
                def writeKernelCellSet(kernelCellSet, psfMatchingKernel, backgroundModel, outdir):
                    if not os.path.isdir(outdir):
                        os.makedirs(outdir)
                
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(False): # False = include bad candidates
                            cand = diffimLib.cast_KernelCandidateF(cand)
                            if cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                xCand = int(cand.getXCenter())
                                yCand = int(cand.getYCenter())
                                idCand = cand.getId()
                                diffIm = cand.getDifferenceImage(diffimLib.KernelCandidateF.ORIG)
                                kernel = cand.getKernelImage(diffimLib.KernelCandidateF.ORIG)
                                diffIm.writeFits(os.path.join(outdir, 'diffim_c%d_x%d_y%d.fits' % (idCand, xCand, yCand)))
                                kernel.writeFits(os.path.join(outdir, 'kernel_c%d_x%d_y%d.fits' % (idCand, xCand, yCand)))
                
                                # Diffim from spatial model
                                ski   = afwImage.ImageD(kernel.getDimensions())
                                psfMatchingKernel.computeImage(ski, False, xCand, yCand)
                                sk    = afwMath.FixedKernel(ski)
                                sbg   = backgroundModel(xCand, yCand)
                                sdmi  = cand.getDifferenceImage(sk, sbg)
                                sdmi.writeFits(os.path.join(outdir, 'sdiffim_c%d_x%d_y%d.fits' % (idCand, xCand, yCand)))
                
                #######
                # Converting types
                #######
                
                def sourceToFootprintList(candidateInList, templateExposure, scienceExposure, kernelSize, config, log):
                    """ Takes an input list of Sources that were selected to constrain
                    the Psf-matching Kernel and turns them into a List of Footprints,
                    which are used to seed a set of KernelCandidates.  The function
                    checks both the template and science image for masked pixels,
                    rejecting the Source if certain Mask bits (defined in config) are
                    set within the Footprint.
                
                    @param candidateInList: Input list of Sources
                    @param templateExposure: Template image, to be checked for Mask bits in Source Footprint
                    @param scienceExposure: Science image, to be checked for Mask bits in Source Footprint
                    @param config: Config that defines the Mask planes that indicate an invalid Source and Bbox grow radius
                    @param log: Log for output
                
                    @return a list of dicts having a "source" and "footprint" field, to be used for Psf-matching
                    """
                
                    candidateOutList = []
                    fsb = diffimLib.FindSetBitsU()
                    badBitMask = 0
                    for mp in config.badMaskPlanes: 
                        badBitMask |= afwImage.MaskU.getPlaneBitMask(mp)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#b3a497e9">b3a497e9</a> -     bbox = scienceExposure.getBBox(afwImage.PARENT)</div>
              ?                                    ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#9250fe88">9250fe88</a> +     bbox = scienceExposure.getBBox()</div>
                
                    # Size to grow Sources
                    if config.scaleByFwhm:
                        fpGrowPix = int(config.fpGrowKernelScaling * kernelSize + 0.5)
                    else:
                        fpGrowPix = config.fpGrowPix
                    log.info("Growing %d kernel candidate stars by %d pixels" % (len(candidateInList), fpGrowPix))
                
                    for kernelCandidate in candidateInList:
                        if not type(kernelCandidate) == afwTable.SourceRecord:
                            raise RuntimeError, ("Candiate not of type afwTable.SourceRecord")
                        bm1 = 0
                        bm2 = 0
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#7054ff7a">7054ff7a</a> -         ra  = kernelCandidate.getRa()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#7054ff7a">7054ff7a</a> -         dec = kernelCandidate.getDec()</div>
                        center = afwGeom.Point2I(scienceExposure.getWcs().skyToPixel(kernelCandidate.getCoord()))
                        if center[0] < bbox.getMinX() or center[0] > bbox.getMaxX():
                            continue
                        if center[1] < bbox.getMinY() or center[1] > bbox.getMaxY():
                            continue
                
                        xmin   = center[0] - fpGrowPix
                        xmax   = center[0] + fpGrowPix
                        ymin   = center[1] - fpGrowPix
                        ymax   = center[1] + fpGrowPix
                
                        # Keep object centered
                        if (xmin - bbox.getMinX()) < 0:
                            xmax += (xmin - bbox.getMinX())
                            xmin -= (xmin - bbox.getMinX())
                        if (ymin - bbox.getMinY()) < 0:
                            ymax += (ymin - bbox.getMinY())
                            ymin -= (ymin - bbox.getMinY())
                        if (bbox.getMaxX() - xmax) < 0:
                            xmin -= (bbox.getMaxX() - xmax)
                            xmax += (bbox.getMaxX() - xmax)
                        if (bbox.getMaxY() - ymax) < 0:
                            ymin -= (bbox.getMaxY() - ymax)
                            ymax += (bbox.getMaxY() - ymax)
                        if xmin > xmax or ymin > ymax:
                            continue
                
                        kbbox = afwGeom.Box2I(afwGeom.Point2I(xmin, ymin), afwGeom.Point2I(xmax, ymax))
                        try:
                            fsb.apply(afwImage.MaskedImageF(templateExposure.getMaskedImage(), kbbox, False).getMask())
                            bm1 = fsb.getBits()
                            fsb.apply(afwImage.MaskedImageF(scienceExposure.getMaskedImage(), kbbox, False).getMask())
                            bm2 = fsb.getBits()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
348  <a href="#7054ff7a">7054ff7a</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
346  <a href="#9250fe88">9250fe88</a> +         except Exception:</div>
                            pass
                        else:
                            if not((bm1 & badBitMask) or (bm2 & badBitMask)):
                                candidateOutList.append({'source':kernelCandidate, 'footprint':afwDetect.Footprint(kbbox)})
                    log.info("Selected %d / %d sources for KernelCandidacy" % (len(candidateOutList), len(candidateInList)))
                    return candidateOutList
                
                def sourceTableToCandidateList(sourceTable, templateExposure, scienceExposure, kConfig, dConfig, log,
                                               basisList, doBuild=False):
                    """Takes an input list of Sources, and turns them into
                    KernelCandidates for fitting of the Psf-matching kernel."""
                    kernelSize = basisList[0].getWidth()
                    footprintList = sourceToFootprintList(list(sourceTable), templateExposure, scienceExposure,
                                                          kernelSize, dConfig, log)
                    candList = []
                
                    if doBuild and not basisList:
                        doBuild = False
                    else:
                        policy = pexConfig.makePolicy(kConfig)
                        visitor = diffimLib.BuildSingleKernelVisitorF(basisList, policy)
                
                    policy = pexConfig.makePolicy(kConfig)
                    for cand in footprintList:
                        bbox = cand['footprint'].getBBox() 
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
374  <a href="#5ede6be6">5ede6be6</a> -         tmi  = afwImage.MaskedImageF(templateExposure.getMaskedImage(), bbox, afwImage.PARENT)</div>
              ?                                                                             -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
372  <a href="#9250fe88">9250fe88</a> +         tmi  = afwImage.MaskedImageF(templateExposure.getMaskedImage(), bbox)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
375  <a href="#5ede6be6">5ede6be6</a> -         smi  = afwImage.MaskedImageF(scienceExposure.getMaskedImage(), bbox, afwImage.PARENT)</div>
              ?                                                                            -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
373  <a href="#9250fe88">9250fe88</a> +         smi  = afwImage.MaskedImageF(scienceExposure.getMaskedImage(), bbox)</div>
                        kCand = diffimLib.makeKernelCandidate(cand['source'], tmi, smi, policy)
                        if doBuild:
                            visitor.processCandidate(kCand)
                            kCand.setStatus(afwMath.SpatialCellCandidate.UNKNOWN)
                        candList.append(kCand)
                    return candList
                
                
                #######
                #
                #######
                
                
                class NbasisEvaluator(object):
                    """A functor to evaluate the Bayesian Information Criterion for the number of basis sets going into the kernel fitting"""
                    def __init__(self, psfMatchConfig, psfFwhmPixTc, psfFwhmPixTnc):
                        self.psfMatchConfig = psfMatchConfig
                        self.psfFwhmPixTc = psfFwhmPixTc
                        self.psfFwhmPixTnc = psfFwhmPixTnc
                        if not self.psfMatchConfig.kernelBasisSet == "alard-lupton":
                            raise RuntimeError, "BIC only implemnted for AL (alard lupton) basis"
                
                    def __call__(self, kernelCellSet, log):
                        d1, d2, d3 = self.psfMatchConfig.alardDegGauss
                        bicArray = {}
                        for d1i in range(1, d1+1):
                            for d2i in range(1, d2+1):
                                for d3i in range(1, d3+1):
                                    dList = [d1i, d2i, d3i]
                                    bicConfig = type(self.psfMatchConfig)(self.psfMatchConfig, alardDegGauss=dList)
                                    kList = makeKernelBasisList(bicConfig, self.psfFwhmPixTc, self.psfFwhmPixTnc)
                                    k = len(kList)
                                    visitor = diffimLib.BuildSingleKernelVisitorF(kList, pexConfig.makePolicy(bicConfig))
                                    visitor.setSkipBuilt(False)
                                    kernelCellSet.visitCandidates(visitor, bicConfig.nStarPerCell)
                
                                    for cell in kernelCellSet.getCellList():
                                        for cand in cell.begin(False): # False = include bad candidates
                                            cand = diffimLib.cast_KernelCandidateF(cand)
                                            if cand.getStatus() != afwMath.SpatialCellCandidate.GOOD:
                                                continue
                                            diffIm = cand.getDifferenceImage(diffimLib.KernelCandidateF.RECENT)
                                            bbox = cand.getKernel(diffimLib.KernelCandidateF.RECENT).shrinkBBox(diffIm.getBBox(afwImage.LOCAL))
                                            diffIm = type(diffIm)(diffIm, bbox, True)
                                            chi2 = diffIm.getImage().getArray()**2 / diffIm.getVariance().getArray()
                                            n = chi2.shape[0] * chi2.shape[1]
                                            bic = np.sum(chi2) + k * np.log(n)
                                            if not bicArray.has_key(cand.getId()):
                                                bicArray[cand.getId()] = {}
                                            bicArray[cand.getId()][(d1i, d2i, d3i)] = bic
                
                        bestConfigs = []
                        candIds = bicArray.keys()
                        for candId in candIds:
                            cconfig, cvals = bicArray[candId].keys(), bicArray[candId].values()
                            idx = np.argsort(cvals)
                            bestConfig = cconfig[idx[0]]
                            bestConfigs.append(bestConfig)
                
                        counter = Counter(bestConfigs).most_common(3)
                        log.info("B.I.C. prefers basis complexity %s %d times; %s %d times; %s %d times" % (counter[0][0], counter[0][1],
                                                                                                            counter[1][0], counter[1][1],
                                                                                                            counter[2][0], counter[2][1]))
                        return counter[0][0], counter[1][0], counter[2][0]
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="4c42be0e"/></a>4c42be0e</h3>

<pre>
commit 4c42be0e6a95f55e1f4fab40c7552a47a606eee0
Author: becker <becker@git.lsstcorp.org>
Date:   Thu May 26 02:06:09 2011 +0000

    Unit tests of Psf matching MaskedImages.  #1689
</pre>
<h3><a name="099e4cee"/></a>099e4cee</h3>

<pre>
commit 099e4cee3da9db83967eafff32206a6f9a5d113b
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Jan 30 13:58:50 2013 -0800

    Moved call to measDeblend into ipDiffim.DipoleDeblender.  #2595
</pre>
<h3><a name="94d7fa6b"/></a>94d7fa6b</h3>

<pre>
commit 94d7fa6bbbedb2f3331d829147c0034b7712e950
Author: rowen <rowen@git.lsstcorp.org>
Date:   Sat Apr 16 00:12:02 2011 +0000

    First cut at #1556 changes
</pre>
<h3><a name="7054ff7a"/></a>7054ff7a</h3>

<pre>
commit 7054ff7a2548cbd2165c38b8eb7cc1456685802a
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 3 13:50:58 2012 -0500

    Enabling debugging plots showing the resids in the diffims.
</pre>
<h3><a name="b3a497e9"/></a>b3a497e9</h3>

<pre>
commit b3a497e98a5a28c0b7056eb58696f12cee049dad
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Thu Feb 14 16:26:34 2013 -0800

    Fixed unit tests and added detection and measurement code
</pre>
<h3><a name="5ede6be6"/></a>5ede6be6</h3>

<pre>
commit 5ede6be6d6045f0c74534af79c1b472c7f9efd7b
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Mon Feb 11 18:20:09 2013 -0800

    Calculate metrics on kernel candidates
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
<h3><a name="d1d02620"/></a>d1d02620</h3>

<pre>
commit d1d026207bfb85d241869ed8bdc508970cd487c6
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 16:40:18 2014 -0700

    Making minor XY0 change to helper method makeFakeKernelSet
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_82"><a name="tests/SnapPsfMatch.py"/></a>tests/SnapPsfMatch.py</h1>

<h3 id="toc_83">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import unittest
                import lsst.utils.tests as tests
                import lsst.afw.image as afwImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#9a8b565a">9a8b565a</a> - import lsst.afw.image.utils as imageUtils</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#9a8b565a">9a8b565a</a> - import lsst.afw.math as afwMath</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#b3a497e9">b3a497e9</a> - import lsst.afw.detection as afwDet</div>
                import lsst.meas.algorithms as measAlg
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.daf.base as dafBase
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#9a8b565a">9a8b565a</a> - import lsst.pex.policy as pexPolicy</div>
                
                import lsst.pex.logging as pexLog
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class PsfMatchTestCases(unittest.TestCase):
                
                    def setUp(self):
                        self.configAL    = ipDiffim.SnapPsfMatchTask.ConfigClass()
                        self.configAL.kernel.name = "AL"
                        self.subconfigAL = self.configAL.kernel.active
                
                        self.configDF    = ipDiffim.SnapPsfMatchTask.ConfigClass()
                        self.configDF.kernel.name = "DF"
                        self.subconfigDF = self.configDF.kernel.active
                
                        self.configDFr    = ipDiffim.SnapPsfMatchTask.ConfigClass()
                        self.configDFr.kernel.name = "DF"
                        self.subconfigDFr = self.configDFr.kernel.active
                
                        self.subconfigDF.useRegularization = False
                        self.subconfigDFr.useRegularization = True
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#57b19673">57b19673</a> -         self.subconfigAL.afwBackgroundConfig.useApprox = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#57b19673">57b19673</a> -         self.subconfigDF.afwBackgroundConfig.useApprox = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#57b19673">57b19673</a> -         self.subconfigDFr.afwBackgroundConfig.useApprox = False</div>
                
                        # variance is a hack
                        self.subconfigAL.singleKernelClipping   = False
                        self.subconfigAL.spatialKernelClipping  = False
                        self.subconfigDF.singleKernelClipping   = False
                        self.subconfigDF.spatialKernelClipping  = False
                        self.subconfigDFr.singleKernelClipping  = False
                        self.subconfigDFr.spatialKernelClipping = False
                
                        # Send fake kernel a differential background
                        self.bgValue = 100.
                        self.subconfigAL.fitForBackground = True
                        self.subconfigDF.fitForBackground = True
                        self.subconfigDFr.fitForBackground = True
                
                        # Make ideal PSF
                        self.ksize  = 21
                        self.sigma = 2.0
                        self.psf = measAlg.DoubleGaussianPsf(self.ksize, self.ksize, self.sigma)
                
                    def makeWcs(self, offset = 0):
                        # taken from $AFW_DIR/tests/testMakeWcs.py
                        metadata = dafBase.PropertySet()
                        metadata.set("SIMPLE", "T")
                        metadata.set("BITPIX", -32)
                        metadata.set("NAXIS", 2)
                        metadata.set("NAXIS1", 1024)
                        metadata.set("NAXIS2", 1153)
                        metadata.set("RADECSYS", 'FK5')
                        metadata.set("EQUINOX", 2000.)
                        metadata.setDouble("CRVAL1", 215.604025685476)
                        metadata.setDouble("CRVAL2", 53.1595451514076)
                        metadata.setDouble("CRPIX1", 1109.99981456774 + offset)
                        metadata.setDouble("CRPIX2", 560.018167811613 + offset)
                        metadata.set("CTYPE1", 'RA---SIN')
                        metadata.set("CTYPE2", 'DEC--SIN')
                        metadata.setDouble("CD1_1", 5.10808596133527E-05)
                        metadata.setDouble("CD1_2", 1.85579539217196E-07)
                        metadata.setDouble("CD2_2", -5.10281493481982E-05)
                        metadata.setDouble("CD2_1", -8.27440751733828E-07)
                        return afwImage.makeWcs(metadata)
                
                    def testSnap(self):
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = self.bgValue)
                
                        tWcs = self.makeWcs(offset = 0)
                        sWcs = self.makeWcs(offset = 0)
                        tExp = afwImage.ExposureF(tMi, tWcs)
                        sExp = afwImage.ExposureF(sMi, sWcs)
                        sExp.setPsf(self.psf)
                        psfMatchAL   = ipDiffim.SnapPsfMatchTask(config=self.configAL)
                        psfMatchDF   = ipDiffim.SnapPsfMatchTask(config=self.configDF)
                        psfMatchDFr  = ipDiffim.SnapPsfMatchTask(config=self.configDFr)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#cca1e80e">cca1e80e</a> -         resultsAL    = psfMatchAL.subtractMaskedImages(tMi, sMi, psfMatchAL.makeCandidateList(tExp,</div>
              ?        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#966eaa96">966eaa96</a> +         psfMatchAL.subtractMaskedImages(tMi, sMi, psfMatchAL.makeCandidateList(tExp, sExp, self.ksize))</div>
              ?                                                                                     +++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#cca1e80e">cca1e80e</a> -                                                                                               sExp,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#4e585250">4e585250</a> -                                                                                               self.ksize))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#cca1e80e">cca1e80e</a> -         resultsDF    = psfMatchDF.subtractMaskedImages(tMi, sMi, psfMatchDF.makeCandidateList(tExp,</div>
              ?        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#966eaa96">966eaa96</a> +         psfMatchDF.subtractMaskedImages(tMi, sMi, psfMatchDF.makeCandidateList(tExp, sExp, self.ksize))</div>
              ?                                                                                     +++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#cca1e80e">cca1e80e</a> -                                                                                               sExp,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#4e585250">4e585250</a> -                                                                                               self.ksize))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#cca1e80e">cca1e80e</a> -         resultsDFr   = psfMatchDFr.subtractMaskedImages(tMi, sMi, psfMatchDFr.makeCandidateList(tExp,</div>
              ?        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#966eaa96">966eaa96</a> +         psfMatchDFr.subtractMaskedImages(tMi, sMi, psfMatchDFr.makeCandidateList(tExp, sExp, self.ksize))</div>
              ?                                                                                       +++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#cca1e80e">cca1e80e</a> -                                                                                                 sExp,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#4e585250">4e585250</a> -                                                                                                 self.ksize))</div>
                
                    def tearDown(self):
                        del self.configAL
                        del self.configDF
                        del self.configDFr
                        del self.psf
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(PsfMatchTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="57b19673"/></a>57b19673</h3>

<pre>
commit 57b19673488ac33f17461fcdeeffdd6203f64d9c
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Mon Apr 20 16:57:34 2015 +0900

    Set tests to use original background config params.
</pre>
<h3><a name="4e585250"/></a>4e585250</h3>

<pre>
commit 4e5852509d8fbf32da2a94bc183cb78d9fa1d60f
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Apr 4 11:56:28 2013 -0700

    Fixing failing unit tests.
</pre>
<h3><a name="9a8b565a"/></a>9a8b565a</h3>

<pre>
commit 9a8b565a2257570cc7c685089f89b480a4911342
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 22 10:49:09 2012 -0800

    Config uses registries now.
</pre>
<h3><a name="b3a497e9"/></a>b3a497e9</h3>

<pre>
commit b3a497e98a5a28c0b7056eb58696f12cee049dad
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Thu Feb 14 16:26:34 2013 -0800

    Fixed unit tests and added detection and measurement code
</pre>
<h3><a name="cca1e80e"/></a>cca1e80e</h3>

<pre>
commit cca1e80e719df66265e1492d127e9661ac244a35
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 22 16:09:49 2013 -0700

    Initial round of fixes to based on Paul's W13 review.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_84"><a name="examples/runSubtractMaskedImages.py"/></a>examples/runSubtractMaskedImages.py</h1>

<h3 id="toc_85">Diff:</h3>

<pre>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#109bd96b">109bd96b</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import sys
                import os
                import optparse
                
                import lsst.daf.base as dafBase
                import lsst.afw.image as afwImage
                import lsst.afw.display.ds9 as ds9
                
                from lsst.pex.logging import Trace
                from lsst.pex.logging import Log
                
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                
                def main():
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#109bd96b">109bd96b</a> -     imageProcDir = eups.productDir('ip_diffim')</div>
              ?                    ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#48e85303">48e85303</a> +     imageProcDir = lsst.utils.getPackageDir('ip_diffim')</div>
              ?                    ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#109bd96b">109bd96b</a> -     if imageProcDir == None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#109bd96b">109bd96b</a> -         print 'Error: could not set up ip_diffim'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#109bd96b">109bd96b</a> -         sys.exit(1)</div>
                
                    defSciencePath  = None
                    defTemplatePath = None
                    defOutputPath   = 'diffImage.fits'
                    defVerbosity    = 5
                    defFwhm         = 3.5
                    
                    usage = """usage: %%prog [options] [scienceImage [templateImage [outputImage]]]]
                
                Notes:
                - image arguments are paths to MaskedImage fits files
                - image arguments must NOT include the final _img.fits
                - the result is science image - template image
                - the template image is convolved, the science image is not
                - default scienceMaskedImage=%s
                - default templateMaskedImage=%s
                - default outputImage=%s 
                """ % (defSciencePath, defTemplatePath, defOutputPath)
                    
                    parser = optparse.OptionParser(usage)
                    parser.add_option('-v', '--verbosity', type=int, default=defVerbosity,
                                      help='verbosity of Trace messages')
                    parser.add_option('-d', '--display', action='store_true', default=False,
                                      help='display the images')
                    parser.add_option('-b', '--bg', action='store_true', default=False,
                                      help='subtract backgrounds')
                    parser.add_option('--fwhmS', type=float,
                                      help='Science Image Psf Fwhm (pixel)')
                    parser.add_option('--fwhmT', type=float,
                                      help='Template Image Psf Fwhm (pixel)')
                                      
                    (options, args) = parser.parse_args()
                    
                    def getArg(ind, defValue):
                        if ind < len(args):
                            return args[ind]
                        return defValue
                    
                    sciencePath     = getArg(0, defSciencePath)
                    templatePath    = getArg(1, defTemplatePath)
                    outputPath      = getArg(2, defOutputPath)
                
                    if sciencePath == None or templatePath == None:
                        parser.print_help()
                        sys.exit(1)
                    
                    print 'Science image: ', sciencePath
                    print 'Template image:', templatePath
                    print 'Output image:  ', outputPath
                
                    fwhmS = defFwhm
                    if options.fwhmS:
                        print 'FwhmS =', options.fwhmS
                        fwhmS = options.fwhmS
                
                    fwhmT = defFwhm
                    if options.fwhmT:
                        print 'Fwhmt =', options.fwhmT
                        fwhmT = options.fwhmT
                
                    display = False
                    if options.display:
                        print 'Display =', options.display
                        display = True
                
                    bgSub = False
                    if options.bg:
                        print 'Background subtract =', options.bg
                        bgSub = True
                
                    if options.verbosity > 0:
                        print 'Verbosity =', options.verbosity
                        Trace.setVerbosity('lsst.ip.diffim', options.verbosity)
                        
                    ####
                        
                    templateMaskedImage = afwImage.MaskedImageF(templatePath)
                    scienceMaskedImage  = afwImage.MaskedImageF(sciencePath)
                
                    config = ipDiffim.ImagePsfMatchTask.ConfigClass()
                    config.kernel.name = "AL"
                    subconfig = config.kernel.active
                
                    if bgSub:
                        diffimTools.backgroundSubtract(subconfig.afwBackgroundConfig,
                                                       [templateMaskedImage, scienceMaskedImage])
                    else:
                        if subconfig.fitForBackground == False:
                            print 'NOTE: no background subtraction at all is requested'
                
                    psfmatch = ipDiffim.ImagePsfMatchTask(subconfig)
                    results  = psfmatch.run(templateMaskedImage, scienceMaskedImage, "subtractMaskedImages",
                                            templateFwhmPix = fwhmT, scienceFwhmPix = fwhmS)
                
                    differenceMaskedImage = results.subtractedImage
                    differenceMaskedImage.writeFits(outputPath)
                
                    if False:
                        spatialKernel = results.psfMatchingKernel
                        print spatialKernel.getSpatialParameters()
                    
                    if display:
                        ds9.mtv(differenceMaskedImage)
                
                def run():
                    Log.getDefaultLog()
                    memId0 = dafBase.Citizen_getNextMemId()
                    main()
                    # check for memory leaks
                    if dafBase.Citizen_census(0, memId0) != 0:
                        print dafBase.Citizen_census(0, memId0), 'Objects leaked:'
                        print dafBase.Citizen_census(dafBase.cout, memId0)
                
                if __name__ == '__main__':
                    run()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="109bd96b"/></a>109bd96b</h3>

<pre>
commit 109bd96b9bc7942af46bcbb13b1e97004a648989
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Mar 5 20:41:18 2009 +0000

    Merging of ticket #354 to trunk.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_86"><a name="tests/BuildSpatialKernelVisitor.py"/></a>tests/BuildSpatialKernelVisitor.py</h1>

<h3 id="toc_87">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c96bb23c">c96bb23c</a> - import os, sys</div>
                import unittest
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#c96bb23c">c96bb23c</a> - import lsst.afw.math as afwMath</div>
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#c96bb23c">c96bb23c</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#4a142468">4a142468</a> - import numpy</div>
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                # This tests the basics of the BuildSpatialKernelVisitor.  E.g. that
                # it makes the right size solution.  For more complex behaviors such
                # as reducing a delta function basis set into a Pca basis set, look at
                # FitSpatialKernelFromCandidates.py
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "AL"
                        self.subconfig = self.config.kernel.active
                
                        self.policy = pexConfig.makePolicy(self.subconfig)
                        self.size   = 51
                
                    def tearDown(self):
                        del self.policy
                
                    def makeCandidate(self, kSum, x, y):
                        mi1 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi1.getVariance().set(1.0) # avoid NaNs
                        mi1.set(self.size//2, self.size//2, (1, 0x0, 1))
                        mi2 = afwImage.MaskedImageF(afwGeom.Extent2I(self.size, self.size))
                        mi2.getVariance().set(1.0) # avoid NaNs
                        mi2.set(self.size//2, self.size//2, (kSum, 0x0, kSum))
                        kc = ipDiffim.makeKernelCandidate(x, y, mi1, mi2, self.policy)
                        return kc
                
                    def testNoBg(self):
                        self.runNoBg(0)
                        self.runNoBg(1)
                        self.runNoBg(2)
                
                    def runNoBg(self, sko):
                        basisList = ipDiffim.makeKernelBasisList(self.subconfig)
                        self.policy.set('spatialKernelOrder', sko)
                        self.policy.set('fitForBackground', False)
                
                        bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0),
                                             afwGeom.Extent2I(self.size*10, self.size*10))
                
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)
                        
                        for x in range(1, self.size, 10):
                            for y in range(1, self.size, 10):
                                cand = self.makeCandidate(1.0, x, y)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                
                        # Kernel
                        if sko == 0:
                            # Specialization for speedup
                            spatialKernelSolution = sk.getKernelParameters()
                
                            # One term for each basis function
                            self.assertEqual(len(spatialKernelSolution), len(basisList))
                            
                        else:
                            spatialKernelSolution = sk.getSpatialParameters()
                
                            nSpatialTerms = int(0.5 * (sko + 1) * (sko + 2))
                            # One model for each basis function
                            self.assertEqual(len(spatialKernelSolution), len(basisList))
                            # First basis has no spatial variation
                            for i in range(1, nSpatialTerms):
                                self.assertEqual(spatialKernelSolution[0][i], 0.)
                            # All bases have correct number of terms
                            for i in range(len(spatialKernelSolution)):
                                self.assertEqual(len(spatialKernelSolution[i]), nSpatialTerms)
                
                        # Background
                        spatialBgSolution = sb.getParameters()
                        nBgTerms = 1
                        self.assertEqual(len(spatialBgSolution), nBgTerms)
                
                    def testModelType(self):
                        bbox = afwGeom.Box2I(afwGeom.Point2I(10, 10),
                                             afwGeom.Extent2I(10, 10))
                        basisList = ipDiffim.makeKernelBasisList(self.subconfig)
                        
                        self.policy.set("spatialModelType", "polynomial") 
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#9093b760">9093b760</a> -         bspkv = ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
              ?        --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#966eaa96">966eaa96</a> +         ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
                
                        self.policy.set("spatialModelType", "chebyshev1") 
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#9093b760">9093b760</a> -         bspkv = ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
              ?        --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#966eaa96">966eaa96</a> +         ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
                
                        try:
                            self.policy.set("spatialModelType", "foo") 
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#9093b760">9093b760</a> -             bspkv = ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
              ?            --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#966eaa96">966eaa96</a> +             ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#9093b760">9093b760</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#966eaa96">966eaa96</a> +         except Exception:</div>
              ?               ++++++++++
                            pass
                        else:
                            self.fail()
                            
                        
                    def testAlSpatialModel(self):
                        self.runAlSpatialModel(0, 0)
                        self.runAlSpatialModel(1, 0)
                        self.runAlSpatialModel(0, 1)
                        self.runAlSpatialModel(1, 1)
                        self.runAlSpatialModel(2, 2)
                        
                    def runAlSpatialModel(self, sko, bgo):
                        basisList = ipDiffim.makeKernelBasisList(self.subconfig)
                        self.policy.set('spatialKernelOrder', sko)
                        self.policy.set('spatialBgOrder', bgo)
                        self.policy.set('fitForBackground', True)
                
                        bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0),
                                             afwGeom.Extent2I(self.size*10, self.size*10))
                
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(basisList, bbox, self.policy)
                        
                        for x in range(1, self.size, 10):
                            for y in range(1, self.size, 10):
                                cand = self.makeCandidate(1.0, x, y)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                
                        # Kernel
                        if sko == 0:
                            # Specialization for speedup
                            spatialKernelSolution = sk.getKernelParameters()
                
                            # One term for each basis function
                            self.assertEqual(len(spatialKernelSolution), len(basisList))
                            
                        else:
                            spatialKernelSolution = sk.getSpatialParameters()
                
                            nSpatialTerms = int(0.5 * (sko + 1) * (sko + 2))
                            # One model for each basis function
                            self.assertEqual(len(spatialKernelSolution), len(basisList))
                            # First basis has no spatial variation
                            for i in range(1, nSpatialTerms):
                                self.assertEqual(spatialKernelSolution[0][i], 0.)
                            # All bases have correct number of terms
                            for i in range(len(spatialKernelSolution)):
                                self.assertEqual(len(spatialKernelSolution[i]), nSpatialTerms)
                
                        # Background
                        spatialBgSolution = sb.getParameters()
                        nBgTerms = int(0.5 * (bgo + 1) * (bgo + 2))
                        self.assertEqual(len(spatialBgSolution), nBgTerms)
                
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="9093b760"/></a>9093b760</h3>

<pre>
commit 9093b760a12d30efdb11b875efcbb249d8c483af
Author: becker <becker@git.lsstcorp.org>
Date:   Fri May 13 21:11:35 2011 +0000

    Added in Cheby, but disabled until debugged.  #1140.
</pre>
<h3><a name="4a142468"/></a>4a142468</h3>

<pre>
commit 4a1424680ee49ebf9e6c38ea23cbef28eb733a34
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Apr 27 20:48:06 2010 +0000

    Added option to not fit for background in kernel (no cross terms).  Moved spatial matrix functionality to KernelSolution.  #1140.
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_88"><a name="python/lsst/ip/diffim/makeRatingVector.py"/></a>python/lsst/ip/diffim/makeRatingVector.py</h1>

<h3 id="toc_89">Diff:</h3>

<pre>
                # all the c++ level classes and routines
                import diffimLib
                
                # all the other LSST packages
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#99917838">99917838</a> - import lsst.pex.logging as pexLog</div>
                
                # Basically deprecated until SDQA is replaced
                
                def makeRatingVector(kernelCellSet, spatialKernel, spatialBg):
                    imstats    = diffimLib.ImageStatisticsF()
                    #sdqaVector = sdqa.SdqaRatingSet()
                
                    width, height = spatialKernel.getDimensions()
                    kImage        = afwImage.ImageD(width, height)
                    # find the kernel sum and its Rms by looking at the 4 corners of the image
                    kSums = afwMath.vectorD()
                    for x in (0, width):
                        for y in (0, height):
                            kSum = spatialKernel.computeImage(kImage, False, x, y)
                            kSums.push_back(kSum)
                            
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#99917838">99917838</a> -     afwStat    = afwMath.makeStatistics(kSums, afwMath.MEAN | afwMath.STDEV)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#966eaa96">966eaa96</a> +     #afwStat    = afwMath.makeStatistics(kSums, afwMath.MEAN | afwMath.STDEV)</div>
              ?     +
                    #kSumRating = sdqa.SdqaRating("lsst.ip.diffim.kernel_sum",
                    #                             afwStat.getValue(afwMath.MEAN),
                    #                             afwStat.getValue(afwMath.STDEV),
                    #                             scope)
                    #sdqaVector.append(kSumRating)
                
                    nGood = 0
                    nBad  = 0
                    for cell in kernelCellSet.getCellList():
                        for cand in cell.begin(False): # False = include bad candidates
                            cand = diffimLib.cast_KernelCandidateF(cand)
                            if cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                # this has been used for processing
                                nGood += 1
                    
                                xCand = int(cand.getXCenter())
                                yCand = int(cand.getYCenter())
                
                                # evaluate kernel and background at position of candidate
                                kSum = spatialKernel.computeImage(kImage, False, xCand, yCand)
                                kernel = afwMath.FixedKernel(kImage)
                                background = spatialBg(xCand, yCand)
                
                                diffIm = cand.getDifferenceImage(kernel, background)
                                imstats.apply(diffIm)
                                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#99917838">99917838</a> -                 candMean   = imstats.getMean()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#966eaa96">966eaa96</a> +                 #candMean   = imstats.getMean()</div>
              ?                 +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#99917838">99917838</a> -                 candRms    = imstats.getRms()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#966eaa96">966eaa96</a> +                 #candRms    = imstats.getRms()</div>
              ?                 +
                                #candRating = sdqa.SdqaRating("lsst.ip.diffim.residuals_%d_%d" % (xCand, yCand),
                                #                             candMean, candRms, scope)
                                #sdqaVector.append(candRating)
                            elif cand.getStatus() == afwMath.SpatialCellCandidate.BAD:
                                nBad += 1
                
                    #nGoodRating = sdqa.SdqaRating("lsst.ip.diffim.nCandGood", nGood, 0, scope)
                    #sdqaVector.append(nGoodRating)
                    #nBadRating = sdqa.SdqaRating("lsst.ip.diffim.nCandBad", nBad, 0, scope)
                    #sdqaVector.append(nBadRating)
                
                    nKernelTerms = spatialKernel.getNSpatialParameters()
                    if nKernelTerms == 0: # order 0
                        nKernelTerms = 1
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#e7bd7d96">e7bd7d96</a> -     nBgTerms     = len(spatialBg.getParameters())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#966eaa96">966eaa96</a> +     #nBgTerms     = len(spatialBg.getParameters())</div>
              ?     +
                    #nKernRating  = sdqa.SdqaRating("lsst.ip.diffim.nTermsSpatialKernel", nKernelTerms, 0, scope)
                    #nBgRating    = sdqa.SdqaRating("lsst.ip.diffim.nTermsSpatialBg", nBgTerms, 0, scope)
                    #sdqaVector.append(nKernRating)
                    #sdqaVector.append(nBgRating)
                
                    #for i in range(sdqaVector.size()):
                    #    pexLog.Trace("lsst.ip.diffim.makeSdqaRatingVector", 5,
                    #                 "Sdqa Rating %s : %.2f %.2f" % (sdqaVector[i].getName(),
                    #                                                 sdqaVector[i].getValue(),
                    #                                                 sdqaVector[i].getErr()))
                    #                 
                    #return sdqaVector
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="99917838"/></a>99917838</h3>

<pre>
commit 99917838e0e11c2d4cd1c682419f471738ab06b2
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Oct 23 17:23:29 2009 +0000

    Reworked detection, aded sdqa rating calculation, renamed arguments to
    psf mathcing code.  #876.
</pre>
<h3><a name="e7bd7d96"/></a>e7bd7d96</h3>

<pre>
commit e7bd7d966233faa1a6d15862e6cb0cecd404a094
Author: becker <becker@git.lsstcorp.org>
Date:   Tue May 17 21:20:32 2011 +0000

    Additional testing of number of candidates vs. number of terms in spatial model.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_90"><a name="src/KernelPca.cc"/></a>src/KernelPca.cc</h1>

<h3 id="toc_91">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file KernelPca.cc
                 *
                 * @brief Implementation of KernelPca and KernelPcaVisitor 
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                
                #include "lsst/afw/math.h"
                #include "lsst/afw/image.h"
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/KernelCandidate.h"
                #include "lsst/ip/diffim/KernelPca.h"
                
                namespace afwMath        = lsst::afw::math;
                namespace afwImage       = lsst::afw::image;
                namespace pexLogging     = lsst::pex::logging; 
                namespace pexExcept      = lsst::pex::exceptions; 
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                namespace detail {
                
                    /**
                     * @class KernelPcaVisitor
                     *
                     * @ingroup ip_diffim
                     *
                     * @brief A class to run a PCA on all candidate kernels (represented as
                     * Images).
                     *
                     * @note Templated on the pixel types of the MaskedImages it will be
                     * visiting (typically float).
                     *
                     * @note Works in concert with a afwMath::SpatialCellSet and ip::Diffim
                     * KernelPca to create a Karhunen-Loeve basis from all the good
                     * KernelCandidates.  This class adds the extra functionality to subtract
                     * off the mean kernel from all entries, which makes the resulting basis
                     * more compact.  The user needs to manually add this mean image into the
                     * resulting basis list after imagePca.analyze() is called.
                     * 
                     * @note KernelPca (and base class afwImage::ImagePca) weight objects of
                     * different brightness differently.  However we don't necessarily want
                     * images with larger kernel sums to have more weight.  Each kernel should
                     * have constant weight in the Pca.  For simplicity we scale them to have
                     * the same kernel sum, 1.0, and send to ImagePca that the flux (weight) is
                     * 1.0.
                     * 
                     */
                    template<typename PixelT>
                    KernelPcaVisitor<PixelT>::KernelPcaVisitor(
                        boost::shared_ptr<KernelPca<ImageT> > imagePca ///< Set of Images to initialise
                        ) :
                        afwMath::CandidateVisitor(),
                        _imagePca(imagePca),
                        _mean() 
                    {};
                
                    template<typename PixelT>
                    lsst::afw::math::KernelList KernelPcaVisitor<PixelT>::getEigenKernels() {
                        afwMath::KernelList kernelList;
                
                        std::vector<typename ImageT::Ptr> eigenImages = _imagePca->getEigenImages();
                        int ncomp = eigenImages.size();
                
                        if (_mean) {
                            kernelList.push_back(afwMath::Kernel::Ptr(
                                                     new afwMath::FixedKernel(
                                                         afwImage::Image<afwMath::Kernel::Pixel>
                                                         (*_mean, true))));
                        }
                        for (int i = 0; i < ncomp; i++) {
                            afwImage::Image<afwMath::Kernel::Pixel> img = 
                                afwImage::Image<afwMath::Kernel::Pixel>(*eigenImages[i], true);
                            kernelList.push_back(afwMath::Kernel::Ptr(
                                                     new afwMath::FixedKernel(img)
                                                     ));
                        }
                
                        return kernelList;
                    }
                
                    template<typename PixelT>
                    void KernelPcaVisitor<PixelT>::processCandidate(lsst::afw::math::SpatialCellCandidate *candidate) {
                        
                        KernelCandidate<PixelT> *kCandidate = dynamic_cast<KernelCandidate<PixelT> *>(candidate);
                        if (kCandidate == NULL) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#8f24bdc0">8f24bdc0</a> -             throw LSST_EXCEPT(pexExcept::LogicErrorException,</div>
              ?                                                    ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::LogicError,</div>
                                              "Failed to cast SpatialCellCandidate to KernelCandidate");
                        }
                        pexLogging::TTrace<6>("lsst.ip.diffim.SetPcaImageVisitor.processCandidate", 
                                              "Processing candidate %d", kCandidate->getId());
                        
                        try {
                            /* Normalize to unit sum */
                            PTR(ImageT) kImage = kCandidate->getKernelSolution(
                                KernelCandidate<PixelT>::ORIG)->makeKernelImage();
                            *kImage           /= kCandidate->getKernelSolution(
                                KernelCandidate<PixelT>::ORIG)->getKsum();
                            /* Tell imagePca they have the same weighting in the Pca */
                            _imagePca->addImage(kImage, 1.0);
                        } catch(pexExcept::Exception &e) {
                            return;
                        }
                    }
                
                    template<typename PixelT>
                    void KernelPcaVisitor<PixelT>::subtractMean() {
                        /* 
                           If we don't subtract off the mean before we do the Pca, the
                           subsequent terms carry less of the power than if you do subtract
                           off the mean.  Explicit example:
                           
                           With mean subtraction:
                             DEBUG: Eigenvalue 0 : 0.010953 (0.373870 %)
                             DEBUG: Eigenvalue 1 : 0.007927 (0.270604 %)
                             DEBUG: Eigenvalue 2 : 0.001393 (0.047542 %)
                             DEBUG: Eigenvalue 3 : 0.001092 (0.037261 %)
                             DEBUG: Eigenvalue 4 : 0.000829 (0.028283 %)
                           
                           Without mean subtraction:
                             DEBUG: Eigenvalue 0 : 0.168627 (0.876046 %)
                             DEBUG: Eigenvalue 1 : 0.007935 (0.041223 %)
                             DEBUG: Eigenvalue 2 : 0.006049 (0.031424 %)
                             DEBUG: Eigenvalue 3 : 0.001188 (0.006173 %)
                             DEBUG: Eigenvalue 4 : 0.001050 (0.005452 %)
                
                           After the first term above, which basically represents the mean,
                           the remaining terms carry less of the power than if you do
                           subtract off the mean.  (0.041223/(1-0.876046) < 0.373870).
                         */
                        pexLogging::TTrace<6>("lsst.ip.diffim.KernelPcaVisitor.subtractMean", 
                                              "Subtracting mean feature before Pca");
                        
                        _mean = _imagePca->getMean();
                        KernelPca<ImageT>::ImageList imageList = _imagePca->getImageList();
                        for (typename KernelPca<ImageT>::ImageList::const_iterator ptr = imageList.begin(), 
                                 end = imageList.end(); ptr != end; ++ptr) {
                            **ptr -= *_mean;
                        }
                    }
                
                    /**
                     * @class KernelPca
                     *
                     * @ingroup ip_diffim
                     *
                     * @brief Overrides the analyze method of base class afwImage::ImagePca
                     *
                     * @note Templated on the Image types it is running on (typically
                     * [exclusively?] afwMath::Kernel::Pixel, which is double)
                     *
                     * @note This override normalizes the resulting eigenImages to have peak
                     * value of 1.0.
                     *
                     */
                    template <typename ImageT>
                    void KernelPca<ImageT>::analyze()
                    {
                        Super::analyze();
                        
                        typename Super::ImageList const &eImageList = this->getEigenImages();
                        typename Super::ImageList::const_iterator iter = eImageList.begin(), end = eImageList.end();
                        for (size_t i = 0; iter != end; ++i, ++iter) {
                            PTR(ImageT) eImage = *iter;
                            
                            /*
                             * Normalise eigenImages to have a maximum of 1.0.  For n > 0 they
                             * (should) have mean == 0, so we can't use that to normalize
                             */
                            afwMath::Statistics stats = afwMath::makeStatistics(*eImage, (afwMath::MIN | afwMath::MAX));
                            double const min = stats.getValue(afwMath::MIN);
                            double const max = stats.getValue(afwMath::MAX);
                            
                            double const extreme = (fabs(min) > max) ? min :max;
                            if (extreme != 0.0) {
                                *eImage /= extreme;
                            }
                        }
                    }
                
                
                    typedef float PixelT;
                    template class KernelPcaVisitor<PixelT>;
                    template class KernelPca<afwImage::Image<afwMath::Kernel::Pixel> >;
                
                }}}} // end of namespace lsst::ip::diffim::detail
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="8f24bdc0"/></a>8f24bdc0</h3>

<pre>
commit 8f24bdc07cdb2c19bd32dd3d73fdb4d586f9b92f
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Jan 18 12:59:50 2013 -0800

    Renaming files from KernelPcaVisitor to KernelPca.  Adding KernelPca class, subclassed from ImagePca.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_92"><a name="python/lsst/ip/diffim/psfMatch.py"/></a>python/lsst/ip/diffim/psfMatch.py</h1>

<h3 id="toc_93">Diff:</h3>

<pre>
                #
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import time
                import numpy as num
                import lsst.afw.image as afwImage
                import lsst.pex.logging as pexLog
                import lsst.pex.exceptions as pexExcept
                import lsst.pex.config as pexConfig
                import lsst.afw.math as afwMath
                import lsst.afw.display.ds9 as ds9
                import lsst.pipe.base as pipeBase
                from lsst.meas.algorithms.detection import BackgroundConfig
                from . import utils as diUtils
                from . import diffimLib
                
                class DetectionConfig(pexConfig.Config):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#8b7f49ff">8b7f49ff</a> +     """!Configuration for detecting sources on images for building a PSF-matching kernel</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#8b7f49ff">8b7f49ff</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#8b7f49ff">8b7f49ff</a> +     Configuration for turning detected lsst.afw.detection.FootPrints into an acceptable </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#8b7f49ff">8b7f49ff</a> +     (unmasked, high signal-to-noise, not too large or not too small) list of </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#8b7f49ff">8b7f49ff</a> +     lsst.ip.diffim.KernelSources that are used to build the Psf-matching kernel"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#7c5682a9">7c5682a9</a> + </div>
                    detThreshold = pexConfig.Field(
                        dtype = float,
                        doc = "Value of footprint detection threshold",
                        default = 10.0,
                        check = lambda x : x >= 3.0
                    )
                    detThresholdType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "Type of detection threshold",
                        default = "pixel_stdev",
                        allowed = {
                           "value"       : "Use counts as the detection threshold type",
                           "stdev"       : "Use standard deviation of image plane",
                           "variance"    : "Use variance of image plane",
                           "pixel_stdev" : "Use stdev derived from variance plane"
                        }
                    )
                    detOnTemplate = pexConfig.Field(
                        dtype = bool,
                        doc = """If true run detection on the template (image to convolve);
                                 if false run detection on the science image""",
                        default = True
                    )
                    badMaskPlanes = pexConfig.ListField(
                        dtype = str,
                        doc = """Mask planes that lead to an invalid detection.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#11ed452e">11ed452e</a> -                  Options: NO_DATA EDGE SAT BAD CR INTRP""",</div>
              ?                           --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#adb9c713">adb9c713</a> +                  Options: EDGE SAT BAD CR INTRP""",</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#11ed452e">11ed452e</a> -         default = ("NO_DATA", "SAT")</div>
              ?                     ^^^ ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#e278f3b9">e278f3b9</a> +         default = ("EDGE", "SAT")</div>
              ?                     ^ ^^
                    )
                    fpNpixMin = pexConfig.Field(
                        dtype = int,
                        doc = "Minimum number of pixels in an acceptable Footprint",
                        default = 5,
                        check = lambda x : x >= 5
                    )
                    fpNpixMax = pexConfig.Field(
                        dtype = int,
                        doc = """Maximum number of pixels in an acceptable Footprint;
                                 too big and the subsequent convolutions become unwieldy""",
                        default = 500,
                        check = lambda x : x <= 500
                    )
                    fpGrowKernelScaling = pexConfig.Field(
                        dtype = float,
                        doc = """If config.scaleByFwhm, grow the footprint based on
                                 the final kernelSize.  Each footprint will be
                                 2*fpGrowKernelScaling*kernelSize x
                                 2*fpGrowKernelScaling*kernelSize.  With the value
                                 of 1.0, the remaining pixels in each KernelCandiate
                                 after convolution by the basis functions will be
                                 eqaul to the kernel size iteslf.""",
                        default = 1.0,
                        check = lambda x : x >= 1.0
                    )
                    fpGrowPix = pexConfig.Field(
                        dtype = int,
                        doc = """Growing radius (in pixels) for each raw detection
                                 footprint.  The smaller the faster; however the
                                 kernel sum does not converge if the stamp is too
                                 small; and the kernel is not constrained at all if
                                 the stamp is the size of the kernel.  The grown stamp
                                 is 2 * fpGrowPix pixels larger in each dimension.
                                 This is overridden by fpGrowKernelScaling if scaleByFwhm""",
                        default = 30,
                        check = lambda x : x >= 10
                    )
                    scaleByFwhm = pexConfig.Field(
                        dtype = bool,
                        doc = "Scale fpGrowPix by input Fwhm?",
                        default = True,
                    )
                
                
                class PsfMatchConfig(pexConfig.Config):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#8b7f49ff">8b7f49ff</a> +     """!Base configuration for Psf-matching</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#8b7f49ff">8b7f49ff</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#8b7f49ff">8b7f49ff</a> +     The base configuration of the Psf-matching kernel, and of the warping, detection, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#0184f44e">0184f44e</a> +     and background modeling subTasks."""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#7c5682a9">7c5682a9</a> + </div>
                    warpingConfig = pexConfig.ConfigField("Config for warping exposures to a common alignment",
                                                          afwMath.warper.WarperConfig)
                    detectionConfig = pexConfig.ConfigField("Controlling the detection of sources for kernel building",
                                                            DetectionConfig)
                    afwBackgroundConfig = pexConfig.ConfigField("Controlling the Afw background fitting",
                                                                BackgroundConfig)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#906178a2">906178a2</a> -     # Background fitting</div>
                    useAfwBackground = pexConfig.Field(
                        dtype = bool,
                        doc = "Use afw background subtraction instead of ip_diffim",
                        default = False,
                    )
                    fitForBackground = pexConfig.Field(
                        dtype = bool,
                        doc = "Include terms (including kernel cross terms) for background in ip_diffim",
                        default = False,
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#906178a2">906178a2</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#906178a2">906178a2</a> -     # Basis set selection</div>
                    kernelBasisSet = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "Type of basis set for PSF matching kernel.",
                        default = "alard-lupton",
                        allowed = {
                            "alard-lupton" : """Alard-Lupton sum-of-gaussians basis set,
                                           * The first term has no spatial variation
                                           * The kernel sum is conserved
                                           * You may want to turn off 'usePcaForSpatialKernel'""",
                            "delta-function" : """Delta-function kernel basis set,
                                           * You may enable the option useRegularization
                                           * You should seriously consider usePcaForSpatialKernel, which will also
                                             enable kernel sum conservation for the delta function kernels"""
                        }
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#906178a2">906178a2</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#906178a2">906178a2</a> -     # Kernel size</div>
                    kernelSize = pexConfig.Field(
                        dtype = int,
                        doc = """Number of rows/columns in the convolution kernel; should be odd-valued.
                                 Modified by kernelSizeFwhmScaling if scaleByFwhm = true""",
                        default = 21,
                    )
                    scaleByFwhm = pexConfig.Field(
                        dtype = bool,
                        doc = "Scale kernelSize, alardGaussians by input Fwhm",
                        default = True,
                    )
                    kernelSizeFwhmScaling = pexConfig.Field(
                        dtype = float,
                        doc = """How much to scale the kernel size based on the largest AL Sigma""",
                        default = 6.0,
                        check = lambda x : x >= 1.0
                    )
                    kernelSizeMin = pexConfig.Field(
                        dtype = int,
                        doc = """Minimum Kernel Size""",
                        default = 21,
                    )
                    kernelSizeMax = pexConfig.Field(
                        dtype = int,
                        doc = """Maximum Kernel Size""",
                        default = 35,
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#906178a2">906178a2</a> -     #####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#906178a2">906178a2</a> -     # Spatial modeling</div>
                    spatialModelType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "Type of spatial functions for kernel and background",
                        default = "chebyshev1",
                        allowed = {
                            "chebyshev1" : "Chebyshev polynomial of the first kind",
                            "polynomial" : "Standard x,y polynomial",
                        }
                    )
                    spatialKernelOrder = pexConfig.Field(
                        dtype = int,
                        doc = "Spatial order of convolution kernel variation",
                        default = 2,
                        check = lambda x : x >= 0
                    )
                    spatialBgOrder = pexConfig.Field(
                        dtype = int,
                        doc = "Spatial order of differential background variation",
                        default = 1,
                        check = lambda x : x >= 0
                    )
                    sizeCellX = pexConfig.Field(
                        dtype = int,
                        doc = "Size (rows) in pixels of each SpatialCell for spatial modeling",
                        default = 128,
                        check = lambda x : x >= 32
                    )
                    sizeCellY = pexConfig.Field(
                        dtype = int,
                        doc = "Size (columns) in pixels of each SpatialCell for spatial modeling",
                        default = 128,
                        check = lambda x : x >= 32
                    )
                    nStarPerCell = pexConfig.Field(
                        dtype = int,
                        doc = "Number of KernelCandidates in each SpatialCell to use in the spatial fitting",
                        default = 3,
                        check = lambda x : x >= 1
                    )
                    maxSpatialIterations = pexConfig.Field(
                        dtype = int,
                        doc = "Maximum number of iterations for rejecting bad KernelCandidates in spatial fitting",
                        default = 3,
                        check = lambda x : x >= 1 and x <= 5
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#f4985e17">f4985e17</a> -     # Spatial modeling; Pca</div>
                    usePcaForSpatialKernel = pexConfig.Field(
                        dtype = bool,
                        doc = """Use Pca to reduce the dimensionality of the kernel basis sets.
                                 This is particularly useful for delta-function kernels.
                                 Functionally, after all Cells have their raw kernels determined, we run
                                 a Pca on these Kernels, re-fit the Cells using the eigenKernels and then
                                 fit those for spatial variation using the same technique as for Alard-Lupton kernels.
                                 If this option is used, the first term will have no spatial variation and the
                                 kernel sum will be conserved.""",
                        default = False,
                    )
                    subtractMeanForPca = pexConfig.Field(
                        dtype = bool,
                        doc = "Subtract off the mean feature before doing the Pca",
                        default = True,
                    )
                    numPrincipalComponents = pexConfig.Field(
                        dtype = int,
                        doc = """Number of principal components to use for Pca basis, including the
                                 mean kernel if requested.""",
                        default = 5,
                        check = lambda x : x >= 3
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#f4985e17">f4985e17</a> -     # What types of clipping of KernelCandidates to enable</div>
                    singleKernelClipping = pexConfig.Field(
                        dtype = bool,
                        doc = "Do sigma clipping on each raw kernel candidate",
                        default = True,
                    )
                    kernelSumClipping = pexConfig.Field(
                        dtype = bool,
                        doc = "Do sigma clipping on the ensemble of kernel sums",
                        default = True,
                    )
                    spatialKernelClipping = pexConfig.Field(
                        dtype = bool,
                        doc = "Do sigma clipping after building the spatial model",
                        default = True,
                    )
                    checkConditionNumber = pexConfig.Field(
                        dtype = bool,
                        doc = """Test for maximum condition number when inverting a kernel matrix.
                                 Anything above maxConditionNumber is not used and the candidate is set as BAD.
                                 Also used to truncate inverse matrix in estimateBiasedRisk.  However,
                                 if you are doing any deconvolution you will want to turn this off, or use
                                 a large maxConditionNumber""",
                        default = False,
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#e58cdb50">e58cdb50</a> -     # Clipping of KernelCandidates based on diffim residuals; </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#e58cdb50">e58cdb50</a> -     # used with singleKernelClipping and spatialKernelClipping</div>
                    badMaskPlanes = pexConfig.ListField(
                        dtype = str,
                        doc = """Mask planes to ignore when calculating diffim statistics
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#11ed452e">11ed452e</a> -                  Options: NO_DATA EDGE SAT BAD CR INTRP""",</div>
              ?                           --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#116067c8">116067c8</a> +                  Options: EDGE SAT BAD CR INTRP""",</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#11ed452e">11ed452e</a> -         default = ("NO_DATA", "SAT")</div>
              ?                     ^^^ ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#116067c8">116067c8</a> +         default = ("EDGE", "SAT")</div>
              ?                     ^ ^^
                    )
                    candidateResidualMeanMax = pexConfig.Field(
                        dtype = float,
                        doc = """Rejects KernelCandidates yielding bad difference image quality.
                                 Used by BuildSingleKernelVisitor, AssessSpatialKernelVisitor.
                                 Represents average over pixels of (image/sqrt(variance)).""",
                        default = 0.25,
                        check = lambda x : x >= 0.0
                    )
                    candidateResidualStdMax = pexConfig.Field(
                        dtype = float,
                        doc = """Rejects KernelCandidates yielding bad difference image quality.
                                 Used by BuildSingleKernelVisitor, AssessSpatialKernelVisitor.
                                 Represents stddev over pixels of (image/sqrt(variance)).""",
                        default = 1.50,
                        check = lambda x : x >= 0.0
                    )
                    useCoreStats = pexConfig.Field(
                        dtype = bool,
                        doc = """Use the core of the footprint for the quality statistics, instead of the entire footprint.
                                 WARNING: if there is deconvolution we probably will need to turn this off""",
                        default = False,
                    )
                    candidateCoreRadius = pexConfig.Field(
                        dtype = int,
                        doc = """Radius for calculation of stats in 'core' of KernelCandidate diffim.
                                 Total number of pixels used will be (2*radius)**2.
                                 This is used both for 'core' diffim quality as well as ranking of
                                 KernelCandidates by their total flux in this core""",
                        default = 3,
                        check = lambda x : x >= 1
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#f4985e17">f4985e17</a> -     # Clipping of KernelCandidates based on kernel sum distribution</div>
                    maxKsumSigma = pexConfig.Field(
                        dtype = float,
                        doc = """Maximum allowed sigma for outliers from kernel sum distribution.
                                 Used to reject variable objects from the kernel model""",
                        default = 3.0,
                        check = lambda x : x >= 0.0
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#f4985e17">f4985e17</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#906178a2">906178a2</a> -     # Clipping of KernelCandidates based on condition number</div>
                    maxConditionNumber = pexConfig.Field(
                        dtype = float,
                        doc = "Maximum condition number for a well conditioned matrix",
                        default = 5.0e7,
                        check = lambda x : x >= 0.0
                    )
                    conditionNumberType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "Use singular values (SVD) or eigen values (EIGENVALUE) to determine condition number",
                        default = "EIGENVALUE",
                        allowed = {
                            "SVD" : "Use singular values",
                            "EIGENVALUE" : "Use eigen values (faster)",
                        }
                    )
                    maxSpatialConditionNumber = pexConfig.Field(
                        dtype = float,
                        doc = "Maximum condition number for a well conditioned spatial matrix",
                        default = 1.0e10,
                        check = lambda x : x >= 0.0
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
354  <a href="#cca1e80e">cca1e80e</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
355  <a href="#906178a2">906178a2</a> -     ####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#906178a2">906178a2</a> -     # Fitting of single kernel to object pair in KernelCandidate</div>
                    iterateSingleKernel = pexConfig.Field(
                        dtype = bool,
                        doc = """Remake KernelCandidate using better variance estimate after first pass?
                                 Primarily useful when convolving a single-depth image, otherwise not necessary.""",
                        default = False,
                    )
                    constantVarianceWeighting = pexConfig.Field(
                        dtype = bool,
                        doc = """Use constant variance weighting in single kernel fitting?
                                 In some cases this is better for bright star residuals.""",
                        default = True,
                    )
                    calculateKernelUncertainty = pexConfig.Field(
                        dtype = bool,
                        doc = """Calculate kernel and background uncertainties for each kernel candidate?
                                 This comes from the inverse of the covariance matrix.
                                 Warning: regularization can cause problems for this step.""",
                        default = False,
                    )
                    useBicForKernelBasis = pexConfig.Field(
                        dtype = bool,
                        doc = """Use Bayesian Information Criterion to select the number of bases going into the kernel""",
                        default = False,
                    )
                
                
                class PsfMatchConfigAL(PsfMatchConfig):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
364  <a href="#8b7f49ff">8b7f49ff</a> +     """!The parameters specific to the "Alard-Lupton" (sum-of-Gaussian) Psf-matching basis"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
365  <a href="#7c5682a9">7c5682a9</a> + </div>
                    def setDefaults(self):
                        PsfMatchConfig.setDefaults(self)
                        self.kernelBasisSet = "alard-lupton"
                        self.maxConditionNumber = 5.0e7
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
389  <a href="#6c0e8620">6c0e8620</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
390  <a href="#6c0e8620">6c0e8620</a> -     #####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#6c0e8620">6c0e8620</a> -     # Alard-Lupton Basis Parameters</div>
                    alardNGauss = pexConfig.Field(
                        dtype = int,
                        doc = "Number of Gaussians in alard-lupton basis",
                        default = 3,
                        check = lambda x : x >= 1
                    )
                    alardDegGauss = pexConfig.ListField(
                        dtype = int,
                        doc = "Polynomial order of spatial modification of Gaussians.  Must in number equal alardNGauss",
                        default = (4, 2, 2),
                    )
                    alardSigGauss = pexConfig.ListField(
                        dtype = float,
                        doc = """Sigma in pixels of Gaussians (FWHM = 2.35 sigma).  Must in number equal alardNGauss""",
                        default = (0.7, 1.5, 3.0),
                    )
                    alardGaussBeta = pexConfig.Field(
                        dtype = float,
                        doc = """Default scale factor between Gaussian sigmas """,
                        default = 2.0,
                        check = lambda x: x >= 0.0,
                    )
                    alardMinSig = pexConfig.Field(
                        dtype = float,
                        doc = """Minimum Sigma (pixels) for Gaussians""",
                        default = 0.7,
                        check = lambda x : x >= 0.25
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
420  <a href="#e58cdb50">e58cdb50</a> - </div>
                    alardDegGaussDeconv = pexConfig.Field(
                        dtype = int,
                        doc = """Degree of spatial modification of ALL gaussians in AL basis during deconvolution""",
                        default = 3,
                        check = lambda x : x >= 1
                    )
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
405  <a href="#71c02d8d">71c02d8d</a> +     alardMinSigDeconv = pexConfig.Field(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
406  <a href="#71c02d8d">71c02d8d</a> +         dtype = float,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#0184f44e">0184f44e</a> +         doc = """Minimum Sigma (pixels) for Gaussians during deconvolution; </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#0184f44e">0184f44e</a> +         make smaller than alardMinSig as this is only indirectly used""",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#a41ad65f">a41ad65f</a> +         default = 0.4,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#71c02d8d">71c02d8d</a> +         check = lambda x : x >= 0.25</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
411  <a href="#71c02d8d">71c02d8d</a> +     )</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#71c02d8d">71c02d8d</a> +     alardNGaussDeconv = pexConfig.Field(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
413  <a href="#71c02d8d">71c02d8d</a> +         dtype = int,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
414  <a href="#71c02d8d">71c02d8d</a> +         doc = "Number of Gaussians in AL basis during deconvolution",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
415  <a href="#71c02d8d">71c02d8d</a> +         default = 3,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
416  <a href="#71c02d8d">71c02d8d</a> +         check = lambda x : x >= 1</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
417  <a href="#71c02d8d">71c02d8d</a> +     )</div>
                
                
                
                class PsfMatchConfigDF(PsfMatchConfig):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
422  <a href="#8b7f49ff">8b7f49ff</a> +     """!The parameters specific to the delta-function (one basis per-pixel) Psf-matching basis"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
423  <a href="#7c5682a9">7c5682a9</a> + </div>
                    def setDefaults(self):
                        PsfMatchConfig.setDefaults(self)
                        self.kernelBasisSet = "delta-function"
                        self.maxConditionNumber = 5.0e6
                        self.usePcaForSpatialKernel = True
                        self.subtractMeanForPca = True
                        self.useBicForKernelBasis = False
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
439  <a href="#6c0e8620">6c0e8620</a> -     #####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
440  <a href="#6c0e8620">6c0e8620</a> -     # Delta Function Basis Parameters</div>
                    useRegularization = pexConfig.Field(
                        dtype = bool,
                        doc = "Use regularization to smooth the delta function kernels",
                        default = True,
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
446  <a href="#6c0e8620">6c0e8620</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
447  <a href="#6c0e8620">6c0e8620</a> -     #####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
448  <a href="#6c0e8620">6c0e8620</a> -     # Regularization shape</div>
                    regularizationType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "Type of regularization.",
                        default = "centralDifference",
                        allowed = {
                            "centralDifference": "Penalize second derivative using 2-D stencil of central finite difference",
                            "forwardDifference": "Penalize first, second, third derivatives using forward finite differeces"
                        }
                    )
                    centralRegularizationStencil = pexConfig.ChoiceField(
                        dtype = int,
                        doc = "Type of stencil to approximate central derivative (for centralDifference only)",
                        default = 9,
                        allowed = {
                            5 : "5-point stencil including only adjacent-in-x,y elements",
                            9 : "9-point stencil including diagonal elements"
                        }
                    )
                    forwardRegularizationOrders = pexConfig.ListField(
                        dtype = int,
                        doc = "Array showing which order derivatives to penalize (for forwardDifference only)",
                        default = (1, 2),
                        itemCheck = lambda x: (x > 0) and (x < 4)
                    )
                    regularizationBorderPenalty = pexConfig.Field(
                        dtype = float,
                        doc = "Value of the penalty for kernel border pixels",
                        default = 3.0,
                        check = lambda x : x >= 0.0
                    )
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
479  <a href="#6c0e8620">6c0e8620</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
480  <a href="#6c0e8620">6c0e8620</a> -     #####</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
481  <a href="#6c0e8620">6c0e8620</a> -     # Regularization strength</div>
                    lambdaType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = "How to choose the value of the regularization strength",
                        default = "absolute",
                        allowed = {
                            "absolute" : "Use lambdaValue as the value of regularization strength",
                            "relative" : "Use lambdaValue as fraction of the default regularization strength (N.R. 18.5.8)",
                            "minimizeBiasedRisk" : "Minimize biased risk estimate",
                            "minimizeUnbiasedRisk" : "Minimize unbiased risk estimate",
                        }
                    )
                    lambdaValue = pexConfig.Field(
                        dtype = float,
                        doc = "Value used for absolute determinations of regularization strength",
                        default = 0.2,
                    )
                    lambdaScaling = pexConfig.Field(
                        dtype = float,
                        doc = "Fraction of the default lambda strength (N.R. 18.5.8) to use.  1e-4 or 1e-5",
                        default = 1e-4,
                    )
                    lambdaStepType = pexConfig.ChoiceField(
                        dtype = str,
                        doc = """If a scan through lambda is needed (minimizeBiasedRisk, minimizeUnbiasedRisk),
                                 use log or linear steps""",
                        default = "log",
                        allowed = {
                            "log" : "Step in log intervals; e.g. lambdaMin, lambdaMax, lambdaStep = -1.0, 2.0, 0.1",
                            "linear" : "Step in linear intervals; e.g. lambdaMin, lambdaMax, lambdaStep = 0.1, 100, 0.1",
                        }
                    )
                    lambdaMin = pexConfig.Field(
                        dtype = float,
                        doc = """If scan through lambda needed (minimizeBiasedRisk, minimizeUnbiasedRisk),
                                 start at this value.  If lambdaStepType = log:linear, suggest -1:0.1""",
                        default = -1.0,
                    )
                    lambdaMax = pexConfig.Field(
                        dtype = float,
                        doc = """If scan through lambda needed (minimizeBiasedRisk, minimizeUnbiasedRisk),
                                 stop at this value.  If lambdaStepType = log:linear, suggest 2:100""",
                        default = 2.0,
                    )
                    lambdaStep = pexConfig.Field(
                        dtype = float,
                        doc = """If scan through lambda needed (minimizeBiasedRisk, minimizeUnbiasedRisk),
                                 step in these increments.  If lambdaStepType = log:linear, suggest 0.1:0.1""",
                        default = 0.1,
                    )
                
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
518  <a href="#7c5682a9">7c5682a9</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
519  <a href="#7c5682a9">7c5682a9</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
520  <a href="#7c5682a9">7c5682a9</a> + ## \page PsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
521  <a href="#7c5682a9">7c5682a9</a> + ## \ref PsfMatchTask_ "PsfMatchTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
522  <a href="#7c5682a9">7c5682a9</a> + ## \copybrief PsfMatchTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
523  <a href="#7c5682a9">7c5682a9</a> + ## \}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
524  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
533  <a href="#77ece2b8">77ece2b8</a> - class PsfMatch(pipeBase.Task):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
525  <a href="#ea0a71c3">ea0a71c3</a> + class PsfMatchTask(pipeBase.Task):</div>
              ?               ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
534  <a href="#77ece2b8">77ece2b8</a> -     """Base class for PSF matching task.  Has no run method; hence should not be called!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
526  <a href="#7c5682a9">7c5682a9</a> +     """!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
527  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
528  <a href="#7c5682a9">7c5682a9</a> + \anchor PsfMatchTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
529  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
530  <a href="#7c5682a9">7c5682a9</a> + \brief Base class for Psf Matching; should not be called directly</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
531  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
532  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Contents Contents</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
533  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
534  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Purpose</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
535  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Initialize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
536  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_IO</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
537  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Config</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
538  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
539  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Debug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
540  <a href="#7c5682a9">7c5682a9</a> +  - \ref ip_diffim_psfmatch_Example</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
541  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
542  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
543  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
544  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Purpose   Description</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
545  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
546  <a href="#0184f44e">0184f44e</a> + PsfMatchTask is a base class that implements the core functionality for matching the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
547  <a href="#0184f44e">0184f44e</a> + Psfs of two images using a spatially varying Psf-matching lsst.afw.math.LinearCombinationKernel.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
548  <a href="#7c5682a9">7c5682a9</a> + The Task requires the user to provide an instance of an lsst.afw.math.SpatialCellSet, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
549  <a href="#7c5682a9">7c5682a9</a> + filled with lsst.ip.diffim.KernelCandidate instances, and an lsst.afw.math.KernelList </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
550  <a href="#7c5682a9">7c5682a9</a> + of basis shapes that will be used for the decomposition.  If requested, the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
551  <a href="#7c5682a9">7c5682a9</a> + also performs background matching and returns the differential background model as an </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
552  <a href="#7c5682a9">7c5682a9</a> + lsst.afw.math.Kernel.SpatialFunction.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
553  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
554  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
555  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
556  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Initialize    Task initialization</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
557  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
558  <a href="#7c5682a9">7c5682a9</a> + \copydoc \_\_init\_\_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
559  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
560  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
561  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
562  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_IO        Invoking the Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
563  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
564  <a href="#7c5682a9">7c5682a9</a> + As a base class, this Task is not directly invoked.  However, run() methods that are</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
565  <a href="#7c5682a9">7c5682a9</a> + implemented on derived classes will make use of the core _solve() functionality, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
566  <a href="#7c5682a9">7c5682a9</a> + which defines a sequence of lsst.afw.math.CandidateVisitor classes that iterate</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
567  <a href="#7c5682a9">7c5682a9</a> + through the KernelCandidates, first building up a per-candidate solution and then</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
568  <a href="#7c5682a9">7c5682a9</a> + building up a spatial model from the ensemble of candidates.  Sigma clipping is</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
569  <a href="#7c5682a9">7c5682a9</a> + performed using the mean and standard deviation of all kernel sums (to reject </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
570  <a href="#7c5682a9">7c5682a9</a> + variable objects), on the per-candidate substamp diffim residuals </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
571  <a href="#7c5682a9">7c5682a9</a> + (to indicate a bad choice of kernel basis shapes for that particular object), </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
572  <a href="#7c5682a9">7c5682a9</a> + and on the substamp diffim residuals using the spatial kernel fit (to indicate a bad</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
573  <a href="#7c5682a9">7c5682a9</a> + choice of spatial kernel order, or poor constraints on the spatial model).  The</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
574  <a href="#7c5682a9">7c5682a9</a> + _diagnostic() method logs information on the quality of the spatial fit, and also</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
575  <a href="#7c5682a9">7c5682a9</a> + modifies the Task metadata.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
576  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
577  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
578  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
579  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Config       Configuration parameters</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
580  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
581  <a href="#7c5682a9">7c5682a9</a> + See \ref PsfMatchConfig, \ref PsfMatchConfigAL, \ref PsfMatchConfigDF, and \ref DetectionConfig.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
582  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
583  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
584  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
585  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Metadata   Quantities set in Metadata</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
586  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
587  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
588  <a href="#7c5682a9">7c5682a9</a> + <DL></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
589  <a href="#7c5682a9">7c5682a9</a> + <DT> spatialConditionNum <DD> Condition number of the spatial kernel fit; </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
590  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.PsfMatchTask._diagnostic PsfMatchTask._diagnostic \endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
591  <a href="#7c5682a9">7c5682a9</a> + <DT> spatialKernelSum <DD> Kernel sum (10^{-0.4 * &Delta; zeropoint}) of the spatial Psf-matching kernel;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
592  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.PsfMatchTask._diagnostic PsfMatchTask._diagnostic \endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
593  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
594  <a href="#7c5682a9">7c5682a9</a> + <DT> ALBasisNGauss <DD> If using sum-of-Gaussian basis, the number of gaussians used;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
595  <a href="#0184f44e">0184f44e</a> +     via \link lsst.ip.diffim.makeKernelBasisList.generateAlardLuptonBasisList </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
596  <a href="#0184f44e">0184f44e</a> +     generateAlardLuptonBasisList\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
597  <a href="#7c5682a9">7c5682a9</a> + <DT> ALBasisDegGauss <DD> If using sum-of-Gaussian basis, the degree of spatial variation of the Gaussians;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
598  <a href="#0184f44e">0184f44e</a> +     via \link lsst.ip.diffim.makeKernelBasisList.generateAlardLuptonBasisList </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
599  <a href="#0184f44e">0184f44e</a> +     generateAlardLuptonBasisList\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
600  <a href="#7c5682a9">7c5682a9</a> + <DT> ALBasisSigGauss <DD> If using sum-of-Gaussian basis, the widths (sigma) of the Gaussians;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
601  <a href="#0184f44e">0184f44e</a> +     via \link lsst.ip.diffim.makeKernelBasisList.generateAlardLuptonBasisList </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
602  <a href="#0184f44e">0184f44e</a> +     generateAlardLuptonBasisList\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
603  <a href="#7c5682a9">7c5682a9</a> + <DT> ALKernelSize <DD> If using sum-of-Gaussian basis, the kernel size;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
604  <a href="#0184f44e">0184f44e</a> +     via \link lsst.ip.diffim.makeKernelBasisList.generateAlardLuptonBasisList </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
605  <a href="#0184f44e">0184f44e</a> +     generateAlardLuptonBasisList\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
606  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
607  <a href="#7c5682a9">7c5682a9</a> + <DT> NFalsePositivesTotal <DD> Total number of diaSources;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
608  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
609  <a href="#7c5682a9">7c5682a9</a> + <DT> NFalsePositivesRefAssociated <DD> Number of diaSources that associate with the reference catalog;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
610  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
611  <a href="#7c5682a9">7c5682a9</a> + <DT> NFalsePositivesRefAssociated <DD> Number of diaSources that associate with the source catalog;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
612  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
613  <a href="#7c5682a9">7c5682a9</a> + <DT> NFalsePositivesUnassociated <DD> Number of diaSources that are orphans;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
614  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
615  <a href="#0184f44e">0184f44e</a> + <DT> metric_MEAN <DD> Mean value of substamp diffim quality metrics across all KernelCandidates, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
616  <a href="#0184f44e">0184f44e</a> +     for both the per-candidate (LOCAL) and SPATIAL residuals;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
617  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
618  <a href="#0184f44e">0184f44e</a> + <DT> metric_MEDIAN <DD> Median value of substamp diffim quality metrics across all KernelCandidates, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
619  <a href="#0184f44e">0184f44e</a> +     for both the per-candidate (LOCAL) and SPATIAL residuals;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
620  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
621  <a href="#0184f44e">0184f44e</a> + <DT> metric_STDEV <DD> Standard deviation of substamp diffim quality metrics across all KernelCandidates, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
622  <a href="#0184f44e">0184f44e</a> +     for both the per-candidate (LOCAL) and SPATIAL residuals;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
623  <a href="#7c5682a9">7c5682a9</a> +     via \link lsst.ip.diffim.KernelCandidateQa.aggregate KernelCandidateQa.aggregate\endlink </DD> </DT></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
624  <a href="#7c5682a9">7c5682a9</a> + </DL></div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
625  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
626  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
627  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
628  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
629  <a href="#7c5682a9">7c5682a9</a> + \section ip_diffim_psfmatch_Debug     Debug variables</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
630  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
631  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
632  <a href="#7c5682a9">7c5682a9</a> + The \link lsst.pipe.base.cmdLineTask.CmdLineTask command line task\endlink interface supports a</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
633  <a href="#7c5682a9">7c5682a9</a> + flag \c -d/--debug to import \b debug.py from your \c PYTHONPATH.  The relevant contents of debug.py </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
634  <a href="#7c5682a9">7c5682a9</a> + for this Task include:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
635  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
636  <a href="#7c5682a9">7c5682a9</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
637  <a href="#7c5682a9">7c5682a9</a> +     import sys</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
638  <a href="#7c5682a9">7c5682a9</a> +     import lsstDebug</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
639  <a href="#7c5682a9">7c5682a9</a> +     def DebugInfo(name):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
640  <a href="#7c5682a9">7c5682a9</a> +         di = lsstDebug.getInfo(name)          </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
641  <a href="#7c5682a9">7c5682a9</a> +         if name == "lsst.ip.diffim.psfMatch":</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
642  <a href="#bef62402">bef62402</a> +             di.display = True                 # enable debug output</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
643  <a href="#7c5682a9">7c5682a9</a> +             di.maskTransparency = 80          # ds9 mask transparency</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
644  <a href="#7c5682a9">7c5682a9</a> +             di.displayCandidates = True       # show all the candidates and residuals</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
645  <a href="#7c5682a9">7c5682a9</a> +             di.displayKernelBasis = False     # show kernel basis functions</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
646  <a href="#7c5682a9">7c5682a9</a> +             di.displayKernelMosaic = True     # show kernel realized across the image</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
647  <a href="#7c5682a9">7c5682a9</a> +             di.plotKernelSpatialModel = False # show coefficients of spatial model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
648  <a href="#7c5682a9">7c5682a9</a> +             di.showBadCandidates = True       # show the bad candidates (red) along with good (green)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
649  <a href="#7c5682a9">7c5682a9</a> +         return di</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
650  <a href="#7c5682a9">7c5682a9</a> +     lsstDebug.Info = DebugInfo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
651  <a href="#7c5682a9">7c5682a9</a> +     lsstDebug.frame = 1</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
652  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
653  <a href="#7c5682a9">7c5682a9</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
654  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
655  <a href="#a081a2a2">a081a2a2</a> + Note that if you want addional logging info, you may add to your scripts:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
656  <a href="#a081a2a2">a081a2a2</a> + \code{.py}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
657  <a href="#a081a2a2">a081a2a2</a> + import lsst.pex.logging as pexLog</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
658  <a href="#a081a2a2">a081a2a2</a> + pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
659  <a href="#a081a2a2">a081a2a2</a> + \endcode</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
660  <a href="#a081a2a2">a081a2a2</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
661  <a href="#7c5682a9">7c5682a9</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
662  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
663  <a href="#8b7f49ff">8b7f49ff</a> + \section ip_diffim_psfmatch_Example   Example code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
664  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
665  <a href="#8b7f49ff">8b7f49ff</a> + As a base class, there is no example code for PsfMatchTask.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
666  <a href="#f69650db">f69650db</a> + However, see \link lsst.ip.diffim.imagePsfMatch.ImagePsfMatchTask ImagePsfMatchTask\endlink, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
667  <a href="#f69650db">f69650db</a> + \link lsst.ip.diffim.snapPsfMatch.SnapPsfMatchTask SnapPsfMatchTask\endlink, and</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
668  <a href="#f69650db">f69650db</a> + \link lsst.ip.diffim.modelPsfMatch.ModelPsfMatchTask ModelPsfMatchTask\endlink.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
669  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
670  <a href="#83623b4f">83623b4f</a> + #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
671  <a href="#83623b4f">83623b4f</a> + </div>
                    """
                    ConfigClass = PsfMatchConfig
                    _DefaultName = "psfMatch"
                
                    def __init__(self, *args, **kwargs):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
677  <a href="#8b7f49ff">8b7f49ff</a> +         """!Create the psf-matching Task</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
678  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
679  <a href="#7c5682a9">7c5682a9</a> +         \param *args arguments to be passed to lsst.pipe.base.task.Task.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
680  <a href="#7c5682a9">7c5682a9</a> +         \param **kwargs keyword arguments to be passed to lsst.pipe.base.task.Task.__init__</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
681  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
682  <a href="#7c5682a9">7c5682a9</a> +         The initialization sets the Psf-matching kernel configuration using the value of </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
683  <a href="#7c5682a9">7c5682a9</a> +         self.config.kernel.active.  If the kernel is requested with regularization to moderate</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
684  <a href="#7c5682a9">7c5682a9</a> +         the bias/variance tradeoff, currently only used when a delta function kernel basis</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
685  <a href="#7c5682a9">7c5682a9</a> +         is provided, it creates a regularization matrix stored as member variable</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
686  <a href="#7c5682a9">7c5682a9</a> +         self.hMat.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
687  <a href="#7c5682a9">7c5682a9</a> +         """</div>
                        pipeBase.Task.__init__(self, *args, **kwargs)
                        self.kConfig = self.config.kernel.active
                
                        #
                        if 'useRegularization' in self.kConfig.keys():
                            self.useRegularization = self.kConfig.useRegularization
                        else:
                            self.useRegularization = False
                
                        if self.useRegularization:
                            self.hMat = diffimLib.makeRegularizationMatrix(pexConfig.makePolicy(self.kConfig))
                
                    def _diagnostic(self, kernelCellSet, spatialSolution, spatialKernel, spatialBg):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
553  <a href="#3c6e3b17">3c6e3b17</a> -         """Provide logging diagnostics on quality of spatial kernel fit</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
701  <a href="#7c5682a9">7c5682a9</a> +         """!Provide logging diagnostics on quality of spatial kernel fit</div>
              ?            +
                
                        @param kernelCellSet: Cellset that contains the KernelCandidates used in the fitting
                        @param spatialSolution: KernelSolution of best-fit
                        @param spatialKernel: Best-fit spatial Kernel model
                        @param spatialBg: Best-fit spatial background model
                
                        """
                        # What is the final kernel sum
                        kImage = afwImage.ImageD(spatialKernel.getDimensions())
                        kSum = spatialKernel.computeImage(kImage, False)
                        self.log.info("Final spatial kernel sum %.3f" % (kSum))
                
                        # Look at how well conditioned the matrix is
                        conditionNum = spatialSolution.getConditionNumber(
                            getattr(diffimLib.KernelSolution, self.kConfig.conditionNumberType))
                        self.log.info("Spatial model condition number %.3e" % (conditionNum))
                
                        if conditionNum < 0.0:
                            self.log.warn("Condition number is negative (%.3e)" % (conditionNum))
                        if conditionNum > self.kConfig.maxSpatialConditionNumber:
                            self.log.warn("Spatial solution exceeds max condition number (%.3e > %.3e)" % (
                                    conditionNum, self.kConfig.maxSpatialConditionNumber))
                
                        self.metadata.set("spatialConditionNum", conditionNum)
                        self.metadata.set("spatialKernelSum", kSum)
                
                        # Look at how well the solution is constrained
                        nBasisKernels = spatialKernel.getNBasisKernels()
                        nKernelTerms  = spatialKernel.getNSpatialParameters()
                        if nKernelTerms == 0: # order 0
                            nKernelTerms = 1
                
                        # Not fit for
                        nBgTerms     = spatialBg.getNParameters()
                        if nBgTerms == 1:
                            if spatialBg.getParameters()[0] == 0.0:
                                nBgTerms = 0
                
                        nGood = 0
                        nBad  = 0
                        nTot  = 0
                        for cell in kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand = diffimLib.cast_KernelCandidateF(cand)
                                nTot += 1
                                if cand.getStatus() == afwMath.SpatialCellCandidate.GOOD:
                                    nGood += 1
                                if cand.getStatus() == afwMath.SpatialCellCandidate.BAD:
                                    nBad += 1
                
                        self.log.info("Doing stats of kernel candidates used in the spatial fit.")
                
                        # Counting statistics
                        if nBad > 2*nGood:
                            self.log.warn("Many more candidates rejected than accepted; %d total, %d rejected, %d used" % (
                                          nTot, nBad, nGood) )
                        else:
                            self.log.info("%d candidates total, %d rejected, %d used" % (nTot, nBad, nGood))
                
                        # Some judgements on the quality of the spatial models
                        if nGood < nKernelTerms:
                            self.log.warn("Spatial kernel model underconstrained; %d candidates, %d terms, %d bases" % (
                                    nGood, nKernelTerms, nBasisKernels))
                            self.log.warn("Consider lowering the spatial order")
                        elif nGood <= 2*nKernelTerms:
                            self.log.warn("Spatial kernel model poorly constrained; %d candidates, %d terms, %d bases" % (
                                    nGood, nKernelTerms, nBasisKernels))
                            self.log.warn("Consider lowering the spatial order")
                        else:
                            self.log.info("Spatial kernel model well constrained; %d candidates, %d terms, %d bases" % (
                                    nGood, nKernelTerms, nBasisKernels))
                
                        if nGood < nBgTerms:
                            self.log.warn("Spatial background model underconstrained; %d candidates, %d terms" % (
                                    nGood, nBgTerms))
                            self.log.warn("Consider lowering the spatial order")
                        elif nGood <= 2*nBgTerms:
                            self.log.warn("Spatial background model poorly constrained; %d candidates, %d terms" % (
                                    nGood, nBgTerms))
                            self.log.warn("Consider lowering the spatial order")
                        else:
                            self.log.info("Spatial background model appears well constrained; %d candidates, %d terms" % (
                                    nGood, nBgTerms))
                
                    def _displayDebug(self, kernelCellSet, spatialKernel, spatialBackground):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
787  <a href="#8b7f49ff">8b7f49ff</a> +         """!Provide visualization of the inputs and ouputs to the Psf-matching code</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
788  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
789  <a href="#0184f44e">0184f44e</a> +         @param kernelCellSet: the SpatialCellSet used in determining the matching kernel and background </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
790  <a href="#7c5682a9">7c5682a9</a> +         @param spatialKernel: spatially varying Psf-matching kernel</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
791  <a href="#7c5682a9">7c5682a9</a> +         @param spatialBackground: spatially varying background-matching function</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
792  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
793  <a href="#7c5682a9">7c5682a9</a> +         """</div>
                        import lsstDebug
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
640  <a href="#3c6e3b17">3c6e3b17</a> -         displaySpatialCells = lsstDebug.Info(__name__).displaySpatialCells</div>
                        displayCandidates = lsstDebug.Info(__name__).displayCandidates
                        displayKernelBasis = lsstDebug.Info(__name__).displayKernelBasis
                        displayKernelMosaic = lsstDebug.Info(__name__).displayKernelMosaic
                        plotKernelSpatialModel = lsstDebug.Info(__name__).plotKernelSpatialModel
                        showBadCandidates = lsstDebug.Info(__name__).showBadCandidates
                        maskTransparency = lsstDebug.Info(__name__).maskTransparency
                        if not maskTransparency:
                            maskTransparency = 0
                        ds9.setMaskTransparency(maskTransparency)
                
                        if displayCandidates:
                            diUtils.showKernelCandidates(kernelCellSet, kernel=spatialKernel, background=spatialBackground, 
                                                         frame=lsstDebug.frame,
                                                         showBadCandidates=showBadCandidates)
                            lsstDebug.frame += 1
                            diUtils.showKernelCandidates(kernelCellSet, kernel=spatialKernel, background=spatialBackground, 
                                                         frame=lsstDebug.frame,
                                                         showBadCandidates=showBadCandidates,
                                                         kernels=True)
                            lsstDebug.frame += 1
                            diUtils.showKernelCandidates(kernelCellSet, kernel=spatialKernel, background=spatialBackground, 
                                                         frame=lsstDebug.frame,
                                                         showBadCandidates=showBadCandidates,
                                                         resids=True)
                            lsstDebug.frame += 1
                
                        if displayKernelBasis:
                            diUtils.showKernelBasis(spatialKernel, frame=lsstDebug.frame)
                            lsstDebug.frame += 1
                
                        if displayKernelMosaic:
                            diUtils.showKernelMosaic(kernelCellSet.getBBox(), spatialKernel, frame=lsstDebug.frame)
                            lsstDebug.frame += 1
                
                        if plotKernelSpatialModel:
                            diUtils.plotKernelSpatialModel(spatialKernel, kernelCellSet, showBadCandidates=showBadCandidates)
                
                
                    def _createPcaBasis(self, kernelCellSet, nStarPerCell, policy):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
834  <a href="#8b7f49ff">8b7f49ff</a> +         """!Create Principal Component basis</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
835  <a href="#8b7f49ff">8b7f49ff</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
836  <a href="#8b7f49ff">8b7f49ff</a> +         If a principal component analysis is requested, typically when using a delta function basis, </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
837  <a href="#0184f44e">0184f44e</a> +         perform the PCA here and return a new basis list containing the new principal components.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
838  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
839  <a href="#0184f44e">0184f44e</a> +         @param kernelCellSet: a SpatialCellSet containing KernelCandidates, from which components are derived</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
840  <a href="#7c5682a9">7c5682a9</a> +         @param nStarPerCell: the number of stars per cell to visit when doing the PCA</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
841  <a href="#7c5682a9">7c5682a9</a> +         @param policy: input policy controlling the single kernel visitor</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
842  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
843  <a href="#7c5682a9">7c5682a9</a> +         @return</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
844  <a href="#7c5682a9">7c5682a9</a> +         - nRejectedPca: number of KernelCandidates rejected during PCA loop</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
845  <a href="#7c5682a9">7c5682a9</a> +         - spatialBasisList: basis list containing the principal shapes as Kernels</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
846  <a href="#7c5682a9">7c5682a9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
847  <a href="#7c5682a9">7c5682a9</a> +         """</div>
                        nComponents       = self.kConfig.numPrincipalComponents
                        imagePca          = diffimLib.KernelPcaD()
                        importStarVisitor = diffimLib.KernelPcaVisitorF(imagePca)
                        kernelCellSet.visitCandidates(importStarVisitor, nStarPerCell)
                        if self.kConfig.subtractMeanForPca:
                            importStarVisitor.subtractMean()
                        imagePca.analyze()
                
                        eigenValues  = imagePca.getEigenValues()
                        pcaBasisList = importStarVisitor.getEigenKernels()
                
                        eSum = num.sum(eigenValues)
                        if eSum == 0.0:
                            raise RuntimeError("Eigenvalues sum to zero")
                        for j in range(len(eigenValues)):
                            pexLog.Trace(self.log.getName()+"._solve", 6,
                                         "Eigenvalue %d : %f (%f)" % (j, eigenValues[j], eigenValues[j]/eSum))
                
                        nToUse = min(nComponents, len(eigenValues))
                        trimBasisList = afwMath.KernelList()
                        for j in range(nToUse):
                            # Check for NaNs?
                            kimage = afwImage.ImageD(pcaBasisList[j].getDimensions())
                            pcaBasisList[j].computeImage(kimage, False)
                            if not (True in num.isnan(kimage.getArray())):
                                trimBasisList.push_back(pcaBasisList[j])
                
                        # Put all the power in the first kernel, which will not vary spatially
                        spatialBasisList = diffimLib.renormalizeKernelList(trimBasisList)
                
                        # New Kernel visitor for this new basis list (no regularization explicitly)
                        singlekvPca = diffimLib.BuildSingleKernelVisitorF(spatialBasisList, policy)
                        singlekvPca.setSkipBuilt(False)
                        kernelCellSet.visitCandidates(singlekvPca, nStarPerCell)
                        singlekvPca.setSkipBuilt(True)
                        nRejectedPca = singlekvPca.getNRejected()
                
                        return nRejectedPca, spatialBasisList
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
887  <a href="#0184f44e">0184f44e</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
888  <a href="#0184f44e">0184f44e</a> +     def _buildCellSet(self, *args):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
889  <a href="#d3d9fd18">d3d9fd18</a> +         """!Fill a SpatialCellSet with KernelCandidates for the Psf-matching process;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
890  <a href="#d3d9fd18">d3d9fd18</a> +         override in derived classes"""</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
891  <a href="#0184f44e">0184f44e</a> +         return</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
892  <a href="#0184f44e">0184f44e</a> + </div>
                    @pipeBase.timeMethod
                    def _solve(self, kernelCellSet, basisList, returnOnExcept=False):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
721  <a href="#3dc073eb">3dc073eb</a> -         """Determine the PSF matching kernel</div>
              ?            ^ ^^ ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
895  <a href="#504f305d">504f305d</a> +         """!Solve for the PSF matching kernel</div>
              ?            ^^^^^ ^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
723  <a href="#3dc073eb">3dc073eb</a> -         @param kernelCellSet: a SpatialCellSet to use in determining the PSF matching kernel</div>
              ?                                                                         ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
897  <a href="#0184f44e">0184f44e</a> +         @param kernelCellSet: a SpatialCellSet to use in determining the matching kernel </div>
              ?                                                                                         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
724  <a href="#3dc073eb">3dc073eb</a> -             as provided by self._buildCellSet</div>
              ?           ^                -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
898  <a href="#0184f44e">0184f44e</a> +           (typically as provided by _buildCellSet)</div>
              ?           ^^^^^^^^^^                             +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
899  <a href="#0184f44e">0184f44e</a> +         @param basisList: list of Kernels to be used in the decomposition of the spatially varying kernel </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
900  <a href="#0184f44e">0184f44e</a> +           (typically as provided by makeKernelBasisList)</div>
                        @param returnOnExcept: if True then return (None, None) if an error occurs, else raise the exception
                
                        @return
                        - psfMatchingKernel: PSF matching kernel
                        - backgroundModel: differential background model
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
731  <a href="#3dc073eb">3dc073eb</a> -         @raise Exception if unable to determine PSF matching kernel and returnOnExcept False</div>
              ?         ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
907  <a href="#7c5682a9">7c5682a9</a> +         Raise Exception if unable to determine PSF matching kernel and returnOnExcept False</div>
              ?         ^
                        """
                
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                
                        maxSpatialIterations   = self.kConfig.maxSpatialIterations
                        nStarPerCell           = self.kConfig.nStarPerCell
                        usePcaForSpatialKernel = self.kConfig.usePcaForSpatialKernel
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
740  <a href="#cca1e80e">cca1e80e</a> -         subtractMeanForPca     = self.kConfig.subtractMeanForPca</div>
                
                        # Visitor for the single kernel fit
                        policy = pexConfig.makePolicy(self.kConfig)
                        if self.useRegularization:
                            singlekv = diffimLib.BuildSingleKernelVisitorF(basisList, policy, self.hMat)
                        else:
                            singlekv = diffimLib.BuildSingleKernelVisitorF(basisList, policy)
                
                        # Visitor for the kernel sum rejection
                        ksv = diffimLib.KernelSumVisitorF(policy)
                
                        # Main loop
                        t0 = time.time()
                        try:
                            totalIterations = 0
                            thisIteration   = 0
                            while (thisIteration < maxSpatialIterations):
                
                                # Make sure there are no uninitialized candidates as active occupants of Cell
                                nRejectedSkf = -1
                                while (nRejectedSkf != 0):
                                    pexLog.Trace(self.log.getName()+"._solve", 2,
                                                 "Building single kernels...")
                                    kernelCellSet.visitCandidates(singlekv, nStarPerCell)
                                    nRejectedSkf = singlekv.getNRejected()
                                    pexLog.Trace(self.log.getName()+"._solve", 2,
                                                 "Iteration %d, rejected %d candidates due to initial kernel fit" %
                                                 (thisIteration, nRejectedSkf))
                
                                # Reject outliers in kernel sum 
                                ksv.resetKernelSum()
                                ksv.setMode(diffimLib.KernelSumVisitorF.AGGREGATE)
                                kernelCellSet.visitCandidates(ksv, nStarPerCell)
                                ksv.processKsumDistribution()
                                ksv.setMode(diffimLib.KernelSumVisitorF.REJECT)
                                kernelCellSet.visitCandidates(ksv, nStarPerCell)
                
                                nRejectedKsum = ksv.getNRejected()
                                pexLog.Trace(self.log.getName()+"._solve", 2,
                                             "Iteration %d, rejected %d candidates due to kernel sum" %
                                             (thisIteration, nRejectedKsum))
                
                
                                # Do we jump back to the top without incrementing thisIteration?
                                if nRejectedKsum > 0:
                                    totalIterations += 1
                                    continue
                
                                # At this stage we can either apply the spatial fit to
                                # the kernels, or we run a PCA, use these as a *new*
                                # basis set with lower dimensionality, and then apply
                                # the spatial fit to these kernels
                
                                if (usePcaForSpatialKernel):
                                    pexLog.Trace(self.log.getName()+"._solve", 1, "Building Pca basis")
                
                                    nRejectedPca, spatialBasisList = self._createPcaBasis(kernelCellSet, nStarPerCell, policy)
                                    pexLog.Trace(self.log.getName()+"._solve", 2,
                                                 "Iteration %d, rejected %d candidates due to Pca kernel fit" % (
                                            thisIteration, nRejectedPca))
                
                                    # We don't want to continue on (yet) with the
                                    # spatial modeling, because we have bad objects
                                    # contributing to the Pca basis.  We basically
                                    # need to restart from the beginning of this loop,
                                    # since the cell-mates of those objects that were
                                    # rejected need their original Kernels built by
                                    # singleKernelFitter.
                
                                    # Don't count against thisIteration
                                    if (nRejectedPca > 0):
                                        totalIterations += 1
                                        continue
                                else:
                                    spatialBasisList = basisList
                
                                # We have gotten on to the spatial modeling part
                                regionBBox = kernelCellSet.getBBox()
                                spatialkv  = diffimLib.BuildSpatialKernelVisitorF(spatialBasisList, regionBBox, policy)
                                kernelCellSet.visitCandidates(spatialkv, nStarPerCell)
                                spatialkv.solveLinearEquation()
                                pexLog.Trace(self.log.getName()+"._solve", 3,
                                             "Spatial kernel built with %d candidates" % (spatialkv.getNCandidates()))
                                spatialKernel, spatialBackground = spatialkv.getSolutionPair()
                
                                # Check the quality of the spatial fit (look at residuals)
                                assesskv   = diffimLib.AssessSpatialKernelVisitorF(spatialKernel, spatialBackground, policy)
                                kernelCellSet.visitCandidates(assesskv, nStarPerCell)
                                nRejectedSpatial = assesskv.getNRejected()
                                nGoodSpatial     = assesskv.getNGood()
                                pexLog.Trace(self.log.getName()+"._solve", 2,
                                             "Iteration %d, rejected %d candidates due to spatial kernel fit" % (
                                        thisIteration, nRejectedSpatial))
                                pexLog.Trace(self.log.getName()+"._solve", 2,
                                             "%d candidates used in fit" % (nGoodSpatial))
                
                                # If only nGoodSpatial == 0, might be other candidates in the cells
                                if nGoodSpatial == 0 and nRejectedSpatial == 0:
                                    raise RuntimeError("No kernel candidates for spatial fit")
                
                                if nRejectedSpatial == 0:
                                    # Nothing rejected, finished with spatial fit
                                    break
                
                                # Otherwise, iterate on...
                                thisIteration   += 1
                
                            # Final fit if above did not converge
                            if (nRejectedSpatial > 0) and (thisIteration == maxSpatialIterations):
                                pexLog.Trace(self.log.getName()+"._solve", 2, "Final spatial fit")
                                if (usePcaForSpatialKernel):
                                    nRejectedPca, spatialBasisList = self._createPcaBasis(kernelCellSet, nStarPerCell, policy)
                                regionBBox = kernelCellSet.getBBox()
                                spatialkv  = diffimLib.BuildSpatialKernelVisitorF(spatialBasisList, regionBBox, policy)
                                kernelCellSet.visitCandidates(spatialkv, nStarPerCell)
                                spatialkv.solveLinearEquation()
                                pexLog.Trace(self.log.getName()+"._solve", 3,
                                             "Spatial kernel built with %d candidates" % (spatialkv.getNCandidates()))
                                spatialKernel, spatialBackground = spatialkv.getSolutionPair()
                
                            spatialSolution = spatialkv.getKernelSolution()
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
863  <a href="#54efc895">54efc895</a> -         except pexExcept.LsstCppException, e:</div>
              ?                          -------         ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1038 <a href="#dee8d025">dee8d025</a> +         except pexExcept.Exception as e:</div>
              ?                                   ^^^
                            pexLog.Trace(self.log.getName()+"._solve", 1, "ERROR: Unable to calculate psf matching kernel")
                            pexLog.Trace(self.log.getName()+"._solve", 2, e.args[0].what())
                            raise e
                        except Exception, e:
                            pexLog.Trace(self.log.getName()+"._solve", 1, "ERROR: Unable to calculate psf matching kernel")
                            pexLog.Trace(self.log.getName()+"._solve", 2, e.args[0])
                            raise e
                
                        t1 = time.time()
                        pexLog.Trace(self.log.getName()+"._solve", 1,
                                     "Total time to compute the spatial kernel : %.2f s" % (t1 - t0))
                
                        if display:
                            self._displayDebug(kernelCellSet, spatialKernel, spatialBackground)
                
                        self._diagnostic(kernelCellSet, spatialSolution, spatialKernel, spatialBackground)
                
                        return spatialSolution, spatialKernel, spatialBackground
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1058 <a href="#ea0a71c3">ea0a71c3</a> + PsfMatch=PsfMatchTask</div>
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="77ece2b8"/></a>77ece2b8</h3>

<pre>
commit 77ece2b8bf9aab07a7b5c50492a86a2cbc5ae32d
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 24 16:41:56 2012 -0800

    Initial work on making stages pipeBase.Tasks.
</pre>
<h3><a name="3dc073eb"/></a>3dc073eb</h3>

<pre>
commit 3dc073eba40e681ba13635e385683951f2a82056
Author: rowen <rowen@git.lsstcorp.org>
Date:   Tue May 31 21:35:23 2011 +0000

    Add doc strings and make a few methods private (with a leading underscore).
</pre>
<h3><a name="54efc895"/></a>54efc895</h3>

<pre>
commit 54efc8957105afda461df0e5cf9dd70e35bd5ca6
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 8 13:53:11 2012 -0800

    Extensive changes to get ImagePsfMatch unit tests working.
</pre>
<h3><a name="e58cdb50"/></a>e58cdb50</h3>

<pre>
commit e58cdb50df92ed018f1ed7388b94b663d4b21cf0
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 19 10:54:35 2013 -0800

    Fixing AL basis shape calculation code.  Fixing line length issues.  #2636
</pre>
<h3><a name="cca1e80e"/></a>cca1e80e</h3>

<pre>
commit cca1e80e719df66265e1492d127e9661ac244a35
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Oct 22 16:09:49 2013 -0700

    Initial round of fixes to based on Paul's W13 review.
</pre>
<h3><a name="11ed452e"/></a>11ed452e</h3>

<pre>
commit 11ed452e41a541f79f5ddb941d163affb60b717d
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri May 23 14:52:38 2014 -0400

    Adapt to new mask bit NO_DATA replacing EDGE (DM-669)
    
    NO_DATA means a warp/coadd pixel doesn't map to a CCD.
    EDGE means a pixel is near the edge and couldn't be searched
    for sources.
</pre>
<h3><a name="6c0e8620"/></a>6c0e8620</h3>

<pre>
commit 6c0e86208a8d9faa0707a44b415bb3c51559787c
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 11:18:27 2012 -0800

    Fixing formatting and removing all policy refs from psfMatch.
</pre>
<h3><a name="906178a2"/></a>906178a2</h3>

<pre>
commit 906178a2e55f5835437ac1bc5f2af058f24591de
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 2 17:39:51 2012 -0800

    Switchover to pex_config mostly implemented but not tested.  Moving fitting loop into Python for easier debugging.
</pre>
<h3><a name="f4985e17"/></a>f4985e17</h3>

<pre>
commit f4985e17583972906ac5f8eeab3604304c0fed49
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 1 14:33:01 2012 -0800

    Converting to new swig; initial conversion to pex_config.
</pre>
<h3><a name="3c6e3b17"/></a>3c6e3b17</h3>

<pre>
commit 3c6e3b171e276226d9832eec500f6bfc0700d9f0
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 15:35:53 2013 -0700

    Addressed all ticket comments from Paul and Serge.  Will build and run unit tests next.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="ea0a71c3"/></a>ea0a71c3</h3>

<pre>
commit ea0a71c39d9756c68dec41b2a16516d0015e5bf2
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jul 29 14:07:41 2014 -0700

    Renaming PsfMatch to PsfMatchTask within ip_diffim; PsfMatch=PsfMatchTask makes this change transparent for other packages
</pre>
<h3><a name="83623b4f"/></a>83623b4f</h3>

<pre>
commit 83623b4f1752472e636678c141d4dd3851f3cf74
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 10:52:09 2014 -0700

    Adding hline to help with doxygen readability
</pre>
<h3><a name="116067c8"/></a>116067c8</h3>

<pre>
commit 116067c859ae65dd6c4e5e161a64c9b561591b0f
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Sep 18 16:58:51 2012 -0500

    Convert ImageStatistics code to use Config to define the good/bad mask planes
</pre>
<h3><a name="a41ad65f"/></a>a41ad65f</h3>

<pre>
commit a41ad65fa901113b9d770416183555eee2fb8177
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 12 13:12:02 2014 -0600

    Modifications to alardMinSigDeconv doc string
</pre>
<h3><a name="0184f44e"/></a>0184f44e</h3>

<pre>
commit 0184f44e5fecb0b1bf67e1c2e1e248b1b21b39d2
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 10:06:16 2014 -0700

    Fixing line length issues in psfMatch.py documentation
</pre>
<h3><a name="d3d9fd18"/></a>d3d9fd18</h3>

<pre>
commit d3d9fd18b50e68225e902c9cf822a1a0697253fb
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 10:08:30 2014 -0700

    Minor documentation fix to PsfMatchTask._buildCellSet
</pre>
<h3><a name="e278f3b9"/></a>e278f3b9</h3>

<pre>
commit e278f3b97137503b6b3dab2decacd37113df0741
Author: Andy Becker <acbecker@gmail.com>
Date:   Mon Sep 17 15:47:03 2012 -0500

    Overall config change to not block on BAD pixels; leave SAT and EDGE as "bad"
</pre>
<h3><a name="71c02d8d"/></a>71c02d8d</h3>

<pre>
commit 71c02d8d5ae64db2a15225f1fd62d07f47405d44
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 11 17:08:10 2014 -0600

    Work on ticket #3143 to allow for a slightly different configuration of a deconvolution kernel, compared to a smoothing kernel
</pre>
<h3><a name="8b7f49ff"/></a>8b7f49ff</h3>

<pre>
commit 8b7f49ff55c0cee47bd9688aa1017e14c72faaac
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:33:58 2014 -0700

    Fixing first-line of doxygen comments for PsfMatch methods
</pre>
<h3><a name="dee8d025"/></a>dee8d025</h3>

<pre>
commit dee8d025aa461b1d045642529523597db323829f
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Jul 18 14:29:38 2014 -0400

    Adapt to changes in exception Python wrappers (DM-827)
</pre>
<h3><a name="adb9c713"/></a>adb9c713</h3>

<pre>
commit adb9c71367ae93df3d30dbd8390cb3fdf7aeaeec
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Sep 18 17:15:54 2012 -0500

    Unnecessary documentation
</pre>
<h3><a name="bef62402"/></a>bef62402</h3>

<pre>
commit bef624022b4fa1bb21114ee5b08f38d736aca280
Author: Andy Becker <acbecker@gmail.com>
Date:   Sun Aug 10 16:10:00 2014 -0700

    Minor wording change to debugging description
</pre>
<h3><a name="f69650db"/></a>f69650db</h3>

<pre>
commit f69650dbc38b8dd6775935928fb94064952c7aa1
Author: Andy Becker <acbecker@gmail.com>
Date:   Sun Aug 3 16:16:51 2014 -0700

    Fixing links to subclasses in doxygen
</pre>
<h3><a name="a081a2a2"/></a>a081a2a2</h3>

<pre>
commit a081a2a244bf355ff9e8bf63c6749e93d252e844
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 8 14:23:18 2014 -0700

    Added pex.logging example to doxygen
</pre>
<h3><a name="7c5682a9"/></a>7c5682a9</h3>

<pre>
commit 7c5682a902e2df668f9a51f4a5bc10b6ef6231f9
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Aug 1 17:52:35 2014 -0700

    Initial Task documentation for PsfMatchTask
</pre>
<h3><a name="504f305d"/></a>504f305d</h3>

<pre>
commit 504f305dc212bf2332290bc75e4e6917a8f6c3cb
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Aug 5 10:07:25 2014 -0700

    Minor documentation fix to PsfMatchTask._solve
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_94"><a name="tests/compareToHotpants.py"/></a>tests/compareToHotpants.py</h1>

<h3 id="toc_95">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#f781ec0b">f781ec0b</a> - import os, sys</div>
                import unittest
                import lsst.utils.tests as tests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#44d7da55">44d7da55</a> - import numpy as num</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#f781ec0b">f781ec0b</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.detection as afwDet
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class DiffimTestCases(unittest.TestCase):
                
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "AL"
                        self.subconfig = self.config.kernel.active
                
                        # Test was put together before the min size went to 21
                        self.subconfig.kernelSize = 19 
                
                        self.subconfig.scaleByFwhm = False
                        self.subconfig.fitForBackground = True
                        self.subconfig.spatialModelType = "polynomial"
                        self.policy = pexConfig.makePolicy(self.subconfig)
                
                        self.smi = afwImage.MaskedImageF('tests/compareToHotpants/scienceMI.fits')
                        self.tmi = afwImage.MaskedImageF('tests/compareToHotpants/templateMI.fits')
                        self.smi.setXY0(0,0)
                        self.tmi.setXY0(0,0)
                
                        # Run detection
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#9a8b565a">9a8b565a</a> -         detConfig = self.subconfig.detectionConfig</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#966eaa96">966eaa96</a> +         #detConfig = self.subconfig.detectionConfig</div>
              ?         +
                        # Note here regarding detConfig:
                        #
                        # If I set detThresholdType = "pixel_stdev", I get slightly
                        # different centroids than if I use "stdev".  These different
                        # centroids screw up the testing since hotpants was hardcoded to
                        # use the "stdev" centroids.  For completeness these are:
                        #
                        # 32 32
                        # 96 32
                        # 160 32
                        # 96 95
                        # 31 96
                        # 160 96
                        # 96 160
                        # 160 160
                        # 32 160
                
                        # As of Winter2013, KernelCandidateDetectionF does not return
                        # these exact centroids anymore, so I need to hardcode them
                        # in.
                        self.footprints = []
                        for xc,yc in [(32, 32), (96, 32), (160, 32),
                                      (96, 95), (31, 96), (160, 96),
                                      (96, 160), (160, 160), (32, 160)]:
                            self.footprints.append(afwDet.Footprint(afwGeom.Box2I(
                                        afwGeom.Point2I(xc,yc), afwGeom.Extent2I(1,1))))
                
                        #detConfig.detThresholdType = "stdev"
                        #kcDetect = ipDiffim.KernelCandidateDetectionF(pexConfig.makePolicy(detConfig))
                        #kcDetect.apply(self.smi, self.tmi)
                        #self.footprints = kcDetect.getFootprints()
                
                        # Make a basis list that hotpants has been run with
                        nGauss = 1
                        sGauss = [3.]
                        dGauss = [3]
                        self.subconfig.alardNGauss = nGauss
                        self.subconfig.alardSigGauss = sGauss
                        self.subconfig.alardDegGauss = dGauss
                        basisList0 = ipDiffim.makeKernelBasisList(self.subconfig)
                
                        # HP does things in a different order, and with different normalization, so reorder list
                        order   = [0, 2, 5, 9, 1, 4, 8, 3, 7, 6]
                        scaling = [1.000000e+00,
                                   8.866037e-02,
                                   1.218095e+01,
                                   5.099318e-03,
                                   8.866037e-02,
                                   4.179772e-02,
                                   1.138120e-02,
                                   1.218095e+01,
                                   1.138120e-02,
                                   5.099318e-03]
                        
                        self.basisList = afwMath.KernelList()
                        for i in range(len(order)):
                            im  = afwImage.ImageD(basisList0[order[i]].getDimensions())
                            basisList0[order[i]].computeImage(im, False)
                            im /= scaling[i]
                            #im.writeFits('k%d.fits' % (i))
                            k   = afwMath.FixedKernel(im)
                            self.basisList.append(k)
                
                        # And a place to put candidates
                        self.kernelCellSet = afwMath.SpatialCellSet(afwGeom.Box2I(afwGeom.Point2I(0,0),
                                                                                  afwGeom.Extent2I(self.smi.getWidth(),
                                                                                                   self.smi.getHeight())),
                                                                    self.policy.getInt("sizeCellX"),
                                                                    self.policy.getInt("sizeCellY"))
                
                        # There are some -1 factors that come from differences in how
                        # convolution is done.  Some resulting convovled images end up
                        # being a factor of -1 different, therefore the coefficients
                        # need to be a factor of -1 different as well.
                        self.parity = [1, -1, 1, -1, -1, 1, -1, 1, -1, -1, 1]
                        
                    def tearDown(self):
                        del self.policy
                        del self.tmi
                        del self.smi
                        del self.basisList
                        del self.footprints
                        del self.kernelCellSet
                            
                    def testSingleNoVariation(self):
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 0)
                        self.policy.set('spatialBgOrder', 0)
                
                        # Place candidate footprints within the spatial grid
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            # Only one passes
                            if xC > 150 and yC > 150:
                                cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                     (0.5 * self.smi.getWidth()),
                                                                     (yC - 0.5 * self.smi.getHeight()) /
                                                                     (0.5 * self.smi.getHeight()),
                                                                     tsmi, ssmi, self.policy)
                                self.kernelCellSet.insertCandidate(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cell in self.kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                
                        HPsingleSolution = [ 0.959086,
                                            -0.000344,
                                            -0.197758,
                                             0.000019,
                                            -0.000172,
                                             0.000053,
                                             0.000018,
                                            -0.192776,
                                             0.000000,
                                             0.000001,
                                             0.602642 ]
                        
                        HPspatialSolution = HPsingleSolution
                
                        singleSolution = cand.getKernel(ipDiffim.KernelCandidateF.RECENT).getKernelParameters()
                        for i in range(len(singleSolution)):
                            self.assertAlmostEqual(HPsingleSolution[i] * self.parity[i], singleSolution[i], 5)
                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getKernelParameters()
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[i] * self.parity[i], spatialSolution[i], 6)
                
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1], 5)
                
                    def testFourNoVariation(self):
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 0)
                        self.policy.set('spatialBgOrder', 0)
                
                        # Place candidate footprints within the spatial grid
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                
                            # Hotpants centroids go from -1 to 1
                            if xC > 90 and yC > 90:
                                cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                     (0.5 * self.smi.getWidth()),
                                                                     (yC - 0.5 * self.smi.getHeight()) /
                                                                     (0.5 * self.smi.getHeight()),
                                                                     tsmi, ssmi, self.policy)
                
                                self.kernelCellSet.insertCandidate(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()        
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cell in self.kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ 0.969559,
                                             -0.000223,
                                             -0.198374,
                                              0.000012,
                                             -0.000010,
                                              0.000036,
                                             -0.000004,
                                             -0.206751,
                                              0.000012,
                                              0.000004,
                                              0.452304 ]
                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getKernelParameters()
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[i] * self.parity[i], spatialSolution[i], 5)
                
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1], 5)
                
                    def testFourKernelVariation(self):
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 1)
                        self.policy.set('spatialBgOrder', 0)
                
                        # Place candidate footprints within the spatial grid
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            if xC > 90 and yC > 90:
                                cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                     (0.5 * self.smi.getWidth()),
                                                                     (yC - 0.5 * self.smi.getHeight()) /
                                                                     (0.5 * self.smi.getHeight()),
                                                                     tsmi, ssmi, self.policy)
                                self.kernelCellSet.insertCandidate(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cell in self.kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ [  0.969559,
                                                 0.,
                                                 0. ],
                                              [ -0.000082,
                                                -0.000620,
                                                 0.000185 ],
                                              [ -0.197749,
                                                 0.001418,
                                                -0.003321 ],
                                              [  0.000002,
                                                 0.000049,
                                                -0.000016 ],
                                              [  0.000211,
                                                -0.000283,
                                                -0.000397 ],
                                              [  0.000034,
                                                 0.000002,
                                                 0.000006 ],
                                              [ -0.000013,
                                                 0.000041,
                                                -0.000010 ],
                                              [ -0.220238,
                                                 0.028395,
                                                 0.013148 ],
                                              [  0.000019,
                                                -0.000025,
                                                 0.000003 ],
                                              [  0.000003,
                                                 0.000000,
                                                 0.000005 ],
                                              0.452304 ]
                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getSpatialParameters()
                
                        for i in range(len(spatialSolution)):
                            # HP and LSST switch the order x<->y
                            self.assertAlmostEqual(HPspatialSolution[i][0] * self.parity[i], spatialSolution[i][0], 5)
                            self.assertAlmostEqual(HPspatialSolution[i][1] * self.parity[i], spatialSolution[i][2], 5)
                            self.assertAlmostEqual(HPspatialSolution[i][2] * self.parity[i], spatialSolution[i][1], 5)
                            
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1], 5)
                
                    def testFourBgVariation(self):
                
                        # OK, so these can end up a bit different due to how HP and
                        # LSST represent the background in the matrix math.  HP has
                        # each pixel have its own coordinate (which goes from -1 to 1
                        # across the entire image, by the way), whereas we give all
                        # the LSST pixels within a stamp the same coordinate.  
                
                        # To make this comparison, I go ahead and edit the Hotpants
                        # code to give each pixel the same weight.  For reference this
                        # is in fillStamp() and I replace:
                        #
                        #        //xf = (i - rPixX2) / rPixX2;
                        #        xf = (xi - rPixX2) / rPixX2;
                        #
                        #            //yf = (j - rPixY2) / rPixY2; 
                        #            yf = (yi - rPixY2) / rPixY2; 
                        
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 0)
                        self.policy.set('spatialBgOrder', 1)
                
                        # Place candidate footprints within the spatial grid
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            if xC > 90 and yC > 90:
                                cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                     (0.5 * self.smi.getWidth()),
                                                                     (yC - 0.5 * self.smi.getHeight()) /
                                                                     (0.5 * self.smi.getHeight()),
                                                                     tsmi, ssmi, self.policy)
                                #print 'OBJECT', cand.getId(), 'AT', xC, yC, cand.getXCenter(), cand.getYCenter()
                                self.kernelCellSet.insertCandidate(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cell in self.kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ 0.969559,
                                             -0.000223,
                                             -0.198374,
                                              0.000012,
                                             -0.000010,
                                              0.000036,
                                             -0.000004,
                                             -0.206751,
                                              0.000012,
                                              0.000004,
                                              [ 0.782113,
                                               -0.910963,
                                               -0.106636] ]
                       
                        
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getKernelParameters()
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[i] * self.parity[i], spatialSolution[i], 5)
                
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1][0], 5)
                        self.assertAlmostEqual(sb.getParameters()[1], HPspatialSolution[-1][2], 5) # x<->y
                        self.assertAlmostEqual(sb.getParameters()[2], HPspatialSolution[-1][1], 5) # x<->y
                
                    def testFourVariation(self):
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 1)
                        self.policy.set('spatialBgOrder', 1)
                
                        # Place candidate footprints within the spatial grid
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            if xC > 90 and yC > 90:
                                cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                     (0.5 * self.smi.getWidth()),
                                                                     (yC - 0.5 * self.smi.getHeight()) /
                                                                     (0.5 * self.smi.getHeight()),
                                                                     tsmi, ssmi, self.policy)
                                self.kernelCellSet.insertCandidate(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()        
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cell in self.kernelCellSet.getCellList():
                            for cand in cell.begin(False): # False = include bad candidates
                                cand  = ipDiffim.cast_KernelCandidateF(cand)
                                bsikv.processCandidate(cand)
                                bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ [  0.969559,
                                                 0.,
                                                 0. ],
                                              [ -0.000082,
                                                -0.000620,
                                                 0.000185 ],
                                              [ -0.197749,
                                                 0.001418,
                                                -0.003321 ],
                                              [  0.000002,
                                                 0.000049,
                                                -0.000016 ],
                                              [  0.000211,
                                                -0.000283,
                                                -0.000397 ],
                                              [  0.000034,
                                                 0.000002,
                                                 0.000006 ],
                                              [ -0.000013,
                                                 0.000041,
                                                -0.000010 ],
                                              [ -0.220238,
                                                 0.028395,
                                                 0.013148 ],
                                              [  0.000019,
                                                -0.000025,
                                                 0.000003 ],
                                              [  0.000003,
                                                 0.000000,
                                                 0.000005 ],
                                              [  0.782113,
                                                -0.910963,
                                                -0.106636] ]
                        
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getSpatialParameters()
                
                        for i in range(len(spatialSolution)):
                            # HP and LSST switch the order x<->y
                            self.assertAlmostEqual(HPspatialSolution[i][0] * self.parity[i], spatialSolution[i][0], 5)
                            self.assertAlmostEqual(HPspatialSolution[i][1] * self.parity[i], spatialSolution[i][2], 5)
                            self.assertAlmostEqual(HPspatialSolution[i][2] * self.parity[i], spatialSolution[i][1], 5)
                
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1][0], 5)
                        self.assertAlmostEqual(sb.getParameters()[1], HPspatialSolution[-1][2], 5) # x<->y
                        self.assertAlmostEqual(sb.getParameters()[2], HPspatialSolution[-1][1], 5) # x<->y
                
                    def testAllBgVariation2(self):
                        # OK, I ran HP on all the things in this image.  Enough for
                        # second order spatial variation
                        
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 0)
                        self.policy.set('spatialBgOrder', 2)
                        
                        # Ignore the whole kernelCellSet thing
                        cands = []
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                 (0.5 * self.smi.getWidth()),
                                                                 (yC - 0.5 * self.smi.getHeight()) /
                                                                 (0.5 * self.smi.getHeight()),
                                                                 tsmi, ssmi, self.policy)
                            cands.append(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()        
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cand in cands:
                            bsikv.processCandidate(cand)
                            bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ 0.968505,
                                             -0.000053,
                                             -0.206505,
                                              0.000005,
                                              0.000062,
                                              0.000028,
                                             -0.000004,
                                             -0.206135,
                                              0.000005,
                                              0.000001,
                                             [ 0.812488,
                                               0.096456,
                                              -1.140900,
                                               0.132670,
                                              -0.571923,
                                              -0.284670] ]
                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getKernelParameters()
                
                        # Kernel
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[i] * self.parity[i], spatialSolution[i], 5)
                
                        # Bg
                        # Ordering of second order terms is just messy
                        spReorder = [0, 3, 1, 5, 4, 2]
                        spatialSolution = sb.getParameters()
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[-1][spReorder[i]], spatialSolution[i], 5)
                
                    def testAllKernelVariation2(self):
                        # OK, I ran HP on all the things in this image.  Enough for
                        # second order spatial variation
                        
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 2)
                        self.policy.set('spatialBgOrder', 0)
                        
                        # Ignore the whole kernelCellSet thing
                        cands = []
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                 (0.5 * self.smi.getWidth()),
                                                                 (yC - 0.5 * self.smi.getHeight()) /
                                                                 (0.5 * self.smi.getHeight()),
                                                                 tsmi, ssmi, self.policy)
                            cands.append(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()        
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cand in cands:
                            bsikv.processCandidate(cand)
                            bspkv.processCandidate(cand)
                
                        HPspatialSolution = [ [  0.968505,
                                                 0.,
                                                 0.,
                                                 0.,
                                                 0.,
                                                 0.,
                                                 0.],
                                              [ -0.000094,
                                                -0.000206,
                                                -0.000027,
                                                 0.000025,
                                                -0.000705,
                                                 0.000162],
                                              [ -0.188375,
                                                 0.001801,
                                                -0.027534,
                                                 0.008718,
                                                 0.016346,
                                                -0.033879],
                                              [  0.000004,
                                                 0.000012,
                                                 0.000023,
                                                 0.000004,
                                                 0.000017,
                                                -0.000020],
                                              [  0.000128,
                                                -0.000218,
                                                 0.000304,
                                                -0.000038,
                                                -0.000151,
                                                -0.000531],
                                              [ -0.000011,
                                                -0.000013,
                                                 0.000038,
                                                -0.000017,
                                                 0.000133,
                                                 0.000093],
                                              [ -0.000003,
                                                 0.000003,
                                                 0.000006,
                                                 0.000008,
                                                 0.000002,
                                                -0.000010],
                                              [ -0.212235,
                                                -0.000856,
                                                 0.012246,
                                                -0.010893,
                                                 0.049302,
                                                 0.008249],
                                              [  0.000014,
                                                -0.000002,
                                                -0.000050,
                                                -0.000001,
                                                 0.000030,
                                                 0.000020],
                                              [ -0.000001,
                                                 0.000010,
                                                -0.000012,
                                                -0.000007,
                                                 0.000015,
                                                 0.000019],
                                              0.392482]
                
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getSpatialParameters()
                
                        # Kernel
                        spReorder = [0, 3, 1, 5, 4, 2]
                        for i in range(len(spatialSolution)):
                            for j in range(len(spReorder)):
                                self.assertAlmostEqual(HPspatialSolution[i][spReorder[j]] * self.parity[i],
                                                       spatialSolution[i][j], 5)
                
                        self.assertAlmostEqual(sb.getParameters()[0], HPspatialSolution[-1], 5)
                
                    def testAllVariation2(self):
                        # OK, I ran HP on all the things in this image.  Enough for
                        # second order spatial variation
                        
                        self.policy.set('constantVarianceWeighting', True)
                        self.policy.set('spatialKernelOrder', 2)
                        self.policy.set('spatialBgOrder', 2)
                        
                        # Ignore the whole kernelCellSet thing
                        cands = []
                        for fp in self.footprints:
                            bbox = fp.getBBox()
                        
                            # Grab the centers in the parent's coordinate system
                            xC   = int(0.5 * ( bbox.getMinX() + bbox.getMaxX() ))
                            yC   = int(0.5 * ( bbox.getMinY() + bbox.getMaxY() ))
                        
                            bbox = afwGeom.Box2I(afwGeom.Point2I(int(xC)-24, int(yC)-24), afwGeom.Extent2I(49, 49))
                        
                            tsmi  = afwImage.MaskedImageF(self.tmi, bbox, afwImage.LOCAL)
                            ssmi  = afwImage.MaskedImageF(self.smi, bbox, afwImage.LOCAL)
                        
                            # Hotpants centroids go from -1 to 1
                            cand = ipDiffim.makeKernelCandidate( (xC - 0.5 * self.smi.getWidth()) /
                                                                 (0.5 * self.smi.getWidth()),
                                                                 (yC - 0.5 * self.smi.getHeight()) /
                                                                 (0.5 * self.smi.getHeight()),
                                                                 tsmi, ssmi, self.policy)
                            cands.append(cand)
                
                        # Visitors
                        bbox  = self.kernelCellSet.getBBox()
                        bsikv = ipDiffim.BuildSingleKernelVisitorF(self.basisList, self.policy)
                        bspkv = ipDiffim.BuildSpatialKernelVisitorF(self.basisList, bbox, self.policy)
                
                        for cand in cands:
                            bsikv.processCandidate(cand)
                            bspkv.processCandidate(cand)
                
                        HPspatialSolution =[ [ 0.968505,
                                               0.,
                                               0.,
                                               0.,
                                               0.,
                                               0.],
                                             [-0.000094,
                                              -0.000206,
                                              -0.000027,
                                               0.000025,
                                              -0.000705,
                                               0.000162],
                                             [-0.188375,
                                               0.001801,
                                              -0.027534,
                                               0.008718,
                                               0.016346,
                                              -0.033879],
                                             [ 0.000004,
                                               0.000012,
                                               0.000023,
                                               0.000004,
                                               0.000017,
                                              -0.000020],
                                             [ 0.000128,
                                              -0.000218,
                                               0.000304,
                                              -0.000038,
                                              -0.000151,
                                              -0.000531],
                                             [-0.000011,
                                              -0.000013,
                                               0.000038,
                                              -0.000017,
                                               0.000133,
                                               0.000093],
                                             [-0.000003,
                                               0.000003,
                                               0.000006,
                                               0.000008,
                                               0.000002,
                                              -0.000010],
                                             [-0.212235,
                                              -0.000856,
                                               0.012246,
                                              -0.010893,
                                               0.049302,
                                               0.008249],
                                             [ 0.000014,
                                              -0.000002,
                                              -0.000050,
                                              -0.000001,
                                               0.000030,
                                               0.000020],
                                             [-0.000001,
                                               0.000010,
                                              -0.000012,
                                              -0.000007,
                                               0.000015,
                                               0.000019],
                                             [ 0.812488,
                                               0.096456,
                                              -1.140900,
                                               0.132670,
                                              -0.571923,
                                              -0.284670] ]
                        
                        bspkv.solveLinearEquation()
                        sk, sb = bspkv.getSolutionPair()
                        spatialSolution = sk.getSpatialParameters()
                
                        # Kernel
                        spReorder = [0, 3, 1, 5, 4, 2]
                        for i in range(len(spatialSolution)):
                            for j in range(len(spReorder)):
                                self.assertAlmostEqual(HPspatialSolution[i][spReorder[j]] * self.parity[i],
                                                       spatialSolution[i][j], 5)
                        # Bg
                        spatialSolution = sb.getParameters()
                        for i in range(len(spatialSolution)):
                            self.assertAlmostEqual(HPspatialSolution[-1][spReorder[i]], spatialSolution[i], 5)
                
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="44d7da55"/></a>44d7da55</h3>

<pre>
commit 44d7da55dea74894e824e6643d71fe39037ece0e
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 16:48:10 2012 -0800

    Up to KernelCandidateAndSolution, where I am getting a Swig problem.
</pre>
<h3><a name="f781ec0b"/></a>f781ec0b</h3>

<pre>
commit f781ec0b0388ba8fb8c21264484f390acd824c38
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Jun 9 19:31:14 2010 +0000

    Unit test to compare to hotpants code.  Exactly works!  #1140.
</pre>
<h3><a name="9a8b565a"/></a>9a8b565a</h3>

<pre>
commit 9a8b565a2257570cc7c685089f89b480a4911342
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 22 10:49:09 2012 -0800

    Config uses registries now.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_96"><a name="tests/AssessSpatialKernelVisitor.py"/></a>tests/AssessSpatialKernelVisitor.py</h1>

<h3 id="toc_97">Diff:</h3>

<pre>
                #!/usr/bin/env python
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#c96bb23c">c96bb23c</a> - import os, sys</div>
                import unittest
                import numpy as num
                
                import lsst.utils.tests as tests
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#c96bb23c">c96bb23c</a> - import eups</div>
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.ip.diffim as ipDiffim
                import lsst.pex.logging as pexLog
                import lsst.pex.config as pexConfig
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#4b34646f">4b34646f</a> - import lsst.afw.display.ds9 as ds9</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#966eaa96">966eaa96</a> + #import lsst.afw.display.ds9 as ds9</div>
              ? +
                
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class DiffimTestCases(unittest.TestCase):
                    
                    def setUp(self):
                        self.config    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.config.kernel.name = "AL"
                        self.subconfig = self.config.kernel.active
                
                        self.policy = pexConfig.makePolicy(self.subconfig)
                        self.kList  = ipDiffim.makeKernelBasisList(self.subconfig)
                
                        self.ksize  = self.policy.get('kernelSize')
                
                    def makeSpatialKernel(self, order):
                        basicGaussian1 = afwMath.GaussianFunction2D(2., 2., 0.)
                        basicKernel1   = afwMath.AnalyticKernel(self.ksize, self.ksize, basicGaussian1)
                        
                        basicGaussian2 = afwMath.GaussianFunction2D(5., 3., 0.5 * num.pi)
                        basicKernel2   = afwMath.AnalyticKernel(self.ksize, self.ksize, basicGaussian2)
                        
                        basisList = afwMath.KernelList()
                        basisList.append(basicKernel1)
                        basisList.append(basicKernel2)
                        basisList = afwMath.KernelList(ipDiffim.renormalizeKernelList(basisList))
                        
                        spatialKernelFunction = afwMath.PolynomialFunction2D(order)
                        spatialKernel = afwMath.LinearCombinationKernel(basisList, spatialKernelFunction)
                        kCoeffs = [[0.0      for x in range(1,spatialKernelFunction.getNParameters()+1)],
                                   [0.01 * x for x in range(1,spatialKernelFunction.getNParameters()+1)]]
                        kCoeffs[0][0] = 1.0  # it does not vary spatially; constant across image
                        spatialKernel.setSpatialParameters(kCoeffs)
                        return spatialKernel
                
                    def tearDown(self):
                        del self.policy
                        del self.kList
                
                    def testGood(self):
                        ti = afwImage.MaskedImageF(afwGeom.Extent2I(100, 100))
                        ti.getVariance().set(0.1)
                        ti.set(50, 50, (1., 0x0, 1.))
                        sKernel = self.makeSpatialKernel(2)
                        si = afwImage.MaskedImageF(ti.getDimensions())
                        afwMath.convolve(si, ti, sKernel, True)
                
                        bbox = afwGeom.Box2I(afwGeom.Point2I(25, 25),
                                             afwGeom.Point2I(75, 75))
                        si   = afwImage.MaskedImageF(si, bbox, afwImage.LOCAL)
                        ti   = afwImage.MaskedImageF(ti, bbox, afwImage.LOCAL)
                        kc   = ipDiffim.KernelCandidateF(50., 50., ti, si, self.policy)
                
                        sBg      = afwMath.PolynomialFunction2D(1)
                        bgCoeffs = [0., 0., 0.]
                        sBg.setParameters(bgCoeffs)
                
                        # must be initialized
                        bskv = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                        bskv.processCandidate(kc)
                        self.assertEqual(kc.isInitialized(), True)
                        #ds9.mtv(kc.getTemplateMaskedImage(), frame=1)
                        #ds9.mtv(kc.getScienceMaskedImage(), frame=2)
                        #ds9.mtv(kc.getKernelImage(ipDiffim.KernelCandidateF.RECENT), frame=3)
                        #ds9.mtv(kc.getDifferenceImage(ipDiffim.KernelCandidateF.RECENT), frame=4)
                        
                        askv = ipDiffim.AssessSpatialKernelVisitorF(sKernel, sBg, self.policy)
                        askv.processCandidate(kc)
                        
                        self.assertEqual(askv.getNProcessed(), 1)
                        self.assertEqual(askv.getNRejected(), 0)
                        self.assertEqual(kc.getStatus(), afwMath.SpatialCellCandidate.GOOD)
                        
                    def testBad(self):
                        ti = afwImage.MaskedImageF(afwGeom.Extent2I(100, 100))
                        ti.getVariance().set(0.1)
                        ti.set(50, 50, (1., 0x0, 1.))
                        sKernel = self.makeSpatialKernel(2)
                        si = afwImage.MaskedImageF(ti.getDimensions())
                        afwMath.convolve(si, ti, sKernel, True)
                
                        bbox = afwGeom.Box2I(afwGeom.Point2I(25, 25),
                                             afwGeom.Point2I(75, 75))
                        si   = afwImage.MaskedImageF(si, bbox, afwImage.LOCAL)
                        ti   = afwImage.MaskedImageF(ti, bbox, afwImage.LOCAL)
                        kc   = ipDiffim.KernelCandidateF(50., 50., ti, si, self.policy)
                
                        badGaussian = afwMath.GaussianFunction2D(1., 1., 0.)
                        badKernel   = afwMath.AnalyticKernel(self.ksize, self.ksize, badGaussian)
                        basisList = afwMath.KernelList()
                        basisList.append(badKernel)
                        badSpatialKernelFunction = afwMath.PolynomialFunction2D(0)
                        badSpatialKernel = afwMath.LinearCombinationKernel(basisList, badSpatialKernelFunction)
                        badSpatialKernel.setSpatialParameters([[1,]])
                        
                        sBg      = afwMath.PolynomialFunction2D(1)
                        bgCoeffs = [10., 10., 10.]
                        sBg.setParameters(bgCoeffs)
                
                        # must be initialized
                        bskv = ipDiffim.BuildSingleKernelVisitorF(self.kList, self.policy)
                        bskv.processCandidate(kc)
                        self.assertEqual(kc.isInitialized(), True)
                        
                        askv = ipDiffim.AssessSpatialKernelVisitorF(badSpatialKernel, sBg, self.policy)
                        askv.processCandidate(kc)
                       
                        self.assertEqual(askv.getNProcessed(), 1)
                        self.assertEqual(askv.getNRejected(), 1)
                        self.assertEqual(kc.getStatus(), afwMath.SpatialCellCandidate.BAD)
                
                        
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="4b34646f"/></a>4b34646f</h3>

<pre>
commit 4b34646f11de8c8504a24ef625c3c3203e8e0a85
Author: becker <becker@git.lsstcorp.org>
Date:   Mon Jun 7 22:41:00 2010 +0000

    AssessSpatialKernelVisitor unit test.
</pre>
<h3><a name="c96bb23c"/></a>c96bb23c</h3>

<pre>
commit c96bb23c0f7912d0ba725ab5fef84ea79b29c681
Author: becker <becker@git.lsstcorp.org>
Date:   Wed Mar 24 18:26:45 2010 +0000

    Working on unit tests.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_98"><a name="src/KernelSumVisitor.cc"/></a>src/KernelSumVisitor.cc</h1>

<h3 id="toc_99">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file KernelSumVisitor.h
                 *
                 * @brief Implementation of KernelSumVisitor 
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                #include <limits>
                
                #include "lsst/afw/math.h"
                #include "lsst/pex/policy/Policy.h"
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/KernelCandidate.h"
                #include "lsst/ip/diffim/KernelSumVisitor.h"
                
                namespace afwMath        = lsst::afw::math;
                namespace pexLogging     = lsst::pex::logging; 
                namespace pexPolicy      = lsst::pex::policy; 
                namespace pexExcept      = lsst::pex::exceptions; 
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                namespace detail {
                    
                    /**
                     * @class KernelSumVisitor
                     * @ingroup ip_diffim
                     *
                     * @brief A class to accumulate kernel sums across SpatialCells 
                     *
                     * @code
                        Policy::Ptr policy(new Policy);
                        policy->set("kernelSumClipping", false);
                        policy->set("maxKsumSigma", 3.0);
                     
                        detail::KernelSumVisitor<PixelT> kernelSumVisitor(*policy);
                        kernelSumVisitor.reset();
                        kernelSumVisitor.setMode(detail::KernelSumVisitor<PixelT>::AGGREGATE);
                        kernelCells.visitCandidates(&kernelSumVisitor, nStarPerCell);
                        kernelSumVisitor.processKsumDistribution();
                        kernelSumVisitor.setMode(detail::KernelSumVisitor<PixelT>::REJECT);
                        kernelCells.visitCandidates(&kernelSumVisitor, nStarPerCell);
                        int nRejected = kernelSumVisitor.getNRejected();
                     * @endcode
                     *
                     *
                     * @note The class has 2 processing modes; the first AGGREGATES kernel sums
                     * across all candidates.  You must the process the distribution to set member
                     * variables representing the mean and standard deviation of the kernel sums.
                     * The second mode then REJECTs candidates with kernel sums outside the
                     * acceptable range (set by the policy).  It does this by setting candidate
                     * status to afwMath::SpatialCellCandidate::BAD.  In this mode it also
                     * accumulates the number of candidates it sets as bad.
                     *
                     * @note The statistics call calculates sigma-clipped values (afwMath::MEANCLIP,
                     * afwMath::STDEVCLIP)
                     *
                     */
                    template<typename PixelT>
                    KernelSumVisitor<PixelT>::KernelSumVisitor(
                        lsst::pex::policy::Policy const& policy ///< Policy file directing behavior
                        ) :
                        afwMath::CandidateVisitor(),
                        _mode(AGGREGATE),
                        _kSums(std::vector<double>()),
                        _kSumMean(0.),
                        _kSumStd(0.),
                        _dkSumMax(0.),
                        _kSumNpts(0),
                        _nRejected(0),
                        _policy(policy) 
                    {};
                    
                    template<typename PixelT>
                    void KernelSumVisitor<PixelT>::resetKernelSum() {
                        _kSums.clear();
                        _kSumMean =  0.;
                        _kSumStd  =  0.;
                        _dkSumMax =  0.;
                        _kSumNpts =  0;
                        _nRejected = 0;
                    }
                
                    template<typename PixelT>
                    void KernelSumVisitor<PixelT>::processCandidate(lsst::afw::math::SpatialCellCandidate 
                                                                    *candidate) {
                
                        KernelCandidate<PixelT> *kCandidate = dynamic_cast<KernelCandidate<PixelT> *>(candidate);
                        if (kCandidate == NULL) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#c67c91dd">c67c91dd</a> -             throw LSST_EXCEPT(pexExcept::LogicErrorException,</div>
              ?                                                    ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::LogicError,</div>
                                              "Failed to cast SpatialCellCandidate to KernelCandidate");
                        }
                        pexLogging::TTrace<6>("lsst.ip.diffim.KernelSumVisitor.processCandidate", 
                                              "Processing candidate %d, mode %d", kCandidate->getId(), _mode);
                        
                        /* Grab all kernel sums and look for outliers */
                        if (_mode == AGGREGATE) {
                            _kSums.push_back(kCandidate->getKernelSolution(KernelCandidate<PixelT>::ORIG)->getKsum());
                        }
                        else if (_mode == REJECT) {
                            if (_policy.getBool("kernelSumClipping")) {
                                double kSum = 
                                    kCandidate->getKernelSolution(KernelCandidate<PixelT>::ORIG)->getKsum();
                
                                if (fabs(kSum - _kSumMean) > _dkSumMax) {
                                    kCandidate->setStatus(afwMath::SpatialCellCandidate::BAD);
                                    pexLogging::TTrace<4>("lsst.ip.diffim.KernelSumVisitor.processCandidate", 
                                                          "Rejecting candidate %d; bad source kernel sum : (%.2f)",
                                                          kCandidate->getId(),
                                                          kSum);
                                    _nRejected += 1;
                                }
                            }
                            else {
                                pexLogging::TTrace<6>("lsst.ip.diffim.KernelSumVisitor.processCandidate", 
                                                      "Sigma clipping not enabled");
                            }
                        }
                    }
                    
                    template<typename PixelT>
                    void KernelSumVisitor<PixelT>::processKsumDistribution() {
                        if (_kSums.size() == 0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Unable to determine kernel sum; 0 candidates");
                        }
                        else if (_kSums.size() == 1) {
                            pexLogging::TTrace<2>("lsst.ip.diffim.KernelSumVisitor.processKsumDistribution", 
                                                  "WARNING: only 1 kernel candidate");
                            
                            _kSumMean = _kSums[0];
                            _kSumStd  = 0.0;
                            _kSumNpts = 1;
                        }
                        else {
                            try {
                                afwMath::Statistics stats = afwMath::makeStatistics(_kSums, 
                                                                                    afwMath::NPOINT | 
                                                                                    afwMath::MEANCLIP | 
                                                                                    afwMath::STDEVCLIP); 
                                _kSumMean = stats.getValue(afwMath::MEANCLIP);
                                _kSumStd  = stats.getValue(afwMath::STDEVCLIP);
                                _kSumNpts = static_cast<int>(stats.getValue(afwMath::NPOINT));
                            } catch (pexExcept::Exception &e) {
                                LSST_EXCEPT_ADD(e, "Unable to calculate kernel sum statistics");
                                throw e;
                            }
                            if (std::isnan(_kSumMean)) {
                                throw LSST_EXCEPT(pexExcept::Exception, 
                                                  str(boost::format("Mean kernel sum returns NaN (%d points)") 
                                                      % _kSumNpts));
                            }
                            if (std::isnan(_kSumStd)) {
                                throw LSST_EXCEPT(pexExcept::Exception, 
                                                  str(boost::format("Kernel sum stdev returns NaN (%d points)") 
                                                      % _kSumNpts));
                            }
                        }
                        _dkSumMax = _policy.getDouble("maxKsumSigma") * _kSumStd;
                        pexLogging::TTrace<2>("lsst.ip.diffim.KernelSumVisitor.processCandidate", 
                                              "Kernel Sum Distribution : %.3f +/- %.3f (%d points)", 
                                              _kSumMean, _kSumStd, _kSumNpts);
                    }
                    
                    typedef float PixelT;
                
                    template class KernelSumVisitor<PixelT>;
                
                    template boost::shared_ptr<KernelSumVisitor<PixelT> > 
                    makeKernelSumVisitor<PixelT>(lsst::pex::policy::Policy const&);
                
                }}}} // end of namespace lsst::ip::diffim::detail
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="c67c91dd"/></a>c67c91dd</h3>

<pre>
commit c67c91dd4e81b9b72be671a573ee8a5c541bd30b
Author: becker <becker@git.lsstcorp.org>
Date:   Sat Feb 27 21:32:29 2010 +0000

    Moved Visitor code into separate declaration and implementation files.  #1140.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_100"><a name="tests/ImagePsfMatch.py"/></a>tests/ImagePsfMatch.py</h1>

<h3 id="toc_101">Diff:</h3>

<pre>
                #!/usr/bin/env python
                import unittest
                import lsst.utils.tests as tests
                import lsst.afw.image as afwImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#54efc895">54efc895</a> - import lsst.afw.image.utils as imageUtils</div>
                import lsst.afw.math as afwMath
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#b3a497e9">b3a497e9</a> - import lsst.afw.detection as afwDet</div>
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                import lsst.daf.base as dafBase
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#54efc895">54efc895</a> - import lsst.pex.policy as pexPolicy</div>
                import lsst.meas.algorithms as measAlg
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#54efc895">54efc895</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#b3a497e9">b3a497e9</a> - import lsst.afw.geom as afwGeom</div>
                
                import lsst.pex.logging as pexLog
                pexLog.Trace_setVerbosity('lsst.ip.diffim', 5)
                
                class PsfMatchTestCases(unittest.TestCase):
                
                    def setUp(self):
                        self.configAL    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configAL.kernel.name = "AL"
                        self.subconfigAL = self.configAL.kernel.active
                
                        self.configDF    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDF.kernel.name = "DF"
                        self.subconfigDF = self.configDF.kernel.active
                
                        self.configDFr    = ipDiffim.ImagePsfMatchTask.ConfigClass()
                        self.configDFr.kernel.name = "DF"
                        self.subconfigDFr = self.configDFr.kernel.active
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#57b19673">57b19673</a> -         self.subconfigAL.afwBackgroundConfig.useApprox = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#57b19673">57b19673</a> -         self.subconfigDF.afwBackgroundConfig.useApprox = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#57b19673">57b19673</a> -         self.subconfigDFr.afwBackgroundConfig.useApprox = False</div>
                
                        self.subconfigDF.useRegularization = False
                        self.subconfigDFr.useRegularization = True
                
                        self.subconfigAL.constantVarianceWeighting = False
                        self.subconfigDF.constantVarianceWeighting = False
                        self.subconfigDFr.constantVarianceWeighting = False
                
                        # variance is a hack
                        self.subconfigAL.singleKernelClipping   = False
                        self.subconfigAL.spatialKernelClipping  = False
                        self.subconfigDF.singleKernelClipping   = False
                        self.subconfigDF.spatialKernelClipping  = False
                        self.subconfigDFr.singleKernelClipping  = False
                        self.subconfigDFr.spatialKernelClipping = False
                
                        # Send fake kernel a differential background
                        self.bgValue = 100.
                        self.subconfigAL.fitForBackground = True
                        self.subconfigDF.fitForBackground = True
                        self.subconfigDFr.fitForBackground = True
                
                        # Make ideal PSF
                        self.ksize  = 21
                        self.sigma = 2.0
                        self.psf = measAlg.DoubleGaussianPsf(self.ksize, self.ksize, self.sigma)
                
                    def makeWcs(self, offset = 0):
                        # taken from $AFW_DIR/tests/testMakeWcs.py
                        metadata = dafBase.PropertySet()
                        metadata.set("SIMPLE", "T")
                        metadata.set("BITPIX", -32)
                        metadata.set("NAXIS", 2)
                        metadata.set("NAXIS1", 1024)
                        metadata.set("NAXIS2", 1153)
                        metadata.set("RADECSYS", 'FK5')
                        metadata.set("EQUINOX", 2000.)
                        metadata.setDouble("CRVAL1", 215.604025685476)
                        metadata.setDouble("CRVAL2", 53.1595451514076)
                        metadata.setDouble("CRPIX1", 1109.99981456774 + offset)
                        metadata.setDouble("CRPIX2", 560.018167811613 + offset)
                        metadata.set("CTYPE1", 'RA---SIN')
                        metadata.set("CTYPE2", 'DEC--SIN')
                        metadata.setDouble("CD1_1", 5.10808596133527E-05)
                        metadata.setDouble("CD1_2", 1.85579539217196E-07)
                        metadata.setDouble("CD2_2", -5.10281493481982E-05)
                        metadata.setDouble("CD2_1", -8.27440751733828E-07)
                        return afwImage.makeWcs(metadata)
                
                    def testWarping(self):
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = self.bgValue)
                
                        tWcs = self.makeWcs(offset = 0)
                        sWcs = self.makeWcs(offset = 1)
                        tExp = afwImage.ExposureF(tMi, tWcs)
                        sExp = afwImage.ExposureF(sMi, sWcs)
                
                        # Should fail due to registration problem
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#966eaa96">966eaa96</a> +         psfMatchAL  = ipDiffim.ImagePsfMatchTask(config=self.configAL)</div>
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#54efc895">54efc895</a> -             resultsAL  = psfMatchAL.subtractExposures(tExp, sExp, doWarping = True)</div>
              ?            -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#966eaa96">966eaa96</a> +             psfMatchAL.subtractExposures(tExp, sExp, doWarping = True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#54efc895">54efc895</a> -         except:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#966eaa96">966eaa96</a> +         except Exception as e:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#966eaa96">966eaa96</a> +             print "testWarning failed with %r" % (e,)</div>
                            pass
                        else:
                            self.fail()
                
                    def testSubtractExposures(self):
                        # Test all 3 options
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = self.bgValue)
                
                        tWcs = self.makeWcs(offset = 0)
                        sWcs = self.makeWcs(offset = 1)
                        tExp = afwImage.ExposureF(tMi, tWcs)
                        sExp = afwImage.ExposureF(sMi, sWcs)
                        sExp.setPsf(self.psf)
                
                        psfMatchAL  = ipDiffim.ImagePsfMatchTask(config=self.configAL)
                        psfMatchDF  = ipDiffim.ImagePsfMatchTask(config=self.configDF)
                        psfMatchDFr = ipDiffim.ImagePsfMatchTask(config=self.configDFr)
                
                        self.assertEqual(psfMatchAL.useRegularization, False)
                        self.assertEqual(psfMatchDF.useRegularization, False)
                        self.assertEqual(psfMatchDFr.useRegularization, True)
                
                        resultsAL  = psfMatchAL.subtractExposures(tExp, sExp, doWarping = True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#ff220272">ff220272</a> -         resultsDF  = psfMatchDF.subtractExposures(tExp, sExp, doWarping = True)</div>
              ?        -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#966eaa96">966eaa96</a> +         psfMatchDF.subtractExposures(tExp, sExp, doWarping = True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#ff220272">ff220272</a> -         resultsDFr = psfMatchDFr.subtractExposures(tExp, sExp, doWarping = True)</div>
              ?        -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#966eaa96">966eaa96</a> +         psfMatchDFr.subtractExposures(tExp, sExp, doWarping = True)</div>
                
                        self.assertEqual(type(resultsAL.subtractedExposure), afwImage.ExposureF)
                        self.assertEqual(type(resultsAL.psfMatchingKernel), afwMath.LinearCombinationKernel)
                        self.assertEqual(type(resultsAL.backgroundModel), afwMath.Function2D)
                        self.assertEqual(type(resultsAL.kernelCellSet), afwMath.SpatialCellSet)
                
                    def testMatchExposures(self):
                        # Only test 1 option
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = self.bgValue)
                
                        tWcs = self.makeWcs(offset = 0)
                        sWcs = self.makeWcs(offset = 1)
                        tExp = afwImage.ExposureF(tMi, tWcs)
                        sExp = afwImage.ExposureF(sMi, sWcs)
                        sExp.setPsf(self.psf)
                
                        psfMatchAL = ipDiffim.ImagePsfMatchTask(config=self.configAL)
                        resultsAL  = psfMatchAL.matchExposures(tExp, sExp,
                                                               templateFwhmPix = 2.0, scienceFwhmPix = 3.0, doWarping = True)
                        self.assertEqual(type(resultsAL.matchedExposure), afwImage.ExposureF)
                        self.assertEqual(type(resultsAL.psfMatchingKernel), afwMath.LinearCombinationKernel)
                        self.assertEqual(type(resultsAL.backgroundModel), afwMath.Function2D)
                        self.assertEqual(type(resultsAL.kernelCellSet), afwMath.SpatialCellSet)
                
                    def testPca(self, nTerms = 3):
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = self.bgValue)
                
                        tWcs = self.makeWcs(offset = 0)
                        sWcs = self.makeWcs(offset = 0)
                        tExp = afwImage.ExposureF(tMi, tWcs)
                        sExp = afwImage.ExposureF(sMi, sWcs)
                        sExp.setPsf(self.psf)
                
                        self.subconfigDF.usePcaForSpatialKernel = True
                        self.subconfigDF.numPrincipalComponents = nTerms
                
                        psfMatchDF  = ipDiffim.ImagePsfMatchTask(config=self.configDF)
                        candList = psfMatchDF.makeCandidateList(tExp, sExp, self.ksize)
                        resultsDF   = psfMatchDF.subtractMaskedImages(tMi, sMi, candList)
                
                        spatialKernel = resultsDF.psfMatchingKernel
                        spatialKernelSolution = spatialKernel.getSpatialParameters()
                        self.assertEqual(len(spatialKernelSolution), nTerms)
                
                        # First basis has no spatial variation
                        for i in range(1, nTerms):
                            self.assertEqual(spatialKernelSolution[0][i], 0.)
                
                        # All bases have correct number of terms
                        sko = self.subconfigDF.spatialKernelOrder
                        nSpatialTerms = int(0.5 * (sko + 1) * (sko + 2))
                        for i in range(len(spatialKernelSolution)):
                            self.assertEqual(len(spatialKernelSolution[i]), nSpatialTerms)
                
                        spatialBg = resultsDF.backgroundModel
                        spatialBgSolution = spatialBg.getParameters()
                        bgo = self.subconfigDF.spatialBgOrder
                        nBgTerms = int(0.5 * (bgo + 1) * (bgo + 2))
                        self.assertEqual(len(spatialBgSolution), nBgTerms)
                
                    def testSubtractMaskedImages(self):
                        # Lets do some additional testing here to make sure we recover
                        # the known spatial model.  No background, just the faked
                        # alard-lupton basis set.  The rest of matchMaskedImages() and
                        # subtractMaskedImages() functionality is tested by the
                        # Exposure-based methods.
                        fakeCoeffs = diffimTools.fakeCoeffs()
                
                        # Quick note; you shouldn't change confake here, since the
                        # candidates in the KernelCellSet are initialized in
                        # makeFakeKernelSet
                        tMi, sMi, sK, kcs, confake = diffimTools.makeFakeKernelSet(bgValue = 0.0, addNoise = False)
                
                        svar = sMi.getVariance()
                        svar.set(1.0)
                        tvar = tMi.getVariance()
                        tvar.set(1.0)
                
                        basisList = ipDiffim.makeKernelBasisList(confake.kernel.active)
                        psfMatchAL = ipDiffim.ImagePsfMatchTask(config=confake)
                        spatialSolution, psfMatchingKernel, backgroundModel = psfMatchAL._solve(kcs, basisList)
                
                        fitCoeffs = psfMatchingKernel.getSpatialParameters()
                
                        for b in range(len(fakeCoeffs)):
                            for s in range(len(fakeCoeffs[b])):
                
                                if fakeCoeffs[b][s] == 0.0:
                                    self.assertAlmostEqual(fitCoeffs[b][s], 0.0)
                                else:
                                    # OUTSTANDING ISSUE - WHY IS THIS ONE TERM OFF!?!?
                                    if b != 4 and s != 0:
                                       self.assertAlmostEqual(fitCoeffs[b][s]/fakeCoeffs[b][s], 1.0, 1)
                
                    def tearDown(self):
                        del self.configAL
                        del self.configDF
                        del self.configDFr
                        del self.psf
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(PsfMatchTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="57b19673"/></a>57b19673</h3>

<pre>
commit 57b19673488ac33f17461fcdeeffdd6203f64d9c
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Mon Apr 20 16:57:34 2015 +0900

    Set tests to use original background config params.
</pre>
<h3><a name="54efc895"/></a>54efc895</h3>

<pre>
commit 54efc8957105afda461df0e5cf9dd70e35bd5ca6
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 8 13:53:11 2012 -0800

    Extensive changes to get ImagePsfMatch unit tests working.
</pre>
<h3><a name="9a8b565a"/></a>9a8b565a</h3>

<pre>
commit 9a8b565a2257570cc7c685089f89b480a4911342
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 22 10:49:09 2012 -0800

    Config uses registries now.
</pre>
<h3><a name="b3a497e9"/></a>b3a497e9</h3>

<pre>
commit b3a497e98a5a28c0b7056eb58696f12cee049dad
Author: Simon Krughoff <krughoff@astro.washington.edu>
Date:   Thu Feb 14 16:26:34 2013 -0800

    Fixed unit tests and added detection and measurement code
</pre>
<h3><a name="ff220272"/></a>ff220272</h3>

<pre>
commit ff2202729761b848f39992157126ed47d518aacf
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 14 14:17:10 2012 -0700

    Modified ImagePsfMatchTask as follows:
    - The four main methods originally called by run now return Structs so they are easier to use
    - Deprecated the run method (log a warning)
    - The subtract methods return the matched image
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_102"><a name="python/lsst/ip/diffim/makeKernelBasisList.py"/></a>python/lsst/ip/diffim/makeKernelBasisList.py</h1>

<h3 id="toc_103">Diff:</h3>

<pre>
                #
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import diffimLib 
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#906178a2">906178a2</a> - import lsst.pex.config as pexConfig</div>
                import lsst.pex.logging as pexLog
                import numpy as np
                sigma2fwhm = 2. * np.sqrt(2. * np.log(2.))
                
                def makeKernelBasisList(config, targetFwhmPix=None, referenceFwhmPix=None,
                                        basisDegGauss=None, metadata=None):
                    """Generate the appropriate Kernel basis based on the Config"""
                    if config.kernelBasisSet == "alard-lupton":
                        return generateAlardLuptonBasisList(config, targetFwhmPix=targetFwhmPix,
                                                            referenceFwhmPix=referenceFwhmPix,
                                                            basisDegGauss=basisDegGauss,
                                                            metadata=metadata)
                    elif config.kernelBasisSet == "delta-function":
                        kernelSize = config.kernelSize
                        return diffimLib.makeDeltaFunctionBasisList(kernelSize, kernelSize)
                    else:
                        raise ValueError("Cannot generate %s basis set" % (config.kernelBasisSet))
                
                def generateAlardLuptonBasisList(config, targetFwhmPix=None, referenceFwhmPix=None,
                                                 basisDegGauss=None, metadata=None):
                    """Generate an Alard-Lupton kernel basis based upon the Config and
                    the input FWHM of the science and template images"""
                
                    if config.kernelBasisSet != "alard-lupton":
                        raise RuntimeError("Cannot generate %s basis within generateAlardLuptonBasisList" % config.kernelBasisSet)
                
                    kernelSize     = config.kernelSize
                    fwhmScaling    = config.kernelSizeFwhmScaling
                    basisNGauss    = config.alardNGauss
                    basisSigmaGauss  = config.alardSigGauss
                    basisGaussBeta = config.alardGaussBeta
                    basisMinSigma  = config.alardMinSig
                    if basisDegGauss is None:
                        basisDegGauss = config.alardDegGauss
                
                    if len(basisDegGauss) != basisNGauss:
                        raise ValueError("len(basisDegGauss) != basisNGauss : %d vs %d" % (len(basisDegGauss), basisNGauss))
                    if len(basisSigmaGauss) != basisNGauss:
                        raise ValueError("len(basisSigmaGauss) != basisNGauss : %d vs %d" % (len(basisSigmaGauss), basisNGauss))
                    if (kernelSize % 2) != 1:
                        raise ValueError("Only odd-sized Alard-Lupton bases allowed")
                
                    if (targetFwhmPix is None) or (referenceFwhmPix is None) or (not config.scaleByFwhm):
                        if metadata is not None:
                            metadata.add("ALBasisNGauss", basisNGauss)
                            metadata.add("ALBasisDegGauss", basisDegGauss)
                            metadata.add("ALBasisSigGauss", basisSigmaGauss)
                            metadata.add("ALKernelSize", kernelSize)
                
                        return diffimLib.makeAlardLuptonBasisList(kernelSize//2, basisNGauss, basisSigmaGauss, basisDegGauss)
                
                    targetSigma    = targetFwhmPix / sigma2fwhm
                    referenceSigma = referenceFwhmPix / sigma2fwhm
                    pexLog.Trace("lsst.ip.diffim.generateAlardLuptonBasisList", 2,
                                 "Generating matching bases for sigma %.2f pix -> %.2f pix" % (targetSigma, referenceSigma))
                
                    # Modify the size of Alard Lupton kernels based upon the images FWHM
                    #
                    # Note the operation is : template.x.kernel = science
                    #
                    # Assuming the template and science image Psfs are Gaussians with
                    # the Fwhm above, Fwhm_T **2 + Fwhm_K **2 = Fwhm_S **2
                    #
                    if targetSigma == referenceSigma:
                        # Leave defaults as-is
                        pass
                    elif referenceSigma > targetSigma:
                        # Normal convolution
                
                        # First Gaussian has the sigma that comes from the convolution
                        # of two Gaussians : Sig_S**2 = Sig_T**2 + Sig_K**2
                        #
                        # If it's larger than basisMinSigma * basisGaussBeta, make it the
                        # second kernel.  Else make it the smallest kernel.  Unless
                        # only 1 kernel is asked for.
                        kernelSigma = np.sqrt(referenceSigma**2 - targetSigma**2)
                        if kernelSigma < basisMinSigma:
                            kernelSigma = basisMinSigma
                
                        basisSigmaGauss = []
                        if basisNGauss == 1:
                            basisSigmaGauss.append(kernelSigma)
                            nAppended = 1
                        else:
                            if (kernelSigma/basisGaussBeta) > basisMinSigma:
                                basisSigmaGauss.append(kernelSigma/basisGaussBeta)
                                basisSigmaGauss.append(kernelSigma)
                                nAppended = 2
                            else:
                                basisSigmaGauss.append(kernelSigma)
                                nAppended = 1
                
                        # Any other Gaussians above basisNGauss=1 come from a scaling
                        # relationship: Sig_i+1 / Sig_i = basisGaussBeta
                        for i in range(nAppended,basisNGauss):
                            basisSigmaGauss.append(basisSigmaGauss[-1]*basisGaussBeta)
                
                        kernelSize  = int(fwhmScaling * basisSigmaGauss[-1])
                        kernelSize += 0 if kernelSize%2 else 1 # Make sure it's odd
                        kernelSize  = min(config.kernelSizeMax, max(kernelSize, config.kernelSizeMin))
                
                    else:
                        # Deconvolution; Define the progression of Gaussians using a
                        # method to derive a deconvolution sum-of-Gaussians from it's
                        # convolution counterpart.  Only use 3 since the algorithm
                        # assumes 3 components.
                        #
                        # http://iopscience.iop.org/0266-5611/26/8/085002  Equation 40
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#3c6e3b17">3c6e3b17</a> -         basisNGauss = 3</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#71c02d8d">71c02d8d</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#71c02d8d">71c02d8d</a> +         # Use specializations for deconvolution</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#71c02d8d">71c02d8d</a> +         basisNGauss = config.alardNGaussDeconv</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#71c02d8d">71c02d8d</a> +         basisMinSigma = config.alardMinSigDeconv</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#71c02d8d">71c02d8d</a> + </div>
                        kernelSigma = np.sqrt(targetSigma**2 - referenceSigma**2)
                        if kernelSigma < basisMinSigma:
                            kernelSigma = basisMinSigma
                
                        basisSigmaGauss = []
                        if (kernelSigma/basisGaussBeta) > basisMinSigma:
                            basisSigmaGauss.append(kernelSigma/basisGaussBeta)
                            basisSigmaGauss.append(kernelSigma)
                            nAppended = 2
                        else:
                            basisSigmaGauss.append(kernelSigma)
                            nAppended = 1
                
                        for i in range(nAppended,basisNGauss):
                            basisSigmaGauss.append(basisSigmaGauss[-1]*basisGaussBeta)
                
                        kernelSize  = int(fwhmScaling * basisSigmaGauss[-1])
                        kernelSize += 0 if kernelSize%2 else 1 # Make sure it's odd
                        kernelSize  = min(config.kernelSizeMax, max(kernelSize, config.kernelSizeMin))
                
                        # Now build a deconvolution set from these sigmas
                        sig0 = basisSigmaGauss[0]
                        sig1 = basisSigmaGauss[1]
                        sig2 = basisSigmaGauss[2]
                        basisSigmaGauss = []
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#906178a2">906178a2</a> -         for n in range(3):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#71c02d8d">71c02d8d</a> +         for n in range(1, 3):</div>
              ?                        +++
                            for j in range(n):
                                sigma2jn  = (n - j) * sig1**2
                                sigma2jn += j * sig2**2
                                sigma2jn -= (n + 1) * sig0**2
                                sigmajn   = np.sqrt(sigma2jn)
                                basisSigmaGauss.append(sigmajn)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#71c02d8d">71c02d8d</a> + </div>
                        basisSigmaGauss.sort()
                        basisNGauss = len(basisSigmaGauss)
                        basisDegGauss = [config.alardDegGaussDeconv for x in basisSigmaGauss]
                
                    if metadata is not None:
                        metadata.add("ALBasisNGauss", basisNGauss)
                        metadata.add("ALBasisDegGauss", basisDegGauss)
                        metadata.add("ALBasisSigGauss", basisSigmaGauss)
                        metadata.add("ALKernelSize", kernelSize)
                
                    return diffimLib.makeAlardLuptonBasisList(kernelSize//2, basisNGauss, basisSigmaGauss, basisDegGauss)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="906178a2"/></a>906178a2</h3>

<pre>
commit 906178a2e55f5835437ac1bc5f2af058f24591de
Author: Andy Becker <acbecker@gmail.com>
Date:   Thu Feb 2 17:39:51 2012 -0800

    Switchover to pex_config mostly implemented but not tested.  Moving fitting loop into Python for easier debugging.
</pre>
<h3><a name="3c6e3b17"/></a>3c6e3b17</h3>

<pre>
commit 3c6e3b171e276226d9832eec500f6bfc0700d9f0
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Oct 23 15:35:53 2013 -0700

    Addressed all ticket comments from Paul and Serge.  Will build and run unit tests next.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="71c02d8d"/></a>71c02d8d</h3>

<pre>
commit 71c02d8d5ae64db2a15225f1fd62d07f47405d44
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Feb 11 17:08:10 2014 -0600

    Work on ticket #3143 to allow for a slightly different configuration of a deconvolution kernel, compared to a smoothing kernel
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_104"><a name="tests/ipDiffimConfig.py"/></a>tests/ipDiffimConfig.py</h1>

<h3 id="toc_105">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import unittest
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#966eaa96">966eaa96</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#af09df2c">af09df2c</a> - import eups</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#af09df2c">af09df2c</a> - import os</div>
                import lsst.utils.tests as tests
                import lsst.ip.diffim as ipDiffim
                
                class DiffimTestCases(unittest.TestCase):
                    def setUp(self):
                        pass
                
                    def tearDown(self):
                        pass
                
                    def testDiaSourceAnalystConfig(self):
                        config = ipDiffim.DiaSourceAnalystConfig()
                        config.validate()
                
                    def testImagePsfMatchConfig(self):
                        config = ipDiffim.ImagePsfMatchConfig()
                        config.validate()
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#966eaa96">966eaa96</a> +     def testSnapPsfMatchConfig(self):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#966eaa96">966eaa96</a> +         config = ipDiffim.SnapPsfMatchConfig()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#966eaa96">966eaa96</a> +         config.validate()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#966eaa96">966eaa96</a> + </div>
                    def testSnapPsfMatchConfigDF(self):
                        config = ipDiffim.SnapPsfMatchConfigDF()
                        config.validate()
                
                    def testSnapPsfMatchConfigAL(self):
                        config = ipDiffim.SnapPsfMatchConfigAL()
                        config.validate()
                
                    def testModelPsfMatchConfig(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#32bc3a37">32bc3a37</a> -         config = ipDiffim.ModelPsfMatchConfig()</div>
              ?        ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#966eaa96">966eaa96</a> +         ipDiffim.ModelPsfMatchConfig()</div>
                
                    def testDetectionConfig(self):
                        config = ipDiffim.DetectionConfig()
                        config.fpGrowPix = 10
                        config.validate()
                
                    #
                
                    def testPsfMatchConfig(self):
                        config = ipDiffim.PsfMatchConfig()
                        config.validate()
                
                    def testPsfMatchConfigAL(self):
                        config = ipDiffim.PsfMatchConfigAL()
                        config.validate()
                
                    def testPsfMatchConfigDF(self):
                        config = ipDiffim.PsfMatchConfigDF()
                        config.validate()
                
                    #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#9a8b565a">9a8b565a</a> -     def testSnapPsfMatchConfig(self):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#9a8b565a">9a8b565a</a> -         config = ipDiffim.SnapPsfMatchConfig()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#9a8b565a">9a8b565a</a> -         config.validate()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#9a8b565a">9a8b565a</a> -     def testSnapPsfMatchConfigAL(self):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#9a8b565a">9a8b565a</a> -         config = ipDiffim.SnapPsfMatchConfigAL()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#9a8b565a">9a8b565a</a> -         config.validate()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#9a8b565a">9a8b565a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#9a8b565a">9a8b565a</a> -     def testSnapPsfMatchConfigDF(self):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#9a8b565a">9a8b565a</a> -         config = ipDiffim.SnapPsfMatchConfigDF()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#9a8b565a">9a8b565a</a> -         config.validate()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#9a8b565a">9a8b565a</a> - </div>
                #####
                        
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DiffimTestCases)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(doExit=False):
                    """Run the tests"""
                    tests.run(suite(), doExit)
                
                if __name__ == "__main__":
                    run(True)
                    
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="9a8b565a"/></a>9a8b565a</h3>

<pre>
commit 9a8b565a2257570cc7c685089f89b480a4911342
Author: Andy Becker <acbecker@gmail.com>
Date:   Wed Feb 22 10:49:09 2012 -0800

    Config uses registries now.
</pre>
<h3><a name="af09df2c"/></a>af09df2c</h3>

<pre>
commit af09df2ca96b958fce3308dc38feb3eb0f5b2649
Author: becker <becker@git.lsstcorp.org>
Date:   Fri Nov 20 19:27:51 2009 +0000

    Additional minor unit tests.  #876.
</pre>
<h3><a name="32bc3a37"/></a>32bc3a37</h3>

<pre>
commit 32bc3a370c89b06e628e733ae98525321a624d59
Author: Andy Becker <acbecker@gmail.com>
Date:   Fri Feb 3 12:31:53 2012 -0800

    Additional changes to get the code to build, and unit tests run.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="966eaa96"/></a>966eaa96</h3>

<pre>
commit 966eaa96a14595be24402eec120357ba4642166e
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Mar 10 16:12:56 2015 -0700

    Tweaks to make pyflakes happy and remove bare except:
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_106"><a name="src/KernelSolution.cc"/></a>src/KernelSolution.cc</h1>

<h3 id="toc_107">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                /**
                 * @file KernelSolution.cc
                 *
                 * @brief Implementation of KernelSolution class
                 *
                 * @author Andrew Becker, University of Washington
                 *
                 * @ingroup ip_diffim
                 */
                #include <iterator>
                #include <cmath>
                #include <algorithm>
                #include <limits>
                
                #include "boost/shared_ptr.hpp"
                #include "boost/timer.hpp" 
                
                #include "Eigen/Core"
                #include "Eigen/Cholesky"
                #include "Eigen/QR"
                #include "Eigen/LU"
                #include "Eigen/Eigenvalues"
                #include "Eigen/SVD"
                
                #include "lsst/afw/math.h"
                #include "lsst/afw/geom.h"
                #include "lsst/afw/image.h"
                #include "lsst/afw/detection.h"
                #include "lsst/afw/detection/FootprintArray.cc"
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                
                #include "lsst/ip/diffim/ImageSubtract.h"
                #include "lsst/ip/diffim/KernelSolution.h"
                
                #include "ndarray.h"
                #include "ndarray/eigen.h"
                
                #define DEBUG_MATRIX  0
                #define DEBUG_MATRIX2 0
                
                namespace afwDet         = lsst::afw::detection;
                namespace afwMath        = lsst::afw::math;
                namespace afwGeom        = lsst::afw::geom;
                namespace afwImage       = lsst::afw::image;
                namespace pexLog         = lsst::pex::logging; 
                namespace pexExcept      = lsst::pex::exceptions;
                
                namespace lsst { 
                namespace ip { 
                namespace diffim {
                    
                    /* Unique identifier for solution */
                    int KernelSolution::_SolutionId = 0;
                
                    KernelSolution::KernelSolution(
                        boost::shared_ptr<Eigen::MatrixXd> mMat,
                        boost::shared_ptr<Eigen::VectorXd> bVec,
                        bool fitForBackground
                        ) :
                        _id(++_SolutionId),
                        _mMat(mMat),
                        _bVec(bVec),
                        _aVec(),
                        _solvedBy(NONE),
                        _fitForBackground(fitForBackground)
                    {};
                
                    KernelSolution::KernelSolution(
                        bool fitForBackground
                        ) :
                        _id(++_SolutionId),
                        _mMat(),
                        _bVec(),
                        _aVec(),
                        _solvedBy(NONE),
                        _fitForBackground(fitForBackground)
                    {};
                
                    KernelSolution::KernelSolution() :
                        _id(++_SolutionId),
                        _mMat(),
                        _bVec(),
                        _aVec(),
                        _solvedBy(NONE),
                        _fitForBackground(true)
                    {};
                
                    void KernelSolution::solve() {
                        solve(*_mMat, *_bVec);
                    }
                
                    double KernelSolution::getConditionNumber(ConditionNumberType conditionType) {
                        return getConditionNumber(*_mMat, conditionType);
                    }
                
                    double KernelSolution::getConditionNumber(Eigen::MatrixXd mMat, 
                                                              ConditionNumberType conditionType) {
                        switch (conditionType) {
                        case EIGENVALUE: 
                            {
                            Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> eVecValues(mMat);
                            Eigen::VectorXd eValues = eVecValues.eigenvalues();
                            double eMax = eValues.maxCoeff();
                            double eMin = eValues.minCoeff();
                            pexLog::TTrace<5>("lsst.ip.diffim.KernelSolution.getConditionNumber", 
                                              "EIGENVALUE eMax / eMin = %.3e", eMax / eMin);
                            return (eMax / eMin);
                            break;
                            }
                        case SVD: 
                            {
                            Eigen::VectorXd sValues = mMat.jacobiSvd().singularValues();
                            double sMax = sValues.maxCoeff();
                            double sMin = sValues.minCoeff();
                            pexLog::TTrace<5>("lsst.ip.diffim.KernelSolution.getConditionNumber", 
                                              "SVD eMax / eMin = %.3e", sMax / sMin);
                            return (sMax / sMin);
                            break;
                            }
                        default:
                            {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#1707c6fa">1707c6fa</a> -             throw LSST_EXCEPT(pexExcept::InvalidParameterException,</div>
              ?                                                           ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#7d3a88f7">7d3a88f7</a> +             throw LSST_EXCEPT(pexExcept::InvalidParameterError,</div>
              ?                                                           ^^ ^
                                              "Undefined ConditionNumberType : only EIGENVALUE, SVD allowed.");
                            break;
                            }
                        }
                    }
                
                    void KernelSolution::solve(Eigen::MatrixXd mMat,
                                               Eigen::VectorXd bVec) {
                        
                        if (DEBUG_MATRIX) {
                            std::cout << "M " << std::endl;
                            std::cout << mMat << std::endl;
                            std::cout << "B " << std::endl;
                            std::cout << bVec << std::endl;
                        }
                
                        Eigen::VectorXd aVec = Eigen::VectorXd::Zero(bVec.size());
                
                        boost::timer t;
                        t.restart();
                
                        pexLog::TTrace<4>("lsst.ip.difim.KernelSolution.solve", 
                                          "Solving for kernel");
                        _solvedBy = LU;
                        Eigen::FullPivLU<Eigen::MatrixXd> lu(mMat);
                        if (lu.isInvertible()) {
                            aVec = lu.solve(bVec);
                        } else {
                            pexLog::TTrace<5>("lsst.ip.diffim.KernelSolution.solve", 
                                              "Unable to determine kernel via LU");
                            /* LAST RESORT */
                            try {
                                
                                _solvedBy = EIGENVECTOR;
                                Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> eVecValues(mMat);
                                Eigen::MatrixXd const& rMat = eVecValues.eigenvectors();
                                Eigen::VectorXd eValues = eVecValues.eigenvalues();
                                
                                for (int i = 0; i != eValues.rows(); ++i) {
                                    if (eValues(i) != 0.0) {
                                        eValues(i) = 1.0/eValues(i);
                                    }
                                }
                                
                                aVec = rMat * eValues.asDiagonal() * rMat.transpose() * bVec;
                            } catch (pexExcept::Exception& e) {
                                
                                _solvedBy = NONE;
                                pexLog::TTrace<5>("lsst.ip.diffim.KernelSolution.solve", 
                                                  "Unable to determine kernel via eigen-values");
                                
                                throw LSST_EXCEPT(pexExcept::Exception, "Unable to determine kernel solution");
                            }
                        }
                
                        double time = t.elapsed();
                        pexLog::TTrace<5>("lsst.ip.diffim.KernelSolution.solve", 
                                          "Compute time for matrix math : %.2f s", time);
                
                        if (DEBUG_MATRIX) {
                          std::cout << "A " << std::endl;
                            std::cout << aVec << std::endl;
                        }
                        
                        _aVec = boost::shared_ptr<Eigen::VectorXd>(new Eigen::VectorXd(aVec));
                    }
                
                    /*******************************************************************************************************/
                
                    template <typename InputT>
                    StaticKernelSolution<InputT>::StaticKernelSolution(
                        lsst::afw::math::KernelList const& basisList,
                        bool fitForBackground
                        ) 
                        :
                        KernelSolution(fitForBackground),
                        _cMat(),
                        _iVec(),
                        _ivVec(),
                        _kernel(),
                        _background(0.0),
                        _kSum(0.0)
                    {
                        std::vector<double> kValues(basisList.size());
                        _kernel = boost::shared_ptr<afwMath::Kernel>( 
                            new afwMath::LinearCombinationKernel(basisList, kValues) 
                            );
                    };
                
                    template <typename InputT>
                    lsst::afw::math::Kernel::Ptr StaticKernelSolution<InputT>::getKernel() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return solution");
                        }
                        return _kernel;
                    }
                
                    template <typename InputT>
                    lsst::afw::image::Image<lsst::afw::math::Kernel::Pixel>::Ptr StaticKernelSolution<InputT>::makeKernelImage() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return image");
                        }
                        afwImage::Image<afwMath::Kernel::Pixel>::Ptr image(
                            new afwImage::Image<afwMath::Kernel::Pixel>(_kernel->getDimensions())
                            );
                        (void)_kernel->computeImage(*image, false);              
                        return image;
                    }
                
                    template <typename InputT>
                    double StaticKernelSolution<InputT>::getBackground() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return background");
                        }
                        return _background;
                    }
                
                    template <typename InputT>
                    double StaticKernelSolution<InputT>::getKsum() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return ksum");
                        }
                        return _kSum;
                    }
                
                    template <typename InputT>
                    std::pair<boost::shared_ptr<lsst::afw::math::Kernel>, double>
                    StaticKernelSolution<InputT>::getSolutionPair() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return solution");
                        }
                
                        return std::make_pair(_kernel, _background);
                    }
                
                    template <typename InputT>
                    void StaticKernelSolution<InputT>::build(
                        lsst::afw::image::Image<InputT> const &templateImage,
                        lsst::afw::image::Image<InputT> const &scienceImage,
                        lsst::afw::image::Image<lsst::afw::image::VariancePixel> const &varianceEstimate
                        ) {
                
                        afwMath::Statistics varStats = afwMath::makeStatistics(varianceEstimate, afwMath::MIN);
                        if (varStats.getValue(afwMath::MIN) < 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance less than 0.0");
                        }
                        if (varStats.getValue(afwMath::MIN) == 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance equals 0.0, cannot inverse variance weight");
                        }
                
                        lsst::afw::math::KernelList basisList = 
                            boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(_kernel)->getKernelList();
                        
                        unsigned int const nKernelParameters     = basisList.size();
                        unsigned int const nBackgroundParameters = _fitForBackground ? 1 : 0;
                        unsigned int const nParameters           = nKernelParameters + nBackgroundParameters;
                
                        std::vector<boost::shared_ptr<afwMath::Kernel> >::const_iterator kiter = basisList.begin();
                        
                        /* Ignore buffers around edge of convolved images :
                         * 
                         * If the kernel has width 5, it has center pixel 2.  The first good pixel
                         * is the (5-2)=3rd pixel, which is array index 2, and ends up being the
                         * index of the central pixel.
                         * 
                         * You also have a buffer of unusable pixels on the other side, numbered
                         * width-center-1.  The last good usable pixel is N-width+center+1.
                         * 
                         * Example : the kernel is width = 5, center = 2
                         * 
                         * ---|---|-c-|---|---|
                         * 
                         * the image is width = N
                         * convolve this with the kernel, and you get
                         * 
                         * |-x-|-x-|-g-|---|---| ... |---|---|-g-|-x-|-x-|
                         * 
                         * g = first/last good pixel
                         * x = bad
                         * 
                         * the first good pixel is the array index that has the value "center", 2
                         * the last good pixel has array index N-(5-2)+1
                         * eg. if N = 100, you want to use up to index 97
                         * 100-3+1 = 98, and the loops use i < 98, meaning the last
                         * index you address is 97.
                         */
                
                        /* NOTE - we are accessing particular elements of Eigen arrays using
                           these coordinates, therefore they need to be in LOCAL coordinates.
                           This was written before ndarray unification.
                        */
                        afwGeom::Box2I goodBBox = (*kiter)->shrinkBBox(templateImage.getBBox(afwImage::LOCAL));
                        unsigned int const startCol = goodBBox.getMinX();
                        unsigned int const startRow = goodBBox.getMinY();
                        // endCol/Row is one past the index of the last good col/row
                        unsigned int endCol = goodBBox.getMaxX() + 1;
                        unsigned int endRow = goodBBox.getMaxY() + 1;
                
                        boost::timer t;
                        t.restart();
                        
                        /* Eigen representation of input images; only the pixels that are unconvolved in cimage below */
                        Eigen::MatrixXd eigenTemplate = imageToEigenMatrix(templateImage).block(startRow, 
                                                                                                startCol, 
                                                                                                endRow-startRow, 
                                                                                                endCol-startCol);
                        Eigen::MatrixXd eigenScience = imageToEigenMatrix(scienceImage).block(startRow, 
                                                                                              startCol, 
                                                                                              endRow-startRow, 
                                                                                              endCol-startCol);
                        Eigen::MatrixXd eigeniVariance = imageToEigenMatrix(varianceEstimate).block(
                        startRow, startCol, endRow-startRow, endCol-startCol
                    ).array().inverse().matrix();
                
                        /* Resize into 1-D for later usage */
                        eigenTemplate.resize(eigenTemplate.rows()*eigenTemplate.cols(), 1);
                        eigenScience.resize(eigenScience.rows()*eigenScience.cols(), 1);
                        eigeniVariance.resize(eigeniVariance.rows()*eigeniVariance.cols(), 1);
                        
                        /* Holds image convolved with basis function */
                        afwImage::Image<PixelT> cimage(templateImage.getDimensions());
                        
                        /* Holds eigen representation of image convolved with all basis functions */
                        std::vector<boost::shared_ptr<Eigen::MatrixXd> > convolvedEigenList(nKernelParameters);
                        
                        /* Iterators over convolved image list and basis list */
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiter = 
                            convolvedEigenList.begin();
                        /* Create C_i in the formalism of Alard & Lupton */
                        for (kiter = basisList.begin(); kiter != basisList.end(); ++kiter, ++eiter) {
                            afwMath::convolve(cimage, templateImage, **kiter, false); /* cimage stores convolved image */
                
                            boost::shared_ptr<Eigen::MatrixXd> cMat (
                                new Eigen::MatrixXd(imageToEigenMatrix(cimage).block(startRow, 
                                                                                     startCol, 
                                                                                     endRow-startRow, 
                                                                                     endCol-startCol))
                                );
                            cMat->resize(cMat->rows()*cMat->cols(), 1);
                            *eiter = cMat;
                
                        } 
                
                        double time = t.elapsed();
                        pexLog::TTrace<5>("lsst.ip.diffim.StaticKernelSolution.build", 
                                          "Total compute time to do basis convolutions : %.2f s", time);
                        t.restart();
                        
                        /* 
                           Load matrix with all values from convolvedEigenList : all images
                           (eigeniVariance, convolvedEigenList) must be the same size
                        */
                        Eigen::MatrixXd cMat(eigenTemplate.col(0).size(), nParameters);
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterj = 
                            convolvedEigenList.begin();
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterE = 
                            convolvedEigenList.end();
                        for (unsigned int kidxj = 0; eiterj != eiterE; eiterj++, kidxj++) {
                            cMat.col(kidxj) = (*eiterj)->col(0);
                        }
                        /* Treat the last "image" as all 1's to do the background calculation. */
                        if (_fitForBackground)
                            cMat.col(nParameters-1).fill(1.);
                
                        _cMat.reset(new Eigen::MatrixXd(cMat));
                        _ivVec.reset(new Eigen::VectorXd(eigeniVariance.col(0)));
                        _iVec.reset(new Eigen::VectorXd(eigenScience.col(0)));
                
                        /* Make these outside of solve() so I can check condition number */
                        _mMat.reset(new Eigen::MatrixXd((*_cMat).transpose() * ((*_ivVec).asDiagonal() * (*_cMat))));
                        _bVec.reset(new Eigen::VectorXd((*_cMat).transpose() * ((*_ivVec).asDiagonal() * (*_iVec))));
                    }
                
                    template <typename InputT>
                    void StaticKernelSolution<InputT>::solve() {
                        pexLog::TTrace<5>("lsst.ip.diffim.StaticKernelSolution.solve", 
                                          "mMat is %d x %d; bVec is %d; cMat is %d x %d; vVec is %d; iVec is %d", 
                                          (*_mMat).rows(), (*_mMat).cols(), (*_bVec).size(),
                                          (*_cMat).rows(), (*_cMat).cols(), (*_ivVec).size(), (*_iVec).size());
                
                        /* If I put this here I can't check for condition number before solving */
                        /*
                        _mMat.reset(new Eigen::MatrixXd((*_cMat).transpose() * ((*_ivVec).asDiagonal() * (*_cMat))));
                        _bVec.reset(new Eigen::VectorXd((*_cMat).transpose() * ((*_ivVec).asDiagonal() * (*_iVec))));
                        */
                
                        if (DEBUG_MATRIX) {
                            std::cout << "C" << std::endl;
                            std::cout << (*_cMat) << std::endl;
                            std::cout << "iV" << std::endl;
                            std::cout << (*_ivVec) << std::endl;
                            std::cout << "I" << std::endl;
                            std::cout << (*_iVec) << std::endl;
                        }
                
                        try {
                            KernelSolution::solve();
                        } catch (pexExcept::Exception &e) {
                            LSST_EXCEPT_ADD(e, "Unable to solve static kernel matrix");
                            throw e;
                        }
                        /* Turn matrices into _kernel and _background */
                        _setKernel();
                    }
                
                    template <typename InputT>
                    void StaticKernelSolution<InputT>::_setKernel() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot make solution");
                        }
                
                        unsigned int const nParameters           = _aVec->size();
                        unsigned int const nBackgroundParameters = _fitForBackground ? 1 : 0;
                        unsigned int const nKernelParameters     = 
                            boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(_kernel)->getKernelList().size();
                        if (nParameters != (nKernelParameters + nBackgroundParameters)) 
                            throw LSST_EXCEPT(pexExcept::Exception, "Mismatched sizes in kernel solution");
                
                        /* Fill in the kernel results */
                        std::vector<double> kValues(nKernelParameters);
                        for (unsigned int idx = 0; idx < nKernelParameters; idx++) {
                            if (std::isnan((*_aVec)(idx))) {
                                throw LSST_EXCEPT(pexExcept::Exception, 
                                                  str(boost::format("Unable to determine kernel solution %d (nan)") % idx));
                            }
                            kValues[idx] = (*_aVec)(idx);
                        }
                        _kernel->setKernelParameters(kValues);
                
                        ImageT::Ptr image (
                            new ImageT(_kernel->getDimensions())
                            );
                        _kSum  = _kernel->computeImage(*image, false);              
                        
                        if (_fitForBackground) {
                            if (std::isnan((*_aVec)(nParameters-1))) {
                                throw LSST_EXCEPT(pexExcept::Exception, 
                                                  str(boost::format("Unable to determine background solution %d (nan)") % 
                                                      (nParameters-1)));
                            }
                            _background = (*_aVec)(nParameters-1);
                        }
                    }        
                
                
                    template <typename InputT>
                    void StaticKernelSolution<InputT>::_setKernelUncertainty() {
                        throw LSST_EXCEPT(pexExcept::Exception, "Uncertainty calculation not supported");
                
                        /* Estimate of parameter uncertainties comes from the inverse of the
                         * covariance matrix (noise spectrum).  
                         * N.R. 15.4.8 to 15.4.15
                         * 
                         * Since this is a linear problem no need to use Fisher matrix
                         * N.R. 15.5.8
                         *
                         * Although I might be able to take advantage of the solution above.
                         * Since this now works and is not the rate limiting step, keep as-is for DC3a.
                         *
                         * Use Cholesky decomposition again.
                         * Cholkesy:
                         * Cov       =  L L^t
                         * Cov^(-1)  = (L L^t)^(-1)
                         *           = (L^T)^-1 L^(-1)
                         * 
                         * Code would be:
                         * 
                         * Eigen::MatrixXd             cov    = (*_mMat).transpose() * (*_mMat);
                         * Eigen::LLT<Eigen::MatrixXd> llt    = cov.llt();
                         * Eigen::MatrixXd             error2 = llt.matrixL().transpose().inverse()*llt.matrixL().inverse();
                         */
                    }
                
                    /*******************************************************************************************************/
                
                    template <typename InputT>
                    MaskedKernelSolution<InputT>::MaskedKernelSolution(
                        lsst::afw::math::KernelList const& basisList,
                        bool fitForBackground
                        ) :
                        StaticKernelSolution<InputT>(basisList, fitForBackground)
                    {};
                
                    template <typename InputT>
                    void MaskedKernelSolution<InputT>::buildWithMask(
                        lsst::afw::image::Image<InputT> const &templateImage,
                        lsst::afw::image::Image<InputT> const &scienceImage,
                        lsst::afw::image::Image<lsst::afw::image::VariancePixel> const &varianceEstimate,
                        lsst::afw::image::Mask<lsst::afw::image::MaskPixel> const &pixelMask
                        ) {
                
                        afwMath::Statistics varStats = afwMath::makeStatistics(varianceEstimate, afwMath::MIN);
                        if (varStats.getValue(afwMath::MIN) < 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance less than 0.0");
                        }
                        if (varStats.getValue(afwMath::MIN) == 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance equals 0.0, cannot inverse variance weight");
                        }
                
                        /* Full footprint of all input images */
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
529  <a href="#ec2f65f1">ec2f65f1</a> -         afwDet::Footprint::Ptr fullFp(new afwDet::Footprint(templateImage.getBBox(afwImage::PARENT)));</div>
              ?                                                                                   ----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
529  <a href="#9250fe88">9250fe88</a> +         afwDet::Footprint::Ptr fullFp(new afwDet::Footprint(templateImage.getBBox()));</div>
                
                        afwMath::KernelList basisList = 
                            boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(this->_kernel)->getKernelList();
                        std::vector<boost::shared_ptr<afwMath::Kernel> >::const_iterator kiter = basisList.begin();
                
                        /* Only BAD pixels marked in this mask */
                        afwImage::MaskPixel bitMask = 
                            (afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("BAD") | 
                             afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("SAT") |
                             afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("EDGE"));
                
                        /* Create a Footprint that contains all the masked pixels set above */
                        afwDet::Threshold threshold = afwDet::Threshold(bitMask, afwDet::Threshold::BITMASK, true);
                        afwDet::FootprintSet maskFpSet(pixelMask, threshold, true);
                
                        /* And spread it by the kernel half width */
                        int growPix = (*kiter)->getCtr().getX();
                        afwDet::FootprintSet maskedFpSetGrown(maskFpSet, growPix, true);
                        
                #if 0
                        for (typename afwDet::FootprintSet::FootprintList::iterator 
                                 ptr = maskedFpSetGrown.getFootprints()->begin(),
                                 end = maskedFpSetGrown.getFootprints()->end(); 
                             ptr != end; 
                             ++ptr) {
                            
                            afwDet::setMaskFromFootprint(finalMask, 
                                                         (**ptr),
                                                         afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("BAD"));
                        }
                #endif
                
                        afwImage::Mask<afwImage::MaskPixel> finalMask(pixelMask.getDimensions());
                        afwDet::setMaskFromFootprintList(&finalMask, 
                                                         *(maskedFpSetGrown.getFootprints()),
                                                         afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("BAD"));
                        pixelMask.writeFits("pixelmask.fits");
                        finalMask.writeFits("finalmask.fits");
                
                
                        ndarray::Array<int, 1, 1> maskArray = 
                            ndarray::allocate(ndarray::makeVector(fullFp->getArea()));
                        afwDet::flattenArray(*fullFp, finalMask.getArray(), 
                                             maskArray, templateImage.getXY0()); /* Need to fake the XY0 */
                        ndarray::EigenView<int, 1, 1> maskEigen(maskArray);
                
                        ndarray::Array<InputT, 1, 1> arrayTemplate = 
                            ndarray::allocate(ndarray::makeVector(fullFp->getArea()));
                        afwDet::flattenArray(*fullFp, templateImage.getArray(), 
                                             arrayTemplate, templateImage.getXY0());
                        ndarray::EigenView<InputT, 1, 1> eigenTemplate0(arrayTemplate);
                
                        ndarray::Array<InputT, 1, 1> arrayScience = 
                            ndarray::allocate(ndarray::makeVector(fullFp->getArea()));
                        afwDet::flattenArray(*fullFp, scienceImage.getArray(), 
                                             arrayScience, scienceImage.getXY0());
                        ndarray::EigenView<InputT, 1, 1> eigenScience0(arrayScience);
                
                        ndarray::Array<afwImage::VariancePixel, 1, 1> arrayVariance = 
                            ndarray::allocate(ndarray::makeVector(fullFp->getArea()));
                        afwDet::flattenArray(*fullFp, varianceEstimate.getArray(), 
                                             arrayVariance, varianceEstimate.getXY0());
                        ndarray::EigenView<afwImage::VariancePixel, 1, 1> eigenVariance0(arrayVariance);
                
                        int nGood = 0;
                        for (int i = 0; i < maskEigen.size(); i++) {
                            if (maskEigen(i) == 0.0)
                                nGood += 1;
                        }
                
                        Eigen::VectorXd eigenTemplate(nGood);
                        Eigen::VectorXd eigenScience(nGood);
                        Eigen::VectorXd eigenVariance(nGood);
                        int nUsed = 0;
                        for (int i = 0; i < maskEigen.size(); i++) {
                            if (maskEigen(i) == 0.0) {
                                eigenTemplate(nUsed) = eigenTemplate0(i);
                                eigenScience(nUsed) = eigenScience0(i);
                                eigenVariance(nUsed) = eigenVariance0(i);
                                nUsed += 1;
                            }
                        }
                
                
                        boost::timer t;
                        t.restart();
                
                        unsigned int const nKernelParameters     = basisList.size();
                        unsigned int const nBackgroundParameters = this->_fitForBackground ? 1 : 0;
                        unsigned int const nParameters           = nKernelParameters + nBackgroundParameters;
                
                        /* Holds image convolved with basis function */
                        afwImage::Image<InputT> cimage(templateImage.getDimensions());
                        
                        /* Holds eigen representation of image convolved with all basis functions */
                        std::vector<boost::shared_ptr<Eigen::VectorXd> >
                            convolvedEigenList(nKernelParameters);
                        
                        /* Iterators over convolved image list and basis list */
                        typename std::vector<boost::shared_ptr<Eigen::VectorXd> >::iterator eiter = 
                            convolvedEigenList.begin();
                
                        /* Create C_i in the formalism of Alard & Lupton */
                        for (kiter = basisList.begin(); kiter != basisList.end(); ++kiter, ++eiter) {
                            afwMath::convolve(cimage, templateImage, **kiter, false); /* cimage stores convolved image */
                
                            ndarray::Array<InputT, 1, 1> arrayC = 
                                ndarray::allocate(ndarray::makeVector(fullFp->getArea()));
                            afwDet::flattenArray(*fullFp, cimage.getArray(), 
                                                 arrayC, cimage.getXY0());
                            ndarray::EigenView<InputT, 1, 1> eigenC0(arrayC);
                
                            Eigen::VectorXd eigenC(nGood);
                            int nUsed = 0;
                            for (int i = 0; i < maskEigen.size(); i++) {
                                if (maskEigen(i) == 0.0) {
                                    eigenC(nUsed) = eigenC0(i);
                                    nUsed += 1;
                                }
                            }
                
                            boost::shared_ptr<Eigen::VectorXd> 
                                eigenCptr (new Eigen::VectorXd(eigenC));
                            
                            *eiter = eigenCptr;
                        }
                        double time = t.elapsed();
                        pexLog::TTrace<5>("lsst.ip.diffim.StaticKernelSolution.buildWithMask", 
                                          "Total compute time to do basis convolutions : %.2f s", time);
                        t.restart();
                        
                        /* Load matrix with all convolved images */
                        Eigen::MatrixXd cMat(eigenTemplate.size(), nParameters);
                        typename std::vector<boost::shared_ptr<Eigen::VectorXd> >::iterator eiterj = 
                            convolvedEigenList.begin();
                        typename std::vector<boost::shared_ptr<Eigen::VectorXd> >::iterator eiterE = 
                            convolvedEigenList.end();
                        for (unsigned int kidxj = 0; eiterj != eiterE; eiterj++, kidxj++) {
                            cMat.block(0, kidxj, eigenTemplate.size(), 1) = 
                                Eigen::MatrixXd(**eiterj).block(0, 0, eigenTemplate.size(), 1);
                        }
                        /* Treat the last "image" as all 1's to do the background calculation. */
                        if (this->_fitForBackground)
                            cMat.col(nParameters-1).fill(1.);
                        
                        this->_cMat.reset(new Eigen::MatrixXd(cMat));
                        //this->_ivVec.reset(new Eigen::VectorXd((eigenVariance.template cast<double>()).cwise().inverse()));
                        //this->_iVec.reset(new Eigen::VectorXd(eigenScience.template cast<double>()));
                        this->_ivVec.reset(new Eigen::VectorXd(eigenVariance.array().inverse().matrix()));
                        this->_iVec.reset(new Eigen::VectorXd(eigenScience));
                
                        /* Make these outside of solve() so I can check condition number */
                        this->_mMat.reset(
                            new Eigen::MatrixXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_cMat))
                            );
                        this->_bVec.reset(
                            new Eigen::VectorXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_iVec))
                            );
                    }
                
                
                    template <typename InputT>
                    void MaskedKernelSolution<InputT>::buildOrig(
                        lsst::afw::image::Image<InputT> const &templateImage,
                        lsst::afw::image::Image<InputT> const &scienceImage,
                        lsst::afw::image::Image<lsst::afw::image::VariancePixel> const &varianceEstimate,
                        lsst::afw::image::Mask<lsst::afw::image::MaskPixel> pixelMask
                        ) {
                
                        afwMath::Statistics varStats = afwMath::makeStatistics(varianceEstimate, afwMath::MIN);
                        if (varStats.getValue(afwMath::MIN) < 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance less than 0.0");
                        }
                        if (varStats.getValue(afwMath::MIN) == 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance equals 0.0, cannot inverse variance weight");
                        }
                
                        lsst::afw::math::KernelList basisList = 
                            boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(this->_kernel)->getKernelList();
                        std::vector<boost::shared_ptr<afwMath::Kernel> >::const_iterator kiter = basisList.begin();
                
                        /* Only BAD pixels marked in this mask */
                        lsst::afw::image::Mask<lsst::afw::image::MaskPixel> sMask(pixelMask, true);
                        afwImage::MaskPixel bitMask = 
                            (afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("BAD") | 
                             afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("SAT") |
                             afwImage::Mask<afwImage::MaskPixel>::getPlaneBitMask("EDGE"));
                        sMask &= bitMask;
                        /* TBD: Need to figure out a way to spread this; currently done in Python */
                
                        unsigned int const nKernelParameters     = basisList.size();
                        unsigned int const nBackgroundParameters = this->_fitForBackground ? 1 : 0;
                        unsigned int const nParameters           = nKernelParameters + nBackgroundParameters;
                
                        /* NOTE - we are accessing particular elements of Eigen arrays using
                           these coordinates, therefore they need to be in LOCAL coordinates.
                           This was written before ndarray unification.
                        */
                        /* Ignore known EDGE pixels for speed */
                        afwGeom::Box2I shrunkLocalBBox = (*kiter)->shrinkBBox(templateImage.getBBox(afwImage::LOCAL));
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Limits of good pixels after convolution: %d,%d -> %d,%d (local)", 
                                          shrunkLocalBBox.getMinX(), shrunkLocalBBox.getMinY(), 
                                          shrunkLocalBBox.getMaxX(), shrunkLocalBBox.getMaxY());
                
                        /* Subimages are addressed in raw pixel coordinates */
                        unsigned int startCol = shrunkLocalBBox.getMinX();
                        unsigned int startRow = shrunkLocalBBox.getMinY();
                        unsigned int endCol   = shrunkLocalBBox.getMaxX();
                        unsigned int endRow   = shrunkLocalBBox.getMaxY();
                        /* Needed for Eigen block slicing operation */
                        endCol += 1;
                        endRow += 1;
                
                        boost::timer t;
                        t.restart();
                
                        /* Eigen representation of input images; only the pixels that are unconvolved in cimage below */
                        Eigen::MatrixXi eMask = maskToEigenMatrix(sMask).block(startRow, 
                                                                               startCol, 
                                                                               endRow-startRow, 
                                                                               endCol-startCol);
                
                        Eigen::MatrixXd eigenTemplate = imageToEigenMatrix(templateImage).block(startRow, 
                                                                                                startCol, 
                                                                                                endRow-startRow, 
                                                                                                endCol-startCol);
                        Eigen::MatrixXd eigenScience = imageToEigenMatrix(scienceImage).block(startRow, 
                                                                                              startCol, 
                                                                                              endRow-startRow, 
                                                                                              endCol-startCol);
                        Eigen::MatrixXd eigeniVariance = imageToEigenMatrix(varianceEstimate).block(
                        startRow, startCol, endRow-startRow, endCol-startCol
                    ).array().inverse().matrix();
                
                        /* Resize into 1-D for later usage */
                        eMask.resize(eMask.rows()*eMask.cols(), 1);
                        eigenTemplate.resize(eigenTemplate.rows()*eigenTemplate.cols(), 1);
                        eigenScience.resize(eigenScience.rows()*eigenScience.cols(), 1);
                        eigeniVariance.resize(eigeniVariance.rows()*eigeniVariance.cols(), 1);
                
                        /* Do the masking, slowly for now... */
                        Eigen::MatrixXd maskedEigenTemplate(eigenTemplate.rows(), 1);
                        Eigen::MatrixXd maskedEigenScience(eigenScience.rows(), 1);
                        Eigen::MatrixXd maskedEigeniVariance(eigeniVariance.rows(), 1);
                        int nGood = 0;
                        for (int i = 0; i < eMask.rows(); i++) {
                            if (eMask(i, 0) == 0) {
                                maskedEigenTemplate(nGood, 0) = eigenTemplate(i, 0);
                                maskedEigenScience(nGood, 0) = eigenScience(i, 0);
                                maskedEigeniVariance(nGood, 0) = eigeniVariance(i, 0);
                                nGood += 1;
                            }
                        }
                        /* Can't resize() since all values are lost; use blocks */
                        eigenTemplate    = maskedEigenTemplate.block(0, 0, nGood, 1);
                        eigenScience     = maskedEigenScience.block(0, 0, nGood, 1);
                        eigeniVariance   = maskedEigeniVariance.block(0, 0, nGood, 1);
                
                
                        /* Holds image convolved with basis function */
                        afwImage::Image<InputT> cimage(templateImage.getDimensions());
                        
                        /* Holds eigen representation of image convolved with all basis functions */
                        std::vector<boost::shared_ptr<Eigen::MatrixXd> > convolvedEigenList(nKernelParameters);
                        
                        /* Iterators over convolved image list and basis list */
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiter = 
                            convolvedEigenList.begin();
                        /* Create C_i in the formalism of Alard & Lupton */
                        for (kiter = basisList.begin(); kiter != basisList.end(); ++kiter, ++eiter) {
                            afwMath::convolve(cimage, templateImage, **kiter, false); /* cimage stores convolved image */
                            
                            Eigen::MatrixXd cMat = imageToEigenMatrix(cimage).block(startRow, 
                                                                                    startCol, 
                                                                                    endRow-startRow, 
                                                                                    endCol-startCol);
                            cMat.resize(cMat.rows() * cMat.cols(), 1);
                
                            /* Do masking */
                            Eigen::MatrixXd maskedcMat(cMat.rows(), 1);
                            int nGood = 0;
                            for (int i = 0; i < eMask.rows(); i++) {
                                if (eMask(i, 0) == 0) {
                                    maskedcMat(nGood, 0) = cMat(i, 0);
                                    nGood += 1;
                                }
                            }
                            cMat = maskedcMat.block(0, 0, nGood, 1);
                            boost::shared_ptr<Eigen::MatrixXd> cMatPtr (new Eigen::MatrixXd(cMat));
                            *eiter = cMatPtr;
                        } 
                
                        double time = t.elapsed();
                        pexLog::TTrace<5>("lsst.ip.diffim.StaticKernelSolution.build", 
                                          "Total compute time to do basis convolutions : %.2f s", time);
                        t.restart();
                        
                        /* 
                           Load matrix with all values from convolvedEigenList : all images
                           (eigeniVariance, convolvedEigenList) must be the same size
                        */
                        Eigen::MatrixXd cMat(eigenTemplate.col(0).size(), nParameters);
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterj = 
                            convolvedEigenList.begin();
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterE = 
                            convolvedEigenList.end();
                        for (unsigned int kidxj = 0; eiterj != eiterE; eiterj++, kidxj++) {
                            cMat.col(kidxj) = (*eiterj)->col(0);
                        }
                        /* Treat the last "image" as all 1's to do the background calculation. */
                        if (this->_fitForBackground)
                            cMat.col(nParameters-1).fill(1.);
                
                        this->_cMat.reset(new Eigen::MatrixXd(cMat));
                        this->_ivVec.reset(new Eigen::VectorXd(eigeniVariance.col(0)));
                        this->_iVec.reset(new Eigen::VectorXd(eigenScience.col(0)));
                
                        /* Make these outside of solve() so I can check condition number */
                        this->_mMat.reset(
                            new Eigen::MatrixXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_cMat))
                            );
                        this->_bVec.reset(
                            new Eigen::VectorXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_iVec))
                            );
                        
                    }
                
                    /* NOTE - this was written before the ndarray unification.  I am rewriting
                       buildSingleMask to use the ndarray stuff */
                    template <typename InputT>
                    void MaskedKernelSolution<InputT>::buildSingleMaskOrig(
                        lsst::afw::image::Image<InputT> const &templateImage,
                        lsst::afw::image::Image<InputT> const &scienceImage,
                        lsst::afw::image::Image<lsst::afw::image::VariancePixel> const &varianceEstimate,
                        lsst::afw::geom::Box2I maskBox
                        ) {
                
                        afwMath::Statistics varStats = afwMath::makeStatistics(varianceEstimate, afwMath::MIN);
                        if (varStats.getValue(afwMath::MIN) < 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance less than 0.0");
                        }
                        if (varStats.getValue(afwMath::MIN) == 0.0) {
                            throw LSST_EXCEPT(pexExcept::Exception, 
                                              "Error: variance equals 0.0, cannot inverse variance weight");
                        }
                
                        lsst::afw::math::KernelList basisList = 
                            boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(this->_kernel)->getKernelList();
                
                        unsigned int const nKernelParameters     = basisList.size();
                        unsigned int const nBackgroundParameters = this->_fitForBackground ? 1 : 0;
                        unsigned int const nParameters           = nKernelParameters + nBackgroundParameters;
                
                        std::vector<boost::shared_ptr<afwMath::Kernel> >::const_iterator kiter = basisList.begin();
                
                        /* 
                           NOTE : If we are using these views in Afw's Image space, we need to
                           make sure and compensate for the XY0 of the image:
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
893  <a href="#ec2f65f1">ec2f65f1</a> -            afwGeom::Box2I fullBBox = templateImage.getBBox(afwImage::PARENT);</div>
              ?                                                            ----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
893  <a href="#9250fe88">9250fe88</a> +            afwGeom::Box2I fullBBox = templateImage.getBBox();</div>
                           int maskStartCol = maskBox.getMinX();
                           int maskStartRow = maskBox.getMinY();
                           int maskEndCol   = maskBox.getMaxX();
                           int maskEndRow   = maskBox.getMaxY();
                
                        
                          If we are going to be doing the slicing in Eigen matrices derived from
                          the images, ignore the XY0.
                
                           afwGeom::Box2I fullBBox = templateImage.getBBox(afwImage::LOCAL);
                
                           int maskStartCol = maskBox.getMinX() - templateImage.getX0();
                           int maskStartRow = maskBox.getMinY() - templateImage.getY0();
                           int maskEndCol   = maskBox.getMaxX() - templateImage.getX0();
                           int maskEndRow   = maskBox.getMaxY() - templateImage.getY0();
                
                        */
                
                                                                                         
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
913  <a href="#ec2f65f1">ec2f65f1</a> -         afwGeom::Box2I shrunkBBox = (*kiter)->shrinkBBox(templateImage.getBBox(afwImage::PARENT));</div>
              ?                                                                                ----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
913  <a href="#9250fe88">9250fe88</a> +         afwGeom::Box2I shrunkBBox = (*kiter)->shrinkBBox(templateImage.getBBox());</div>
                
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Limits of good pixels after convolution: %d,%d -> %d,%d", 
                                          shrunkBBox.getMinX(), shrunkBBox.getMinY(), 
                                          shrunkBBox.getMaxX(), shrunkBBox.getMaxY());
                
                        unsigned int const startCol = shrunkBBox.getMinX();
                        unsigned int const startRow = shrunkBBox.getMinY();
                        unsigned int const endCol   = shrunkBBox.getMaxX();
                        unsigned int const endRow   = shrunkBBox.getMaxY();
                
                        /* NOTE: no endCol/endRow += 1 for block slicing, since we are doing the
                           slicing using Afw, not Eigen
                
                           Eigen arrays have index 0,0 in the upper right, while LSST images
                           have 0,0 in the lower left.  The y-axis is flipped.  When translating
                           Images to Eigen matrices in ipDiffim::imageToEigenMatrix this is
                           accounted for.  However, we still need to be aware of this fact if
                           addressing subregions of an Eigen matrix.  This is why the slicing is
                           done in Afw, its cleaner.
                           
                           Please see examples/maskedKernel.cc for elaboration on some of the
                           tests done to make sure this indexing gets done right.
                
                        */
                
                
                        /* Inner limits; of mask box */
                        int maskStartCol = maskBox.getMinX();
                        int maskStartRow = maskBox.getMinY();
                        int maskEndCol   = maskBox.getMaxX();
                        int maskEndRow   = maskBox.getMaxY();
                
                        /* 
                
                        |---------------------------|
                        |      Kernel Boundary      |
                        |  |---------------------|  |
                        |  |         Top         |  |
                        |  |......_________......|  |
                        |  |      |       |      |  |
                        |  |  L   |  Box  |  R   |  |
                        |  |      |       |      |  |
                        |  |......---------......|  |
                        |  |        Bottom       |  |
                        |  |---------------------|  |
                        |                           |
                        |---------------------------|
                       
                        4 regions we want to extract from the pixels: top bottom left right
                
                        */
                        afwGeom::Box2I tBox = afwGeom::Box2I(afwGeom::Point2I(startCol, maskEndRow + 1),
                                                             afwGeom::Point2I(endCol, endRow));
                        
                        afwGeom::Box2I bBox = afwGeom::Box2I(afwGeom::Point2I(startCol, startRow),
                                                             afwGeom::Point2I(endCol, maskStartRow - 1));
                        
                        afwGeom::Box2I lBox = afwGeom::Box2I(afwGeom::Point2I(startCol, maskStartRow),
                                                             afwGeom::Point2I(maskStartCol - 1, maskEndRow));
                        
                        afwGeom::Box2I rBox = afwGeom::Box2I(afwGeom::Point2I(maskEndCol + 1, maskStartRow),
                                                             afwGeom::Point2I(endCol, maskEndRow));
                
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Upper good pixel region: %d,%d -> %d,%d", 
                                          tBox.getMinX(), tBox.getMinY(), tBox.getMaxX(), tBox.getMaxY());
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Bottom good pixel region: %d,%d -> %d,%d", 
                                          bBox.getMinX(), bBox.getMinY(), bBox.getMaxX(), bBox.getMaxY());
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Left good pixel region: %d,%d -> %d,%d", 
                                          lBox.getMinX(), lBox.getMinY(), lBox.getMaxX(), lBox.getMaxY());
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Right good pixel region: %d,%d -> %d,%d", 
                                          rBox.getMinX(), rBox.getMinY(), rBox.getMaxX(), rBox.getMaxY());
                
                        std::vector<afwGeom::Box2I> boxArray;
                        boxArray.push_back(tBox);
                        boxArray.push_back(bBox);
                        boxArray.push_back(lBox);
                        boxArray.push_back(rBox);        
                
                        int totalSize = tBox.getWidth() * tBox.getHeight();
                        totalSize    += bBox.getWidth() * bBox.getHeight();
                        totalSize    += lBox.getWidth() * lBox.getHeight();
                        totalSize    += rBox.getWidth() * rBox.getHeight();
                
                        Eigen::MatrixXd eigenTemplate(totalSize, 1);
                        Eigen::MatrixXd eigenScience(totalSize, 1);
                        Eigen::MatrixXd eigeniVariance(totalSize, 1);
                        eigenTemplate.setZero();
                        eigenScience.setZero();
                        eigeniVariance.setZero();
                        
                        boost::timer t;
                        t.restart();
                 
                        int nTerms = 0;
                        typename std::vector<afwGeom::Box2I>::iterator biter = boxArray.begin();
                        for (; biter != boxArray.end(); ++biter) {
                            int area = (*biter).getWidth() * (*biter).getHeight();
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1017 <a href="#ec2f65f1">ec2f65f1</a> -             afwImage::Image<InputT> siTemplate(templateImage, *biter, afwImage::PARENT);</div>
              ?                                                                     ------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1017 <a href="#9250fe88">9250fe88</a> +             afwImage::Image<InputT> siTemplate(templateImage, *biter);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1018 <a href="#ec2f65f1">ec2f65f1</a> -             afwImage::Image<InputT> siScience(scienceImage, *biter, afwImage::PARENT);</div>
              ?                                                                   ------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1018 <a href="#9250fe88">9250fe88</a> +             afwImage::Image<InputT> siScience(scienceImage, *biter);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1019 <a href="#1fdd0bb7">1fdd0bb7</a> -             afwImage::Image<InputT> sVarEstimate(varianceEstimate, *biter, afwImage::PARENT);</div>
              ?                                                                          ------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1019 <a href="#9250fe88">9250fe88</a> +             afwImage::Image<InputT> sVarEstimate(varianceEstimate, *biter);</div>
                
                            Eigen::MatrixXd eTemplate = imageToEigenMatrix(siTemplate);
                            Eigen::MatrixXd eScience = imageToEigenMatrix(siScience);
                            Eigen::MatrixXd eiVarEstimate = imageToEigenMatrix(sVarEstimate).array().inverse().matrix();
                            
                            eTemplate.resize(area, 1);
                            eScience.resize(area, 1);
                            eiVarEstimate.resize(area, 1);
                
                            eigenTemplate.block(nTerms, 0, area, 1) = eTemplate.block(0, 0, area, 1);
                            eigenScience.block(nTerms, 0, area, 1) = eScience.block(0, 0, area, 1);
                            eigeniVariance.block(nTerms, 0, area, 1) = eiVarEstimate.block(0, 0, area, 1);
                
                            nTerms += area;
                        }
                
                        afwImage::Image<InputT> cimage(templateImage.getDimensions());
                
                        std::vector<boost::shared_ptr<Eigen::MatrixXd> > convolvedEigenList(nKernelParameters);
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiter = 
                            convolvedEigenList.begin();
                        /* Create C_i in the formalism of Alard & Lupton */
                        for (kiter = basisList.begin(); kiter != basisList.end(); ++kiter, ++eiter) {
                            afwMath::convolve(cimage, templateImage, **kiter, false); /* cimage stores convolved image */
                            Eigen::MatrixXd cMat(totalSize, 1);
                            cMat.setZero();
                
                            int nTerms = 0;
                            typename std::vector<afwGeom::Box2I>::iterator biter = boxArray.begin();
                            for (; biter != boxArray.end(); ++biter) {
                                int area = (*biter).getWidth() * (*biter).getHeight();
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1052 <a href="#1d34d3d4">1d34d3d4</a> -                 afwImage::Image<InputT> csubimage(cimage, *biter, afwImage::PARENT);</div>
              ?                                                                 ------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1052 <a href="#9250fe88">9250fe88</a> +                 afwImage::Image<InputT> csubimage(cimage, *biter);</div>
                                Eigen::MatrixXd esubimage = imageToEigenMatrix(csubimage);
                                esubimage.resize(area, 1);
                                cMat.block(nTerms, 0, area, 1) = esubimage.block(0, 0, area, 1);
                
                                nTerms += area;
                            }
                            
                            boost::shared_ptr<Eigen::MatrixXd> cMatPtr (new Eigen::MatrixXd(cMat));
                            *eiter = cMatPtr;
                            
                        } 
                        
                        double time = t.elapsed();
                        pexLog::TTrace<5>("lsst.ip.diffim.MaskedKernelSolution.build", 
                                          "Total compute time to do basis convolutions : %.2f s", time);
                        t.restart();
                
                        /* 
                           Load matrix with all values from convolvedEigenList : all images
                           (eigeniVariance, convolvedEigenList) must be the same size
                        */
                        Eigen::MatrixXd cMat(eigenTemplate.col(0).size(), nParameters);
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterj = 
                            convolvedEigenList.begin();
                        typename std::vector<boost::shared_ptr<Eigen::MatrixXd> >::iterator eiterE = 
                            convolvedEigenList.end();
                        for (unsigned int kidxj = 0; eiterj != eiterE; eiterj++, kidxj++) {
                            cMat.col(kidxj) = (*eiterj)->col(0);
                        }
                        /* Treat the last "image" as all 1's to do the background calculation. */
                        if (this->_fitForBackground)
                            cMat.col(nParameters-1).fill(1.);
                
                        this->_cMat.reset(new Eigen::MatrixXd(cMat));
                        this->_ivVec.reset(new Eigen::VectorXd(eigeniVariance.col(0)));
                        this->_iVec.reset(new Eigen::VectorXd(eigenScience.col(0)));
                
                        /* Make these outside of solve() so I can check condition number */
                        this->_mMat.reset(
                            new Eigen::MatrixXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_cMat))
                            );
                        this->_bVec.reset(
                            new Eigen::VectorXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_iVec))
                            );
                        
                    }
                    /*******************************************************************************************************/
                
                
                    template <typename InputT>
                    RegularizedKernelSolution<InputT>::RegularizedKernelSolution(
                        lsst::afw::math::KernelList const& basisList,
                        bool fitForBackground,
                        boost::shared_ptr<Eigen::MatrixXd> hMat,
                        lsst::pex::policy::Policy policy
                        ) 
                        :
                        StaticKernelSolution<InputT>(basisList, fitForBackground),
                        _hMat(hMat),
                        _policy(policy)
                    {};
                
                    template <typename InputT>
                    double RegularizedKernelSolution<InputT>::estimateRisk(double maxCond) {
                        Eigen::MatrixXd vMat      = (this->_cMat)->jacobiSvd().matrixV();
                        Eigen::MatrixXd vMatvMatT = vMat * vMat.transpose();
                
                        /* Find pseudo inverse of mMat, which may be ill conditioned */
                        Eigen::SelfAdjointEigenSolver<Eigen::MatrixXd> eVecValues(*(this->_mMat));
                        Eigen::MatrixXd const& rMat = eVecValues.eigenvectors();
                        Eigen::VectorXd eValues = eVecValues.eigenvalues();
                        double eMax = eValues.maxCoeff();
                        for (int i = 0; i != eValues.rows(); ++i) {
                            if (eValues(i) == 0.0) {
                                eValues(i) = 0.0;
                            }
                            else if ((eMax / eValues(i)) > maxCond) {
                                pexLog::TTrace<5>("lsst.ip.diffim.RegularizedKernelSolution.estimateRisk", 
                                                  "Truncating eValue %d; %.5e / %.5e = %.5e vs. %.5e",
                                                  i, eMax, eValues(i), eMax / eValues(i), maxCond);
                                eValues(i) = 0.0;
                            }
                            else {
                                eValues(i) = 1.0 / eValues(i);
                            }
                        }
                        Eigen::MatrixXd mInv    = rMat * eValues.asDiagonal() * rMat.transpose();
                
                        std::vector<double> lambdas = _createLambdaSteps();
                        std::vector<double> risks;
                        for (unsigned int i = 0; i < lambdas.size(); i++) {
                            double l = lambdas[i];
                            Eigen::MatrixXd mLambda = *(this->_mMat) + l * (*_hMat);
                            
                            try {
                                KernelSolution::solve(mLambda, *(this->_bVec));
                            } catch (pexExcept::Exception &e) {
                                LSST_EXCEPT_ADD(e, "Unable to solve regularized kernel matrix");
                                throw e;
                            }
                            Eigen::VectorXd term1 = (this->_aVec->transpose() * vMatvMatT * *(this->_aVec));
                            if (term1.size() != 1)
                                throw LSST_EXCEPT(pexExcept::Exception, "Matrix size mismatch");
                
                            double term2a = (vMatvMatT * mLambda.inverse()).trace();
                
                            Eigen::VectorXd term2b = (this->_aVec->transpose() * (mInv * *(this->_bVec)));
                            if (term2b.size() != 1)
                                throw LSST_EXCEPT(pexExcept::Exception, "Matrix size mismatch");
                
                            double risk   = term1(0) + 2 * (term2a - term2b(0));
                            pexLog::TTrace<6>("lsst.ip.diffim.RegularizedKernelSolution.estimateRisk", 
                                              "Lambda = %.3f, Risk = %.5e", 
                                              l, risk);
                            pexLog::TTrace<7>("lsst.ip.diffim.RegularizedKernelSolution.estimateRisk", 
                                              "%.5e + 2 * (%.5e - %.5e)", 
                                              term1(0), term2a, term2b(0));
                            risks.push_back(risk);
                        }
                        std::vector<double>::iterator it = min_element(risks.begin(), risks.end());
                        int index = distance(risks.begin(), it);
                        pexLog::TTrace<5>("lsst.ip.diffim.RegularizedKernelSolution.estimateRisk", 
                                          "Minimum Risk = %.3e at lambda = %.3e", risks[index], lambdas[index]);
                
                        return lambdas[index];
                        
                    }
                
                    template <typename InputT>
                    boost::shared_ptr<Eigen::MatrixXd> RegularizedKernelSolution<InputT>::getM(bool includeHmat) {
                        if (includeHmat == true) {
                            return (boost::shared_ptr<Eigen::MatrixXd>(
                                        new Eigen::MatrixXd(*(this->_mMat) + _lambda * (*_hMat))
                                        ));
                        }
                        else {
                            return this->_mMat;
                        }
                    }
                
                    template <typename InputT>
                    void RegularizedKernelSolution<InputT>::solve() {
                
                        pexLog::TTrace<5>("lsst.ip.diffim.RegularizedKernelSolution.solve", 
                                          "cMat is %d x %d; vVec is %d; iVec is %d; hMat is %d x %d", 
                                          (*this->_cMat).rows(), (*this->_cMat).cols(), (*this->_ivVec).size(), 
                                          (*this->_iVec).size(), (*_hMat).rows(), (*_hMat).cols());
                
                        if (DEBUG_MATRIX2) {
                            std::cout << "ID: " << (this->_id) << std::endl;
                            std::cout << "C:" << std::endl;
                            std::cout << (*this->_cMat) << std::endl;
                            std::cout << "Sigma^{-1}:" << std::endl;
                            std::cout << Eigen::MatrixXd((*this->_ivVec).asDiagonal()) << std::endl;
                            std::cout << "Y:" << std::endl;
                            std::cout << (*this->_iVec) << std::endl;
                            std::cout << "H:" << std::endl;
                            std::cout << (*_hMat) << std::endl;
                        }
                
                
                        this->_mMat.reset(
                            new Eigen::MatrixXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_cMat))
                            );
                        this->_bVec.reset(
                            new Eigen::VectorXd(this->_cMat->transpose() * this->_ivVec->asDiagonal() * *(this->_iVec))
                            );
                        
                        
                        /* See N.R. 18.5
                           
                           Matrix equation to solve is Y = C a + N
                           Y   = vectorized version of I (I = image to not convolve)
                           C_i = K_i (x) R (R = image to convolve)
                           a   = kernel coefficients
                           N   = noise
                           
                           If we reweight everything by the inverse square root of the noise
                           covariance, we get a linear model with the identity matrix for
                           the noise.  The problem can then be solved using least squares,
                           with the normal equations
                           
                              C^T Y = C^T C a
                
                           or 
                           
                              b = M a
                
                           with 
                
                              b = C^T Y
                              M = C^T C
                              a = (C^T C)^{-1} C^T Y
                
                
                           We can regularize the least square problem
                  
                              Y = C a + lambda a^T H a       (+ N, which can be ignored)
                
                           or the normal equations
                
                              (C^T C + lambda H) a = C^T Y
                 
                              
                           The solution to the regularization of the least squares problem is
                
                              a = (C^T C + lambda H)^{-1} C^T Y
                
                           The approximation to Y is 
                
                              C a = C (C^T C + lambda H)^{-1} C^T Y
                 
                           with smoothing matrix 
                
                              S = C (C^T C + lambda H)^{-1} C^T 
                
                        */
                        
                        std::string lambdaType = _policy.getString("lambdaType");        
                        if (lambdaType == "absolute") {
                            _lambda = _policy.getDouble("lambdaValue");
                        }
                        else if (lambdaType ==  "relative") {
                            _lambda  = this->_mMat->trace() / this->_hMat->trace();
                            _lambda *= _policy.getDouble("lambdaScaling");
                        }
                        else if (lambdaType ==  "minimizeBiasedRisk") {
                            double tol = _policy.getDouble("maxConditionNumber");
                            _lambda = estimateRisk(tol);
                        }
                        else if (lambdaType ==  "minimizeUnbiasedRisk") {
                            _lambda = estimateRisk(std::numeric_limits<double>::max());
                        }
                        else {
                            throw LSST_EXCEPT(pexExcept::Exception, "lambdaType in Policy not recognized");
                        }
                        
                        pexLog::TTrace<5>("lsst.ip.diffim.KernelCandidate.build", 
                                          "Applying kernel regularization with lambda = %.2e", _lambda);
                        
                        
                        try {
                            KernelSolution::solve(*(this->_mMat) + _lambda * (*_hMat), *(this->_bVec));
                        } catch (pexExcept::Exception &e) {
                            LSST_EXCEPT_ADD(e, "Unable to solve static kernel matrix");
                            throw e;
                        }
                        /* Turn matrices into _kernel and _background */
                        StaticKernelSolution<InputT>::_setKernel();
                    }
                
                    template <typename InputT>
                    std::vector<double> RegularizedKernelSolution<InputT>::_createLambdaSteps() {
                        std::vector<double> lambdas;
                
                        std::string lambdaStepType = _policy.getString("lambdaStepType");    
                        if (lambdaStepType == "linear") {
                            double lambdaLinMin   = _policy.getDouble("lambdaLinMin");        
                            double lambdaLinMax   = _policy.getDouble("lambdaLinMax");
                            double lambdaLinStep  = _policy.getDouble("lambdaLinStep");
                            for (double l = lambdaLinMin; l <= lambdaLinMax; l += lambdaLinStep) {
                                lambdas.push_back(l);
                            }
                        }
                        else if (lambdaStepType == "log") {
                            double lambdaLogMin   = _policy.getDouble("lambdaLogMin");        
                            double lambdaLogMax   = _policy.getDouble("lambdaLogMax");
                            double lambdaLogStep  = _policy.getDouble("lambdaLogStep");
                            for (double l = lambdaLogMin; l <= lambdaLogMax; l += lambdaLogStep) {
                                lambdas.push_back(pow(10, l));
                            }
                        }
                        else {
                            throw LSST_EXCEPT(pexExcept::Exception, "lambdaStepType in Policy not recognized");
                        }
                        return lambdas;
                    }
                
                    /*******************************************************************************************************/
                
                    SpatialKernelSolution::SpatialKernelSolution(
                        lsst::afw::math::KernelList const& basisList,
                        lsst::afw::math::Kernel::SpatialFunctionPtr spatialKernelFunction,
                        lsst::afw::math::Kernel::SpatialFunctionPtr background,
                        lsst::pex::policy::Policy policy
                        ) :
                        KernelSolution(),
                        _spatialKernelFunction(spatialKernelFunction),
                        _constantFirstTerm(false),
                        _kernel(),
                        _background(background),
                        _kSum(0.0),
                        _policy(policy),
                        _nbases(0),
                        _nkt(0),
                        _nbt(0),
                        _nt(0) {
                
                        bool isAlardLupton    = _policy.getString("kernelBasisSet") == "alard-lupton";
                        bool usePca           = _policy.getBool("usePcaForSpatialKernel");
                        if (isAlardLupton || usePca) {
                            _constantFirstTerm = true;
                        }
                        this->_fitForBackground = _policy.getBool("fitForBackground");
                
                        _nbases = basisList.size();
                        _nkt = _spatialKernelFunction->getParameters().size();
                        _nbt = _fitForBackground ? _background->getParameters().size() : 0;
                        _nt  = 0;
                        if (_constantFirstTerm) {
                            _nt = (_nbases - 1) * _nkt + 1 + _nbt;
                        } else {
                            _nt = _nbases * _nkt + _nbt;
                        }
                        
                        boost::shared_ptr<Eigen::MatrixXd> mMat (new Eigen::MatrixXd(_nt, _nt));
                        boost::shared_ptr<Eigen::VectorXd> bVec (new Eigen::VectorXd(_nt));
                        (*mMat).setZero();
                        (*bVec).setZero();
                
                        this->_mMat = mMat;
                        this->_bVec = bVec;
                
                        _kernel = afwMath::LinearCombinationKernel::Ptr(
                            new afwMath::LinearCombinationKernel(basisList, *_spatialKernelFunction)
                            );
                
                        pexLog::TTrace<5>("lsst.ip.diffim.SpatialKernelSolution", 
                                          "Initializing with size %d %d %d and constant first term = %s",
                                          _nkt, _nbt, _nt,
                                          _constantFirstTerm ? "true" : "false");
                        
                    }
                
                    void SpatialKernelSolution::addConstraint(float xCenter, float yCenter,
                                                              boost::shared_ptr<Eigen::MatrixXd> qMat,
                                                              boost::shared_ptr<Eigen::VectorXd> wVec) {
                        
                        pexLog::TTrace<8>("lsst.ip.diffim.SpatialKernelSolution.addConstraint", 
                                          "Adding candidate at %f, %f", xCenter, yCenter);
                
                        /* Calculate P matrices */
                        /* Pure kernel terms */
                        Eigen::VectorXd pK(_nkt);
                        std::vector<double> paramsK = _spatialKernelFunction->getParameters();
                        for (int idx = 0; idx < _nkt; idx++) { paramsK[idx] = 0.0; }
                        for (int idx = 0; idx < _nkt; idx++) {
                            paramsK[idx] = 1.0;
                            _spatialKernelFunction->setParameters(paramsK);
                            pK(idx) = (*_spatialKernelFunction)(xCenter, yCenter); /* Assume things don't vary over stamp */
                            paramsK[idx] = 0.0;
                        }
                        Eigen::MatrixXd pKpKt = (pK * pK.transpose());
                        
                        Eigen::VectorXd pB;
                        Eigen::MatrixXd pBpBt;
                        Eigen::MatrixXd pKpBt;
                        if (_fitForBackground) {
                            pB = Eigen::VectorXd(_nbt);
                
                            /* Pure background terms */
                            std::vector<double> paramsB = _background->getParameters();
                            for (int idx = 0; idx < _nbt; idx++) { paramsB[idx] = 0.0; }
                            for (int idx = 0; idx < _nbt; idx++) {
                                paramsB[idx] = 1.0;
                                _background->setParameters(paramsB);
                                pB(idx) = (*_background)(xCenter, yCenter);       /* Assume things don't vary over stamp */
                                paramsB[idx] = 0.0;
                            }
                            pBpBt = (pB * pB.transpose());
                            
                            /* Cross terms */
                            pKpBt = (pK * pB.transpose());
                        }
                        
                        if (DEBUG_MATRIX) {
                            std::cout << "Spatial weights" << std::endl;
                            std::cout << "pKpKt " << pKpKt << std::endl;
                            if (_fitForBackground) {
                                std::cout << "pBpBt " << pBpBt << std::endl;
                                std::cout << "pKpBt " << pKpBt << std::endl;
                            }
                        }
                        
                        if (DEBUG_MATRIX) {
                            std::cout << "Spatial matrix inputs" << std::endl;
                            std::cout << "M " << (*qMat) << std::endl;
                            std::cout << "B " << (*wVec) << std::endl;
                        }
                
                        /* first index to start the spatial blocks; default=0 for non-constant first term */
                        int m0 = 0; 
                        /* how many rows/cols to adjust the matrices/vectors; default=0 for non-constant first term */
                        int dm = 0; 
                        /* where to start the background terms; this is always true */
                        int mb = _nt - _nbt;
                        
                        if (_constantFirstTerm) {
                            m0 = 1;       /* we need to manually fill in the first (non-spatial) terms below */
                            dm = _nkt-1;  /* need to shift terms due to lack of spatial variation in first term */
                            
                            (*_mMat)(0, 0) += (*qMat)(0,0);
                            for(int m2 = 1; m2 < _nbases; m2++)  {
                                (*_mMat).block(0, m2*_nkt-dm, 1, _nkt) += (*qMat)(0,m2) * pK.transpose();
                            }
                            (*_bVec)(0) += (*wVec)(0);
                            
                            if (_fitForBackground) {
                                (*_mMat).block(0, mb, 1, _nbt) += (*qMat)(0,_nbases) * pB.transpose();
                            }
                        }
                        
                        /* Fill in the spatial blocks */
                        for(int m1 = m0; m1 < _nbases; m1++)  {
                            /* Diagonal kernel-kernel term; only use upper triangular part of pKpKt */
                            (*_mMat).block(m1*_nkt-dm, m1*_nkt-dm, _nkt, _nkt) += 
                                (pKpKt * (*qMat)(m1,m1)).triangularView<Eigen::Upper>();
                            
                            /* Kernel-kernel terms */
                            for(int m2 = m1+1; m2 < _nbases; m2++)  {
                                (*_mMat).block(m1*_nkt-dm, m2*_nkt-dm, _nkt, _nkt) += (*qMat)(m1,m2) * pKpKt;
                            }
                
                            if (_fitForBackground) {
                                /* Kernel cross terms with background */
                                (*_mMat).block(m1*_nkt-dm, mb, _nkt, _nbt) += (*qMat)(m1,_nbases) * pKpBt;
                            }
                            
                            /* B vector */
                            (*_bVec).segment(m1*_nkt-dm, _nkt) += (*wVec)(m1) * pK;
                        }
                        
                        if (_fitForBackground) {
                            /* Background-background terms only */
                            (*_mMat).block(mb, mb, _nbt, _nbt) +=  
                                (pBpBt * (*qMat)(_nbases,_nbases)).triangularView<Eigen::Upper>();
                            (*_bVec).segment(mb, _nbt)         += (*wVec)(_nbases) * pB;
                        }
                        
                        if (DEBUG_MATRIX) {
                            std::cout << "Spatial matrix outputs" << std::endl;
                            std::cout << "mMat " << (*_mMat) << std::endl;
                            std::cout << "bVec " << (*_bVec) << std::endl;
                        }
                
                    }
                
                    lsst::afw::image::Image<lsst::afw::math::Kernel::Pixel>::Ptr SpatialKernelSolution::makeKernelImage(afwGeom::Point2D const& pos) {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return image");
                        }
                        afwImage::Image<afwMath::Kernel::Pixel>::Ptr image(
                            new afwImage::Image<afwMath::Kernel::Pixel>(_kernel->getDimensions())
                            );
                        (void)_kernel->computeImage(*image, false, pos[0], pos[1]);              
                        return image;
                    }
                
                    void SpatialKernelSolution::solve() {
                        /* Fill in the other half of mMat */
                        for (int i = 0; i < _nt; i++) {
                            for (int j = i+1; j < _nt; j++) {
                                (*_mMat)(j,i) = (*_mMat)(i,j);
                            }
                        }
                
                        try {
                            KernelSolution::solve();
                        } catch (pexExcept::Exception &e) {
                            LSST_EXCEPT_ADD(e, "Unable to solve spatial kernel matrix");
                            throw e;
                        }
                        /* Turn matrices into _kernel and _background */
                        _setKernel();
                    }
                
                    std::pair<afwMath::LinearCombinationKernel::Ptr, 
                            afwMath::Kernel::SpatialFunctionPtr> SpatialKernelSolution::getSolutionPair() {
                        if (_solvedBy == KernelSolution::NONE) {
                            throw LSST_EXCEPT(pexExcept::Exception, "Kernel not solved; cannot return solution");
                        }
                        
                        return std::make_pair(_kernel, _background);
                    }
                    
                    void SpatialKernelSolution::_setKernel() {
                        /* Report on condition number */
                        double cNumber = this->getConditionNumber(EIGENVALUE);
                        
                        if (_nkt == 1) {
                            /* Not spatially varying; this fork is a specialization for convolution speed--up */
                            
                            /* Set the basis coefficients */
                            std::vector<double> kCoeffs(_nbases);
                            for (int i = 0; i < _nbases; i++) {
                                if (std::isnan((*_aVec)(i))) {
                                    throw LSST_EXCEPT(
                                        pexExcept::Exception, 
                                        str(boost::format(
                                                "I. Unable to determine spatial kernel solution %d (nan).  Condition number = %.3e") % i % cNumber));
                                }
                                kCoeffs[i] = (*_aVec)(i);
                            }
                            lsst::afw::math::KernelList basisList = 
                                boost::dynamic_pointer_cast<afwMath::LinearCombinationKernel>(_kernel)->getKernelList();
                            _kernel.reset(
                                new afwMath::LinearCombinationKernel(basisList, kCoeffs)
                                );
                        }
                        else {
                            
                            /* Set the kernel coefficients */
                            std::vector<std::vector<double> > kCoeffs;
                            kCoeffs.reserve(_nbases);
                            for (int i = 0, idx = 0; i < _nbases; i++) {
                                kCoeffs.push_back(std::vector<double>(_nkt));
                
                                /* Deal with the possibility the first term doesn't vary spatially */
                                if ((i == 0) && (_constantFirstTerm)) {
                                    if (std::isnan((*_aVec)(idx))) {
                                        throw LSST_EXCEPT(
                                            pexExcept::Exception, 
                                            str(boost::format(
                                                    "II. Unable to determine spatial kernel solution %d (nan).  Condition number = %.3e") % idx % cNumber));
                                    }
                                    kCoeffs[i][0] = (*_aVec)(idx++);
                                }
                                else {
                                    for (int j = 0; j < _nkt; j++) {
                                        if (std::isnan((*_aVec)(idx))) {
                                            throw LSST_EXCEPT(
                                                pexExcept::Exception, 
                                                str(boost::format(
                                                        "III. Unable to determine spatial kernel solution %d (nan).  Condition number = %.3e") % idx % cNumber));
                                        }
                                        kCoeffs[i][j] = (*_aVec)(idx++);
                                    }
                                }
                            }
                            _kernel->setSpatialParameters(kCoeffs);
                        }
                
                        /* Set kernel Sum */
                        ImageT::Ptr image (new ImageT(_kernel->getDimensions()));
                        _kSum  = _kernel->computeImage(*image, false);              
                
                        /* Set the background coefficients */
                        std::vector<double> bgCoeffs(_fitForBackground ? _nbt : 1);
                        if (_fitForBackground) {
                            for (int i = 0; i < _nbt; i++) {
                                int idx = _nt - _nbt + i;
                                if (std::isnan((*_aVec)(idx))) {
                                    throw LSST_EXCEPT(pexExcept::Exception, 
                                                      str(boost::format(
                                           "Unable to determine spatial background solution %d (nan)") % (idx)));
                                }
                                bgCoeffs[i] = (*_aVec)(idx);
                            }
                        }
                        else {
                            bgCoeffs[0] = 0.;
                        }
                        _background->setParameters(bgCoeffs);
                    }
                
                /***********************************************************************************************************/
                //
                // Explicit instantiations
                //
                    typedef float InputT;
                
                    template class StaticKernelSolution<InputT>;
                    template class MaskedKernelSolution<InputT>;
                    template class RegularizedKernelSolution<InputT>;
                
                }}} // end of namespace lsst::ip::diffim
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="1d34d3d4"/></a>1d34d3d4</h3>

<pre>
commit 1d34d3d4db8017aa5755ca78a73bc7a19bca016f
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Apr 28 00:14:27 2011 +0000

    Working on ndarray integration.  #1140.
</pre>
<h3><a name="1fdd0bb7"/></a>1fdd0bb7</h3>

<pre>
commit 1fdd0bb7e8e67d1a5e7ab119e8445801cc89de8e
Author: becker <becker@git.lsstcorp.org>
Date:   Tue Apr 19 21:45:56 2011 +0000

    Additional edits to clean up the BBox LOCAL vs. PARENT change.  #1140.
</pre>
<h3><a name="1707c6fa"/></a>1707c6fa</h3>

<pre>
commit 1707c6fa5352e44cba90118e890fe70499483753
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Jul 22 00:36:01 2010 +0000

    added condition number calculation.  #1140.
</pre>
<h3><a name="ec2f65f1"/></a>ec2f65f1</h3>

<pre>
commit ec2f65f1f72311b644f7ab2640a9f7f96912fdf4
Author: Andy Becker <acbecker@gmail.com>
Date:   Tue Jan 8 14:36:44 2013 -0800

    Renaming of variables from e.g. "exposure to convolve" to "template exposure".  reads far easier.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="7d3a88f7"/></a>7d3a88f7</h3>

<pre>
commit 7d3a88f73bc94bf6eb8d1634f409e320a3f23d96
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:19:09 2014 -0700

    Renamed exceptions
</pre>
<h3><a name="9250fe88"/></a>9250fe88</h3>

<pre>
commit 9250fe889b96cf9b3fa82d2bc499dab86d63723b
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:52:26 2014 -0700

    Use default origin of PARENT where possible
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_108"><a name="examples/runSubtractExposures.py"/></a>examples/runSubtractExposures.py</h1>

<h3 id="toc_109">Diff:</h3>

<pre>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#109bd96b">109bd96b</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#48e85303">48e85303</a> + import lsst.utils</div>
                import sys
                import os
                import optparse
                import re
                import numpy as num
                
                import lsst.afw.image as afwImage
                
                from lsst.pex.logging import Trace
                from lsst.pex.logging import Log
                import lsst.meas.algorithms as measAlg
                
                import lsst.ip.diffim as ipDiffim
                import lsst.ip.diffim.diffimTools as diffimTools
                
                def main():
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#48e85303">48e85303</a> +     defDataDir = lsst.utils.getPackageDir('afwdata')</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#109bd96b">109bd96b</a> -     defDataDir   = eups.productDir('afwdata')</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#109bd96b">109bd96b</a> -     if defDataDir == None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#109bd96b">109bd96b</a> -         print 'Error: afwdata not set up'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#109bd96b">109bd96b</a> -         sys.exit(1)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#109bd96b">109bd96b</a> -     imageProcDir = eups.productDir('ip_diffim')</div>
              ?                    ^ ^  ^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#48e85303">48e85303</a> +     imageProcDir = lsst.utils.getPackageDir('ip_diffim')</div>
              ?                    ^^^^^ ^^^  ^^^^^ ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#109bd96b">109bd96b</a> -     if imageProcDir == None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#109bd96b">109bd96b</a> -         print 'Error: could not set up ip_diffim'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#109bd96b">109bd96b</a> -         sys.exit(1)</div>
                
                    defSciencePath  = os.path.join(defDataDir, "DC3a-Sim", "sci", "v26-e0", "v26-e0-c011-a10.sci")
                    defTemplatePath = os.path.join(defDataDir, "DC3a-Sim", "sci", "v5-e0", "v5-e0-c011-a10.sci")
                
                    defOutputPath   = 'diffExposure.fits'
                    defVerbosity    = 5
                    defFwhm         = 3.5
                    sigma2fwhm      = 2. * num.sqrt(2. * num.log(2.))
                
                    usage = """usage: %%prog [options] [scienceExposure [templateExposure [outputExposure]]]]
                
                Notes:
                - image arguments are paths to Expoure fits files
                - image arguments must NOT include the final _img.fits
                - the result is science image - template image
                - the template exposure is convolved, the science exposure is not
                - default scienceExposure=%s
                - default templateExposure=%s
                - default outputExposure=%s 
                """ % (defSciencePath, defTemplatePath, defOutputPath)
                    
                    parser = optparse.OptionParser(usage)
                    parser.add_option('-v', '--verbosity', type=int, default=defVerbosity,
                                      help='verbosity of Trace messages')
                    parser.add_option('-d', '--display', action='store_true', default=False,
                                      help='display the images')
                    parser.add_option('-b', '--bg', action='store_true', default=False,
                                      help='subtract backgrounds using afw')
                    parser.add_option('--fwhmS', type=float,
                                      help='Science Image Psf Fwhm (pixel)')
                    parser.add_option('--fwhmT', type=float,
                                      help='Template Image Psf Fwhm (pixel)')
                
                    (options, args) = parser.parse_args()
                    
                    def getArg(ind, defValue):
                        if ind < len(args):
                            return args[ind]
                        return defValue
                    
                    sciencePath     = getArg(0, defSciencePath)
                    templatePath    = getArg(1, defTemplatePath)
                    outputPath      = getArg(2, defOutputPath)
                    
                    if sciencePath == None or templatePath == None:
                        parser.print_help()
                        sys.exit(1)
                
                    print 'Science exposure: ', sciencePath
                    print 'Template exposure:', templatePath
                    print 'Output exposure:  ', outputPath
                
                    templateExposure = afwImage.ExposureF(templatePath)
                    scienceExposure  = afwImage.ExposureF(sciencePath)
                    
                    config = ipDiffim.ImagePsfMatchTask.ConfigClass()
                    config.kernel.name = "AL"
                    subconfig = config.kernel.active
                
                    fwhmS = defFwhm
                    if options.fwhmS:
                        if scienceExposure.hasPsf():
                            width, height = scienceExposure.getPsf().getKernel().getDimensions()
                            psfAttr = measAlg.PsfAttributes(scienceExposure.getPsf(), width//2, height//2)
                            s = psfAttr.computeGaussianWidth(psfAttr.ADAPTIVE_MOMENT) # gaussian sigma in pixels
                            fwhm = s * sigma2fwhm
                            print 'NOTE: Embedded Psf has FwhmS =', fwhm
                        print 'USING: FwhmS =', options.fwhmS
                        fwhmS = options.fwhmS
                
                    fwhmT = defFwhm
                    if options.fwhmT:
                        if templateExposure.hasPsf():
                            width, height = templateExposure.getPsf().getKernel().getDimensions()
                            psfAttr = measAlg.PsfAttributes(templateExposure.getPsf(), width//2, height//2)
                            s = psfAttr.computeGaussianWidth(psfAttr.ADAPTIVE_MOMENT) # gaussian sigma in pixels
                            fwhm = s * sigma2fwhm
                            print 'NOTE: Embedded Psf has FwhmT =', fwhm
                        print 'USING: FwhmT =', options.fwhmT
                        fwhmT = options.fwhmT
                
                    display = False
                    if options.display:
                        print 'Display =', options.display
                        display = True
                
                    bgSub = False
                    if options.bg:
                        print 'Background subtract =', options.bg
                        bgSub = True
                
                    if options.verbosity > 0:
                        print 'Verbosity =', options.verbosity
                        Trace.setVerbosity('lsst.ip.diffim', options.verbosity)
                
                    ####
                        
                    if bgSub:
                        diffimTools.backgroundSubtract(subconfig.afwBackgroundConfig,
                                                       [templateExposure.getMaskedImage(),
                                                        scienceExposure.getMaskedImage()])
                    else:
                        if subconfig.fitForBackground == False:
                            print 'NOTE: no background subtraction at all is requested'
                
                    psfmatch = ipDiffim.ImagePsfMatchTask(config)
                    results  = psfmatch.run(templateExposure, scienceExposure, "subtractExposures",
                                            templateFwhmPix = fwhmT, scienceFwhmPix = fwhmS)
                
                    differenceExposure = results.subtractedImage
                    differenceExposure.writeFits(outputPath)
                
                    if False:
                        psfMatchingKernel = results.psfMatchingKernel
                        backgroundModel   = results.backgroundModel
                        kernelCellSet     = results.kernelCellSet
                        
                        diffimTools.writeKernelCellSet(kernelCellSet, psfMatchingKernel, backgroundModel,
                                                       re.sub('.fits', '', outputPath))
                        
                def run():
                    Log.getDefaultLog()
                    main()
                
                if __name__ == '__main__':
                    run()
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/ip_diffim/</h2>
<h3><a name="109bd96b"/></a>109bd96b</h3>

<pre>
commit 109bd96b9bc7942af46bcbb13b1e97004a648989
Author: becker <becker@git.lsstcorp.org>
Date:   Thu Mar 5 20:41:18 2009 +0000

    Merging of ticket #354 to trunk.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/ip_diffim/</h2>
<h3><a name="48e85303"/></a>48e85303</h3>

<pre>
commit 48e8530382bbf73854eab61a7f5766520a1ba272
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Thu May 21 16:59:32 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<script type="text/javascript">
self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{};var Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var s={};for(var o in i)if(i.hasOwnProperty(o)){if(o==n)for(var l in a)a.hasOwnProperty(l)&&(s[l]=a[l]);s[o]=i[o]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=s)}),r[e]=s},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,s,o=a;o&&!e.test(o.className);)o=o.parentNode;if(o&&(l=(o.className.match(e)||[,""])[1],s=t.languages[l]),s){a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=a.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent;if(u){u=u.replace(/^(?:\r?\n|\r)/,"");var g={element:a,language:l,grammar:s,code:u};if(t.hooks.run("before-highlight",g),r&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){g.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(g.element),t.hooks.run("after-highlight",g)},c.postMessage(JSON.stringify({language:g.language,code:g.code}))}else g.highlightedCode=t.highlight(g.code,g.grammar,g.language),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",g)}}},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var s=n[l];s="Array"===t.util.type(s)?s:[s];for(var o=0;o<s.length;++o){var u=s[o],g=u.inside,c=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){c&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,g?t.tokenize(m,g):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener?(self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),self.close()},!1),self.Prism):self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
</body>

</html>
