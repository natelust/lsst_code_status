<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>meas_deblender</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
</head>
<body>
<h1 id="toc_0">Comparison of the meas_deblender repository</h1>

<div style="background-color:Aquamarine; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Summary of Repositories</h1>
<p>
Comparison run at 02:17PM on June 09, 2015<br>
There are <b>1025</b> differences between the two repositories<br><br>
Repository <b>/Users/nate/repos_hsc/meas_deblender/</b> <br> Revision <b>501999c7c31c903304cd801a984172b01bceaa5f</b><br> Branch <b>master</b><br>Last commit was on <b>2015-05-20 19:26:57 -0400</b><br><br>
Repository <b>/Users/nate/repos_lsst/meas_deblender/</b> <br> Revision <b>88c55f79cb4d1aca20caf79a6b4fe82ca98a48a7</b><br> Branch <b>master</b><br>Last commit was on <b>2015-04-22 11:12:15 -0400</b><br><br>
</p>
</div>

<hr>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_hsc/meas_deblender/</h1>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_lsst/meas_deblender/</h1>
<h2>tests/data/ticket1738.fits</h2>
<pre>
commit 88c55f79cb4d1aca20caf79a6b4fe82ca98a48a7
Merge: 554edb6 f3746e8
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Wed Apr 22 11:12:15 2015 -0400

    Merge branch 'tickets/DM-1944'</pre>
<h2>tests/data/ticket1738_noInclude.fits</h2>
<pre>
commit 88c55f79cb4d1aca20caf79a6b4fe82ca98a48a7
Merge: 554edb6 f3746e8
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Wed Apr 22 11:12:15 2015 -0400

    Merge branch 'tickets/DM-1944'</pre>
<h2>tests/testInclude.py</h2>
<pre>
commit 88c55f79cb4d1aca20caf79a6b4fe82ca98a48a7
Merge: 554edb6 f3746e8
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Wed Apr 22 11:12:15 2015 -0400

    Merge branch 'tickets/DM-1944'</pre>
<h2>src/Baseline.cc.orig</h2>
<pre>
commit 88c55f79cb4d1aca20caf79a6b4fe82ca98a48a7
Merge: 554edb6 f3746e8
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Wed Apr 22 11:12:15 2015 -0400

    Merge branch 'tickets/DM-1944'</pre>
</div>

<h1 id="toc_1">List of the files in common<a name="homelist"></a></h1>

<p>Files without links do not differ</p>

<ul>
<li><code>examples/data/act.psf</code></li>
<li><code>doc/design-figs/design-mono2-h1.pdf</code></li>
<li><code>doc/design-figs/design-mono2-tw2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-parent.pdf</code></li>
<li><code>doc/design-figs/design-med2-h0.pdf</code></li>
<li><a href="#src/Baseline.cc"><code>src/Baseline.cc</code></a></li>
<li><code>examples/data/act.fp</code></li>
<li><code>doc/design-figs/design-ramp3-s0.pdf</code></li>
<li><code>examples/data/t0002/t.fits</code></li>
<li><code>doc/design-figs/design-sdss-parent.pdf</code></li>
<li><code>tests/monotonic.py</code></li>
<li><code>tests/SConscript</code></li>
<li><a href="#examples/designdoc.py"><code>examples/designdoc.py</code></a></li>
<li><code>doc/design-figs/design-med2-f1.pdf</code></li>
<li><code>doc/design-figs/design-sdss-h0.pdf</code></li>
<li><code>doc/design-figs/design-med2-h2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-tw2.pdf</code></li>
<li><code>doc/design-figs/design-mono4-h3.pdf</code></li>
<li><code>doc/design-figs/design-mono2-f1.pdf</code></li>
<li><code>.gitignore</code></li>
<li><code>doc/design-figs/design-med1-parent.pdf</code></li>
<li><code>examples/data/t0010/t.fits</code></li>
<li><code>python/lsst/meas/deblender/deblendAndMeasure.py</code></li>
<li><code>doc/design-figs/design-med2-h3.pdf</code></li>
<li><code>ups/meas_deblender.pacman.m4</code></li>
<li><code>doc/design-figs/design-mono4-f1.pdf</code></li>
<li><code>doc/design-figs/design-mono2-parent.pdf</code></li>
<li><code>doc/design-figs/design-med1-tw0.pdf</code></li>
<li><code>examples/data/t0010/mod2.png</code></li>
<li><code>doc/design-figs/design-mono1-parent.pdf</code></li>
<li><code>doc/design-figs/design-med2-f0.pdf</code></li>
<li><code>doc/design-figs/design-sdss-t2.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-hb2.pdf</code></li>
<li><code>doc/design-figs/design-med1-f1.pdf</code></li>
<li><code>doc/design-figs/design-med1-tw2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-h3.pdf</code></li>
<li><code>examples/data/t0002/mod2.png</code></li>
<li><code>examples/rerun.py</code></li>
<li><code>examples/data/t0003/t.fits</code></li>
<li><code>doc/design-figs/design-ramp2-symm2.pdf</code></li>
<li><code>doc/design-figs/design-med1-f2.pdf</code></li>
<li><code>doc/design-figs/design-med2-parent.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-t0.pdf</code></li>
<li><code>doc/design-figs/design-med1-tw1.pdf</code></li>
<li><a href="#tests/strayFlux.py"><code>tests/strayFlux.py</code></a></li>
<li><code>doc/design-figs/design-mono1-tw1.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-t2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-tw1.pdf</code></li>
<li><code>src/SConscript</code></li>
<li><a href="#python/lsst/meas/__init__.py"><code>python/lsst/meas/__init__.py</code></a></li>
<li><code>NOTES</code></li>
<li><code>examples/data/t0001/mod.png</code></li>
<li><code>doc/design-figs/design-ramp2-symm0.pdf</code></li>
<li><code>doc/design-figs/design-mono3-f0.pdf</code></li>
<li><code>doc/design-figs/design-mono4-h2.pdf</code></li>
<li><code>doc/design-figs/design-mono4-f0.pdf</code></li>
<li><code>doc/design-figs/design-mono2-f0.pdf</code></li>
<li><code>doc/design-figs/design-mono3-h1.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-r0.pdf</code></li>
<li><code>doc/design-figs/design-mono4-tw2.pdf</code></li>
<li><code>python/lsst/meas/deblender/__init__.py</code></li>
<li><code>doc/design-figs/design-mono3-f2.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-s1.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-hb3.pdf</code></li>
<li><code>doc/design-figs/design-mono2-tw0.pdf</code></li>
<li><code>doc/design-figs/design-med2-tw0.pdf</code></li>
<li><code>doc/design-figs/design-sdss-h1.pdf</code></li>
<li><code>doc/design-figs/design-mono3-f3.pdf</code></li>
<li><code>examples/data/t0011/srcs.fits</code></li>
<li><code>doc/design-figs/design-med1-h0.pdf</code></li>
<li><code>doc/design-figs/design-mono4-h1.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-s2.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-parent.pdf</code></li>
<li><a href="#include/lsst/meas/deblender/Baseline.h"><code>include/lsst/meas/deblender/Baseline.h</code></a></li>
<li><code>doc/design-figs/design-mono1-f2.pdf</code></li>
<li><code>doc/design-figs/design-patch-parent.pdf</code></li>
<li><code>doc/design-figs/design-mono3-h0.pdf</code></li>
<li><code>lib/SConscript</code></li>
<li><code>doc/design-figs/design-sdss-t1.pdf</code></li>
<li><code>ups/meas_deblender.cfg</code></li>
<li><code>examples/data/t0001/mod2.png</code></li>
<li><code>doc/design-figs/design-mono4-f3.pdf</code></li>
<li><code>doc/design-figs/design-sdss-tw1.pdf</code></li>
<li><code>doc/design-figs/design-mono1-f0.pdf</code></li>
<li><code>tests/symmFootprint.py</code></li>
<li><code>doc/design-figs/design-mono1-h0.pdf</code></li>
<li><code>doc/design-figs/design-med2-tw1.pdf</code></li>
<li><code>doc/design-figs/design-sdss-tw2.pdf</code></li>
<li><code>doc/design-figs/design-mono2-h2.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-t3.pdf</code></li>
<li><code>doc/design-figs/design-sdss-t0.pdf</code></li>
<li><code>doc/design-figs/design-mono1-f1.pdf</code></li>
<li><code>examples/suprime.py</code></li>
<li><code>examples/__init__.py</code></li>
<li><code>examples/data/t0000/mod.png</code></li>
<li><a href="#python/lsst/meas/deblender/deblend.py"><code>python/lsst/meas/deblender/deblend.py</code></a></li>
<li><code>doc/design-figs/design-patch-hsum.pdf</code></li>
<li><code>doc/doxygen.conf.in</code></li>
<li><code>tests/test1.fits</code></li>
<li><code>doc/design-figs/design-mono2-h0.pdf</code></li>
<li><code>doc/design-figs/design-mono4-parent.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-t1.pdf</code></li>
<li><code>examples/drivers/tractor.paf</code></li>
<li><code>SConstruct</code></li>
<li><code>examples/utils.py</code></li>
<li><code>examples/drivers/tractorMapper.py</code></li>
<li><code>doc/design-figs/design-med1-h2.pdf</code></li>
<li><a href="#python/lsst/meas/deblender/deblenderLib.i"><code>python/lsst/meas/deblender/deblenderLib.i</code></a></li>
<li><code>doc/design-figs/design-mono1-tw2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-tw3.pdf</code></li>
<li><a href="#ups/meas_deblender.table"><code>ups/meas_deblender.table</code></a></li>
<li><code>examples/data/t0010/mod.png</code></li>
<li><code>doc/design-figs/design-mono2-tw1.pdf</code></li>
<li><code>examples/drivers/tractorPreprocess.py</code></li>
<li><code>doc/design-figs/design-sdss-f1.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-symm3.pdf</code></li>
<li><code>doc/design-figs/design-mono1-h2.pdf</code></li>
<li><code>doc/design-figs/design-med2-h1.pdf</code></li>
<li><code>doc/design-figs/design-mono2-f2.pdf</code></li>
<li><code>doc/design-figs/design-mono3-tw0.pdf</code></li>
<li><code>doc/design-figs/design-med2-tw3.pdf</code></li>
<li><a href="#tests/fit_psf.py"><code>tests/fit_psf.py</code></a></li>
<li><code>examples/data/t0000/mod2.png</code></li>
<li><code>doc/design-figs/design-ramp3-hb0.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-parent.pdf</code></li>
<li><code>doc/design.tex</code></li>
<li><code>doc/design-figs/design-mono3-f1.pdf</code></li>
<li><code>etc/dependencies.dat</code></li>
<li><code>doc/design-figs/design-sdss-h2.pdf</code></li>
<li><code>examples/data/t0003/mod2.png</code></li>
<li><a href="#python/lsst/meas/deblender/baseline.py"><code>python/lsst/meas/deblender/baseline.py</code></a></li>
<li><code>doc/design-figs/design-sdss-f2.pdf</code></li>
<li><code>doc/design-figs/design-sdss-tw0.pdf</code></li>
<li><code>examples/drivers/tractorDeblend.py</code></li>
<li><code>doc/design-figs/design-mono4-tw1.pdf</code></li>
<li><code>doc/design-figs/design-med2-f2.pdf</code></li>
<li><code>examples/data/t0003/srcs.fits</code></li>
<li><code>doc/design-figs/design-sdss-tsum.pdf</code></li>
<li><code>examples/README</code></li>
<li><code>doc/SConscript</code></li>
<li><code>doc/design-figs/design-mono4-tw0.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-o0.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-symm1.pdf</code></li>
<li><code>examples/data/t0003/mod.png</code></li>
<li><code>examples/data/t0011/mod2.png</code></li>
<li><code>examples/data/t0011/mod.png</code></li>
<li><code>examples/data/t0000/t.fits</code></li>
<li><code>doc/design-figs/design-sdss-f0.pdf</code></li>
<li><code>doc/design-figs/design-patch-o0.pdf</code></li>
<li><code>doc/design-figs/design-ramp1-hsum.pdf</code></li>
<li><code>doc/design-figs/design-mono4-tw3.pdf</code></li>
<li><code>doc/design-figs/design-ramp2-hsum.pdf</code></li>
<li><code>doc/design-figs/design-med2-tw2.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-hb1.pdf</code></li>
<li><code>examples/data/act-img.fits</code></li>
<li><code>doc/design-figs/design-ramp3-hsum.pdf</code></li>
<li><code>examples/data/t0011/t.fits</code></li>
<li><code>examples/data/t0002/mod.png</code></li>
<li><code>doc/design-figs/design-ramp1-o0.pdf</code></li>
<li><a href="#tests/ticket2871.py"><code>tests/ticket2871.py</code></a></li>
<li><code>examples/data/t0001/t.fits</code></li>
<li><code>doc/design-figs/design-ramp3-s3.pdf</code></li>
<li><a href="#python/lsst/__init__.py"><code>python/lsst/__init__.py</code></a></li>
<li><code>doc/design-figs/design-med1-f0.pdf</code></li>
<li><code>doc/design-figs/design-mono4-h0.pdf</code></li>
<li><a href="#examples/plotDeblendFamilies.py"><code>examples/plotDeblendFamilies.py</code></a></li>
<li><code>doc/design-figs/design-mono4-f2.pdf</code></li>
<li><code>doc/design-figs/design-mono1-tw0.pdf</code></li>
<li><code>doc/design-figs/design-sdss-image.pdf</code></li>
<li><code>ups/meas_deblender.build</code></li>
<li><code>doc/design-figs/design-med2-f3.pdf</code></li>
<li><code>doc/plots.sh</code></li>
<li><code>ups/manifest.list</code></li>
<li><code>doc/design-figs/design-mono1-h1.pdf</code></li>
<li><code>doc/design-figs/design-med1-h1.pdf</code></li>
<li><code>doc/design-figs/design-ramp3-hsum2.pdf</code></li>
<li><code>examples/portionFigureWithMissingSrc.py</code></li>
<li><code>examples/data/t0002/srcs.fits</code></li>
<li><code>doc/design-figs/design-mono3-h2.pdf</code></li>
<li><code>python/lsst/meas/deblender/SConscript</code></li>
<li><a href="#tests/edges.py"><code>tests/edges.py</code></a></li>
<li><code>doc/design-figs/design-patch-t0.pdf</code></li>
</ul>

<h1 id="toc_2"><a name="src/Baseline.cc"/></a>src/Baseline.cc</h1>

<h3 id="toc_3">Diff:</h3>

<pre>
                #include <list>
                
                #include "lsst/meas/deblender/Baseline.h"
                #include "lsst/pex/logging.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#0609735f">0609735f</a> - #include "lsst/pex/exceptions.h"</div>
                #include "lsst/afw/geom/Box.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#7b331d27">7b331d27</a> - #include "lsst/meas/algorithms/detail/SdssShape.h"</div>
                
                #include <boost/math/special_functions/round.hpp>
                
                using boost::math::iround;
                
                namespace image = lsst::afw::image;
                namespace det = lsst::afw::detection;
                namespace deblend = lsst::meas::deblender;
                namespace geom = lsst::afw::geom;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#7b331d27">7b331d27</a> - namespace malg = lsst::meas::algorithms;</div>
                namespace pexLog = lsst::pex::logging;
                
                
                static bool span_ptr_compare(PTR(det::Span) sp1, PTR(det::Span) sp2) {
                    return (*sp1 < *sp2);
                }
                
                /**
                 Run a spatial median filter over the given input *img*, writing the
                 results to *out*.  *halfsize* is half the box size of the filter; ie,
                 a halfsize of 50 means that each output pixel will be the median of
                 the pixels in a 101 x 101-pixel box in the input image.
                
                 Margins are handled horribly: the median is computed only for pixels
                 more than *halfsize* away from the edges; pixels near the edges are
                 simply copied from the input *img* to *out*.
                
                 Mask and variance planes are, likewise, simply copied from *img* to
                 *out*.
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                void
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                medianFilter(MaskedImageT const& img,
                             MaskedImageT & out,
                             int halfsize) {
                    int S = halfsize*2 + 1;
                    int SS = S*S;
                    typedef typename MaskedImageT::xy_locator xy_loc;
                    xy_loc pix = img.xy_at(halfsize,halfsize);
                    std::vector<typename xy_loc::cached_location_t> locs;
                    for (int i=0; i<S; ++i) {
                        for (int j=0; j<S; ++j) {
                            locs.push_back(pix.cache_location(j-halfsize, i-halfsize));
                        }
                    }
                    int W = img.getWidth();
                    int H = img.getHeight();
                    ImagePixelT vals[S*S];
                    for (int y=halfsize; y<H-halfsize; ++y) {
                        xy_loc inpix = img.xy_at(halfsize, y), end = img.xy_at(W-halfsize, y);
                        for (typename MaskedImageT::x_iterator optr = out.row_begin(y) + halfsize;
                             inpix != end; ++inpix.x(), ++optr) {
                            for (int i=0; i<SS; ++i)
                                vals[i] = inpix[locs[i]].image();
                            std::nth_element(vals, vals+SS/2, vals+SS);
                            optr.image() = vals[SS/2];
                            optr.mask() = inpix.mask();
                            optr.variance() = inpix.variance();
                        }
                    }
                
                    // grumble grumble margins
                    for (int y=0; y<2*halfsize; ++y) {
                        int iy = y;
                        if (y >= halfsize)
                            iy = H - 1 - (y-halfsize);
                        typename MaskedImageT::x_iterator optr = out.row_begin(iy);
                        typename MaskedImageT::x_iterator iptr = img.row_begin(iy), end=img.row_end(iy);
                        for (; iptr != end; ++iptr,++optr)
                            *optr = *iptr;
                    }
                    for (int y=halfsize; y<H-halfsize; ++y) {
                        typename MaskedImageT::x_iterator optr = out.row_begin(y);
                        typename MaskedImageT::x_iterator iptr = img.row_begin(y), end=img.row_begin(y)+halfsize;
                        for (; iptr != end; ++iptr,++optr)
                            *optr = *iptr;
                        iptr = img.row_begin(y) + ((W-1) - halfsize);
                        end  = img.row_begin(y) + (W-1);
                        optr = out.row_begin(y) + ((W-1) - halfsize);
                        for (; iptr != end; ++iptr,++optr)
                            *optr = *iptr;
                    }
                
                }
                
                /**
                 Given an image *mimg* and Peak location *peak*, overwrite *mimg* so
                 that pixels further from the peak have values smaller than those
                 close to the peak; make the profile monotonic-decreasing.
                
                 The exact algorithm is a little more complicated than that.  The
                 basic idea is of "casting a shadow" from a pixel to pixels farther
                 from the peak in the same direction.  Done naively, this results in
                 very narrow "shadows" and ragged profiles.  A tweak is to make the
                 shadows "fatter" -- make a pixel shadow a wedge of pixels -- but if
                 one does this naively, the wedge gets wider and wider too quickly.
                 The algorithm works out from the peak in square "rings" of pixels, so
                 if a pixel shadows a wedge 30 degrees wide, in the next ring of
                 pixels the shadowed pixel at largest angle from the shadowing pixel
                 will shade a yet-larger wedge, expanding the shadowing angle.  To
                 reduce this effect, we work in chunks of 5 pixels in radius, only
                 copying the intermediate pixels to the "shadowing" image at the end
                 of each chunk.
                
                 Currently the mask and variance planes of the input are totally
                 ignored.
                
                 For illustration, run tests/monotonic.py and look at im*.png
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                void
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                makeMonotonic(
                    MaskedImageT & mimg,
                    det::PeakRecord const& peak) {
                
                    int cx = peak.getIx();
                    int cy = peak.getIy();
                    int ix0 = mimg.getX0();
                    int iy0 = mimg.getY0();
                    int iW = mimg.getWidth();
                    int iH = mimg.getHeight();
                
                    ImagePtrT img = mimg.getImage();
                    ImagePtrT shadowingImg = ImagePtrT(new ImageT(*img, true));
                
                    int DW = std::max(cx - mimg.getX0(), mimg.getX0() + mimg.getWidth() - cx);
                    int DH = std::max(cy - mimg.getY0(), mimg.getY0() + mimg.getHeight() - cy);
                
                    const int S = 5;
                
                    // Work out from the peak in chunks of "S" pixels.
                    int s;
                    for (s = 0; s < std::max(DW,DH); s += S) {
                        int p;
                        for (p=0; p<S; p++) {
                            // visit pixels with L_inf distance = s + p from the
                            // center (ie, the s+p'th square ring of pixels)
                            // L is the half-length of the ring (box).
                            int L = s+p;
                            int x = L, y = -L;
                            int dx = 0, dy = 0; // initialized here to satisfy the
                                                // compiler; initialized for real
                                                // below (first time through loop)
                            /*
                            int i;
                            int leg;
                            for (i=0; i<(8*L); i++, x += dx, y += dy) {
                                if (i % (2*L) == 0) {
                                    leg = (i/(2*L));
                                    dx = ( leg    % 2) * (-1 + 2*(leg/2));
                                    dy = ((leg+1) % 2) * ( 1 - 2*(leg/2));
                                }
                             */
                
                            /*
                             We visit pixels in a box of "radius" L, in this order:
                
                             L=1:
                
                             4 3 2
                             5   1
                             6 7 0
                
                             L=2:
                
                             8  7  6  5  4
                             9           3
                             10          2
                             11          1
                             12 13 14 15 0
                
                             Note that the number of pixel visited is 8*L, and that we
                             change "dx" or "dy" each "2*L" steps.
                             */
                            for (int i=0; i<(8*L); i++, x += dx, y += dy) {
                                // time to change directions?  (Note that this runs
                                // the first time through the loop, initializing dx,dy
                                // appropriately.)
                                if (i % (2*L) == 0) {
                                    int leg = (i/(2*L));
                                    // dx = [ 0, -1,  0, 1 ][leg]
                                    dx = ( leg    % 2) * (-1 + 2*(leg/2));
                                    // dy = [ 1,  0, -1, 0 ][leg]
                                    dy = ((leg+1) % 2) * ( 1 - 2*(leg/2));
                                }
                                //printf("  i=%i, leg=%i, dx=%i, dy=%i, x=%i, y=%i\n", i, leg, dx, dy, x, y);
                                int px = cx + x - ix0;
                                int py = cy + y - iy0;
                                // If the shadowing pixel is out of bounds, nothing to do.
                                if (px < 0 || px >= iW || py < 0 || py >= iH)
                                    continue;
                                // The pixel casting the shadow
                                ImagePixelT pix = (*shadowingImg)(px,py);
                
                                // Cast this pixel's shadow S pixels long in a cone.
                                // We compute the range of slopes (or inverse-slopes)
                                // shadowed by the pixel, [ds0,ds1]
                                double ds0, ds1;
                                // Range of slopes shadowed
                                const double A = 0.3;
                                int shx, shy;
                                int psx, psy;
                                // Are we traversing a vertical edge of the box?
                                if (dx == 0) {
                                    // (if so, then "x" is +- L, so no div-by-zero)
                                    ds0 = (double(y) / double(x)) - A;
                                    ds1 = ds0 + 2.0 * A;
                                    // cast the shadow on column x + sign(x)*shx
                                    for (shx=1; shx<=S; shx++) {
                                        int xsign = (x>0?1:-1);
                                        // the column being shadowed
                                        psx = cx + x + (xsign*shx) - ix0;
                                        if (psx < 0 || psx >= iW)
                                            continue;
                                        // shadow covers a range of y values based on slope
                                        for (shy  = iround(shx * ds0);
                                             shy <= iround(shx * ds1); shy++) {
                                            psy = cy + y + xsign*shy - iy0;
                                            if (psy < 0 || psy >= iH)
                                                continue;
                                            (*img)(psx, psy) = std::min((*img)(psx, psy), pix);
                                        }
                                    }
                
                                } else {
                                    // We're traversing a horizontal edge of the box; y = +-L
                                    ds0 = (double(x) / double(y)) - A;
                                    ds1 = ds0 + 2.0 * A;
                                    // Cast shadow on row y + sign(y)*shy
                                    for (shy=1; shy<=S; shy++) {
                                        int ysign = (y>0?1:-1);
                                        psy = cy + y + (ysign*shy) - iy0;
                                        if (psy < 0 || psy >= iH)
                                            continue;
                                        // shadow covers a range of x vals based on slope
                                        for (shx  = iround(shy * ds0);
                                             shx <= iround(shy * ds1); shx++) {
                                            psx = cx + x + ysign*shx - ix0;
                                            if (psx < 0 || psx >= iW)
                                                continue;
                                            (*img)(psx, psy) = std::min((*img)(psx, psy), pix);
                                        }
                                    }
                                }
                            }
                        }
                        //*shadowingImg <<= *img;
                        shadowingImg->operator<<=(*img);
                    }
                }
                
                static double _get_contrib_r_to_footprint(int x, int y,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#b606deab">b606deab</a> -                                           det::Footprint::Ptr tfoot) {</div>
              ?                                                         ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#a8c50f30">a8c50f30</a> +                                           PTR(det::Footprint) tfoot) {</div>
              ?                                           ++++              ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#b606deab">b606deab</a> -     typedef typename det::Footprint::SpanList SpanList;</div>
              ?            ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#a8c50f30">a8c50f30</a> +     typedef det::Footprint::SpanList SpanList;</div>
                    double minr2 = 1e12;
                    SpanList const& tspans = tfoot->getSpans();
                    for (SpanList::const_iterator ts = tspans.begin(); ts < tspans.end(); ++ts) {
                        geom::Span* sp = ts->get();
                        int mindx;
                        // span is to right of pixel?
                        int dx = sp->getX0() - x;
                        if (dx >= 0) {
                            mindx = dx;
                        } else {
                            // span is to left of pixel?
                            dx = x - sp->getX1();
                            if (dx >= 0) {
                                mindx = dx;
                            } else {
                                // span contains pixel (in x direction)
                                mindx = 0;
                            }
                        }
                        int dy = sp->getY() - y;
                        minr2 = std::min(minr2, (double)(mindx*mindx + dy*dy));
                    }
                    //printf("stray flux at (%i,%i): dist to t %i is %g\n", x, y, (int)i, sqrt(minr2));
                    return 1. / (1. + minr2);
                }
                
                
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                void
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                _find_stray_flux(det::Footprint const& foot,
                                 ImagePtrT tsum,
                                 MaskedImageT const& img,
                                 int strayFluxOptions,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#519fee6c">519fee6c</a> -                  std::vector<det::Footprint::Ptr> tfoots,</div>
              ?                                            ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#a8c50f30">a8c50f30</a> +                  std::vector<PTR(det::Footprint)> tfoots,</div>
              ?                              ++++              ^
                                 std::vector<bool> const& ispsf,
                                 std::vector<int>  const& pkx,
                                 std::vector<int>  const& pky,
                                 double clipStrayFluxFraction,
                                 std::vector<boost::shared_ptr<typename det::HeavyFootprint<ImagePixelT,MaskPixelT,VariancePixelT> > > & strays
                                 ) {
                
                    typedef typename det::Footprint::SpanList SpanList;
                    typedef typename det::HeavyFootprint<ImagePixelT, MaskPixelT, VariancePixelT> HeavyFootprint;
                    typedef typename boost::shared_ptr< HeavyFootprint > HeavyFootprintPtrT;
                
                    // when doing stray flux: the footprints and pixels, which we'll
                    // combine into the return 'strays' HeavyFootprint at the end.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#519fee6c">519fee6c</a> -     std::vector<det::Footprint::Ptr > strayfoot;</div>
              ?                               ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#a8c50f30">a8c50f30</a> +     std::vector<PTR(det::Footprint) > strayfoot;</div>
              ?                 ++++              ^
                    std::vector<std::vector<ImagePixelT> > straypix;
                    std::vector<std::vector<MaskPixelT> > straymask;
                    std::vector<std::vector<VariancePixelT> > strayvar;
                
                    int ix0 = img.getX0();
                    int iy0 = img.getY0();
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#519fee6c">519fee6c</a> -     geom::Box2I sumbb = tsum->getBBox(image::PARENT);</div>
              ?                                       -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#5ea010ad">5ea010ad</a> +     geom::Box2I sumbb = tsum->getBBox();</div>
                    int sumx0 = sumbb.getMinX();
                    int sumy0 = sumbb.getMinY();
                
                    for (size_t i=0; i<tfoots.size(); ++i) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#519fee6c">519fee6c</a> -         strayfoot.push_back(det::Footprint::Ptr());</div>
              ?                                           ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#a8c50f30">a8c50f30</a> +         strayfoot.push_back(PTR(det::Footprint)());</div>
              ?                             ++++              ^
                        straypix.push_back(std::vector<ImagePixelT>());
                        straymask.push_back(std::vector<MaskPixelT>());
                        strayvar.push_back(std::vector<VariancePixelT>());
                    }
                
                    bool always = (strayFluxOptions & STRAYFLUX_TO_POINT_SOURCES_ALWAYS);
                
                    typedef boost::uint16_t itype;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#b606deab">b606deab</a> -     image::Image<itype>::Ptr nearest;</div>
              ?                        ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#a8c50f30">a8c50f30</a> +     PTR(image::Image<itype>) nearest;</div>
              ?     ++++                   ^
                
                    if (strayFluxOptions & STRAYFLUX_NEAREST_FOOTPRINT) {
                        // Compute the map of which footprint is closest to each
                        // pixel in the bbox.
                        typedef boost::uint16_t dtype;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#b606deab">b606deab</a> -         image::Image<dtype>::Ptr dist(new image::Image<dtype>(sumbb));</div>
              ?                            ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#a8c50f30">a8c50f30</a> +         PTR(image::Image<dtype>) dist(new image::Image<dtype>(sumbb));</div>
              ?         ++++                   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#b606deab">b606deab</a> -         nearest = image::Image<itype>::Ptr(new image::Image<itype>(sumbb));</div>
              ?                                      ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#a8c50f30">a8c50f30</a> +         nearest = PTR(image::Image<itype>)(new image::Image<itype>(sumbb));</div>
              ?                   ++++                   ^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
342  <a href="#b606deab">b606deab</a> -         std::vector<det::Footprint::Ptr> templist;</div>
              ?                                   ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#a8c50f30">a8c50f30</a> +         std::vector<PTR(det::Footprint)> templist;</div>
              ?                     ++++              ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#b606deab">b606deab</a> -         std::vector<det::Footprint::Ptr>* footlist = &tfoots;</div>
              ?                                   ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#a8c50f30">a8c50f30</a> +         std::vector<PTR(det::Footprint)>* footlist = &tfoots;</div>
              ?                     ++++              ^
                
                        if (!always && ispsf.size()) {
                            // create a temp list that has empty footprints in place
                            // of all the point sources.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
348  <a href="#e3cd0cbe">e3cd0cbe</a> -             PTR(det::Footprint) empty(new det::Footprint(foot.getPeaks().getSchema()));</div>
              ?                                                          ---------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
345  <a href="#a8c50f30">a8c50f30</a> +             PTR(det::Footprint) empty(new det::Footprint());</div>
                            for (size_t i=0; i<tfoots.size(); ++i) {
                                if (ispsf[i]) {
                                    templist.push_back(empty);
                                } else {
                                    templist.push_back(tfoots[i]);
                                }
                            }
                            footlist = &templist;
                        }
                        nearestFootprint(*footlist, nearest, dist);
                    }
                
                    // Go through the (parent) Footprint looking for stray flux:
                    // pixels that are not claimed by any template, and positive.
                    const SpanList& spans = foot.getSpans();
                    for (SpanList::const_iterator s = spans.begin(); s < spans.end(); s++) {
                        int y = (*s)->getY();
                        int x0 = (*s)->getX0();
                        int x1 = (*s)->getX1();
                        typename ImageT::x_iterator tsum_it =
                            tsum->row_begin(y - sumy0) + (x0 - sumx0);
                        typename MaskedImageT::x_iterator in_it =
                            img.row_begin(y - iy0) + (x0 - ix0);
                        double contrib[tfoots.size()];
                
                        for (int x = x0; x <= x1; ++x, ++tsum_it, ++in_it) {
                            // Skip pixels that are covered by at least one
                            // template (*tsum_it > 0) or the input is not
                            // positive (*in_it <= 0).
                            if ((*tsum_it > 0) || (*in_it).image() <= 0) {
                                continue;
                            }
                
                            if (strayFluxOptions & STRAYFLUX_R_TO_FOOTPRINT) {
                                // we'll compute these just-in-time
                                for (size_t i=0; i<tfoots.size(); ++i) {
                                    contrib[i] = -1.0;
                                }
                            } else if (strayFluxOptions & STRAYFLUX_NEAREST_FOOTPRINT) {
                                for (size_t i=0; i<tfoots.size(); ++i) {
                                    contrib[i] = 0.0;
                                }
                                int i = nearest->get0(x, y);
                                contrib[i] = 1.0;
                            } else {
                                // R_TO_PEAK
                                for (size_t i=0; i<tfoots.size(); ++i) {
                                    // Split the stray flux by 1/(1+r^2) to peaks
                                    int dx, dy;
                                    dx = pkx[i] - x;
                                    dy = pky[i] - y;
                                    contrib[i] = 1. / (1. + dx*dx + dy*dy);
                                }
                            }
                
                            // Round 1: skip point sources unless STRAYFLUX_TO_POINT_SOURCES_ALWAYS
                            // are we going to assign stray flux to ptsrcs?
                            bool ptsrcs = always;
                            double csum = 0.;
                            for (size_t i=0; i<tfoots.size(); ++i) {
                                // if we're skipping point sources and this is a point source...
                                if ((!ptsrcs) && ispsf.size() && ispsf[i]) {
                                    continue;
                                }
                                if (contrib[i] == -1.0) {
                                    contrib[i] = _get_contrib_r_to_footprint(x, y, tfoots[i]);
                                }
                                csum += contrib[i];
                            }
                            if ((csum == 0.) &&
                                (strayFluxOptions &
                                 STRAYFLUX_TO_POINT_SOURCES_WHEN_NECESSARY)) {
                                // No extended sources -- assign to pt sources
                                //log.debugf("necessary to assign stray flux to point sources");
                                ptsrcs = true;
                                for (size_t i=0; i<tfoots.size(); ++i) {
                                    if (contrib[i] == -1.0) {
                                        contrib[i] = _get_contrib_r_to_footprint(x, y, tfoots[i]);
                                    }
                                    csum += contrib[i];
                                }
                            }
                
                            // Drop small contributions...
                            double strayclip = (clipStrayFluxFraction * csum);
                            csum = 0.;
                            for (size_t i=0; i<tfoots.size(); ++i) {
                                // skip ptsrcs?
                                if ((!ptsrcs) && ispsf.size() && ispsf[i]) {
                                    contrib[i] = 0.;
                                    continue;
                                }
                                // skip small contributions
                                if (contrib[i] < strayclip) {
                                    contrib[i] = 0.;
                                    continue;
                                }
                                csum += contrib[i];
                            }
                
                            for (size_t i=0; i<tfoots.size(); ++i) {
                                if (contrib[i] == 0.) {
                                    continue;
                                }
                                // the stray flux to give to template i
                                double p = (contrib[i] / csum) * (*in_it).image();
                                if (!strayfoot[i]) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
456  <a href="#e3cd0cbe">e3cd0cbe</a> -                     strayfoot[i] = PTR(det::Footprint)(new det::Footprint(foot.getPeaks().getSchema()));</div>
              ?                                                                           ---------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
453  <a href="#a8c50f30">a8c50f30</a> +                     strayfoot[i] = PTR(det::Footprint)(new det::Footprint());</div>
                                }
                                strayfoot[i]->addSpanInSeries(y, x, x);
                                straypix[i].push_back(p);
                                straymask[i].push_back((*in_it).mask());
                                strayvar[i].push_back((*in_it).variance());
                            }
                        }
                    }
                
                    // Store the stray flux in HeavyFootprints
                    for (size_t i=0; i<tfoots.size(); ++i) {
                        if (!strayfoot[i]) {
                            strays.push_back(HeavyFootprintPtrT());
                        } else {
                            /// Hmm, this is a little bit dangerous: we're assuming that
                            /// the HeavyFootprint stores its pixels in the same order that
                            /// we iterate over them above (ie, lexicographic).
                            HeavyFootprintPtrT heavy(new HeavyFootprint(*strayfoot[i]));
                            ndarray::Array<ImagePixelT,1,1> himg = heavy->getImageArray();
                            typename std::vector<ImagePixelT>::const_iterator spix;
                            typename std::vector<MaskPixelT>::const_iterator smask;
                            typename std::vector<VariancePixelT>::const_iterator svar;
                            typename ndarray::Array<ImagePixelT,1,1>::Iterator hpix;
                            typename ndarray::Array<MaskPixelT,1,1>::Iterator mpix;
                            typename ndarray::Array<VariancePixelT,1,1>::Iterator vpix;
                
                            assert((size_t)strayfoot[i]->getNpix() == straypix[i].size());
                
                            for (spix = straypix[i].begin(),
                                     smask = straymask[i].begin(),
                                     svar  = strayvar [i].begin(),
                                     hpix = himg.begin(),
                                     mpix = heavy->getMaskArray().begin(),
                                     vpix = heavy->getVarianceArray().begin();
                                 spix != straypix[i].end();
                                 ++spix, ++smask, ++svar, ++hpix, ++mpix, ++vpix) {
                                *hpix = *spix;
                                *mpix = *smask;
                                *vpix = *svar;
                            }
                            strays.push_back(heavy);
                        }
                    }
                }
                
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                void
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                _sum_templates(std::vector<MaskedImagePtrT> timgs,
                               ImagePtrT tsum) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
507  <a href="#8f605f1f">8f605f1f</a> -     geom::Box2I sumbb = tsum->getBBox(image::PARENT);</div>
              ?                                       -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
504  <a href="#5ea010ad">5ea010ad</a> +     geom::Box2I sumbb = tsum->getBBox();</div>
                    int sumx0 = sumbb.getMinX();
                    int sumy0 = sumbb.getMinY();
                
                    // Compute  tsum = the sum of templates
                    for (size_t i=0; i<timgs.size(); ++i) {
                        MaskedImagePtrT timg = timgs[i];
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
514  <a href="#8f605f1f">8f605f1f</a> -         geom::Box2I tbb = timg->getBBox(image::PARENT);</div>
              ?                                         -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
511  <a href="#5ea010ad">5ea010ad</a> +         geom::Box2I tbb = timg->getBBox();</div>
                        int tx0 = tbb.getMinX();
                        int ty0 = tbb.getMinY();
                        // To handle "ramped" templates that can extend outside the
                        // parent, clip the bbox.  Note that we saved tx0,ty0 BEFORE
                        // doing this!
                        tbb.clip(sumbb);
                        int copyx0 = tbb.getMinX();
                        // Here we iterate over the template bbox -- we could instead
                        // iterate over the "tfoot"s.
                        for (int y=tbb.getMinY(); y<=tbb.getMaxY(); ++y) {
                            typename MaskedImageT::x_iterator in_it = timg->row_begin(y - ty0) +
                                (copyx0 - tx0);
                            typename MaskedImageT::x_iterator inend = in_it + tbb.getWidth();
                            typename ImageT::x_iterator tsum_it =
                                tsum->row_begin(y - sumy0) + (copyx0 - sumx0);
                            for (; in_it != inend; ++in_it, ++tsum_it) {
                                *tsum_it += std::max((ImagePixelT)0., (*in_it).image());
                            }
                        }
                    }
                
                }
                
                /**
                 Splits flux in a given image *img*, within a given footprint *foot*,
                 among a number of templates *timgs*,*tfoots*.  This is where actual
                 "deblending" takes place.
                
                 *timgs* and *tfoots* MUST be the same length.
                
                 Flux is assigned to templates according to their relative heights at
                 each pixel.
                
                 If *strayFluxOptions* includes *ASSIGN_STRAYFLUX*, then "stray flux"
                 -- flux in the parent footprint that is not covered by any of the
                 template footprints -- is assigned to templates based on their
                 1/(1+r^2) distance.
                
                 If *strayFluxOptions* includes *STRAYFLUX_R_TO_FOOTPRINT*, the stray
                 flux is distributed to the footprints based on 1/(1+r^2) of the
                 minimum distance from the stray flux to footprint.
                
                 If *strayFluxOptions* includes "STRAYFLUX_NEAREST_FOOTPRINT*, the
                 stray flux is assigned to the footprint with lowest L-1 (Manhattan)
                 distance to the stray flux.
                
                 Otherwise, stray flux is assigned based on (1/(1+r^2) from the peaks.
                
                 If *strayFluxOptions* includes *STRAYFLUX_TO_POINT_SOURCES_ALWAYS*,
                 then point sources are always included in the 1/(1+r^2) splitting.
                 Otherwise, if *STRAYFLUX_TO_POINT_SOURCES_WHEN_NECESSARY*, point
                 sources are included only if there are no extended sources nearby.
                
                 If any stray-flux portion is less than *clipStrayFluxFraction*, it is
                 clipped to zero.
                
                 When doing stray flux, the "strays" arg is used as an extra return
                 value, the stray flux assigned to each template.
                
                 When doing stray flux, the *ispsf*, *pkx*, and *pky* arrays are
                 required.  They give the peak x,y coords plus whether the peak is
                 believed (by the deblender) to be a point source.  *pkx* and *pky*
                 MUST be the same length as *timgs*.  If *ispsf* has nonzero length,
                 it MUST be the same length as *timgs*.
                
                 If *tsum* is given, is it set to the sum of max(0, template).
                
                 The return value is a vector of MaskedImages containing the flux
                 assigned to each template.
                
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                std::vector<typename PTR(image::MaskedImage<ImagePixelT, MaskPixelT, VariancePixelT>)>
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                apportionFlux(MaskedImageT const& img,
                              det::Footprint const& foot,
                              std::vector<MaskedImagePtrT> timgs,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
592  <a href="#81146de8">81146de8</a> -               std::vector<det::Footprint::Ptr> tfoots,</div>
              ?                                         ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
589  <a href="#a8c50f30">a8c50f30</a> +               std::vector<PTR(det::Footprint)> tfoots,</div>
              ?                           ++++              ^
                              ImagePtrT tsum,
                              std::vector<bool> const& ispsf,
                              std::vector<int>  const& pkx,
                              std::vector<int>  const& pky,
                              std::vector<boost::shared_ptr<typename det::HeavyFootprint<ImagePixelT,MaskPixelT,VariancePixelT> > > & strays,
                              int strayFluxOptions,
                              double clipStrayFluxFraction
                    ) {
                    typedef typename det::Footprint::SpanList SpanList;
                
                    if (timgs.size() != tfoots.size()) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
604  <a href="#d6945e7a">d6945e7a</a> -         throw LSST_EXCEPT(lsst::pex::exceptions::LengthErrorException,</div>
              ?                                                             ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
601  <a href="#d19f42f0">d19f42f0</a> +         throw LSST_EXCEPT(lsst::pex::exceptions::LengthError,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
605  <a href="#576ca540">576ca540</a> -                           (boost::format("Template images must be the same length as template footprints (%d vs %d)") % timgs.size() % tfoots.size()).str());</div>
              ? --------------                                                                                                       ----------------------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
602  <a href="#8846f794">8846f794</a> +             (boost::format("Template images must be the same length as template footprints (%d vs %d)")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
603  <a href="#8846f794">8846f794</a> +                 % timgs.size() % tfoots.size()).str());</div>
                    }
                
                    for (size_t i=0; i<timgs.size(); ++i) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
609  <a href="#576ca540">576ca540</a> -         if (!timgs[i]->getBBox(image::PARENT).contains(tfoots[i]->getBBox())) {</div>
              ?                                -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
607  <a href="#5ea010ad">5ea010ad</a> +         if (!timgs[i]->getBBox().contains(tfoots[i]->getBBox())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
610  <a href="#576ca540">576ca540</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeErrorException,</div>
              ?                                                                  ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
608  <a href="#d19f42f0">d19f42f0</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeError,</div>
                                              "Template image MUST contain template footprint");
                        }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
613  <a href="#576ca540">576ca540</a> -         if (!img.getBBox(image::PARENT).contains(foot.getBBox())) {</div>
              ?                          -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
611  <a href="#5ea010ad">5ea010ad</a> +         if (!img.getBBox().contains(foot.getBBox())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
614  <a href="#576ca540">576ca540</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeErrorException,</div>
              ?                                                                  ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
612  <a href="#d19f42f0">d19f42f0</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeError,</div>
                                              "Image bbox MUST contain parent footprint");
                        }
                        // template bounding-boxes *can* extend outside the parent
                        // footprint if we are ramping templates with significant flux
                        // at the edges.  We handle this below.
                    }
                
                    // the apportioned flux return value
                    std::vector<MaskedImagePtrT> portions;
                
                    pexLog::Log log(pexLog::Log::getDefaultLog(),
                                    "lsst.meas.deblender.apportionFlux");
                    bool findStrayFlux = (strayFluxOptions & ASSIGN_STRAYFLUX);
                
                    int ix0 = img.getX0();
                    int iy0 = img.getY0();
                    geom::Box2I fbb = foot.getBBox();
                
                    if (!tsum) {
                        tsum = ImagePtrT(new ImageT(fbb.getDimensions()));
                        tsum->setXY0(fbb.getMinX(), fbb.getMinY());
                    }
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
638  <a href="#576ca540">576ca540</a> -     if (!tsum->getBBox(image::PARENT).contains(foot.getBBox())) {</div>
              ?                        -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
636  <a href="#5ea010ad">5ea010ad</a> +     if (!tsum->getBBox().contains(foot.getBBox())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
639  <a href="#576ca540">576ca540</a> -         throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeErrorException,</div>
              ?                                                              ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
637  <a href="#d19f42f0">d19f42f0</a> +         throw LSST_EXCEPT(lsst::pex::exceptions::RuntimeError,</div>
                                          "Template sum image MUST contain parent footprint");
                    }
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
643  <a href="#576ca540">576ca540</a> -     geom::Box2I sumbb = tsum->getBBox(image::PARENT);</div>
              ?                                       -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
641  <a href="#5ea010ad">5ea010ad</a> +     geom::Box2I sumbb = tsum->getBBox();</div>
                    int sumx0 = sumbb.getMinX();
                    int sumy0 = sumbb.getMinY();
                
                    _sum_templates(timgs, tsum);
                
                    // Compute flux portions
                    for (size_t i=0; i<timgs.size(); ++i) {
                        MaskedImagePtrT timg = timgs[i];
                        // Initialize return value:
                        MaskedImagePtrT port(new MaskedImageT(timg->getDimensions()));
                        port->setXY0(timg->getXY0());
                        portions.push_back(port);
                
                        // Split flux = image * template / tsum
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
658  <a href="#81146de8">81146de8</a> -         geom::Box2I tbb = timg->getBBox(image::PARENT);</div>
              ?                                         -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
656  <a href="#5ea010ad">5ea010ad</a> +         geom::Box2I tbb = timg->getBBox();</div>
                        int tx0 = tbb.getMinX();
                        int ty0 = tbb.getMinY();
                        // As above
                        tbb.clip(sumbb);
                        int copyx0 = tbb.getMinX();
                        for (int y=tbb.getMinY(); y<=tbb.getMaxY(); ++y) {
                            typename MaskedImageT::x_iterator in_it =
                                img.row_begin(y - iy0) + (copyx0 - ix0);
                            typename MaskedImageT::x_iterator tptr =
                                timg->row_begin(y - ty0) + (copyx0 - tx0);
                            typename MaskedImageT::x_iterator tend = tptr + tbb.getWidth();
                            typename ImageT::x_iterator tsum_it =
                                tsum->row_begin(y - sumy0) + (copyx0 - sumx0);
                            typename MaskedImageT::x_iterator out_it =
                                port->row_begin(y - ty0) + (copyx0 - tx0);
                            for (; tptr != tend; ++tptr, ++in_it, ++out_it, ++tsum_it) {
                                if (*tsum_it == 0) {
                                    continue;
                                }
                                double frac = std::max((ImagePixelT)0., (*tptr).image()) / (*tsum_it);
                                //if (frac == 0) {
                                // treat mask planes differently?
                                // }
                                out_it.mask()     = (*in_it).mask();
                                out_it.variance() = (*in_it).variance();
                                out_it.image()    = (*in_it).image() * frac;
                            }
                        }
                    }
                
                    if (findStrayFlux) {
                        if ((ispsf.size() > 0) && (ispsf.size() != timgs.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
691  <a href="#d6945e7a">d6945e7a</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::LengthErrorException,</div>
              ?                                                                 ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
689  <a href="#d19f42f0">d19f42f0</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::LengthError,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
692  <a href="#576ca540">576ca540</a> -                               (boost::format("'ispsf' must be the same length as templates (%d vs %d)") % ispsf.size() % timgs.size()).str());</div>
              ? --------------                                                                                         ---------------------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
690  <a href="#8846f794">8846f794</a> +                 (boost::format("'ispsf' must be the same length as templates (%d vs %d)")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
691  <a href="#8846f794">8846f794</a> +                      % ispsf.size() % timgs.size()).str());</div>
                        }
                        if ((pkx.size() != timgs.size()) || (pky.size() != timgs.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
695  <a href="#d6945e7a">d6945e7a</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::LengthErrorException,</div>
              ?                                                                 ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
694  <a href="#d19f42f0">d19f42f0</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::LengthError,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
696  <a href="#576ca540">576ca540</a> -                               (boost::format("'pkx' and 'pky' must be the same length as templates (%d,%d vs %d)") % pkx.size() % pky.size() % timgs.size()).str());</div>
              ? --------------                                                                                                    --------------------------------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
695  <a href="#8846f794">8846f794</a> +                 (boost::format("'pkx' and 'pky' must be the same length as templates (%d,%d vs %d)")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
696  <a href="#8846f794">8846f794</a> +                     % pkx.size() % pky.size() % timgs.size()).str());</div>
                        }
                        _find_stray_flux(foot, tsum, img, strayFluxOptions, tfoots,
                                         ispsf, pkx, pky, clipStrayFluxFraction, strays);
                    }
                    return portions;
                }
                
                
                /**
                 This is a convenience class used in symmetrizeFootprint, wrapping the
                 idea of iterating through a SpanList either forward or backward, and
                 looking at dx,dy coordinates relative to a center cx,cy coordinate.
                 This makes the symmetrizeFootprint code much tidier and more
                 symmetric-looking; the operations on the forward and backward
                 iterators are mostly the same.
                 */
                class RelativeSpanIterator {
                public:
                    typedef det::Footprint::SpanList SpanList;
                
                    RelativeSpanIterator() {}
                
                    RelativeSpanIterator(SpanList::const_iterator const& real,
                                         SpanList const& arr,
                                         int cx, int cy, bool forward=true) 
                        : _real(real), _cx(cx), _cy(cy), _forward(forward)
                        {
                            if (_forward) {
                                _end = arr.end();
                            } else {
                                _end = arr.begin();
                            }
                        }
                
                    bool operator==(const SpanList::const_iterator & other) {
                        return _real == other;
                    }
                    bool operator!=(const SpanList::const_iterator & other) {
                        return _real != other;
                    }
                    bool operator<=(const SpanList::const_iterator & other) {
                        return _real <= other;
                    }
                    bool operator<(const SpanList::const_iterator & other) {
                        return _real < other;
                    }
                    bool operator>=(const SpanList::const_iterator & other) {
                        return _real >= other;
                    }
                    bool operator>(const SpanList::const_iterator & other) {
                        return _real > other;
                    }
                
                    bool operator==(RelativeSpanIterator & other) {
                        return (_real == other._real) &&
                            (_cx == other._cx) && (_cy == other._cy) &&
                            (_forward == other._forward);
                    }
                    bool operator!=(RelativeSpanIterator & other) {
                        return !(*this == other);
                    }
                
                    RelativeSpanIterator operator++() {
                        if (_forward) {
                            _real++;
                        } else {
                            _real--;
                        }
                        return *this;
                    }
                    RelativeSpanIterator operator++(int dummy) {
                        RelativeSpanIterator result = *this;
                        ++(*this);
                        return result;
                    }
                
                    bool notDone() {
                        if (_forward) {
                            return _real < _end;
                        } else {
                            return _real >= _end;
                        }
                    }
                
                    int dxlo() {
                        if (_forward) {
                            return (*_real)->getX0() - _cx;
                        } else {
                            return _cx - (*_real)->getX1();
                        }
                    }
                    int dxhi() {
                        if (_forward) {
                            return (*_real)->getX1() - _cx;
                        } else {
                            return _cx - (*_real)->getX0();
                        }
                    }
                    int dy() {
                        return std::abs((*_real)->getY() - _cy);
                    }
                    int x0() {
                        return (*_real)->getX0();
                    }
                    int x1() {
                        return (*_real)->getX1();
                    }
                    int y() {
                        return (*_real)->getY();
                    }
                
                private:
                    SpanList::const_iterator _real;
                    SpanList::const_iterator _end;
                    int _cx;
                    int _cy;
                    bool _forward;
                };
                
                
                /*
                 // Check symmetrizeFootprint by computing truth naively.
                     // compute correct answer dumbly
                     det::Footprint truefoot;
                     geom::Box2I bbox = foot.getBBox();
                     for (int y=bbox.getMinY(); y<=bbox.getMaxY(); y++) {
                     for (int x=bbox.getMinX(); x<=bbox.getMaxX(); x++) {
                     int dy = y - cy;
                     int dx = x - cx;
                     int x2 = cx - dx;
                     int y2 = cy - dy;
                     if (foot.contains(geom::Point2I(x,  y)) &&
                     foot.contains(geom::Point2I(x2, y2))) {
                     truefoot.addSpan(y, x, x);
                     }
                     }
                     }
                     truefoot.normalize();
                
                     SpanList sp1 = truefoot.getSpans();
                     SpanList sp2 = sfoot->getSpans();
                     for (SpanList::const_iterator spit1 = sp1.begin(),
                     spit2 = sp2.begin();
                     spit1 != sp1.end() && spit2 != sp2.end();
                     spit1++, spit2++) {
                     //printf("\n");
                     printf(" true   y %i, x [%i, %i]\n", (*spit1)->getY(), (*spit1)->getX0(), (*spit1)->getX1());
                     printf(" sfoot  y %i, x [%i, %i]\n", (*spit2)->getY(), (*spit2)->getX0(), (*spit2)->getX1());
                     if (((*spit1)->getY()  != (*spit2)->getY()) ||
                     ((*spit1)->getX0() != (*spit2)->getX0()) ||
                     ((*spit1)->getX1() != (*spit2)->getX1())) {
                     printf("*******************************************\n");
                     }
                     }
                     assert(sp1.size() == sp2.size());
                     for (SpanList::const_iterator spit1 = sp1.begin(),
                     spit2 = sp2.begin();
                     spit1 != sp1.end() && spit2 != sp2.end();
                     spit1++, spit2++) {
                     assert((*spit1)->getY()  == (*spit2)->getY());
                     assert((*spit1)->getX0() == (*spit2)->getX0());
                     assert((*spit1)->getX1() == (*spit2)->getX1());
                     }
                 */
                
                /**
                 Given a Footprint *foot* and peak *cx*,*cy*, returns a Footprint that
                 is symmetric around the peak (with twofold rotational symmetry) --
                 the AND of the two symmetric halves.
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                PTR(lsst::afw::detection::Footprint)
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                symmetrizeFootprint(
                    det::Footprint const& foot,
                    int cx, int cy) {
                
                    typedef typename det::Footprint::SpanList SpanList;
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
876  <a href="#e3cd0cbe">e3cd0cbe</a> -     PTR(det::Footprint) sfoot(new det::Footprint(foot.getPeaks().getSchema()));</div>
              ?                                                 -----------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
876  <a href="#87afb3f1">87afb3f1</a> +     PTR(det::Footprint) sfoot(new det::Footprint);</div>
                    const SpanList spans = foot.getSpans();
                    assert(foot.isNormalized());
                
                    pexLog::Log log(pexLog::Log::getDefaultLog(),
                                    "lsst.meas.deblender.symmetrizeFootprint");
                
                    // Find the Span containing the peak.
                    PTR(det::Span) target(new det::Span(cy, cx, cx));
                    SpanList::const_iterator peakspan =
                        std::upper_bound(spans.begin(), spans.end(), target, span_ptr_compare);
                    // upper_bound returns the last position where "target" could be inserted;
                    // ie, the first Span larger than "target".  The Span containing "target"
                    // should be peakspan-1 or (if the peak is on the first pixel in the span,
                    // peakspan.
                    PTR(det::Span) sp;
                    if (peakspan == spans.begin()) {
                        sp = *peakspan;
                        if (!sp->contains(cx, cy)) {
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
895  <a href="#8846f794">8846f794</a> +             log.warnf(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
895  <a href="#81146de8">81146de8</a> -             log.warnf("Failed to find span containing (%i,%i): before the beginning of this footprint", cx, cy);</div>
              ?             ^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
896  <a href="#8846f794">8846f794</a> +                 "Failed to find span containing (%i,%i): before the beginning of this footprint", cx, cy);</div>
              ?             ^^^^
                            return PTR(det::Footprint)();
                        }
                    } else {
                        --peakspan;
                        sp = *peakspan;
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
902  <a href="#7cc468fd">7cc468fd</a> -         if (!sp->contains(cx,cy)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
903  <a href="#c39062da">c39062da</a> +         if (!sp->contains(cx, cy)) {</div>
              ?                              +
                            ++peakspan;
                            sp = *peakspan;
                            if (!sp->contains(cx, cy)) {
                                geom::Box2I fbb = foot.getBBox();
                                log.warnf("Failed to find span containing (%i,%i): nearest is %i, [%i,%i].  "
                                          "Footprint bbox is [%i,%i],[%i,%i]",
                                          cx, cy, sp->getY(), sp->getX0(), sp->getX1(),
                                          fbb.getMinX(), fbb.getMaxX(), fbb.getMinY(), fbb.getMaxY());
                                return PTR(det::Footprint)();
                            }
                        }
                    }
                    log.debugf("Span containing (%i,%i): (x=[%i,%i], y=%i)",
                               cx, cy, sp->getX0(), sp->getX1(), sp->getY());
                
                    // The symmetric templates are essentially an AND of the footprint
                    // pixels and its 180-degree-rotated self, rotated around the
                    // peak (cx,cy).
                    //
                    // We iterate forward and backward simultaneously, starting from
                    // the span containing the peak and moving out, row by row.
                    // 
                    // In the loop below, we search for the next pair of Spans that
                    // overlap (in "dx" from the center), output the overlapping
                    // portion of the Spans, and advance either the "fwd" or "back"
                    // iterator.  When we fail to find an overlapping pair of Spans,
                    // we move on to the next row.
                    //
                    // [The following paragraph is somewhat obsoleted by the
                    // RelativeSpanIterator class, which performs some of the renaming
                    // and the dx,dy coords.]
                    //
                    // '''In reading the code, "forward", "advancing", etc, are all
                    // from the perspective of the "fwd" iterator (the one going
                    // forward through the Span list, from low to high Y and then low
                    // to high X).  It will help to imagine making a copy of the
                    // footprint and rotating it around the center pixel by 180
                    // degrees, so that "fwd" and "back" are both iterating the same
                    // direction; we're then just finding the AND of those two
                    // iterators, except we have to work in dx,dy coordinates rather
                    // than original x,y coords, and the accessors for "back" are
                    // opposite.'''
                
                    RelativeSpanIterator fwd (peakspan, spans, cx, cy, true);
                    RelativeSpanIterator back(peakspan, spans, cx, cy, false);
                
                    int dy = 0;
                    while (fwd.notDone() && back.notDone()) {
                        // forward and backward "y"; just symmetric around cy
                        int fy = cy + dy;
                        int by = cy - dy;
                        // delta-x of the beginnings of the spans, for "fwd" and "back"
                        int fdxlo =  fwd.dxlo();
                        int bdxlo = back.dxlo();
                
                        // First find:
                        //    fend -- first span in the next row, or end(); ie,
                        //            the end of this row in the forward direction
                        //    bend -- the end of this row in the backward direction
                        RelativeSpanIterator fend, bend;
                        for (fend = fwd; fend.notDone(); ++fend) {
                            if (fend.dy() != dy)
                                break;
                        }
                        for (bend = back; bend.notDone(); ++bend) {
                            if (bend.dy() != dy)
                                break;
                        }
                
                        log.debugf("dy=%i, fy=%i, fx=[%i, %i],   by=%i, fx=[%i, %i],  fdx=%i, bdx=%i",
                                   dy, fy, fwd.x0(), fwd.x1(), by, back.x0(), back.x1(),
                                   fdxlo, bdxlo);
                
                        // Find possibly-overlapping span
                        if (bdxlo > fdxlo) {
                            log.debugf("Advancing forward.");
                            // While the "forward" span is entirely to the "left" of the "backward" span,
                            // (in dx coords), ie, |---fwd---X   X---back---|
                            // and we are comparing the edges marked X
                            while ((fwd != fend) && (fwd.dxhi() < bdxlo)) {
                                fwd++;
                                if (fwd == fend) {
                                    log.debugf("Reached fend");
                                } else {
                                    log.debugf("Advanced to forward span %i, [%i, %i]",
                                               fy, fwd.x0(), fwd.x1());
                                }
                            }
                        } else if (fdxlo > bdxlo) {
                            log.debugf("Advancing backward.");
                            // While the "backward" span is entirely to the "left" of the "foreward" span,
                            // (in dx coords), ie, |---back---X   X---fwd---|
                            // and we are comparing the edges marked X
                            while ((back != bend) && (back.dxhi() < fdxlo)) {
                                back++;
                                if (back == bend) {
                                    log.debugf("Reached bend");
                                } else {
                                    log.debugf("Advanced to backward span %i, [%i, %i]",
                                               by, back.x0(), back.x1());
                                }
                            }
                        }
                
                        if ((back == bend) || (fwd == fend)) {
                            // We reached the end of the row without finding spans that could
                            // overlap.  Move onto the next dy.
                            if (back == bend) {
                                log.debugf("Reached bend");
                            }
                            if (fwd == fend) {
                                log.debugf("Reached fend");
                            }
                            back = bend;
                            fwd  = fend;
                            dy++;
                            continue;
                        }
                
                        // Spans may overlap -- find the overlapping part.
                        int dxlo = std::max(fwd.dxlo(), back.dxlo());
                        int dxhi = std::min(fwd.dxhi(), back.dxhi());
                        if (dxlo <= dxhi) {
                            log.debugf("Adding span fwd %i, [%i, %i],  back %i, [%i, %i]",
                                       fy, cx+dxlo, cx+dxhi, by, cx-dxhi, cx-dxlo);
                            sfoot->addSpan(fy, cx + dxlo, cx + dxhi);
                            sfoot->addSpan(by, cx - dxhi, cx - dxlo);
                        }
                
                        // Advance the one whose "hi" edge is smallest
                        if (fwd.dxhi() < back.dxhi()) {
                            fwd++;
                            if (fwd == fend) {
                                log.debugf("Stepped to fend");
                            } else {
                                log.debugf("Stepped forward to span %i, [%i, %i]",
                                           fwd.y(), fwd.x0(), fwd.x1());
                            }
                        } else {
                            back++;
                            if (back == bend) {
                                log.debugf("Stepped to bend");
                            } else {
                                log.debugf("Stepped backward to span %i, [%i, %i]",
                                           back.y(), back.x0(), back.x1());
                            }
                        }
                
                        if ((back == bend) || (fwd == fend)) {
                            // Reached the end of the row.  On to the next dy!
                            if (back == bend) {
                                log.debugf("Reached bend");
                            }
                            if (fwd == fend) {
                                log.debugf("Reached fend");
                            }
                            back = bend;
                            fwd  = fend;
                            dy++;
                            continue;
                        }
                
                    }
                    sfoot->normalize();
                    return sfoot;
                }
                
                /**
                 Given an *img*, footprint *foot*, and *peak*, creates a symmetric
                 template around the peak; produce a MaskedImage and Footprint
                 describing a footprint where:
                   output pixels (cx + dx, cy + dy) and (cx - dx, cy - dy)
                   = min(input pixels (cx + dx, cy + dy) and (cx - dx, cy - dy))
                
                 For pixels that are pulled down by more than 1 sigma, the SYMM_1SIG
                 bit is set; for pixels pulled down by more than 3 sigma, SYMM_3SIG.
                
                 If *patchEdge* is true and if the footprint touches pixels with the
                 EDGE bit set, then for spans whose symmetric mirror are outside the
                 image, the symmetric footprint is grown to include them and their
                 pixel values are stored.
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                std::pair<typename PTR(lsst::afw::image::MaskedImage<ImagePixelT,MaskPixelT,VariancePixelT>),
                          typename PTR(lsst::afw::detection::Footprint) >
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                buildSymmetricTemplate(
                    MaskedImageT const& img,
                    det::Footprint const& foot,
                    det::PeakRecord const& peak,
                    double sigma1,
                    bool minZero,
                    bool patchEdge,
                    bool* patchedEdges) {
                
                    typedef typename MaskedImageT::const_xy_locator xy_loc;
                    typedef typename det::Footprint::SpanList SpanList;
                
                    *patchedEdges = false;
                
                    int cx = peak.getIx();
                    int cy = peak.getIy();
                
                    pexLog::Log log(pexLog::Log::getDefaultLog(),
                                    "lsst.meas.deblender.symmetricFootprint");
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1109 <a href="#0609735f">0609735f</a> -     if (!img.getBBox(image::PARENT).contains(foot.getBBox())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1110 <a href="#0609735f">0609735f</a> -         throw LSST_EXCEPT(lsst::pex::exceptions::LengthErrorException, "Image too small for footprint");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1111 <a href="#0609735f">0609735f</a> -     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1112 <a href="#0609735f">0609735f</a> - </div>
                    FootprintPtrT sfoot = symmetrizeFootprint(foot, cx, cy);
                    if (!sfoot) {
                        return std::pair<MaskedImagePtrT, FootprintPtrT>(MaskedImagePtrT(), sfoot);
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1116 <a href="#81146de8">81146de8</a> -     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1117 <a href="#0609735f">0609735f</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1118 <a href="#0609735f">0609735f</a> -     if (!img.getBBox(image::PARENT).contains(sfoot->getBBox())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1119 <a href="#0609735f">0609735f</a> -         throw LSST_EXCEPT(lsst::pex::exceptions::LengthErrorException,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1120 <a href="#0609735f">0609735f</a> -                           "Image too small for symmetrized footprint");</div>
                    }
                    const SpanList spans = sfoot->getSpans();
                
                    // does this footprint touch an EDGE?
                    bool touchesEdge = false;
                    if (patchEdge) {
                        log.debugf("Checking footprint for EDGE bits");
                        MaskPtrT mask = img.getMask();
                        bool edge = false;
                        MaskPixelT edgebit = mask->getPlaneBitMask("EDGE");
                        for (SpanList::const_iterator fwd=spans.begin();
                             fwd != spans.end(); ++fwd) {
                            int x0 = (*fwd)->getX0();
                            int x1 = (*fwd)->getX1();
                            typename MaskT::x_iterator xiter =
                                mask->x_at(x0 - mask->getX0(), (*fwd)->getY() - mask->getY0());
                            for (int x=x0; x<=x1; ++x, ++xiter) {
                                if ((*xiter) & edgebit) {
                                    edge = true;
                                    break;
                                }
                            }
                            if (edge)
                                break;
                        }
                        if (edge) {
                            log.debugf("Footprint includes an EDGE pixel.");
                            touchesEdge = true;
                        }
                    }
                
                    // The result image:
                    MaskedImagePtrT timg(new MaskedImageT(sfoot->getBBox()));
                
                    MaskPixelT symm1sig = img.getMask()->getPlaneBitMask("SYMM_1SIG");
                    MaskPixelT symm3sig = img.getMask()->getPlaneBitMask("SYMM_3SIG");
                
                    SpanList::const_iterator fwd  = spans.begin();
                    SpanList::const_iterator back = spans.end()-1;
                
                    ImagePtrT theimg = img.getImage();
                    ImagePtrT targetimg  = timg->getImage();
                    MaskPtrT  targetmask = timg->getMask();
                
                    for (; fwd <= back; fwd++, back--) {
                        int fy = (*fwd)->getY();
                        int by = (*back)->getY();
                
                        for (int fx=(*fwd)->getX0(), bx=(*back)->getX1();
                             fx <= (*fwd)->getX1();
                             fx++, bx--) {
                            // FIXME -- CURRENTLY WE IGNORE THE MASK PLANE!  options
                            // include ORing the mask bits, or being clever about
                            // ignoring some masked pixels, or copying the mask bits
                            // of the min pixel
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1177 <a href="#0609735f">0609735f</a> -             // We have already checked the bounding box, so this should always be satisfied</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1178 <a href="#0609735f">0609735f</a> -             assert(theimg->getBBox(image::PARENT).contains(geom::Point2I(fx, fy)));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1179 <a href="#0609735f">0609735f</a> -             assert(theimg->getBBox(image::PARENT).contains(geom::Point2I(bx, by)));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1180 <a href="#0609735f">0609735f</a> - </div>
                            // FIXME -- we could do this with image iterators instead.
                            // But first profile to show that it's necessary and an
                            // improvement.
                            ImagePixelT pixf = theimg->get0(fx, fy);
                            ImagePixelT pixb = theimg->get0(bx, by);
                            ImagePixelT pix = std::min(pixf, pixb);
                            if (minZero) {
                                pix = std::max(pix, static_cast<ImagePixelT>(0));
                            }
                            targetimg->set0(fx, fy, pix);
                            targetimg->set0(bx, by, pix);
                
                            // Set the "symm1sig" mask bit for pixels that have been
                            // pulled down at least 1 sigma by the symmetry
                            // constraint, and the "symm3sig" mask bit for pixels
                            // pulled down by 3 sigma or more.
                            if (pixf >= pix + 1.*sigma1) {
                                targetmask->set0(fx, fy, targetmask->get0(fx, fy) | symm1sig);
                                if (pixf >= pix + 3.*sigma1) {
                                    targetmask->set0(fx, fy, targetmask->get0(fx, fy) | symm3sig);
                                }
                            }
                            if (pixb >= pix + 1.*sigma1) {
                                targetmask->set0(bx, by, targetmask->get0(bx, by) | symm1sig);
                                if (pixb >= pix + 3.*sigma1) {
                                    targetmask->set0(bx, by, targetmask->get0(bx, by) | symm3sig);
                                }
                            }
                        }
                    }
                
                
                    if (touchesEdge) {
                        // Find spans whose mirrors fall outside the image bounds,
                        // grow the footprint to include those spans, and plug in
                        // their pixel values.
                        geom::Box2I bb = sfoot->getBBox();
                
                        // Actually, it's not necessarily the IMAGE bounds that count
                        //-- the footprint may not go right to the image edge.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1221 <a href="#7cc85f7d">7cc85f7d</a> -         //geom::Box2I imbb = img.getBBox(image::PARENT);</div>
              ?                                          -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1209 <a href="#5ea010ad">5ea010ad</a> +         //geom::Box2I imbb = img.getBBox();</div>
                        geom::Box2I imbb = foot.getBBox();
                
                        log.debugf("Footprint touches EDGE: start bbox [%i,%i],[%i,%i]",
                                   bb.getMinX(), bb.getMaxX(), bb.getMinY(), bb.getMaxY());
                        // original footprint spans
                        const SpanList ospans = foot.getSpans();
                        for (fwd = ospans.begin(); fwd != ospans.end(); ++fwd) {
                            int y = (*fwd)->getY();
                            int x = (*fwd)->getX0();
                            // mirrored coords
                            int ym = cy + (cy - y);
                            int xm = cx + (cx - x);
                            if (!imbb.contains(geom::Point2I(xm, ym))) {
                                bb.include(geom::Point2I(x, y));
                            }
                            x = (*fwd)->getX1();
                            xm = cx + (cx - x);
                            if (!imbb.contains(geom::Point2I(xm, ym))) {
                                bb.include(geom::Point2I(x, y));
                            }
                        }
                        log.debugf("Footprint touches EDGE: grown bbox [%i,%i],[%i,%i]",
                                   bb.getMinX(), bb.getMaxX(), bb.getMinY(), bb.getMaxY());
                
                        // New template image
                        MaskedImagePtrT timg2(new MaskedImageT(bb));
                        copyWithinFootprint(*sfoot, timg, timg2);
                
                        log.debugf("Symmetric footprint spans:");
                        const SpanList sspans = sfoot->getSpans();
                        for (fwd = sspans.begin(); fwd != sspans.end(); ++fwd) {
                            log.debugf("  %s", (*fwd)->toString().c_str());
                        }
                
                        // copy original 'img' pixels for the portion of spans whose
                        // mirrors are out of bounds.
                        for (fwd = ospans.begin(); fwd != ospans.end(); ++fwd) {
                            int y   = (*fwd)->getY();
                            int x0  = (*fwd)->getX0();
                            int x1 = (*fwd)->getX1();
                            // mirrored coords
                            int ym  = cy + (cy - y);
                            int xm0 = cx + (cx - x0);
                            int xm1 = cx + (cx - x1);
                            bool in0 = imbb.contains(geom::Point2I(xm0, ym));
                            bool in1 = imbb.contains(geom::Point2I(xm1, ym));
                            if (in0 && in1) {
                                // both endpoints of the symmetric span are in bounds; nothing to do
                                continue;
                            }
                            // clip to the part of the span where the mirror is out of bounds
                            if (in0) {
                                // the mirror of x0 is in-bounds; move x0 to be the first pixel
                                // whose mirror would be out-of-bounds
                                x0 = cx + (cx - (imbb.getMinX() - 1));
                            }
                            if (in1) {
                                x1 = cx + (cx - (imbb.getMaxX() + 1));
                            }
                            log.debugf("Span y=%i, x=[%i,%i] has mirror (%i,[%i,%i]) out-of-bounds; clipped to %i,[%i,%i]",
                                       y, (*fwd)->getX0(), (*fwd)->getX1(), ym, xm1, xm0, y, x0, x1);
                            typename MaskedImageT::x_iterator initer =
                                img.x_at(x0 - img.getX0(), y - img.getY0());
                            typename MaskedImageT::x_iterator outiter =
                                timg2->x_at(x0 - timg2->getX0(), y - timg2->getY0());
                            for (int x=x0; x<=x1; ++x, ++outiter, ++initer) {
                                *outiter = *initer;
                            }
                            sfoot->addSpan(y, x0, x1);
                        }
                        sfoot->normalize();
                        timg = timg2;
                    }
                
                    *patchedEdges = touchesEdge;
                    return std::pair<MaskedImagePtrT, FootprintPtrT>(timg, sfoot);
                }
                
                /**
                 Returns true if the given Footprint *sfoot* in image *img* has flux
                 above value *thresh* at its edge.
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                bool
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                hasSignificantFluxAtEdge(ImagePtrT img,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1308 <a href="#81146de8">81146de8</a> -                          det::Footprint::Ptr sfoot,</div>
              ?                                        ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1296 <a href="#a8c50f30">a8c50f30</a> +                          PTR(det::Footprint) sfoot,</div>
              ?                          ++++              ^
                                         ImagePixelT thresh) {
                    typedef typename det::Footprint::SpanList SpanList;
                
                    pexLog::Log log(pexLog::Log::getDefaultLog(),
                                    "lsst.meas.deblender.hasSignificantFluxAtEdge");
                
                    // Find edge template pixels with significant flux -- perhaps
                    // because their symmetric pixels were outside the footprint?
                    // (clipped by an image edge, etc)
                
                    const SpanList spans = sfoot->getSpans();
                    for (SpanList::const_iterator sp = spans.begin();
                         sp != spans.end(); ++sp) {
                        // We first search for significant pixels, and then check
                        // whether they are on the edge of the footprint.
                        // We have to check above and below all pixels and left and
                        // right of the end pixels.  Faster to do this in image space?
                        // (Inserting footprint into image, operating on image,
                        // re-grabbing footprint, like growFootprint) Or cache the
                        // span starts and ends of a sliding window of rows?
                        int y  = (*sp)->getY();
                        int x0 = (*sp)->getX0();
                        int x1 = (*sp)->getX1();
                        int x;
                        typename ImageT::const_x_iterator xiter;
                        for (xiter = img->x_at(x0 - img->getX0(), y - img->getY0()), x=x0; 
                             x<=x1; ++x, ++xiter) {
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1337 <a href="#576ca540">576ca540</a> -             assert(img->getBBox(image::PARENT).contains(geom::Point2I(x, y)));</div>
              ?                                 -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1325 <a href="#5ea010ad">5ea010ad</a> +             assert(img->getBBox().contains(geom::Point2I(x, y)));</div>
                
                            if (*xiter < thresh)
                                // not significant
                                continue;
                            // Since the footprint is normalized, all span endpoints
                            // are on the boundary.
                            if ((x != x0) && (x != x1) &&
                                sfoot->contains(geom::Point2I(x, y-1)) &&
                                sfoot->contains(geom::Point2I(x, y+1))) {
                                // not edge
                                continue;
                            }
                            log.debugf("Found significant template-edge pixel: %i,%i = %f > %f",
                                       x, y, (float)*xiter, (float)thresh);
                            return true;
                        }
                    }
                    return false;
                }
                
                /**
                 Returns a list of pixels that are on the edge of the given Footprint
                 *sfoot* in image *img*, above threshold *thresh*.
                 */
                template<typename ImagePixelT, typename MaskPixelT, typename VariancePixelT>
                boost::shared_ptr<det::Footprint>
                deblend::BaselineUtils<ImagePixelT,MaskPixelT,VariancePixelT>::
                getSignificantEdgePixels(ImagePtrT img,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1366 <a href="#81146de8">81146de8</a> -                          det::Footprint::Ptr sfoot,</div>
              ?                                        ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1354 <a href="#a8c50f30">a8c50f30</a> +                          PTR(det::Footprint) sfoot,</div>
              ?                          ++++              ^
                                         ImagePixelT thresh) {
                    typedef typename det::Footprint::SpanList SpanList;
                    pexLog::Log log(pexLog::Log::getDefaultLog(),
                                    "lsst.meas.deblender.getSignificantEdgePixels");
                    sfoot->normalize();
                    const SpanList spans = sfoot->getSpans();
                    SpanList::const_iterator sp;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1374 <a href="#e3cd0cbe">e3cd0cbe</a> -     PTR(det::Footprint) edgepix(new det::Footprint(sfoot->getPeaks().getSchema()));</div>
              ?                                                    -----------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1362 <a href="#a8c50f30">a8c50f30</a> +     PTR(det::Footprint) edgepix(new det::Footprint());</div>
                
                    for (sp = spans.begin(); sp != spans.end(); sp++) {
                        int y  = (*sp)->getY();
                        int x0 = (*sp)->getX0();
                        int x1 = (*sp)->getX1();
                        int x;
                        typename ImageT::const_x_iterator xiter;
                        for (xiter = img->x_at(x0 - img->getX0(), y - img->getY0()), x=x0;
                             x<=x1; ++x, ++xiter) {
                            if (*xiter < thresh)
                                // not significant
                                continue;
                            // Since the footprint is normalized, all span endpoints
                            // are on the boundary.
                            if ((x != x0) && (x != x1) &&
                                sfoot->contains(geom::Point2I(x, y-1)) &&
                                sfoot->contains(geom::Point2I(x, y+1))) {
                                // not edge
                                continue;
                            }
                            log.debugf("Found significant edge pixel: %i,%i = %f > thresh %g",
                                       x, y, (float)*xiter, (float)thresh);
                            edgepix->addSpanInSeries(y, x, x);
                        }
                    }
                    return edgepix;
                }
                
                // Instantiate
                template class deblend::BaselineUtils<float>;
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="b606deab"/></a>b606deab</h3>

<pre>
commit b606deab6b402a542ffdf2720a84cf48491508b1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Apr 11 14:44:27 2014 -0400

    add config option for how to split stray flux; add NEAREST_FOOTPRINT option; reduce default max number of pixels
</pre>
<h3><a name="7cc85f7d"/></a>7cc85f7d</h3>

<pre>
commit 7cc85f7d59fa9f8353e1832d9256bad3ef501cc7
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jan 13 13:40:44 2014 -0600

    tweak the patch-edges code -- footprint bounds rather than image bounds; and better comments
</pre>
<h3><a name="e3cd0cbe"/></a>e3cd0cbe</h3>

<pre>
commit e3cd0cbe51794935b2b3ac6ef9b8393f27f7dd34
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Mon Dec 22 14:46:51 2014 -0500

    Ensure deblender Footprint-creators preserve peak schema
    
    Deblender operations that create new Footprints need to maintain
    the peak schema of the footprints they start with.  Usually this
    is handled by using the Footprint copy constructor, but not always.
</pre>
<h3><a name="7cc468fd"/></a>7cc468fd</h3>

<pre>
commit 7cc468fd73fff9940d9d83b6bd806ab6c1b6ccc6
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Dec 10 19:11:36 2014 -0500

    Fix logic in searching for Span containing Peak
    
    Previous logic overlooked the possibility that the Peak
    corresponded to the first pixel in its Span, causing
    the deblender to think the Peak was not within the
    Footprint.
</pre>
<h3><a name="8f605f1f"/></a>8f605f1f</h3>

<pre>
commit 8f605f1ff03b2a72f0b783cf36f086bc47005139
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 13:57:01 2014 -0400

    pull out summing templates, and finding stray flux
</pre>
<h3><a name="81146de8"/></a>81146de8</h3>

<pre>
commit 81146de84332da7da0306fddfa9648877eb8ef21
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Oct 21 15:23:56 2013 -0400

    replace tabs by spaces
</pre>
<h3><a name="519fee6c"/></a>519fee6c</h3>

<pre>
commit 519fee6c6ec16212d8437696b33bf3fa7cc1e8b0
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 15:53:56 2014 -0400

    whoops, whitespace
</pre>
<h3><a name="7b331d27"/></a>7b331d27</h3>

<pre>
commit 7b331d277a9909540cbaef36ce593be7a86935b4
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Feb 17 16:57:12 2012 -0500

    start gluing in Sdss adaptive moments code
</pre>
<h3><a name="576ca540"/></a>576ca540</h3>

<pre>
commit 576ca5408d33d93fb051410552fcf24c7a72f9fb
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jan 7 13:37:30 2014 -0600

    huge amount of debugging trying to figure out image offset problems and expanded footprint bounding-boxes
</pre>
<h3><a name="0609735f"/></a>0609735f</h3>

<pre>
commit 0609735fa90b5449198bc4ab0f18e181fc4e5cda
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Sep 17 12:47:09 2014 -0400

    buildSymmetricTemplate: guard against over-sized footprints
    
    buildSymmetricTemplate now throws exceptions if the footprint
    is too large for the image (and would therefore cause memory
    problems).
</pre>
<h3><a name="d6945e7a"/></a>d6945e7a</h3>

<pre>
commit d6945e7a9eb475df05a01e1cba0d2c33965291cf
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jan 6 18:20:50 2014 -0500

    Add more doxygen documentation for Baseline.cc functions
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="8846f794"/></a>8846f794</h3>

<pre>
commit 8846f794165e6d6ee2e17b168e3f7395aee71fa3
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 24 16:58:43 2014 -0700

    Responded to Jim's review by shortening some lines.
</pre>
<h3><a name="a8c50f30"/></a>a8c50f30</h3>

<pre>
commit a8c50f3027265721d8abb82b53ec4c384372d88e
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jun 24 12:24:44 2014 -0500

    Switch some ::Ptr to PTR()
</pre>
<h3><a name="87afb3f1"/></a>87afb3f1</h3>

<pre>
commit 87afb3f1b6c619e02c78d228f278e27844074fb6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Nov 19 19:10:28 2013 -0600

    Change foo::Ptr to PTR(foo) to help swig 2.0.11
</pre>
<h3><a name="c39062da"/></a>c39062da</h3>

<pre>
commit c39062da3b52b0f1ae74731929eed29979a2c981
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Dec 10 19:11:36 2014 -0500

    Fix logic in searching for Span containing Peak
    
    Previous logic overlooked the possibility that the Peak
    corresponded to the first pixel in its Span, causing
    the deblender to think the Peak was not within the
    Footprint.
    
    Conflicts:
        src/Baseline.cc
</pre>
<h3><a name="d19f42f0"/></a>d19f42f0</h3>

<pre>
commit d19f42f0b59463b53fca202a48008f778d36bba1
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:32 2014 -0700

    Renamed exceptions
</pre>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_4"><a name="examples/designdoc.py"/></a>examples/designdoc.py</h1>

<h3 id="toc_5">Diff:</h3>

<pre>
                import matplotlib
                matplotlib.use('Agg')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#d12545da">d12545da</a> - from matplotlib.patches import Ellipse</div>
                import pylab as plt
                import numpy as np
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#d12545da">d12545da</a> - import math</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#d12545da">d12545da</a> - import lsst.pipe.base as pipeBase</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#d12545da">d12545da</a> - import lsst.pipe.tasks.processCcd as procCcd</div>
                import lsst.pex.logging as pexLog
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
10   <a href="#d12545da">d12545da</a> - import lsst.daf.base as dafBase</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#d12545da">d12545da</a> - import lsst.afw.table as afwTable</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#d12545da">d12545da</a> - import lsst.afw.math  as afwMath</div>
                import lsst.afw.image as afwImage
                import lsst.afw.detection as afwDet
                
                from utils import *
                from suprime import *
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#d12545da">d12545da</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#dde33c6e">dde33c6e</a> - from lsst.afw.detection import Psf</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#dde33c6e">dde33c6e</a> - from lsst.meas.algorithms import * #pcaPsf</div>
                
                def main():
                    '''
                    Runs the deblender and creates plots for the "design document",
                    doc/design.tex.  See the file NOTES for how to get set up to the
                    point where you can actually run this on data.
                    '''
                
                    from optparse import OptionParser
                    parser = OptionParser()
                    parser.add_option('--root', dest='root', help='Root directory for Subaru data')
                    parser.add_option('--outroot', '-o', dest='outroot', help='Output root directory for Subaru data')
                    parser.add_option('--sources', help='Read a FITS table of sources')
                    parser.add_option('--calexp', help='Read a FITS calexp')
                    parser.add_option('--psf', help='Read a FITS PSF')
                
                    parser.add_option('--drill', '-D', dest='drill', action='append', type=str, default=[],
                                      help='Drill down on individual source IDs')
                    parser.add_option('--drillxy', dest='drillxy', action='append', type=str, default=[],
                                      help='Drill down on individual source positions, eg 132,46;54,67')
                    parser.add_option('--visit', dest='visit', type=int, default=108792, help='Suprimecam visit id')
                    parser.add_option('--ccd', dest='ccd', type=int, default=5, help='Suprimecam CCD number')
                    parser.add_option('--prefix', dest='prefix', default='design-', help='plot filename prefix')
                    parser.add_option('--suffix', dest='suffix', default=None, help='plot filename suffix (default: ".png")')
                    parser.add_option('--pat', dest='pat', help='Plot filename pattern: eg, "design-%(pid)04i-%(name).png"; overrides --prefix and --suffix')
                    parser.add_option('--pdf', dest='pdf', action='store_true', default=False, help='save in PDF format?')
                    parser.add_option('-v', dest='verbose', action='store_true')
                    parser.add_option('--figw', dest='figw', type=float, help='Figure window width (inches)',
                                      default=4.)
                    parser.add_option('--figh', dest='figh', type=float, help='Figure window height (inches)',
                                      default=4.)
                    parser.add_option('--order', dest='order', type=str, help='Child order: eg 3,0,1,2')
                
                    parser.add_option('--sdss', dest='sec', action='store_const', const='sdss',
                                      help='Produce plots for the SDSS section.')
                    parser.add_option('--mono', dest='sec', action='store_const', const='mono',
                                      help='Produce plots for the "monotonic" section.')
                    parser.add_option('--median', dest='sec', action='store_const', const='median',
                                      help='Produce plots for the "median filter" section.')
                    parser.add_option('--ramp', dest='sec', action='store_const', const='ramp',
                                      help='Produce plots for the "ramp edges" section.')
                    parser.add_option('--ramp2', dest='sec', action='store_const', const='ramp2',
                                      help='Produce plots for the "ramp edges + stray flux" section.')
                    parser.add_option('--patch', dest='sec', action='store_const', const='patch',
                                      help='Produce plots for the "patch edges" section.')
                
                    opt,args = parser.parse_args()
                
                    # Logging
                    root = pexLog.Log.getDefaultLog()
                    if opt.verbose:
                        root.setThreshold(pexLog.Log.DEBUG)
                    else:
                        root.setThreshold(pexLog.Log.INFO)
                    # Quiet some of the more chatty loggers
                    pexLog.Log(root, 'lsst.meas.deblender.symmetrizeFootprint',
                                   pexLog.Log.INFO)
                    #pexLog.Log(root, 'lsst.meas.deblender.symmetricFootprint',
                    #               pexLog.Log.INFO)
                    pexLog.Log(root, 'lsst.meas.deblender.getSignificantEdgePixels',
                                   pexLog.Log.INFO)
                    pexLog.Log(root, 'afw.Mask', pexLog.Log.INFO)
                
                
                    if opt.sec is None:
                        opt.sec = 'sdss'
                    if opt.pdf:
                        if opt.suffix is None:
                            opt.suffix = ''
                        opt.suffix += '.pdf'
                    if not opt.suffix:
                        opt.suffix = '.png'
                
                    if opt.pat:
                        plotpattern = opt.pat
                    else:
                        plotpattern = opt.prefix + '%(pid)04i-%(name)s' + opt.suffix
                
                    if opt.order is not None:
                        opt.order = [int(x) for x in opt.order.split(',')]
                        invorder = np.zeros(len(opt.order))
                        invorder[opt.order] = np.arange(len(opt.order))
                
                    def mapchild(i):
                        if opt.order is None:
                            return i
                        return invorder[i]
                
                    def savefig(pid, figname):
                        fn = plotpattern % dict(pid=pid, name=figname)
                        plt.savefig(fn)
                
                    # Load data using the butler, if desired
                    dr = None
                    if opt.sources is None or opt.calexp is None:
                        print 'Creating DataRef...'
                        dr = getSuprimeDataref(opt.visit, opt.ccd, rootdir=opt.root,
                                               outrootdir=opt.outroot)
                        print 'Got', dr
                
                    # Which parent ids / deblend families are we going to plot?
                    keepids = None
                    if len(opt.drill):
                        keepids = []
                        for d in opt.drill:
                            for dd in d.split(','):
                                keepids.append(int(dd))
                        print 'Keeping parent ids', keepids
                
                    keepxys = None
                    if len(opt.drillxy):
                        keepxys = []
                        for d in opt.drillxy:
                            for dd in d.split(';'):
                                xy = dd.split(',')
                                assert(len(xy) == 2)
                                keepxys.append((int(xy[0]),int(xy[1])))
                        print 'Keeping parents at xy', keepxys
                        
                    # Read from butler or local file
                    cat = readCatalog(opt.sources, None, dataref=dr, keepids=keepids,
                                      keepxys=keepxys, patargs=dict(visit=opt.visit, ccd=opt.ccd))
                    print 'Got', len(cat), 'sources'
                
                    # Load data from butler or local files
                    if opt.calexp is not None:
                        print 'Reading exposure from', opt.calexp
                        exposure = afwImage.ExposureF(opt.calexp)
                    else:
                        exposure = dr.get('calexp')
                    print 'Exposure', exposure
                    mi = exposure.getMaskedImage()
                
                    if opt.psf is not None:
                        print 'Reading PSF from', opt.psf
                        psf = afwDet.Psf.readFits(opt.psf)
                        print 'Got', psf
                    elif dr:
                        psf = dr.get('psf')
                    else:
                        psf = exposure.getPsf()
                        
                
                    sigma1 = get_sigma1(mi)
                
                    fams = getFamilies(cat)
                    print len(fams), 'deblend families'
                    
                    if False:
                        for j,(parent,children) in enumerate(fams):
                            print 'parent', parent
                            print 'children', children
                            plotDeblendFamily(mi, parent, children, cat, sigma1, ellipses=False)
                            fn = '%04i.png' % parent.getId()
                            plt.savefig(fn)
                            print 'wrote', fn
                
                
                
                    def nlmap(X):
                        return np.arcsinh(X / (3.*sigma1))
                    def myimshow(im, **kwargs):
                        kwargs = kwargs.copy()
                        mn = kwargs.get('vmin', -5*sigma1)
                        kwargs['vmin'] = nlmap(mn)
                        mx = kwargs.get('vmax', 100*sigma1)
                        kwargs['vmax'] = nlmap(mx)
                        plt.imshow(nlmap(im), **kwargs)
                    plt.figure(figsize=(opt.figw, opt.figh))
                    plt.subplot(1,1,1)
                    plt.subplots_adjust(left=0.01, right=0.99, bottom=0.01, top=0.99,
                                        wspace=0.05, hspace=0.1)
                
                    # Make plots for each deblend family.
                
                    for j,(parent,children) in enumerate(fams):
                        print 'parent', parent.getId()
                        print 'children', [ch.getId() for ch in children]
                        print 'parent x,y', parent.getX(), parent.getY()
                
                        pid = parent.getId()
                        fp = parent.getFootprint()
                        bb = fp.getBBox()
                        pim = footprintToImage(parent.getFootprint(), mi).getArray()
                        pext = getExtent(bb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#f0b1f87f">f0b1f87f</a> -         px0,py0 = pext[0],pext[2]</div>
                        imargs = dict(interpolation='nearest', origin='lower', vmax=pim.max() * 0.95, vmin=-3.*sigma1)
                        pksty = dict(linestyle='None', marker='+', color='r', mew=3, ms=20, alpha=0.6)
                
                        plt.clf()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#3ad186d8">3ad186d8</a> -         myimshow(afwImage.ImageF(mi.getImage(), bb, afwImage.PARENT).getArray(), **imargs)</div>
              ?                                                   -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#5ea010ad">5ea010ad</a> +         myimshow(afwImage.ImageF(mi.getImage(), bb).getArray(), **imargs)</div>
                        plt.gray()
                        plt.xticks([])
                        plt.yticks([])
                        savefig(pid, 'image')
                        
                        # Parent footprint
                        plt.clf()
                        myimshow(pim, extent=pext, **imargs)
                        plt.gray()
                        pks = fp.getPeaks()
                        plt.plot([pk.getIx() for pk in pks], [pk.getIy() for pk in pks], **pksty)
                        plt.xticks([])
                        plt.yticks([])
                        plt.axis(pext)
                        savefig(pid, 'parent')
                
                        from lsst.meas.deblender.baseline import deblend
                
                        xc = int((bb.getMinX() + bb.getMaxX()) / 2.)
                        yc = int((bb.getMinY() + bb.getMaxY()) / 2.)
                        if hasattr(psf, 'getFwhm'):
                            psf_fwhm = psf.getFwhm(xc, yc)
                        else:
                            psf_fwhm = psf.computeShape().getDeterminantRadius() * 2.35
                            
                        # Each section of the design doc runs the deblender with different args.
                            
                        kwargs = dict(sigma1=sigma1, verbose=opt.verbose,
                                      getTemplateSum=True)
                
                        basic = kwargs.copy()
                        basic.update(fit_psfs=False,
                                     median_smooth_template=False,
                                     monotonic_template=False,
                                     lstsq_weight_templates=False,
                                     findStrayFlux=False,
                                     rampFluxAtEdge=False,
                                     patchEdges=False)
                
                        if opt.sec == 'sdss':
                            # SDSS intro
                            kwargs = basic
                            kwargs.update(lstsq_weight_templates=True)
                                          
                        elif opt.sec == 'mono':
                            kwargs = basic
                            kwargs.update(lstsq_weight_templates=True,
                                          monotonic_template=True)
                        elif opt.sec == 'median':
                            kwargs = basic
                            kwargs.update(lstsq_weight_templates=True,
                                          median_smooth_template=True,
                                          monotonic_template=True)
                        elif opt.sec == 'ramp':
                            kwargs = basic
                            kwargs.update(median_smooth_template=True,
                                          monotonic_template=True,
                                          rampFluxAtEdge=True)
                
                        elif opt.sec == 'ramp2':
                            kwargs = basic
                            kwargs.update(median_smooth_template=True,
                                          monotonic_template=True,
                                          rampFluxAtEdge=True,
                                          findStrayFlux=True,
                                          assignStrayFlux=True)
                
                        elif opt.sec == 'patch':
                            kwargs = basic
                            kwargs.update(median_smooth_template=True,
                                          monotonic_template=True,
                                          patchEdges=True)
                
                        else:
                            raise 'Unknown section: "%s"' % opt.sec
                
                        print 'Running deblender with kwargs:', kwargs
                        res = deblend(fp, mi, psf, psf_fwhm, **kwargs)
                        #print 'got result with', [x for x in dir(res) if not x.startswith('__')]
                        #for pk in res.peaks:
                        #    print 'got peak with', [x for x in dir(pk) if not x.startswith('__')]
                        #    print '  deblend as psf?', pk.deblend_as_psf
                
                        # Find bounding-box of all templates.
                        tbb = fp.getBBox()
                        for pkres,pk in zip(res.peaks, pks):
                            tbb.include(pkres.template_foot.getBBox())
                        print 'Bounding-box of all templates:', tbb
                
                        # Sum-of-templates plot
                        tsum = np.zeros((tbb.getHeight(), tbb.getWidth()))
                        tx0,ty0 = tbb.getMinX(), tbb.getMinY()
                
                        # Sum-of-deblended children plot(s)
                        # "heavy" bbox == template bbox.
                        hsum = np.zeros((tbb.getHeight(), tbb.getWidth()))
                        hsum2 = np.zeros((tbb.getHeight(), tbb.getWidth()))
                
                        # Sum of templates from the deblender itself
                        plt.clf()
                        t = res.templateSum
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#08c0d83e">08c0d83e</a> -         myimshow(t.getArray(), extent=getExtent(t.getBBox(afwImage.PARENT)), **imargs)</div>
              ?                                                           ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#5ea010ad">5ea010ad</a> +         myimshow(t.getArray(), extent=getExtent(t.getBBox()), **imargs)</div>
                        plt.gray()
                        plt.xticks([])
                        plt.yticks([])
                        savefig(pid, 'tsum1')
                
                        # Make plots for each deblended child (peak)
                        
                        k = 0
                        for pkres,pk in zip(res.peaks, pks):
                
                            heavy = pkres.get_flux_portion()
                            if heavy is None:
                                print 'Child has no HeavyFootprint -- skipping'
                                continue
                
                            kk = mapchild(k)
                
                            w = pkres.template_weight
                
                            cfp = pkres.template_foot
                            cbb = cfp.getBBox()
                            cext = getExtent(cbb)
                
                            # Template image
                            tim = pkres.template_mimg.getImage()
                            timext = cext
                            tim = tim.getArray()
                
                            (x0,x1,y0,y1) = timext
                            print 'tim ext', timext
                            tsum[y0-ty0:y1-ty0, x0-tx0:x1-tx0] += tim
                
                            # "Heavy" image -- flux assigned to child
                            him = footprintToImage(heavy).getArray()
                            hext = getExtent(heavy.getBBox())
                
                            (x0,x1,y0,y1) = hext
                            hsum[y0-ty0:y1-ty0, x0-tx0:x1-tx0] += him
                
                            # "Heavy" without stray flux
                            h2 = pkres.get_flux_portion(strayFlux=False)
                            him2 = footprintToImage(h2).getArray()
                            hext2 = getExtent(h2.getBBox())
                            (x0,x1,y0,y1) = hext2
                            hsum2[y0-ty0:y1-ty0, x0-tx0:x1-tx0] += him2
                            
                            if opt.sec == 'median':
                                try:
                                    med = pkres.median_filtered_template
                                except:
                                    med = pkres.orig_template
                
                                for im,nm in [(pkres.orig_template, 'symm'), (med, 'med')]:
                                    #print 'im:', im
                                    plt.clf()
                                    myimshow(im.getArray(), extent=cext, **imargs)
                                    plt.gray()
                                    plt.xticks([])
                                    plt.yticks([])
                                    plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                    plt.axis(pext)
                                    savefig(pid, nm + '%i' % (kk))
                
                            # Template
                            plt.clf()
                            myimshow(pkres.template_mimg.getImage().getArray() / w, extent=cext, **imargs)
                            plt.gray()
                            plt.xticks([])
                            plt.yticks([])
                            plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                            plt.axis(pext)
                            savefig(pid, 't%i' % (kk))
                
                            # Weighted template
                            plt.clf()
                            myimshow(tim, extent=cext, **imargs)
                            plt.gray()
                            plt.xticks([])
                            plt.yticks([])
                            plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                            plt.axis(pext)
                            savefig(pid, 'tw%i' % (kk))
                
                            # "Heavy"
                            plt.clf()
                            myimshow(him, extent=hext, **imargs)
                            plt.gray()
                            plt.xticks([])
                            plt.yticks([])
                            plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                            plt.axis(pext)
                            savefig(pid, 'h%i' % (kk))
                
                            # Original symmetric template
                            plt.clf()
                            t = pkres.orig_template
                            foot = pkres.orig_foot
                            myimshow(t.getArray(), extent=getExtent(foot.getBBox()), **imargs)
                            plt.gray()
                            plt.xticks([])
                            plt.yticks([])
                            plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                            plt.axis(pext)
                            savefig(pid, 'o%i' % (kk))
                
                            if opt.sec == 'patch' and pkres.patched:
                                pass
                            
                            if opt.sec in ['ramp','ramp2'] and pkres.has_ramped_template:
                
                                # Ramped template
                                plt.clf()
                                t = pkres.ramped_template
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
427  <a href="#08c0d83e">08c0d83e</a> -                 myimshow(t.getArray(), extent=getExtent(t.getBBox(afwImage.PARENT)),</div>
              ?                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
416  <a href="#5ea010ad">5ea010ad</a> +                 myimshow(t.getArray(), extent=getExtent(t.getBBox()),</div>
                                         **imargs)
                                plt.gray()
                                plt.xticks([])
                                plt.yticks([])
                                plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                plt.axis(pext)
                                savefig(pid, 'r%i' % (kk))
                
                                # Median-filtered template
                                plt.clf()
                                t = pkres.median_filtered_template
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
439  <a href="#08c0d83e">08c0d83e</a> -                 myimshow(t.getArray(), extent=getExtent(t.getBBox(afwImage.PARENT)),</div>
              ?                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
428  <a href="#5ea010ad">5ea010ad</a> +                 myimshow(t.getArray(), extent=getExtent(t.getBBox()),</div>
                                         **imargs)
                                plt.gray()
                                plt.xticks([])
                                plt.yticks([])
                                plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                plt.axis(pext)
                                savefig(pid, 'med%i' % (kk))
                
                                # Assigned flux
                                plt.clf()
                                t = pkres.portion_mimg.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
451  <a href="#08c0d83e">08c0d83e</a> -                 myimshow(t.getArray(), extent=getExtent(t.getBBox(afwImage.PARENT)),</div>
              ?                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
440  <a href="#5ea010ad">5ea010ad</a> +                 myimshow(t.getArray(), extent=getExtent(t.getBBox()),</div>
                                         **imargs)
                                plt.gray()
                                plt.xticks([])
                                plt.yticks([])
                                plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                plt.axis(pext)
                                savefig(pid, 'p%i' % (kk))
                
                            if opt.sec == 'ramp2':
                                # stray flux
                                if pkres.stray_flux is not None:
                                    s = pkres.stray_flux
                                    strayim = footprintToImage(s).getArray()
                                    strayext = getExtent(s.getBBox())
                
                                    plt.clf()
                                    myimshow(strayim, extent=strayext, **imargs)
                                    plt.gray()
                                    plt.xticks([])
                                    plt.yticks([])
                                    plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                    plt.axis(pext)
                                    savefig(pid, 's%i' % (kk))
                
                                    # Assigned flux, omitting stray flux.
                                    plt.clf()
                                    myimshow(him2, extent=hext2, **imargs)
                                    plt.gray()
                                    plt.xticks([])
                                    plt.yticks([])
                                    plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                                    plt.axis(pext)
                                    savefig(pid, 'hb%i' % (kk))
                
                
                            k += 1
                
                        # sum of templates
                        plt.clf()
                        myimshow(tsum, extent=getExtent(tbb), **imargs)
                        plt.gray()
                        plt.xticks([])
                        plt.yticks([])
                        plt.plot([pk.getIx() for pk in pks], [pk.getIy() for pk in pks], **pksty)
                        plt.axis(pext)
                        savefig(pid, 'tsum')
                
                        # sum of assigned flux
                        plt.clf()
                        myimshow(hsum, extent=getExtent(tbb), **imargs)
                        plt.gray()
                        plt.xticks([])
                        plt.yticks([])
                        plt.plot([pk.getIx() for pk in pks], [pk.getIy() for pk in pks], **pksty)
                        plt.axis(pext)
                        savefig(pid, 'hsum')
                
                        plt.clf()
                        myimshow(hsum2, extent=getExtent(tbb), **imargs)
                        plt.gray()
                        plt.xticks([])
                        plt.yticks([])
                        plt.plot([pk.getIx() for pk in pks], [pk.getIy() for pk in pks], **pksty)
                        plt.axis(pext)
                        savefig(pid, 'hsum2')
                
                        k = 0
                        for pkres,pk in zip(res.peaks, pks):
                            heavy = pkres.get_flux_portion()
                            if heavy is None:
                                continue
                
                            print 'Template footprint:', pkres.template_foot.getBBox()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
525  <a href="#9ae6367c">9ae6367c</a> -             print 'Template img:', pkres.template_mimg.getBBox(afwImage.PARENT)</div>
              ?                                                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
514  <a href="#5ea010ad">5ea010ad</a> +             print 'Template img:', pkres.template_mimg.getBBox()</div>
                            print 'Heavy footprint:', heavy.getBBox()
                
                            cfp = pkres.template_foot
                            cbb = cfp.getBBox()
                            cext = getExtent(cbb)
                            tim = pkres.template_mimg.getImage().getArray()
                            (x0,x1,y0,y1) = cext
                
                            frac = tim / tsum[y0-ty0:y1-ty0, x0-tx0:x1-tx0]
                
                            msk = afwImage.ImageF(cbb.getWidth(), cbb.getHeight())
                            msk.setXY0(cbb.getMinX(), cbb.getMinY())
                            afwDet.setImageFromFootprint(msk, cfp, 1.)
                            msk = msk.getArray()
                            frac[msk == 0.] = np.nan
                
                            # Fraction of flux assigned to this child.
                            plt.clf()
                            plt.imshow(frac, extent=cext, interpolation='nearest', origin='lower', vmin=0, vmax=1)
                            #plt.plot([x0,x0,x1,x1,x0], [y0,y1,y1,y0,y0], 'k-')
                            plt.gray()
                            plt.xticks([])
                            plt.yticks([])
                            plt.plot([pk.getIx()], [pk.getIy()], **pksty)
                            plt.gca().set_axis_bgcolor((0.9,0.9,0.5))
                            plt.axis(pext)
                            savefig(pid, 'f%i' % (mapchild(k)))
                
                            k += 1
                
                if __name__ == '__main__':
                    main()
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="dde33c6e"/></a>dde33c6e</h3>

<pre>
commit dde33c6eadf436e532d917feee876cee127e485c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jan 3 14:31:29 2014 -0500

    whitespace changes; and make tinyFootprintSize configurable
</pre>
<h3><a name="f0b1f87f"/></a>f0b1f87f</h3>

<pre>
commit f0b1f87f43fd825097c51a59b7e27b5dbfb076d7
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed May 16 11:55:14 2012 -0400

    plots for design doc initial SDSS description; minor cosmetics
</pre>
<h3><a name="08c0d83e"/></a>08c0d83e</h3>

<pre>
commit 08c0d83ed7bb45069d57e6f8a688dc6879a7b6b6
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu Jan 9 16:13:02 2014 -0600

    Fix apportionFlux indexing given templates extending outside the parent footprint; revive designdoc.py
</pre>
<h3><a name="d12545da"/></a>d12545da</h3>

<pre>
commit d12545da4dc40523b5aeab0574ffde5afca58cec
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 11 13:37:16 2012 -0400

    factor out a bunch of 'examples' code to utils.py; add code to generate figs for design doc
</pre>
<h3><a name="3ad186d8"/></a>3ad186d8</h3>

<pre>
commit 3ad186d83fe7c33abe4be989115d254ce3895544
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 11 14:17:59 2012 -0400

    add options to disable some of the deblending tweaks; make plots
</pre>
<h3><a name="9ae6367c"/></a>9ae6367c</h3>

<pre>
commit 9ae6367cd78c2427be4b0710eaac80617f4aa629
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jan 7 16:15:46 2014 -0600

    start reviving the "design doc" plotting code
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_6"><a name="tests/strayFlux.py"/></a>tests/strayFlux.py</h1>

<h3 id="toc_7">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                doPlot = False
                if doPlot:
                    import matplotlib
                    matplotlib.use('Agg')
                    import pylab as plt
                    import os.path
                    plotpat = os.path.join(os.path.dirname(__file__), 'stray%i.png')
                    print 'Writing plots to', plotpat
                else:
                    print '"doPlot" not set -- not making plots.  To enable plots, edit', __file__
                
                import unittest
                import lsst.utils.tests         as utilsTests
                
                import numpy as np
                
                import lsst.afw.detection as afwDet
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.pex.logging as pexLogging
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#16cdd6cd">16cdd6cd</a> - from lsst.meas.deblender.baseline import *</div>
              ?                                          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#5ea010ad">5ea010ad</a> + from lsst.meas.deblender.baseline import deblend</div>
              ?                                          ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#e38ae0de">e38ae0de</a> - from lsst.meas.deblender import BaselineUtilsF as butils</div>
                
                import lsst.meas.algorithms as measAlg
                
                root = pexLogging.Log.getDefaultLog()
                root.setThreshold(pexLogging.Log.DEBUG)
                
                # Quiet some of the more chatty loggers
                pexLogging.Log(root, 'lsst.meas.deblender.symmetrizeFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.symmetricFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.getSignificantEdgePixels',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'afw.Mask',
                               pexLogging.Log.INFO)
                
                def imExt(img):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#bbaeb182">bbaeb182</a> -     bbox = img.getBBox(afwImage.PARENT)</div>
              ?                        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#5ea010ad">5ea010ad</a> +     bbox = img.getBBox()</div>
                    return [bbox.getMinX(), bbox.getMaxX(),
                            bbox.getMinY(), bbox.getMaxY()]
                
                def doubleGaussianPsf(W, H, fwhm1, fwhm2, a2):
                    return measAlg.DoubleGaussianPsf(W, H, fwhm1, fwhm2, a2)
                    
                def gaussianPsf(W, H, fwhm):
                    return measAlg.DoubleGaussianPsf(W, H, fwhm)
                
                
                class StrayFluxTestCase(unittest.TestCase):
                
                    def test1(self):
                        '''
                        A simple example: three overlapping blobs (detected as 1
                        footprint with three peaks).  We artificially omit one of the
                        peaks, meaning that its flux is "stray".  Assert that the
                        stray flux assigned to the other two peaks accounts for all
                        the flux in the parent.
                        '''
                        H,W = 100,100
                
                        fpbb = afwGeom.Box2I(afwGeom.Point2I(0,0),
                                             afwGeom.Point2I(W-1,H-1))
                
                        afwimg = afwImage.MaskedImageF(fpbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#16cdd6cd">16cdd6cd</a> -         imgbb = afwimg.getBBox(afwImage.PARENT)</div>
              ?                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#5ea010ad">5ea010ad</a> +         imgbb = afwimg.getBBox()</div>
                        img = afwimg.getImage().getArray()
                
                        var = afwimg.getVariance().getArray()
                        var[:,:] = 1.
                        
                        blob_fwhm = 10.
                        blob_psf = doubleGaussianPsf(99, 99, blob_fwhm, 3.*blob_fwhm, 0.03)
                
                        fakepsf_fwhm = 3.
                        fakepsf = gaussianPsf(11, 11, fakepsf_fwhm)
                        
                        blobimgs = []
                        x = 75.
                        XY = [(x,35.), (x,65.), (50.,50.)]
                        flux = 1e6
                        for x,y in XY:
                            bim = blob_psf.computeImage(afwGeom.Point2D(x, y))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#16cdd6cd">16cdd6cd</a> -             bbb = bim.getBBox(afwImage.PARENT)</div>
              ?                               ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#5ea010ad">5ea010ad</a> +             bbb = bim.getBBox()</div>
                            bbb.clip(imgbb)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#16cdd6cd">16cdd6cd</a> -             bim = bim.Factory(bim, bbb, afwImage.PARENT)</div>
              ?                                       -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#5ea010ad">5ea010ad</a> +             bim = bim.Factory(bim, bbb)</div>
                            bim2 = bim.getArray()
                
                            blobimg = np.zeros_like(img)
                            blobimg[bbb.getMinY():bbb.getMaxY()+1,
                                    bbb.getMinX():bbb.getMaxX()+1] += flux * bim2
                            blobimgs.append(blobimg)
                
                            img[bbb.getMinY():bbb.getMaxY()+1,
                                bbb.getMinX():bbb.getMaxX()+1] += flux * bim2
                
                        # Run the detection code to get a ~ realistic footprint
                        thresh = afwDet.createThreshold(5., 'value', True)
                        fpSet = afwDet.FootprintSet(afwimg, thresh, 'DETECTED', 1)
                        fps = fpSet.getFootprints()
                        print 'found', len(fps), 'footprints'
                        pks2 = []
                        for fp in fps:
                            print 'peaks:', len(fp.getPeaks())
                            for pk in fp.getPeaks():
                                print '  ', pk.getIx(), pk.getIy()
                                pks2.append((pk.getIx(), pk.getIy()))
                
                        # The first peak in this list is the one we want to omit.
                        fp0 = fps[0]
                        fakefp = afwDet.Footprint(fp0.getSpans(), fp0.getBBox())
                        for pk in fp0.getPeaks()[1:]:
                            fakefp.getPeaks().append(pk)
                        
                        ima = dict(interpolation='nearest', origin='lower', cmap='gray',
                                   vmin=0, vmax=1e3)
                
                        if doPlot:
                            plt.figure(figsize=(12,6))
                
                            plt.clf()
                            plt.suptitle('strayFlux.py: test1 input')
                            plt.subplot(2,2,1)
                            plt.title('Image')
                            plt.imshow(img, **ima)
                            ax = plt.axis()
                            plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                            plt.axis(ax)
                            for i,(b,(x,y)) in enumerate(zip(blobimgs, XY)):
                                plt.subplot(2,2, 2+i)
                                plt.title('Blob %i' % i)
                                plt.imshow(b, **ima)
                                ax = plt.axis()
                                plt.plot(x, y, 'r.')
                                plt.axis(ax)
                            plt.savefig(plotpat % 1)
                
                        deb = deblend(fakefp, afwimg, fakepsf, fakepsf_fwhm, verbose=True)
                        parent_img = afwImage.ImageF(fpbb)
                        afwDet.copyWithinFootprintImage(fakefp, afwimg.getImage(), parent_img)
                
                        if doPlot:
                            def myimshow(*args, **kwargs):
                                plt.imshow(*args, **kwargs)
                                plt.xticks([]); plt.yticks([])
                                plt.axis(imExt(afwimg))
                    
                            plt.clf()
                            plt.suptitle('strayFlux.py: test1 results')
                            #R,C = 3,5
                            R,C = 3,4
                            plt.subplot(R, C, (2*C) + 1)
                            plt.title('Image')
                            myimshow(img, **ima)
                            ax = plt.axis()
                            plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                            plt.axis(ax)
                    
                            plt.subplot(R, C, (2*C) + 2)
                            plt.title('Parent footprint')
                            myimshow(parent_img.getArray(), **ima)
                            ax = plt.axis()
                            plt.plot([pk.getIx() for pk in fakefp.getPeaks()],
                                     [pk.getIy() for pk in fakefp.getPeaks()], 'r.')
                            plt.axis(ax)
                            
                            sumimg = None
                            for i,dpk in enumerate(deb.peaks):
                                plt.subplot(R, C, i*C + 1)
                                plt.title('ch%i symm' % i)
                                symm = dpk.templateMaskedImage.getImage()
                                myimshow(symm.getArray(), extent=imExt(symm), **ima)
                    
                                plt.subplot(R, C, i*C + 2)
                                plt.title('ch%i portion' % i)
                                port = dpk.fluxPortion.getImage()
                                myimshow(port.getArray(), extent=imExt(port), **ima)
                    
                                himg = afwImage.ImageF(fpbb)
                                heavy = dpk.getFluxPortion(strayFlux=False)
                                heavy.insert(himg)
                                
                                # plt.subplot(R, C, i*C + 3)
                                # plt.title('ch%i heavy' % i)
                                # myimshow(himg.getArray(), **ima)
                                # ax = plt.axis()
                                # plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                                # plt.axis(ax)
                    
                                simg = afwImage.ImageF(fpbb)
                                dpk.strayFlux.insert(simg)
                                
                                plt.subplot(R, C, i*C + 3)
                                plt.title('ch%i stray' % i)
                                myimshow(simg.getArray(), **ima)
                                ax = plt.axis()
                                plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                                plt.axis(ax)
                
                                himg2 = afwImage.ImageF(fpbb)
                                heavy = dpk.getFluxPortion(strayFlux=True)
                                heavy.insert(himg2)
                    
                                if sumimg is None:
                                    sumimg = himg2.getArray().copy()
                                else:
                                    sumimg += himg2.getArray()
                                    
                                plt.subplot(R, C, i*C + 4)
                                myimshow(himg2.getArray(), **ima)
                                plt.title('ch%i total' % i)
                                ax = plt.axis()
                                plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                                plt.axis(ax)
                    
                            plt.subplot(R, C, (2*C) + C)
                            myimshow(sumimg, **ima)
                            ax = plt.axis()
                            plt.plot([x for x,y in XY], [y for x,y in XY], 'r.')
                            plt.axis(ax)
                            plt.title('Sum of deblends')
                                
                            plt.savefig(plotpat % 2)
                
                        # Compute the sum-of-children image
                        sumimg = None
                        for i,dpk in enumerate(deb.peaks):
                            himg2 = afwImage.ImageF(fpbb)
                            dpk.getFluxPortion().insert(himg2)
                            if sumimg is None:
                                sumimg = himg2.getArray().copy()
                            else:
                                sumimg += himg2.getArray()
                        
                        # Sum of children ~= Original image inside footprint (parent_img)
                
                        absdiff = np.max(np.abs(sumimg - parent_img.getArray()))
                        print 'Max abs diff:', absdiff
                        imgmax = parent_img.getArray().max()
                        print 'Img max:', imgmax
                        self.assertTrue(absdiff < imgmax * 1e-6)
                
                
                    def test2(self):
                        '''
                        A 1-d example, to test the stray-flux assignment.
                        '''
                        H,W = 1,100
                
                        fpbb = afwGeom.Box2I(afwGeom.Point2I(0,0),
                                             afwGeom.Point2I(W-1,H-1))
                        afwimg = afwImage.MaskedImageF(fpbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#bbaeb182">bbaeb182</a> -         imgbb = afwimg.getBBox(afwImage.PARENT)</div>
                        img = afwimg.getImage().getArray()
                        
                        var = afwimg.getVariance().getArray()
                        var[:,:] = 1.
                
                        y = 0
                        img[y, 1:-1] = 10.
                
                        img[0,  1] = 20.
                        img[0, -2] = 20.
                        
                        fakepsf_fwhm = 1.
                        fakepsf = gaussianPsf(1, 1, fakepsf_fwhm)
                
                        # Run the detection code to get a ~ realistic footprint
                        thresh = afwDet.createThreshold(5., 'value', True)
                        fpSet = afwDet.FootprintSet(afwimg, thresh, 'DETECTED', 1)
                        fps = fpSet.getFootprints()
                        self.assertEqual(len(fps), 1)
                        fp = fps[0]
                
                        # WORKAROUND: the detection alg produces ONE peak, at (1,0),
                        # rather than two.
                        self.assertEqual(len(fp.getPeaks()), 1)
                        fp.addPeak(W-2, y, float("NaN"))
                        #print 'Added peak; peaks:', len(fp.getPeaks())
                        #for pk in fp.getPeaks():
                        #    print '  ', pk.getFx(), pk.getFy()
                        
                        deb = deblend(fp, afwimg, fakepsf, fakepsf_fwhm, verbose=True,
                                      fitPsfs=False, )
                
                        if doPlot:
                            XX = np.arange(W+1).repeat(2)[1:-1]
                
                            plt.clf()
                            p1 = plt.plot(XX, img[y,:].repeat(2), 'g-', lw=3, alpha=0.3)
                
                            for i,dpk in enumerate(deb.peaks):
                                print dpk
                                port = dpk.fluxPortion.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#ebbaa999">ebbaa999</a> -                 bb = port.getBBox(afwImage.PARENT)</div>
              ?                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#5ea010ad">5ea010ad</a> +                 bb = port.getBBox()</div>
                                YY = np.zeros(XX.shape)
                                YY[bb.getMinX()*2 : (bb.getMaxX()+1)*2] = port.getArray()[0,:].repeat(2)
                                p2 = plt.plot(XX, YY, 'r-')
                
                                simg = afwImage.ImageF(fpbb)
                                dpk.strayFlux.insert(simg)
                                p3 = plt.plot(XX, simg.getArray()[y,:].repeat(2), 'b-')
                
                            plt.legend((p1[0],p2[0],p3[0]),
                                       ('Parent Flux', 'Child portion', 'Child stray flux'))
                            plt.ylim(-2, 22)
                            plt.savefig(plotpat % 3)
                
                        strays = []
                        for i,dpk in enumerate(deb.peaks):
                            simg = afwImage.ImageF(fpbb)
                            dpk.strayFlux.insert(simg)
                            strays.append(simg.getArray())
                
                        ssum = reduce(np.add, strays)
                
                        starget = np.zeros(W)
                        starget[2:-2] = 10.
                        
                        self.assertTrue(np.all(ssum == starget))
                
                        X = np.arange(W)
                        dx1 = X - 1.
                        dx2 = X - (W-2)
                        f1 = (1. / (1. + dx1**2))
                        f2 = (1. / (1. + dx2**2))
                        strayclip = 0.001
                        fsum = f1 + f2
                        f1[f1 < strayclip * fsum] = 0.
                        f2[f2 < strayclip * fsum] = 0.
                
                        s1 = f1 / (f1+f2) * 10.
                        s2 = f2 / (f1+f2) * 10.
                
                        s1[:2] = 0.
                        s2[-2:] = 0.
                        
                        if doPlot:
                            p4 = plt.plot(XX, s1.repeat(2), 'm-')
                            plt.plot(XX, s2.repeat(2), 'm-')
                
                            plt.legend((p1[0],p2[0],p3[0],p4[0]),
                                       ('Parent Flux', 'Child portion', 'Child stray flux',
                                        'Expected stray flux'))
                            plt.ylim(-2, 22)
                            plt.savefig(plotpat % 4)
                
                        # test abs diff
                        d = np.max(np.abs(s1 - strays[0]))
                        self.assertTrue(d < 1e-6)
                        d = np.max(np.abs(s2 - strays[1]))
                        self.assertTrue(d < 1e-6)
                
                        # test relative diff
                        self.assertTrue(np.max(np.abs(s1 - strays[0]) / np.maximum(1e-3, s1)) < 1e-6)
                        self.assertTrue(np.max(np.abs(s2 - strays[1]) / np.maximum(1e-3, s2)) < 1e-6)
                        
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    utilsTests.init()
                    suites = []
                    suites += unittest.makeSuite(StrayFluxTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                 
                if __name__ == "__main__":
                    run(True)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="bbaeb182"/></a>bbaeb182</h3>

<pre>
commit bbaeb182bef0664c94bd54aeebea31cf159d0180
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Jun 5 15:07:12 2013 -0400

    stray flux test: 1-d example, testing exact stray-flux assignment profile (1/(1+r^2))
</pre>
<h3><a name="ebbaa999"/></a>ebbaa999</h3>

<pre>
commit ebbaa999c55094bc0f6906f156ef24d90be161b5
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 3 12:01:38 2014 -0600

    continue reviving tests; raise exception early if footprint/image bounding-box geometry doesn't match
</pre>
<h3><a name="16cdd6cd"/></a>16cdd6cd</h3>

<pre>
commit 16cdd6cd84368f4d00559034e0a7f91784ac812c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jun 3 15:40:07 2013 -0400

    start test on stray flux
</pre>
<h3><a name="e38ae0de"/></a>e38ae0de</h3>

<pre>
commit e38ae0de691f070716103c408df5c234c12731b1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jun 14 11:48:21 2013 -0400

    add copyWithinFootprint() function; clean up ramped edge handling
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_8"><a name="include/lsst/meas/deblender/Baseline.h"/></a>include/lsst/meas/deblender/Baseline.h</h1>

<h3 id="toc_9">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                #if !defined(LSST_DEBLENDER_BASELINE_H)
                #define LSST_DEBLENDER_BASELINE_H
                //!
                
                #include <vector>
                #include <utility>
                
                #include "lsst/afw/image/Image.h"
                #include "lsst/afw/image/MaskedImage.h"
                #include "lsst/afw/detection/Footprint.h"
                #include "lsst/afw/detection/HeavyFootprint.h"
                #include "lsst/afw/detection/Peak.h"
                
                namespace lsst {
                    namespace meas {
                        namespace deblender {
                
                            template <typename ImagePixelT,
                                      typename MaskPixelT=lsst::afw::image::MaskPixel,
                                      typename VariancePixelT=lsst::afw::image::VariancePixel>
                            class BaselineUtils {
                
                            public:
                                typedef typename lsst::afw::image::MaskedImage<ImagePixelT, MaskPixelT, VariancePixelT> MaskedImageT;
                                typedef typename PTR(lsst::afw::image::MaskedImage<ImagePixelT, MaskPixelT, VariancePixelT>) MaskedImagePtrT;
                                typedef typename lsst::afw::image::Image<ImagePixelT> ImageT;
                                typedef typename PTR(lsst::afw::image::Image<ImagePixelT>) ImagePtrT;
                                typedef typename lsst::afw::image::Mask<MaskPixelT> MaskT;
                                typedef typename PTR(lsst::afw::image::Mask<MaskPixelT>) MaskPtrT;
                
                                typedef typename lsst::afw::detection::Footprint FootprintT;
                                typedef typename PTR(lsst::afw::detection::Footprint) FootprintPtrT;
                                typedef typename lsst::afw::detection::HeavyFootprint<ImagePixelT, MaskPixelT, VariancePixelT> HeavyFootprintT;
                
                                typedef typename PTR(lsst::afw::detection::HeavyFootprint<ImagePixelT, MaskPixelT, VariancePixelT>) HeavyFootprintPtrT;
                
                                static
                                PTR(lsst::afw::detection::Footprint)
                                symmetrizeFootprint(lsst::afw::detection::Footprint const& foot,
                                                    int cx, int cy);
                
                                static
                                std::pair<MaskedImagePtrT, FootprintPtrT>
                                buildSymmetricTemplate(MaskedImageT const& img,
                                                       lsst::afw::detection::Footprint const& foot,
                                                       lsst::afw::detection::PeakRecord const& pk,
                                                       double sigma1,
                                                       bool minZero,
                                                       bool patchEdges,
                                                       bool* patchedEdges);
                
                                static void
                                medianFilter(MaskedImageT const& img,
                                             MaskedImageT & outimg,
                                             int halfsize);
                
                                static void
                                makeMonotonic(MaskedImageT & img,
                                              lsst::afw::detection::PeakRecord const& pk);
                
                                static const int ASSIGN_STRAYFLUX                          = 0x1;
                                static const int STRAYFLUX_TO_POINT_SOURCES_WHEN_NECESSARY = 0x2;
                                static const int STRAYFLUX_TO_POINT_SOURCES_ALWAYS         = 0x4;
                                // split flux according to the closest distance to the template?
                                // (default is according to distance to the peak)
                                static const int STRAYFLUX_R_TO_FOOTPRINT                  = 0x8;
                                static const int STRAYFLUX_NEAREST_FOOTPRINT              = 0x10;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#d509aee5">d509aee5</a> -                 static const int STRAYFLUX_TRIM                           = 0x20;</div>
                
                                // swig doesn't seem to understand std::vector<MaskedImagePtrT>...
                                static
                                std::vector<typename PTR(lsst::afw::image::MaskedImage<ImagePixelT, MaskPixelT, VariancePixelT>)>
                                apportionFlux(MaskedImageT const& img,
                                              lsst::afw::detection::Footprint const& foot,
                                              std::vector<typename PTR(lsst::afw::image::MaskedImage<ImagePixelT, MaskPixelT, VariancePixelT>)> templates,
                                              std::vector<boost::shared_ptr<lsst::afw::detection::Footprint> > templ_footprints,
                                              //
                                              ImagePtrT templ_sum,
                                              std::vector<bool> const& ispsf,
                                              std::vector<int>  const& pkx,
                                              std::vector<int>  const& pky,
                                              std::vector<boost::shared_ptr<typename lsst::afw::detection::HeavyFootprint<ImagePixelT,MaskPixelT,VariancePixelT> > > & strays,
                                              int strayFluxOptions,
                                              double clipStrayFluxFraction
                                     );
                
                                static
                                bool
                                hasSignificantFluxAtEdge(ImagePtrT,
                                                         boost::shared_ptr<lsst::afw::detection::Footprint>,
                                    ImagePixelT threshold);
                
                                static
                                boost::shared_ptr<lsst::afw::detection::Footprint>
                                getSignificantEdgePixels(ImagePtrT,
                                                         boost::shared_ptr<lsst::afw::detection::Footprint>,
                                                         ImagePixelT threshold);
                
                
                                static
                                void
                                _sum_templates(std::vector<MaskedImagePtrT> timgs,
                                               ImagePtrT tsum);
                
                                static
                                void
                                _find_stray_flux(lsst::afw::detection::Footprint const& foot,
                                             ImagePtrT tsum,
                                             MaskedImageT const& img,
                                             int strayFluxOptions,
                                             std::vector<boost::shared_ptr<lsst::afw::detection::Footprint> > tfoots,
                                             std::vector<bool> const& ispsf,
                                             std::vector<int>  const& pkx,
                                             std::vector<int>  const& pky,
                                             double clipStrayFluxFraction,
                                             std::vector<boost::shared_ptr<typename lsst::afw::detection::HeavyFootprint<ImagePixelT,MaskPixelT,VariancePixelT> > > & strays);
                
                            };
                        }
                    }
                }
                
                #endif
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="d509aee5"/></a>d509aee5</h3>

<pre>
commit d509aee5a12496025293666555dab15aae32b4a4
Author: Bob Armstrong <rearmstr@gmail.com>
Date:   Fri May 1 13:55:36 2015 -0400

    Add strayFlux option to the deblender to shrink parents to the union of their children.
    
    The deblender is not doing well at assigning stray flux to its children.  This
    option ignores pixels not assigned to any children and trims the parent footprint to the
    union of the children.  This can result in parents having non-contigous footprints.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_10"><a name="python/lsst/meas/deblender/deblend.py"/></a>python/lsst/meas/deblender/deblend.py</h1>

<h3 id="toc_11">Diff:</h3>

<pre>
                #
                # LSST Data Management System
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#061bf0ed">061bf0ed</a> - # Copyright 2008-2013 LSST Corporation.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#25a44b26">25a44b26</a> + # Copyright 2008-2015 AURA/LSST.</div>
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import math
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#061bf0ed">061bf0ed</a> - import numpy</div>
                import time
                
                import lsst.pex.config as pexConf
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#592bcaab">592bcaab</a> - import lsst.pex.exceptions as pexExcept</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#061bf0ed">061bf0ed</a> - import lsst.afw.table as afwTable</div>
                import lsst.pipe.base as pipeBase
                import lsst.afw.math as afwMath
                import lsst.afw.geom as afwGeom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#8d178820">8d178820</a> - import lsst.afw.geom.ellipses as afwEll</div>
                import lsst.afw.image as afwImage
                import lsst.afw.detection as afwDet
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#3dbc7ffc">3dbc7ffc</a> + import lsst.afw.table as afwTable</div>
                
                __all__ = 'SourceDeblendConfig', 'SourceDeblendTask'
                
                class SourceDeblendConfig(pexConf.Config):
                
                    edgeHandling = pexConf.ChoiceField(
                        doc='What to do when a peak to be deblended is close to the edge of the image',
                        dtype=str, default='ramp',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#eabe1eb5">eabe1eb5</a> -         allowed = {</div>
              ?                - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#25a44b26">25a44b26</a> +         allowed={</div>
                            'clip': 'Clip the template at the edge AND the mirror of the edge.',
                            'ramp': 'Ramp down flux at the image edge by the PSF',
                            'noclip': 'Ignore the edge when building the symmetric template.',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#eabe1eb5">eabe1eb5</a> -             })</div>
              ?              -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#25a44b26">25a44b26</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#eabe1eb5">eabe1eb5</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#25a44b26">25a44b26</a> +         )</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#25a44b26">25a44b26</a> + </div>
                    strayFluxToPointSources = pexConf.ChoiceField(
                        doc='When the deblender should attribute stray flux to point sources',
                        dtype=str, default='necessary',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#eabe1eb5">eabe1eb5</a> -         allowed = {</div>
              ?                - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#25a44b26">25a44b26</a> +         allowed={</div>
                            'necessary': 'When there is not an extended object in the footprint',
                            'always': 'Always',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#eabe1eb5">eabe1eb5</a> -             'never': 'Never; stray flux will not be attributed to any deblended child if the deblender thinks all peaks look like point sources',</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#25a44b26">25a44b26</a> +             'never': ('Never; stray flux will not be attributed to any deblended child '</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#25a44b26">25a44b26</a> +                       'if the deblender thinks all peaks look like point sources'),</div>
                            }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#eabe1eb5">eabe1eb5</a> -             )</div>
              ? ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#25a44b26">25a44b26</a> +         )</div>
                
                    findStrayFlux = pexConf.Field(dtype=bool, default=True,
                                                  doc='Find stray flux---flux not claimed by any child in the deblender.')
                
                    assignStrayFlux = pexConf.Field(dtype=bool, default=True,
                                                    doc='Assign stray flux to deblend children.  Implies findStrayFlux.')
                
                    strayFluxRule = pexConf.ChoiceField(
                        doc='How to split flux among peaks',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#624790aa">624790aa</a> -         dtype=str, default='trim',</div>
              ?                              ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#c813cc7d">c813cc7d</a> +         dtype=str, default='r-to-peak',</div>
              ?                             ++ ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#b606deab">b606deab</a> -         allowed = {</div>
              ?                - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#25a44b26">25a44b26</a> +         allowed={</div>
                            'r-to-peak': '~ 1/(1+R^2) to the peak',
                            'r-to-footprint': ('~ 1/(1+R^2) to the closest pixel in the footprint.  '
                                               'CAUTION: this can be computationally expensive on large footprints!'),
                            'nearest-footprint': ('Assign 100% to the nearest footprint (using L-1 norm aka '
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#d509aee5">d509aee5</a> -                                   'Manhattan distance)'),</div>
              ?                                                         -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#25a44b26">25a44b26</a> +                                   'Manhattan distance)')</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#d509aee5">d509aee5</a> -             'trim': ('Shrink the parent footprint to pixels that are not assigned to children')</div>
                            }
                        )
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#b606deab">b606deab</a> -     clipStrayFluxFraction = pexConf.Field(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#fcdda962">fcdda962</a> +     clipStrayFluxFraction = pexConf.Field(dtype=float, default=0.01,</div>
              ?                                           ++++++++++++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#25a44b26">25a44b26</a> +                                           doc=('When splitting stray flux, clip fractions below '</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#25a44b26">25a44b26</a> +                                                'this value to zero.'))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#b606deab">b606deab</a> -         dtype=float, default=0.001,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#b606deab">b606deab</a> -         doc='When splitting stray flux, clip fractions below this value to zero.'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#b606deab">b606deab</a> -         )</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#b606deab">b606deab</a> - </div>
                    psfChisq1 = pexConf.Field(dtype=float, default=1.5, optional=False,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#061bf0ed">061bf0ed</a> -                                 doc=('Chi-squared per DOF cut for deciding a source is '+</div>
              ? --                                                                                      -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#25a44b26">25a44b26</a> +                               doc=('Chi-squared per DOF cut for deciding a source is '</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#061bf0ed">061bf0ed</a> -                                      'a PSF during deblending (un-shifted PSF model)'))</div>
              ? --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#25a44b26">25a44b26</a> +                                    'a PSF during deblending (un-shifted PSF model)'))</div>
                    psfChisq2 = pexConf.Field(dtype=float, default=1.5, optional=False,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#061bf0ed">061bf0ed</a> -                                 doc=('Chi-squared per DOF cut for deciding a source is '+</div>
              ? --                                                                                      -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#25a44b26">25a44b26</a> +                               doc=('Chi-squared per DOF cut for deciding a source is '</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#061bf0ed">061bf0ed</a> -                                      'PSF during deblending (shifted PSF model)'))</div>
              ? --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#25a44b26">25a44b26</a> +                                    'PSF during deblending (shifted PSF model)'))</div>
                    psfChisq2b = pexConf.Field(dtype=float, default=1.5, optional=False,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#061bf0ed">061bf0ed</a> -                                 doc=('Chi-squared per DOF cut for deciding a source is '+</div>
              ? -                                                                                       -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#25a44b26">25a44b26</a> +                                doc=('Chi-squared per DOF cut for deciding a source is '</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#061bf0ed">061bf0ed</a> -                                      'a PSF during deblending (shifted PSF model #2)'))</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#25a44b26">25a44b26</a> +                                     'a PSF during deblending (shifted PSF model #2)'))</div>
                    maxNumberOfPeaks = pexConf.Field(dtype=int, default=0,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#061bf0ed">061bf0ed</a> -                                      doc=("Only deblend the brightest maxNumberOfPeaks peaks in the parent" +</div>
              ?                                                                                                            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#25a44b26">25a44b26</a> +                                      doc=("Only deblend the brightest maxNumberOfPeaks peaks in the parent"</div>
                                                          " (<= 0: unlimited)"))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#8d178820">8d178820</a> -     maxFootprintArea = pexConf.Field(dtype=int, default=10000,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#fcdda962">fcdda962</a> +     maxFootprintArea = pexConf.Field(dtype=int, default=100000,</div>
              ?                                                              +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#8d178820">8d178820</a> -                                      doc=("Maximum area for footprints before they are ignored as large; "</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#8d178820">8d178820</a> -                                           "non-positive means no threshold applied"))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#25a44b26">25a44b26</a> +                                      doc=('Refuse to deblend parent footprints containing more than this '</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#25a44b26">25a44b26</a> +                                           'number of pixels (due to speed concerns); 0 means no limit.'))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#061bf0ed">061bf0ed</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#8d178820">8d178820</a> -     maxFootprintSize = pexConf.Field(dtype=int, default=300,</div>
              ?                 ^^^                                     ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#c813cc7d">c813cc7d</a> +     maxFootprintArea = pexConf.Field(dtype=int, default=100000,</div>
              ?                 ^^ +                                    ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#8d178820">8d178820</a> -                                     doc=("Maximum linear dimension for footprints before they are ignored "</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#8d178820">8d178820</a> -                                          "as large; non-positive means no threshold applied"))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#25a44b26">25a44b26</a> +                                      doc=('Refuse to deblend parent footprints containing more than this '</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#25a44b26">25a44b26</a> +                                           'number of pixels (due to speed concerns); 0 means no limit.'))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#b0576025">b0576025</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#8d178820">8d178820</a> -     minFootprintAxisRatio = pexConf.Field(dtype=float, default=1.0e-2,</div>
              ?     ^           ^^ ^^^^^^                       ^^^^           -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#dde33c6e">dde33c6e</a> +     tinyFootprintSize = pexConf.Field(dtype=int, default=2,</div>
              ?     ^  +         ^ ^^                       ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#8d178820">8d178820</a> -                                           doc=("Minimum axis ratio for footprints before they are ignored "</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#8d178820">8d178820</a> -                                                "as large; non-positive means no threshold applied"))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#d6204398">d6204398</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#a8cf6c22">a8cf6c22</a> -     tinyFootprintSize = pexConf.RangeField(dtype=int, default=2, min=2, inclusiveMin=True,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#a8cf6c22">a8cf6c22</a> -                                       doc=('Footprints smaller in width or height than this value will be '</div>
              ?                                                                                                        ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#25a44b26">25a44b26</a> +                                       doc=('Footprints smaller in width or height than this value will '</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#a8cf6c22">a8cf6c22</a> -                                            'ignored; minimum of 2 due to PSF gradient calculation.'))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#25a44b26">25a44b26</a> +                                            'be ignored; 0 to never ignore.'))</div>
                
                    removeMaskPlanes = pexConf.Field(dtype=int, default=True,
                                                     doc=("Clear and remove diagnostic mask planes on exit "
                                                          "(disable for deblender debugging)"))
                
                    propagateAllPeaks = pexConf.Field(dtype=bool, default=False,
                                                      doc=('Guarantee that all peaks produce a child source.'))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#590eca36">590eca36</a> - </div>
                    catchFailures = pexConf.Field(dtype=bool, default=False,
                                                  doc=("If True, catch exceptions thrown by the deblender, log them, "
                                                       "and set a flag on the parent, instead of letting them propagate up"))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#809b2a99">809b2a99</a> -     maskPlanes = pexConf.ListField(dtype=str, default=["SAT", "INTRP", "NO_DATA"],</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#809b2a99">809b2a99</a> -                                    doc="Mask planes to ignore when performing statistics")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#05347b2b">05347b2b</a> -     maskLimits = pexConf.DictField(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#05347b2b">05347b2b</a> -         keytype = str,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#05347b2b">05347b2b</a> -         itemtype = float,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#05347b2b">05347b2b</a> -         default = {},</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#05347b2b">05347b2b</a> -         doc = ("Mask planes with the corresponding limit on the fraction of masked pixels. "</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#05347b2b">05347b2b</a> -                "Sources violating this limit will not be deblended."),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#05347b2b">05347b2b</a> -         )</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#503b7186">503b7186</a> + ## \addtogroup LSST_task_documentation</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#503b7186">503b7186</a> + ## \{</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#503b7186">503b7186</a> + ## \page SourceDeblendTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#503b7186">503b7186</a> + ## \ref SourceDeblendTask_ "SourceDeblendTask"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#503b7186">503b7186</a> + ## \copybrief SourceDeblendTask</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#503b7186">503b7186</a> + ## \}</div>
                
                class SourceDeblendTask(pipeBase.Task):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#503b7186">503b7186</a> +     """!</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#25a44b26">25a44b26</a> +     \anchor SourceDeblendTask_</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#503b7186">503b7186</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#061bf0ed">061bf0ed</a> -     """Split blended sources into individual sources.</div>
              ?     ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#25a44b26">25a44b26</a> +     \brief Split blended sources into individual sources.</div>
              ?     ^^^^^^^
                
                    This task has no return value; it only modifies the SourceCatalog in-place.
                    """
                    ConfigClass = SourceDeblendConfig
                    _DefaultName = "sourceDeblend"
                
                    def __init__(self, schema, peakSchema=None, **kwargs):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#25a44b26">25a44b26</a> +         """!</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#061bf0ed">061bf0ed</a> -         """Create the task, adding necessary fields to the given schema.</div>
              ?         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#25a44b26">25a44b26</a> +         Create the task, adding necessary fields to the given schema.</div>
                
                        @param[in,out] schema        Schema object for measurement fields; will be modified in-place.
                        @param[in]     peakSchema    Schema of Footprint Peaks that will be passed to the deblender.
                                                     Any fields beyond the PeakTable minimal schema will be transferred
                                                     to the main source Schema.  If None, no fields will be transferred
                                                     from the Peaks.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#061bf0ed">061bf0ed</a> -         @param         **kwds        Passed to Task.__init__.</div>
              ?               ^^^^         ^ --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#3dbc7ffc">3dbc7ffc</a> +         @param[in]     **kwargs      Passed to Task.__init__.</div>
              ?               ^^^^         ^^^
                        """
                        pipeBase.Task.__init__(self, **kwargs)
                        peakMinimalSchema = afwDet.PeakTable.makeMinimalSchema()
                        if peakSchema is None:
                            # In this case, the peakSchemaMapper will transfer nothing, but we'll still have one
                            # to simplify downstream code
                            self.peakSchemaMapper = afwTable.SchemaMapper(peakMinimalSchema, schema)
                        else:
                            self.peakSchemaMapper = afwTable.SchemaMapper(peakSchema, schema)
                            for item in peakSchema:
                                if item.key not in peakMinimalSchema:
                                    self.peakSchemaMapper.addMapping(item.key, item.field)
                                    # Because SchemaMapper makes a copy of the output schema you give its ctor, it isn't
                                    # updating this Schema in place.  That's probably a design flaw, but in the meantime,
                                    # we'll keep that schema in sync with the peakSchemaMapper.getOutputSchema() manually,
                                    # by adding the same fields to both.
                                    schema.addField(item.field)
                            assert schema == self.peakSchemaMapper.getOutputSchema(), "Logic bug mapping schemas"
                        self.addSchemaKeys(schema)
                
                    def addSchemaKeys(self, schema):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#061bf0ed">061bf0ed</a> -         self.nChildKey = schema.addField('deblend.nchild', type=int,</div>
              ?                                                  ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#22f14a7e">22f14a7e</a> +         self.nChildKey = schema.addField('deblend_nChild', type=int,</div>
              ?                                                  ^ ^
                                                         doc='Number of children this object has (defaults to 0)')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#061bf0ed">061bf0ed</a> -         self.psfKey = schema.addField('deblend.deblended-as-psf', type='Flag',</div>
              ?                                               ^         ^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#22f14a7e">22f14a7e</a> +         self.psfKey = schema.addField('deblend_deblendedAsPsf', type='Flag',</div>
              ?                                               ^         ^ ^
                                                      doc='Deblender thought this source looked like a PSF')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#061bf0ed">061bf0ed</a> -         self.psfCenterKey = schema.addField('deblend.psf-center', type='PointD',</div>
              ?                                                     ^   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#22f14a7e">22f14a7e</a> +         self.psfCenterKey = schema.addField('deblend_psfCenter', type='PointD',</div>
              ?                                                     ^   ^
                                                         doc='If deblended-as-psf, the PSF centroid')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#061bf0ed">061bf0ed</a> -         self.psfFluxKey = schema.addField('deblend.psf-flux', type='D',</div>
              ?                                                   ^   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#22f14a7e">22f14a7e</a> +         self.psfFluxKey = schema.addField('deblend_psfFlux', type='D',</div>
              ?                                                   ^   ^
                                                           doc='If deblended-as-psf, the PSF flux')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#061bf0ed">061bf0ed</a> -         self.tooManyPeaksKey = schema.addField('deblend.too-many-peaks', type='Flag',</div>
              ?                                                        ^   ^^   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#22f14a7e">22f14a7e</a> +         self.tooManyPeaksKey = schema.addField('deblend_tooManyPeaks', type='Flag',</div>
              ?                                                        ^   ^   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#061bf0ed">061bf0ed</a> -                                                doc='Source had too many peaks; ' +</div>
              ?                                                                                 --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#25a44b26">25a44b26</a> +                                                doc='Source had too many peaks; '</div>
                                                               'only the brightest were included')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#fcdda962">fcdda962</a> -         self.tooBigKey = schema.addField('deblend.parent-too-big', type='Flag',</div>
              ?                                                  ^      ^^  ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#22f14a7e">22f14a7e</a> +         self.tooBigKey = schema.addField('deblend_parentTooBig', type='Flag',</div>
              ?                                                  ^      ^  ^
                                                         doc='Parent footprint covered too many pixels')
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#713a58b2">713a58b2</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#05347b2b">05347b2b</a> -         self.maskedKey = schema.addField('deblend.masked', type='Flag',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#05347b2b">05347b2b</a> -                                          doc='Parent footprint was predominantly masked')</div>
                        if self.config.catchFailures:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#590eca36">590eca36</a> -             self.deblendFailedKey = schema.addField('deblend.failed', type='Flag',</div>
              ?                                                             ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#713a58b2">713a58b2</a> +             self.deblendFailedKey = schema.addField('deblend_failed', type='Flag',</div>
              ?                                                             ^
                                                                    doc="Deblending failed on source")
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#22f14a7e">22f14a7e</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#5268a5fc">5268a5fc</a> -         self.deblendSkippedKey = schema.addField('deblend.skipped', type='Flag',</div>
              ?                                                          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#22f14a7e">22f14a7e</a> +         self.deblendSkippedKey = schema.addField('deblend_skipped', type='Flag',</div>
              ?                                                          ^
                                                                doc="Deblender skipped this source")
                
                        self.deblendRampedTemplateKey = schema.addField(
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#bf4264b7">bf4264b7</a> -             'deblend.ramped_template', type='Flag',</div>
              ?                     ^      ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#22f14a7e">22f14a7e</a> +             'deblend_rampedTemplate', type='Flag',</div>
              ?                     ^      ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#bf4264b7">bf4264b7</a> -             doc=('This source was near an image edge and the deblender used ' +</div>
              ?                                                                              --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#25a44b26">25a44b26</a> +             doc=('This source was near an image edge and the deblender used '</div>
                                 '"ramp" edge-handling.'))
                
                        self.deblendPatchedTemplateKey = schema.addField(
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#bf4264b7">bf4264b7</a> -             'deblend.patched_template', type='Flag',</div>
              ?                     ^       ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#22f14a7e">22f14a7e</a> +             'deblend_patchedTemplate', type='Flag',</div>
              ?                     ^       ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#bf4264b7">bf4264b7</a> -             doc=('This source was near an image edge and the deblender used ' +</div>
              ?                                                                              --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#25a44b26">25a44b26</a> +             doc=('This source was near an image edge and the deblender used '</div>
                                 '"patched" edge-handling.'))
                
                        self.hasStrayFluxKey = schema.addField(
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#5cf09fe2">5cf09fe2</a> -             'deblend.has_stray_flux', type='Flag',</div>
              ?                     ^   ^^    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#22f14a7e">22f14a7e</a> +             'deblend_hasStrayFlux', type='Flag',</div>
              ?                     ^   ^    ^
                            doc=('This source was assigned some stray flux'))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#bf4264b7">bf4264b7</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#95da1cb7">95da1cb7</a> + </div>
                        self.log.logdebug('Added keys to schema: %s' % ", ".join(str(x) for x in (
                                    self.nChildKey, self.psfKey, self.psfCenterKey, self.psfFluxKey,
                                    self.tooManyPeaksKey, self.tooBigKey)))
                
                    @pipeBase.timeMethod
                    def run(self, exposure, sources, psf):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#25a44b26">25a44b26</a> +         """!</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#061bf0ed">061bf0ed</a> -         """Run deblend().</div>
              ?         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#25a44b26">25a44b26</a> +         Run deblend().</div>
                
                        @param[in]     exposure Exposure to process
                        @param[in,out] sources  SourceCatalog containing sources detected on this exposure.
                        @param[in]     psf      PSF
                
                        @return None
                        """
                        self.deblend(exposure, sources, psf)
                
                    def _getPsfFwhm(self, psf, bbox):
                        # It should be easier to get a PSF's fwhm;
                        # https://dev.lsstcorp.org/trac/ticket/3030
                        return psf.computeShape().getDeterminantRadius() * 2.35
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#972e36b9">972e36b9</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#25a44b26">25a44b26</a> + </div>
                    @pipeBase.timeMethod
                    def deblend(self, exposure, srcs, psf):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#25a44b26">25a44b26</a> +         """!</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#061bf0ed">061bf0ed</a> -         """Deblend.</div>
              ?         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#25a44b26">25a44b26</a> +         Deblend.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#061bf0ed">061bf0ed</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#25a44b26">25a44b26</a> + </div>
                        @param[in]     exposure Exposure to process
                        @param[in,out] srcs     SourceCatalog containing sources detected on this exposure.
                        @param[in]     psf      PSF
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#061bf0ed">061bf0ed</a> -                        </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#25a44b26">25a44b26</a> + </div>
                        @return None
                        """
                        self.log.info("Deblending %d sources" % len(srcs))
                
                        from lsst.meas.deblender.baseline import deblend
                        import lsst.meas.algorithms as measAlg
                
                        # find the median stdev in the image...
                        mi = exposure.getMaskedImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#809b2a99">809b2a99</a> -         statsCtrl = afwMath.StatisticsControl()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#809b2a99">809b2a99</a> -         statsCtrl.setAndMask(mi.getMask().getPlaneBitMask(self.config.maskPlanes))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#809b2a99">809b2a99</a> -         stats = afwMath.makeStatistics(mi.getVariance(), mi.getMask(), afwMath.MEDIAN, statsCtrl)</div>
              ?                                                                                      -----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#061bf0ed">061bf0ed</a> +         stats = afwMath.makeStatistics(mi.getVariance(), mi.getMask(), afwMath.MEDIAN)</div>
                        sigma1 = math.sqrt(stats.getValue(afwMath.MEDIAN))
                        self.log.logdebug('sigma1: %g' % sigma1)
                
                        schema = srcs.getSchema()
                
                        n0 = len(srcs)
                        nparents = 0
                        for i,src in enumerate(srcs):
                            #t0 = time.clock()
                
                            fp = src.getFootprint()
                            pks = fp.getPeaks()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#8aa3e8af">8aa3e8af</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#8aa3e8af">8aa3e8af</a> -             # Since we use the first peak for the parent object, we should propagate its flags</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#8aa3e8af">8aa3e8af</a> -             # to the parent source.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#8aa3e8af">8aa3e8af</a> -             src.assign(pks[0], self.peakSchemaMapper)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#8aa3e8af">8aa3e8af</a> - </div>
                            if len(pks) < 2:
                                continue
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#8d178820">8d178820</a> -             if self.isLargeFootprint(fp):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#25a44b26">25a44b26</a> +             toobig = ((self.config.maxFootprintArea > 0) and</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#fcdda962">fcdda962</a> +                       (fp.getArea() > self.config.maxFootprintArea))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#8d178820">8d178820</a> -                 src.set(self.tooBigKey, True)</div>
              ? ----                                    ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#fcdda962">fcdda962</a> +             src.set(self.tooBigKey, toobig)</div>
              ?                                     ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#fcdda962">fcdda962</a> +             if toobig:</div>
                                src.set(self.deblendSkippedKey, True)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#fcdda962">fcdda962</a> +                 self.log.logdebug('Parent %i: area %i > max %i; skipping' %</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#fcdda962">fcdda962</a> +                                   (int(src.getId()), fp.getArea(), self.config.maxFootprintArea))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#8d178820">8d178820</a> -                 self.log.logdebug('Parent %i: skipping large footprint' % (int(src.getId()),))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#fcdda962">fcdda962</a> -                 continue</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#05347b2b">05347b2b</a> -             if self.isMasked(fp, exposure.getMaskedImage().getMask()):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#05347b2b">05347b2b</a> -                 src.set(self.maskedKey, True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#05347b2b">05347b2b</a> -                 src.set(self.deblendSkippedKey, True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#05347b2b">05347b2b</a> -                 self.log.logdebug('Parent %i: skipping masked footprint' % (int(src.getId()),))</div>
                                continue
                
                            nparents += 1
                            bb = fp.getBBox()
                            psf_fwhm = self._getPsfFwhm(psf, bb)
                
                            self.log.logdebug('Parent %i: deblending %i peaks' % (int(src.getId()), len(pks)))
                
                            self.preSingleDeblendHook(exposure, srcs, i, fp, psf, psf_fwhm, sigma1)
                            npre = len(srcs)
                
                            # This should really be set in deblend, but deblend doesn't have access to the src
                            src.set(self.tooManyPeaksKey, len(fp.getPeaks()) > self.config.maxNumberOfPeaks)
                
                            try:
                                res = deblend(
                                    fp, mi, psf, psf_fwhm, sigma1=sigma1,
                                    psfChisqCut1 = self.config.psfChisq1,
                                    psfChisqCut2 = self.config.psfChisq2,
                                    psfChisqCut2b= self.config.psfChisq2b,
                                    maxNumberOfPeaks=self.config.maxNumberOfPeaks,
                                    strayFluxToPointSources=self.config.strayFluxToPointSources,
                                    assignStrayFlux=self.config.assignStrayFlux,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#eabe1eb5">eabe1eb5</a> -                     findStrayFlux=(self.config.assignStrayFlux or</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#25a44b26">25a44b26</a> +                     findStrayFlux=(self.config.assignStrayFlux or self.config.findStrayFlux),</div>
              ?                                                                  ++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#eabe1eb5">eabe1eb5</a> -                                    self.config.findStrayFlux),</div>
                                    strayFluxAssignment=self.config.strayFluxRule,
                                    rampFluxAtEdge=(self.config.edgeHandling == 'ramp'),
                                    patchEdges=(self.config.edgeHandling == 'noclip'),
                                    tinyFootprintSize=self.config.tinyFootprintSize,
                                    clipStrayFluxFraction=self.config.clipStrayFluxFraction,
                                    )
                                if self.config.catchFailures:
                                    src.set(self.deblendFailedKey, False)
                            except Exception as e:
                                if self.config.catchFailures:
                                    self.log.warn("Unable to deblend source %d: %s" % (src.getId(), e))
                                    src.set(self.deblendFailedKey, True)
                                    import traceback
                                    traceback.print_exc()
                                    continue
                                else:
                                    raise
                
                            kids = []
                            nchild = 0
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#846a6363">846a6363</a> -             for j,peak in enumerate(res.peaks):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#25a44b26">25a44b26</a> +             for j, peak in enumerate(res.peaks):</div>
              ?                   +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#9ea0a1be">9ea0a1be</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#9ea0a1be">9ea0a1be</a> +                 failed = False</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#846a6363">846a6363</a> +                 if peak.skip:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#061bf0ed">061bf0ed</a> +                     # skip this source?</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#9ea0a1be">9ea0a1be</a> +                     msg = 'Skipping out-of-bounds peak at (%i,%i)' % (pks[j].getIx(), pks[j].getIy())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#9ea0a1be">9ea0a1be</a> +                     self.log.warn(msg)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#5268a5fc">5268a5fc</a> +                     src.set(self.deblendSkippedKey, True)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#9ea0a1be">9ea0a1be</a> +                     failed = True</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#2d7b7d59">2d7b7d59</a> + </div>
                                heavy = peak.getFluxPortion()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#db7d705d">db7d705d</a> -                 if heavy is None or peak.skip:</div>
              ?                                 -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#2d7b7d59">2d7b7d59</a> +                 if heavy is None:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#2d7b7d59">2d7b7d59</a> +                     # This can happen for children >= maxNumberOfPeaks</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#9ea0a1be">9ea0a1be</a> +                     msg = 'Skipping peak at (%i,%i), child %i of %i: no flux portion' \</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#9ea0a1be">9ea0a1be</a> +                           % (pks[j].getIx(), pks[j].getIy(), j+1, len(res.peaks))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#9ea0a1be">9ea0a1be</a> +                     self.log.warn(msg)</div>
                                    src.set(self.deblendSkippedKey, True)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#9ea0a1be">9ea0a1be</a> +                     failed = True</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#9ea0a1be">9ea0a1be</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#9ea0a1be">9ea0a1be</a> +                 if failed:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#db7d705d">db7d705d</a> -                     if not self.config.propagateAllPeaks:</div>
              ?                       ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#9ea0a1be">9ea0a1be</a> +                     if self.config.propagateAllPeaks:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#db7d705d">db7d705d</a> -                         # Don't care</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#9ea0a1be">9ea0a1be</a> +                         # make sure we have enough info to create a minimal child src</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#9ea0a1be">9ea0a1be</a> +                         if heavy is None:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#5e8566c9">5e8566c9</a> +                             # copy the full footprint and strip out extra peaks</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#5e8566c9">5e8566c9</a> +                             foot = afwDet.Footprint(src.getFootprint())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#5e8566c9">5e8566c9</a> +                             peakList = foot.getPeaks()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#5058a1a0">5058a1a0</a> +                             peakList.clear()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#5058a1a0">5058a1a0</a> +                             peakList.append(peak.peak)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#9ea0a1be">9ea0a1be</a> +                             zeroMimg = afwImage.MaskedImageF(foot.getBBox())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#9ea0a1be">9ea0a1be</a> +                             heavy = afwDet.makeHeavyFootprint(foot, zeroMimg)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#ab2935bf">ab2935bf</a> +                         if peak.deblendedAsPsf:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#ab2935bf">ab2935bf</a> +                             if peak.psfFitFlux is None:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#ab2935bf">ab2935bf</a> +                                 peak.psfFitFlux = 0.0</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#ab2935bf">ab2935bf</a> +                             if peak.psfFitCenter is None:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#ab2935bf">ab2935bf</a> +                                 peak.psfFitCenter = (peak.peak.getIx(), peak.peak.getIy())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#9ea0a1be">9ea0a1be</a> +                         self.log.warn("Peak failed.  Using minimal default info for child.")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#9ea0a1be">9ea0a1be</a> +                     else:</div>
                                        continue
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#db7d705d">db7d705d</a> -                     # We need to preserve the peak: make sure we have enough info to create a minimal child src</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#db7d705d">db7d705d</a> -                     self.log.logdebug("Peak failed.  Using minimal default info for child.")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#db7d705d">db7d705d</a> -                     if heavy is None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#db7d705d">db7d705d</a> -                         # copy the full footprint and strip out extra peaks</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#db7d705d">db7d705d</a> -                         foot = afwDet.Footprint(src.getFootprint())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#db7d705d">db7d705d</a> -                         peakList = foot.getPeaks()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#db7d705d">db7d705d</a> -                         peakList.clear()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#db7d705d">db7d705d</a> -                         peakList.append(peak.peak)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#db7d705d">db7d705d</a> -                         zeroMimg = afwImage.MaskedImageF(foot.getBBox())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#db7d705d">db7d705d</a> -                         heavy = afwDet.makeHeavyFootprint(foot, zeroMimg)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#db7d705d">db7d705d</a> -                     if peak.deblendedAsPsf:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#db7d705d">db7d705d</a> -                         if peak.psfFitFlux is None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#db7d705d">db7d705d</a> -                             peak.psfFitFlux = 0.0</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#db7d705d">db7d705d</a> -                         if peak.psfFitCenter is None:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#db7d705d">db7d705d</a> -                             peak.psfFitCenter = (peak.peak.getIx(), peak.peak.getIy())</div>
                
                                assert(len(heavy.getPeaks()) == 1)
                
                                src.set(self.deblendSkippedKey, False)
                                child = srcs.addNew(); nchild += 1
                                child.assign(heavy.getPeaks()[0], self.peakSchemaMapper)
                                child.setParent(src.getId())
                                child.setFootprint(heavy)
                                child.set(self.psfKey, peak.deblendedAsPsf)
                                child.set(self.hasStrayFluxKey, peak.strayFlux is not None)
                                if peak.deblendedAsPsf:
                                    (cx,cy) = peak.psfFitCenter
                                    child.set(self.psfCenterKey, afwGeom.Point2D(cx, cy))
                                    child.set(self.psfFluxKey, peak.psfFitFlux)
                                child.set(self.deblendRampedTemplateKey, peak.hasRampedTemplate)
                                child.set(self.deblendPatchedTemplateKey, peak.patched)
                                kids.append(child)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#91a61523">91a61523</a> -             # update parent footprint in-place to ensure it contains all child footprints</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
360  <a href="#8ae91faf">8ae91faf</a> +             # Child footprints may extend beyond the full extent of their parent's which</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
361  <a href="#8ae91faf">8ae91faf</a> +             # results in a failure of the replace-by-noise code to reinstate these pixels</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
362  <a href="#8ae91faf">8ae91faf</a> +             # to their original values.  The following updates the parent footprint</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
363  <a href="#8ae91faf">8ae91faf</a> +             # in-place to ensure it contains the full union of itself and all of its</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
364  <a href="#8ae91faf">8ae91faf</a> +             # children's footprints.</div>
                            src.getFootprint().include([child.getFootprint() for child in kids])
                
                            src.set(self.nChildKey, nchild)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
362  <a href="#061bf0ed">061bf0ed</a> -             </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
368  <a href="#25a44b26">25a44b26</a> + </div>
                            self.postSingleDeblendHook(exposure, srcs, i, npre, kids, fp, psf, psf_fwhm, sigma1, res)
                            #print 'Deblending parent id', src.getId(), 'took', time.clock() - t0
                
                        if self.config.removeMaskPlanes:
                            mask = exposure.getMaskedImage().getMask()
                            definedMasks = set(mask.getMaskPlaneDict().keys())
                            for nm in ['SYMM_1SIG', 'SYMM_3SIG', 'MONOTONIC_1SIG']:
                                if nm in definedMasks:
                                    mask.removeAndClearMaskPlane(nm, True)
                
                        n1 = len(srcs)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
374  <a href="#061bf0ed">061bf0ed</a> -         self.log.info('Deblended: of %i sources, %i were deblended, creating %i children, total %i sources' %</div>
              ?                                                                                                            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
380  <a href="#25a44b26">25a44b26</a> +         self.log.info('Deblended: of %i sources, %i were deblended, creating %i children, total %i sources'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
375  <a href="#061bf0ed">061bf0ed</a> -                       (n0, nparents, n1-n0, n1))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
381  <a href="#25a44b26">25a44b26</a> +                       % (n0, nparents, n1-n0, n1))</div>
              ?                      ++
                
                    def preSingleDeblendHook(self, exposure, srcs, i, fp, psf, psf_fwhm, sigma1):
                        pass
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
379  <a href="#061bf0ed">061bf0ed</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
385  <a href="#25a44b26">25a44b26</a> + </div>
                    def postSingleDeblendHook(self, exposure, srcs, i, npre, kids, fp, psf, psf_fwhm, sigma1, res):
                        pass
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
383  <a href="#8d178820">8d178820</a> -     def isLargeFootprint(self, footprint):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
384  <a href="#8d178820">8d178820</a> -         """Returns whether a Footprint is large</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
386  <a href="#8d178820">8d178820</a> -         'Large' is defined by thresholds on the area, size and axis ratio.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
387  <a href="#8d178820">8d178820</a> -         These may be disabled independently by configuring them to be non-positive.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
388  <a href="#33db9727">33db9727</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
389  <a href="#8d178820">8d178820</a> -         This is principally intended to get rid of satellite streaks, which the</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
390  <a href="#8d178820">8d178820</a> -         deblender or other downstream processing can have trouble dealing with</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#8d178820">8d178820</a> -         (e.g., multiple large HeavyFootprints can chew up memory).</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
392  <a href="#8d178820">8d178820</a> -         """</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
393  <a href="#8d178820">8d178820</a> -         if self.config.maxFootprintArea > 0 and footprint.getArea() > self.config.maxFootprintArea:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
394  <a href="#8d178820">8d178820</a> -             return True</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
395  <a href="#8d178820">8d178820</a> -         if self.config.maxFootprintSize > 0:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
396  <a href="#8d178820">8d178820</a> -             bbox = footprint.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
397  <a href="#8d178820">8d178820</a> -             if max(bbox.getWidth(), bbox.getHeight()) > self.config.maxFootprintSize:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
398  <a href="#8d178820">8d178820</a> -                 return True</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
399  <a href="#8d178820">8d178820</a> -         if self.config.minFootprintAxisRatio > 0:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
400  <a href="#8d178820">8d178820</a> -             axes = afwEll.Axes(footprint.getShape())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
401  <a href="#8d178820">8d178820</a> -             if axes.getB() < self.config.minFootprintAxisRatio*axes.getA():</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
402  <a href="#8d178820">8d178820</a> -                 return True</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
403  <a href="#8d178820">8d178820</a> -         return False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
404  <a href="#05347b2b">05347b2b</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
405  <a href="#05347b2b">05347b2b</a> -     def isMasked(self, footprint, mask):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
406  <a href="#05347b2b">05347b2b</a> -         """Returns whether the footprint violates the mask limits"""</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#05347b2b">05347b2b</a> -         size = float(footprint.getArea())</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#05347b2b">05347b2b</a> -         for maskName, limit in self.config.maskLimits.iteritems():</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#05347b2b">05347b2b</a> -             maskVal = mask.getPlaneBitMask(maskName)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#05347b2b">05347b2b</a> -             unmasked = afwDet.Footprint(footprint)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
411  <a href="#05347b2b">05347b2b</a> -             unmasked.intersectMask(mask, maskVal) # footprint of unmasked pixels</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#05347b2b">05347b2b</a> -             if (size - unmasked.getArea())/size > limit:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
413  <a href="#05347b2b">05347b2b</a> -                 return True</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
414  <a href="#05347b2b">05347b2b</a> -         return False</div>
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="592bcaab"/></a>592bcaab</h3>

<pre>
commit 592bcaab86578a5e8717f59f19776bb25d336d43
Author: Paul Price <price@astro.princeton.edu>
Date:   Tue Jul 9 03:49:49 2013 +0900

    deblend: add missing import
</pre>
<h3><a name="d6204398"/></a>d6204398</h3>

<pre>
commit d6204398e70228ebdb0dde2331988d513efaa84a
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 09:37:02 2014 -0400

    printf profiling; and add a max footprint area for deblending
</pre>
<h3><a name="5cf09fe2"/></a>5cf09fe2</h3>

<pre>
commit 5cf09fe2dbf7c1e1b71062e31906b11df3d31cc2
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 15 11:38:04 2014 -0600

    add flag for stray flux
</pre>
<h3><a name="809b2a99"/></a>809b2a99</h3>

<pre>
commit 809b2a99be0a0ddc748c192d1c8ea3b03e5d60f0
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Feb 25 10:46:19 2015 -0500

    SourceDeblendTask: respect mask planes for statistics
    
    If a large fraction of the image was masked, we might get a
    bad variance value unless we respect the mask.
</pre>
<h3><a name="d509aee5"/></a>d509aee5</h3>

<pre>
commit d509aee5a12496025293666555dab15aae32b4a4
Author: Bob Armstrong <rearmstr@gmail.com>
Date:   Fri May 1 13:55:36 2015 -0400

    Add strayFlux option to the deblender to shrink parents to the union of their children.
    
    The deblender is not doing well at assigning stray flux to its children.  This
    option ignores pixels not assigned to any children and trims the parent footprint to the
    union of the children.  This can result in parents having non-contigous footprints.
</pre>
<h3><a name="590eca36"/></a>590eca36</h3>

<pre>
commit 590eca36d0568741abff2708a51721e97132fd51
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Dec 10 19:09:45 2014 -0500

    Make low-level deblend failures fatal
    
    With the new requirement that deblending happen consistently
    in all bands, we can no longer handle occasional unexplained
    failures by simply leaving the parent as-is.
    
    However, the old behavior, which caught exceptions, warned
    about them, and set a flag, can still be enabled via config.
</pre>
<h3><a name="8d178820"/></a>8d178820</h3>

<pre>
commit 8d17882033d7417c9f4faaeff461974edd730488
Author: Paul Price <price@astro.princeton.edu>
Date:   Mon Mar 9 22:18:19 2015 -0400

    SourceDeblendTask: more extensive definition of a large footprint
    
    Large footprints are now identified from their large area (the only
    requirement previously), linear size or small axis ratio, which are
    configurable.  This is principally intended to get rid of satellite
    streaks, which the deblender has trouble dealing with.
</pre>
<h3><a name="624790aa"/></a>624790aa</h3>

<pre>
commit 624790aa63a38fb7a328ebc21abfd1b10503aa26
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri May 8 10:57:15 2015 -0400

    config: change default strayFluxRule
    
    We believe "trim" is the best option to use now.
</pre>
<h3><a name="33db9727"/></a>33db9727</h3>

<pre>
commit 33db9727f34421b943d3d619d7dbc340ff1b4379
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Mar 6 15:47:56 2014 -0500

    start debugging; also add a separate task for running JUST deblending and measurment, starting from calexp + sources
</pre>
<h3><a name="972e36b9"/></a>972e36b9</h3>

<pre>
commit 972e36b9ece410a26371dc528bf1200bab453d3b
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Oct 21 15:10:40 2013 -0400

    deblender: pull out PSF FWHM code
</pre>
<h3><a name="db7d705d"/></a>db7d705d</h3>

<pre>
commit db7d705de93b43a5f32f771c716b1c5c7368d124
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Mar 18 11:53:13 2015 -0400

    consolidate failed peak logic and downgrade warning
    
    A peak is treated as "failed" if it has been explicitly marked
    to be skipped or it doesn't have a HeavyFootprint.  These cases
    are treated in the same code, so consolidated them so it's easier
    to follow.
    
    In the process, changed the warning to a debug message, to avoid
    overwhelming the user: it is common for a peak to 'fail' in this
    manner (usually due to having a 'tiny' Footprint, or the peak
    being off the image), and the source is marked as skipped, so
    we know what happened and there's no need to record this through
    the logger (in the same way we don't log every exception from a
    measurement algorithm).
</pre>
<h3><a name="061bf0ed"/></a>061bf0ed</h3>

<pre>
commit 061bf0ede1d7a8bae8dfff590f88710c153f5034
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jun 10 11:20:46 2013 -0400

    move deblend.py (SourceDeblendTask) from meas_alg to meas_deblender
</pre>
<h3><a name="846a6363"/></a>846a6363</h3>

<pre>
commit 846a6363c691d7b1c5424f70893f37694e7ad850
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 17 10:48:03 2014 -0600

    deblender: convertNamesToCamelCase
</pre>
<h3><a name="bf4264b7"/></a>bf4264b7</h3>

<pre>
commit bf4264b7202fe997045fd02f5b2953cfc2e065b2
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jan 13 16:58:06 2014 -0500

    comments, cleanup
</pre>
<h3><a name="fcdda962"/></a>fcdda962</h3>

<pre>
commit fcdda962ae277011615874845706b27ea1444357
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Mar 11 16:29:23 2014 -0400

    Increase the stray-flux clipping default; and add config maxFootprintArea to refuse to try to deblend large footprints
</pre>
<h3><a name="5268a5fc"/></a>5268a5fc</h3>

<pre>
commit 5268a5fc988b16d2a9cba524e78a2bd640b27426
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 15 11:31:29 2014 -0600

    actually set the new deblender flags
</pre>
<h3><a name="b606deab"/></a>b606deab</h3>

<pre>
commit b606deab6b402a542ffdf2720a84cf48491508b1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Apr 11 14:44:27 2014 -0400

    add config option for how to split stray flux; add NEAREST_FOOTPRINT option; reduce default max number of pixels
</pre>
<h3><a name="eabe1eb5"/></a>eabe1eb5</h3>

<pre>
commit eabe1eb5e75eac2cadb7c7cac21f02a9e3ac4062
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jun 14 11:38:26 2013 -0400

    Add config options to control stray flux and edge handling
</pre>
<h3><a name="8aa3e8af"/></a>8aa3e8af</h3>

<pre>
commit 8aa3e8afdea938d5ff93292bc183bc5f39060842
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Apr 23 12:37:36 2015 -0400

    Propagate peak flags to sources for parents.
</pre>
<h3><a name="a8cf6c22"/></a>a8cf6c22</h3>

<pre>
commit a8cf6c22df14494d6dcf2d7354c695cba9506301
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Mar 18 11:49:14 2015 -0400

    Clarify tiny footprint limit
    
    The tiny footprint limit cannot be reduced below 2 because the
    "PSF dx" calculation involves shifting the PSF by one pixel to
    the left and to the right (for a total of 2; and then we need
    some pixels remaining, so the footprint must be larger than that).
    Added comments to this effect, and enforced the limit in the
    SourceDeblendConfig.
</pre>
<h3><a name="91a61523"/></a>91a61523</h3>

<pre>
commit 91a615239492b0b84e0a6e9f1001122507120981
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Apr 16 17:41:55 2014 -0400

    Ensure parent footprints include all their children
</pre>
<h3><a name="05347b2b"/></a>05347b2b</h3>

<pre>
commit 05347b2bfa025910481e48be8d3d5086a5901303
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed May 20 16:12:56 2015 -0400

    add limits on masked pixels in a parent
    
    If the fractional limit of masked pixels is violated, the source will
    be skipped.  This is principally to deal with very long deblending times
    for artifacts in the vignetted area of the camera.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5268a5fc"/></a>5268a5fc</h3>

<pre>
commit 5268a5fc988b16d2a9cba524e78a2bd640b27426
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 15 11:31:29 2014 -0600

    actually set the new deblender flags
</pre>
<h3><a name="846a6363"/></a>846a6363</h3>

<pre>
commit 846a6363c691d7b1c5424f70893f37694e7ad850
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 17 10:48:03 2014 -0600

    deblender: convertNamesToCamelCase
</pre>
<h3><a name="b0576025"/></a>b0576025</h3>

<pre>
commit b057602571ed50cf3838c9b3aae522767bf2bf12
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 09:37:02 2014 -0400

    add a maximum footprint area for deblending
</pre>
<h3><a name="8ae91faf"/></a>8ae91faf</h3>

<pre>
commit 8ae91faf9a41cdef74129295c49c950d01bc94cb
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Mon Mar 16 17:00:58 2015 -0400

    Clarify comments RE updating parent footprint to include all children
</pre>
<h3><a name="2d7b7d59"/></a>2d7b7d59</h3>

<pre>
commit 2d7b7d591f894d9d2f5617b9e463b77e7470cf89
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jan 7 15:16:03 2014 -0600

    revert most of the debugging output; handle deblend children with no heavyFootprint due to maxSourcesToDeblend
</pre>
<h3><a name="9ea0a1be"/></a>9ea0a1be</h3>

<pre>
commit 9ea0a1bee69d2f18a76d2af6dfd7ffcaae37de98
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Mon Dec 1 18:10:21 2014 +0900

    add a config option indicating all peaks must produce a child.
</pre>
<h3><a name="dde33c6e"/></a>dde33c6e</h3>

<pre>
commit dde33c6eadf436e532d917feee876cee127e485c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jan 3 14:31:29 2014 -0500

    whitespace changes; and make tinyFootprintSize configurable
</pre>
<h3><a name="3dbc7ffc"/></a>3dbc7ffc</h3>

<pre>
commit 3dbc7ffc6f1eb36a4283d77fed483d4edf597cf6
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Dec 18 15:00:29 2014 -0500

    Propagate fields from PeakRecords to SourceRecords.
    
    Peaks can now contain extra information, such as their filter of origin.
    When we create a SourceRecord from a PeakRecord, we want to transfer
    that information.
    
    Conflicts:
        python/lsst/meas/deblender/deblend.py
</pre>
<h3><a name="25a44b26"/></a>25a44b26</h3>

<pre>
commit 25a44b267636c1f1ee2a29e0b70732aa3015a739
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Thu Apr 16 17:16:58 2015 -0400

    Remove whitespace, update copyright, and minor formatting
</pre>
<h3><a name="ab2935bf"/></a>ab2935bf</h3>

<pre>
commit ab2935bfd807b1f71ae1f096d4ff07c292b6a03d
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Thu Dec 4 17:26:13 2014 +0900

    set only non-defaulted deblend info
</pre>
<h3><a name="5058a1a0"/></a>5058a1a0</h3>

<pre>
commit 5058a1a0cda369b1e810a12102e298f78d2a4f6f
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Dec 19 15:18:19 2014 -0500

    More updates to switch from Peak to PeakRecord
</pre>
<h3><a name="061bf0ed"/></a>061bf0ed</h3>

<pre>
commit 061bf0ede1d7a8bae8dfff590f88710c153f5034
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jun 10 11:20:46 2013 -0400

    move deblend.py (SourceDeblendTask) from meas_alg to meas_deblender
</pre>
<h3><a name="713a58b2"/></a>713a58b2</h3>

<pre>
commit 713a58b27e4ca8cb84909b644a95aecc717cc9f2
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Dec 10 19:09:45 2014 -0500

    Make low-level deblend failures fatal
    
    With the new requirement that deblending happen consistently
    in all bands, we can no longer handle occasional unexplained
    failures by simply leaving the parent as-is.
    
    However, the old behavior, which caught exceptions, warned
    about them, and set a flag, can still be enabled via config.
    
    Conflicts:
        python/lsst/meas/deblender/deblend.py
</pre>
<h3><a name="22f14a7e"/></a>22f14a7e</h3>

<pre>
commit 22f14a7e9f5235f5cc3bd6f48b45f281d3139926
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Sat Mar 14 12:21:15 2015 -0700

    Remove ability to work on version 0 files
</pre>
<h3><a name="5e8566c9"/></a>5e8566c9</h3>

<pre>
commit 5e8566c9d8694caf93a4250c8a2833d4f4dd5725
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Thu Dec 4 17:25:29 2014 +0900

    remove extra peaks from footprint [review]
</pre>
<h3><a name="c813cc7d"/></a>c813cc7d</h3>

<pre>
commit c813cc7db1034c862f517b0fdb01816d898675c1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Apr 11 14:44:27 2014 -0400

    Deblending: add config option for how to split stray flux; add NEAREST_FOOTPRINT option; reduce default max number of pixels
</pre>
<h3><a name="fcdda962"/></a>fcdda962</h3>

<pre>
commit fcdda962ae277011615874845706b27ea1444357
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Mar 11 16:29:23 2014 -0400

    Increase the stray-flux clipping default; and add config maxFootprintArea to refuse to try to deblend large footprints
</pre>
<h3><a name="503b7186"/></a>503b7186</h3>

<pre>
commit 503b71865059e818065c28e96cfd20a31cb2a6ac
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Wed Jul 2 22:51:49 2014 -1000

    Added hooks to allow for doxygenation of SourceDeblendTask
</pre>
<h3><a name="95da1cb7"/></a>95da1cb7</h3>

<pre>
commit 95da1cb78d7cf4e9bf27d263c721b57e400d968b
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Thu Jun 19 20:35:47 2014 -0500

    Changes to work with both tableVersions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_12"><a name="python/lsst/meas/deblender/deblenderLib.i"/></a>python/lsst/meas/deblender/deblenderLib.i</h1>

<h3 id="toc_13">Diff:</h3>

<pre>
                // -*- lsst-c++ -*-
                %define meas_deblenderLib_DOCSTRING
                "
                Python interface to lsst::meas::deblender classes
                "
                %enddef
                
                %feature("autodoc", "1");
                
                %module(package="lsst.meas.deblender", docstring=meas_deblenderLib_DOCSTRING) deblenderLib
                
                %{
                #include <exception>
                #include <list>
                #include <boost/shared_ptr.hpp>
                #include "lsst/meas/deblender/Baseline.h"
                #include "lsst/afw/table.h"
                #include "lsst/afw/detection.h"
                #include "lsst/pex/logging.h"
                #include "lsst/afw/cameraGeom.h"
                #include "lsst/afw/math.h"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#65c85a57">65c85a57</a> + </div>
                #include "lsst/afw/image.h"
                %}
                
                %inline %{
                namespace lsst { namespace afw {
                        namespace detection { }
                        namespace image { }
                } }
                using namespace lsst;
                using namespace lsst::afw::image;
                using namespace lsst::afw::detection;
                %}
                
                %include "lsst/p_lsstSwig.i"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#3d5d9223">3d5d9223</a> + %initializeNumPy(meas_deblender)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#3d5d9223">3d5d9223</a> + </div>
                %include "lsst/base.h"                  // PTR(); should be in p_lsstSwig.i
                
                %lsst_exceptions();
                
                %import "lsst/afw/table/io/ioLib.i"
                %import "lsst/afw/image/imageLib.i"
                %import "lsst/afw/detection/detectionLib.i"
                
                %apply bool *OUTPUT { bool *patchedEdges };
                
                %include "lsst/meas/deblender/Baseline.h"
                
                %template(BaselineUtilsF) lsst::meas::deblender::BaselineUtils<float>;
                
                %template(pairMaskedImageFPtrAndFootprintPtr) std::pair<lsst::meas::deblender::BaselineUtils<float>::MaskedImagePtrT, lsst::meas::deblender::BaselineUtils<float>::FootprintPtrT>;
                
                /******************************************************************************/
                // Local Variables: ***
                // eval: (setq indent-tabs-mode nil) ***
                // End: ***
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="65c85a57"/></a>65c85a57</h3>

<pre>
commit 65c85a57e155c8e93b532a817cb5ed98e05b4e1a
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jun 29 16:57:15 2012 -0400

    compensate for changes in afw master
</pre>
<h3><a name="3d5d9223"/></a>3d5d9223</h3>

<pre>
commit 3d5d922365aef063bd79364d6206e04ba222d217
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Apr 8 17:05:47 2015 -0400

    Utilize new numeric scalar typemaps and NumPy initialization macro
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_14"><a name="ups/meas_deblender.table"/></a>ups/meas_deblender.table</h1>

<h3 id="toc_15">Diff:</h3>

<pre>
                setupRequired(utils)
                setupRequired(afw)
                setupRequired(meas_algorithms)
                
                setupOptional(matplotlib)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#^8b0177d">^8b0177d</a> - envAppend(LD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)</div>
              ?    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#5e554825">5e554825</a> + envPrepend(LD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)</div>
              ?    ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#^8b0177d">^8b0177d</a> - envAppend(DYLD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)</div>
              ?    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#5e554825">5e554825</a> + envPrepend(DYLD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)</div>
              ?    ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#^8b0177d">^8b0177d</a> - envAppend(PYTHONPATH, ${PRODUCT_DIR}/python)</div>
              ?    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#5e554825">5e554825</a> + envPrepend(PYTHONPATH, ${PRODUCT_DIR}/python)</div>
              ?    ^^^
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="^8b0177d"/></a>^8b0177d</h3>

<pre>

</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5e554825"/></a>5e554825</h3>

<pre>
commit 5e554825dd2221659d5e9ecc996ac3fcc78d8429
Author: Robyn Allsman <robyn@LSST.org>
Date:   Mon Nov 17 10:26:24 2014 -0600

    Replace envAppend with envPrepend in ups table files.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_16"><a name="tests/fit_psf.py"/></a>tests/fit_psf.py</h1>

<h3 id="toc_17">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                try:
                    import matplotlib
                    matplotlib.use('Agg')
                    import pylab as plt
                    doPlot = True
                except:
                    doPlot = False
                
                
                import unittest
                import lsst.utils.tests         as utilsTests
                
                import numpy as np
                
                import lsst.afw.detection as afwDet
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.pex.logging as pexLogging
                import lsst.meas.algorithms as measAlg
                from lsst.meas.deblender.baseline import _fitPsf, CachingPsf, PerPeak
                
                class FitPsfTestCase(unittest.TestCase):
                    def test1(self):
                
                        # circle
                        fp = afwDet.Footprint(afwGeom.Point2I(50,50), 45.)
                
                        #
                        psfsig = 1.5
                        psffwhm = psfsig * 2.35
                        psf1 = measAlg.DoubleGaussianPsf(11, 11, psfsig)
                
                        psf2 = measAlg.DoubleGaussianPsf(100, 100, psfsig)
                
                
                        fbb = fp.getBBox()
                        print 'fbb', fbb.getMinX(), fbb.getMaxX(), fbb.getMinY(), fbb.getMaxY()
                        
                        fmask = afwImage.MaskU(fbb)
                        fmask.setXY0(fbb.getMinX(), fbb.getMinY())
                        afwDet.setMaskFromFootprint(fmask, fp, 1)
                
                        sig1 = 10.
                
                        img = afwImage.ImageF(fbb)
                        A = img.getArray()
                        A += np.random.normal(0, sig1, size=(fbb.getHeight(), fbb.getWidth()))
                        print 'img x0,y0', img.getX0(), img.getY0()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#eb557384">eb557384</a> -         print 'BBox', img.getBBox(afwImage.PARENT)</div>
              ?                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#5ea010ad">5ea010ad</a> +         print 'BBox', img.getBBox()</div>
                
                        peaks = afwDet.PeakCatalog(afwDet.PeakTable.makeMinimalSchema())
                    def makePeak(x, y):
                            p = peaks.addNew()
                            p.setFx(x)
                            p.setFy(y)
                            p.setIx(int(x))
                            p.setIy(int(y))
                            return p
                        pk1 = makePeak(20., 30.)
                        pk2 = makePeak(23., 33.)
                        pk3 = makePeak(92., 50.)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#eb557384">eb557384</a> -         ibb = img.getBBox(afwImage.PARENT)</div>
              ?                           ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#5ea010ad">5ea010ad</a> +         ibb = img.getBBox()</div>
                        iext = [ibb.getMinX(), ibb.getMaxX(), ibb.getMinY(), ibb.getMaxY()]
                        ix0,iy0 = iext[0], iext[2]
                
                        pbbs = []
                        pxys = []
                        
                        fluxes = [10000., 5000., 5000.]
                        for pk,f in zip(peaks, fluxes):
                            psfim = psf1.computeImage(afwGeom.Point2D(pk.getFx(), pk.getFy()))
                            print 'psfim x0,y0', psfim.getX0(), psfim.getY0()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#3e624183">3e624183</a> -             pbb = psfim.getBBox(afwImage.PARENT)</div>
              ?                                 ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#5ea010ad">5ea010ad</a> +             pbb = psfim.getBBox()</div>
                            print 'pbb', pbb.getMinX(), pbb.getMaxX(), pbb.getMinY(), pbb.getMaxY()
                            pbb.clip(ibb)
                            print 'clipped pbb', pbb.getMinX(), pbb.getMaxX(), pbb.getMinY(), pbb.getMaxY()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#3e624183">3e624183</a> -             psfim = psfim.Factory(psfim, pbb, afwImage.PARENT)</div>
              ?                                             -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#5ea010ad">5ea010ad</a> +             psfim = psfim.Factory(psfim, pbb)</div>
                
                            psfa = psfim.getArray()
                            psfa /= psfa.sum()
                            img.getArray()[pbb.getMinY() - iy0: pbb.getMaxY()+1 - iy0,
                                           pbb.getMinX() - ix0: pbb.getMaxX()+1 - ix0] += f * psfa
                
                            pbbs.append((pbb.getMinX(), pbb.getMaxX(), pbb.getMinY(), pbb.getMaxY()))
                            pxys.append((pk.getFx(), pk.getFy()))
                
                
                        if doPlot:
                            plt.clf()
                            plt.imshow(img.getArray(), extent=iext, interpolation='nearest', origin='lower')
                            ax = plt.axis()
                            x0,x1,y0,y1 = fbb.getMinX(), fbb.getMaxX(), fbb.getMinY(), fbb.getMaxY()
                            plt.plot([x0,x0,x1,x1,x0], [y0,y1,y1,y0,y0], 'k-')
                            for x0,x1,y0,y1 in pbbs:
                                plt.plot([x0,x0,x1,x1,x0], [y0,y1,y1,y0,y0], 'r-')
                            for x,y in pxys:
                                plt.plot(x, y, 'ro')
                            plt.axis(ax)
                            plt.savefig('img.png')
                
                        varimg = afwImage.ImageF(fbb)
                        varimg.set(sig1**2)
                
                        psf_chisq_cut1 = psf_chisq_cut2 = psf_chisq_cut2b = 1.5
                
                        pkres = PerPeak()
                
                        loglvl = pexLogging.Log.INFO
                        #if verbose:
                        #    loglvl = pexLogging.Log.DEBUG
                        log = pexLogging.Log(pexLogging.Log.getDefaultLog(), 'tests.fit_psf', loglvl)
                
                        cpsf = CachingPsf(psf1)
                
                        peaksF = [pk.getF() for pk in peaks]
                        pkF = pk1.getF()
                
                        _fitPsf(fp, fmask, pk1, pkF, pkres, fbb, peaks, peaksF, log, cpsf, psffwhm,
                                 img, varimg,
                                 psf_chisq_cut1, psf_chisq_cut2, psf_chisq_cut2b)
                        for k in dir(pkres):
                            if k.startswith('__'):
                                continue
                            print '  ', k, getattr(pkres, k)
                
                        cpsf = CachingPsf(psf2)
                        _fitPsf(fp, fmask, pk1, pkF, pkres, fbb, peaks, peaksF, log, cpsf, psffwhm,
                                 img, varimg,
                                 psf_chisq_cut1, psf_chisq_cut2, psf_chisq_cut2b)
                        for k in dir(pkres):
                            if k.startswith('__'):
                                continue
                            print '  ', k, getattr(pkres, k)
                
                
                        pkF = pk3.getF()
                        _fitPsf(fp, fmask, pk3, pkF, pkres, fbb, peaks, peaksF, log, cpsf, psffwhm,
                                 img, varimg,
                                 psf_chisq_cut1, psf_chisq_cut2, psf_chisq_cut2b)
                        for k in dir(pkres):
                            if k.startswith('__'):
                                continue
                            print '  ', k, getattr(pkres, k)
                
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    utilsTests.init()
                    suites = []
                    suites += unittest.makeSuite(FitPsfTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                 
                if __name__ == "__main__":
                    run(True)
                
                
                
                
                
                
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="3e624183"/></a>3e624183</h3>

<pre>
commit 3e624183e372e389542a6a3629cfacb2973e76f9
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Sep 10 15:33:56 2012 -0500

    add some documentation to _fit_psf* functions; tweak fit_psf.py (so-called) test to at least run
</pre>
<h3><a name="eb557384"/></a>eb557384</h3>

<pre>
commit eb5573846c8e0de47ada3e2c9510f8272915f743
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jul 9 16:40:42 2012 -0500

    Make some plots showing the A matrix terms -- find & fix ramp-weight bug
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_18"><a name="python/lsst/meas/deblender/baseline.py"/></a>python/lsst/meas/deblender/baseline.py</h1>

<h3 id="toc_19">Diff:</h3>

<pre>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1    <a href="#dcb164e2">dcb164e2</a> + #!/usr/bin/env python</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
2    <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#dcb164e2">dcb164e2</a> + # LSST Data Management System</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#dcb164e2">dcb164e2</a> + # Copyright 2008-2015  AURA/LSST.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#dcb164e2">dcb164e2</a> + # This product includes software developed by the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#dcb164e2">dcb164e2</a> + # LSST Project (http://www.lsst.org/).</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
10   <a href="#dcb164e2">dcb164e2</a> + # This program is free software: you can redistribute it and/or modify</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#dcb164e2">dcb164e2</a> + # it under the terms of the GNU General Public License as published by</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#dcb164e2">dcb164e2</a> + # the Free Software Foundation, either version 3 of the License, or</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#dcb164e2">dcb164e2</a> + # (at your option) any later version.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#dcb164e2">dcb164e2</a> + # This program is distributed in the hope that it will be useful,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#dcb164e2">dcb164e2</a> + # but WITHOUT ANY WARRANTY; without even the implied warranty of</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#dcb164e2">dcb164e2</a> + # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#dcb164e2">dcb164e2</a> + # GNU General Public License for more details.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#dcb164e2">dcb164e2</a> + #</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#dcb164e2">dcb164e2</a> + # You should have received a copy of the LSST License Statement and</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
21   <a href="#dcb164e2">dcb164e2</a> + # the GNU General Public License along with this program.  If not,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#dcb164e2">dcb164e2</a> + # see <https://www.lsstcorp.org/LegalNotices/>.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#dcb164e2">dcb164e2</a> + #</div>
                import math
                import numpy as np
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#8f605f1f">8f605f1f</a> - import time</div>
                
                import lsst.pex.exceptions
                import lsst.afw.image as afwImage
                import lsst.afw.detection as afwDet
                import lsst.afw.geom  as afwGeom
                import lsst.afw.math  as afwMath
                
                # Result objects; will probably go away as we push more results
                # into earlier-created Source objects, but useful for now for
                # hauling debugging results around.
                
                class PerFootprint(object):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#d62b5dc4">d62b5dc4</a> -     Result of deblending a single parent Footprint.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#dcb164e2">dcb164e2</a> +     """Result of deblending a single parent Footprint."""</div>
              ?     +++                                               +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#d62b5dc4">d62b5dc4</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
                    def __init__(self, fp, peaks=None):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#d62b5dc4">d62b5dc4</a> -         '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#dcb164e2">dcb164e2</a> +         """!</div>
                        Creates a result object for the given parent Footprint 'fp'.
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#d62b5dc4">d62b5dc4</a> -         fp: Footprint</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#dcb164e2">dcb164e2</a> +         @param[in]      fp     Footprint</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#d62b5dc4">d62b5dc4</a> -         peaks: if specified, the list of peaks to use; default is</div>
              ?              ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#dcb164e2">dcb164e2</a> +         @param[in,out]  peaks  If specified, the list of peaks to use; default is</div>
              ?       ++++++++++++++++       ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#d62b5dc4">d62b5dc4</a> -                fp.getPeaks().</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#dcb164e2">dcb164e2</a> +                                fp.getPeaks().</div>
              ? ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#d62b5dc4">d62b5dc4</a> -         '''</div>
              ?         ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#dcb164e2">dcb164e2</a> +         """</div>
              ?         ^^^
                        # PerPeak objects, one per Peak
                        self.peaks = []
                        if peaks is None:
                            peaks = fp.getPeaks()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#d62b5dc4">d62b5dc4</a> -         for pki,pk in enumerate(peaks):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#dcb164e2">dcb164e2</a> +         for pki, pk in enumerate(peaks):</div>
              ?                 +
                            pkres = PerPeak()
                            pkres.peak = pk
                            pkres.pki = pki
                            self.peaks.append(pkres)
                
                        self.templateSum = None
                
                    def setTemplateSum(self, tsum):
                        self.templateSum = tsum
                
                class PerPeak(object):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#dcb164e2">dcb164e2</a> +     """!</div>
                    Result of deblending a single Peak within a parent Footprint.
                
                    There is one of these objects for each Peak in the Footprint.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#dcb164e2">dcb164e2</a> +     """</div>
                    def __init__(self):
                        # Peak object
                        self.peak = None
                        # int, peak index number
                        self.pki = None
                        # union of all the ways of failing...
                        self.skip = False
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#dcb164e2">dcb164e2</a> + </div>
                        self.outOfBounds = False
                        self.tinyFootprint = False
                        self.noValidPixels = False
                        self.deblendedAsPsf = False
                
                        # Field set during _fitPsf:
                        self.psfFitFailed = False
                        self.psfFitBadDof = False
                        # (chisq, dof) for PSF fit without decenter
                        self.psfFit1 = None
                        # (chisq, dof) for PSF fit with decenter
                        self.psfFit2 = None
                        # (chisq, dof) for PSF fit after applying decenter
                        self.psfFit3 = None
                        # decentered PSF fit wanted to move the center too much
                        self.psfFitBigDecenter = False
                        # was the fit with decenter better?
                        self.psfFitWithDecenter = False
                        #
                        self.psfFitR0 = None
                        self.psfFitR1 = None
                        self.psfFitStampExtent = None
                        self.psfFitCenter = None
                        self.psfFitBest = None
                        self.psfFitParams = None
                        self.psfFitFlux = None
                        self.psfFitNOthers = None
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#dcb164e2">dcb164e2</a> + </div>
                        # Things only set in _fitPsf when debugging is turned on:
                        self.psfFitDebugPsf0Img = None
                        self.psfFitDebugPsfImg = None
                        self.psfFitDebugPsfDerivImg = None
                        self.psfFitDebugPsfModel = None
                
                        self.failedSymmetricTemplate = False
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#dcb164e2">dcb164e2</a> + </div>
                        # The actual template MaskedImage and Footprint
                        self.templateMaskedImage = None
                        self.templateFootprint = None
                
                        # The flux assigned to this template -- a MaskedImage
                        self.fluxPortion = None
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#005add45">005add45</a> -         # The stray flux assigned to this template (may be None),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#dcb164e2">dcb164e2</a> +         # The stray flux assigned to this template (may be None), a HeavyFootprint</div>
              ?                                                                  +++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#005add45">005add45</a> -         # a HeavyFootprint</div>
                        self.strayFlux = None
                
                        self.hasRampedTemplate = False
                
                        self.patched = False
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#577f14a3">577f14a3</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#dcb164e2">dcb164e2</a> + </div>
                        # debug -- a copy of the original symmetric template
                        self.origTemplate = None
                        self.origFootprint = None
                        # MaskedImage
                        self.rampedTemplate = None
                        # MaskedImage
                        self.medianFilteredTemplate = None
                
                        # when least-squares fitting templates, the template weight.
                        self.templateWeight = 1.0
                
                    def __str__(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#846a6363">846a6363</a> -         return (('Per-peak deblend result: outOfBounds: %s, ' +</div>
              ?                                                              ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#dcb164e2">dcb164e2</a> +         return (('Per-peak deblend result: outOfBounds: %s, deblendedAsPsf: %s') %</div>
              ?                                                             ++++++++++++++++++ ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#846a6363">846a6363</a> -                 'deblendedAsPsf: %s') %</div>
                                (self.outOfBounds, self.deblendedAsPsf))
                
                    @property
                    def psfFitChisq(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#846a6363">846a6363</a> -         chisq,dof = self.psfFitBest</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#dcb164e2">dcb164e2</a> +         chisq, dof = self.psfFitBest</div>
              ?               +
                        return chisq
                    @property
                    def psfFitDof(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#846a6363">846a6363</a> -         chisq,dof = self.psfFitBest</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#dcb164e2">dcb164e2</a> +         chisq, dof = self.psfFitBest</div>
              ?               +
                        return dof
                
                    def getFluxPortion(self, strayFlux=True):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#6e406c53">6e406c53</a> -         '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#dcb164e2">dcb164e2</a> +         """!</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#6e406c53">6e406c53</a> -         Return a HeavyFootprint containing the flux apportioned to</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#dcb164e2">dcb164e2</a> +         Return a HeavyFootprint containing the flux apportioned to this peak.</div>
              ?                                                                   +++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#6e406c53">6e406c53</a> -         this peak.</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#6e406c53">6e406c53</a> -         'strayFlux': include stray flux also?</div>
              ?         ^         ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#dcb164e2">dcb164e2</a> +         @param[in]     strayFlux   include stray flux also?</div>
              ?         ^^^^^^^^^^^^^^^         ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#6e406c53">6e406c53</a> -         '''</div>
              ?         ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#dcb164e2">dcb164e2</a> +         """</div>
              ?         ^^^
                        if self.templateFootprint is None or self.fluxPortion is None:
                            return None
                        heavy = afwDet.makeHeavyFootprint(self.templateFootprint,
                                                          self.fluxPortion)
                        if strayFlux:
                            if self.strayFlux is not None:
                                heavy.normalize()
                                self.strayFlux.normalize()
                                heavy = afwDet.mergeHeavyFootprintsF(heavy, self.strayFlux)
                
                        return heavy
                
                    def setStrayFlux(self, stray):
                        self.strayFlux = stray
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#846a6363">846a6363</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#dcb164e2">dcb164e2</a> + </div>
                    def setFluxPortion(self, mimg):
                        self.fluxPortion = mimg
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#dcb164e2">dcb164e2</a> + </div>
                    def setTemplateWeight(self, w):
                        self.templateWeight = w
                
                    def setPatched(self):
                        self.patched = True
                
                    # DEBUG
                    def setOrigTemplate(self, t, tfoot):
                        self.origTemplate = t.getImage().Factory(t.getImage(), True)
                        self.origFootprint = tfoot
                    def setRampedTemplate(self, t, tfoot):
                        self.hasRampedTemplate = True
                        self.rampedTemplate = t.getImage().Factory(t.getImage(), True)
                    def setMedianFilteredTemplate(self, t, tfoot):
                        self.medianFilteredTemplate = t.getImage().Factory(t.getImage(), True)
                    def setPsfTemplate(self, tim, tfoot):
                        self.psfFootprint = afwDet.Footprint(tfoot)
                        self.psfTemplate = tim.Factory(tim, True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#dcb164e2">dcb164e2</a> + </div>
                    def setOutOfBounds(self):
                        self.outOfBounds = True
                        self.skip = True
                
                    def setTinyFootprint(self):
                        self.tinyFootprint = True
                        self.skip = True
                
                    def setNoValidPixels(self):
                        self.noValidPixels = True
                        self.skip = True
                
                    def setPsfFitFailed(self):
                        self.psfFitFailed = True
                
                    def setBadPsfDof(self):
                        self.psfFitBadDof = True
                
                    def setDeblendedAsPsf(self):
                        self.deblendedAsPsf = True
                
                    def setFailedSymmetricTemplate(self):
                        self.failedSymmetricTemplate = True
                        self.skip = True
                
                    def setTemplate(self, maskedImage, footprint):
                        self.templateMaskedImage = maskedImage
                        self.templateFootprint = footprint
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#d62b5dc4">d62b5dc4</a> -         </div>
                
                def deblend(footprint, maskedImage, psf, psffwhm,
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#dcb164e2">dcb164e2</a> +             psfChisqCut1=1.5, psfChisqCut2=1.5, psfChisqCut2b=1.5, fitPsfs=True,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#846a6363">846a6363</a> -             psfChisqCut1 = 1.5,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#846a6363">846a6363</a> -             psfChisqCut2 = 1.5,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#846a6363">846a6363</a> -             psfChisqCut2b = 1.5,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#846a6363">846a6363</a> -             fitPsfs = True,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#846a6363">846a6363</a> -             medianSmoothTemplate=True,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#dcb164e2">dcb164e2</a> +             medianSmoothTemplate=True, medianFilterHalfsize=2,</div>
              ?                                       ++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#846a6363">846a6363</a> -             medianFilterHalfsize=2,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#846a6363">846a6363</a> -             monotonicTemplate=True,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#dcb164e2">dcb164e2</a> +             monotonicTemplate=True, weightTemplates=False,</div>
              ?                                    +++++++++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#dcb164e2">dcb164e2</a> +             log=None, verbose=False, sigma1=None, maxNumberOfPeaks=0,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#846a6363">846a6363</a> -             weightTemplates=False,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#497d2eac">497d2eac</a> -             log=None, verbose=False,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#79582bd3">79582bd3</a> -             sigma1=None,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#ac0865d5">ac0865d5</a> -             maxNumberOfPeaks=0,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#9223a489">9223a489</a> -             findStrayFlux=True,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#fc8fd79d">fc8fd79d</a> -             assignStrayFlux=True,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#dcb164e2">dcb164e2</a> +             findStrayFlux=True, assignStrayFlux=True,</div>
              ?            ++++++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#dcb164e2">dcb164e2</a> +             strayFluxToPointSources='necessary', strayFluxAssignment='r-to-peak',</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#dcb164e2">dcb164e2</a> +             rampFluxAtEdge=False, patchEdges=False, tinyFootprintSize=2,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#fc8fd79d">fc8fd79d</a> -             strayFluxToPointSources='necessary',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#b606deab">b606deab</a> -             strayFluxAssignment='r-to-peak',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#ad2c8388">ad2c8388</a> -             rampFluxAtEdge=False,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#dde33c6e">dde33c6e</a> -             patchEdges=False,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#dde33c6e">dde33c6e</a> -             tinyFootprintSize=2,</div>
                            getTemplateSum=False,
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#dcb164e2">dcb164e2</a> +             clipStrayFluxFraction=0.001, clipFootprintToNonzero=True,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#29b043e7">29b043e7</a> -             clipStrayFluxFraction=0.001,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#29b043e7">29b043e7</a> -             clipFootprintToNonzero=True,</div>
                            ):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#9c47f7bf">9c47f7bf</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#dcb164e2">dcb164e2</a> +     """!</div>
                    Deblend a single ``footprint`` in a ``maskedImage``.
                
                    Each ``Peak`` in the ``Footprint`` will produce a deblended child.
                
                    psfChisqCut1, psfChisqCut2: used when deciding whether a given
                    peak looks like a point source.  We build a small local model of
                    background + peak + neighboring peaks.  These are the
                    chi-squared-per-degree-of-freedom cuts (1=without and 2=with terms
                    allowing the peak position to move); larger values will result in
                    more peaks being classified as PSFs.
                
                    psfChisqCut2b: if the with-decenter fit is accepted, we then
                    apply the computed dx,dy to the source position and re-fit without
                    decentering.  The model is accepted if its chi-squared-per-DOF is
                    less than this value.
                
                    maxNumberOfPeaks: if positive, only deblend the brightest
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#d62b5dc4">d62b5dc4</a> -             maxNumberOfPeaks peaks in the parent</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#dcb164e2">dcb164e2</a> +                       maxNumberOfPeaks peaks in the parent</div>
              ? ++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#9c47f7bf">9c47f7bf</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#dcb164e2">dcb164e2</a> +     """</div>
                    # Import C++ routines
                    import lsst.meas.deblender as deb
                    butils = deb.BaselineUtilsF
                
                    validStrayPtSrc = ['never', 'necessary', 'always']
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#d509aee5">d509aee5</a> -     validStrayAssign = ['r-to-peak', 'r-to-footprint', 'nearest-footprint', 'trim']</div>
              ?                                                                           --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#c813cc7d">c813cc7d</a> +     validStrayAssign = ['r-to-peak', 'r-to-footprint', 'nearest-footprint']</div>
                    if not strayFluxToPointSources in validStrayPtSrc:
                        raise ValueError((('strayFluxToPointSources: value \"%s\" not in the '
                                           + 'set of allowed values: ')
                                           % strayFluxToPointSources) + str(validStrayPtSrc))
                    if not strayFluxAssignment in validStrayAssign:
                        raise ValueError((('strayFluxAssignment: value \"%s\" not in the '
                                           + 'set of allowed values: ')
                                           % strayFluxAssignment) + str(validStrayAssign))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#fc8fd79d">fc8fd79d</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#dcb164e2">dcb164e2</a> + </div>
                    if log is None:
                        import lsst.pex.logging as pexLogging
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#6428a772">6428a772</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#6428a772">6428a772</a> +         component = 'meas_deblender.baseline'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#497d2eac">497d2eac</a> -         loglvl = pexLogging.Log.INFO</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#497d2eac">497d2eac</a> -         if verbose:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#497d2eac">497d2eac</a> -             loglvl = pexLogging.Log.DEBUG</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#d62b5dc4">d62b5dc4</a> -         log = pexLogging.Log(pexLogging.Log.getDefaultLog(),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#6428a772">6428a772</a> +         log = pexLogging.Log(pexLogging.Log.getDefaultLog(), component)</div>
              ?                                                             +++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#d62b5dc4">d62b5dc4</a> -                              'meas_deblender.baseline', loglvl)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#6428a772">6428a772</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#dcb164e2">dcb164e2</a> +         if verbose:      # pexLogging defines DEBUG in terms of "importance" == -verbosity</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#6428a772">6428a772</a> +             pexLogging.Trace.setVerbosity(component, -pexLogging.Log.DEBUG)</div>
                
                    img = maskedImage.getImage()
                    varimg = maskedImage.getVariance()
                    mask = maskedImage.getMask()
                
                    fp = footprint
                    fp.normalize()
                    peaks = fp.getPeaks()
                    if maxNumberOfPeaks > 0:
                        peaks = peaks[:maxNumberOfPeaks]
                
                    # Pull out the image bounds of the parent Footprint
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#ebbaa999">ebbaa999</a> -     imbb = img.getBBox(afwImage.PARENT)</div>
              ?                        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#5ea010ad">5ea010ad</a> +     imbb = img.getBBox()</div>
                    bb = fp.getBBox()
                    if not imbb.contains(bb):
                        raise ValueError(('Footprint bounding-box %s extends outside image '
                                          + 'bounding-box %s') % (str(bb), str(imbb)))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#ebbaa999">ebbaa999</a> -     W,H = bb.getWidth(), bb.getHeight()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#dcb164e2">dcb164e2</a> +     W, H = bb.getWidth(), bb.getHeight()</div>
              ?       +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#ebbaa999">ebbaa999</a> -     x0,y0 = bb.getMinX(), bb.getMinY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#dcb164e2">dcb164e2</a> +     x0, y0 = bb.getMinX(), bb.getMinY()</div>
              ?        +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#ebbaa999">ebbaa999</a> -     x1,y1 = bb.getMaxX(), bb.getMaxY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#dcb164e2">dcb164e2</a> +     x1, y1 = bb.getMaxX(), bb.getMaxY()</div>
              ?        +
                
                    # 'sigma1' is an estimate of the average noise level in this image.
                    if sigma1 is None:
                        # FIXME -- just within the bbox?
                        stats = afwMath.makeStatistics(varimg, mask, afwMath.MEDIAN)
                        sigma1 = math.sqrt(stats.getValue(afwMath.MEDIAN))
                        log.logdebug('Estimated sigma1 = %f' % sigma1)
                
                    # Add the mask planes we will set.
                    for nm in ['SYMM_1SIG', 'SYMM_3SIG', 'MONOTONIC_1SIG']:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#70d18fb5">70d18fb5</a> -         bit = mask.addMaskPlane(nm)</div>
              ?        ------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#5ea010ad">5ea010ad</a> +         mask.addMaskPlane(nm)</div>
                
                    # get object that will hold our results
                    res = PerFootprint(fp, peaks=peaks)
                
                    if fitPsfs:
                        # Find peaks that are well-fit by a PSF + background model.
                        _fitPsfs(fp, peaks, res, log, psf, psffwhm, img, varimg,
                                  psfChisqCut1, psfChisqCut2, psfChisqCut2b,
                                  tinyFootprintSize=tinyFootprintSize)
                
                    # Create templates...
                    log.logdebug(('Creating templates for footprint at x0,y0,W,H = ' +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#d62b5dc4">d62b5dc4</a> -                   '(%i,%i, %i,%i)') % (x0,y0,W,H))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#dcb164e2">dcb164e2</a> +                   '(%i, %i, %i, %i)') % (x0, y0, W, H))</div>
              ?                        +       +            +   +  +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#33db9727">33db9727</a> -     for peaki,pkres in enumerate(res.peaks):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#dcb164e2">dcb164e2</a> +     for peaki, pkres in enumerate(res.peaks):</div>
              ?               +
                        log.logdebug('Deblending peak %i of %i' % (peaki, len(res.peaks)))
                        if pkres.skip or pkres.deblendedAsPsf:
                            continue
                        pk = pkres.peak
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#8641cb3e">8641cb3e</a> -         cx,cy = pk.getIx(), pk.getIy()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#dcb164e2">dcb164e2</a> +         cx, cy = pk.getIx(), pk.getIy()</div>
              ?            +
                        if not imbb.contains(afwGeom.Point2I(cx,cy)):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#d62b5dc4">d62b5dc4</a> -             log.logdebug('Peak center is not inside image; skipping %i' %</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#dcb164e2">dcb164e2</a> +             log.logdebug('Peak center is not inside image; skipping %i' % pkres.pki)</div>
              ?                                                                          +++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#d62b5dc4">d62b5dc4</a> -                          pkres.pki)</div>
                            pkres.setOutOfBounds()
                            continue
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#d62b5dc4">d62b5dc4</a> -         log.logdebug('computing template for peak %i at (%i,%i)' %</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#dcb164e2">dcb164e2</a> +         log.logdebug('computing template for peak %i at (%i, %i)' % (pkres.pki, cx, cy))</div>
              ?                                                             +      +++++++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#dcb164e2">dcb164e2</a> +         S, patched = butils.buildSymmetricTemplate(maskedImage, fp, pk, sigma1, True, patchEdges)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#d62b5dc4">d62b5dc4</a> -                      (pkres.pki, cx, cy))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#bc602277">bc602277</a> -         S,patched = butils.buildSymmetricTemplate(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#bc602277">bc602277</a> -             maskedImage, fp, pk, sigma1, True, patchEdges)</div>
                        # SWIG doesn't know how to unpack a std::pair into a 2-tuple...
                        # (in this case, a nested pair)
                        t1, tfoot = S[0], S[1]
                        del S
                
                        if t1 is None:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#d62b5dc4">d62b5dc4</a> -             log.logdebug(('Peak %i at (%i,%i): failed to build symmetric ' +</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#dcb164e2">dcb164e2</a> +             log.logdebug(('Peak %i at (%i, %i): failed to build symmetric ' +</div>
              ?                                           +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#d62b5dc4">d62b5dc4</a> -                           'template') % (pkres.pki, cx,cy))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#dcb164e2">dcb164e2</a> +                           'template') % (pkres.pki, cx, cy))</div>
              ?                                                        +
                            pkres.setFailedSymmetricTemplate()
                            continue
                
                        if patched:
                            pkres.setPatched()
                
                        # possibly save the original symmetric template
                        pkres.setOrigTemplate(t1, tfoot)
                
                        if rampFluxAtEdge:
                            log.logdebug('Checking for significant flux at edge: sigma1=%g' % sigma1)
                        if (rampFluxAtEdge and
                            butils.hasSignificantFluxAtEdge(t1.getImage(), tfoot, 3*sigma1)):
                            log.logdebug("Template %i has significant flux at edge: ramping" % pkres.pki)
                            try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
355  <a href="#01ed1f5e">01ed1f5e</a> -                 (t2, tfoot2, patched) = _handle_flux_at_edge(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#46c0a56a">46c0a56a</a> +                 (t2, tfoot2, patched) = _handle_flux_at_edge(log, psffwhm, t1, tfoot, fp,</div>
              ?                                                              ++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
356  <a href="#01ed1f5e">01ed1f5e</a> -                     log, psffwhm, t1, tfoot, fp, maskedImage, x0,x1,y0,y1,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
357  <a href="#01ed1f5e">01ed1f5e</a> -                     psf, pk, sigma1, patchEdges)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
357  <a href="#46c0a56a">46c0a56a</a> +                                                              maskedImage, x0, x1, y0, y1,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#46c0a56a">46c0a56a</a> +                                                              psf, pk, sigma1, patchEdges)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
358  <a href="#01ed1f5e">01ed1f5e</a> -             except lsst.pex.exceptions.LsstCppException as exc:</div>
              ?                                        -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
359  <a href="#f3746e84">f3746e84</a> +             except lsst.pex.exceptions.Exception as exc:</div>
                                if (isinstance(exc.message, lsst.pex.exceptions.InvalidParameterException) and
                                    "CoaddPsf" in str(exc)):
                                    pkres.setOutOfBounds()
                                    continue
                                raise
                            pkres.setRampedTemplate(t2, tfoot2)
                            if patched:
                                pkres.setPatched()
                            t1 = t2
                            tfoot = tfoot2
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
369  <a href="#d62b5dc4">d62b5dc4</a> -                 </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
370  <a href="#dcb164e2">dcb164e2</a> + </div>
                        if medianSmoothTemplate:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
371  <a href="#846a6363">846a6363</a> -             filtsize = medianFilterHalfsize * 2 + 1</div>
              ?                                            - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
372  <a href="#dcb164e2">dcb164e2</a> +             filtsize = medianFilterHalfsize*2 + 1</div>
                            if t1.getWidth() >= filtsize and t1.getHeight() >= filtsize:
                                log.logdebug('Median filtering template %i' % pkres.pki)
                                # We want the output to go in "t1", so copy it into
                                # "inimg" for input
                                inimg = t1.Factory(t1, True)
                                butils.medianFilter(inimg, t1, medianFilterHalfsize)
                                # possible save this median-filtered template
                                pkres.setMedianFilteredTemplate(t1, tfoot)
                            else:
                                log.logdebug(('Not median-filtering template %i: size '
                                              + '%i x %i smaller than required %i x %i') %
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
383  <a href="#d62b5dc4">d62b5dc4</a> -                               (pkres.pki, t1.getWidth(), t1.getHeight(),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
384  <a href="#dcb164e2">dcb164e2</a> +                               (pkres.pki, t1.getWidth(), t1.getHeight(), filtsize, filtsize))</div>
              ?                                                                         +++++++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
385  <a href="#dcb164e2">dcb164e2</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
384  <a href="#d62b5dc4">d62b5dc4</a> -                                filtsize, filtsize))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
385  <a href="#5e5a6ff4">5e5a6ff4</a> -                 </div>
                        if monotonicTemplate:
                            log.logdebug('Making template %i monotonic' % pkres.pki)
                            butils.makeMonotonic(t1, pk)
                
                        if clipFootprintToNonzero:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#2853897c">2853897c</a> -             tfoot.clipToNonzeroF(t1.getImage())</div>
              ?                                -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#9370f92d">9370f92d</a> +             tfoot.clipToNonzero(t1.getImage())</div>
                            tfoot.normalize()
                
                        pkres.setTemplate(t1, tfoot)
                
                    # Prepare inputs to "apportionFlux" call.
                    # template maskedImages
                    tmimgs = []
                    # template footprints
                    tfoots = []
                    # deblended as psf
                    dpsf = []
                    # peak x,y
                    pkx = []
                    pky = []
                    # indices of valid templates
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#6e406c53">6e406c53</a> -     ibi = [] </div>
              ?             -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#dcb164e2">dcb164e2</a> +     ibi = []</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#33db9727">33db9727</a> -     for peaki,pkres in enumerate(res.peaks):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#dcb164e2">dcb164e2</a> +     for peaki, pkres in enumerate(res.peaks):</div>
              ?               +
                        if pkres.skip:
                            continue
                        tmimgs.append(pkres.templateMaskedImage)
                        tfoots.append(pkres.templateFootprint)
                        # for stray flux...
                        dpsf.append(pkres.deblendedAsPsf)
                        pk = pkres.peak
                        pkx.append(pk.getIx())
                        pky.append(pk.getIy())
                        ibi.append(pkres.pki)
                
                    if weightTemplates:
                        # Reweight the templates by doing a least-squares fit to the image
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
423  <a href="#8641cb3e">8641cb3e</a> -         A = np.zeros((W * H, len(tmimgs)))</div>
              ?                        - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
423  <a href="#dcb164e2">dcb164e2</a> +         A = np.zeros((W*H, len(tmimgs)))</div>
                        b = img.getArray()[y0:y1+1, x0:x1+1].ravel()
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
426  <a href="#8641cb3e">8641cb3e</a> -         for mim,i in zip(tmimgs, ibi):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
426  <a href="#dcb164e2">dcb164e2</a> +         for mim, i in zip(tmimgs, ibi):</div>
              ?                 +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
427  <a href="#8641cb3e">8641cb3e</a> -             ibb = mim.getBBox(afwImage.PARENT)</div>
              ?                               ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
427  <a href="#5ea010ad">5ea010ad</a> +             ibb = mim.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
428  <a href="#8641cb3e">8641cb3e</a> -             ix0,iy0 = ibb.getMinX(), ibb.getMinY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
428  <a href="#dcb164e2">dcb164e2</a> +             ix0, iy0 = ibb.getMinX(), ibb.getMinY()</div>
              ?                 +
                            pkres = res.peaks[i]
                            foot = pkres.templateFootprint
                            ima = mim.getImage().getArray()
                            for sp in foot.getSpans():
                                sy, sx0, sx1 = sp.getY(), sp.getX0(), sp.getX1()
                                imrow = ima[sy-iy0, sx0-ix0 : 1+sx1-ix0]
                                r0 = (sy-y0)*W
                                A[r0 + sx0-x0: r0+1+sx1-x0, i] = imrow
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
438  <a href="#8641cb3e">8641cb3e</a> -         X1,r1,rank1,s1 = np.linalg.lstsq(A, b)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
438  <a href="#dcb164e2">dcb164e2</a> +         X1, r1, rank1, s1 = np.linalg.lstsq(A, b)</div>
              ?            +   +      +
                        del A
                        del b
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
442  <a href="#8641cb3e">8641cb3e</a> -         for mim,i,w in zip(tmimgs, ibi, X1):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
442  <a href="#dcb164e2">dcb164e2</a> +         for mim, i, w in zip(tmimgs, ibi, X1):</div>
              ?                 +  +
                            im = mim.getImage()
                            im *= w
                            res.peaks[i].setTemplateWeight(w)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
447  <a href="#d62b5dc4">d62b5dc4</a> -     # FIXME -- Remove templates that are too similar (via dot-product</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
447  <a href="#dcb164e2">dcb164e2</a> +     # FIXME -- Remove templates that are too similar (via dot-product test)?</div>
              ?                                                                      +++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
448  <a href="#dcb164e2">dcb164e2</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
448  <a href="#d62b5dc4">d62b5dc4</a> -     # test)?</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
449  <a href="#5e5a6ff4">5e5a6ff4</a> -     </div>
                    # Now apportion flux according to the templates
                    log.logdebug('Apportioning flux among %i templates' % len(tmimgs))
                    sumimg = afwImage.ImageF(bb)
                    #.getDimensions())
                    #sumimg.setXY0(bb.getMinX(), bb.getMinY())
                
                    strayflux = afwDet.HeavyFootprintPtrListF()
                
                    strayopts = 0
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
459  <a href="#d509aee5">d509aee5</a> -     if strayFluxAssignment == 'trim':</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
460  <a href="#d509aee5">d509aee5</a> -         findStrayFlux = False</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
461  <a href="#d509aee5">d509aee5</a> -         strayopts |= butils.STRAYFLUX_TRIM</div>
                    if findStrayFlux:
                        strayopts |= butils.ASSIGN_STRAYFLUX
                        if strayFluxToPointSources == 'necessary':
                            strayopts |= butils.STRAYFLUX_TO_POINT_SOURCES_WHEN_NECESSARY
                        elif strayFluxToPointSources == 'always':
                            strayopts |= butils.STRAYFLUX_TO_POINT_SOURCES_ALWAYS
                
                        if strayFluxAssignment == 'r-to-peak':
                            # this is the default
                            pass
                        elif strayFluxAssignment == 'r-to-footprint':
                            strayopts |= butils.STRAYFLUX_R_TO_FOOTPRINT
                        elif strayFluxAssignment == 'nearest-footprint':
                            strayopts |= butils.STRAYFLUX_NEAREST_FOOTPRINT
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
477  <a href="#6e406c53">6e406c53</a> -     portions = butils.apportionFlux(maskedImage, fp, tmimgs, tfoots, sumimg,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
473  <a href="#dcb164e2">dcb164e2</a> +     portions = butils.apportionFlux(maskedImage, fp, tmimgs, tfoots, sumimg, dpsf,</div>
              ?                                                                             ++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
478  <a href="#aeec2864">aeec2864</a> -                                     dpsf, pkx, pky, strayflux, strayopts,</div>
              ?                                    ------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
474  <a href="#dcb164e2">dcb164e2</a> +                                     pkx, pky, strayflux, strayopts, clipStrayFluxFraction)</div>
              ?                                                                    +++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
479  <a href="#aeec2864">aeec2864</a> -                                     clipStrayFluxFraction)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
480  <a href="#d509aee5">d509aee5</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
481  <a href="#d509aee5">d509aee5</a> -     # Shrink parent to union of children</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
482  <a href="#d509aee5">d509aee5</a> -     if strayFluxAssignment == 'trim':</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
483  <a href="#d509aee5">d509aee5</a> -         fp.include(tfoots, True)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
484  <a href="#d509aee5">d509aee5</a> - </div>
                    if getTemplateSum:
                        res.setTemplateSum(sumimg)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
487  <a href="#08c0d83e">08c0d83e</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
477  <a href="#dcb164e2">dcb164e2</a> + </div>
                    # Save the apportioned fluxes
                    ii = 0
                    for j, (pk, pkres) in enumerate(zip(peaks, res.peaks)):
                        if pkres.skip:
                            continue
                        pkres.setFluxPortion(portions[ii])
                
                        if findStrayFlux:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
496  <a href="#d62b5dc4">d62b5dc4</a> -             # NOTE that due to a swig bug</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
497  <a href="#d62b5dc4">d62b5dc4</a> -             #   (https://github.com/swig/swig/issues/59)</div>
              ?               ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
486  <a href="#dcb164e2">dcb164e2</a> +             # NOTE that due to a swig bug (https://github.com/swig/swig/issues/59)</div>
              ?               ^^^^^^^^^^^^^^^^^^^^^^^^^^^
                            # we CANNOT iterate over "strayflux", but must index into it.
                            stray = strayflux[ii]
                        else:
                            stray = None
                        ii += 1
                
                        pkres.setStrayFlux(stray)
                
                    # Set child footprints to contain the right number of peaks.
                    for j, (pk, pkres) in enumerate(zip(peaks, res.peaks)):
                        if pkres.skip:
                            continue
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
511  <a href="#e2e1a694">e2e1a694</a> -         for foot,add in [(pkres.templateFootprint, True),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
500  <a href="#dcb164e2">dcb164e2</a> +         for foot, add in [(pkres.templateFootprint, True), (pkres.origFootprint, True),</div>
              ?                  +                                  +++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
512  <a href="#e2e1a694">e2e1a694</a> -                          (pkres.origFootprint, True),</div>
                                         (pkres.strayFlux, False)]:
                            if foot is None:
                                continue
                            pks = foot.getPeaks()
                            pks.clear()
                            if add:
                                pks.append(pk)
                
                    return res
                
                class CachingPsf(object):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
524  <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
512  <a href="#dcb164e2">dcb164e2</a> +     """!</div>
                    In the PSF fitting code, we request PSF models for all peaks near
                    the one being fit.  This was turning out to be quite expensive in
                    some cases.  Here, we cache the PSF models to bring the cost down
                    closer to O(N) rather than O(N^2).
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
529  <a href="#d62b5dc4">d62b5dc4</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
517  <a href="#dcb164e2">dcb164e2</a> +     """</div>
                    def __init__(self, psf):
                        self.cache = {}
                        self.psf = psf
                    def computeImage(self, cx, cy):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
534  <a href="#a42b82ff">a42b82ff</a> -         im = self.cache.get((cx,cy), None)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
522  <a href="#dcb164e2">dcb164e2</a> +         im = self.cache.get((cx, cy), None)</div>
              ?                                 +
                        if im is not None:
                            return im
                        try:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
538  <a href="#569143a1">569143a1</a> -             im = self.psf.computeImage(afwGeom.Point2D(cx,cy))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
526  <a href="#acb6bebf">acb6bebf</a> +             im = self.psf.computeImage(afwGeom.Point2D(cx, cy))</div>
              ?                                                           +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
539  <a href="#569143a1">569143a1</a> -         except lsst.pex.exceptions.LsstCppException:</div>
              ?                                    -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
527  <a href="#f3746e84">f3746e84</a> +         except lsst.pex.exceptions.Exception:</div>
                            im = self.psf.computeImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
541  <a href="#a42b82ff">a42b82ff</a> -         self.cache[(cx,cy)] = im</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
529  <a href="#dcb164e2">dcb164e2</a> +         self.cache[(cx, cy)] = im</div>
              ?                        +
                        return im
                
                def _fitPsfs(fp, peaks, fpres, log, psf, psffwhm, img, varimg,
                              psfChisqCut1, psfChisqCut2, psfChisqCut2b,
                              **kwargs):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
547  <a href="#3e624183">3e624183</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
535  <a href="#dcb164e2">dcb164e2</a> +     """!</div>
                    Fit a PSF + smooth background models to a small region around each
                    peak (plus other peaks that are nearby) in the given list of
                    peaks.
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
552  <a href="#3e624183">3e624183</a> -     fp: Footprint containing the Peaks to model</div>
              ?       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
540  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      fp           Footprint containing the Peaks to model</div>
              ? ++++++++++++++++      ^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
553  <a href="#3e624183">3e624183</a> -     peaks: a list of all the Peak objects within this Footprint</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
541  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      peaks        a list of all the Peak objects within this Footprint</div>
              ? ++++++++++++++++         ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
554  <a href="#3e624183">3e624183</a> -     fpres: a PerFootprint result object where results will be placed</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
542  <a href="#dcb164e2">dcb164e2</a> +     @param[in,out]  fpres        a PerFootprint result object where results will be placed</div>
              ?   ++++++++++++++++       ^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
543  <a href="#dcb164e2">dcb164e2</a> +     @param[in,out]  log          pex Log object</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
544  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      psf          afw PSF object</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
555  <a href="#3e624183">3e624183</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
556  <a href="#3e624183">3e624183</a> -     log: pex Log object</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
557  <a href="#3e624183">3e624183</a> -     psf: afw PSF object</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
558  <a href="#3e624183">3e624183</a> -     psffwhm: FWHM of the PSF, in pixels</div>
              ?            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
545  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      psffwhm      FWHM of the PSF, in pixels</div>
              ? ++++++++++++++++           ^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
559  <a href="#3e624183">3e624183</a> -     img: umm, the Image in which this Footprint finds itself</div>
              ?        ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
546  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      img          the Image in which this Footprint finds itself</div>
              ? ++++++++++++++++       ^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
560  <a href="#3e624183">3e624183</a> -     varimg: Variance plane</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
547  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      varimg       Variance plane</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
561  <a href="#846a6363">846a6363</a> -     psfChisqCut*: floats: cuts in chisq-per-pixel at which to accept</div>
              ?                 -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
548  <a href="#dcb164e2">dcb164e2</a> +     @param[in]      psfChisqCut* floats: cuts in chisq-per-pixel at which to accept</div>
              ? ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
562  <a href="#d62b5dc4">d62b5dc4</a> -         the PSF model</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
549  <a href="#dcb164e2">dcb164e2</a> +                                  the PSF model</div>
                
                    Results go into the fpres.peaks objects.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
565  <a href="#3e624183">3e624183</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
552  <a href="#dcb164e2">dcb164e2</a> +     """</div>
              ?     +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
566  <a href="#3e624183">3e624183</a> -     '''</div>
                    fbb = fp.getBBox()
                    cpsf = CachingPsf(psf)
                
                    # create mask image for pixels within the footprint
                    fmask = afwImage.MaskU(fbb)
                    fmask.setXY0(fbb.getMinX(), fbb.getMinY())
                    afwDet.setMaskFromFootprint(fmask, fp, 1)
                
                    # pk.getF() -- retrieving the floating-point location of the peak
                    # -- actually shows up in the profile if we do it in the loop, so
                    # grab them all here.
                    peakF = [pk.getF() for pk in peaks]
                
                    for pki,(pk,pkres,pkF) in enumerate(zip(peaks, fpres.peaks, peakF)):
                        log.logdebug('Peak %i' % pki)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
582  <a href="#846a6363">846a6363</a> -         _fitPsf(fp, fmask, pk, pkF, pkres, fbb, peaks, peakF, log, cpsf,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
568  <a href="#dcb164e2">dcb164e2</a> +         _fitPsf(fp, fmask, pk, pkF, pkres, fbb, peaks, peakF, log, cpsf, psffwhm,</div>
              ?                                                                         +++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
583  <a href="#3e624183">3e624183</a> -                  psffwhm, img, varimg,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
584  <a href="#846a6363">846a6363</a> -                  psfChisqCut1, psfChisqCut2, psfChisqCut2b,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
569  <a href="#dcb164e2">dcb164e2</a> +                 img, varimg, psfChisqCut1, psfChisqCut2, psfChisqCut2b,</div>
              ?                 ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
585  <a href="#bbaeb182">bbaeb182</a> -                  **kwargs)</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
570  <a href="#dcb164e2">dcb164e2</a> +                 **kwargs)</div>
                
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
588  <a href="#846a6363">846a6363</a> - def _fitPsf(fp, fmask, pk, pkF, pkres, fbb, peaks, peaksF, log, psf,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
573  <a href="#dcb164e2">dcb164e2</a> + def _fitPsf(fp, fmask, pk, pkF, pkres, fbb, peaks, peaksF, log, psf, psffwhm,</div>
              ?                                                                     +++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
589  <a href="#3e624183">3e624183</a> -              psffwhm, img, varimg,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
590  <a href="#846a6363">846a6363</a> -              psfChisqCut1, psfChisqCut2, psfChisqCut2b,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
574  <a href="#dcb164e2">dcb164e2</a> +             img, varimg, psfChisqCut1, psfChisqCut2, psfChisqCut2b,</div>
              ?             ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
591  <a href="#dde33c6e">dde33c6e</a> -              tinyFootprintSize=2,</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
575  <a href="#dcb164e2">dcb164e2</a> +             tinyFootprintSize=2,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
592  <a href="#bbaeb182">bbaeb182</a> -              ):</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
576  <a href="#dcb164e2">dcb164e2</a> +             ):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
593  <a href="#3e624183">3e624183</a> -     '''</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
577  <a href="#dcb164e2">dcb164e2</a> +     """!</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
594  <a href="#d62b5dc4">d62b5dc4</a> -     Fit a PSF + smooth background model (linear) to a small region</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
578  <a href="#dcb164e2">dcb164e2</a> +     Fit a PSF + smooth background model (linear) to a small region around the peak.</div>
              ?                                                                   +++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
595  <a href="#d62b5dc4">d62b5dc4</a> -     around the peak.</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
597  <a href="#3e624183">3e624183</a> -     fp: Footprint</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
580  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     fp            Footprint</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
598  <a href="#3e624183">3e624183</a> -     fmask: the Mask plane for pixels in the Footprint</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
581  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     fmask         the Mask plane for pixels in the Footprint</div>
              ? +++++++++++++++         ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
599  <a href="#3e624183">3e624183</a> -     pk: the Peak within the Footprint that we are going to fit a PSF model for</div>
              ?       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
582  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     pk            the Peak within the Footprint that we are going to fit a PSF model for</div>
              ? +++++++++++++++      ^^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
600  <a href="#3e624183">3e624183</a> -     pkF: the floating-point coordinates of this peak</div>
              ?        ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
583  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     pkF           the floating-point coordinates of this peak</div>
              ? +++++++++++++++       ^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
601  <a href="#3e624183">3e624183</a> -     pkres: a PerPeak object that will hold the results for this peak</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
584  <a href="#dcb164e2">dcb164e2</a> +     @param[in,out] pkres         a PerPeak object that will hold the results for this peak</div>
              ?    +++++++++++++++      ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
602  <a href="#3e624183">3e624183</a> -     fbb: the bounding-box of this Footprint (a Box2I)</div>
              ?        ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
585  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     fbb           the bounding-box of this Footprint (a Box2I)</div>
              ? +++++++++++++++       ^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
603  <a href="#3e624183">3e624183</a> -     peaks: a list of all the Peak objects within this Footprint</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
586  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     peaks         a list of all the Peak objects within this Footprint</div>
              ? +++++++++++++++         ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
604  <a href="#3e624183">3e624183</a> -     peaksF: a python list of the floating-point (x,y) peak locations</div>
              ?           ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
587  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     peaksF        a python list of the floating-point (x,y) peak locations</div>
              ? +++++++++++++++          ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
605  <a href="#3e624183">3e624183</a> -     log: pex Log object</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
606  <a href="#3e624183">3e624183</a> -     psf: afw PSF object</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
588  <a href="#dcb164e2">dcb164e2</a> +     @param[in,out] log           pex Log object</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
589  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     psf           afw PSF object</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
607  <a href="#3e624183">3e624183</a> -     psffwhm: FWHM of the PSF, in pixels</div>
              ?            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
590  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     psffwhm       FWHM of the PSF, in pixels</div>
              ? +++++++++++++++           ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
608  <a href="#3e624183">3e624183</a> -     img: umm, the Image in which this Footprint finds itself</div>
              ?        ^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
591  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     img           the Image in which this Footprint finds itself</div>
              ? +++++++++++++++       ^^^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
609  <a href="#3e624183">3e624183</a> -     varimg: Variance plane</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
592  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     varimg        Variance plane</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
610  <a href="#846a6363">846a6363</a> -     psfChisqCut*: floats: cuts in chisq-per-pixel at which to accept the PSF model</div>
              ?                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
593  <a href="#dcb164e2">dcb164e2</a> +     @param[in]     psfChisqCut*  floats: cuts in chisq-per-pixel at which to accept the PSF model</div>
              ? +++++++++++++++                ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
611  <a href="#3e624183">3e624183</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
594  <a href="#dcb164e2">dcb164e2</a> +     """</div>
              ?     +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
612  <a href="#3e624183">3e624183</a> -     '''</div>
                    import lsstDebug
                    # my __name__ is lsst.meas.deblender.baseline
                    debugPlots = lsstDebug.Info(__name__).plots
                    debugPsf = lsstDebug.Info(__name__).psf
                
                    # The small region is a disk out to R0, plus a ramp with
                    # decreasing weight down to R1.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
620  <a href="#a42b82ff">a42b82ff</a> -     R0 = int(math.ceil(psffwhm * 1.))</div>
              ?                               - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
602  <a href="#dcb164e2">dcb164e2</a> +     R0 = int(math.ceil(psffwhm*1.))</div>
                    # ramp down to zero weight at this radius...
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
622  <a href="#a42b82ff">a42b82ff</a> -     R1 = int(math.ceil(psffwhm * 1.5))</div>
              ?                               - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
604  <a href="#dcb164e2">dcb164e2</a> +     R1 = int(math.ceil(psffwhm*1.5))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
623  <a href="#a42b82ff">a42b82ff</a> -     S = 2 * R1</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
624  <a href="#b993573a">b993573a</a> -     cx,cy = pkF.getX(), pkF.getY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
605  <a href="#dcb164e2">dcb164e2</a> +     cx, cy = pkF.getX(), pkF.getY()</div>
              ?        +
                    psfimg = psf.computeImage(cx, cy)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
626  <a href="#a42b82ff">a42b82ff</a> -     # R2: distance to neighbouring peak in order to put it</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
607  <a href="#dcb164e2">dcb164e2</a> +     # R2: distance to neighbouring peak in order to put it into the model</div>
              ?                                                           +++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
627  <a href="#a42b82ff">a42b82ff</a> -     # into the model</div>
                    R2 = R1 + min(psfimg.getWidth(), psfimg.getHeight())/2.
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
630  <a href="#a42b82ff">a42b82ff</a> -     pbb = psfimg.getBBox(afwImage.PARENT)</div>
              ?                          ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
610  <a href="#5ea010ad">5ea010ad</a> +     pbb = psfimg.getBBox()</div>
                    pbb.clip(fbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
632  <a href="#a42b82ff">a42b82ff</a> -     px0,py0 = psfimg.getX0(), psfimg.getY0()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
612  <a href="#dcb164e2">dcb164e2</a> +     px0, py0 = psfimg.getX0(), psfimg.getY0()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
633  <a href="#bbaeb182">bbaeb182</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
613  <a href="#dcb164e2">dcb164e2</a> + </div>
                    # Make sure we haven't been given a substitute PSF that's nowhere near where we want, as may occur if
                    # "Cannot compute CoaddPsf at point (xx,yy); no input images at that point."
                    if not pbb.contains(afwGeom.Point2I(int(cx), int(cy))):
                        pkres.setOutOfBounds()
                        return
                
                    # The bounding-box of the local region we are going to fit ("stamp")
                    xlo = int(math.floor(cx - R1))
                    ylo = int(math.floor(cy - R1))
                    xhi = int(math.ceil (cx + R1))
                    yhi = int(math.ceil (cy + R1))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
645  <a href="#a42b82ff">a42b82ff</a> -     stampbb = afwGeom.Box2I(afwGeom.Point2I(xlo,ylo), afwGeom.Point2I(xhi,yhi))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
625  <a href="#dcb164e2">dcb164e2</a> +     stampbb = afwGeom.Box2I(afwGeom.Point2I(xlo, ylo), afwGeom.Point2I(xhi, yhi))</div>
              ?                                                 +                          +
                    stampbb.clip(fbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
647  <a href="#a42b82ff">a42b82ff</a> -     xlo,xhi = stampbb.getMinX(), stampbb.getMaxX()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
627  <a href="#dcb164e2">dcb164e2</a> +     xlo, xhi = stampbb.getMinX(), stampbb.getMaxX()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
648  <a href="#a42b82ff">a42b82ff</a> -     ylo,yhi = stampbb.getMinY(), stampbb.getMaxY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
628  <a href="#dcb164e2">dcb164e2</a> +     ylo, yhi = stampbb.getMinY(), stampbb.getMaxY()</div>
              ?         +
                    if xlo > xhi or ylo > yhi:
                        log.logdebug('Skipping this peak: out of bounds')
                        pkres.setOutOfBounds()
                        return
                
                    # drop tiny footprints too?
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
635  <a href="#dde33c6e">dde33c6e</a> +     if tinyFootprintSize>0 and (((xhi - xlo) < tinyFootprintSize) or</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
636  <a href="#dde33c6e">dde33c6e</a> +                                 ((yhi - ylo) < tinyFootprintSize)):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
655  <a href="#a8cf6c22">a8cf6c22</a> -     if min(stampbb.getWidth(), stampbb.getHeight()) <= max(tinyFootprintSize, 2):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
656  <a href="#a8cf6c22">a8cf6c22</a> -         # Minimum size limit of 2 comes from the "PSF dx" calculation, which involves shifting the PSF</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
657  <a href="#a8cf6c22">a8cf6c22</a> -         # by one pixel to the left and right.</div>
                        log.logdebug('Skipping this peak: tiny footprint / close to edge')
                        pkres.setTinyFootprint()
                        return
                
                    # find other peaks within range...
                    otherpeaks = []
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
664  <a href="#b993573a">b993573a</a> -     for pk2,pkF2 in zip(peaks, peaksF):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
643  <a href="#dcb164e2">dcb164e2</a> +     for pk2, pkF2 in zip(peaks, peaksF):</div>
              ?             +
                        if pk2 == pk:
                            continue
                        if pkF.distanceSquared(pkF2) > R2**2:
                            continue
                        opsfimg = psf.computeImage(pkF2.getX(), pkF2.getY())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
670  <a href="#d62b5dc4">d62b5dc4</a> -         if not opsfimg.getBBox().overlaps(stampbb):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
649  <a href="#66082910">66082910</a> +         if not opsfimg.getBBox(afwImage.LOCAL).overlaps(stampbb):</div>
              ?                                ++++++++++++++
                            continue
                        otherpeaks.append(opsfimg)
                        log.logdebug('%i other peaks within range' % len(otherpeaks))
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
675  <a href="#a42b82ff">a42b82ff</a> -     # Now we are going to do a least-squares fit for the flux</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
654  <a href="#dcb164e2">dcb164e2</a> +     # Now we are going to do a least-squares fit for the flux in this</div>
              ?                                                              ++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
676  <a href="#a42b82ff">a42b82ff</a> -     # in this PSF, plus a decenter term, a linear sky, and</div>
              ?      --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
655  <a href="#dcb164e2">dcb164e2</a> +     # PSF, plus a decenter term, a linear sky, and fluxes of nearby</div>
              ?                                                   +++++++++++++++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
656  <a href="#dcb164e2">dcb164e2</a> +     # sources (assumed point sources).  Build up the matrix...</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
677  <a href="#a42b82ff">a42b82ff</a> -     # fluxes of nearby sources (assumed point sources).  Build</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
678  <a href="#a42b82ff">a42b82ff</a> -     # up the matrix...</div>
                    # Number of terms -- PSF flux, constant sky, X, Y, + other PSF fluxes
                    NT1 = 4 + len(otherpeaks)
                    # + PSF dx, dy
                    NT2 = NT1 + 2
                    # Number of pixels -- at most
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
684  <a href="#a42b82ff">a42b82ff</a> -     NP = (1 + yhi - ylo) * (1 + xhi - xlo)</div>
              ?                         - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
662  <a href="#dcb164e2">dcb164e2</a> +     NP = (1 + yhi - ylo)*(1 + xhi - xlo)</div>
                    # indices of columns in the "A" matrix.
                    I_psf = 0
                    I_sky = 1
                    I_sky_ramp_x = 2
                    I_sky_ramp_y = 3
                    # offset of other psf fluxes:
                    I_opsf = 4
                    I_dx = NT1 + 0
                    I_dy = NT1 + 1
                
                    # Build the matrix "A", rhs "b" and weight "w".
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
696  <a href="#a42b82ff">a42b82ff</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
697  <a href="#a42b82ff">a42b82ff</a> -     ix0,iy0 = img.getX0(), img.getY0()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
674  <a href="#dcb164e2">dcb164e2</a> +     ix0, iy0 = img.getX0(), img.getY0()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
698  <a href="#a42b82ff">a42b82ff</a> -     fx0,fy0 = fbb.getMinX(), fbb.getMinY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
675  <a href="#dcb164e2">dcb164e2</a> +     fx0, fy0 = fbb.getMinX(), fbb.getMinY()</div>
              ?         +
                    fslice = (slice(ylo-fy0, yhi-fy0+1), slice(xlo-fx0, xhi-fx0+1))
                    islice = (slice(ylo-iy0, yhi-iy0+1), slice(xlo-ix0, xhi-ix0+1))
                    fmask_sub = fmask .getArray()[fslice]
                    var_sub   = varimg.getArray()[islice]
                    img_sub   = img   .getArray()[islice]
                
                    # Clip the PSF image to match its bbox
                    psfarr = psfimg.getArray()[pbb.getMinY()-py0: 1+pbb.getMaxY()-py0,
                                               pbb.getMinX()-px0: 1+pbb.getMaxX()-px0]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
708  <a href="#0d8dc136">0d8dc136</a> -     px0,px1 = pbb.getMinX(), pbb.getMaxX()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
685  <a href="#dcb164e2">dcb164e2</a> +     px0, px1 = pbb.getMinX(), pbb.getMaxX()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
709  <a href="#0d8dc136">0d8dc136</a> -     py0,py1 = pbb.getMinY(), pbb.getMaxY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
686  <a href="#dcb164e2">dcb164e2</a> +     py0, py1 = pbb.getMinY(), pbb.getMaxY()</div>
              ?         +
                
                    # Compute the "valid" pixels within our region-of-interest
                    valid = (fmask_sub > 0)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
713  <a href="#850bfead">850bfead</a> -     xx,yy = np.arange(xlo, xhi+1), np.arange(ylo, yhi+1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
690  <a href="#dcb164e2">dcb164e2</a> +     xx, yy = np.arange(xlo, xhi+1), np.arange(ylo, yhi+1)</div>
              ?        +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
714  <a href="#850bfead">850bfead</a> -     RR = ((xx - cx)**2)[np.newaxis,:] + ((yy - cy)**2)[:,np.newaxis]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
691  <a href="#dcb164e2">dcb164e2</a> +     RR = ((xx - cx)**2)[np.newaxis, :] + ((yy - cy)**2)[:, np.newaxis]</div>
              ?                                    +                      +
                    valid *= (RR <= R1**2)
                    valid *= (var_sub > 0)
                    NP = valid.sum()
                
                    if NP == 0:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
720  <a href="#d62b5dc4">d62b5dc4</a> -         log.warn('Skipping peak at (%.1f,%.1f): no unmasked pixels nearby'</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
697  <a href="#dcb164e2">dcb164e2</a> +         log.warn('Skipping peak at (%.1f, %.1f): no unmasked pixels nearby' % (cx, cy))</div>
              ?                                          +                                 ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
721  <a href="#d62b5dc4">d62b5dc4</a> -                  % (cx,cy))</div>
                        pkres.setNoValidPixels()
                        return
                
                    # pixel coords of valid pixels
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
726  <a href="#b993573a">b993573a</a> -     XX,YY = np.meshgrid(xx, yy)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
702  <a href="#dcb164e2">dcb164e2</a> +     XX, YY = np.meshgrid(xx, yy)</div>
              ?        +
                    ipixes = np.vstack((XX[valid] - xlo, YY[valid] - ylo)).T
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
729  <a href="#850bfead">850bfead</a> -     inpsfx = (xx >= px0) * (xx <= px1)</div>
              ?                         - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
705  <a href="#dcb164e2">dcb164e2</a> +     inpsfx = (xx >= px0)*(xx <= px1)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
730  <a href="#850bfead">850bfead</a> -     inpsfy = (yy >= py0) * (yy <= py1)</div>
              ?                         - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
706  <a href="#dcb164e2">dcb164e2</a> +     inpsfy = (yy >= py0)*(yy <= py1)</div>
                    inpsf = np.outer(inpsfy, inpsfx)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
732  <a href="#850bfead">850bfead</a> -     indx = np.outer(inpsfy, (xx > px0) * (xx < px1))</div>
              ?                                       - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
708  <a href="#dcb164e2">dcb164e2</a> +     indx = np.outer(inpsfy, (xx > px0)*(xx < px1))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
733  <a href="#850bfead">850bfead</a> -     indy = np.outer((yy > py0) * (yy < py1), inpsfx)</div>
              ?                               - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
709  <a href="#dcb164e2">dcb164e2</a> +     indy = np.outer((yy > py0)*(yy < py1), inpsfx)</div>
                
                    del inpsfx
                    del inpsfy
                
                    def _overlap(xlo, xhi, xmin, xmax):
                        assert((xlo <= xmax) and (xhi >= xmin) and
                               (xlo <= xhi)  and (xmin <= xmax))
                        xloclamp = max(xlo, xmin)
                        Xlo = xloclamp - xlo
                        xhiclamp = min(xhi, xmax)
                        Xhi = Xlo + (xhiclamp - xloclamp)
                        assert(xloclamp >= 0)
                        assert(Xlo >= 0)
                        return (xloclamp, xhiclamp+1, Xlo, Xhi+1)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
748  <a href="#0d8dc136">0d8dc136</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
724  <a href="#dcb164e2">dcb164e2</a> + </div>
                    A = np.zeros((NP, NT2))
                    # Constant term
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
751  <a href="#d62b5dc4">d62b5dc4</a> -     A[:,I_sky] = 1.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
727  <a href="#dcb164e2">dcb164e2</a> +     A[:, I_sky] = 1.</div>
              ?         +
                    # Sky slope terms: dx, dy
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
753  <a href="#d62b5dc4">d62b5dc4</a> -     A[:,I_sky_ramp_x] = ipixes[:,0] + (xlo-cx)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
729  <a href="#dcb164e2">dcb164e2</a> +     A[:, I_sky_ramp_x] = ipixes[:, 0] + (xlo-cx)</div>
              ?         +                         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
754  <a href="#d62b5dc4">d62b5dc4</a> -     A[:,I_sky_ramp_y] = ipixes[:,1] + (ylo-cy)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
730  <a href="#dcb164e2">dcb164e2</a> +     A[:, I_sky_ramp_y] = ipixes[:, 1] + (ylo-cy)</div>
              ?         +                         +
                
                    # whew, grab the valid overlapping PSF pixels
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
757  <a href="#0d8dc136">0d8dc136</a> -     px0,px1 = pbb.getMinX(), pbb.getMaxX()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
733  <a href="#dcb164e2">dcb164e2</a> +     px0, px1 = pbb.getMinX(), pbb.getMaxX()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
758  <a href="#0d8dc136">0d8dc136</a> -     py0,py1 = pbb.getMinY(), pbb.getMaxY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
734  <a href="#dcb164e2">dcb164e2</a> +     py0, py1 = pbb.getMinY(), pbb.getMaxY()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
759  <a href="#0d8dc136">0d8dc136</a> -     sx1,sx2,sx3,sx4 = _overlap(xlo, xhi, px0, px1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
735  <a href="#dcb164e2">dcb164e2</a> +     sx1, sx2, sx3, sx4 = _overlap(xlo, xhi, px0, px1)</div>
              ?         +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
760  <a href="#0d8dc136">0d8dc136</a> -     sy1,sy2,sy3,sy4 = _overlap(ylo, yhi, py0, py1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
736  <a href="#dcb164e2">dcb164e2</a> +     sy1, sy2, sy3, sy4 = _overlap(ylo, yhi, py0, py1)</div>
              ?         +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
761  <a href="#a42b82ff">a42b82ff</a> -     dpx0,dpy0 = px0 - xlo, py0 - ylo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
737  <a href="#dcb164e2">dcb164e2</a> +     dpx0, dpy0 = px0 - xlo, py0 - ylo</div>
              ?          +
                    psf_y_slice = slice(sy3 - dpy0, sy4 - dpy0)
                    psf_x_slice = slice(sx3 - dpx0, sx4 - dpx0)
                    psfsub = psfarr[psf_y_slice, psf_x_slice]
                    vsub = valid[sy1-ylo: sy2-ylo, sx1-xlo: sx2-xlo]
                    A[inpsf[valid], I_psf] = psfsub[vsub]
                
                    # PSF dx -- by taking the half-difference of shifted-by-one and
                    # shifted-by-minus-one.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
770  <a href="#a42b82ff">a42b82ff</a> -     oldsx = (sx1,sx2,sx3,sx4)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
746  <a href="#dcb164e2">dcb164e2</a> +     oldsx = (sx1, sx2, sx3, sx4)</div>
              ?                  +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
771  <a href="#0d8dc136">0d8dc136</a> -     sx1,sx2,sx3,sx4 = _overlap(xlo, xhi, px0+1, px1-1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
747  <a href="#dcb164e2">dcb164e2</a> +     sx1, sx2, sx3, sx4 = _overlap(xlo, xhi, px0+1, px1-1)</div>
              ?         +    +    +
                    psfsub = (psfarr[psf_y_slice, sx3 - dpx0 + 1: sx4 - dpx0 + 1] -
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
773  <a href="#d62b5dc4">d62b5dc4</a> -               psfarr[psf_y_slice, sx3 - dpx0 - 1: sx4 - dpx0 - 1]) / 2.</div>
              ?                                                                   - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
749  <a href="#dcb164e2">dcb164e2</a> +               psfarr[psf_y_slice, sx3 - dpx0 - 1: sx4 - dpx0 - 1])/2.</div>
                    vsub = valid[sy1-ylo: sy2-ylo, sx1-xlo: sx2-xlo]
                    A[indx[valid], I_dx] = psfsub[vsub]
                    # revert x indices...
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
777  <a href="#a42b82ff">a42b82ff</a> -     (sx1,sx2,sx3,sx4) = oldsx</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
753  <a href="#dcb164e2">dcb164e2</a> +     (sx1, sx2, sx3, sx4) = oldsx</div>
              ?          +    +    +
                
                    # PSF dy
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
780  <a href="#0d8dc136">0d8dc136</a> -     sy1,sy2,sy3,sy4 = _overlap(ylo, yhi, py0+1, py1-1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
756  <a href="#dcb164e2">dcb164e2</a> +     sy1, sy2, sy3, sy4 = _overlap(ylo, yhi, py0+1, py1-1)</div>
              ?         +    +    +
                    psfsub = (psfarr[sy3 - dpy0 + 1: sy4 - dpy0 + 1, psf_x_slice] -
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
782  <a href="#d62b5dc4">d62b5dc4</a> -               psfarr[sy3 - dpy0 - 1: sy4 - dpy0 - 1, psf_x_slice]) / 2.</div>
              ?                                                                   - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
758  <a href="#dcb164e2">dcb164e2</a> +               psfarr[sy3 - dpy0 - 1: sy4 - dpy0 - 1, psf_x_slice])/2.</div>
                    vsub = valid[sy1-ylo: sy2-ylo, sx1-xlo: sx2-xlo]
                    A[indy[valid], I_dy] = psfsub[vsub]
                
                    # other PSFs...
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
787  <a href="#a42b82ff">a42b82ff</a> -     for j,opsf in enumerate(otherpeaks):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
763  <a href="#dcb164e2">dcb164e2</a> +     for j, opsf in enumerate(otherpeaks):</div>
              ?           +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
788  <a href="#a42b82ff">a42b82ff</a> -         obb = opsf.getBBox(afwImage.PARENT)</div>
              ?                            ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
764  <a href="#5ea010ad">5ea010ad</a> +         obb = opsf.getBBox()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
789  <a href="#850bfead">850bfead</a> -         ino = np.outer((yy >= obb.getMinY()) * (yy <= obb.getMaxY()),</div>
              ?                                             - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
765  <a href="#dcb164e2">dcb164e2</a> +         ino = np.outer((yy >= obb.getMinY())*(yy <= obb.getMaxY()),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
790  <a href="#850bfead">850bfead</a> -                        (xx >= obb.getMinX()) * (xx <= obb.getMaxX()))</div>
              ?                                             - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
766  <a href="#dcb164e2">dcb164e2</a> +                        (xx >= obb.getMinX())*(xx <= obb.getMaxX()))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
791  <a href="#a42b82ff">a42b82ff</a> -         dpx0,dpy0 = obb.getMinX() - xlo, obb.getMinY() - ylo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
767  <a href="#dcb164e2">dcb164e2</a> +         dpx0, dpy0 = obb.getMinX() - xlo, obb.getMinY() - ylo</div>
              ?              +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
792  <a href="#a42b82ff">a42b82ff</a> -         sx1,sx2,sx3,sx4 = _overlap(xlo, xhi, obb.getMinX(), obb.getMaxX())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
768  <a href="#dcb164e2">dcb164e2</a> +         sx1, sx2, sx3, sx4 = _overlap(xlo, xhi, obb.getMinX(), obb.getMaxX())</div>
              ?             +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
793  <a href="#a42b82ff">a42b82ff</a> -         sy1,sy2,sy3,sy4 = _overlap(ylo, yhi, obb.getMinY(), obb.getMaxY())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
769  <a href="#dcb164e2">dcb164e2</a> +         sy1, sy2, sy3, sy4 = _overlap(ylo, yhi, obb.getMinY(), obb.getMaxY())</div>
              ?             +    +    +
                        opsfarr = opsf.getArray()
                        psfsub = opsfarr[sy3 - dpy0 : sy4 - dpy0, sx3 - dpx0: sx4 - dpx0]
                        vsub = valid[sy1-ylo: sy2-ylo, sx1-xlo: sx2-xlo]
                        A[ino[valid], I_opsf + j] = psfsub[vsub]
                
                    b = img_sub[valid]
                
                    # Weights -- from ramp and image variance map.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
802  <a href="#d62b5dc4">d62b5dc4</a> -     # ramp weights -- from 1 at R0 down to 0 at R1.</div>
              ?       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
778  <a href="#dcb164e2">dcb164e2</a> +     # Ramp weights -- from 1 at R0 down to 0 at R1.</div>
              ?       ^
                    rw = np.ones_like(RR)
                    ii = (RR > R0**2)
                    rr = np.sqrt(RR[ii])
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
806  <a href="#73387ae5">73387ae5</a> -     rw[ii] = np.maximum(0, 1. - ((rr - R0) / (R1 - R0)))</div>
              ?                                           - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
782  <a href="#dcb164e2">dcb164e2</a> +     rw[ii] = np.maximum(0, 1. - ((rr - R0)/(R1 - R0)))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
807  <a href="#eb557384">eb557384</a> -     w = np.sqrt(rw[valid] / var_sub[valid])</div>
              ?                          - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
783  <a href="#dcb164e2">dcb164e2</a> +     w = np.sqrt(rw[valid]/var_sub[valid])</div>
                    # save the effective number of pixels
                    sumr = np.sum(rw[valid])
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
786  <a href="#6428a772">6428a772</a> +     log.log(-9, 'sumr = %g' % sumr)</div>
                
                    del ii
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
813  <a href="#5e3ba624">5e3ba624</a> -     Aw  = A * w[:,np.newaxis]</div>
              ?            - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
790  <a href="#dcb164e2">dcb164e2</a> +     Aw  = A*w[:, np.newaxis]</div>
              ?                 +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
814  <a href="#5e3ba624">5e3ba624</a> -     bw  = b * w</div>
              ?            - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
791  <a href="#dcb164e2">dcb164e2</a> +     bw  = b*w</div>
                
                    if debugPlots:
                        import pylab as plt
                        plt.clf()
                        N = NT2 + 2
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
820  <a href="#a1442386">a1442386</a> -         R,C = 2, (N+1) / 2</div>
              ?                       - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
797  <a href="#dcb164e2">dcb164e2</a> +         R, C = 2, (N+1)/2</div>
              ?           +
                        for i in range(NT2):
                            im1 = np.zeros((1+yhi-ylo, 1+xhi-xlo))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
823  <a href="#a1442386">a1442386</a> -             im1[ipixes[:,1], ipixes[:,0]] = A[:, i]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
800  <a href="#dcb164e2">dcb164e2</a> +             im1[ipixes[:, 1], ipixes[:, 0]] = A[:, i]</div>
              ?                          +             +
                            plt.subplot(R, C, i+1)
                            plt.imshow(im1, interpolation='nearest', origin='lower')
                        plt.subplot(R, C, NT2+1)
                        im1 = np.zeros((1+yhi-ylo, 1+xhi-xlo))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
828  <a href="#a1442386">a1442386</a> -         im1[ipixes[:,1], ipixes[:,0]] = b</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
805  <a href="#dcb164e2">dcb164e2</a> +         im1[ipixes[:, 1], ipixes[:, 0]] = b</div>
              ?                      +             +
                        plt.imshow(im1, interpolation='nearest', origin='lower')
                        plt.subplot(R, C, NT2+2)
                        im1 = np.zeros((1+yhi-ylo, 1+xhi-xlo))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
832  <a href="#a1442386">a1442386</a> -         im1[ipixes[:,1], ipixes[:,0]] = w</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
809  <a href="#dcb164e2">dcb164e2</a> +         im1[ipixes[:, 1], ipixes[:, 0]] = w</div>
              ?                      +             +
                        plt.imshow(im1, interpolation='nearest', origin='lower')
                        plt.savefig('A.png')
                
                    # We do fits with and without the decenter (dx,dy) terms.
                    # Since the dx,dy terms are at the end of the matrix,
                    # we can do that just by trimming off those elements.
                    #
                    # The SVD can fail if there are NaNs in the matrices; this should
                    # really be handled upstream
                    try:
                        # NT1 is number of terms without dx,dy;
                        # X1 is the result without decenter
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
845  <a href="#a1442386">a1442386</a> -         X1,r1,rank1,s1 = np.linalg.lstsq(Aw[:,:NT1], bw)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
822  <a href="#dcb164e2">dcb164e2</a> +         X1, r1, rank1, s1 = np.linalg.lstsq(Aw[:, :NT1], bw)</div>
              ?            +   +      +                          +
                        # X2 is with decenter
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
847  <a href="#a1442386">a1442386</a> -         X2,r2,rank2,s2 = np.linalg.lstsq(Aw, bw)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
824  <a href="#dcb164e2">dcb164e2</a> +         X2, r2, rank2, s2 = np.linalg.lstsq(Aw, bw)</div>
              ?            +   +      +
                    except np.linalg.LinAlgError, e:
                        log.log(log.WARN, "Failed to fit PSF to child: %s" % e)
                        pkres.setPsfFitFailed()
                        return
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
829  <a href="#a1442386">a1442386</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
830  <a href="#03b5452d">03b5452d</a> +     log.log(-9, 'r1 r2 %s %s' % (r1, r2))</div>
                
                    # r is weighted chi-squared = sum over pixels: ramp * (model -
                    # data)**2/sigma**2
                    if len(r1) > 0:
                        chisq1 = r1[0]
                    else:
                        chisq1 = 1e30
                    if len(r2) > 0:
                        chisq2 = r2[0]
                    else:
                        chisq2 = 1e30
                    dof1 = sumr - len(X1)
                    dof2 = sumr - len(X2)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
844  <a href="#6428a772">6428a772</a> +     log.log(-9, 'dof1, dof2 %g %g' % (dof1, dof2))</div>
                
                    # This can happen if we're very close to the edge (?)
                    if dof1 <= 0 or dof2 <= 0:
                        log.logdebug('Skipping this peak: bad DOF %g, %g' % (dof1, dof2))
                        pkres.setBadPsfDof()
                        return
                
                    q1 = chisq1/dof1
                    q2 = chisq2/dof2
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
874  <a href="#a42b82ff">a42b82ff</a> -     log.logdebug('PSF fits: chisq/dof = %g, %g' % (q1,q2))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
854  <a href="#dcb164e2">dcb164e2</a> +     log.logdebug('PSF fits: chisq/dof = %g, %g' % (q1, q2))</div>
              ?                                                       +
                    ispsf1 = (q1 < psfChisqCut1)
                    ispsf2 = (q2 < psfChisqCut2)
                
                    pkres.psfFit1 = (chisq1, dof1)
                    pkres.psfFit2 = (chisq2, dof2)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
880  <a href="#d62b5dc4">d62b5dc4</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
860  <a href="#dcb164e2">dcb164e2</a> + </div>
                    # check that the fit PSF spatial derivative terms aren't too big
                    if ispsf2:
                        fdx, fdy = X2[I_dx], X2[I_dy]
                        f0 = X2[I_psf]
                        # as a fraction of the PSF flux
                        dx = fdx/f0
                        dy = fdy/f0
                        ispsf2 = ispsf2 and (abs(dx) < 1. and abs(dy) < 1.)
                        log.logdebug('isPSF2 -- checking derivatives: dx,dy = %g, %g -> %s' %
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
890  <a href="#a42b82ff">a42b82ff</a> -                      (dx,dy, str(ispsf2)))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
870  <a href="#dcb164e2">dcb164e2</a> +                      (dx, dy, str(ispsf2)))</div>
              ?                          +
                        if not ispsf2:
                            pkres.psfFitBigDecenter = True
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
893  <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
873  <a href="#dcb164e2">dcb164e2</a> + </div>
                    # Looks like a shifted PSF: try actually shifting the PSF by that amount
                    # and re-evaluate the fit.
                    if ispsf2:
                        psfimg2 = psf.computeImage(cx + dx, cy + dy)
                        # clip
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
899  <a href="#a42b82ff">a42b82ff</a> -         pbb2 = psfimg2.getBBox(afwImage.PARENT)</div>
              ?                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
879  <a href="#5ea010ad">5ea010ad</a> +         pbb2 = psfimg2.getBBox()</div>
                        pbb2.clip(fbb)
                
                        # Make sure we haven't been given a substitute PSF that's nowhere near where we want, as may occur if
                        # "Cannot compute CoaddPsf at point (xx,yy); no input images at that point."
                        if not pbb2.contains(afwGeom.Point2I(int(cx + dx), int(cy + dy))):
                            ispsf2 = False
                        else:
                            # clip image to bbox
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
908  <a href="#4e69fd88">4e69fd88</a> -             px0,py0 = psfimg2.getX0(), psfimg2.getY0()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
888  <a href="#3c82471b">3c82471b</a> +             px0, py0 = psfimg2.getX0(), psfimg2.getY0()</div>
              ?                 +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
909  <a href="#4e69fd88">4e69fd88</a> -             psfarr = psfimg2.getArray()[pbb2.getMinY()-py0: 1+pbb2.getMaxY()-py0,</div>
              ?                                                            -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
889  <a href="#3c82471b">3c82471b</a> +             psfarr = psfimg2.getArray()[pbb2.getMinY()-py0:1+pbb2.getMaxY()-py0,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
910  <a href="#4e69fd88">4e69fd88</a> -                                         pbb2.getMinX()-px0: 1+pbb2.getMaxX()-px0]</div>
              ?                                                            -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
890  <a href="#3c82471b">3c82471b</a> +                                         pbb2.getMinX()-px0:1+pbb2.getMaxX()-px0]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
911  <a href="#4e69fd88">4e69fd88</a> -             px0,py0 = pbb2.getMinX(), pbb2.getMinY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
891  <a href="#3c82471b">3c82471b</a> +             px0, py0 = pbb2.getMinX(), pbb2.getMinY()</div>
              ?                 +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
912  <a href="#4e69fd88">4e69fd88</a> -             px1,py1 = pbb2.getMaxX(), pbb2.getMaxY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
892  <a href="#3c82471b">3c82471b</a> +             px1, py1 = pbb2.getMaxX(), pbb2.getMaxY()</div>
              ?                 +
                
                            # yuck!  Update the PSF terms in the least-squares fit matrix.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
915  <a href="#4e69fd88">4e69fd88</a> -             Ab = A[:,:NT1]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
895  <a href="#3c82471b">3c82471b</a> +             Ab = A[:, :NT1]</div>
              ?                      +
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
917  <a href="#4e69fd88">4e69fd88</a> -             sx1,sx2,sx3,sx4 = _overlap(xlo, xhi, px0, px1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
897  <a href="#3c82471b">3c82471b</a> +             sx1, sx2, sx3, sx4 = _overlap(xlo, xhi, px0, px1)</div>
              ?                 +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
918  <a href="#4e69fd88">4e69fd88</a> -             sy1,sy2,sy3,sy4 = _overlap(ylo, yhi, py0, py1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
898  <a href="#3c82471b">3c82471b</a> +             sy1, sy2, sy3, sy4 = _overlap(ylo, yhi, py0, py1)</div>
              ?                 +    +    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
919  <a href="#4e69fd88">4e69fd88</a> -             dpx0,dpy0 = px0 - xlo, py0 - ylo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
899  <a href="#3c82471b">3c82471b</a> +             dpx0, dpy0 = px0 - xlo, py0 - ylo</div>
              ?                  +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
920  <a href="#4e69fd88">4e69fd88</a> -             psfsub = psfarr[sy3 - dpy0 : sy4 - dpy0, sx3 - dpx0: sx4 - dpx0]</div>
              ?                                - -    - -   - -         - -     -   - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
900  <a href="#3c82471b">3c82471b</a> +             psfsub = psfarr[sy3-dpy0:sy4-dpy0, sx3-dpx0:sx4-dpx0]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
921  <a href="#4e69fd88">4e69fd88</a> -             vsub = valid[sy1-ylo: sy2-ylo, sx1-xlo: sx2-xlo]</div>
              ?                                  -                 -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
901  <a href="#3c82471b">3c82471b</a> +             vsub = valid[sy1-ylo:sy2-ylo, sx1-xlo:sx2-xlo]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
922  <a href="#4e69fd88">4e69fd88</a> -             xx,yy = np.arange(xlo, xhi+1), np.arange(ylo, yhi+1)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
902  <a href="#3c82471b">3c82471b</a> +             xx, yy = np.arange(xlo, xhi+1), np.arange(ylo, yhi+1)</div>
              ?                +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
923  <a href="#4e69fd88">4e69fd88</a> -             inpsf = np.outer((yy >= py0) * (yy <= py1), (xx >= px0) * (xx <= px1))</div>
              ?                                         - -                        - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
903  <a href="#3c82471b">3c82471b</a> +             inpsf = np.outer((yy >= py0)*(yy <= py1), (xx >= px0)*(xx <= px1))</div>
                            Ab[inpsf[valid], I_psf] = psfsub[vsub]
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
926  <a href="#4e69fd88">4e69fd88</a> -             Aw  = Ab * w[:,np.newaxis]</div>
              ?                     - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
906  <a href="#3c82471b">3c82471b</a> +             Aw  = Ab*w[:, np.newaxis]</div>
              ?                          +
                            # re-solve...
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
928  <a href="#4e69fd88">4e69fd88</a> -             Xb,rb,rankb,sb = np.linalg.lstsq(Aw, bw)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
908  <a href="#3c82471b">3c82471b</a> +             Xb, rb, rankb, sb = np.linalg.lstsq(Aw, bw)</div>
              ?                +   +      +
                            if len(rb) > 0:
                                chisqb = rb[0]
                            else:
                                chisqb = 1e30
                            dofb = sumr - len(Xb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
934  <a href="#4e69fd88">4e69fd88</a> -             qb = chisqb / dofb</div>
              ?                        - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
914  <a href="#3c82471b">3c82471b</a> +             qb = chisqb/dofb</div>
                            ispsf2 = (qb < psfChisqCut2b)
                            q2 = qb
                            X2 = Xb
                            log.logdebug('shifted PSF: new chisq/dof = %g; good? %s' %
                                         (qb, ispsf2))
                            pkres.psfFit3 = (chisqb, dofb)
                
                    # Which one do we keep?
                    if (((ispsf1 and ispsf2) and (q2 < q1)) or
                        (ispsf2 and not ispsf1)):
                        Xpsf = X2
                        chisq = chisq2
                        dof = dof2
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
928  <a href="#6428a772">6428a772</a> +         log.log(-9, 'dof %g' % dof)</div>
                        log.logdebug('Keeping shifted-PSF model')
                        cx += dx
                        cy += dy
                        pkres.psfFitWithDecenter = True
                    else:
                        # (arbitrarily set to X1 when neither fits well)
                        Xpsf = X1
                        chisq = chisq1
                        dof = dof1
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
938  <a href="#6428a772">6428a772</a> +         log.log(-9, 'dof %g' % dof)</div>
                        log.logdebug('Keeping unshifted PSF model')
                
                    ispsf = (ispsf1 or ispsf2)
                
                    # Save the PSF models in images for posterity.
                    if debugPsf:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
963  <a href="#a1442386">a1442386</a> -         SW,SH = 1+xhi-xlo, 1+yhi-ylo</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
945  <a href="#dcb164e2">dcb164e2</a> +         SW, SH = 1+xhi-xlo, 1+yhi-ylo</div>
              ?            +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
964  <a href="#a1442386">a1442386</a> -         psfmod = afwImage.ImageF(SW,SH)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
946  <a href="#dcb164e2">dcb164e2</a> +         psfmod = afwImage.ImageF(SW, SH)</div>
              ?                                     +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
965  <a href="#a1442386">a1442386</a> -         psfmod.setXY0(xlo,ylo)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
947  <a href="#dcb164e2">dcb164e2</a> +         psfmod.setXY0(xlo, ylo)</div>
              ?                           +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
966  <a href="#a1442386">a1442386</a> -         psfderivmodm = afwImage.MaskedImageF(SW,SH)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
948  <a href="#dcb164e2">dcb164e2</a> +         psfderivmodm = afwImage.MaskedImageF(SW, SH)</div>
              ?                                                 +
                        psfderivmod = psfderivmodm.getImage()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
968  <a href="#a1442386">a1442386</a> -         psfderivmod.setXY0(xlo,ylo)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
950  <a href="#dcb164e2">dcb164e2</a> +         psfderivmod.setXY0(xlo, ylo)</div>
              ?                                +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
969  <a href="#a1442386">a1442386</a> -         model = afwImage.ImageF(SW,SH)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
951  <a href="#dcb164e2">dcb164e2</a> +         model = afwImage.ImageF(SW, SH)</div>
              ?                                    +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
970  <a href="#a1442386">a1442386</a> -         model.setXY0(xlo,ylo)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
952  <a href="#dcb164e2">dcb164e2</a> +         model.setXY0(xlo, ylo)</div>
              ?                          +
                        for i in range(len(Xpsf)):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
972  <a href="#a1442386">a1442386</a> -             V = A[:,i]*Xpsf[i]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
973  <a href="#a1442386">a1442386</a> -             for (x,y),v in zip(ipixes, A[:,i]*Xpsf[i]):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
954  <a href="#dcb164e2">dcb164e2</a> +             for (x, y),v in zip(ipixes, A[:, i]*Xpsf[i]):</div>
              ?                    +                        +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
974  <a href="#a1442386">a1442386</a> -                 ix,iy = int(x),int(y)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
955  <a href="#dcb164e2">dcb164e2</a> +                 ix, iy = int(x), int(y)</div>
              ?                    +            +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
975  <a href="#a1442386">a1442386</a> -                 model.set(ix, iy, model.get(ix,iy) + float(v))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
956  <a href="#dcb164e2">dcb164e2</a> +                 model.set(ix, iy, model.get(ix, iy) + float(v))</div>
              ?                                                +
                                if i in [I_psf, I_dx, I_dy]:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
977  <a href="#a1442386">a1442386</a> -                     psfderivmod.set(ix, iy, psfderivmod.get(ix,iy) + float(v))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
958  <a href="#dcb164e2">dcb164e2</a> +                     psfderivmod.set(ix, iy, psfderivmod.get(ix, iy) + float(v))</div>
              ?                                                                +
                        for ii in range(NP):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
979  <a href="#a1442386">a1442386</a> -             x,y = ipixes[ii,:]</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
960  <a href="#dcb164e2">dcb164e2</a> +             x, y = ipixes[ii, :]</div>
              ?               +              +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
980  <a href="#a1442386">a1442386</a> -             psfmod.set(int(x),int(y), float(A[ii, I_psf] * Xpsf[I_psf]))</div>
              ?                                                         - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
961  <a href="#dcb164e2">dcb164e2</a> +             psfmod.set(int(x), int(y), float(A[ii, I_psf]*Xpsf[I_psf]))</div>
              ?                               +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
981  <a href="#e3cd0cbe">e3cd0cbe</a> -         modelfp = afwDet.Footprint(fp.getPeaks().getSchema())</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
962  <a href="#a1442386">a1442386</a> +         modelfp = afwDet.Footprint()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
982  <a href="#a1442386">a1442386</a> -         for (x,y) in ipixes:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
963  <a href="#dcb164e2">dcb164e2</a> +         for (x, y) in ipixes:</div>
              ?                +
                            modelfp.addSpan(int(y+ylo), int(x+xlo), int(x+xlo))
                        modelfp.normalize()
                
                        pkres.psfFitDebugPsf0Img = psfimg
                        pkres.psfFitDebugPsfImg = psfmod
                        pkres.psfFitDebugPsfDerivImg = psfderivmod
                        pkres.psfFitDebugPsfModel = model
                        pkres.psfFitDebugStamp = img.Factory(img, stampbb, True)
                        pkres.psfFitDebugValidPix = valid  # numpy array
                        pkres.psfFitDebugVar = varimg.Factory(varimg, stampbb, True)
                        ww = np.zeros(valid.shape, np.float)
                        ww[valid] = w
                        pkres.psfFitDebugWeight = ww # numpy
                        pkres.psfFitDebugRampWeight = rw
                
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
999  <a href="#a1442386">a1442386</a> - </div>
                    # Save things we learned about this peak for posterity...
                    pkres.psfFitR0 = R0
                    pkres.psfFitR1 = R1
                    pkres.psfFitStampExtent = (xlo, xhi, ylo, yhi)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1004 <a href="#846a6363">846a6363</a> -     pkres.psfFitCenter = (cx,cy)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
984  <a href="#dcb164e2">dcb164e2</a> +     pkres.psfFitCenter = (cx, cy)</div>
              ?                              +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
985  <a href="#6428a772">6428a772</a> +     log.log(-9, 'saving chisq,dof %g %g' % (chisq, dof))</div>
                    pkres.psfFitBest = (chisq, dof)
                    pkres.psfFitParams = Xpsf
                    pkres.psfFitFlux = Xpsf[I_psf]
                    pkres.psfFitNOthers = len(otherpeaks)
                
                    if ispsf:
                        pkres.setDeblendedAsPsf()
                
                        # replace the template image by the PSF + derivatives
                        # image.
                        log.logdebug('Deblending as PSF; setting template to PSF model')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1016 <a href="#d62b5dc4">d62b5dc4</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
997  <a href="#dcb164e2">dcb164e2</a> + </div>
                        # Instantiate the PSF model and clip it to the footprint
                        psfimg = psf.computeImage(cx, cy)
                        # Scale by fit flux.
                        psfimg *= Xpsf[I_psf]
                        psfimg = psfimg.convertF()
                
                        # Clip the Footprint to the PSF model image bbox.
                        fpcopy = afwDet.Footprint(fp)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1025 <a href="#6e406c53">6e406c53</a> -         psfbb = psfimg.getBBox(afwImage.PARENT)</div>
              ?                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1006 <a href="#5ea010ad">5ea010ad</a> +         psfbb = psfimg.getBBox()</div>
                        fpcopy.clipTo(psfbb)
                        bb = fpcopy.getBBox()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1028 <a href="#6e406c53">6e406c53</a> -         </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1009 <a href="#dcb164e2">dcb164e2</a> + </div>
                        # Copy the part of the PSF model within the clipped footprint.
                        psfmod = afwImage.MaskedImageF(bb)
                        afwDet.copyWithinFootprintImage(fpcopy, psfimg, psfmod.getImage())
                        # Save it as our template.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1033 <a href="#2853897c">2853897c</a> -         fpcopy.clipToNonzeroF(psfmod.getImage())</div>
              ?                             -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1014 <a href="#9370f92d">9370f92d</a> +         fpcopy.clipToNonzero(psfmod.getImage())</div>
                        fpcopy.normalize()
                        pkres.setTemplate(psfmod, fpcopy)
                
                        # DEBUG
                        pkres.setPsfTemplate(psfmod, fpcopy)
                
                
                def _handle_flux_at_edge(log, psffwhm, t1, tfoot, fp, maskedImage,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1042 <a href="#ebbaa999">ebbaa999</a> -                          x0,x1,y0,y1, psf, pk, sigma1, patchEdges):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1023 <a href="#dcb164e2">dcb164e2</a> +                          x0, x1, y0, y1, psf, pk, sigma1, patchEdges):</div>
              ?                             +   +   +
                    # Import C++ routines
                    import lsst.meas.deblender as deb
                    butils = deb.BaselineUtilsF
                
                    log.logdebug('Found significant flux at template edge.')
                    # Compute the max of:
                    #  -symmetric-template-clipped image * PSF
                    #  -footprint-clipped image
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1051 <a href="#d62b5dc4">d62b5dc4</a> -     # Ie, extend the template by the PSF and "fill in" the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1032 <a href="#dcb164e2">dcb164e2</a> +     # Ie, extend the template by the PSF and "fill in" the footprint.</div>
              ?                                                           +++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1052 <a href="#d62b5dc4">d62b5dc4</a> -     # footprint.</div>
                    # Then find the symmetric template of that image.
                
                    # The size we'll grow by
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1056 <a href="#d62b5dc4">d62b5dc4</a> -     S = psffwhm * 1.5</div>
              ?                - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1036 <a href="#dcb164e2">dcb164e2</a> +     S = psffwhm*1.5</div>
                    # make it an odd integer
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1058 <a href="#d62b5dc4">d62b5dc4</a> -     S = (int(S + 0.5) / 2) * 2 + 1</div>
              ?                      - -  - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1038 <a href="#dcb164e2">dcb164e2</a> +     S = (int(S + 0.5)/2)*2 + 1</div>
                
                    tbb = tfoot.getBBox()
                    tbb.grow(S)
                
                    # (footprint+margin)-clipped image;
                    # we need the pixels OUTSIDE the footprint to be 0.
                    fpcopy = afwDet.Footprint(fp)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1066 <a href="#f8aaece6">f8aaece6</a> -     fpcopy = afwDet.growFootprint(fpcopy, S)</div>
                    fpcopy.clipTo(tbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1068 <a href="#f8aaece6">f8aaece6</a> -     fpcopy.normalize()</div>
                    padim = t1.Factory(tbb)
                    afwDet.copyWithinFootprintMaskedImage(fpcopy, maskedImage, padim)
                
                    # find pixels on the edge of the template
                    edgepix = butils.getSignificantEdgePixels(t1.getImage(), tfoot, -1e6)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1074 <a href="#d62b5dc4">d62b5dc4</a> -                                               </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1052 <a href="#dcb164e2">dcb164e2</a> + </div>
                    # instantiate PSF image
                    xc = int((x0 + x1)/2)
                    yc = int((y0 + y1)/2)
                    psfim = psf.computeImage(afwGeom.Point2D(xc, yc))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1079 <a href="#d62b5dc4">d62b5dc4</a> -     pbb = psfim.getBBox(afwImage.PARENT)</div>
              ?                         ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1057 <a href="#5ea010ad">5ea010ad</a> +     pbb = psfim.getBBox()</div>
                    # shift PSF image to by centered on zero
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1081 <a href="#d62b5dc4">d62b5dc4</a> -     lx,ly = pbb.getMinX(), pbb.getMinY()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1059 <a href="#dcb164e2">dcb164e2</a> +     lx, ly = pbb.getMinX(), pbb.getMinY()</div>
              ?        +
                    psfim.setXY0(lx - xc, ly - yc)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1083 <a href="#d62b5dc4">d62b5dc4</a> -     pbb = psfim.getBBox(afwImage.PARENT)</div>
              ?                         ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1061 <a href="#5ea010ad">5ea010ad</a> +     pbb = psfim.getBBox()</div>
                    # clip PSF to S, if necessary
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1085 <a href="#d62b5dc4">d62b5dc4</a> -     Sbox = afwGeom.Box2I(afwGeom.Point2I(-S, -S),</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1063 <a href="#dcb164e2">dcb164e2</a> +     Sbox = afwGeom.Box2I(afwGeom.Point2I(-S, -S), afwGeom.Extent2I(2*S+1, 2*S+1))</div>
              ?                                                  ++++++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1086 <a href="#d62b5dc4">d62b5dc4</a> -                          afwGeom.Extent2I(2*S+1, 2*S+1))</div>
                    if not Sbox.contains(pbb):
                        # clip PSF image
                        psfim = psfim.Factory(psfim, Sbox, afwImage.PARENT, True)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1090 <a href="#d62b5dc4">d62b5dc4</a> -         pbb = psfim.getBBox(afwImage.PARENT)</div>
              ?                             ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1067 <a href="#5ea010ad">5ea010ad</a> +         pbb = psfim.getBBox()</div>
                    px0 = pbb.getMinX()
                    px1 = pbb.getMaxX()
                    py0 = pbb.getMinY()
                    py1 = pbb.getMaxY()
                
                    # Compute the ramped-down edge pixels
                    ramped = t1.getImage().Factory(tbb)
                    Tout = ramped.getArray()
                    Tin  = t1.getImage().getArray()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1100 <a href="#d62b5dc4">d62b5dc4</a> -     tx0,ty0 = t1.getX0(), t1.getY0()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1077 <a href="#dcb164e2">dcb164e2</a> +     tx0, ty0 = t1.getX0(), t1.getY0()</div>
              ?         +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1101 <a href="#d62b5dc4">d62b5dc4</a> -     ox0,oy0 = ramped.getX0(), ramped.getY0()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1078 <a href="#dcb164e2">dcb164e2</a> +     ox0, oy0 = ramped.getX0(), ramped.getY0()</div>
              ?         +
                    P = psfim.getArray()
                    P /= P.max()
                    # For each edge pixel, Tout = max(Tout, edgepix * PSF)
                    for span in edgepix.getSpans():
                        y = span.getY()
                        for x in range(span.getX0(), span.getX1()+1):
                            slc = (slice(y+py0 - oy0, y+py1+1 - oy0),
                                   slice(x+px0 - ox0, x+px1+1 - ox0))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1110 <a href="#d62b5dc4">d62b5dc4</a> -             Tout[slc] = np.maximum(Tout[slc], Tin[y-ty0, x-tx0] * P)</div>
              ?                                                                - -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1087 <a href="#dcb164e2">dcb164e2</a> +             Tout[slc] = np.maximum(Tout[slc], Tin[y-ty0, x-tx0]*P)</div>
                
                    # Fill in the "padim" (which has the right variance and
                    # mask planes) with the ramped pixels, outside the footprint
                    I = (padim.getImage().getArray() == 0)
                    padim.getImage().getArray()[I] = ramped.getArray()[I]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1116 <a href="#d62b5dc4">d62b5dc4</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1117 <a href="#bc602277">bc602277</a> -     rtn,patched = butils.buildSymmetricTemplate(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1118 <a href="#bc602277">bc602277</a> -         padim, fpcopy, pk, sigma1, True, patchEdges)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1093 <a href="#dcb164e2">dcb164e2</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1094 <a href="#d62b5dc4">d62b5dc4</a> +     fpcopy = afwDet.growFootprint(fpcopy, S)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1095 <a href="#d62b5dc4">d62b5dc4</a> +     fpcopy.normalize()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1096 <a href="#dcb164e2">dcb164e2</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1097 <a href="#dcb164e2">dcb164e2</a> +     rtn, patched = butils.buildSymmetricTemplate(padim, fpcopy, pk, sigma1, True, patchEdges)</div>
                    # silly SWIG can't unpack pairs as tuples
                    t2, tfoot2 = rtn[0], rtn[1]
                    del rtn
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1122 <a href="#d62b5dc4">d62b5dc4</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1101 <a href="#dcb164e2">dcb164e2</a> + </div>
                    # This template footprint may extend outside the parent
                    # footprint -- or the image.  Clip it.
                    # NOTE that this may make it asymmetric, unlike normal templates.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1126 <a href="#ebbaa999">ebbaa999</a> -     imbb = maskedImage.getBBox(afwImage.PARENT)</div>
              ?                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
1105 <a href="#5ea010ad">5ea010ad</a> +     imbb = maskedImage.getBBox()</div>
                    tfoot2.clipTo(imbb)
                    tbb = tfoot2.getBBox()
                    # clip template image to bbox
                    t2 = t2.Factory(t2, tbb, afwImage.PARENT, True)
                
                    return t2, tfoot2, patched
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="8641cb3e"/></a>8641cb3e</h3>

<pre>
commit 8641cb3ec0980577da2f12eeea37281ca6721a91
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon May 21 13:53:42 2012 -0400

    change baseline deblend() API to take a single footprint, not a list
</pre>
<h3><a name="70d18fb5"/></a>70d18fb5</h3>

<pre>
commit 70d18fb5da2b660facbba4ab0158d84b07d3202d
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Feb 20 14:20:23 2012 -0500

    set mask bits where the symmetry and monotonicity constraints are active
</pre>
<h3><a name="e3cd0cbe"/></a>e3cd0cbe</h3>

<pre>
commit e3cd0cbe51794935b2b3ac6ef9b8393f27f7dd34
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Mon Dec 22 14:46:51 2014 -0500

    Ensure deblender Footprint-creators preserve peak schema
    
    Deblender operations that create new Footprints need to maintain
    the peak schema of the footprints they start with.  Usually this
    is handled by using the Footprint copy constructor, but not always.
</pre>
<h3><a name="8f605f1f"/></a>8f605f1f</h3>

<pre>
commit 8f605f1ff03b2a72f0b783cf36f086bc47005139
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 13:57:01 2014 -0400

    pull out summing templates, and finding stray flux
</pre>
<h3><a name="bc602277"/></a>bc602277</h3>

<pre>
commit bc6022775fbcd60c882f45bddfd6549be4b99a08
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jan 13 12:32:28 2014 -0600

    ugh, what a pain to get an extra boolean return value from a function!
</pre>
<h3><a name="9223a489"/></a>9223a489</h3>

<pre>
commit 9223a489a09d693ec56dadd3952b7d3e8f4ab24b
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Jun 5 15:26:32 2013 -0400

    add flags to 'find' stray flux and to 'assign' it -- ie, set the '.heavy' result field used by downstream processing
</pre>
<h3><a name="d509aee5"/></a>d509aee5</h3>

<pre>
commit d509aee5a12496025293666555dab15aae32b4a4
Author: Bob Armstrong <rearmstr@gmail.com>
Date:   Fri May 1 13:55:36 2015 -0400

    Add strayFlux option to the deblender to shrink parents to the union of their children.
    
    The deblender is not doing well at assigning stray flux to its children.  This
    option ignores pixels not assigned to any children and trims the parent footprint to the
    union of the children.  This can result in parents having non-contigous footprints.
</pre>
<h3><a name="a1442386"/></a>a1442386</h3>

<pre>
commit a14423863c146e6e00438609041bdae67f191fbc
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Feb 22 20:23:05 2013 +0900

    More display-based debugging for deblender (#2682)
</pre>
<h3><a name="3e624183"/></a>3e624183</h3>

<pre>
commit 3e624183e372e389542a6a3629cfacb2973e76f9
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Sep 10 15:33:56 2012 -0500

    add some documentation to _fit_psf* functions; tweak fit_psf.py (so-called) test to at least run
</pre>
<h3><a name="fc8fd79d"/></a>fc8fd79d</h3>

<pre>
commit fc8fd79dddb997f05922ea1e9b286ba093704d23
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Jun 11 13:29:31 2013 -0400

    add option for stray-flux-to-point-source assignment policy
</pre>
<h3><a name="01ed1f5e"/></a>01ed1f5e</h3>

<pre>
commit 01ed1f5e8618762ffb0f435a2ce00d471346a3cc
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu Jan 1 01:05:57 2015 -0500

    Catch exception from CoaddPsf in _handle_flux_at_edge
    
    The exception arises when the position is off the edge of the image,
    and hence there is no good PSF.
</pre>
<h3><a name="bbaeb182"/></a>bbaeb182</h3>

<pre>
commit bbaeb182bef0664c94bd54aeebea31cf159d0180
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Jun 5 15:07:12 2013 -0400

    stray flux test: 1-d example, testing exact stray-flux assignment profile (1/(1+r^2))
</pre>
<h3><a name="569143a1"/></a>569143a1</h3>

<pre>
commit 569143a1af20b5f2844330c0a3d4e0299fa9492e
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Dec 18 11:47:29 2014 -0500

    Catch failure to evaluate Psf at an out-of-bounds point
    
    We fall back to the "average position" in this case, which isn't ideal,
    but better than a complete failure.
    
    The situation will be improved in the future on HSC-1119 and HSC-1120.
</pre>
<h3><a name="d62b5dc4"/></a>d62b5dc4</h3>

<pre>
commit d62b5dc438fa3e0d3cd3ace52de23f14cce32e36
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Oct 21 17:38:27 2013 -0400

    start responding to Steve's review, with a revamp of the deblending result objects.  Currently highly broken, but I'm going home for the day
</pre>
<h3><a name="850bfead"/></a>850bfead</h3>

<pre>
commit 850bfead67ac672a10901e416e88ecb4064e5291
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jul 10 10:42:21 2012 -0500

    remove commented-out code; replace XX,YY = np.meshgrid(xx,yy) by np.outer() calls, etc
</pre>
<h3><a name="2853897c"/></a>2853897c</h3>

<pre>
commit 2853897c18604b68d6e429e97d55a460588e7b02
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Mar 11 15:33:52 2014 -0400

    add (another) debugging script
</pre>
<h3><a name="0d8dc136"/></a>0d8dc136</h3>

<pre>
commit 0d8dc1362d62c50be3e09f413e751137b2f24609
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jul 10 10:10:24 2012 -0500

    some more speed tweaks, and don't produce a bunch of debugging output
</pre>
<h3><a name="33db9727"/></a>33db9727</h3>

<pre>
commit 33db9727f34421b943d3d619d7dbc340ff1b4379
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Mar 6 15:47:56 2014 -0500

    start debugging; also add a separate task for running JUST deblending and measurment, starting from calexp + sources
</pre>
<h3><a name="08c0d83e"/></a>08c0d83e</h3>

<pre>
commit 08c0d83ed7bb45069d57e6f8a688dc6879a7b6b6
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu Jan 9 16:13:02 2014 -0600

    Fix apportionFlux indexing given templates extending outside the parent footprint; revive designdoc.py
</pre>
<h3><a name="79582bd3"/></a>79582bd3</h3>

<pre>
commit 79582bd3ca4ac2fb7f41d1169ff0c979c3427b3f
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu May 3 09:43:24 2012 -0500

    run measurement on deblended sources; persist
</pre>
<h3><a name="497d2eac"/></a>497d2eac</h3>

<pre>
commit 497d2eace16fbcaba88dd438b4f73fc80f69c83f
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Apr 20 14:52:38 2012 -0500

    convert prints into log calls
</pre>
<h3><a name="4e69fd88"/></a>4e69fd88</h3>

<pre>
commit 4e69fd88855280618ac5479b33f1a2de3a3e4d6a
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu Jan 1 01:10:27 2015 -0500

    Trap case that the shifted PSF isn't at the proper position
    
    This causes an assertion failure in _overlap.
</pre>
<h3><a name="ad2c8388"/></a>ad2c8388</h3>

<pre>
commit ad2c83884c84920d60c472d7e633bb9c8c8e1ab2
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Jun 13 10:17:51 2013 -0400

    remove plotting, clean up, and add rampFluxAtEdge option
</pre>
<h3><a name="5e3ba624"/></a>5e3ba624</h3>

<pre>
commit 5e3ba62489fda2226fd723f3de043d6fe9f3d074
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jul 9 14:56:19 2012 -0500

    refactor, tidy
</pre>
<h3><a name="ebbaa999"/></a>ebbaa999</h3>

<pre>
commit ebbaa999c55094bc0f6906f156ef24d90be161b5
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 3 12:01:38 2014 -0600

    continue reviving tests; raise exception early if footprint/image bounding-box geometry doesn't match
</pre>
<h3><a name="a42b82ff"/></a>a42b82ff</h3>

<pre>
commit a42b82ff52e052543dba7b877916705fbd1b99d0
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jul 9 14:43:56 2012 -0500

    Replace loop over pixels by flat array indexing.  Lots o' debug output
</pre>
<h3><a name="aeec2864"/></a>aeec2864</h3>

<pre>
commit aeec28640698bf337dc7fa9b5246c6a0dfe14d71
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 15 11:57:26 2014 -0600

    add config field for clipStrayFluxFraction
</pre>
<h3><a name="e2e1a694"/></a>e2e1a694</h3>

<pre>
commit e2e1a69473df128c043ee6c78b9ef1950dec61c3
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Apr 10 15:16:44 2014 -0400

    strayFlux doesn't need a peak; getFluxPortion doesn't need to re-add the peak
</pre>
<h3><a name="846a6363"/></a>846a6363</h3>

<pre>
commit 846a6363c691d7b1c5424f70893f37694e7ad850
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 17 10:48:03 2014 -0600

    deblender: convertNamesToCamelCase
</pre>
<h3><a name="eb557384"/></a>eb557384</h3>

<pre>
commit eb5573846c8e0de47ada3e2c9510f8272915f743
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jul 9 16:40:42 2012 -0500

    Make some plots showing the A matrix terms -- find & fix ramp-weight bug
</pre>
<h3><a name="ac0865d5"/></a>ac0865d5</h3>

<pre>
commit ac0865d52e0bbb1a24e8ae533491b70be1236bf9
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Sun Jul 29 15:56:00 2012 +0900

    The other half of maxNumberOfPeaks support (the first half is in meas_algorithms 5c785921a771d4)
</pre>
<h3><a name="73387ae5"/></a>73387ae5</h3>

<pre>
commit 73387ae5dace055a5b5f46d9d8466588d3905f12
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Sat Apr 12 11:48:52 2014 -0400

    more plots about deblended-as-PSF
</pre>
<h3><a name="9c47f7bf"/></a>9c47f7bf</h3>

<pre>
commit 9c47f7bfa70c229b24ae88885960486aecc0d478
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Feb 17 12:18:37 2012 -0500

    tidy up baseline.py, adding some comments, making the effective PSF priors into parameters, and removing the python implementations of building symmetric templates and apportioning flux.
</pre>
<h3><a name="29b043e7"/></a>29b043e7</h3>

<pre>
commit 29b043e7b16094918d6ef1f756e9a21c3ffc64cc
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Mar 10 15:46:58 2014 -0400

    clip template footprints to non-zero
</pre>
<h3><a name="f8aaece6"/></a>f8aaece6</h3>

<pre>
commit f8aaece6d694156cbd5ccba187a7237520a35acf
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Sep 17 12:40:12 2014 -0400

    handle_flux_at_edge: ensure footprint is not over-sized
    
    The 'tfoot' and 'fpcopy' had different sizes, which causes
    memory problems in buildSymmetricTemplate.
</pre>
<h3><a name="6e406c53"/></a>6e406c53</h3>

<pre>
commit 6e406c53039cc3352f61637e2e5a9da437d87fd2
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Jan 2 16:27:47 2014 -0500

    continue revamping deblender code to use new results objects
</pre>
<h3><a name="b606deab"/></a>b606deab</h3>

<pre>
commit b606deab6b402a542ffdf2720a84cf48491508b1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Apr 11 14:44:27 2014 -0400

    add config option for how to split stray flux; add NEAREST_FOOTPRINT option; reduce default max number of pixels
</pre>
<h3><a name="dde33c6e"/></a>dde33c6e</h3>

<pre>
commit dde33c6eadf436e532d917feee876cee127e485c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jan 3 14:31:29 2014 -0500

    whitespace changes; and make tinyFootprintSize configurable
</pre>
<h3><a name="5e5a6ff4"/></a>5e5a6ff4</h3>

<pre>
commit 5e5a6ff459672d3777016dd5c3bd0aae68cd1707
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Feb 12 15:11:33 2013 -0500

    start assigning stray flux
</pre>
<h3><a name="b993573a"/></a>b993573a</h3>

<pre>
commit b993573aa4bd2aea25ce24e4e37f0ee0dca0876d
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jul 10 10:56:38 2012 -0500

    revert meshgrid -- removing it didn't clearly help.  Cache pk.getF()
</pre>
<h3><a name="005add45"/></a>005add45</h3>

<pre>
commit 005add45db79d65b6ba109c74ca00611691c1fc8
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 8 12:52:20 2014 -0600

    make examples/edges.py into a test case for the edge-ramping code
</pre>
<h3><a name="a8cf6c22"/></a>a8cf6c22</h3>

<pre>
commit a8cf6c22df14494d6dcf2d7354c695cba9506301
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Mar 18 11:49:14 2015 -0400

    Clarify tiny footprint limit
    
    The tiny footprint limit cannot be reduced below 2 because the
    "PSF dx" calculation involves shifting the PSF by one pixel to
    the left and to the right (for a total of 2; and then we need
    some pixels remaining, so the footprint must be larger than that).
    Added comments to this effect, and enforced the limit in the
    SourceDeblendConfig.
</pre>
<h3><a name="577f14a3"/></a>577f14a3</h3>

<pre>
commit 577f14a3304e939c40eefbda67b1693a89ad14ba
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jan 6 14:47:02 2014 -0500

    add doxygen and comments for makeMonotonic, and remove the unused Footprint from its signature
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="f3746e84"/></a>f3746e84</h3>

<pre>
commit f3746e84053fe509e0272f8cd7ef480a3ff27a6c
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Mon Apr 20 17:58:39 2015 -0400

    Adapt to changes in exception Python wrappers (DM-827)
</pre>
<h3><a name="66082910"/></a>66082910</h3>

<pre>
commit 660829103539c4251ca379d016ab216ae7fedc6d
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Sep 9 14:06:37 2014 -0700

    Fix one unit tests where image origin not specified.
    Make unit tests executable.
</pre>
<h3><a name="dde33c6e"/></a>dde33c6e</h3>

<pre>
commit dde33c6eadf436e532d917feee876cee127e485c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jan 3 14:31:29 2014 -0500

    whitespace changes; and make tinyFootprintSize configurable
</pre>
<h3><a name="3c82471b"/></a>3c82471b</h3>

<pre>
commit 3c82471b2797cba3af23e4fea06e46b3dcf97a26
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu Jan 1 01:10:27 2015 -0500

    Trap case that the shifted PSF isn't at the proper position
    
    This causes an assertion failure in _overlap.
    
    Conflicts:
        python/lsst/meas/deblender/baseline.py
</pre>
<h3><a name="03b5452d"/></a>03b5452d</h3>

<pre>
commit 03b5452d5812f5de9d7b4dd423d88f05307d7df6
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Thu Apr 16 11:27:04 2015 -0400

    Resolve type mismatch in log message
</pre>
<h3><a name="dcb164e2"/></a>dcb164e2</h3>

<pre>
commit dcb164e2e73790a74555df924ef532f9f7ff7d17
Author: Lauren MacArthur <lauren@astro.princeton.edu>
Date:   Thu Apr 16 14:58:27 2015 -0400

    Remove whitespace, add copyright, and minor formatting
</pre>
<h3><a name="46c0a56a"/></a>46c0a56a</h3>

<pre>
commit 46c0a56a89a0cc7b84c6c645018ef49da5070f7d
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu Jan 1 01:05:57 2015 -0500

    Catch exception from CoaddPsf in _handle_flux_at_edge
    
    The exception arises when the position is off the edge of the image,
    and hence there is no good PSF.
    
    Conflicts:
        python/lsst/meas/deblender/baseline.py
</pre>
<h3><a name="a1442386"/></a>a1442386</h3>

<pre>
commit a14423863c146e6e00438609041bdae67f191fbc
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Feb 22 20:23:05 2013 +0900

    More display-based debugging for deblender (#2682)
</pre>
<h3><a name="6428a772"/></a>6428a772</h3>

<pre>
commit 6428a77262cdc9a9fe39e17da8a6bca9735b1c77
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Wed Jul 2 22:39:06 2014 -1000

    Replace print statements by logging at verbosity 9 (== importance -9)
    
    Also removed unconditional override of verbosity of "meas_deblending.baseline".
    
    To enable these prints say
        -T meas_deblender.baseline=9
    to cmdLineTask (e.g. processCcd.py), or put
        pexLog.Trace.setVerbosity('meas_deblender.baseline', 9)
    somewhere in your code.
    
    Why 9?  Because Dstn put them in as prints, and logging at verbosity
    10 (== -DEBUG) would turn on other meas_deblender.baseline debug statements.
</pre>
<h3><a name="9370f92d"/></a>9370f92d</h3>

<pre>
commit 9370f92d803756ca549b60a9d1af1bb1e6835a75
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jun 24 11:18:46 2014 -0500

    Rename clipToNonzeroF -> clipToNonzero
</pre>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
<h3><a name="c813cc7d"/></a>c813cc7d</h3>

<pre>
commit c813cc7db1034c862f517b0fdb01816d898675c1
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Apr 11 14:44:27 2014 -0400

    Deblending: add config option for how to split stray flux; add NEAREST_FOOTPRINT option; reduce default max number of pixels
</pre>
<h3><a name="d62b5dc4"/></a>d62b5dc4</h3>

<pre>
commit d62b5dc438fa3e0d3cd3ace52de23f14cce32e36
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Oct 21 17:38:27 2013 -0400

    start responding to Steve's review, with a revamp of the deblending result objects.  Currently highly broken, but I'm going home for the day
</pre>
<h3><a name="acb6bebf"/></a>acb6bebf</h3>

<pre>
commit acb6bebf88e3f8a24c52c83e0032764ce4c00c6e
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Dec 18 11:47:29 2014 -0500

    Catch failure to evaluate Psf at an out-of-bounds point
    
    We fall back to the "average position" in this case, which isn't ideal,
    but better than a complete failure.
    
    The situation will be improved in the future on HSC-1119 and HSC-1120.
    
    Conflicts:
        python/lsst/meas/deblender/baseline.py
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_20"><a name="tests/ticket2871.py"/></a>tests/ticket2871.py</h1>

<h3 id="toc_21">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                #
                # LSST Data Management System
                # Copyright 2008-2013 LSST Corporation.
                #
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                #
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                #
                # You should have received a copy of the LSST License Statement and
                # the GNU General Public License along with this program.  If not,
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import unittest
                import lsst.utils.tests as tests
                
                
                import lsst.afw.detection as afwDetection
                import lsst.afw.image as afwImage
                import lsst.afw.geom as afwGeom
                import lsst.afw.table as afwTable
                import lsst.meas.algorithms as algorithms
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                class DeblendTestCase(unittest.TestCase):
                    """A test case for deblending"""
                
                    def checkDeblender(self):
                        try:
                            import lsst.meas.deblender
                        except ImportError, e:
                            self.skipTest("Cannot import lsst.meas.deblender: %s" % e)
                
                    def testFailures(self):
                        """Test deblender failure flagging (#2871)
                
                        We create a good source which is expected to pass and a bad source
                        which is expected to fail because its footprint goes off the image.
                        This latter case may not happen in practise, but it is useful for
                        checking the plumbing of the deblender.
                        """
                        import lsst.meas.deblender as measDeb
                
                        self.checkDeblender()
                        xGood, yGood = 57, 86
                        xBad, yBad = 0, 0 # Required to be in image so we can evaluate the PSF; will put neighbour just outside
                        flux = 100.0
                        dims = afwGeom.Extent2I(128, 128)
                
                        mi = afwImage.MaskedImageF(dims)
                        mi.getVariance().set(1.0)
                        image = mi.getImage()
                        image.set(0)
                        image.set(xGood, yGood, flux)
                
                        exposure = afwImage.makeExposure(mi)
                        psf = algorithms.DoubleGaussianPsf(21, 21, 3.)
                        exposure.setPsf(psf)
                
                        schema = afwTable.SourceTable.makeMinimalSchema()
                
                        config = measDeb.SourceDeblendConfig()
                        config.catchFailures = True
                        task = measDeb.SourceDeblendTask(schema, config=config)
                
                        catalog = afwTable.SourceCatalog(schema)
                
                        def makeSource(x, y, offset=-2, size=3.0):
                            """Make a source in the catalog
                
                            Two peaks are created: one at the specified
                            position, and one offset in x,y.
                            The footprint is of the nominated size.
                            """
                            src = catalog.addNew()
                            foot = afwDetection.Footprint(afwGeom.Point2I(x, y), size)
                            foot.addPeak(x, y, flux)
                            foot.addPeak(x + offset, y + offset, flux)
                            src.setFootprint(foot)
                            return src
                
                        good = makeSource(xGood, yGood)
                        bad = makeSource(xBad, yBad)
                
                        task.run(exposure, catalog, psf)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#a212bc03">a212bc03</a> -         self.assertFalse(good.get('deblend.failed'))</div>
              ?                                           ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#22f14a7e">22f14a7e</a> +         self.assertFalse(good.get('deblend_failed'))</div>
              ?                                           ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#a212bc03">a212bc03</a> -         self.assertTrue(bad.get('deblend.failed'))</div>
              ?                                         ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#22f14a7e">22f14a7e</a> +         self.assertTrue(bad.get('deblend_failed'))</div>
              ?                                         ^
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    tests.init()
                
                    suites = []
                    suites += unittest.makeSuite(DeblendTestCase)
                    suites += unittest.makeSuite(tests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(exit = False):
                    """Run the tests"""
                    tests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="a212bc03"/></a>a212bc03</h3>

<pre>
commit a212bc0312acc4ca19808b665c17bc106198a3e8
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Mon Jun 10 12:17:37 2013 -0400

    move tests/ticket2871.py here
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="22f14a7e"/></a>22f14a7e</h3>

<pre>
commit 22f14a7e9f5235f5cc3bd6f48b45f281d3139926
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Sat Mar 14 12:21:15 2015 -0700

    Remove ability to work on version 0 files
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_22"><a name="examples/plotDeblendFamilies.py"/></a>examples/plotDeblendFamilies.py</h1>

<h3 id="toc_23">Diff:</h3>

<pre>
                import matplotlib
                matplotlib.use('Agg')
                import pylab as plt
                
                import os
                import numpy as np
                
                import lsst.daf.persistence as dafPersist
                import lsst.afw.detection as afwDet
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
10   <a href="#2853897c">2853897c</a> - import lsst.afw.geom as afwGeom</div>
                import lsst.afw.image as afwImage
                import lsst.afw.table as afwTable
                import lsst.pex.logging as pexLogging
                from lsst.meas.deblender.baseline import *
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#2853897c">2853897c</a> - from lsst.meas.deblender import BaselineUtilsF as butils</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#2853897c">2853897c</a> - import lsst.meas.algorithms as measAlg</div>
                
                from astrometry.util.plotutils import *
                
                import lsstDebug
                lsstDebug.Info('lsst.meas.deblender.baseline').psf = True
                
                
                root = pexLogging.Log.getDefaultLog()
                root.setThreshold(pexLogging.Log.DEBUG)
                # Quiet some of the more chatty loggers
                pexLogging.Log(root, 'lsst.meas.deblender.symmetrizeFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.symmetricFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.getSignificantEdgePixels',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'afw.Mask', pexLogging.Log.INFO)
                
                
                def foot_to_img(foot, img=None):
                    fimg = afwImage.ImageF(foot.getBBox())
                    fimg.getArray()[:,:] = np.nan
                    if foot.isHeavy():
                        foot = afwDet.cast_HeavyFootprintF(foot)
                        foot.insert(fimg)
                        heavy = True
                    else:
                        if img is None:
                            return None,False
                        afwDet.copyWithinFootprintImage(foot, img, fimg)
                        # ia = img.getArray()
                        # fa = fimg.getArray()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#2853897c">2853897c</a> -         # fbb = fimg.getBBox(afwImage.PARENT)</div>
              ?                              ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#5ea010ad">5ea010ad</a> +         # fbb = fimg.getBBox()</div>
                        # fx0,fy0 = fbb.getMinX(), fbb.getMinY()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#2853897c">2853897c</a> -         # ibb = img.getBBox(afwImage.PARENT)</div>
              ?                             ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#5ea010ad">5ea010ad</a> +         # ibb = img.getBBox()</div>
                        # ix0,iy0 = ibb.getMinX(), ibb.getMinY()
                        # for span in foot.getSpans():
                        #     y,x0,x1 = span.getY(), span.getX0(), span.getX1()
                        #     # print 'Span', y, x0, x1
                        #     # print 'img', ix0, iy0
                        #     # print 'shape', ia[y - iy0, x0 - ix0: x1+1 - ix0].shape
                        #     # print 'fimg', fx0, fy0,
                        #     # print 'shape', fa[y - fy0, x0 - fx0: x1+1 - fx0].shape
                        #     fa[y - fy0, x0 - fx0: x1+1 - fx0] = ia[y - iy0, x0 - ix0: x1+1 - ix0]
                        heavy = False
                    return fimg, heavy
                
                def img_to_rgb(im, mn, mx):
                    rgbim = np.clip((im-mn)/(mx-mn), 0., 1.)[:,:,np.newaxis].repeat(3, axis=2)
                    I = np.isnan(im)
                    for i in range(3):
                        rgbim[:,:,i][I] = (0.8, 0.8, 0.3)[i]
                    I = (im == 0)
                    for i in range(3):
                        rgbim[:,:,i][I] = (0.5, 0.5, 0.8)[i]
                    return rgbim
                
                def bb_to_ext(bb):
                    y0,y1,x0,x1 = bb.getMinY(), bb.getMaxY(), bb.getMinX(), bb.getMaxX()
                    return [x0-0.5, x1+0.5, y0-0.5, y1+0.5]
                
                def bb_to_xy(bb, margin=0):
                    y0,y1,x0,x1 = bb.getMinY(), bb.getMaxY(), bb.getMinX(), bb.getMaxX()
                    x0,x1,y0,y1 = x0-margin, x1+margin, y0-margin, y1+margin
                    return [x0,x0,x1,x1,x0], [y0,y1,y1,y0,y0]
                
                
                def makeplots(butler, dataId, ps, sources=None, pids=None, minsize=0,
                              maxpeaks=10):
                    calexp = butler.get("calexp", **dataId)
                    if sources is None:
                        ss = butler.get('src', **dataId)
                    else:
                        ss = sources
                
                    #print 'Sources', ss
                    #print 'Calexp', calexp
                    #print dir(ss)
                    
                    srcs = {}
                    families = {}
                    for src in ss:
                        sid = src.getId()
                        srcs[sid] = src
                        parent = src.getParent()
                        if parent == 0:
                            continue
                        if not parent in families:
                            families[parent] = []
                        families[parent].append(src)
                        # print 'Source', src
                        # print '  ', dir(src)
                        # print '  parent', src.getParent()
                        # print '  footprint', src.getFootprint()
                    
                    print
                    lsstimg = calexp.getMaskedImage().getImage()
                    img = lsstimg.getArray()
                    schema = ss.getSchema()
                    psfkey = schema.find("deblend.deblended-as-psf").key
                    nchildkey = schema.find("deblend.nchild").key
                    toomanykey = schema.find("deblend.too-many-peaks").key
                    failedkey = schema.find("deblend.failed").key
                    
                    def getFlagString(src):
                        ss = ['Nchild: %i' % src.get(nchildkey)]
                        for key,s in [(psfkey, 'PSF'),
                                      (toomanykey, 'TooMany'),
                                      (failedkey, 'Failed')]:
                            if src.get(key):
                                ss.append(s)
                        return ', '.join(ss)
                    
                
                    plt.subplots_adjust(left=0.05, right=0.95, bottom=0.05, top=0.9,
                                        hspace=0.2, wspace=0.3)
                
                    sig1 = np.sqrt(np.median(calexp.getMaskedImage().getVariance().getArray().ravel()))
                    pp = (img / np.sqrt(calexp.getMaskedImage().getVariance().getArray())).ravel()
                    plt.clf()
                    lo,hi = -4,4
                    n,b,p = plt.hist(img.ravel() / sig1, 100, range=(lo,hi), histtype='step', color='b')
                    plt.hist(pp, 100, range=(lo,hi), histtype='step', color='g')
                    xx = np.linspace(lo,hi, 200)
                    yy = 1./(np.sqrt(2.*np.pi)) * np.exp(-0.5 * xx**2)
                    yy *= sum(n) * (b[1]-b[0])
                    plt.plot(xx, yy, 'k-', alpha=0.5)
                    plt.xlim(lo,hi)
                    plt.title('image-wide sig1: %.1f' % sig1)
                    ps.savefig()
                    
                    for ifam,(p,kids) in enumerate(families.items()):
                
                        parent = srcs[p]
                        pid = parent.getId() & 0xffff
                        if len(pids) and not pid in pids:
                            #print 'Skipping pid', pid
                            continue
                
                        if len(kids) < minsize:
                            print 'Skipping parent', pid, ': n kids', len(kids)
                            continue
                    
                        # if len(kids) < 5:
                        #     print 'Skipping family with', len(kids)
                        #     continue
                        # print 'ifam', ifam
                        # if ifam != 18:
                        #     print 'skipping'
                        #     continue
                
                        print 'Parent', parent
                        print 'Kids', kids
                    
                        print 'Parent', parent.getId()
                        print 'Kids', [k.getId() for k in kids]
                    
                        pfoot = parent.getFootprint()
                        bb = pfoot.getBBox()
                    
                        y0,y1,x0,x1 = bb.getMinY(), bb.getMaxY(), bb.getMinX(), bb.getMaxX()
                        slc = slice(y0, y1+1), slice(x0, x1+1)
                    
                        ima = dict(interpolation='nearest', origin='lower', cmap='gray',
                                   vmin=-10, vmax=40)
                        mn,mx = ima['vmin'], ima['vmax']
                    
                        if False:
                            plt.clf()
                            plt.imshow(img[slc], extent=bb_to_ext(bb), **ima)
                            plt.title('Parent %i, %s' % (parent.getId(), getFlagString(parent)))
                            ax = plt.axis()
                            x,y = bb_to_xy(bb)
                            plt.plot(x, y, 'r-', lw=2)
                            for i,kid in enumerate(kids):
                                kfoot = kid.getFootprint()
                                kbb = kfoot.getBBox()
                                kx,ky = bb_to_xy(kbb, margin=0.4)
                                plt.plot(kx, ky, 'm-')
                            for pk in pfoot.getPeaks():
                                plt.plot(pk.getIx(), pk.getIy(), 'r+', ms=10, mew=3)
                            plt.axis(ax)
                            ps.savefig()
                    
                        print 'parent footprint:', pfoot
                        print 'heavy?', pfoot.isHeavy()
                        plt.clf()
                        pimg,h = foot_to_img(pfoot, lsstimg)
                
                        plt.imshow(img_to_rgb(pimg.getArray(), mn,mx), extent=bb_to_ext(bb), **ima)
                        tt = 'Parent %i' % parent.getId()
                        if not h:
                            tt += ', no HFoot'
                        tt += ', ' + getFlagString(parent)
                        plt.title(tt)
                        ax = plt.axis()
                        plt.plot([x0,x0,x1,x1,x0], [y0,y1,y1,y0,y0], 'r-', lw=2)
                        for i,kid in enumerate(kids):
                            kfoot = kid.getFootprint()
                            kbb = kfoot.getBBox()
                            kx,ky = bb_to_xy(kbb, margin=-0.1)
                            plt.plot(kx, ky, 'm-', lw=1.5)
                        for pk in pfoot.getPeaks():
                            plt.plot(pk.getIx(), pk.getIy(), 'r+', ms=10, mew=3)
                        plt.axis(ax)
                        ps.savefig()
                    
                    
                        cols = int(np.ceil(np.sqrt(len(kids))))
                        rows = int(np.ceil(len(kids) / float(cols)))
                    
                        if False:
                            plt.clf()
                            for i,kid in enumerate(kids):
                                plt.subplot(rows, cols, 1+i)
                                kfoot = kid.getFootprint()
                                print 'kfoot:', kfoot
                                print 'heavy?', kfoot.isHeavy()
                                #print dir(kid)
                                kbb = kfoot.getBBox()
                                ky0,ky1,kx0,kx1 = kbb.getMinY(), kbb.getMaxY(), kbb.getMinX(), kbb.getMaxX()
                                kslc = slice(ky0, ky1+1), slice(kx0, kx1+1)
                                plt.imshow(img[kslc], extent=bb_to_ext(kbb), **ima)
                                plt.title('Child %i' % kid.getId())
                                plt.axis(ax)
                            ps.savefig()
                    
                        plt.clf()
                        for i,kid in enumerate(kids):
                            plt.subplot(rows, cols, 1+i)
                            kfoot = kid.getFootprint()
                            kbb = kfoot.getBBox()
                            kimg,h = foot_to_img(kfoot, lsstimg)
                            tt = getFlagString(kid)
                            if not h:
                                tt += ', no HFoot'
                            plt.title('%s' % tt)
                            if kimg is None:
                                plt.axis(ax)
                                continue
                            plt.imshow(img_to_rgb(kimg.getArray(),mn,mx), extent=bb_to_ext(kbb), **ima)
                            for pk in kfoot.getPeaks():
                                plt.plot(pk.getIx(), pk.getIy(), 'g+', ms=10, mew=3)
                            plt.axis(ax)
                        plt.suptitle('Child HeavyFootprints')
                        ps.savefig()
                    
                    
                    
                        print
                        print 'Re-running deblender...'
                        psf = calexp.getPsf()
                        psf_fwhm = psf.computeShape().getDeterminantRadius() * 2.35
                        deb = deblend(pfoot, calexp.getMaskedImage(), psf, psf_fwhm, verbose=True,
                                      maxNumberOfPeaks=maxpeaks,
                                      rampFluxAtEdge=True,
                                      clipStrayFluxFraction=0.01,
                                      )
                        print 'Got', deb
                    
                        def getDebFlagString(kid):
                            ss = []
                            for k in ['skip', 'outOfBounds', 'tinyFootprint', 'noValidPixels',
                                      ('deblendedAsPsf','PSF'), 'psfFitFailed', 'psfFitBadDof',
                                      'psfFitBigDecenter', 'psfFitWithDecenter',
                                      'failedSymmetricTemplate', 'hasRampedTemplate', 'patched']:
                                if len(k) == 2:
                                    k,s = k
                                else:
                                    s = k
                                if getattr(kid, k):
                                    ss.append(s)
                            return ', '.join(ss)
                    
                        N = len(deb.peaks)
                        cols = int(np.ceil(np.sqrt(N)))
                        rows = int(np.ceil(N / float(cols)))
                    
                        for plotnum in range(4):
                            plt.clf()
                            for i,kid in enumerate(deb.peaks):
                                # print 'child', kid
                                # print '  flags:', getDebFlagString(kid)
                
                                kfoot = None
                                if plotnum == 0:
                                    kfoot = kid.getFluxPortion(strayFlux=False)
                                    supt = 'flux portion'
                                elif plotnum == 1:
                                    kfoot = kid.getFluxPortion(strayFlux=True)
                                    supt = 'flux portion + stray'
                                elif plotnum == 2:
                                    kfoot = afwDet.makeHeavyFootprint(kid.templateFootprint,
                                                                      kid.templateMaskedImage)
                                    supt = 'template'
                                elif plotnum == 3:
                                    if kid.deblendedAsPsf:
                                        kfoot = afwDet.makeHeavyFootprint(kid.psfFootprint,
                                                                          kid.psfTemplate)
                                        kfoot.normalize()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#2853897c">2853897c</a> -                         kfoot.clipToNonzeroF(kid.psfTemplate.getImage())</div>
              ?                                            -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#9370f92d">9370f92d</a> +                         kfoot.clipToNonzero(kid.psfTemplate.getImage())</div>
                                        # print 'kfoot BB:', kfoot.getBBox()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#73387ae5">73387ae5</a> -                         # print 'Img bb:', kid.psfTemplate.getImage().getBBox(afwImage.PARENT)</div>
              ?                                                                               ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#5ea010ad">5ea010ad</a> +                         # print 'Img bb:', kid.psfTemplate.getImage().getBBox()</div>
                                        # for sp in kfoot.getSpans():
                                        #     print '  span', sp
                                    else:
                                        kfoot = afwDet.makeHeavyFootprint(kid.templateFootprint,
                                                                          kid.templateMaskedImage)
                                    supt = 'psf template'
                
                                kimg,h = foot_to_img(kfoot, None)
                                tt = 'kid %i: %s' % (i, getDebFlagString(kid))
                                if not h:
                                    tt += ', no HFoot'
                                plt.subplot(rows, cols, 1+i)
                                plt.title('%s' % tt, fontsize=8)
                                if kimg is None:
                                    plt.axis(ax)
                                    continue
                                kbb = kfoot.getBBox()
                
                                plt.imshow(img_to_rgb(kimg.getArray(), mn,mx), extent=bb_to_ext(kbb), **ima)
                    
                                #plt.imshow(kimg.getArray(), extent=bb_to_ext(kbb), **ima)
                    
                                plt.axis(ax)
                    
                            plt.suptitle(supt)
                            ps.savefig()
                
                
                        for i,kid in enumerate(deb.peaks):
                            if not kid.deblendedAsPsf:
                                continue
                            plt.clf()
                
                            ima = dict(interpolation='nearest', origin='lower', cmap='gray')
                            #vmin=0, vmax=kid.psfFitFlux)
                
                            plt.subplot(2,4,1)
                            #plt.title('fit psf 0')
                            #plt.imshow(kid.psfFitDebugPsf0Img.getArray(), **ima)
                            #plt.colorbar()
                            #plt.title('valid pixels')
                            #plt.imshow(kid.psfFitDebugValidPix, vmin=0, vmax=1, **ima)
                            plt.title('weights')
                            plt.imshow(kid.psfFitDebugWeight, vmin=0, **ima)
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                            plt.subplot(2,4,7)
                            plt.title('valid pixels')
                            plt.imshow(kid.psfFitDebugValidPix, vmin=0, vmax=1, **ima)
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                
                            plt.subplot(2,4,2)
                            #plt.title('ramp weights')
                            #plt.imshow(kid.psfFitDebugRampWeight, vmin=0, vmax=1, **ima)
                            #plt.colorbar()
                            sig = np.sqrt(kid.psfFitDebugVar.getArray())
                            data = kid.psfFitDebugStamp.getArray()
                            model = kid.psfFitDebugPsfModel.getArray()
                            chi = ((data - model) / sig)
                            valid = kid.psfFitDebugValidPix           
                
                            plt.hist(np.clip((data/sig)[valid], -5, 5), 20, range=(-5,5),
                                     histtype='step', color='m')
                            plt.hist(np.clip((model/sig)[valid], -5, 5), 20, range=(-5,5),
                                     histtype='step', color='r')
                            plt.hist(np.clip(chi.ravel(), -5,5), 20, range=(-5,5),
                                     histtype='step', color='g')
                            n,b,p = plt.hist(np.clip(chi[valid], -5,5), 20, range=(-5,5),
                                             histtype='step', color='b')
                
                            xx = np.linspace(-5,5, 200)
                            yy = 1./(np.sqrt(2.*np.pi)) * np.exp(-0.5 * xx**2)
                            yy *= sum(n) * (b[1]-b[0])
                            plt.plot(xx, yy, 'k-', alpha=0.5)
                
                            plt.xlim(-5,5)
                
                            print 'Sum of ramp weights:', np.sum(kid.psfFitDebugRampWeight)
                            print 'Quadrature sum of ramp weights:', np.sqrt(np.sum(kid.psfFitDebugRampWeight**2))
                            print 'Number of valid pix:', np.sum(kid.psfFitDebugValidPix)
                            rw = kid.psfFitDebugRampWeight
                            valid = kid.psfFitDebugValidPix
                            # print 'valid values:', np.unique(valid)
                            print 'rw[valid]', np.sum(rw[valid])
                            print 'rw range', rw.min(), rw.max()
                            # print 'rw', rw.shape, rw.dtype
                            # print 'valid', valid.shape, valid.dtype
                            # print 'rw[valid]:', rw[valid]
                
                            myresid = np.sum(kid.psfFitDebugValidPix *
                                             kid.psfFitDebugRampWeight *
                                             ((kid.psfFitDebugStamp.getArray() -
                                               kid.psfFitDebugPsfModel.getArray()) /
                                              np.sqrt(kid.psfFitDebugVar.getArray()))**2)
                            print 'myresid:', myresid
                
                
                            plt.subplot(2,4,8)
                            N = 20000
                            rwv = rw[valid]
                            print 'rwv', rwv
                            x = np.random.normal(size=(N,len(rwv)))
                            ss = np.sum(rwv * x**2, axis=1)
                            plt.hist(ss, 25)
                            chi,dof = kid.psfFitBest
                            plt.axvline(chi, color='r')
                
                            mx = kid.psfFitDebugPsfModel.getArray().max()
                
                            plt.subplot(2,4,3)
                            #plt.title('fit psf')
                            #plt.imshow(kid.psfFitDebugPsfImg.getArray(), **ima)
                            #plt.colorbar()
                            # plt.title('variance')
                            # plt.imshow(kid.psfFitDebugVar.getArray(), vmin=0, **ima)
                            # plt.colorbar()
                            plt.title('model+noise')
                            plt.imshow((kid.psfFitDebugPsfModel.getArray() +
                                        sig * np.random.normal(size=sig.shape))*valid,
                                       vmin=0, vmax=mx, **ima)
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                            plt.subplot(2,4,4)
                            plt.title('fit psf model')
                            plt.imshow(kid.psfFitDebugPsfModel.getArray(), vmin=0, vmax=mx, **ima)
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                            plt.subplot(2,4,5)
                            plt.title('fit psf image')
                            plt.imshow(kid.psfFitDebugStamp.getArray(), vmin=0, vmax=mx, **ima)
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                            chi = (kid.psfFitDebugValidPix *
                                   (kid.psfFitDebugStamp.getArray() -
                                    kid.psfFitDebugPsfModel.getArray()) /
                                   np.sqrt(kid.psfFitDebugVar.getArray()))
                
                            plt.subplot(2,4,6)
                            plt.title('fit psf chi')
                            plt.imshow(-chi, vmin=-3, vmax=3, interpolation='nearest', origin='lower', cmap='RdBu')
                            plt.xticks([]); plt.yticks([])
                            plt.colorbar()
                
                            params = kid.psfFitParams
                            (flux, sky, skyx, skyy) = params[:4]
                
                            print 'Model sum:', model.sum()
                            print '- sky', model.sum() - np.sum(valid)*sky
                
                            sig1 = np.median(sig)
                
                            chi,dof = kid.psfFitBest
                            plt.suptitle('PSF kid %i: flux %.1f, sky %.1f, sig1 %.1f' % (i, flux, sky, sig1)) #: chisq %g, dof %i' % (i, chi, dof))
                
                            ps.savefig()
                
                    
                        #if ifam == 5:
                        #    break
                
                
                if __name__ == '__main__':
                    import optparse
                    import sys
                
                    parser = optparse.OptionParser()
                    parser.add_option('--data', help='Data dir, default $SUPRIME_DATA_DIR/rerun/RERUN')
                    parser.add_option('--rerun', help='Rerun name, default %default', default='dstn/deb')
                    parser.add_option('--visit', help='Visit number, default %default', default=905516, type=int)
                    parser.add_option('--ccd', help='CCD number, default %default', default=22, type=int)
                    parser.add_option('--sources', help='Read sources file', type=str)
                    parser.add_option('--hdu', help='With --sources, HDU to read; default %default',
                                      type=int, default=2)
                    parser.add_option('--pid', '-p', action='append', default=[], type=int,
                                      help='Deblend a specific parent ID')
                    parser.add_option('--big', dest='minsize', default=0, help='Only show results for deblend families larger than this', type=int)
                    parser.add_option('--maxpeaks', default=10, help='maxNumberOfPeaks', type=int)
                
                    opt,args = parser.parse_args()
                
                    if len(args):
                        parser.print_help()
                        sys.exit(-1)
                
                    if not opt.data:
                        opt.data = os.path.join(os.environ['SUPRIME_DATA_DIR'],
                                                'rerun', opt.rerun)
                
                    print 'Data directory:', opt.data
                    butler = dafPersist.Butler(opt.data)
                    dataId = dict(visit=opt.visit, ccd=opt.ccd)
                    ps = PlotSequence('deb')
                
                    sources = None
                    if opt.sources:
                        flags = 0
                        sources = afwTable.SourceCatalog.readFits(opt.sources, opt.hdu, flags)
                        print 'Read sources from', opt.sources, ':', sources
                
                    makeplots(butler, dataId, ps, sources=sources, pids=opt.pid, minsize=opt.minsize,
                              maxpeaks=opt.maxpeaks)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="73387ae5"/></a>73387ae5</h3>

<pre>
commit 73387ae5dace055a5b5f46d9d8466588d3905f12
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Sat Apr 12 11:48:52 2014 -0400

    more plots about deblended-as-PSF
</pre>
<h3><a name="2853897c"/></a>2853897c</h3>

<pre>
commit 2853897c18604b68d6e429e97d55a460588e7b02
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Tue Mar 11 15:33:52 2014 -0400

    add (another) debugging script
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="9370f92d"/></a>9370f92d</h3>

<pre>
commit 9370f92d803756ca549b60a9d1af1bb1e6835a75
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Jun 24 11:18:46 2014 -0500

    Rename clipToNonzeroF -> clipToNonzero
</pre>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_24"><a name="tests/edges.py"/></a>tests/edges.py</h1>

<h3 id="toc_25">Diff:</h3>

<pre>
                #!/usr/bin/env python
                doPlot = False
                if doPlot:
                    import matplotlib
                    matplotlib.use('Agg')
                    import pylab as plt
                    import os.path
                    plotpat = os.path.join(os.path.dirname(__file__), 'edge%i.png')
                    print 'Writing plots to', plotpat
                else:
                    print '"doPlot" not set -- not making plots.  To enable plots, edit', __file__
                
                import unittest
                import lsst.utils.tests         as utilsTests
                
                import numpy as np
                
                import lsst.afw.detection as afwDet
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.pex.logging as pexLogging
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#4a143c5e">4a143c5e</a> - from lsst.meas.deblender.baseline import *</div>
              ?                                          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#5ea010ad">5ea010ad</a> + from lsst.meas.deblender.baseline import deblend</div>
              ?                                          ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#4a143c5e">4a143c5e</a> - from lsst.meas.deblender import BaselineUtilsF as butils</div>
                
                import lsst.meas.algorithms as measAlg
                
                root = pexLogging.Log.getDefaultLog()
                root.setThreshold(pexLogging.Log.DEBUG)
                # Quiet some of the more chatty loggers
                pexLogging.Log(root, 'lsst.meas.deblender.symmetrizeFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.symmetricFootprint',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'lsst.meas.deblender.getSignificantEdgePixels',
                               pexLogging.Log.INFO)
                pexLogging.Log(root, 'afw.Mask', pexLogging.Log.INFO)
                               
                def imExt(img):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#4a143c5e">4a143c5e</a> -     bbox = img.getBBox(afwImage.PARENT)</div>
              ?                        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#5ea010ad">5ea010ad</a> +     bbox = img.getBBox()</div>
                    return [bbox.getMinX(), bbox.getMaxX(),
                            bbox.getMinY(), bbox.getMaxY()]
                
                def doubleGaussianPsf(W, H, fwhm1, fwhm2, a2):
                    return measAlg.DoubleGaussianPsf(W, H, fwhm1, fwhm2, a2)
                    
                def gaussianPsf(W, H, fwhm):
                    return measAlg.DoubleGaussianPsf(W, H, fwhm)
                
                
                class RampEdgeTestCase(unittest.TestCase):
                
                    def test1(self):
                        '''
                        In this test, we create a test image containing two blobs, one 
                        of which is truncated by the edge of the image.
                
                        We run the detection code to get realistic peaks and
                        footprints.
                        
                        We then test out the different edge treatments and assert that
                        they do what they claim.  We also make plots, tests/edge*.png
                        '''
                
                
                        # Create fake image...
                        H,W = 100,100
                        fpbb = afwGeom.Box2I(afwGeom.Point2I(0,0),
                                             afwGeom.Point2I(W-1,H-1))
                        afwimg = afwImage.MaskedImageF(fpbb)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#005add45">005add45</a> -         imgbb = afwimg.getBBox(afwImage.PARENT)</div>
              ?                                ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#5ea010ad">5ea010ad</a> +         imgbb = afwimg.getBBox()</div>
                        img = afwimg.getImage().getArray()
                
                        var = afwimg.getVariance().getArray()
                        var[:,:] = 1.
                        
                        blob_fwhm = 15.
                        blob_psf = doubleGaussianPsf(201, 201, blob_fwhm, 3.*blob_fwhm, 0.03)
                        fakepsf_fwhm = 5.
                        S = int(np.ceil(fakepsf_fwhm * 2.)) * 2 + 1
                        print 'S', S
                        fakepsf = gaussianPsf(S, S, fakepsf_fwhm)
                    
                        # Create and save blob images, and add to image to deblend.
                        blobimgs = []
                        XY = [(50.,50.), (90.,50.)]
                        flux = 1e6
                        for x,y in XY:
                            bim = blob_psf.computeImage(afwGeom.Point2D(x, y))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#005add45">005add45</a> -             bbb = bim.getBBox(afwImage.PARENT)</div>
              ?                               ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#5ea010ad">5ea010ad</a> +             bbb = bim.getBBox()</div>
                            bbb.clip(imgbb)
                    
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#005add45">005add45</a> -             bim = bim.Factory(bim, bbb, afwImage.PARENT)</div>
              ?                                       -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#5ea010ad">5ea010ad</a> +             bim = bim.Factory(bim, bbb)</div>
                            bim2 = bim.getArray()
                    
                            blobimg = np.zeros_like(img)
                            blobimg[bbb.getMinY():bbb.getMaxY()+1,
                                    bbb.getMinX():bbb.getMaxX()+1] += flux * bim2
                            blobimgs.append(blobimg)
                    
                            img[bbb.getMinY():bbb.getMaxY()+1,
                                bbb.getMinX():bbb.getMaxX()+1] += flux * bim2
                    
                        # Run the detection code to get a ~ realistic footprint
                        thresh = afwDet.createThreshold(10., 'value', True)
                        fpSet = afwDet.FootprintSet(afwimg, thresh, 'DETECTED', 1)
                        fps = fpSet.getFootprints()
                        print 'found', len(fps), 'footprints'
                    
                        # set EDGE bit on edge pixels.
                        margin = 5
                        lo = imgbb.getMin()
                        lo.shift(afwGeom.Extent2I(margin, margin))
                        hi = imgbb.getMax()
                        hi.shift(afwGeom.Extent2I(-margin, -margin))
                        goodbbox = afwGeom.Box2I(lo, hi)
                        print 'Good bbox for setting EDGE pixels:', goodbbox
                        print 'image bbox:', imgbb
                        edgebit = afwimg.getMask().getPlaneBitMask("EDGE")
                        print 'edgebit:', edgebit
                        measAlg.SourceDetectionTask.setEdgeBits(afwimg, goodbbox, edgebit)
                    
                        if False:
                            plt.clf()
                            plt.imshow(afwimg.getMask().getArray(),
                                       interpolation='nearest', origin='lower')
                            plt.colorbar()
                            plt.title('Mask')
                            plt.savefig('mask.png')
                    
                            M = afwimg.getMask().getArray()
                            for bit in range(32):
                                mbit = (1 << bit)
                                if not np.any(M & mbit):
                                    continue
                                plt.clf()
                                plt.imshow(M & mbit,
                                           interpolation='nearest', origin='lower')
                                plt.colorbar()
                                plt.title('Mask bit %i (0x%x)' % (bit, mbit))
                                plt.savefig('mask-%02i.png' % bit)
                    
                        for fp in fps:
                            print 'peaks:', len(fp.getPeaks())
                            for pk in fp.getPeaks():
                                print '  ', pk.getIx(), pk.getIy()
                        assert(len(fps) == 1)
                        fp = fps[0]
                        assert(len(fp.getPeaks()) == 2)
                        
                        ima = dict(interpolation='nearest', origin='lower', #cmap='gray',
                                   cmap='jet',
                                   vmin=0, vmax=400)
                        
                        for j,(tt,kwa) in enumerate([
                                ('No edge treatment', dict()),
                                ('Ramp by PSF', dict(rampFluxAtEdge=True)),
                                ('No clip at edge', dict(patchEdges=True)),
                            ]):
                            #print 'Deblending...'
                            deb = deblend(fp, afwimg, fakepsf, fakepsf_fwhm, verbose=True,
                                          **kwa)
                            #print 'Result:', deb
                            #print len(deb.peaks), 'deblended peaks'
                    
                            parent_img = afwImage.ImageF(fpbb)
                            afwDet.copyWithinFootprintImage(fp, afwimg.getImage(), parent_img)
                    
                            X = [x for x,y in XY]
                            Y = [y for x,y in XY]
                            PX = [pk.getIx() for pk in fp.getPeaks()]
                            PY = [pk.getIy() for pk in fp.getPeaks()]
                
                            # Grab 1-d slices to make assertion about.
                            symms = []
                            monos = []
                            symm1ds = []
                            mono1ds = []
                            yslice = H/2
                            parent1d = img[yslice, :]
                            for i,dpk in enumerate(deb.peaks):
                                symm = dpk.origTemplate
                                symms.append(symm)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#005add45">005add45</a> -                 bbox = symm.getBBox(afwImage.PARENT)</div>
              ?                                     ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#5ea010ad">5ea010ad</a> +                 bbox = symm.getBBox()</div>
                                x0,y0 = bbox.getMinX(), bbox.getMinY()
                                im = symm.getArray()
                                h,w = im.shape
                                oned = np.zeros(W)
                                oned[x0: x0+w] = im[yslice-y0, :]
                                symm1ds.append(oned)
                    
                                mono = afwImage.ImageF(fpbb)
                                afwDet.copyWithinFootprintImage(dpk.templateFootprint,
                                                                dpk.templateMaskedImage.getImage(), mono)
                                monos.append(mono)
                
                                im = mono.getArray()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#005add45">005add45</a> -                 bbox = mono.getBBox(afwImage.PARENT)</div>
              ?                                     ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#5ea010ad">5ea010ad</a> +                 bbox = mono.getBBox()</div>
                                x0,y0 = bbox.getMinX(), bbox.getMinY()
                                h,w = im.shape
                                oned = np.zeros(W)
                                oned[x0: x0+w] = im[yslice-y0, :]
                                mono1ds.append(oned)
                
                
                            for i,(symm,mono) in enumerate(zip(symm1ds, mono1ds)):
                                # for the first two cases, the basic symmetric
                                # template for the second source drops to zero at <
                                # ~75 where the symmetric part is outside the
                                # footprint.
                                if i == 1 and j in [0,1]:
                                    self.assertTrue(np.all(symm[:74] == 0))
                                if i == 1 and j == 2:
                                    # For the third case, the 'symm' template gets
                                    # "patched" with the parent's value
                                    self.assertTrue(np.all((symm == parent1d)[:74]))
                    
                                if i == 1 and j == 0:
                                    # No edge handling: mono template == 0
                                    self.assertTrue(np.all(mono[:74] == 0))
                                if i == 1 and j == 1:
                                    # ramp by psf: zero up to ~65, ramps up
                                    self.assertTrue(np.all(mono[:64] == 0))
                                    self.assertTrue(np.any(mono[65:74] > 0))
                                    self.assertTrue(np.all(np.diff(mono)[60:80] >= 0.))
                                if i == 1 and j == 2:
                                    # no edge clipping: profile is monotonic and positive.
                                    self.assertTrue(np.all(np.diff(mono)[:85] >= 0.))
                                    self.assertTrue(np.all(mono[:85] > 0.))
                
                
                            if not doPlot:
                                continue
                
                            plt.clf()
                            p1 = plt.plot(parent1d, 'b-', lw=3, alpha=0.5)
                            for i,(symm,mono) in enumerate(zip(symm1ds, mono1ds)):
                                p2 = plt.plot(symm, 'r-', lw=2, alpha=0.7)
                                p3 = plt.plot(mono, 'g-')
                            plt.legend((p1[0],p2[0],p3[0]), ('Parent','Symm template', 'Mono template'),
                                       loc='upper left')
                            plt.title('1-d slice: %s' % tt)
                            fn = plotpat % (2*j+0)
                            plt.savefig(fn)
                            print 'Wrote', fn
                            
                            def myimshow(*args, **kwargs):
                                x0,x1,y0,y1 = imExt(afwimg)
                                plt.fill([x0,x0,x1,x1,x0],[y0,y1,y1,y0,y0], color=(1,1,0.8),
                                         zorder=20)
                                plt.imshow(*args, zorder=25, **kwargs)
                                plt.xticks([]); plt.yticks([])
                                plt.axis(imExt(afwimg))
                    
                            plt.clf()
                    
                            pa = dict(color='m', marker='.', linestyle='None', zorder=30)
                            
                            R,C = 3,6
                            plt.subplot(R, C, (2*C) + 1)
                            myimshow(img, **ima)
                            ax = plt.axis()
                            plt.plot(X, Y, **pa)
                            plt.axis(ax)
                            plt.title('Image')
                    
                            plt.subplot(R, C, (2*C) + 2)
                            myimshow(parent_img.getArray(), **ima)
                            ax = plt.axis()
                            plt.plot(PX, PY, **pa)
                            plt.axis(ax)
                            plt.title('Footprint')
                    
                            sumimg = None
                            for i,dpk in enumerate(deb.peaks):
                    
                                plt.subplot(R, C, i*C + 1)
                                myimshow(blobimgs[i], **ima)
                                ax = plt.axis()
                                plt.plot(PX[i], PY[i], **pa)
                                plt.axis(ax)
                                plt.title('true')
                    
                                plt.subplot(R, C, i*C + 2)
                                t = dpk.origTemplate
                                myimshow(t.getArray(), extent=imExt(t), **ima)
                                ax = plt.axis()
                                plt.plot(PX[i], PY[i], **pa)
                                plt.axis(ax)
                                plt.title('symm')
                    
                                # monotonic template
                                mimg = afwImage.ImageF(fpbb)
                                afwDet.copyWithinFootprintImage(dpk.templateFootprint,
                                                                dpk.templateMaskedImage.getImage(), mimg)
                    
                                plt.subplot(R, C, i*C + 3)
                                myimshow(mimg.getArray(), extent=imExt(mimg), **ima)
                                ax = plt.axis()
                                plt.plot(PX[i], PY[i], **pa)
                                plt.axis(ax)
                                plt.title('monotonic')
                    
                                plt.subplot(R, C, i*C + 4)
                                port = dpk.fluxPortion.getImage()
                                myimshow(port.getArray(), extent=imExt(port), **ima)
                                plt.title('portion')
                                ax = plt.axis()
                                plt.plot(PX[i], PY[i], **pa)
                                plt.axis(ax)
                    
                                if dpk.strayFlux is not None:
                                    simg = afwImage.ImageF(fpbb)
                                    dpk.strayFlux.insert(simg)
                                
                                    plt.subplot(R, C, i*C + 5)
                                    myimshow(simg.getArray(), **ima)
                                    plt.title('stray')
                                    ax = plt.axis()
                                    plt.plot(PX, PY, **pa)
                                    plt.axis(ax)
                    
                                himg2 = afwImage.ImageF(fpbb)
                                portion = dpk.getFluxPortion()
                                portion.insert(himg2)
                    
                                if sumimg is None:
                                    sumimg = himg2.getArray().copy()
                                else:
                                    sumimg += himg2.getArray()
                                    
                                plt.subplot(R, C, i*C + 6)
                                myimshow(himg2.getArray(), **ima)
                                plt.title('portion+stray')
                                ax = plt.axis()
                                plt.plot(PX, PY, **pa)
                                plt.axis(ax)
                    
                            plt.subplot(R, C, (2*C) + C)
                            myimshow(sumimg, **ima)
                            ax = plt.axis()
                            plt.plot(X, Y, **pa)
                            plt.axis(ax)
                            plt.title('Sum of deblends')
                    
                            plt.suptitle(tt)
                            fn = plotpat % (2*j + 1)
                            plt.savefig(fn)
                            print 'Wrote', fn
                
                
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    utilsTests.init()
                    suites = []
                    suites += unittest.makeSuite(RampEdgeTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                 
                if __name__ == "__main__":
                    run(True)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_deblender/</h2>
<h3><a name="4a143c5e"/></a>4a143c5e</h3>

<pre>
commit 4a143c5efc9a8861ac48822ac17b23d91c7b9c70
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Jun 14 11:53:54 2013 -0400

    move edge-handling code to examples/, since there were no actual tests
</pre>
<h3><a name="005add45"/></a>005add45</h3>

<pre>
commit 005add45db79d65b6ba109c74ca00611691c1fc8
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 8 12:52:20 2014 -0600

    make examples/edges.py into a test case for the edge-ramping code
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_deblender/</h2>
<h3><a name="5ea010ad"/></a>5ea010ad</h3>

<pre>
commit 5ea010ad910172374a013f98063a0dafc1d15862
Author: Russell Owen <rowen@uw.edu>
Date:   Fri Sep 12 08:17:57 2014 -0700

    Remove explicit origin=PARENT; use default
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<script type="text/javascript">
self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{};var Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var s={};for(var o in i)if(i.hasOwnProperty(o)){if(o==n)for(var l in a)a.hasOwnProperty(l)&&(s[l]=a[l]);s[o]=i[o]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=s)}),r[e]=s},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,s,o=a;o&&!e.test(o.className);)o=o.parentNode;if(o&&(l=(o.className.match(e)||[,""])[1],s=t.languages[l]),s){a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=a.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent;if(u){u=u.replace(/^(?:\r?\n|\r)/,"");var g={element:a,language:l,grammar:s,code:u};if(t.hooks.run("before-highlight",g),r&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){g.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(g.element),t.hooks.run("after-highlight",g)},c.postMessage(JSON.stringify({language:g.language,code:g.code}))}else g.highlightedCode=t.highlight(g.code,g.grammar,g.language),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",g)}}},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var s=n[l];s="Array"===t.util.type(s)?s:[s];for(var o=0;o<s.length;++o){var u=s[o],g=u.inside,c=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){c&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,g?t.tokenize(m,g):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener?(self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),self.close()},!1),self.Prism):self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
</body>

</html>
