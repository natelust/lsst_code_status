<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>meas_astrom</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', monospace;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>
</head>
<body>
<h1 id="toc_0">Comparison of the meas_astrom repository</h1>

<div style="background-color:Aquamarine; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Summary of Repositories</h1>
<p>
Comparison run at 02:19PM on June 09, 2015<br>
There are <b>1329</b> differences between the two repositories<br><br>
Repository <b>/Users/nate/repos_hsc/meas_astrom/</b> <br> Revision <b>172bfe0ce29e64a2c1bfd301f0af6f19bc243c57</b><br> Branch <b>master</b><br>Last commit was on <b>2015-05-09 23:02:37 -0400</b><br><br>
Repository <b>/Users/nate/repos_lsst/meas_astrom/</b> <br> Revision <b>1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c</b><br> Branch <b>master</b><br>Last commit was on <b>2015-06-09 10:22:25 -0700</b><br><br>
</p>
</div>

<hr>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_hsc/meas_astrom/</h1>
<h2>python/lsst/meas/photocal/colorterms.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/gd66.xy.txt</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>python/lsst/meas/astrom/astrom.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>python/lsst/meas/photocal/__init__.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>bin/andCache.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>examples/v695833-e0-c000-a00.sci.fits</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>python/lsst/meas/astrom/multiindex.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/testGetRefSources.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/colorterm.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/gd66.fits</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>examples/example.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>examples/v695833-e0-c000.xy.fits</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/testRefRaDec.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>python/lsst/meas/photocal/PhotoCal.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/noTag.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/testPhotoCal.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>python/lsst/meas/astrom/config.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/g117.xy.txt</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/testFilterName.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
<h2>tests/testCreateWcsWithSip.py</h2>
<pre>
commit 172bfe0ce29e64a2c1bfd301f0af6f19bc243c57
Author: Paul Price <price@astro.princeton.edu>
Date:   Sat May 9 23:02:37 2015 -0400

    tests: adapt to changes in photocal flags from HSC-1244
    
    PhotoCalConfig.outputField was replaced with candidateSourceField
    and usedSourceField.</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
<h1>Files only in /Users/nate/repos_lsst/meas_astrom/</h1>
<h2>python/lsst/meas/astrom/astromLib.i</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>doc/mainpage.dox</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/matchOptimisticB.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testFitTanSipWcsHighOrder.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testMatchOptimisticB.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/loadAstrometryNetObjects.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testAstrometryTask.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testLoadAstrometryNetObjects.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>src/matchOptimisticB.cc</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/anetAstrometry.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>include/lsst/meas/astrom.h</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/astrometry.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>include/lsst/meas/astrom/matchOptimisticB.h</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/astrometryNetDataConfig.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/display.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/v695833-e0-c000.xy.fits</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testFitTanSipWcsTask.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/v695833-e0-c000-a00.sci.fits</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/setMatchDistance.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/anetBasicAstrometry.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>python/lsst/meas/astrom/fitTanSipWcs.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
<h2>tests/testSetMatchDistance.py</h2>
<pre>
commit 1324b5d523f2ee6d8b867c22d0a3774cce2bbe4c
Merge: b5b19f3 a5a41de
Author: Joshua Hoblitt <jhoblitt@cpan.org>
Date:   Tue Jun 9 10:22:25 2015 -0700

    Merge pull request #11 from lsst/tickets/DM-2636
    
    Tickets/dm 2636</pre>
</div>

<h1 id="toc_1">List of the files in common<a name="homelist"></a></h1>

<p>Files without links do not differ</p>

<ul>
<li><code>tests/imgCharSources-v85501867-R01-S00.xy</code></li>
<li><a href="#doc/doxygen.conf.in"><code>doc/doxygen.conf.in</code></a></li>
<li><code>tests/astrometry_net_data/photocal/index-photocal-test.fits</code></li>
<li><a href="#python/lsst/meas/astrom/SConscript"><code>python/lsst/meas/astrom/SConscript</code></a></li>
<li><code>examples/plotshift.py</code></li>
<li><a href="#python/lsst/meas/astrom/utils.cc"><code>python/lsst/meas/astrom/utils.cc</code></a></li>
<li><a href="#ups/meas_astrom.table"><code>ups/meas_astrom.table</code></a></li>
<li><a href="#tests/testSipTransformations.py"><code>tests/testSipTransformations.py</code></a></li>
<li><code>tests/astrometry_net_data/photocal/mindex-photocal-test-4.fits</code></li>
<li><a href="#tests/testMultiIndex.py"><code>tests/testMultiIndex.py</code></a></li>
<li><code>tests/cat.xy.list</code></li>
<li><code>tests/imgCharSources-v85501867-R01-S00.wcs</code></li>
<li><a href="#.gitignore"><code>.gitignore</code></a></li>
<li><code>SConstruct</code></li>
<li><code>examples/SConscript</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/templ-D3.index.fits</code></li>
<li><code>tests/SConscript</code></li>
<li><code>examples/t2710.wcs</code></li>
<li><code>tests/astrometry_net_data/no-tag/index-photocal-notag.fits</code></li>
<li><a href="#tests/SourceMatchJoin.py"><code>tests/SourceMatchJoin.py</code></a></li>
<li><code>examples/solvestats.py</code></li>
<li><a href="#python/lsst/meas/astrom/sip/cleanBadPoints.py"><code>python/lsst/meas/astrom/sip/cleanBadPoints.py</code></a></li>
<li><code>tests/astrometry_net_data/cfhttemplate/ups/astrometry_net_data.table</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/templ-D1.index.fits</code></li>
<li><a href="#tests/lsf1d.py"><code>tests/lsf1d.py</code></a></li>
<li><code>tests/astrometry_net_data/photocal/andConfig3.py</code></li>
<li><code>examples/rerun-wcs.py</code></li>
<li><code>tests/cfht.xy.txt</code></li>
<li><a href="#examples/queryReferenceCatalog.py"><code>examples/queryReferenceCatalog.py</code></a></li>
<li><code>convertToFitsTable.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/templ-D4.index.fits</code></li>
<li><code>tests/astrometry_net_data/photocal/andConfigOpenFiles.py</code></li>
<li><a href="#tests/createWcsWithSip.py"><code>tests/createWcsWithSip.py</code></a></li>
<li><a href="#python/lsst/meas/astrom/catalogStarSelector.py"><code>python/lsst/meas/astrom/catalogStarSelector.py</code></a></li>
<li><a href="#include/lsst/meas/astrom/sip/LeastSqFitter2d.h"><code>include/lsst/meas/astrom/sip/LeastSqFitter2d.h</code></a></li>
<li><code>examples/imsimRerunWcs.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/templ-D2.index.fits</code></li>
<li><code>tests/imgCharSources-v85501867-R01-S00.tanheader</code></li>
<li><code>tests/testlsf2d.cc</code></li>
<li><code>examples/lsstplots.py</code></li>
<li><a href="#examples/imsimUtils.py"><code>examples/imsimUtils.py</code></a></li>
<li><code>include/lsst/meas/astrom/sip/MatchSrcToCatalogue.h</code></li>
<li><code>examples/astrometry_net_data/ticket2710/andConfig.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/D1.index</code></li>
<li><a href="#src/sip/MatchSrcToCatalogue.cc"><code>src/sip/MatchSrcToCatalogue.cc</code></a></li>
<li><a href="#tests/openFiles.py"><code>tests/openFiles.py</code></a></li>
<li><code>tests/imgCharSources-v85501867-R01-S00.sipheader</code></li>
<li><a href="#python/lsst/meas/astrom/__init__.py"><code>python/lsst/meas/astrom/__init__.py</code></a></li>
<li><code>python/lsst/meas/astrom/sip/sipLib.i</code></li>
<li><a href="#tests/cat.xy.fits"><code>tests/cat.xy.fits</code></a></li>
<li><code>include/lsst/meas/astrom/sip/CreateWcsWithSip.h</code></li>
<li><a href="#examples/rerun_wcs.py"><code>examples/rerun_wcs.py</code></a></li>
<li><code>python/lsst/meas/astrom/sip/genDistortedImage.py</code></li>
<li><a href="#include/lsst/meas/astrom/detail/utils.h"><code>include/lsst/meas/astrom/detail/utils.h</code></a></li>
<li><code>python/lsst/meas/astrom/sip/sourceMatchStatistics.py</code></li>
<li><code>python/lsst/meas/__init__.py</code></li>
<li><code>examples/sourceset_boost_to_fits.py</code></li>
<li><code>doc/SConscript</code></li>
<li><code>tests/astrometry_net_data/photocal/index-photocal-test-stars.fits</code></li>
<li><code>tests/astrometry_net_data/photocal/mindex-photocal-test.fits</code></li>
<li><code>tests/astrometry_net_data/photocal/andConfig5.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/andConfig.py</code></li>
<li><a href="#include/lsst/meas/astrom/sip/LeastSqFitter1d.h"><code>include/lsst/meas/astrom/sip/LeastSqFitter1d.h</code></a></li>
<li><a href="#tests/ticket1979.py"><code>tests/ticket1979.py</code></a></li>
<li><code>tests/astrometry_net_data/photocal/andConfig4.py</code></li>
<li><code>tests/astrometry_net_data/photocal/andConfig6.py</code></li>
<li><code>python/lsst/meas/astrom/sip/SConscript</code></li>
<li><a href="#examples/getSourceSet.py"><code>examples/getSourceSet.py</code></a></li>
<li><code>examples/imsimPlots.py</code></li>
<li><code>python/lsst/meas/astrom/sip/__init__.py</code></li>
<li><a href="#python/lsst/meas/astrom/astrometry_net.i"><code>python/lsst/meas/astrom/astrometry_net.i</code></a></li>
<li><code>tests/astrometry_net_data/photocal/index-photocal-test-4.fits</code></li>
<li><code>tests/testlsf1d.cc</code></li>
<li><code>tests/astrometry_net_data/photocal/ups/astrometry_net_data.table</code></li>
<li><code>examples/wcsPlots.py</code></li>
<li><code>tests/astrometry_net_data/no-tag/andConfig.py</code></li>
<li><a href="#examples/ticket2710.py"><code>examples/ticket2710.py</code></a></li>
<li><a href="#src/sip/CreateWcsWithSip.cc"><code>src/sip/CreateWcsWithSip.cc</code></a></li>
<li><code>policy/WcsDeterminationDictionary.paf</code></li>
<li><code>tests/imgCharSources-v85501867-R01-S00.rdls</code></li>
<li><code>python/lsst/__init__.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/README</code></li>
<li><code>lib/SConscript</code></li>
<li><code>examples/astrometry_net_data/ticket2710/index-130120002-b.fits</code></li>
<li><code>ups/meas_astrom.build</code></li>
<li><code>tests/astrometry_net_data/photocal/andConfig.py</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/templD14.index.fits</code></li>
<li><code>tests/astrometry_net_data/cfhttemplate/metadata.paf</code></li>
<li><code>python/lsst/meas/astrom/verifyWcs.py</code></li>
<li><code>tests/cfht.wcs</code></li>
<li><code>examples/xy2710.fits</code></li>
<li><code>tests/astrometry_net_data/photocal/andConfig2.py</code></li>
<li><code>tests/fpobjc-0745-3-0564-cut.fits</code></li>
<li><code>.gitattributes</code></li>
<li><a href="#tests/lsf2d.py"><code>tests/lsf2d.py</code></a></li>
<li><code>tests/astrometry_net_data/photocal/README</code></li>
<li><a href="#ups/meas_astrom.cfg"><code>ups/meas_astrom.cfg</code></a></li>
</ul>

<h1 id="toc_2"><a name="python/lsst/meas/astrom/SConscript"/></a>python/lsst/meas/astrom/SConscript</h1>

<h3 id="toc_3">Diff:</h3>

<pre>
                # -*- python -*-
                from lsst.sconsUtils import scripts
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#22f92e11">22f92e11</a> - scripts.BasicSConscript.python(['astrometry_net'],</div>
              ?                                 ^              ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#eb937b8d">eb937b8d</a> + scripts.BasicSConscript.python(["astromLib", "astrometry_net"],</div>
              ?                                 ^^^^^^^^^^^^^^              ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#22f92e11">22f92e11</a> -                                 swigSrc={"astrometry_net": ["utils.cc"]})</div>
              ? ----------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#eb937b8d">eb937b8d</a> +     swigSrc={"astrometry_net": ["utils.cc"]})</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
5    <a href="#edbd52c2">edbd52c2</a> - </div>
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="22f92e11"/></a>22f92e11</h3>

<pre>
commit 22f92e118c532d1c1fa29d77660b79c4185fad1f
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 09:42:19 2012 -0400

    Restructure things to move getCatalogImpl out of the .i file
</pre>
<h3><a name="edbd52c2"/></a>edbd52c2</h3>

<pre>
commit edbd52c213eb73412dbd69c7f2bc9f95eddb6a67
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jan 16 15:02:13 2012 -0500

    can we eliminate GlobalAstrometrySolution.{h,cc} by calling Astrometry.net code direct from python?
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_4"><a name="python/lsst/meas/astrom/utils.cc"/></a>python/lsst/meas/astrom/utils.cc</h1>

<h3 id="toc_5">Diff:</h3>

<pre>
                // -*- lsst-C++ -*-
                // Astrometry.net include files:
                extern "C" {
                #include "astrometry/solver.h"
                #include "astrometry/index.h"
                #include "astrometry/starkd.h"
                #include "astrometry/fitsioutils.h"
                #include "astrometry/fitstable.h"
                
                #undef ATTRIB_FORMAT
                #undef FALSE
                #undef TRUE
                }
                
                #include <set>
                #include "boost/cstdint.hpp"
                #include "boost/format.hpp"
                
                #include "lsst/meas/astrom/detail/utils.h"
                #include "lsst/base.h"
                #include "lsst/pex/exceptions.h"
                #include "lsst/afw/table/Source.h"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
23   <a href="#eb937b8d">eb937b8d</a> + #include "lsst/afw/image/Calib.h"</div>
                #pragma clang diagnostic push
                #pragma clang diagnostic ignored "-Wunused-variable"
                #include "lsst/afw/geom/Angle.h"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#eb937b8d">eb937b8d</a> + #include "lsst/afw/geom/Point.h"</div>
                #pragma clang diagnostic pop
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#22f92e11">22f92e11</a> - namespace afwCoord = lsst::afw::coord;</div>
                namespace afwTable = lsst::afw::table;
                namespace afwGeom  = lsst::afw::geom;
                
                namespace lsst {
                namespace meas {
                namespace astrom {
                namespace detail {
                
                static float *
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#aa1c9e8f">aa1c9e8f</a> - read_column(fitstable_t* tag,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#eb937b8d">eb937b8d</a> + read_column(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#eb937b8d">eb937b8d</a> +     fitstable_t* tag,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#aa1c9e8f">aa1c9e8f</a> -             char const *colName,</div>
              ? --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#eb937b8d">eb937b8d</a> +     char const *colName,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#aa1c9e8f">aa1c9e8f</a> -             tfits_type type,</div>
              ? --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#eb937b8d">eb937b8d</a> +     tfits_type type,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#aa1c9e8f">aa1c9e8f</a> -             int *starinds,</div>
              ? --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#eb937b8d">eb937b8d</a> +     int *starinds,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#aa1c9e8f">aa1c9e8f</a> -             int nstars,</div>
              ? --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#eb937b8d">eb937b8d</a> +     int nstars,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#aa1c9e8f">aa1c9e8f</a> -             char const *indexName)</div>
              ? --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#eb937b8d">eb937b8d</a> +     char const *indexName)</div>
                {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#aa1c9e8f">aa1c9e8f</a> -     float *col =</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#aa1c9e8f">aa1c9e8f</a> -         static_cast<float*>(fitstable_read_column_inds(tag, colName, type, starinds, nstars));</div>
              ?     ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#eb937b8d">eb937b8d</a> +     float *col = static_cast<float*>(fitstable_read_column_inds(tag, colName, type, starinds, nstars));</div>
              ?     ^^^^^^^^^^^^
                    if (!col) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#aa1c9e8f">aa1c9e8f</a> -         throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundException,</div>
              ?                                                           ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundError,</div>
              ?                                                           ^^ ^
                                          str(boost::format("Unable to read data for %s from %s") % colName % indexName));
                    }
                
                    return col;
                }
                
                    
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#22f92e11">22f92e11</a> - /*</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#82b8e761">82b8e761</a> -  * Implementation for index_t::getCatalog method</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#22f92e11">22f92e11</a> -  */</div>
                afwTable::SimpleCatalog
                getCatalogImpl(std::vector<index_t*> inds,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#9e8b4e03">9e8b4e03</a> -                double ra, double dec, double radius,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#eb937b8d">eb937b8d</a> +     lsst::afw::coord::Coord const &ctrCoord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#eb937b8d">eb937b8d</a> +     lsst::afw::geom::Angle const &radius,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#9e8b4e03">9e8b4e03</a> -                char const* idcol,</div>
              ? -----------                  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#eb937b8d">eb937b8d</a> +     char const* idCol,</div>
              ?                   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#753b5513">753b5513</a> -                std::vector<mag_column_t> const& magcols,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#9e8b4e03">9e8b4e03</a> -                char const* stargalcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#9e8b4e03">9e8b4e03</a> -                char const* varcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#9e8b4e03">9e8b4e03</a> -                bool unique_ids)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#eb937b8d">eb937b8d</a> +     std::vector<MagColInfo> const& magColInfoList,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#eb937b8d">eb937b8d</a> +     char const* isStarCol,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#eb937b8d">eb937b8d</a> +     char const* isVarCol,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#27598add">27598add</a> +     bool uniqueIds)</div>
                {
                    /*
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#22f92e11">22f92e11</a> -      If unique_ids == true: return only reference sources with unique IDs;</div>
              ?               ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#eb937b8d">eb937b8d</a> +      If uniqueIds == true: return only reference sources with unique IDs;</div>
              ?               ^
                     arbitrarily keep the first star found with each ID.
                     */
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#753b5513">753b5513</a> -     size_t const nMag = magcols.size();   /* number of magnitude[error] columns */</div>
              ?                            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#eb937b8d">eb937b8d</a> +     size_t const nMag = magColInfoList.size();   /* number of magnitude[error] columns */</div>
              ?                            ^  ++++++ +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#753b5513">753b5513</a> -     std::vector<mag_column_t>::const_iterator mc;</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#753b5513">753b5513</a> -     for (mc = magcols.begin(); mc != magcols.end(); ++mc) {</div>
              ?                  ^                      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#eb937b8d">eb937b8d</a> +     for (auto mc = magColInfoList.cbegin(); mc != magColInfoList.cend(); ++mc) {</div>
              ?          +++++        ^  ++++++ + +                  ^  ++++++ + +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#753b5513">753b5513</a> -         if (mc->name.size() == 0) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#eb937b8d">eb937b8d</a> +         if (mc->filterName.empty()) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#753b5513">753b5513</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterException,</div>
              ?                                                                       ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#3896b32c">3896b32c</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterError,</div>
              ?                                                                       ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#753b5513">753b5513</a> -                               "Magnitude names cannot be empty strings.");</div>
              ? --------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#eb937b8d">eb937b8d</a> +                 "Magnitude names cannot be empty strings.");</div>
                        }
                        // We enforce this condition because we convert the mags to fluxes, and
                        // we need a flux to compute a flux error!
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#753b5513">753b5513</a> -         if (mc->magcol.size() == 0) {</div>
              ?                    ^   ---   -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#eb937b8d">eb937b8d</a> +         if (mc->magCol.empty()) {</div>
              ?                    ^    ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#753b5513">753b5513</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterException,</div>
              ?                                                                       ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#3896b32c">3896b32c</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterError,</div>
              ?                                                                       ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#753b5513">753b5513</a> -                               "Magnitude column names cannot be empty string.");</div>
              ? --------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#eb937b8d">eb937b8d</a> +                 "Magnitude column names cannot be empty strings.");</div>
              ?                                                               +
                        }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#753b5513">753b5513</a> -         //printf("mag col \"%s\", \"%s\", \"%s\"\n", mc->name.c_str(), mc->magcol.c_str(), mc->magerrcol.c_str());</div>
              ?                                                          ^                    ^                   ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#eb937b8d">eb937b8d</a> +         //printf("mag col \"%s\", \"%s\", \"%s\"\n", mc->filterName.c_str(), mc->magCol.c_str(), mc->magErrCol.c_str());</div>
              ?                                                          ^^^^^^^                    ^                   ^  ^
                    }
                    
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#eb937b8d">eb937b8d</a> +     auto icrsCoord = ctrCoord.toIcrs();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#eb937b8d">eb937b8d</a> +     double raDeg = icrsCoord.getLongitude().asDegrees();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#eb937b8d">eb937b8d</a> +     double decDeg = icrsCoord.getLatitude().asDegrees();</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#22f92e11">22f92e11</a> -    double xyz[3];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#eb937b8d">eb937b8d</a> +     double xyz[3];</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#22f92e11">22f92e11</a> -    radecdeg2xyzarr(ra, dec, xyz);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#eb937b8d">eb937b8d</a> +     radecdeg2xyzarr(raDeg, decDeg, xyz);</div>
              ? +                     +++     +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#22f92e11">22f92e11</a> -    double r2 = deg2distsq(radius);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#eb937b8d">eb937b8d</a> +     double r2 = deg2distsq(radius.asDegrees());</div>
              ? +                                ++++++++++++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#22f92e11">22f92e11</a> -    afwTable::Schema schema = afwTable::SimpleTable::makeMinimalSchema(); // contains ID, ra, dec.</div>
              ?                                                                                      ^^^^ --- ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#eb937b8d">eb937b8d</a> +     afwTable::Schema schema = afwTable::SimpleTable::makeMinimalSchema(); // contains id and coord</div>
              ? +                                                                                     ^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#eb937b8d">eb937b8d</a> +     schema.addField<afwTable::Point<double>>("centroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#eb937b8d">eb937b8d</a> +         "centroid on some exposure; invalid unless \"hasCentroid\" is true)", "pixels");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#eb937b8d">eb937b8d</a> +     auto hasCentroidKey = schema.addField<afwTable::Flag>("hasCentroid",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#eb937b8d">eb937b8d</a> +         "true if centroid field has been set");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#9e8b4e03">9e8b4e03</a> -    std::vector<afwTable::Key<double> > fluxKey;    // these are double for consistency with measured fluxes;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#eb937b8d">eb937b8d</a> +     std::vector<afwTable::Key<double> > fluxKey;    // these are double for consistency with measured fluxes;</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#22f92e11">22f92e11</a> -    std::vector<afwTable::Key<double> > fluxErrKey; // may be unnecessary, but less surprising.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#eb937b8d">eb937b8d</a> +     std::vector<afwTable::Key<double> > fluxErrKey; // double may be unnecessary, but less surprising.</div>
              ? +                                                     +++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#753b5513">753b5513</a> -    fluxKey.reserve(nMag);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#eb937b8d">eb937b8d</a> +     fluxKey.reserve(nMag);</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#753b5513">753b5513</a> -    fluxErrKey.reserve(nMag);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#eb937b8d">eb937b8d</a> +     fluxErrKey.reserve(nMag);</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#753b5513">753b5513</a> -    </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#753b5513">753b5513</a> -    for (mc = magcols.begin(); mc != magcols.end(); ++mc) {</div>
              ?                 ^                      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#eb937b8d">eb937b8d</a> +     for (auto mc = magColInfoList.cbegin(); mc != magColInfoList.cend(); ++mc) {</div>
              ? +        +++++        ^  ++++++ + +                  ^  ++++++ + +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#753b5513">753b5513</a> -        // Add schema elements for each requested mag (and optionally mag error)</div>
              ?                                                  ^^^                 ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#eb937b8d">eb937b8d</a> +         // Add schema elements for each requested flux (and optionally flux error)</div>
              ? +                                                 ^^^^                 ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#753b5513">753b5513</a> -        // avoid the comment "flux flux"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#eb937b8d">eb937b8d</a> +         // avoid the comment "flux flux"</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#753b5513">753b5513</a> -        std::string comment = (mc->name == "flux" ? "flux" : mc->name + std::string(" flux"));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#753b5513">753b5513</a> -        fluxKey.push_back(schema.addField<double>(mc->name, comment));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#eb937b8d">eb937b8d</a> +         fluxKey.push_back(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#eb937b8d">eb937b8d</a> +             schema.addField<double>(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#27598add">27598add</a> +                 mc->filterName + "_flux",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#27598add">27598add</a> +                 mc->filterName + " flux"));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#753b5513">753b5513</a> -        if (mc->hasErr()) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#eb937b8d">eb937b8d</a> +         if (mc->hasErr()) {</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#753b5513">753b5513</a> -            std::string comment = (mc->name == "flux" ? "flux uncertainty" : mc->name + std::string(" flux uncertainty"));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#753b5513">753b5513</a> -            fluxErrKey.push_back(schema.addField<double>(mc->name + ".err", comment));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#eb937b8d">eb937b8d</a> +             fluxErrKey.push_back(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#eb937b8d">eb937b8d</a> +                 schema.addField<double>(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#27598add">27598add</a> +                     mc->filterName + "_fluxSigma",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#27598add">27598add</a> +                     mc->filterName + " flux uncertainty (sigma)"));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#753b5513">753b5513</a> -        }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#eb937b8d">eb937b8d</a> +         }</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#22f92e11">22f92e11</a> -    }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#eb937b8d">eb937b8d</a> +     }</div>
              ? +
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
111  <a href="#22f92e11">22f92e11</a> -    afwTable::Key<afwTable::Flag> stargalKey;</div>
              ?                                   ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#eb937b8d">eb937b8d</a> +     afwTable::Key<afwTable::Flag> resolvedKey;</div>
              ? +                                 ++ ^ +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
112  <a href="#22f92e11">22f92e11</a> -    if (stargalcol) {</div>
              ?            ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#eb937b8d">eb937b8d</a> +     if (isStarCol) {</div>
              ? +       + +   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#9e8b4e03">9e8b4e03</a> -        stargalKey = schema.addField<afwTable::Flag>(</div>
              ?         ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#eb937b8d">eb937b8d</a> +         resolvedKey = schema.addField<afwTable::Flag>(</div>
              ?        +++ ^ +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
114  <a href="#9e8b4e03">9e8b4e03</a> -                                                     "stargal", "set if the reference object is a star");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#27598add">27598add</a> +             "resolved",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#eb937b8d">eb937b8d</a> +             "set if the reference object is resolved");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#22f92e11">22f92e11</a> -    }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#eb937b8d">eb937b8d</a> +     }</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
116  <a href="#22f92e11">22f92e11</a> -    afwTable::Key<afwTable::Flag> varKey;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#eb937b8d">eb937b8d</a> +     afwTable::Key<afwTable::Flag> variableKey;</div>
              ? +                                    +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
117  <a href="#22f92e11">22f92e11</a> -    if (varcol) {</div>
              ?        ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#eb937b8d">eb937b8d</a> +     if (isVarCol) {</div>
              ? +       ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
118  <a href="#9e8b4e03">9e8b4e03</a> -        varKey = schema.addField<afwTable::Flag>("var", "set if the reference object is variable");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#eb937b8d">eb937b8d</a> +         variableKey = schema.addField<afwTable::Flag>(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#27598add">27598add</a> +             "variable",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
132  <a href="#eb937b8d">eb937b8d</a> +             "set if the reference object is variable");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
119  <a href="#22f92e11">22f92e11</a> -    }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#eb937b8d">eb937b8d</a> +     }</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#22f92e11">22f92e11</a> -    afwTable::Key<afwTable::Flag> photometricKey = schema.addField<afwTable::Flag>(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#eb937b8d">eb937b8d</a> +     afwTable::Key<afwTable::Flag> photometricKey = schema.addField<afwTable::Flag>(</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#22f92e11">22f92e11</a> -       "photometric", "set if the reference object can be used in photometric calibration"</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#22f92e11">22f92e11</a> -       );</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
135  <a href="#27598add">27598add</a> +         "photometric",</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#eb937b8d">eb937b8d</a> +         "set if the reference object can be used in photometric calibration");</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#a4fc1de8">a4fc1de8</a> -    afwTable::SimpleCatalog cat;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#eb937b8d">eb937b8d</a> +     afwTable::SimpleCatalog cat;</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#a4fc1de8">a4fc1de8</a> -    if (idcol) {</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#eb937b8d">eb937b8d</a> +     if (idCol) {</div>
              ? +         ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#a4fc1de8">a4fc1de8</a> -        // make catalog with no IdFactory, since IDs are external</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#eb937b8d">eb937b8d</a> +         // make catalog with no IdFactory, since IDs are external</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#a4fc1de8">a4fc1de8</a> -        cat = afwTable::SimpleCatalog(afwTable::SimpleTable::make(schema, PTR(afwTable::IdFactory)()));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#eb937b8d">eb937b8d</a> +         cat = afwTable::SimpleCatalog(afwTable::SimpleTable::make(schema, PTR(afwTable::IdFactory)()));</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#a4fc1de8">a4fc1de8</a> -    } else {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#eb937b8d">eb937b8d</a> +     } else {</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#a4fc1de8">a4fc1de8</a> -        // let the catalog assign IDs</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#eb937b8d">eb937b8d</a> +         // let the catalog assign IDs</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#a4fc1de8">a4fc1de8</a> -        cat = afwTable::SimpleCatalog(afwTable::SimpleTable::make(schema));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#eb937b8d">eb937b8d</a> +         cat = afwTable::SimpleCatalog(afwTable::SimpleTable::make(schema));</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#a4fc1de8">a4fc1de8</a> -    }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#eb937b8d">eb937b8d</a> +     }</div>
              ? +
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
133  <a href="#22f92e11">22f92e11</a> -    // for unique_ids: keep track of the IDs we have already added to the result set.</div>
              ?                 ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#eb937b8d">eb937b8d</a> +     // for uniqueIds: keep track of the IDs we have already added to the result set.</div>
              ? +                ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#22f92e11">22f92e11</a> -    std::set<boost::int64_t> uids;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#eb937b8d">eb937b8d</a> +     std::set<boost::int64_t> uids;</div>
              ? +
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#22f92e11">22f92e11</a> -    for (std::vector<index_t*>::iterator pind = inds.begin();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#eb937b8d">eb937b8d</a> +     for (std::vector<index_t*>::iterator pind = inds.begin(); pind != inds.end(); ++pind) {</div>
              ? +                                                            ++++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#9e8b4e03">9e8b4e03</a> -         pind != inds.end(); ++pind) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
138  <a href="#22f92e11">22f92e11</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#82b8e761">82b8e761</a> -        index_t* ind = (*pind);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#eb937b8d">eb937b8d</a> +         index_t* ind = (*pind);</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#22f92e11">22f92e11</a> -       // Find nearby stars</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#eb937b8d">eb937b8d</a> +         // Find nearby stars</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#22f92e11">22f92e11</a> -       double *radecs = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#eb937b8d">eb937b8d</a> +         double *radecs = NULL;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#22f92e11">22f92e11</a> -       int *starinds = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#eb937b8d">eb937b8d</a> +         int *starinds = NULL;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#22f92e11">22f92e11</a> -       int nstars = 0;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#eb937b8d">eb937b8d</a> +         int nstars = 0;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#82b8e761">82b8e761</a> -       startree_search_for(ind->starkd, xyz, r2, NULL,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#eb937b8d">eb937b8d</a> +         startree_search_for(ind->starkd, xyz, r2, NULL, &radecs, &starinds, &nstars);</div>
              ? ++                                                     ++++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#9e8b4e03">9e8b4e03</a> -                           &radecs, &starinds, &nstars);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#753b5513">753b5513</a> -       //printf("found %i in \"%s\"\n", nstars, ind->indexname);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#eb937b8d">eb937b8d</a> +         //printf("found %i in \"%s\"\n", nstars, ind->indexname);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
147  <a href="#c6797ad3">c6797ad3</a> -       if (nstars == 0) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#eb937b8d">eb937b8d</a> +         if (nstars == 0) {</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#c6797ad3">c6797ad3</a> -           continue;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#eb937b8d">eb937b8d</a> +             continue;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#c6797ad3">c6797ad3</a> -       }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#eb937b8d">eb937b8d</a> +         }</div>
              ? ++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#22f92e11">22f92e11</a> -       std::vector<float*> mag;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#eb937b8d">eb937b8d</a> +         std::vector<float*> mag;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#22f92e11">22f92e11</a> -       std::vector<float*> magerr;</div>
              ?                              ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
163  <a href="#eb937b8d">eb937b8d</a> +         std::vector<float*> magErr;</div>
              ? ++                             ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
153  <a href="#753b5513">753b5513</a> -       mag.reserve(nMag);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#eb937b8d">eb937b8d</a> +         mag.reserve(nMag);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#753b5513">753b5513</a> -       magerr.reserve(nMag);</div>
              ?          ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#eb937b8d">eb937b8d</a> +         magErr.reserve(nMag);</div>
              ? ++         ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#22f92e11">22f92e11</a> -       boost::int64_t* id = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#eb937b8d">eb937b8d</a> +         boost::int64_t* id = NULL;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#22f92e11">22f92e11</a> -       bool* stargal = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#eb937b8d">eb937b8d</a> +         bool* stargal = NULL;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
157  <a href="#22f92e11">22f92e11</a> -       bool* var = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#eb937b8d">eb937b8d</a> +         bool* var = NULL;</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#753b5513">753b5513</a> -       if (idcol || nMag || stargalcol || varcol) {</div>
              ?             ^                  ^^^^      ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#eb937b8d">eb937b8d</a> +         if (idCol || nMag || isStarCol || isVarCol) {</div>
              ? ++            ^              + +   ^      ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#82b8e761">82b8e761</a> -           fitstable_t* tag = startree_get_tagalong(ind->starkd);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#eb937b8d">eb937b8d</a> +             fitstable_t* tag = startree_get_tagalong(ind->starkd);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#9e8b4e03">9e8b4e03</a> -           tfits_type flt = fitscolumn_float_type();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#eb937b8d">eb937b8d</a> +             tfits_type flt = fitscolumn_float_type();</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
161  <a href="#9e8b4e03">9e8b4e03</a> -           tfits_type boo = fitscolumn_boolean_type();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
172  <a href="#eb937b8d">eb937b8d</a> +             tfits_type boo = fitscolumn_boolean_type();</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
162  <a href="#9e8b4e03">9e8b4e03</a> -           tfits_type i64 = fitscolumn_i64_type();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#eb937b8d">eb937b8d</a> +             tfits_type i64 = fitscolumn_i64_type();</div>
              ? ++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
164  <a href="#a4fc1de8">a4fc1de8</a> -          if (!tag) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#eb937b8d">eb937b8d</a> +             if (!tag) {</div>
              ? +++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#eb937b8d">eb937b8d</a> +                 std::string msg = boost::str(boost::format(</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
165  <a href="#a4fc1de8">a4fc1de8</a> -              std::string msg = boost::str(boost::format("astrometry_net_data index file %s does not contain a tag-along table, "</div>
              ?              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#eb937b8d">eb937b8d</a> +                     "astrometry_net_data index file %s does not contain a tag-along table, "</div>
              ?              ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
166  <a href="#a4fc1de8">a4fc1de8</a> -                                                         "so can't retrieve extra columns.  idcol=%s, stargalcol=%s, varcol=%s") %</div>
              ? ------------------------------------                                                         ^           ^^^^       ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#eb937b8d">eb937b8d</a> +                     "so can't retrieve extra columns.  idCol=%s, isStarCol=%s, isVarCol=%s") %</div>
              ?                                                          ^       + +   ^       ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#82b8e761">82b8e761</a> -                                           ind->indexname % idcol % stargalcol % varcol);</div>
              ? ----------------------                                       ^         ^^^^     ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#eb937b8d">eb937b8d</a> +                     ind->indexname % idCol % isStarCol % isVarCol);</div>
              ?                                        ^     + +   ^     ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
168  <a href="#a4fc1de8">a4fc1de8</a> -              msg += ", mag columns=[";</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
180  <a href="#eb937b8d">eb937b8d</a> +                  msg += ", mag columns=[";</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
169  <a href="#a4fc1de8">a4fc1de8</a> -              for (unsigned int i=0; i<nMag; i++) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#eb937b8d">eb937b8d</a> +                  for (unsigned int i=0; i<nMag; i++) {</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
170  <a href="#a4fc1de8">a4fc1de8</a> -                  if (i) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#eb937b8d">eb937b8d</a> +                      if (i) {</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#a4fc1de8">a4fc1de8</a> -                      msg += ",";</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#eb937b8d">eb937b8d</a> +                          msg += ",";</div>
              ? ++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#9e8b4e03">9e8b4e03</a> +                      }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#eb937b8d">eb937b8d</a> +                      msg += " name='" + magColInfoList[i].filterName +</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#eb937b8d">eb937b8d</a> +                          "', mag='" + magColInfoList[i].magCol +</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#eb937b8d">eb937b8d</a> +                          "', magErr='" + magColInfoList[i].magErrCol + "'";</div>
                                 }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
173  <a href="#a4fc1de8">a4fc1de8</a> -                  msg += " name='" + magcols[i].name +</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#a4fc1de8">a4fc1de8</a> -                      "', mag='" + magcols[i].magcol +</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#a4fc1de8">a4fc1de8</a> -                      "', magerr='" + magcols[i].magerrcol + "'";</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
176  <a href="#a4fc1de8">a4fc1de8</a> -              }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
177  <a href="#a4fc1de8">a4fc1de8</a> -              msg += " ].  You may need to edit the $ASTROMETRY_NET_DATA_DIR/andConfig.py file to set idColumn=None, etc.";</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#eb937b8d">eb937b8d</a> +                  msg += " ].  You may need to edit the $ASTROMETRY_NET_DATA_DIR/andConfig.py file to set idColumn=None, etc.";</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
178  <a href="#a4fc1de8">a4fc1de8</a> -              throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundException, msg);</div>
              ?                                                                ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#eb937b8d">eb937b8d</a> +                  throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundError, msg);</div>
              ? ++++                                                               ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
179  <a href="#a4fc1de8">a4fc1de8</a> -          }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#aa1c9e8f">aa1c9e8f</a> +             }</div>
              ? +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
181  <a href="#9e8b4e03">9e8b4e03</a> -          if (idcol) {</div>
              ?                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#eb937b8d">eb937b8d</a> +             if (idCol) {</div>
              ? +++               ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
182  <a href="#aa1c9e8f">aa1c9e8f</a> -              id = static_cast<int64_t*>(fitstable_read_column_inds(tag, idcol, i64, starinds, nstars));</div>
              ?                                                                           ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#eb937b8d">eb937b8d</a> +                 id = static_cast<int64_t*>(fitstable_read_column_inds(tag, idCol, i64, starinds, nstars));</div>
              ? +++                                                                          ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
183  <a href="#aa1c9e8f">aa1c9e8f</a> -              if (!id) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#eb937b8d">eb937b8d</a> +                 if (!id) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
184  <a href="#aa1c9e8f">aa1c9e8f</a> -                  throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundException,</div>
              ?                                                                    ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#eb937b8d">eb937b8d</a> +                     throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundError,</div>
              ? +++                                                                   ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
185  <a href="#aa1c9e8f">aa1c9e8f</a> -                                    str(boost::format("Unable to read data for %s from %s") %</div>
              ? -----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#eb937b8d">eb937b8d</a> +                         str(boost::format("Unable to read data for %s from %s") % idCol % ind->indexname));</div>
              ?                                                                                  ++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
186  <a href="#82b8e761">82b8e761</a> -                                        idcol % ind->indexname));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#aa1c9e8f">aa1c9e8f</a> -              }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#9e8b4e03">9e8b4e03</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
188  <a href="#aa1c9e8f">aa1c9e8f</a> -          }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#9e8b4e03">9e8b4e03</a> -          if (id && unique_ids) {</div>
              ?                          ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#eb937b8d">eb937b8d</a> +             if (id && uniqueIds) {</div>
              ? +++                         ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#9e8b4e03">9e8b4e03</a> -              // remove duplicate IDs.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#eb937b8d">eb937b8d</a> +                 // remove duplicate IDs.</div>
              ? +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#9e8b4e03">9e8b4e03</a> -              // FIXME -- this shouldn't be necessary once we get astrometry_net 0.40</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#eb937b8d">eb937b8d</a> +                 // FIXME -- this shouldn't be necessary once we get astrometry_net 0.40</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#9e8b4e03">9e8b4e03</a> -              // multi-index functionality in place.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#eb937b8d">eb937b8d</a> +                 // multi-index functionality in place.</div>
              ? +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#9e8b4e03">9e8b4e03</a> -              if (uids.empty()) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#eb937b8d">eb937b8d</a> +                 if (uids.empty()) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#9e8b4e03">9e8b4e03</a> -                  uids = std::set<boost::int64_t>(id, id+nstars);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#eb937b8d">eb937b8d</a> +                     uids = std::set<boost::int64_t>(id, id+nstars);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#9e8b4e03">9e8b4e03</a> -              } else {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#eb937b8d">eb937b8d</a> +                 } else {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#9e8b4e03">9e8b4e03</a> -                  int nkeep = 0;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#eb937b8d">eb937b8d</a> +                     int nkeep = 0;</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#9e8b4e03">9e8b4e03</a> -                  for (int i=0; i<nstars; i++) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#eb937b8d">eb937b8d</a> +                     for (int i=0; i<nstars; i++) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#9e8b4e03">9e8b4e03</a> -                      //std::pair<std::set<boost::int64_t>::iterator, bool> </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#eb937b8d">eb937b8d</a> +                         //std::pair<std::set<boost::int64_t>::iterator, bool> </div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#9e8b4e03">9e8b4e03</a> -                      if (uids.insert(id[i]).second) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#eb937b8d">eb937b8d</a> +                         if (uids.insert(id[i]).second) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#9e8b4e03">9e8b4e03</a> -                          // inserted; keep this one.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#eb937b8d">eb937b8d</a> +                             // inserted; keep this one.</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
203  <a href="#9e8b4e03">9e8b4e03</a> -                          if (nkeep != i) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#eb937b8d">eb937b8d</a> +                             if (nkeep != i) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
204  <a href="#9e8b4e03">9e8b4e03</a> -                              // compact the arrays.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#eb937b8d">eb937b8d</a> +                                 // compact the arrays.</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
205  <a href="#9e8b4e03">9e8b4e03</a> -                              starinds[nkeep] = starinds[i];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#eb937b8d">eb937b8d</a> +                                 starinds[nkeep] = starinds[i];</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
206  <a href="#9e8b4e03">9e8b4e03</a> -                              radecs[nkeep*2+0] = radecs[i*2+0];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#eb937b8d">eb937b8d</a> +                                 radecs[nkeep*2+0] = radecs[i*2+0];</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
207  <a href="#9e8b4e03">9e8b4e03</a> -                              radecs[nkeep*2+1] = radecs[i*2+1];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#eb937b8d">eb937b8d</a> +                                 radecs[nkeep*2+1] = radecs[i*2+1];</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
208  <a href="#9e8b4e03">9e8b4e03</a> -                              id[nkeep] = id[i];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#eb937b8d">eb937b8d</a> +                                 id[nkeep] = id[i];</div>
              ? +++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#eb937b8d">eb937b8d</a> +                             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#eb937b8d">eb937b8d</a> +                             nkeep++;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#eb937b8d">eb937b8d</a> +                         } else {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#eb937b8d">eb937b8d</a> +                             // did not insert (this id has already been found);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#eb937b8d">eb937b8d</a> +                             // drop this star.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
209  <a href="#9e8b4e03">9e8b4e03</a> -                          }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#eb937b8d">eb937b8d</a> +                         }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
210  <a href="#9e8b4e03">9e8b4e03</a> -                          nkeep++;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
211  <a href="#9e8b4e03">9e8b4e03</a> -                      } else {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
212  <a href="#9e8b4e03">9e8b4e03</a> -                          // did not insert (this id has already been found);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#9e8b4e03">9e8b4e03</a> -                          // drop this star.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#9e8b4e03">9e8b4e03</a> -                      }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
226  <a href="#eb937b8d">eb937b8d</a> +                     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#9e8b4e03">9e8b4e03</a> -                  }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#9e8b4e03">9e8b4e03</a> -                  nstars = nkeep;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#eb937b8d">eb937b8d</a> +                     nstars = nkeep;</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#9e8b4e03">9e8b4e03</a> -                  // if they were all duplicate IDs...</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#eb937b8d">eb937b8d</a> +                     // if they were all duplicate IDs...</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#9e8b4e03">9e8b4e03</a> -                  if (nstars == 0) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#eb937b8d">eb937b8d</a> +                     if (nstars == 0) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
219  <a href="#9e8b4e03">9e8b4e03</a> -                      free(starinds);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#eb937b8d">eb937b8d</a> +                         free(starinds);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
220  <a href="#9e8b4e03">9e8b4e03</a> -                      free(radecs);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#eb937b8d">eb937b8d</a> +                         free(radecs);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
221  <a href="#9e8b4e03">9e8b4e03</a> -                      free(id);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#eb937b8d">eb937b8d</a> +                         free(id);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
222  <a href="#9e8b4e03">9e8b4e03</a> -                      continue;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#eb937b8d">eb937b8d</a> +                         continue;</div>
              ? +++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#eb937b8d">eb937b8d</a> +                     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
223  <a href="#9e8b4e03">9e8b4e03</a> -                  }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
224  <a href="#9e8b4e03">9e8b4e03</a> -              }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#aa1c9e8f">aa1c9e8f</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
225  <a href="#9e8b4e03">9e8b4e03</a> -          }</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
227  <a href="#753b5513">753b5513</a> -          for (mc = magcols.begin(); mc != magcols.end(); ++mc) {</div>
              ?                       ^                      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#eb937b8d">eb937b8d</a> +             for (auto mc = magColInfoList.cbegin(); mc != magColInfoList.cend(); ++mc) {</div>
              ? +++              +++++        ^  ++++++ + +                  ^  ++++++ + +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
228  <a href="#753b5513">753b5513</a> -              char const* col = mc->magcol.c_str();</div>
              ?                                       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#eb937b8d">eb937b8d</a> +                 char const* col = mc->magCol.c_str();</div>
              ? +++                                      ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
229  <a href="#82b8e761">82b8e761</a> -              mag.push_back(read_column(tag, col, flt, starinds, nstars, ind->indexname));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#eb937b8d">eb937b8d</a> +                 mag.push_back(read_column(tag, col, flt, starinds, nstars, ind->indexname));</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
230  <a href="#753b5513">753b5513</a> -              if (mc->hasErr()) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#eb937b8d">eb937b8d</a> +                 if (mc->hasErr()) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
231  <a href="#753b5513">753b5513</a> -                  char const* col = mc->magerrcol.c_str();</div>
              ?                                           ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#eb937b8d">eb937b8d</a> +                     char const* col = mc->magErrCol.c_str();</div>
              ? +++                                          ^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
232  <a href="#82b8e761">82b8e761</a> -                  magerr.push_back(read_column(tag, col, flt, starinds, nstars, ind->indexname));</div>
              ?                     ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#eb937b8d">eb937b8d</a> +                     magErr.push_back(read_column(tag, col, flt, starinds, nstars, ind->indexname));</div>
              ? +++                    ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
233  <a href="#22f92e11">22f92e11</a> -              }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#eb937b8d">eb937b8d</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
234  <a href="#753b5513">753b5513</a> -          }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
235  <a href="#9e8b4e03">9e8b4e03</a> -          if (stargalcol) {</div>
              ?                  ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#eb937b8d">eb937b8d</a> +             if (isStarCol) {</div>
              ? +++             + +   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#9e8b4e03">9e8b4e03</a> -              /*  There is something weird going on with handling of bools; maybe "T" vs "F"?</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#eb937b8d">eb937b8d</a> +                 /*  There is something weird going on with handling of bools; maybe "T" vs "F"?</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#9e8b4e03">9e8b4e03</a> -                  stargal = static_cast<bool*>(fitstable_read_column_inds(tag, stargalcol, boo, starinds, nstars));</div>
              ? -                                                                                 ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#eb937b8d">eb937b8d</a> +                 stargal = static_cast<bool*>(fitstable_read_column_inds(tag, isStarCol, boo, starinds, nstars));</div>
              ?                                                                              + +   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#9e8b4e03">9e8b4e03</a> -                  for (int j=0; j<nstars; j++) {</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#eb937b8d">eb937b8d</a> +                 for (int j=0; j<nstars; j++) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#9e8b4e03">9e8b4e03</a> -                  printf("  sg %i = %i, vs %i\n", j, (int)sg[j], stargal[j] ? 1:0);</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#eb937b8d">eb937b8d</a> +                 printf("  sg %i = %i, vs %i\n", j, (int)sg[j], stargal[j] ? 1:0);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#9e8b4e03">9e8b4e03</a> -                  }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#9e8b4e03">9e8b4e03</a> -              */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#eb937b8d">eb937b8d</a> +                 */</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#9e8b4e03">9e8b4e03</a> -              uint8_t* sg = static_cast<uint8_t*>(fitstable_read_column_inds(tag, stargalcol, fitscolumn_u8_type(), starinds, nstars));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#eb937b8d">eb937b8d</a> +                 uint8_t* sg = static_cast<uint8_t*>(fitstable_read_column_inds(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#eb937b8d">eb937b8d</a> +                     tag, isStarCol, fitscolumn_u8_type(), starinds, nstars));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
243  <a href="#9e8b4e03">9e8b4e03</a> -              stargal = static_cast<bool*>(malloc(nstars));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#eb937b8d">eb937b8d</a> +                 stargal = static_cast<bool*>(malloc(nstars));</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
244  <a href="#aa1c9e8f">aa1c9e8f</a> -             if (!stargal) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#eb937b8d">eb937b8d</a> +                 if (!stargal) {</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
245  <a href="#aa1c9e8f">aa1c9e8f</a> -                 throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundException,</div>
              ?                                                                   ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#eb937b8d">eb937b8d</a> +                     throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundError,</div>
              ? ++++                                                                  ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#aa1c9e8f">aa1c9e8f</a> -                                   str(boost::format("Unable to read data for %s from %s") %</div>
              ? ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#eb937b8d">eb937b8d</a> +                         str(boost::format("Unable to read data for %s from %s") % isStarCol % ind->indexname));</div>
              ?                                                                                  ++++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#82b8e761">82b8e761</a> -                                       stargalcol % ind->indexname));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#aa1c9e8f">aa1c9e8f</a> -             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#9e8b4e03">9e8b4e03</a> -             for (int j=0; j<nstars; j++) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#eb937b8d">eb937b8d</a> +                 for (int j=0; j<nstars; j++) {</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#9e8b4e03">9e8b4e03</a> -                 stargal[j] = (sg[j] > 0);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#eb937b8d">eb937b8d</a> +                     stargal[j] = (sg[j] > 0);</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#9e8b4e03">9e8b4e03</a> -             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#9e8b4e03">9e8b4e03</a> -             free(sg);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#eb937b8d">eb937b8d</a> +                 free(sg);</div>
              ? ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#9e8b4e03">9e8b4e03</a> -          }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#eb937b8d">eb937b8d</a> +             }</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#9e8b4e03">9e8b4e03</a> -          if (varcol) {</div>
              ?              ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#eb937b8d">eb937b8d</a> +             if (isVarCol) {</div>
              ? +++             ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#9e8b4e03">9e8b4e03</a> -              var = static_cast<bool*>(fitstable_read_column_inds(tag, varcol, boo, starinds, nstars));</div>
              ?                                                                       ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#eb937b8d">eb937b8d</a> +                 var = static_cast<bool*>(fitstable_read_column_inds(tag, isVarCol, boo, starinds, nstars));</div>
              ? +++                                                                      ^^^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#9e8b4e03">9e8b4e03</a> -              if (!var) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#eb937b8d">eb937b8d</a> +                 if (!var) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#aa1c9e8f">aa1c9e8f</a> -                 throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundException,</div>
              ?                                                                   ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#eb937b8d">eb937b8d</a> +                     throw LSST_EXCEPT(lsst::pex::exceptions::NotFoundError,</div>
              ? ++++                                                                  ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#aa1c9e8f">aa1c9e8f</a> -                                   str(boost::format("Unable to read data for %s from %s") %</div>
              ? ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#eb937b8d">eb937b8d</a> +                         str(boost::format("Unable to read data for %s from %s") % isVarCol % ind->indexname));</div>
              ?                                                                                  +++++++++++++++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#82b8e761">82b8e761</a> -                                       varcol % ind->indexname));</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#aa1c9e8f">aa1c9e8f</a> -             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
              ? ++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#eb937b8d">eb937b8d</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#9e8b4e03">9e8b4e03</a> -          }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#eb937b8d">eb937b8d</a> +         }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#22f92e11">22f92e11</a> -       }</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#22f92e11">22f92e11</a> -       for (int i=0; i<nstars; i++) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#eb937b8d">eb937b8d</a> +         for (int i=0; i<nstars; i++) {</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#9e8b4e03">9e8b4e03</a> -           PTR(afwTable::SimpleRecord) src = cat.addNew();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#eb937b8d">eb937b8d</a> +             PTR(afwTable::SimpleRecord) src = cat.addNew();</div>
              ? ++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#9e8b4e03">9e8b4e03</a> -           // Note that all coords in afwTable catalogs are ICRS; hopefully that's what the </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#eb937b8d">eb937b8d</a> +             // Note that all coords in afwTable catalogs are ICRS; hopefully that's what the </div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#9e8b4e03">9e8b4e03</a> -           // reference catalogs are (and that's what the code assumed before JFB modified it).</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#eb937b8d">eb937b8d</a> +             // reference catalogs are (and that's what the code assumed before JFB modified it).</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#9e8b4e03">9e8b4e03</a> -           src->setCoord(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#eb937b8d">eb937b8d</a> +             src->setCoord(</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#9e8b4e03">9e8b4e03</a> -               afwCoord::IcrsCoord(</div>
              ?                  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#eb937b8d">eb937b8d</a> +                 lsst::afw::coord::IcrsCoord(</div>
              ?               ++++++++   ^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#9e8b4e03">9e8b4e03</a> -                   radecs[i * 2 + 0] * afwGeom::degrees,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#eb937b8d">eb937b8d</a> +                     radecs[i * 2 + 0] * afwGeom::degrees,</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#9e8b4e03">9e8b4e03</a> -                   radecs[i * 2 + 1] * afwGeom::degrees</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#eb937b8d">eb937b8d</a> +                     radecs[i * 2 + 1] * afwGeom::degrees</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#9e8b4e03">9e8b4e03</a> -               )</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#eb937b8d">eb937b8d</a> +                 )</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#9e8b4e03">9e8b4e03</a> -          );</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#eb937b8d">eb937b8d</a> +             );</div>
              ? +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#9e8b4e03">9e8b4e03</a> -           if (id) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#eb937b8d">eb937b8d</a> +             if (id) {</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#22f92e11">22f92e11</a> -              src->setId(id[i]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#eb937b8d">eb937b8d</a> +                 src->setId(id[i]);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#9e8b4e03">9e8b4e03</a> -           }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#eb937b8d">eb937b8d</a> +             }</div>
              ? ++
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#eb937b8d">eb937b8d</a> +             src->set(hasCentroidKey, false);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#753b5513">753b5513</a> -          assert(fluxKey.size() == nMag);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#eb937b8d">eb937b8d</a> +             assert(fluxKey.size() == nMag);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#753b5513">753b5513</a> -          // only non-empty error columns are populated in these vectors.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#eb937b8d">eb937b8d</a> +             // only non-empty error columns are populated in these vectors.</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#753b5513">753b5513</a> -          assert(fluxErrKey.size() == magerr.size());</div>
              ?                                         ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#eb937b8d">eb937b8d</a> +             assert(fluxErrKey.size() == magErr.size());</div>
              ? +++                                        ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#753b5513">753b5513</a> -          // index into non-empty error columns.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#eb937b8d">eb937b8d</a> +             // index into non-empty error columns.</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#753b5513">753b5513</a> -          size_t ej = 0;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#eb937b8d">eb937b8d</a> +             size_t ej = 0;</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#753b5513">753b5513</a> -          size_t j = 0;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#eb937b8d">eb937b8d</a> +             size_t j = 0;</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#753b5513">753b5513</a> -          for (mc = magcols.begin(); mc != magcols.end(); ++mc, ++j) {</div>
              ?                       ^                      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#eb937b8d">eb937b8d</a> +             for (auto mc = magColInfoList.cbegin(); mc != magColInfoList.cend(); ++mc, ++j) {</div>
              ? +++              +++++        ^  ++++++ + +                  ^  ++++++ + +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#eb937b8d">eb937b8d</a> +                 // There is some dispute about returning flux or magnitudes</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
300  <a href="#eb937b8d">eb937b8d</a> +                 // flux is not conventional, but is convenient for several reasons</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
301  <a href="#eb937b8d">eb937b8d</a> +                 // - it simplifies matching to sources for astrometric calibration</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#eb937b8d">eb937b8d</a> +                 // - flux errors are easier to combine than magnitude errors</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#753b5513">753b5513</a> -              // Dustin thinks converting to flux is 'LAME!';</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#753b5513">753b5513</a> -              // Jim thinks it's nice for consistency (and photocal wants fluxes</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#753b5513">753b5513</a> -              // as inputs, so we'll continue to go with that for now) even though</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#753b5513">753b5513</a> -              // we don't need to anymore.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#753b5513">753b5513</a> -              // Dustin rebuts that photocal immediately converts those fluxes into mags,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#753b5513">753b5513</a> -              // so :-P</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#753b5513">753b5513</a> -              //printf("mag %s = %g\n", mc->name.c_str(), mag[j][i]);</div>
              ?                                            ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#eb937b8d">eb937b8d</a> +                 //printf("mag %s = %g\n", mc->filterName.c_str(), mag[j][i]);</div>
              ? +++                                           ^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#753b5513">753b5513</a> -              double flux = pow(10.0, -0.4*mag[j][i]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#eb937b8d">eb937b8d</a> +                 double flux = lsst::afw::image::fluxFromABMag(mag[j][i]);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#753b5513">753b5513</a> -              //printf("flux %g\n", flux);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#eb937b8d">eb937b8d</a> +                 //printf("flux %g\n", flux);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#753b5513">753b5513</a> -              src->set(fluxKey[j], flux);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#eb937b8d">eb937b8d</a> +                 src->set(fluxKey[j], flux);</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#753b5513">753b5513</a> -              if (mc->hasErr()) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#eb937b8d">eb937b8d</a> +                 if (mc->hasErr()) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#753b5513">753b5513</a> -                  //printf("mag err = %g\n", magerr[ej][i]);</div>
              ?                                                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#eb937b8d">eb937b8d</a> +                     //printf("mag err = %g\n", magErr[ej][i]);</div>
              ? +++                                               ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#753b5513">753b5513</a> -                  double fluxerr = fabs(-0.4*magerr[ej][i]*flux*std::log(10.0));</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#eb937b8d">eb937b8d</a> +                     double fluxErr = lsst::afw::image::fluxErrFromABMagErr(magErr[ej][i], mag[j][i]);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
300  <a href="#753b5513">753b5513</a> -                  //printf("flux err = %g\n", fluxerr);</div>
              ?                                                  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#eb937b8d">eb937b8d</a> +                     //printf("flux err = %g\n", fluxErr);</div>
              ? +++                                                 ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
301  <a href="#753b5513">753b5513</a> -                  src->set(fluxErrKey[ej], fluxerr);</div>
              ?                                               ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#eb937b8d">eb937b8d</a> +                     src->set(fluxErrKey[ej], fluxErr);</div>
              ? +++                                              ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#753b5513">753b5513</a> -                  ej++;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#eb937b8d">eb937b8d</a> +                     ej++;</div>
              ? +++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#eb937b8d">eb937b8d</a> +                 }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#753b5513">753b5513</a> -              }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#eb937b8d">eb937b8d</a> +             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#753b5513">753b5513</a> -          }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#753b5513">753b5513</a> -          assert(ej == fluxErrKey.size());</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#eb937b8d">eb937b8d</a> +             assert(ej == fluxErrKey.size());</div>
              ? +++
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#9e8b4e03">9e8b4e03</a> -          bool ok = true;</div>
              ?                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#eb937b8d">eb937b8d</a> +             bool photometric = true;</div>
              ? +++              ++ ^^^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#9e8b4e03">9e8b4e03</a> -          if (stargal) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
318  <a href="#eb937b8d">eb937b8d</a> +             if (stargal) {</div>
              ? +++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#9e8b4e03">9e8b4e03</a> -              src->set(stargalKey, stargal[i]);</div>
              ?                        ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#27598add">27598add</a> +                 src->set(resolvedKey, !stargal[i]);</div>
              ? +++                      ++ ^ +++     +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#9e8b4e03">9e8b4e03</a> -              ok &= stargal[i];</div>
              ?               ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#eb937b8d">eb937b8d</a> +                 photometric &= stargal[i];</div>
              ?              +++++ ^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#eb937b8d">eb937b8d</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#eb937b8d">eb937b8d</a> +             if (var) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#eb937b8d">eb937b8d</a> +                 src->set(variableKey, var[i]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#eb937b8d">eb937b8d</a> +                 photometric &= (!var[i]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#eb937b8d">eb937b8d</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#eb937b8d">eb937b8d</a> +             src->set(photometricKey, photometric);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#9e8b4e03">9e8b4e03</a> -          }</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#eb937b8d">eb937b8d</a> +         }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#9e8b4e03">9e8b4e03</a> -          if (var) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#9e8b4e03">9e8b4e03</a> -              src->set(varKey, var[i]);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#9e8b4e03">9e8b4e03</a> -              ok &= (!var[i]);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
315  <a href="#9e8b4e03">9e8b4e03</a> -          }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
316  <a href="#9e8b4e03">9e8b4e03</a> -          src->set(photometricKey, ok);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
317  <a href="#22f92e11">22f92e11</a> -       }</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
319  <a href="#22f92e11">22f92e11</a> -       free(id);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#eb937b8d">eb937b8d</a> +         free(id);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
320  <a href="#753b5513">753b5513</a> -       for (size_t j=0; j<mag.size(); ++j) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#eb937b8d">eb937b8d</a> +         for (size_t j=0; j<mag.size(); ++j) {</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
321  <a href="#753b5513">753b5513</a> -           free(mag[j]);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#eb937b8d">eb937b8d</a> +             free(mag[j]);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
322  <a href="#753b5513">753b5513</a> -       }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
332  <a href="#eb937b8d">eb937b8d</a> +         }</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
323  <a href="#753b5513">753b5513</a> -       for (size_t j=0; j<magerr.size(); ++j) {</div>
              ?                             ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
333  <a href="#eb937b8d">eb937b8d</a> +         for (size_t j=0; j<magErr.size(); ++j) {</div>
              ? ++                            ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
324  <a href="#753b5513">753b5513</a> -           free(magerr[j]);</div>
              ?                   ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#eb937b8d">eb937b8d</a> +             free(magErr[j]);</div>
              ? ++                  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#22f92e11">22f92e11</a> -       }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#eb937b8d">eb937b8d</a> +         }</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#22f92e11">22f92e11</a> -       free(stargal);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
336  <a href="#eb937b8d">eb937b8d</a> +         free(stargal);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#22f92e11">22f92e11</a> -       free(var);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
337  <a href="#eb937b8d">eb937b8d</a> +         free(var);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#22f92e11">22f92e11</a> -       free(radecs);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
338  <a href="#eb937b8d">eb937b8d</a> +         free(radecs);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#22f92e11">22f92e11</a> -       free(starinds);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
339  <a href="#eb937b8d">eb937b8d</a> +         free(starinds);</div>
              ? ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#22f92e11">22f92e11</a> -    }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
340  <a href="#eb937b8d">eb937b8d</a> +     }</div>
              ? +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#22f92e11">22f92e11</a> -    return cat;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
341  <a href="#eb937b8d">eb937b8d</a> +     return cat;</div>
              ? +
                }
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#eb937b8d">eb937b8d</a> + </div>
                }}}}
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="753b5513"/></a>753b5513</h3>

<pre>
commit 753b5513d6a07c53a2ac2e431102eaa5e68fe1bc
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Sep 11 15:36:20 2012 -0400

    Add a test for the multi-mag reference source retrieval API.
    
    Clean up the way multi-mags are requested, and make the schema's names match the LSST-canonical filter names,
    rather than the Astrometry.net column names (which usually match, but only by convention)
</pre>
<h3><a name="c6797ad3"/></a>c6797ad3</h3>

<pre>
commit c6797ad3909ed0210ff88d7050ba129677e8b167
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu May 30 01:56:33 2013 +0900

    use RAII for index loading/closing (#2879)
    
    When loading indices (when solving, or just reading a catalog)
    one can quickly run out of open file descriptors if not careful.
    To ensure we don't, use an RAII object ("IndexManager") on the
    indices so that files are closed whenever they go out of scope
    (exception, looping, etc).
    
    This replaces the fix to addIndices from #2292 with a more
    complete solution, and applies it also to getCatalogImpl, which
    was discovered to have the same problem in #2879.
</pre>
<h3><a name="a4fc1de8"/></a>a4fc1de8</h3>

<pre>
commit a4fc1de8e1576f432cdf49dce2a24935dfc1860a
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Mar 13 13:55:30 2013 -0400

    Handle no ID column; produce nicer error message when no tag-along table is available
</pre>
<h3><a name="9e8b4e03"/></a>9e8b4e03</h3>

<pre>
commit 9e8b4e037273308dd79594753c4298079c2617d5
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Tue Aug 6 14:39:02 2013 +0900

    untabify 2 examples, utils.{cc,h} and *.i
</pre>
<h3><a name="aa1c9e8f"/></a>aa1c9e8f</h3>

<pre>
commit aa1c9e8f93a48160a1a194b5fffb640f3bbf9baa
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 11:02:38 2012 -0400

    Throw an exception rather than failing if an invalid column is requested
</pre>
<h3><a name="82b8e761"/></a>82b8e761</h3>

<pre>
commit 82b8e76170d0e6f87e137205b70c18a17c1353d4
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 16 11:02:13 2014 -0500

    Use multiindex unload/reload; python RAII
</pre>
<h3><a name="22f92e11"/></a>22f92e11</h3>

<pre>
commit 22f92e118c532d1c1fa29d77660b79c4185fad1f
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 09:42:19 2012 -0400

    Restructure things to move getCatalogImpl out of the .i file
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="aa1c9e8f"/></a>aa1c9e8f</h3>

<pre>
commit aa1c9e8f93a48160a1a194b5fffb640f3bbf9baa
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 11:02:38 2012 -0400

    Throw an exception rather than failing if an invalid column is requested
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
<h3><a name="27598add"/></a>27598add</h3>

<pre>
commit 27598addd6fafc95781ad3a3dcc4dd87ab723470
Author: Russell Owen <rowen@uw.edu>
Date:   Wed Apr 15 05:30:42 2015 -0700

    Remove the getNewSchema argument from getCatalog
    
    Modified getCatalog and getCatalogImpl to always return the new schema.
</pre>
<h3><a name="9e8b4e03"/></a>9e8b4e03</h3>

<pre>
commit 9e8b4e037273308dd79594753c4298079c2617d5
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Tue Aug 6 14:39:02 2013 +0900

    untabify 2 examples, utils.{cc,h} and *.i
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_6"><a name="ups/meas_astrom.table"/></a>ups/meas_astrom.table</h1>

<h3 id="toc_7">Diff:</h3>

<pre>
                setupRequired(afw)
                setupRequired(meas_algorithms)
                setupRequired(pex_logging)
                setupRequired(pex_config)
                setupRequired(pipe_base)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#dca5406d">dca5406d</a> + setupRequired(utils)</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#71da2910">71da2910</a> - setupRequired(gsl)</div>
                setupRequired(wcslib >= 4.4.4)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#71da2910">71da2910</a> - setupRequired(astrometry_net >= 0.49)</div>
              ?                             --------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#eb937b8d">eb937b8d</a> + setupRequired(astrometry_net)</div>
                setupRequired(numpy)
                
                setupOptional(matplotlib)
                
                envPrepend(PYTHONPATH, ${PRODUCT_DIR}/python)
                envPrepend(LD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)
                envPrepend(DYLD_LIBRARY_PATH, ${PRODUCT_DIR}/lib)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#df8f7d5f">df8f7d5f</a> - envPrepend(PATH, ${PRODUCT_DIR}/bin)</div>
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="df8f7d5f"/></a>df8f7d5f</h3>

<pre>
commit df8f7d5f3ad8649aa7959348a28ea57a5f685fda
Author: Paul Price <price@astro.princeton.edu>
Date:   Mon Dec 8 13:06:55 2014 -0500

    Add wrapper for astrometry.net catalog to cache loading
    
    Loading the entire catalog currently requires reading all the index files,
    just to get the metadata (the healpix and nside), which is slow.
    Here, the multiindex_t and list of multiindex_t are wrapped by the new
    MultiIndexCache and AstrometryNetCatalog classes, respectively.  An
    AstrometryNetCatalog can have a cache written for faster loading of the
    metadata.  The cache can be generated with a new bin script, andCache.py.
    
    The Astrometry class really needs to be cleaned up more, and more could
    be moved into the AstrometryNetCatalog class, but I am trying to avoid
    the consequent API changes for now, as this will soon be redone on the
    LSST side.
</pre>
<h3><a name="71da2910"/></a>71da2910</h3>

<pre>
commit 71da29108fecd59e748a176c9284506dd5fbb9a5
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Sat May 24 15:38:09 2014 -0500

    prepare for next astrometry.net release
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="dca5406d"/></a>dca5406d</h3>

<pre>
commit dca5406d4f69a6ffdec97d87ba9a0c51853991e7
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:29:55 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_8"><a name="tests/testSipTransformations.py"/></a>tests/testSipTransformations.py</h1>

<h3 id="toc_9">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#bf2ebaba">bf2ebaba</a> - import sys</div>
                import unittest
                
                import lsst.afw.image as afwImage
                import lsst.utils.tests as utilsTests
                import lsst.afw.geom as afwGeom
                
                
                
                class SipTransformationTest(unittest.TestCase):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#bf2ebaba">bf2ebaba</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#8c240ea3">8c240ea3</a> -     def tearDown(self):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#8c240ea3">8c240ea3</a> -         import lsst.meas.astrom.astrometry_net as an</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#f67a51eb">f67a51eb</a> -         an.finalize()</div>
                    
                    def setUp(self):
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#ed649ff6">ed649ff6</a> +         testDir=os.path.dirname(__file__)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#bf2ebaba">bf2ebaba</a> -         basefn = os.path.join(os.path.dirname(__file__), 'imgCharSources-v85501867-R01-S00')</div>
              ?                               ^ --- ^^^  --------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#ed649ff6">ed649ff6</a> +         basefn = os.path.join(testDir, 'imgCharSources-v85501867-R01-S00')</div>
              ?                               ^^  ^
                
                        sipfn = basefn + '.sipheader'
                        tanfn = basefn + '.tanheader'
                        print 'TAN WCS filename:', tanfn
                        print 'SIP WCS filename:', sipfn
                
                        metaData = afwImage.readMetadata(tanfn)
                        self.tan = afwImage.makeWcs(metaData)
                        metaData = afwImage.readMetadata(sipfn)
                        self.sip = afwImage.makeWcs(metaData)
                
                        #print 'TAN is', self.tan
                        #print 'SIP is', self.sip
                
                        # Using Astrometry.net on SIP solution:
                
                        '''
                        wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.sipheader -x 2168.54521667 -y 2020.40323873
                
                        wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.sipheader -x 2168.54521667 -y 2020.40323873
                
                        wcs-rd2xy -w tests/imgCharSources-v85501867-R01-S00.sipheader -r 1.5 -d 3.3
                
                        wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.sipheader -x 0 -y 0
                
                        Roundtrip:
                        > wcs-rd2xy -w tests/imgCharSources-v85501867-R01-S00.sipheader -r 1.5 -d 3.3
                        RA,Dec (1.5000000000, 3.3000000000) -> pixel (3711.0128841126, 3134.4402504066)
                        > wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.sipheader -x 3711.0128841126 -y 3134.4402504066
                        Pixel (3711.0128841126, 3134.4402504066) -> RA,Dec (1.5000000064, 3.3000000037)
                        > wcs-rd2xy -w tests/imgCharSources-v85501867-R01-S00.sipheader -r 1.5000000064 -d 3.3000000037
                        RA,Dec (1.5000000064, 3.3000000037) -> pixel (3711.0128347543, 3134.4403740779)
                
                        --> good to about 8 digits in RA,Dec in degrees.
                
                        (3711.0128841126, 3134.4402504066)
                        (3711.0128347543, 3134.4403740779)
                
                        --> and about 3-4 digits in pixels.
                        '''
                
                        ''' WCSTools 3.8.0:
                        > sky2xy -v -j tests/imgCharSources-v85501867-R01-S00.wcs 1.5 3.3
                        1.5 3.3 J2000 -> 3711.013 3134.440
                
                        > xy2sky -v -j -d tests/imgCharSources-v85501867-R01-S00.wcs 3711.013 3134.440
                        XY2SKY WCSTools 3.8.0, 12 November 2009, Doug Mink (dmink@cfa.harvard.edu)
                        Print sky coordinates from tests/imgCharSources-v85501867-R01-S00.wcs image coordinates
                        RA           Dec       Sys          X        Y
                        1.50000   3.30000 J2000  <- 3711.013 3134.440
                
                        '''
                
                        
                        self.sip_rdxy = [(r * afwGeom.degrees, d * afwGeom.degrees, x-1,y-1) for (r,d,x,y) in [
                            (1.42667846826, 3.37583321746, 2167.54521667, 2020.40323873),
                            (1.4266863759, 3.3757783481,  2168.5452166700, 2020.4032387300),
                            (1.5000000000, 3.3000000000, 3711.0128841126, 3134.4402504066),
                            (1.2986490876, 3.4785952816, 0.0000000000, 0.0000000000),
                            ]]
                
                
                        # If only TAN is used:
                
                        # > wcs-rd2xy -w tests/imgCharSources-v85501867-R01-S00.tanheader -r 1.5 -d 3.3
                        # RA,Dec (1.5000000000, 3.3000000000) -> pixel (3711.9022585704, 3134.0179793251)
                        #  (wcslib gives same)
                
                        # > wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.tanheader -x 3711.9022585704 -y 3134.0179793251
                        # Pixel (3711.9022585704, 3134.0179793251) -> RA,Dec (1.5000000000, 3.3000000000)
                
                
                        # These are 1-indexed pixels, hence the '-1's below.
                
                        # crpix0 2167.54521667
                        # crpix1 2020.40323873
                        # crval0 1.42667846826
                        # crval1 3.37583321746
                
                        #  (crpix.x, crpix.y)
                        # > wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.tanheader -x 2167.54521667 -y 2020.40323873
                        # Pixel (2167.545217, 2020.403239) -> RA,Dec (1.426678, 3.375833)
                
                        #  (crpix.x + 1, crpix.y)
                        # > wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.tanheader -x 2168.54521667 -y 2020.40323873
                        # Pixel (2168.5452166700, 2020.4032387300) -> RA,Dec (1.4266863759, 3.3757783481)
                
                        #  (crpix.x + 1, crpix.y) with WCSLib:
                        # wcs-xy2rd -L -w tests/imgCharSources-v85501867-R01-S00.tanheader -x 2168.54521667 -y 2020.40323873
                        # Pixel (2168.5452166700, 2020.4032387300) -> RA,Dec (1.4266863759, 3.3757783481)
                
                        # inverse:
                        # > wcs-rd2xy -L -w tests/imgCharSources-v85501867-R01-S00.tanheader -r 1.4266863759 -d 3.3757783481
                        # RA,Dec (1.4266863759, 3.3757783481) -> pixel (2168.5452162485, 2020.4032394061)
                
                
                        # This is the SIP position of 1.5,3.3:
                        # > wcs-xy2rd -w tests/imgCharSources-v85501867-R01-S00.tanheader -x 3711.0128841126 -y 3134.4402504066
                        # Pixel (3711.0128841126, 3134.4402504066) -> RA,Dec (1.5000161440, 3.3000521757)
                
                        # --> good to about 5 decimal digits in pixels.
                
                        self.tan_rdxy = [(r * afwGeom.degrees, d * afwGeom.degrees, x-1, y-1) for (r,d,x,y) in [
                            (1.42667846826, 3.37583321746, 2167.54521667,   2020.40323873),
                            (1.4266863759,  3.3757783481,  2168.5452166700, 2020.4032387300),
                            (1.5000000000, 3.3000000000,  3711.9022585704, 3134.0179793251),
                            (1.5000161440, 3.3000521757, 3711.0128841126, 3134.4402504066),
                            (1.2986453989, 3.4785959230, 0.0000000000, 0.0000000000),
                            ]]
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
149  <a href="#d10b5527">d10b5527</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
150  <a href="#ed649ff6">ed649ff6</a> +     def tearDown(self):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#ed649ff6">ed649ff6</a> +         del self.tan</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
152  <a href="#ed649ff6">ed649ff6</a> +         del self.sip</div>
                
                    # UGH, the coord interface is nasty.
                    def pixelToRaDec(self, wcs, xx, yy):
                        rd = wcs.pixelToSky(xx, yy)
                        rr = rd.getLongitude().asDegrees()
                        dd = rd.getLatitude().asDegrees()
                        return (rr, dd)
                
                    def roundTrip(self, wcs, rdxy):
                        for (ra,dec,x,y) in rdxy:
                            xx,yy = wcs.skyToPixel(ra, dec)
                            rr,dd = self.pixelToRaDec(wcs, xx, yy)
                            print
                            print 'RA,Dec %-14.12g, %-14.12g --> pixel %g, %g -->' % (ra, dec, xx, yy)
                            print 'RA,Dec %-14.12g, %-14.12g' % (rr, dd)
                
                            #print 'pixels are', type(xx), type(yy)
                            #print 'ra,dec are', type(rr), type(rr)
                            
                            self.assertAlmostEqual(rr, ra.asDegrees(), 5)
                            self.assertAlmostEqual(dd, dec.asDegrees(), 5)
                
                            ra,dec = self.pixelToRaDec(wcs, x, y)
                            xx,yy = wcs.skyToPixel(ra * afwGeom.degrees, dec * afwGeom.degrees)
                            print
                            print 'Pixel %-14.12g, %-14.12g --> RA,Dec %-14.12g, %-14.12g -->' %  (x, y, ra, dec)
                            print 'Pixel %-14.12g, %-14.12g' % (xx, yy)
                            self.assertAlmostEqual(x, xx, 3)
                            self.assertAlmostEqual(y, yy, 3)
                        
                
                    def testRoundTripTAN(self):
                        print
                        print 'Round trip TAN'
                        self.roundTrip(self.tan, self.tan_rdxy)
                
                    def testRoundTripSIP(self):
                        print
                        print 'Round trip SIP'
                        self.roundTrip(self.sip, self.sip_rdxy)
                
                    def againstReality(self, wcs, rdxy):
                        for (ra, dec, x, y) in rdxy:
                            xx,yy = wcs.skyToPixel(ra, dec)
                            print 'RA,Dec %-14.12g, %-14.12g --> x,y %-14.12g, %-14.12g' % (ra, dec, xx, yy)
                            print '  Expected:                                   %-14.12g, %-14.12g' % (x,y)
                            self.assertAlmostEqual(x, xx, 3)
                            self.assertAlmostEqual(y, yy, 3)
                            rr,dd = self.pixelToRaDec(wcs, x, y)
                            self.assertAlmostEqual(ra.asDegrees(), rr, 5)
                            self.assertAlmostEqual(dec.asDegrees(), dd, 5)
                            print 'x,y %-14.12g, %-14.12g --> ra,dec %-14.12g, %-14.12g' % (x, y, ra, dec)
                            print '  Expected:                                   %-14.12g, %-14.12g' % (rr,dd)
                
                    def testTan1(self):
                        print
                        print 'TAN against reality:'
                        self.againstReality(self.tan, self.tan_rdxy)
                
                    def testSip1(self):
                        print
                        print 'SIP against reality:'
                        self.againstReality(self.sip, self.sip_rdxy)
                
                
                
                # UGH boilerplate.
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    suites = []
                    suites += unittest.makeSuite(SipTransformationTest)
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="8c240ea3"/></a>8c240ea3</h3>

<pre>
commit 8c240ea3b1e8329d74d93bf5621036fba1958e4c
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Dec 5 13:36:25 2012 -0500

    interim snapshot: call stop_an_logging from unittest tearDown methods; global baton
</pre>
<h3><a name="f67a51eb"/></a>f67a51eb</h3>

<pre>
commit f67a51eb469d3c88b43eea936d66cc6195d33cb0
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Dec 5 13:44:35 2012 -0500

    Rather than a global struct, just make a global PTR(Log); rename stop_an_logging() to finalize()
</pre>
<h3><a name="bf2ebaba"/></a>bf2ebaba</h3>

<pre>
commit bf2ebabae4c10760e5e9178733340b373fd01821
Author: dstn <dstn@git.lsstcorp.org>
Date:   Mon Jun 28 16:21:46 2010 +0000

    add failing test case for ticket #1250
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="d10b5527"/></a>d10b5527</h3>

<pre>
commit d10b5527918680686511c7f7e171f483f052ada5
Author: dstn <dstn@git.lsstcorp.org>
Date:   Mon Jun 28 17:03:15 2010 +0000

    extend tests
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_10"><a name="tests/testMultiIndex.py"/></a>tests/testMultiIndex.py</h1>

<h3 id="toc_11">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#4ce64979">4ce64979</a> - import re</div>
                import os
                import sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#4ce64979">4ce64979</a> - import glob</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#4ce64979">4ce64979</a> - import math</div>
                import unittest
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#4ce64979">4ce64979</a> - import eups</div>
                import lsst.meas.astrom            as measAstrom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#4ce64979">4ce64979</a> - import lsst.afw.detection          as afwDet</div>
              ?                 ^ ----- ^                ^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#ed649ff6">ed649ff6</a> + import lsst.afw.geom               as afwGeom</div>
              ?                 ^  ^^^^^^                ^ ^^
                import lsst.afw.table              as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#4ce64979">4ce64979</a> - import lsst.afw.math               as afwMath</div>
                import lsst.afw.image              as afwImg
                import lsst.utils.tests            as utilsTests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#852cb009">852cb009</a> - import lsst.pex.config             as pexConfig</div>
                from lsst.pex.logging import Log
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#4ce64979">4ce64979</a> - from lsst.pex.exceptions import LsstCppException</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#ed649ff6">ed649ff6</a> + from astrometry.util import ttime</div>
                
                from lsst.meas.astrom import AstrometryNetDataConfig
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#4ce64979">4ce64979</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#e760fc1d">e760fc1d</a> + try:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#e760fc1d">e760fc1d</a> +     import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#e760fc1d">e760fc1d</a> + except ImportError:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#e760fc1d">e760fc1d</a> +     print "warning: import of eups failed; tests will be skipped"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#e760fc1d">e760fc1d</a> +     sys.exit(0)</div>
                
                class MultiIndexTest(unittest.TestCase):
                
                    def setUp(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#4ce64979">4ce64979</a> -         self.conf = measAstrom.MeasAstromConfig()</div>
              ?                                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#7c80bc64">7c80bc64</a> +         self.conf = measAstrom.ANetBasicAstrometryConfig()</div>
              ?                                ^^ ++  ++      ++++
                
                        # Load sample input from disk
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#ed649ff6">ed649ff6</a> +         testDir=os.path.dirname(__file__)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#4ce64979">4ce64979</a> -         mypath = eups.productDir("meas_astrom")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#4ce64979">4ce64979</a> -         path = os.path.join(mypath, "examples")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#4ce64979">4ce64979</a> -         self.srcCat = afwTable.SourceCatalog.readFits(os.path.join(path, "v695833-e0-c000.xy.fits"))</div>
              ?                                                                    -- ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#ed649ff6">ed649ff6</a> +         self.srcCat = afwTable.SourceCatalog.readFits(os.path.join(testDir, "v695833-e0-c000.xy.fits"))</div>
              ?                                                                     ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#4ce64979">4ce64979</a> -         self.srcCat.table.defineApFlux("flux.psf")</div>
                        
                        # The .xy.fits file has sources in the range ~ [0,2000],[0,4500]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#4ce64979">4ce64979</a> -         self.imageSize = (2048, 4612) # approximate</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#ed649ff6">ed649ff6</a> +         self.bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(2048, 4612)) # approximate</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#ef9630f8">ef9630f8</a> -         self.exposure = afwImg.ExposureF(os.path.join(path, "v695833-e0-c000-a00.sci.fits"))</div>
              ?                                                       -- ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#ed649ff6">ed649ff6</a> +         self.exposure = afwImg.ExposureF(os.path.join(testDir, "v695833-e0-c000-a00.sci.fits"))</div>
              ?                                                        ^^^^^^
                        
                        # Set up local astrometry_net_data
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#4ce64979">4ce64979</a> -         datapath = os.path.join(mypath, 'tests', 'astrometry_net_data', 'photocal')</div>
              ?                                 ---------    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#ed649ff6">ed649ff6</a> +         datapath = os.path.join(testDir, 'astrometry_net_data', 'photocal')</div>
              ?                                     ^^^
                        eupsObj = eups.Eups(root=datapath)
                        ok, version, reason = eupsObj.setup('astrometry_net_data')
                        if not ok:
                            raise ValueError("Need photocal version of astrometry_net_data (from path: %s): %s" %
                                             (datapath, reason))
                        self.an_data_dir = datapath
                        
                    def tearDown(self):
                        del self.srcCat
                        del self.conf
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#ed649ff6">ed649ff6</a> +         del self.bbox</div>
                        del self.exposure
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#4ce64979">4ce64979</a> -     def getAstrometrySolution(self, loglvl = Log.INFO, andConfig=None):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#4ce64979">4ce64979</a> -         astrom = measAstrom.Astrometry(self.conf, logLevel=loglvl,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#4ce64979">4ce64979</a> -                                        andConfig=andConfig)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#ed649ff6">ed649ff6</a> +     def getAstrometrySolution(self, andConfig=None, logLevel=Log.INFO):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#ed649ff6">ed649ff6</a> +         astrom = measAstrom.ANetBasicAstrometryTask(self.conf, andConfig=andConfig)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#ed649ff6">ed649ff6</a> +         astrom.log.setThreshold(logLevel)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#4ce64979">4ce64979</a> -         res = astrom.determineWcs(self.srcCat, self.exposure,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#ed649ff6">ed649ff6</a> +         res = astrom.determineWcs(self.srcCat, self.exposure, bbox=self.bbox)</div>
              ?                                                              ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#4ce64979">4ce64979</a> -                                   imageSize=self.imageSize)</div>
                        del astrom
                        return res
                
                    def _testGetSolution(self, **kwargs):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#4ce64979">4ce64979</a> -         res = self.getAstrometrySolution(loglvl=Log.DEBUG, **kwargs)</div>
              ?                                             ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#ed649ff6">ed649ff6</a> +         res = self.getAstrometrySolution(logLevel=Log.DEBUG, **kwargs)</div>
              ?                                             ^^ +
                        self.assertTrue(res is not None)
                        self.assertTrue(len(res.getMatches()) > 50)
                
                    # This is the "vanilla" no-multiIndex setup
                    def testMultiIndexA(self):
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig2.py')
                        andConfig.load(fn)
                        self._testGetSolution(andConfig=andConfig)
                
                    # This is a multiIndex setup with two indices
                    def testMultiIndexB(self):
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig3.py')
                        andConfig.load(fn)
                        self._testGetSolution(andConfig=andConfig)
                
                    # This is a multiIndex setup with two indices, one that has no star kdtree
                    def testMultiIndexC(self):
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig4.py')
                        andConfig.load(fn)
                        self._testGetSolution(andConfig=andConfig)
                
                    # This one has a multiIndex and a normal index.
                    def testMultiIndexD(self):
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig5.py')
                        andConfig.load(fn)
                        self._testGetSolution(andConfig=andConfig)
                
                    # This one has a multiIndex with stars-only and index-only parts
                    def testMultiIndexE(self):
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig6.py')
                        andConfig.load(fn)
                        self._testGetSolution(andConfig=andConfig)
                
                
                    # Test that creating an Astrometry object with many index files
                    # does not use up a lot of memory or file descriptors.
                    # FIXME -- there are no tests on memory usage -- not clear exactly
                    # what to enforce.
                    def testResources(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#5281c0cf">5281c0cf</a> -         from astrometry.util import ttime</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#5281c0cf">5281c0cf</a> -         mem0 = ttime.get_memusage()</div>
                        fd0 = ttime.count_file_descriptors()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#5281c0cf">5281c0cf</a> -         print</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#5281c0cf">5281c0cf</a> -         print 'Mem0:'</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#ed649ff6">ed649ff6</a> +         print 'Mem0:',</div>
              ?                      +
                        print ttime.memusage()
                        print 'FD0:', fd0
                
                        andConfig = AstrometryNetDataConfig()
                        fn = os.path.join(self.an_data_dir, 'andConfig6.py')
                        andConfig.load(fn)
                        andConfig.multiIndexFiles = andConfig.multiIndexFiles * 100
                        print len(andConfig.multiIndexFiles), 'multi-index files'
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#ed649ff6">ed649ff6</a> +         astrom = measAstrom.ANetBasicAstrometryTask(self.conf, andConfig=andConfig)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
141  <a href="#5281c0cf">5281c0cf</a> -         astrom = measAstrom.Astrometry(self.conf, logLevel=Log.INFO,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#5281c0cf">5281c0cf</a> -                                        andConfig=andConfig)</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#5281c0cf">5281c0cf</a> -         mem1 = ttime.get_memusage()</div>
                        fd1 = ttime.count_file_descriptors()
                        print
                        print 'Mem1:'
                        print ttime.memusage()
                        print 'FD1:', fd1
                
                        # Number of used file descriptors should not grow.  Magic 10
                        # is just margin from other things going on in the python process
                        self.assertTrue(fd1 < (fd0 + 10))
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#5281c0cf">5281c0cf</a> -         res = astrom.determineWcs(self.srcCat, self.exposure,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
148  <a href="#ed649ff6">ed649ff6</a> +         res = astrom.determineWcs(self.srcCat, self.exposure, bbox=self.bbox)</div>
              ?                                                              ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
156  <a href="#5281c0cf">5281c0cf</a> -                                   imageSize=self.imageSize)</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
158  <a href="#5281c0cf">5281c0cf</a> -         mem2 = ttime.get_memusage()</div>
                        fd2 = ttime.count_file_descriptors()
                        print
                        print 'Mem2:'
                        print ttime.memusage()
                        print 'FD2:', fd2
                
                        # Number of used file descriptors should not grow.  Magic 10
                        # is just margin from other things going on in the python process
                        self.assertTrue(fd2 < (fd0 + 10))
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#ed649ff6">ed649ff6</a> +         del res</div>
                        del astrom
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
171  <a href="#5281c0cf">5281c0cf</a> -         mem3 = ttime.get_memusage()</div>
                        fd3 = ttime.count_file_descriptors()
                        print
                        print 'Mem3:'
                        print ttime.memusage()
                        print 'FD3:', fd3
                
                        
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(MultiIndexTest)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="5281c0cf"/></a>5281c0cf</h3>

<pre>
commit 5281c0cf8b47c9725cdd51a2fd052d189f473743
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 16 15:52:42 2014 -0500

    check resource use
</pre>
<h3><a name="4ce64979"/></a>4ce64979</h3>

<pre>
commit 4ce64979d323827105fde81df144e7f44cac7f6a
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Dec 6 10:12:02 2012 -0500

    add multi-index config and unit test
</pre>
<h3><a name="852cb009"/></a>852cb009</h3>

<pre>
commit 852cb0090d6ec4f8f7b822fbaa537c8885079a10
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Dec 20 15:07:01 2012 -0500

    Home-brew an AstrometryNetDataConfig class
</pre>
<h3><a name="ef9630f8"/></a>ef9630f8</h3>

<pre>
commit ef9630f8e611997ccb97dbf33a2d826a2c332050
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri Jan 17 14:14:18 2014 -0600

    convert example image from three-file to single-file version; tweak tests to change filename; tweak config for default mag error column; tweak swig
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="e760fc1d"/></a>e760fc1d</h3>

<pre>
commit e760fc1d89c17be9c8a4beee25b3fca6ac2ca67f
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:34:29 2015 -0700

    skip tests/examples if eups is not present
</pre>
<h3><a name="4ce64979"/></a>4ce64979</h3>

<pre>
commit 4ce64979d323827105fde81df144e7f44cac7f6a
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Thu Dec 6 10:12:02 2012 -0500

    add multi-index config and unit test
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_12"><a name=".gitignore"/></a>.gitignore</h1>

<h3 id="toc_13">Diff:</h3>

<pre>
                *.dylib
                *.o
                *.os
                *.pyc
                *.so
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#eb937b8d">eb937b8d</a> + _build.*</div>
                .sconf_temp/
                .sconsign.dblite
                config.log
                doc/html
                doc/doxygen.conf
                examples/refSources
                python/lsst/meas/astrom/net/netLib.py
                python/lsst/meas/astrom/net/netLib_wrap.cc
                python/lsst/meas/astrom/sip/sipLib.py
                python/lsst/meas/astrom/sip/sipLib_wrap.*
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#eb937b8d">eb937b8d</a> + python/lsst/meas/astrom/*Lib.py</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#eb937b8d">eb937b8d</a> + python/lsst/meas/astrom/*Lib_wrap.*</div>
                tests/.tests
                tests/data
                tests/testConvertCheby
                tests/testlsf1d
                tests/testlsf2d
                *.cfgc
                doc/html/
                doc/*.tag
                version.py
                python/lsst/meas/astrom/astrometry_net.py
                python/lsst/meas/astrom/astrometry_net_wrap.cc
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_14"><a name="tests/SourceMatchJoin.py"/></a>tests/SourceMatchJoin.py</h1>

<h3 id="toc_15">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#eb937b8d">eb937b8d</a> + import os</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
3    <a href="#9ca70421">9ca70421</a> - import os, sys</div>
              ?        ----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#e760fc1d">e760fc1d</a> + import sys</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
4    <a href="#9ca70421">9ca70421</a> - from math import *</div>
                import unittest
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#9ca70421">9ca70421</a> - import eups</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#9ca70421">9ca70421</a> - import random</div>
                import lsst.utils.tests as utilsTests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#9ca70421">9ca70421</a> - import lsst.daf.base as dafBase</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
10   <a href="#9ca70421">9ca70421</a> - import lsst.daf.persistence as dafPersist</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#9ca70421">9ca70421</a> - import lsst.pex.exceptions as pexExceptions</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#9ca70421">9ca70421</a> - import lsst.pex.logging as logging</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#9ca70421">9ca70421</a> - import lsst.pex.policy as policy</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#9ca70421">9ca70421</a> - import lsst.afw.geom as afwGeom</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#9ca70421">9ca70421</a> - import lsst.afw.image as afwImage</div>
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#9ca70421">9ca70421</a> - import lsst.afw.math as afwMath</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#9ca70421">9ca70421</a> - import lsst.afw.display.ds9 as ds9</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#9ca70421">9ca70421</a> - import lsst.afw.display.utils as displayUtils</div>
                import lsst.meas.astrom as measAstrom
                from lsst.pex.logging import Log
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#c8e3c28e">c8e3c28e</a> - #from lsst.afw.geom import Angle</div>
                import lsst.afw.geom as afwGeom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#f7ec3246">f7ec3246</a> - import lsst.afw.image              as afwImg</div>
              ?                       -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#eb937b8d">eb937b8d</a> + import lsst.afw.image as afwImg</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#f7ec3246">f7ec3246</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#9ca70421">9ca70421</a> + try:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#e760fc1d">e760fc1d</a> +     import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#e760fc1d">e760fc1d</a> + except ImportError:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#e760fc1d">e760fc1d</a> +     print "warning: import of eups failed; tests will be skipped"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#e760fc1d">e760fc1d</a> +     sys.exit(0)</div>
                
                try:
                    type(verbose)
                except NameError:
                    display = False
                    verbose = 0
                
                
                class matchlistTestCase(unittest.TestCase):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#fcaf0a7f">fcaf0a7f</a> - </div>
                    def setUp(self):
                        # Load sample input from disk
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#ed649ff6">ed649ff6</a> +         testDir=os.path.dirname(__file__)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#9ca70421">9ca70421</a> -         mypath = eups.productDir("meas_astrom")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#fcaf0a7f">fcaf0a7f</a> -         # Ensure the filter we'll use is defined</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#fcaf0a7f">fcaf0a7f</a> -         afwImg.utils.defineFilter("i", 767)</div>
                        # Set up local astrometry_net_data
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#9ca70421">9ca70421</a> -         datapath = os.path.join(mypath, 'tests', 'astrometry_net_data', 'photocal')</div>
              ?                                 ---------    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#ed649ff6">ed649ff6</a> +         datapath = os.path.join(testDir, 'astrometry_net_data', 'photocal')</div>
              ?                                     ^^^
                        print 'Setting up astrometry_net_data:', datapath
                        eupsObj = eups.Eups(root=datapath)
                        ok, version, reason = eupsObj.setup('astrometry_net_data')
                        if not ok:
                            raise ValueError("Couldn't set up local photocal version of astrometry_net_data (from path: %s): %s" % (datapath, reason))
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#f7ec3246">f7ec3246</a> -         path = os.path.join(mypath, "examples")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#fce4c6d8">fce4c6d8</a> -         self.srcSet = afwTable.SourceCatalog.readFits(os.path.join(path, "v695833-e0-c000.xy.fits"))</div>
              ?                                                                    -- ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#ed649ff6">ed649ff6</a> +         self.srcSet = afwTable.SourceCatalog.readFits(os.path.join(testDir, "v695833-e0-c000.xy.fits"))</div>
              ?                                                                     ^^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#f7ec3246">f7ec3246</a> -         self.imageSize = (2048, 4612) # approximate</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#ed649ff6">ed649ff6</a> +         self.bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(2048, 4612)) # approximate</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#b5ae5001">b5ae5001</a> -         self.exposure = afwImg.ExposureF(os.path.join(path, "v695833-e0-c000-a00.sci.fits"))</div>
              ?                                                       -- ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#ed649ff6">ed649ff6</a> +         self.exposure = afwImg.ExposureF(os.path.join(testDir, "v695833-e0-c000-a00.sci.fits"))</div>
              ?                                                        ^^^^^^
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#f7ec3246">f7ec3246</a> -         conf = measAstrom.MeasAstromConfig()</div>
              ?                           ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#ed649ff6">ed649ff6</a> +         config = measAstrom.ANetBasicAstrometryConfig()</div>
              ?             ++              ^^ ++  ++      ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#f7ec3246">f7ec3246</a> -         loglvl = Log.INFO</div>
              ?             --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#ed649ff6">ed649ff6</a> +         logLevel = Log.INFO</div>
              ?            ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#f7ec3246">f7ec3246</a> -         #loglvl = Log.DEBUG</div>
              ?              --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#ed649ff6">ed649ff6</a> +         #logLevel = Log.DEBUG</div>
              ?             ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#f7ec3246">f7ec3246</a> -         self.astrom = measAstrom.Astrometry(conf, logLevel=loglvl)</div>
              ?                                                 ^^^^ ------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#ed649ff6">ed649ff6</a> +         self.astrom = measAstrom.ANetBasicAstrometryTask(config)</div>
              ?                                   +++++++++         ++++     ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#ed649ff6">ed649ff6</a> +         self.astrom.log.setThreshold(logLevel)</div>
                
                    def tearDown(self):
                        del self.srcSet
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#f7ec3246">f7ec3246</a> -         del self.imageSize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#ed649ff6">ed649ff6</a> +         del self.bbox</div>
                        del self.exposure
                        del self.astrom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#f67a51eb">f67a51eb</a> -         import lsst.meas.astrom.astrometry_net as an</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#f67a51eb">f67a51eb</a> -         an.finalize()</div>
                        
                    def getAstrometrySolution(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#f7ec3246">f7ec3246</a> -         return self.astrom.determineWcs(self.srcSet, self.exposure, imageSize=self.imageSize)</div>
              ?                                                                     ^^^^^^^^^      ^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#ed649ff6">ed649ff6</a> +         return self.astrom.determineWcs(self.srcSet, self.exposure, bbox=self.bbox)</div>
              ?                                                                     ^^^^      ^^^^
                
                    def testJoin(self):
                        res = self.getAstrometrySolution()
                
                        matches = res.matches
                        matchmeta = res.matchMetadata
                
                        normalized = afwTable.packMatches(matches)
                        normalized.table.setMetadata(matchmeta)
                
                        matches2 = self.astrom.joinMatchListWithCatalog(normalized, self.srcSet)
                
                        self.assertEqual(len(matches2), len(matches))
                        for i in xrange(len(matches)):
                            self.assertEqual(matches2[i].second.table, matches[i].second.table)
                            self.assertEqual(matches2[i].second.getId(), matches[i].second.getId())
                            self.assertEqual(matches2[i].second, matches[i].second) # no deep copying, so we can compare ptrs
                            self.assertEqual(matches2[i].first.getId(), matches[i].first.getId())
                            self.assertEqual(matches2[i].first.getRa().asDegrees(), matches[i].first.getRa().asDegrees())
                            self.assertEqual(matches2[i].first.getDec().asDegrees(), matches[i].first.getDec().asDegrees())
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#e3ff9504">e3ff9504</a> -             self.assertEqual(matches2[i].first.get("flux"), matches[i].first.get("flux"))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#7c80bc64">7c80bc64</a> +             self.assertEqual(matches2[i].first.get("i_flux"), matches[i].first.get("i_flux"))</div>
              ?                                                     ++                              ++
                
                    def testJoinAllFluxes(self):
                        """Test that we can read all the fluxes back from an a.n.d catalogue"""
                        res = self.getAstrometrySolution()
                
                        matches = res.matches
                        matchmeta = res.matchMetadata
                
                        normalized = afwTable.packMatches(matches)
                        normalized.table.setMetadata(matchmeta)
                
                        matches2 = self.astrom.joinMatchListWithCatalog(normalized, self.srcSet)
                        self.assertTrue(len(matches2) > 0)
                        ref = matches2[0][0]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#5e17f2b0">5e17f2b0</a> -         self.assertEqual(ref.get("flux"), ref.get("i"))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
104  <a href="#e982da08">e982da08</a> -         self.assertEqual(ref.get("flux.err"), ref.get("i.err"))</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#5e17f2b0">5e17f2b0</a> -         sch = ref.getSchema()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#5e17f2b0">5e17f2b0</a> -         names = sch.getNames()</div>
              ?                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#7c80bc64">7c80bc64</a> +         names = ref.getSchema().getNames()</div>
              ?                 ^^^^^^^^  +++++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#7c80bc64">7c80bc64</a> +         for b in ("u", "g", "r", "i", "z"):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#5e17f2b0">5e17f2b0</a> -         for b in "ugriz":               # use one of the "features" I hate in python...</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#5e17f2b0">5e17f2b0</a> -             self.assertTrue(b in names)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
110  <a href="#e982da08">e982da08</a> -             self.assertTrue("%s.err" % b in names)</div>
              ?                                ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#7c80bc64">7c80bc64</a> +             self.assertTrue("%s_flux" % (b,) in names)</div>
              ?                                ^^^^^    + ++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#7c80bc64">7c80bc64</a> +             self.assertTrue("%s_fluxSigma" % (b,) in names)</div>
                            
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= silly boilerplate -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def suite():
                    utilsTests.init()
                    suites = []
                    suites += unittest.makeSuite(matchlistTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the utilsTests"""
                    utilsTests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="fce4c6d8"/></a>fce4c6d8</h3>

<pre>
commit fce4c6d8df8b8922ffe411d1509285532e4cdf34
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Mon Feb 27 12:42:36 2012 -0500

    finished replacing sourceSetIO.py with afw/table FITS readers, removed it
</pre>
<h3><a name="9ca70421"/></a>9ca70421</h3>

<pre>
commit 9ca70421ae17e079d981088a98726d0a9290f54d
Author: dstn <dstn@git.lsstcorp.org>
Date:   Tue Dec 14 17:18:07 2010 +0000

    re-instate a fix from ticket branch 1491-b that was lost?!?
</pre>
<h3><a name="e3ff9504"/></a>e3ff9504</h3>

<pre>
commit e3ff9504c3d9422d8ac0edc7fecf6d2de00a3321
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Mon Feb 27 15:02:38 2012 -0500

    updated join code to afw/tables; all tests now passing
</pre>
<h3><a name="fcaf0a7f"/></a>fcaf0a7f</h3>

<pre>
commit fcaf0a7f47ff65a8da6a454a8852c2d704f980ba
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Thu Mar 13 10:03:50 2014 -1000

    Define a Filter prior to unit tests that use Filters in a_n_d data.
</pre>
<h3><a name="f7ec3246"/></a>f7ec3246</h3>

<pre>
commit f7ec32468e0e6cf869690477467a21842a86e1a2
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu Feb 23 09:53:28 2012 -0500

    add joinMatchList, etc functions; fix SourceMatchJoin test
</pre>
<h3><a name="c8e3c28e"/></a>c8e3c28e</h3>

<pre>
commit c8e3c28e44d45ec525068bccf20c7749e1deda39
Author: dstn <dstn@git.lsstcorp.org>
Date:   Wed May 11 01:33:26 2011 +0000

    lots of debugging output
</pre>
<h3><a name="e982da08"/></a>e982da08</h3>

<pre>
commit e982da084180e424f6739c7cb995a58389395dc9
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Thu Apr 26 13:20:18 2012 -0400

    The name of the flux error columns is wrong; should be foo.err not foo_err.err
</pre>
<h3><a name="f67a51eb"/></a>f67a51eb</h3>

<pre>
commit f67a51eb469d3c88b43eea936d66cc6195d33cb0
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Dec 5 13:44:35 2012 -0500

    Rather than a global struct, just make a global PTR(Log); rename stop_an_logging() to finalize()
</pre>
<h3><a name="5e17f2b0"/></a>5e17f2b0</h3>

<pre>
commit 5e17f2b01dd68eb803d1f5fa5f5ca3ccb7389e94
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Thu Apr 26 12:14:33 2012 -0400

    Added test for allFluxes (#2042)
</pre>
<h3><a name="b5ae5001"/></a>b5ae5001</h3>

<pre>
commit b5ae5001750654a6c85e4051ede21a54909a9c49
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Wed Nov 28 17:15:18 2012 -0500

    Update tests to to work with afw changes.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="f7ec3246"/></a>f7ec3246</h3>

<pre>
commit f7ec32468e0e6cf869690477467a21842a86e1a2
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu Feb 23 09:53:28 2012 -0500

    add joinMatchList, etc functions; fix SourceMatchJoin test
</pre>
<h3><a name="9ca70421"/></a>9ca70421</h3>

<pre>
commit 9ca70421ae17e079d981088a98726d0a9290f54d
Author: dstn <dstn@git.lsstcorp.org>
Date:   Tue Dec 14 17:18:07 2010 +0000

    re-instate a fix from ticket branch 1491-b that was lost?!?
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
<h3><a name="e760fc1d"/></a>e760fc1d</h3>

<pre>
commit e760fc1d89c17be9c8a4beee25b3fca6ac2ca67f
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:34:29 2015 -0700

    skip tests/examples if eups is not present
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_16"><a name="python/lsst/meas/astrom/sip/cleanBadPoints.py"/></a>python/lsst/meas/astrom/sip/cleanBadPoints.py</h1>

<h3 id="toc_17">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                
                import os
                import numpy as np
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#58111c61">58111c61</a> - import eups</div>
                import lsst.afw.detection as det
                
                import sipLib as sip
                
                
                def clean(srcMatch, wcs, order=3, nsigma=3):
                    """Remove bad points from srcMatch
                    
                    Input:
                    srcMatch : std::vector<det::SourceMatch>
                    order:      Order of polynomial to use in robust fitting
                    nsigma:    Sources more than this far away from the robust best fit
                                polynomial are removed
                                
                    Return:
                    std::vector<det::SourceMatch> of the good data points
                    """
                
                    N = len(srcMatch)
                    catX = np.zeros(N)
                    #catY = np.zeros(N)
                    for i in range(N):
                        x,y = wcs.skyToPixel(srcMatch[i].first.getCoord())
                        catX[i] = x
                        #catY[i] = y
                
                    ## FIXME -- why does this only use X?
                
                    x = np.array([s.second.getX() for s in srcMatch])
                    dx = x - catX
                    sigma = np.zeros_like(dx) + 0.1
                    
                    idx = indicesOfGoodPoints(x, dx, sigma, order=order, nsigma=nsigma)
                
                    clean = []
                    for i in idx:
                        clean.append(srcMatch[i])
                    return clean
                            
                    
                
                def indicesOfGoodPoints(x, y, s, order=1, nsigma=3, maxiter=100):
                    """Return a list of indices in the range [0, len(x)]
                    of points that lie less than nsigma away from the robust
                    best fit polynomial
                    """
                    
                    #Indices of elements of x sorted in order of increasing value
                    idx = x.argsort()
                    newidx=[]
                    for niter in xrange(maxiter):
                        rx = chooseRx(x, idx, order)
                        ry = chooseRy(y, idx, order)
                        rs = np.ones((len(rx)))
                          
                        lsf = sip.LeastSqFitter1dPoly(list(rx), list(ry), list(rs), order)
                        fit = map(lambda x: lsf.valueAt(x), rx)
                        f = map(lambda x: lsf.valueAt(x), x)
                        
                        sigma = (y-f).std()
                        deviance = np.fabs( (y - f) /sigma)
                        newidx = np.flatnonzero(deviance < nsigma)
                
                        if False:
                            import matplotlib.pyplot as mpl
                            mpl.plot(x, y, 'ks')
                            mpl.plot(rx, ry, 'b-')        
                            mpl.plot(rx, ry, 'bs')        
                            mpl.plot(rx, fit, 'ms')        
                            mpl.plot(rx, fit, 'm-')        
                            #mpl.plot(x[newidx], y[newidx], 'rs')
                            mpl.show()
                        
                        # If we haven't culled any points we're finished cleaning
                        if len(newidx) == len(idx):
                            break
                    
                    # We get here because we either a) stopped finding bad points
                    # or b) ran out of iterations. Either way, we just return our
                    # list of indices of good points.
                    return newidx
                    
                
                def chooseRx(x, idx, order):
                    """Create order+1 values of the ordinate based on the median of groups of elements of x"""
                    rSize = len(idx)/float(order+1)  #Note, a floating point number
                    rx = np.zeros((order+1))
                    
                    for i in range(order+1):
                        rng = range(int(rSize*i), int(rSize*(i+1)))
                        rx[i] = np.mean(x[idx[rng]])
                    return rx
                    
                
                def chooseRy(y, idx, order):
                    """Create order+1 values of the ordinate based on the median of groups of elements of y"""
                    rSize = len(idx)/float(order+1)  #Note, a floating point number
                    ry = np.zeros((order+1))
                    
                    for i in range(order+1):
                        rng = range(int(rSize*i), int(rSize*(i+1)))
                        ry[i] = np.median(y[idx[rng]])
                    return ry
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="58111c61"/></a>58111c61</h3>

<pre>
commit 58111c618d3ecdeb49df67794daafe2ee464b70d
Author: fergal <fergal@git.lsstcorp.org>
Date:   Tue Oct 6 19:57:20 2009 +0000

    Added some utility functions. These are mostly useful for debugging and testing, but provide methods for creating catalogues from images,  sourceSets with known distortion and identifying outliers and bad matches from SourceMatch
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_18"><a name="tests/lsf1d.py"/></a>tests/lsf1d.py</h1>

<h3 id="toc_19">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import re
                import os
                import glob
                import math
                import pdb                          # we may want to say pdb.set_trace()
                import unittest
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#860335ce">860335ce</a> - import eups</div>
                import lsst.afw.image as afwImage
                import lsst.utils.tests as utilsTests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#860335ce">860335ce</a> - import lsst.afw.image.imageLib as img</div>
              ?                      ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#c6b97345">c6b97345</a> + import lsst.afw.image as img</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#860335ce">860335ce</a> - import lsst.afw.detection.detectionLib as detect</div>
              ?                          -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#c6b97345">c6b97345</a> + import lsst.afw.detection as detect</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#860335ce">860335ce</a> - import lsst.pex.exceptions.exceptionsLib as exception</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#c6b97345">c6b97345</a> + import lsst.pex.exceptions</div>
                
                import lsst.meas.astrom.sip as sip
                
                
                class Lsf1dTestCase(unittest.TestCase):
                    def setUp(self):
                        pass
                
                    def tearDown(self):
                        pass
                
                    def testBadArgs1(self):
                        """Check that code fails when order is too low"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=0
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#860335ce">860335ce</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                        
                
                    def testBadArgs2(self):
                        """Check that code fails when not len(x) != len(y)"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [.622, 1.109, 1.198]
                        s = [1,1,1,1]
                        
                        order=0
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#860335ce">860335ce</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                    def testBadArgs3(self):
                        """Check that code fails when not len(x) != len(s)"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1,1]
                        
                        order=0
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#860335ce">860335ce</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                
                    def testBadArgs4(self):
                        """Check that code fails when not order > number data points"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=5
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#860335ce">860335ce</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                    def testConst1(self):
                        """Check that code fits a dc offset correctly (1)"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=1
                
                        lsf = sip.LeastSqFitter1dPoly(x, y,s,order)
                        
                        for i in range(1, len(x)):
                            self.assertAlmostEqual(lsf.valueAt(x[0]), lsf.valueAt(x[i]), 4)
                            #print x[i], y[i], lsf.valueAt(x[i])
                        
                
                    def testCompareToCpp1(self):
                        """Confirm that I get the same behaviour in Python as I 
                        do in the C++ test fitLinear3
                        """
                        
                        #This test arises because I was having trouble using Eigen's
                        #svd inversion. fitLinear3 in C++ worked fine, but this test
                        #behaved differently, and I tracked the result down to
                        #the svd routines. 
                        
                        x = [689.301136505, 1112.8573687, 1386.67168477]
                        y = [0.66911456573, 1.1147439759, 1.39597284177]
                        s = [1,1,1]
                        
                        order=2
                        print
                        lsf = sip.LeastSqFitter1dPoly(x, y,s,order)
                
                        self.assertAlmostEqual(lsf.valueAt(x[0]), 0.670187891961, 4 )
                        self.assertAlmostEqual(lsf.valueAt(x[1]), 1.11201034929, 4 )
                        self.assertAlmostEqual(lsf.valueAt(x[2]), 1.39763314215, 4 )
                        
                
                    def testCompareToCpp2(self):
                        """Confirm that I get the same behaviour in Python as I do in the C++ test fitLinear3
                        """
                        
                        #This test arises because I was having trouble using Eigen's
                        #svd inversion. fitLinear3 in C++ worked fine, but this test
                        #behaved differently, and I tracked the result down to
                        #the svd routines. 
                        
                        x = [628.857680996, 995.008255088, 1203.39412154, 1425.1404727]
                        y = [0.616728229875, 1.01887634344, 1.19679830465, 1.42873084062]
                        s = [1,1,1, 1]
                        
                        order=3
                        print
                        lsf = sip.LeastSqFitter1dPoly(x, y,s,order)
                        
                        for i in range(len(x)):
                            f = lsf.valueAt(x[i])
                            print "%.1f %.3f %.3f" % (x[i], y[i], f)
                
                        self.assertAlmostEqual(lsf.valueAt(x[0]), y[0], 1 )
                        self.assertAlmostEqual(lsf.valueAt(x[1]), y[1], 1 )
                        self.assertAlmostEqual(lsf.valueAt(x[2]), y[2], 1 )
                        
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(Lsf1dTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                 
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="860335ce"/></a>860335ce</h3>

<pre>
commit 860335ce7262f068a08319392b37e1660991e32c
Author: fergal <fergal@git.lsstcorp.org>
Date:   Thu Oct 1 21:40:56 2009 +0000

    Added some python tests, including one that tests for the bug where LeastSqFitter1d fails when it is called from python. The problem seems to be with svd decomposition
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="c6b97345"/></a>c6b97345</h3>

<pre>
commit c6b973451ae948d29b6fb9418d17ed232eda1a0f
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Jul 18 13:16:44 2014 -0400

    Adapt to changes in exception Python wrappers (DM-827)
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_20"><a name="examples/queryReferenceCatalog.py"/></a>examples/queryReferenceCatalog.py</h1>

<h3 id="toc_21">Diff:</h3>

<pre>
                import sys
                
                import lsst.pex.policy as policy
                import lsst.meas.astrom as measAstrom
                from lsst.pex.logging import Log
                import lsst.afw.geom as afwGeom
                
                def main():
                    from optparse import OptionParser
                
                    parser = OptionParser(usage='%(program) [args] RA Dec radius')
                    parser.add_option('-o', dest='outfn', help='FITS table output filename', default=None)
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
13   <a href="#249758f1">249758f1</a> -     parser.add_option('-f', dest='filter', help='Set desired filter name')</div>
                    (opt, args) = parser.parse_args()
                
                    if len(args) != 3:
                        parser.print_help()
                        return -1
                
                    ra = float(args[0])
                    dec = float(args[1])
                    radius = float(args[2])
                
                    log = Log.getDefaultLog()
                    log.setThreshold(Log.DEBUG);
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#249758f1">249758f1</a> -     config = measAstrom.MeasAstromConfig()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#249758f1">249758f1</a> -     astrom = measAstrom.Astrometry(config, log=log)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#fcc40a76">fcc40a76</a> +     pol = policy.Policy()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#fcc40a76">fcc40a76</a> +     pol.set('matchThreshold', 30)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#fcc40a76">fcc40a76</a> +     solver = measAstrom.createSolver(pol, log)</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#fcc40a76">fcc40a76</a> +     solver.setLogLevel(3)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#fcc40a76">fcc40a76</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#249758f1">249758f1</a> -     X = astrom.getReferenceSources(ra * afwGeom.degrees, dec * afwGeom.degrees,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#249758f1">249758f1</a> -                                    radius * afwGeom.degrees, opt.filter)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#249758f1">249758f1</a> -     print 'Got reference sources', X</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#249758f1">249758f1</a> -     ref = X</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#249758f1">249758f1</a> -     </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#249758f1">249758f1</a> -     # ids = solver.getIndexIdList()</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#fcc40a76">fcc40a76</a> +     ids = solver.getIndexIdList()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#249758f1">249758f1</a> -     # print 'Index IDs:', ids</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#fcc40a76">fcc40a76</a> +     print 'Index IDs:', ids</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#249758f1">249758f1</a> -     # indexid = ids[0]</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#fcc40a76">fcc40a76</a> +     indexid = ids[0]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#249758f1">249758f1</a> -     # </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#fcc40a76">fcc40a76</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#249758f1">249758f1</a> -     # idName = 'id'</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#fcc40a76">fcc40a76</a> +     idName = 'id'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#249758f1">249758f1</a> -     # X = solver.getCatalogue(ra * afwGeom.degrees, dec * afwGeom.degrees,</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#c8e3c28e">c8e3c28e</a> +     X = solver.getCatalogue(ra * afwGeom.degrees, dec * afwGeom.degrees,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#249758f1">249758f1</a> -     #                         radius * afwGeom.degrees, '', idName, indexid)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#c8e3c28e">c8e3c28e</a> +                             radius * afwGeom.degrees, '', idName, indexid)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#249758f1">249758f1</a> -     # ref = X.refsources</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#31f9385d">31f9385d</a> +     ref = X.refsources</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#249758f1">249758f1</a> -     # inds = X.inds</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#31f9385d">31f9385d</a> +     inds = X.inds</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#249758f1">249758f1</a> -     # print 'Got', len(ref), 'reference catalog sources'</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#fcc40a76">fcc40a76</a> +     print 'Got', len(ref), 'reference catalog sources'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#249758f1">249758f1</a> -     # print '  got indices:', len(inds)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#fcc40a76">fcc40a76</a> +     print '  got indices:', len(inds)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#249758f1">249758f1</a> -     # </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#fcc40a76">fcc40a76</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#249758f1">249758f1</a> -     # print 'Tag-along columns:'</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#fcc40a76">fcc40a76</a> +     print 'Tag-along columns:'</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#249758f1">249758f1</a> -     # cols = solver.getTagAlongColumns(indexid)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#fcc40a76">fcc40a76</a> +     cols = solver.getTagAlongColumns(indexid)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#249758f1">249758f1</a> -     # #print cols</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#fcc40a76">fcc40a76</a> +     #print cols</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#249758f1">249758f1</a> -     # for c in cols:</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#fcc40a76">fcc40a76</a> +     for c in cols:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#249758f1">249758f1</a> -     #     print '  column:', c.name, c.fitstype, c.ctype, c.units, c.arraysize</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#fcc40a76">fcc40a76</a> +         print '  column:', c.name, c.fitstype, c.ctype, c.units, c.arraysize</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#249758f1">249758f1</a> -     # colnames = [c.name for c in cols]</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#fcc40a76">fcc40a76</a> +     colnames = [c.name for c in cols]</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#249758f1">249758f1</a> -     # </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#fcc40a76">fcc40a76</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#249758f1">249758f1</a> -     # tagdata = []</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#fcc40a76">fcc40a76</a> +     tagdata = []</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#249758f1">249758f1</a> -     # for c in cols:</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#fcc40a76">fcc40a76</a> +     for c in cols:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#249758f1">249758f1</a> -     #     fname = 'getTagAlong' + c.ctype</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#fcc40a76">fcc40a76</a> +         fname = 'getTagAlong' + c.ctype</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#249758f1">249758f1</a> -     #     func = getattr(solver, fname)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#fcc40a76">fcc40a76</a> +         func = getattr(solver, fname)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#249758f1">249758f1</a> -     #     data = func(indexid, c.name, inds)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#fcc40a76">fcc40a76</a> +         data = func(indexid, c.name, inds)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#249758f1">249758f1</a> -     #     #print 'called', fname, 'to get', c.name, c.ctype, '(len %i)' % len(data)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#fcc40a76">fcc40a76</a> +         #print 'called', fname, 'to get', c.name, c.ctype, '(len %i)' % len(data)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#249758f1">249758f1</a> -     #     tagdata.append(data)</div>
              ?    --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#fcc40a76">fcc40a76</a> +         tagdata.append(data)</div>
                        
                
                    if opt.outfn is None:
                        # SSV
                        print 'ra dec',
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#249758f1">249758f1</a> -         # for c in cols:</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#fcc40a76">fcc40a76</a> +         for c in cols:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#249758f1">249758f1</a> -         #     if c.arraysize > 1:</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#fcc40a76">fcc40a76</a> +             if c.arraysize > 1:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#249758f1">249758f1</a> -         #         for a in len(c.arraysize):</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#fcc40a76">fcc40a76</a> +                 for a in len(c.arraysize):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#249758f1">249758f1</a> -         #             print ('%s_%i' % (c.name, a)),</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#fcc40a76">fcc40a76</a> +                     print ('%s_%i' % (c.name, a)),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#249758f1">249758f1</a> -         #     else:</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#fcc40a76">fcc40a76</a> +             else:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#249758f1">249758f1</a> -         #         print c.name,</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#fcc40a76">fcc40a76</a> +                 print c.name,</div>
                        print
                
                        for i,r in enumerate(ref):
                            print r.getRa().asDegrees(), r.getDec().asDegrees(),
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#249758f1">249758f1</a> -             # for c,d in zip(cols, tagdata):</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#fcc40a76">fcc40a76</a> +             for c,d in zip(cols, tagdata):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#249758f1">249758f1</a> -             #     if c.arraysize > 1:</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#fcc40a76">fcc40a76</a> +                 if c.arraysize > 1:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#249758f1">249758f1</a> -             #         for a in len(c.arraysize):</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#fcc40a76">fcc40a76</a> +                     for a in len(c.arraysize):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#249758f1">249758f1</a> -             #             print d[c.arraysize * i + a],</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#fcc40a76">fcc40a76</a> +                         print d[c.arraysize * i + a],</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#249758f1">249758f1</a> -             #     else:</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#fcc40a76">fcc40a76</a> +                 else:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#249758f1">249758f1</a> -             #         print d[i],</div>
              ?            --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#fcc40a76">fcc40a76</a> +                     print d[i],</div>
                            print
                
                    else:
                        import pyfits
                        import numpy as np
                
                        fitscols = []
                        fitscols.append(pyfits.Column(name='RA', array=np.array([r.getRa().asDegrees() for r in ref]),
                                                      format='D', unit='deg'))
                        fitscols.append(pyfits.Column(name='DEC', array=np.array([r.getDec().asDegrees() for r in ref]),
                                                      format='D', unit='deg'))
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#249758f1">249758f1</a> -         # for c,d in zip(cols, tagdata):</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
89   <a href="#fcc40a76">fcc40a76</a> +         for c,d in zip(cols, tagdata):</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#249758f1">249758f1</a> -         #     fmap = { 'Int64' : 'K',</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#fcc40a76">fcc40a76</a> +             fmap = { 'Int64' : 'K',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#249758f1">249758f1</a> -         #              'Int' : 'J',</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#fcc40a76">fcc40a76</a> +                      'Int' : 'J',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#249758f1">249758f1</a> -         #              'Bool' : 'L',</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#fcc40a76">fcc40a76</a> +                      'Bool' : 'L',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#249758f1">249758f1</a> -         #              'Double': 'D',</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#fcc40a76">fcc40a76</a> +                      'Double': 'D',</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#249758f1">249758f1</a> -         #              }</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#fcc40a76">fcc40a76</a> +                      }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#249758f1">249758f1</a> -         #     if c.arraysize > 1:</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#fcc40a76">fcc40a76</a> +             if c.arraysize > 1:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#249758f1">249758f1</a> -         #         # May have to reshape the array as well...</div>
              ?          ----------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#fcc40a76">fcc40a76</a> +                 # May have to reshape the array as well...</div>
              ? ++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#249758f1">249758f1</a> -         #         fitscols.append(pyfits.Column(name=c.name, array=np.array(d),</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#fcc40a76">fcc40a76</a> +                 fitscols.append(pyfits.Column(name=c.name, array=np.array(d),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
101  <a href="#249758f1">249758f1</a> -         #                                   format='%i%s' % (c.arraysize, fmap.get(c.ctype, 'D'))))</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#fcc40a76">fcc40a76</a> +                                           format='%i%s' % (c.arraysize, fmap.get(c.ctype, 'D'))))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
102  <a href="#249758f1">249758f1</a> -         #     else:</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#fcc40a76">fcc40a76</a> +             else:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
103  <a href="#249758f1">249758f1</a> -         #         fitscols.append(pyfits.Column(name=c.name, array=np.array(d),</div>
              ?        --
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#fcc40a76">fcc40a76</a> +                 fitscols.append(pyfits.Column(name=c.name, array=np.array(d),</div>
                                                          format=fmap.get(c.ctype, 'D')))
                
                        pyfits.new_table(fitscols).writeto(opt.outfn, clobber=True)
                        print 'Wrote FITS table', opt.outfn
                
                
                    return 0
                
                
                if __name__ == '__main__':
                    sys.exit(main())
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="249758f1"/></a>249758f1</h3>

<pre>
commit 249758f1eb71b0ae0d9cb5a9b6509a38432c87ee
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jun 18 08:50:22 2014 -0500

    update queryReferenceCatalog... looks like I removed the "get tag along data" api though
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="31f9385d"/></a>31f9385d</h3>

<pre>
commit 31f9385dc864234ea4ea435c447857e8f7e5938c
Author: dstn <dstn@git.lsstcorp.org>
Date:   Mon Jan 10 16:56:08 2011 +0000

    tidy and fix up tests to use new getCatalogue...() return type
</pre>
<h3><a name="fcc40a76"/></a>fcc40a76</h3>

<pre>
commit fcc40a76f2ffcdf1edcf5519587ecd69f43cbf19
Author: dstn <dstn@git.lsstcorp.org>
Date:   Thu Jan 6 18:11:15 2011 +0000

    add more sense to sensible tag-along data accessors; add example python script
</pre>
<h3><a name="c8e3c28e"/></a>c8e3c28e</h3>

<pre>
commit c8e3c28e44d45ec525068bccf20c7749e1deda39
Author: dstn <dstn@git.lsstcorp.org>
Date:   Wed May 11 01:33:26 2011 +0000

    lots of debugging output
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_22"><a name="tests/createWcsWithSip.py"/></a>tests/createWcsWithSip.py</h1>

<h3 id="toc_23">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#dce80bf9">dce80bf9</a> - import re</div>
                import os
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#dce80bf9">dce80bf9</a> + import unittest</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#dce80bf9">dce80bf9</a> + </div>
                import sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#dce80bf9">dce80bf9</a> - import glob</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#dce80bf9">dce80bf9</a> - import math</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#dce80bf9">dce80bf9</a> - import unittest</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#dce80bf9">dce80bf9</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#dce80bf9">dce80bf9</a> - import eups</div>
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#dce80bf9">dce80bf9</a> - import lsst.afw.math as afwMath</div>
                import lsst.utils.tests as utilsTests
                import lsst.afw.geom as afwGeom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#656b4818">656b4818</a> - import lsst.afw.image as afwImage</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#81748f80">81748f80</a> - import lsst.pex.logging as pexLog</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#81748f80">81748f80</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#81748f80">81748f80</a> - import lsst.meas.astrom as measAst</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#7c80bc64">7c80bc64</a> + import lsst.meas.astrom as measAstrom</div>
              ?                                   +++
                import lsst.meas.astrom.sip as sip
                import lsst.meas.astrom.sip.genDistortedImage as distort
                import lsst.meas.astrom.sip.cleanBadPoints as cleanBadPoints
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#dce80bf9">dce80bf9</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#e760fc1d">e760fc1d</a> + try:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#e760fc1d">e760fc1d</a> +     import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#e760fc1d">e760fc1d</a> + except ImportError:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#e760fc1d">e760fc1d</a> +     print "warning: import of eups failed; tests will be skipped"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#e760fc1d">e760fc1d</a> +     sys.exit(0)</div>
                
                ############################
                # Set up local astrometry_net_data
                meas_astrom_dir = eups.productDir("meas_astrom")
                datapath = os.path.join(meas_astrom_dir, 'tests', 'astrometry_net_data', 'cfhttemplate')
                eupsObj = eups.Eups(root=datapath)
                ok, version, reason = eupsObj.setup('astrometry_net_data')
                if not ok:
                    raise ValueError("Can't find astrometry_net_data version cfhttemplate (from path: %s): %s" %
                                     (datapath, reason))
                
                class CreateWcsWithSipCase(unittest.TestCase):
                    def setUp(self):
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#81748f80">81748f80</a> -         self.conf = measAst.MeasAstromConfig()</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#81748f80">81748f80</a> -         self.astrom = measAst.Astrometry(self.conf) #, logLevel=pexLog.Log.DEBUG)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#ed649ff6">ed649ff6</a> +         self.config = measAstrom.ANetBasicAstrometryConfig()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#ed649ff6">ed649ff6</a> +         self.config.defaultFilter = "r"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#ed649ff6">ed649ff6</a> +         self.astrom = measAstrom.ANetBasicAstrometryTask(config=self.config)</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#5a89ae8c">5a89ae8c</a> -         path=eups.productDir("meas_astrom")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#ed649ff6">ed649ff6</a> +         testDir=os.path.dirname(__file__)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#3e053505">3e053505</a> -         self.filename=os.path.join(path, "tests", "cat.xy.fits")</div>
              ?                                    -------    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#ed649ff6">ed649ff6</a> +         self.filename=os.path.join(testDir, "cat.xy.fits")</div>
              ?                                        ^^^
                        self.tolArcsec = .4 
                        self.tolPixel = .1
                
                    def tearDown(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#81748f80">81748f80</a> -         del self.conf</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#ed649ff6">ed649ff6</a> +         del self.config</div>
              ?                      ++
                        del self.astrom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#40340ca2">40340ca2</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#f67a51eb">f67a51eb</a> -         import lsst.meas.astrom.astrometry_net as an</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#f67a51eb">f67a51eb</a> -         an.finalize()</div>
                
                    def testBigXy0(self):
                        # test for ticket #2710
                        from lsst.pex.logging import Log
                        log = Log.getDefaultLog()
                        log.setThreshold(Log.DEBUG);
                        self.astrom.log = log
                        x0,y0 = 200000, 500000
                        cx = 500
                        a2 = 1e-5
                        cat = afwTable.SourceCatalog.readFits(self.filename)
                        print 'Catalog size', len(cat)
                        # Source x,y positions are ~ (500,1500) x (500,1500)
                        xKey = cat.table.getCentroidKey().getX()
                        yKey = cat.table.getCentroidKey().getY()
                        for src in cat:
                            x = src.get(xKey) - 500
                            dx = x - cx
                            x += a2 * (dx**2)
                            src.set(xKey, x + x0)
                            src.set(yKey, src.get(yKey) - 500 + y0)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#ed649ff6">ed649ff6</a> +         bbox = afwGeom.Box2I(afwGeom.Point2I(x0, y0), afwGeom.Extent2I(1000, 1000))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#eb84056d">eb84056d</a> -         res = self.astrom.determineWcs2(cat, imageSize=(1000,1000),</div>
              ?                                              ^^^^^^^^^ ^^^^^^^^^^ -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#ed649ff6">ed649ff6</a> +         res = self.astrom.determineWcs2(cat, bbox=bbox)</div>
              ?                                              ^^^^ ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#eb84056d">eb84056d</a> -                                         x0=x0, y0=y0)</div>
                        print 'Got result', res
                        print 'SIP:', res.sipWcs.getFitsMetadata().toString()
                
                        wcs = res.wcs
                        for src in cat:
                            rd = wcs.pixelToSky(src.getCentroid())
                            xy = wcs.skyToPixel(rd)
                            #print 'src', src.getX(), src.getY()
                            #print 'rd', rd
                            #print 'xy', xy
                            #print 'dx,dy', xy[0] - src.getX(), xy[1] - src.getY()
                            self.assertTrue(abs(xy[0] - src.getX()) < 0.1)
                            self.assertTrue(abs(xy[1] - src.getY()) < 0.1)
                        
                    def testLinearXDistort(self):
                        print "linearXDistort"
                        self.singleTestInstance(self.filename, distort.linearXDistort)
                
                    def testLinearYDistort(self):
                        print "linearYDistort"
                        self.singleTestInstance(self.filename, distort.linearYDistort)
                
                    def testQuadraticDistort(self):
                        print "linearQuadraticDistort"
                        self.singleTestInstance(self.filename, distort.linearYDistort)
                    
                    def singleTestInstance(self, filename, distortFunc):
                        cat = self.loadCatalogue(self.filename)
                        img = distort.distortList(cat, distortFunc)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
121  <a href="#ed649ff6">ed649ff6</a> +         bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(1000, 1000))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#81748f80">81748f80</a> -         res = self.astrom.determineWcs2(img, imageSize=(1000,1000))</div>
              ?                                              ^^^^^^^^^ ^^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
122  <a href="#ed649ff6">ed649ff6</a> +         res = self.astrom.determineWcs2(img, bbox=bbox)</div>
              ?                                              ^^^^ ^^^^
                        imgWcs = res.getWcs()
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
124  <a href="#11dbab3e">11dbab3e</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
125  <a href="#eb937b8d">eb937b8d</a> +         def printWcs(wcs):</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#eb937b8d">eb937b8d</a> +             print "WCS metadata:"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#eb937b8d">eb937b8d</a> +             md = wcs.getFitsMetadata()</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
128  <a href="#eb937b8d">eb937b8d</a> +             for name in md.names():</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#eb937b8d">eb937b8d</a> +                 print "%s: %r" % (name, md.get(name))</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
130  <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#eb937b8d">eb937b8d</a> +         printWcs(imgWcs)</div>
                
                        #Create a wcs with sip
                        cat = cat.cast(afwTable.SimpleCatalog, False)
                        matchList = self.matchSrcAndCatalogue(cat, img, imgWcs)
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
136  <a href="#eb937b8d">eb937b8d</a> +         print "*** num matches =", len(matchList)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#eb937b8d">eb937b8d</a> +         return</div>
                        sipObject = sip.makeCreateWcsWithSip(matchList, imgWcs, 3)
                
                        #print 'Put in TAN Wcs:'
                        #print imgWcs.getFitsMetadata().toString()
                        imgWcs = sipObject.getNewWcs()
                        #print 'Got SIP Wcs:'
                        #print imgWcs.getFitsMetadata().toString()
                
                        # Write out the SIP header
                        #afwImage.fits_write_imageF('createWcsWithSip.sip', afwImage.ImageF(0,0),
                        #imgWcs.getFitsMetadata())
                
                        print 'number of matches:', len(matchList), sipObject.getNPoints()
                        scatter = sipObject.getScatterOnSky().asArcseconds()
                        print "Scatter in arcsec is %g" % (scatter)
                
                        self.assertTrue(scatter < self.tolArcsec, "Scatter exceeds tolerance in arcsec")
                
                        if False:
                            scatter = sipObject.getScatterInPixels()
                            self.assertTrue(scatter < self.tolPixel, "Scatter exceeds tolerance in pixels: %g" %(scatter))
                        
                
                    def loadCatalogue(self, filename):
                        """Load a list of xy points from a file, solve for position, and
                        return a SourceSet of points"""
                
                        cat = afwTable.SourceCatalog.readFits(filename)
                
                        # Source x,y positions are ~ (500,1500) x (500,1500)
                        xKey = cat.table.getCentroidKey().getX()
                        yKey = cat.table.getCentroidKey().getY()
                        for src in cat:
                            src.set(xKey, src.get(xKey) - 500)
                            src.set(yKey, src.get(yKey) - 500)
                            
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
174  <a href="#ed649ff6">ed649ff6</a> +         bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(1000, 1000))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
167  <a href="#81748f80">81748f80</a> -         res = self.astrom.determineWcs2(cat, imageSize=(1000,1000))</div>
              ?                                              ^^^^^^^^^ ^^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
175  <a href="#ed649ff6">ed649ff6</a> +         res = self.astrom.determineWcs2(cat, bbox=bbox)</div>
              ?                                              ^^^^ ^^^^
                        catWcs = res.getWcs()
                
                        #Set catalogue ra and decs
                        for src in cat:
                            src.updateCoord(catWcs)
                        return cat
                
                    def matchSrcAndCatalogue(self, cat, img, imgWcs, dist=1.*afwGeom.arcseconds, cleanParam=3):
                        """Given an input catalogue, match a list of objects in an image, given
                        their x,y position and a wcs solution.
                
                        Return: A list of x, y, dx and dy. Each element of the list is itself a list
                        """
                
                        matcher = sip.MatchSrcToCatalogue(cat, img, imgWcs, dist)
                        matchList = matcher.getMatches()
                
                        mList = cleanBadPoints.clean(matchList, imgWcs, order=cleanParam)
                        return mList
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
187  <a href="#dce80bf9">dce80bf9</a> -         </div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#dce80bf9">dce80bf9</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#dce80bf9">dce80bf9</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#dce80bf9">dce80bf9</a> -         </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#dce80bf9">dce80bf9</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#dce80bf9">dce80bf9</a> -         </div>
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#dce80bf9">dce80bf9</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#dce80bf9">dce80bf9</a> - </div>
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(CreateWcsWithSipCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                
                
                
                 
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="dce80bf9"/></a>dce80bf9</h3>

<pre>
commit dce80bf914872d3831112ac90d217f2b3a1f2102
Author: fergal <fergal@git.lsstcorp.org>
Date:   Wed Dec 9 20:21:48 2009 +0000

    Added test for CreateWcsWithSip class
</pre>
<h3><a name="40340ca2"/></a>40340ca2</h3>

<pre>
commit 40340ca26c3557eec8a1f2706dff7fc9da9bd087
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu May 15 12:08:56 2014 -0500

    Merge master; still need to resolve conceptual conflicts in IndexManager RAII vs multiindex
</pre>
<h3><a name="3e053505"/></a>3e053505</h3>

<pre>
commit 3e0535057baaf04a0153a87f76c927b1e5ec6968
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Sat Feb 25 17:47:30 2012 -0500

    basic WCS-with-SIP determination tests now passing
</pre>
<h3><a name="5a89ae8c"/></a>5a89ae8c</h3>

<pre>
commit 5a89ae8c5b8c80cda33c5d846424f2de1c559ec3
Author: fergal <fergal@git.lsstcorp.org>
Date:   Tue Dec 15 21:26:55 2009 +0000

    Minor changes.
</pre>
<h3><a name="656b4818"/></a>656b4818</h3>

<pre>
commit 656b4818a05268e3f7e6aefb9f194a4017cdc514
Author: dstn <dstn@git.lsstcorp.org>
Date:   Wed May 11 15:24:24 2011 +0000

    all the tests that used to pass now pass again!
</pre>
<h3><a name="81748f80"/></a>81748f80</h3>

<pre>
commit 81748f80d2ffe90acf28ff32cd77623e951bb231
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Feb 22 17:14:26 2012 -0500

    make createWcsWithSip test work; create new CFHTLS Deep1 index, with provenance
</pre>
<h3><a name="eb84056d"/></a>eb84056d</h3>

<pre>
commit eb84056dae684b1a4f0078baf8f7e3da7e8c82eb
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Thu Feb 28 13:02:03 2013 -0600

    logging; scatter diagnostics; return SIP WCS by default in InitialAstrometry object;
    fit inverse SIP coefficients in pixel space, not sky space.
</pre>
<h3><a name="f67a51eb"/></a>f67a51eb</h3>

<pre>
commit f67a51eb469d3c88b43eea936d66cc6195d33cb0
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Dec 5 13:44:35 2012 -0500

    Rather than a global struct, just make a global PTR(Log); rename stop_an_logging() to finalize()
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="dce80bf9"/></a>dce80bf9</h3>

<pre>
commit dce80bf914872d3831112ac90d217f2b3a1f2102
Author: fergal <fergal@git.lsstcorp.org>
Date:   Wed Dec 9 20:21:48 2009 +0000

    Added test for CreateWcsWithSip class
</pre>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
<h3><a name="11dbab3e"/></a>11dbab3e</h3>

<pre>
commit 11dbab3e9c4d479a95288eaca560e4cb1afbc1ce
Author: dstn <dstn@git.lsstcorp.org>
Date:   Tue Apr 19 17:10:46 2011 +0000

    meas_astrom src ra,dec in radians
</pre>
<h3><a name="e760fc1d"/></a>e760fc1d</h3>

<pre>
commit e760fc1d89c17be9c8a4beee25b3fca6ac2ca67f
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:34:29 2015 -0700

    skip tests/examples if eups is not present
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_24"><a name="python/lsst/meas/astrom/catalogStarSelector.py"/></a>python/lsst/meas/astrom/catalogStarSelector.py</h1>

<h3 id="toc_25">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                import math
                import numpy
                
                import lsst.pex.config as pexConfig
                import lsst.pex.exceptions as pexExcept
                import lsst.afw.detection as afwDetection
                import lsst.afw.display.ds9 as ds9
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.table as afwTable
                import lsst.afw.geom as afwGeom
                import lsst.afw.geom.ellipses as geomEllip
                import lsst.afw.cameraGeom as cameraGeom
                import lsst.meas.algorithms as measAlg
                
                class CatalogStarSelectorConfig(pexConfig.Config):
                    fluxLim = pexConfig.Field(
                        doc = "specify the minimum psfFlux for good Psf Candidates",
                        dtype = float,
                        default = 0.0,
                        check = lambda x: x >= 0.0,
                    )
                    fluxMax = pexConfig.Field(
                        doc = "specify the maximum psfFlux for good Psf Candidates (ignored if == 0)",
                        dtype = float,
                        default = 0.0,
                #        minValue = 0.0,
                        check = lambda x: x >= 0.0,
                    )
                    badStarPixelFlags = pexConfig.ListField(
                        doc = "PSF candidate objects may not have any of these bits set",
                        dtype = str,
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#6e515c11">6e515c11</a> -         default = ["flags.pixel.edge", "flags.pixel.interpolated.center", "flags.pixel.saturated.center"],</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#53cfeb2a">53cfeb2a</a> +         default = ["base_PixelFlags_flag_edge", "base_PixelFlags_flag_interpolatedCenter", "base_PixelFlags_flag_saturatedCenter"],</div>
                        )
                    kernelSize = pexConfig.Field(
                        doc = "size of the kernel to create",
                        dtype = int,
                        default = 21,
                    )
                    borderWidth = pexConfig.Field(
                        doc = "number of pixels to ignore around the edge of PSF candidate postage stamps",
                        dtype = int,
                        default = 0,
                    )
                
                class CheckSource(object):
                    """A functor to check whether a source has any flags set that should cause it to be labeled bad."""
                
                    def __init__(self, table, fluxLim, fluxMax, badStarPixelFlags):
                        self.keys = [table.getSchema().find(name).key for name in badStarPixelFlags]
                        self.keys.append(table.getCentroidFlagKey())
                        self.fluxLim = fluxLim
                        self.fluxMax = fluxMax
                
                    def __call__(self, source):
                        for k in self.keys:
                            if source.get(k):
                                return False
                        if self.fluxLim != None and source.getPsfFlux() < self.fluxLim: # ignore faint objects
                            return False
                        if self.fluxMax != 0.0 and source.getPsfFlux() > self.fluxMax: # ignore bright objects
                            return False
                        return True
                
                class CatalogStarSelector(object):
                    ConfigClass = CatalogStarSelectorConfig
                
                    def __init__(self, config=None):
                        """Construct a star selector that uses second moments
                        
                        This is a naive algorithm and should be used with caution.
                        
                        @param[in] config: An instance of CatalogStarSelectorConfig
                        """
                        if not config:
                            config = CatalogStarSelector.ConfigClass()
                
                        self._kernelSize  = config.kernelSize
                        self._borderWidth = config.borderWidth
                        self._fluxLim  = config.fluxLim
                        self._fluxMax  = config.fluxMax
                        self._badStarPixelFlags = config.badStarPixelFlags
                            
                    def selectStars(self, exposure, sources, matches=None):
                        """Return a list of PSF candidates that represent likely stars
                        
                        A list of PSF candidates may be used by a PSF fitter to construct a PSF.
                        
                        @param[in] exposure: the exposure containing the sources
                        @param[in] sources: a source list containing sources that may be stars
                        @param[in] matches: a match vector as produced by meas_astrom; not actually optional
                                            (passing None just allows us to handle the exception better here
                                            than in calling code)
                        
                        @return psfCandidateList: a list of PSF candidates.
                        """
                        import lsstDebug
                        display = lsstDebug.Info(__name__).display
                        displayExposure = lsstDebug.Info(__name__).displayExposure     # display the Exposure + spatialCells
                        pauseAtEnd = lsstDebug.Info(__name__).pauseAtEnd               # pause when done
                
                        if matches is None:
                            raise RuntimeError(
                                "Cannot use catalog star selector without running astrometry."
                                )
                
                        mi = exposure.getMaskedImage()
                        
                        if display:
                            frames = {}
                            if displayExposure:
                                frames["displayExposure"] = 1
                                ds9.mtv(mi, frame=frames["displayExposure"], title="PSF candidates")
                        #
                        # Read the reference catalogue
                        #
                        wcs = exposure.getWcs()
                        imageSize = exposure.getDimensions()
                        filterName = exposure.getFilter().getName()
                        calib = exposure.getCalib()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
142  <a href="#028e08bc">028e08bc</a> -     </div>
                        isGoodSource = CheckSource(sources, self._fluxLim, self._fluxMax, self._badStarPixelFlags)
                
                        #
                        # Go through and find all the PSFs in the catalogue
                        #
                        # We'll split the image into a number of cells, each of which contributes only
                        # one PSF candidate star
                        #
                        psfCandidateList = []
                
                        with ds9.Buffering():
                            for ref, source, d in matches:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
155  <a href="#028e08bc">028e08bc</a> -                 if ref.get("stargal"):</div>
              ?                              ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
154  <a href="#eb937b8d">eb937b8d</a> +                 if not ref.get("resolved"):</div>
              ?                   ++++          ++ ^ +++
                                    if not isGoodSource(source):
                                        symb, ctype = "+", ds9.RED
                                    else:
                                        try:
                                            psfCandidate = measAlg.makePsfCandidate(source, exposure)
                
                                            # The setXXX methods are class static, but it's convenient to call them on
                                            # an instance as we don't know Exposure's pixel type
                                            # (and hence psfCandidate's exact type)
                                            if psfCandidate.getWidth() == 0:
                                                psfCandidate.setBorderWidth(self._borderWidth)
                                                psfCandidate.setWidth(self._kernelSize + 2*self._borderWidth)
                                                psfCandidate.setHeight(self._kernelSize + 2*self._borderWidth)
                
                                            im = psfCandidate.getMaskedImage().getImage()
                                            max = afwMath.makeStatistics(im, afwMath.MAX).getValue()
                                            if not numpy.isfinite(max):
                                                continue
                                            psfCandidateList.append(psfCandidate)
                
                                            symb, ctype = "+", ds9.GREEN
                                        except Exception as err:
                                            symb, ctype = "o", ds9.RED
                                            print "RHL", err
                                            pass # FIXME: should log this!
                                else:
                                    symb, ctype = "o", ds9.BLUE
                
                                if display and displayExposure:
                                    ds9.dot(symb, source.getX() - mi.getX0(), source.getY() - mi.getY0(),
                                            size=4, frame=frames["displayExposure"], ctype=ctype)
                
                        if display and pauseAtEnd:
                            raw_input("Continue? y[es] p[db] ")
                
                        return psfCandidateList
                
                measAlg.starSelectorRegistry.register("catalog", CatalogStarSelector)
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="028e08bc"/></a>028e08bc</h3>

<pre>
commit 028e08bcf47e8b49e7397d470b5480315a81405a
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Thu May 24 15:39:06 2012 -0400

    A new start selector that uses the star/galaxy data from the input (A.N.D.) catalogue to choose candidates
</pre>
<h3><a name="6e515c11"/></a>6e515c11</h3>

<pre>
commit 6e515c113c585e86bed493a8695bf3eb674fe330
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Sat Jun 23 15:25:22 2012 -0500

    Make the pixel masks defining bad pixels configurable
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="53cfeb2a"/></a>53cfeb2a</h3>

<pre>
commit 53cfeb2afef825a0bec91e6f641660c000010a55
Author: Perry Gee <pgee@physics.ucdavis.edu>
Date:   Wed Jul 9 06:02:01 2014 -0500

    Fix error in catalogStarSelector with names of flags.  Restore fluxField option to PhotoCal.py
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_26"><a name="include/lsst/meas/astrom/sip/LeastSqFitter2d.h"/></a>include/lsst/meas/astrom/sip/LeastSqFitter2d.h</h1>

<h3 id="toc_27">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                
                /* 
                 * LSST Data Management System
                 * Copyright 2008, 2009, 2010 LSST Corporation.
                 * 
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
                 * 
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
                 * 
                 * You should have received a copy of the LSST License Statement and 
                 * the GNU General Public License along with this program.  If not, 
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
                 
                
                #ifndef LEAST_SQ_FITTER_2D
                #define LEAST_SQ_FITTER_2D
                
                
                #include <cstdio>
                #include <vector>
                
                #include "boost/shared_ptr.hpp"
                #include "Eigen/Core"
                #include "Eigen/SVD"
                
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                #include "lsst/afw/math/FunctionLibrary.h"
                
                namespace except = lsst::pex::exceptions;
                namespace pexLogging = lsst::pex::logging;
                
                
                namespace lsst { 
                namespace meas { 
                namespace astrom { 
                namespace sip {
                
                /**
                \brief Fit an lsst::afw::math::Function1 object to a set of data points in two dimensions.
                
                The class is templated over the kind of object to fit. Note that we fit the 1d object in each
                dimension, not the 2d one.
                
                Input is a list of x and y ordinates for a set of points, the z coordinate, and the uncertainties, s.
                order is order of the polynomial to fit (e.g if the templated function is 
                lsst::afw::math::PolynomialFunction1, then order=3 => fit a function of the form \f$ax^2+bx+c\f$
                
                \tparam FittingFunc The 1d function to fit in both dimensions. Must inherit from 
                lsst::afw::math::Function1 
                
                \param x Ordinate of points to fit
                \param y Ordinate of points to fit
                \param z Co-ordinate of pionts to fit
                \param s 1\f$\sigma\f$ uncertainties in z
                \param order Polynomial order to fit
                
                \sa LeastSqFitter1d
                */
                template <class FittingFunc>class LeastSqFitter2d {
                public:
                    LeastSqFitter2d(const std::vector<double> &x, const std::vector<double> &y, const std::vector<double> &z, 
                                    const std::vector<double> &s, int order);
                
                    Eigen::MatrixXd getParams();
                    Eigen::MatrixXd getErrors();
                    double valueAt(double x, double y);
                    std::vector<double> residuals();
                    
                    double getChiSq();
                    double getReducedChiSq();
                
                private:
                    void initFunctions();
                
                    Eigen::MatrixXd expandParams(Eigen::VectorXd const & input) const;
                
                    double func2d(double x, double y, int term);
                    double func1d(double value, int exponent);
                    
                    std::vector<double> _x, _y, _z, _s;
                    int _order;   //Degree of polynomial to fit, e.g 4=> cubic
                    int _nPar;    //Number of parameters in fitting eqn, e.g x^2, xy, y^2, x^3, 
                    int _nData;   //Number of data points, == _x.size()
                    
                    Eigen::JacobiSVD<Eigen::MatrixXd> _svd;
                    Eigen::VectorXd _par;
                
                    std::vector<boost::shared_ptr<FittingFunc> > _funcArray;
                        
                        
                };
                    
                
                
                
                //The .cc part
                namespace sip = lsst::meas::astrom::sip;
                namespace math = lsst::afw::math;
                
                ///Fit a 2d polynomial to a set of data points z(x, y)
                ///
                ///\tparam FittingFunc  The type of function to fit in each dimension. This function should extend the base
                ///       class of lsst::afw::math::Function1. Note that this is a 1d function
                ///\param x vector of x positions of data
                ///\param y vector of y positions of data
                ///\param z Value of data for a given x,y. \f$z = z_i = z_i(x_i, y_i)\f$
                ///\param s Vector of measured uncertainties in the values of z
                ///\param order Order of 2d function to fit
                template<class FittingFunc> LeastSqFitter2d<FittingFunc>::LeastSqFitter2d(const std::vector<double> &x, 
                    const std::vector<double> &y, const std::vector<double> &z, const std::vector<double> &s, int order) :
                    _x(x), _y(y), _z(z), _s(s), _order(order), _nPar(0), _par(1) {
                    
                    //_nPar, the number of terms to fix (x^2, xy, y^2 etc.) is \Sigma^(order+1) 1
                    _nPar = 0;
                    for (int i = 0; i < order; ++i) {
                        _nPar += i + 1;
                    }
                    
                    //Check input vectors are the same size
                    _nData = _x.size();
                    if (_nData != static_cast<int>(_y.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#c0ec4f23">c0ec4f23</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "x and y vectors of different lengths");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "x and y vectors of different lengths");        </div>
                    }
                    if (_nData != static_cast<int>(_s.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#c0ec4f23">c0ec4f23</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "x and s vectors of different lengths");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
137  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "x and s vectors of different lengths");        </div>
                    }
                    if (_nData != static_cast<int>(_z.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#c0ec4f23">c0ec4f23</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "x and z vectors of different lengths");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "x and z vectors of different lengths");        </div>
                    }
                
                    for (int i = 0; i < _nData; ++i) {
                        if ( _s[i] == 0.0 ) {
                            std::string msg = "Illegal zero value for fit weight encountered.";
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#27c466be">27c466be</a> -             throw LSST_EXCEPT(except::RuntimeErrorException, msg);        </div>
              ?                                                   ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
146  <a href="#3896b32c">3896b32c</a> +             throw LSST_EXCEPT(except::RuntimeError, msg);        </div>
                        }
                    }
                
                    if (_nData < _order) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#c0ec4f23">c0ec4f23</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "Fewer data points than parameters");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
151  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "Fewer data points than parameters");        </div>
                    }
                    
                    initFunctions();
                
                    Eigen::MatrixXd design(_nData, _nPar);
                    Eigen::VectorXd rhs(_nData);
                    for (int i = 0; i < _nData; ++i) {
                        rhs[i] = z[i] / s[i];
                        for (int j = 0; j < _nPar; ++j) {
                            design(i, j) = func2d(_x[i], _y[i], j) / _s[i];
                        }
                    }
                    _svd.compute(design, Eigen::ComputeThinU | Eigen::ComputeThinV);
                    _par = _svd.solve(rhs);
                }
                
                
                ///Build up a triangular matrix of the parameters. The shape of the matrix is
                ///such that the values correspond to the coefficients of the following polynomials\n
                /// 1   y    y^2  y^3 \n
                /// x   xy   xy^2 0   \n
                /// x^2 x^2y 0    0   \n
                /// x^3 0    0    0   \n
                ///(order==4) \n
                ///
                /// where row x column < order
                template<class FittingFunc> Eigen::MatrixXd LeastSqFitter2d<FittingFunc>::getParams() {
                    return expandParams(_par);
                }
                
                /// Turn a flattened parameter-like vector into a triangular matrix.
                template<class FittingFunc> 
                Eigen::MatrixXd LeastSqFitter2d<FittingFunc>::expandParams(Eigen::VectorXd const & input) const {
                    Eigen::MatrixXd out = Eigen::MatrixXd::Zero(_order, _order);
                    int count = 0;
                    for (int i = 0; i < _order; ++i) {
                        for (int j = 0; j < _order - i; ++j) {
                            out(i, j) = input[count++];
                        }
                    }
                    return out;
                }
                
                /// \brief Return a measure of the goodness of fit. 
                /// \f[ \chi^2 = \sum \left( \frac{z_i - f(x_i, y_i)}{s_i} \right)^2  \f]
                template<class FittingFunc> double LeastSqFitter2d<FittingFunc>::getChiSq() {
                    
                    double chisq = 0;
                    for (int i = 0; i < _nData; ++i) {
                        double val = _z[i] - valueAt(_x[i], _y[i]);
                        val /= _s[i];
                        chisq += pow(val, 2);
                    }
                    
                    return chisq;
                }
                
                
                /// \brief Return a measure of the goodness of fit. 
                /// \f[ \chi_r^2 = \sum \left( \frac{z_i - f(x_i, y_i)}{s} \right)^2 \div (N-p) \f]
                /// Where \f$ N \f$ is the number of data points, and \f$ p \f$ is the number 
                /// of parameters in the fit
                /// 
                template<class FittingFunc> double LeastSqFitter2d<FittingFunc>::getReducedChiSq() {
                    return getChiSq()/(double) (_nData - _nPar);
                }
                
                
                
                ///Return the value of the best fit function at a given position (x,y)
                template<class FittingFunc>  double LeastSqFitter2d<FittingFunc>::valueAt(double x, double y){
                    double val = 0;
                    
                    //Sum the values of the different orders to get the value of the fitted function
                    for (int i = 0; i < _nPar; ++i) {
                        val += _par[i] * func2d(x, y, i);
                    }
                    return val;
                }
                
                ///Return a vector of residuals of the fit (i.e the difference between the input z values, and 
                ///the value of the fitting function at that point.
                template<class FittingFunc>  std::vector<double> LeastSqFitter2d<FittingFunc>::residuals(){
                
                    std::vector<double> out;
                    out.reserve(_nData);
                    
                    for (int i = 0; i < _nData; ++i) {
                        out.push_back(_z[i] - valueAt(_x[i], _y[i]));
                    }
                    
                    return out;
                }
                
                
                ///Companion function to getParams(). Returns uncertainties in the parameters as a matrix
                template<class FittingFunc>
                Eigen::MatrixXd LeastSqFitter2d<FittingFunc>::getErrors() {
                    Eigen::ArrayXd variance(_nPar);
                    for (int i = 0; i < _nPar; ++i) {
                        variance[i] = _svd.matrixV().row(i).dot(
                            (_svd.singularValues().array().inverse().square() * _svd.matrixV().col(i).array()).matrix()
                        );
                    }
                    return expandParams(variance.sqrt().matrix());
                }
                
                    
                template<class FittingFunc> void LeastSqFitter2d<FittingFunc>::initFunctions() {
                    //Initialise the array of functions. _funcArray[i] is a object of type math::Function1 of order i
                    _funcArray.reserve(_order);
                    
                    std::vector<double> coeff;
                    coeff.reserve( _order);
                    
                    coeff.push_back(1);
                    for (int i = 0; i < _order; ++i) {
                        boost::shared_ptr<FittingFunc> p(new FittingFunc(coeff));
                        _funcArray.push_back(p);
                        
                        coeff[i] = 0;
                        coeff.push_back(1);  //coeff now looks like [0,0,...,0,1]
                    }
                }
                     
                
                //The ith term in the fitting polynomial is of the form x^a * y^b. This function figures
                //out the value of a and b, then calculates the value of the ith term at the given x and y
                template<class FittingFunc> double LeastSqFitter2d<FittingFunc>::func2d(double x, double y, int term) {
                
                    int yexp = 0;  //y exponent
                    int xexp = 0;  //x exponent
                
                    for (int i = 0; i<term; ++i) {
                        yexp = (yexp + 1) % (_order - xexp);
                        if ( yexp == 0){
                            xexp++;
                        }
                    }
                
                    double xcomp = func1d(x, xexp);  //x component of polynomial
                    double ycomp = func1d(y, yexp);  //y component
                
                    #if 0   //A useful debugging printf statement
                        printf("The %i(th) function: x^%i * y^%i = %.1f * %.1f\n", term, xexp, yexp, xcomp, ycomp);
                    #endif
                    
                    return xcomp*ycomp;
                }
                
                template<class FittingFunc> double LeastSqFitter2d<FittingFunc>::func1d(double value, int exponent) {
                    return (*_funcArray[exponent])(value);
                }
                
                
                    
                }}}}
                
                #endif
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="c0ec4f23"/></a>c0ec4f23</h3>

<pre>
commit c0ec4f23c419fb5a51c4662b3868b17767629020
Author: fergal <fergal@git.lsstcorp.org>
Date:   Mon Oct 5 20:38:24 2009 +0000

    Tidied up the code. Try many different ways of solving the linear equation instead of just one. Validate input parameters. Added the valueAt function, which returns the value of the fitted function at a give (x,y)
</pre>
<h3><a name="27c466be"/></a>27c466be</h3>

<pre>
commit 27c466be87376e673ccbcaf846f58b84e8bc6fee
Author: fergal <fergal@git.lsstcorp.org>
Date:   Thu Dec 10 16:45:06 2009 +0000

    Ran C++ code through Steve's style checker, and cleaned out quite a few things. Minor change to flow of logic in MatchSrcToCatalogue. findMatches() (the workhorse function) is now called when you ask to getMatches(). This way, if you change one of the parameters, you can be sure you are getting the most uptodate result when you call getMatches()
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_28"><a name="examples/imsimUtils.py"/></a>examples/imsimUtils.py</h1>

<h3 id="toc_29">Diff:</h3>

<pre>
                from lsst.obs.lsstSim import LsstSimMapper
                import lsst.daf.persistence as dafPersist
                
                
                def addOptions(parser, input=True, output=False):
                    if input:
                        parser.add_option('-i', '--input', dest='inRoot', default='.', help='input root')
                    if output:
                        parser.add_option('-o', '--output', dest='outRoot', default='.', help='output root')
                    parser.add_option('-R', '--registry', help='registry', dest='registry')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#f05c8cf5">f05c8cf5</a> -     parser.add_option('-v', '--visit', type='int', dest='visit', action='append', type='int', default=[])</div>
              ?                                       ------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#a5a41def">a5a41def</a> +     parser.add_option('-v', '--visit', dest='visit', action='append', type='int', default=[])</div>
                    parser.add_option('-r', '--raft', dest='raft', action='append', default=[])
                    parser.add_option('-s', '--sensor', dest='sensor', action='append', default=[])
                
                def getInputButler(opt):
                    inmapper = LsstSimMapper(root=opt.inRoot, registry=opt.registry)
                    bf = dafPersist.ButlerFactory(mapper=inmapper)
                    inButler = bf.create()
                    return inButler
                
                def getOutputButler(opt):
                    outmapper = LsstSimMapper(root=opt.outRoot, registry=opt.registry)
                    bf = dafPersist.ButlerFactory(mapper=outmapper)
                    outButler = bf.create()
                    return outButler
                
                def getAllKeys(opt, inButler):
                    allkeys = []
                    if not len(opt.visit):
                        # Grab all available visits.
                        print 'Grabbing all available visits...'
                        #visits = inButler.queryMetadata('visitim', 'visit')
                        visits = inButler.queryMetadata('raw', 'visit')
                        print 'Got visits', visits
                        opt.visit = visits
                
                    for visit in opt.visit:
                        if not len(opt.raft):
                            print 'Grabbing all available rafts for visit', visit
                            rafts = inButler.queryMetadata('raw', 'raft', visit=visit)
                            print 'Got rafts', rafts
                        else:
                            rafts = opt.raft
                
                        for raft in rafts:
                            if not len(opt.sensor):
                                print 'Grabbing all available sensors for visit', visit, 'raft', raft
                                sensors = inButler.queryMetadata('raw', 'sensor', visit=visit, raft=raft)
                                print 'Got sensors', sensors
                            else:
                                sensors = opt.sensor
                            for sensor in sensors:
                                allkeys.append(dict(visit=visit, raft=raft, sensor=sensor))
                    return allkeys
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="f05c8cf5"/></a>f05c8cf5</h3>

<pre>
commit f05c8cf5111fdc951ee6881891f4385a22f8c6ed
Author: dstn <dstn@git.lsstcorp.org>
Date:   Tue Dec 14 03:48:43 2010 +0000

    re-add example files that should have come in with the merge of ticket 1491-b!
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="a5a41def"/></a>a5a41def</h3>

<pre>
commit a5a41def84416834ba8c9266e1e8d8b1f079eace
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 15:38:08 2015 -0700

    fix syntax error in ./examples/imsimUtils.py
    
          File "./examples/imsimUtils.py", line 11
            parser.add_option('-v', '--visit', type='int', dest='visit', action='append', type='int', default=[])
        SyntaxError: keyword argument repeated
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_30"><a name="src/sip/MatchSrcToCatalogue.cc"/></a>src/sip/MatchSrcToCatalogue.cc</h1>

<h3 id="toc_31">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                
                /* 
                 * LSST Data Management System
                 * Copyright 2008, 2009, 2010 LSST Corporation.
                 * 
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
                 * 
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
                 * 
                 * You should have received a copy of the LSST License Statement and 
                 * the GNU General Public License along with this program.  If not, 
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
                 
                #include "lsst/meas/astrom/sip/MatchSrcToCatalogue.h"
                #include "lsst/afw/image/Wcs.h"
                
                namespace lsst { namespace meas { namespace astrom { namespace sip {
                
                /// \brief Create a list of common objects from a catalogue and an image.
                /// 
                /// Take a catSet, i.e a SimpleCatalog giving the true positions of objects in
                /// ra/dec space, and an imageSet, i.e. a SourceCatalog of the pixel positions
                /// of sources detected on a CCD image.  Use the Wcs to calculate the ra/dec of
                /// the image source, and then find the subset of objects withcommon positions
                /// in the two sets. The returned list of matches is one-to-one, i.e no object
                /// in the catalogue is matched twice, and no object in the imageSet is matched
                /// twice.
                /// 
                /// \param catSet  List of catalogue positions with known ra and dec
                /// \param imgSet  List of image positions with known x and y
                /// \param wcs     A Wcs object to convert from xy to radec
                /// \param dist    How close to objects need to be in order to be considered the same
                /// 
                MatchSrcToCatalogue::MatchSrcToCatalogue(afw::table::SimpleCatalog const& catSet,  
                                                         afw::table::SourceCatalog const& imgSet, 
                                                         CONST_PTR(lsst::afw::image::Wcs) wcs, 
                                                         afw::geom::Angle dist)
                {
                    setImgSrcSet(imgSet);
                    setCatSrcSet(catSet);
                    setDist(dist);
                    setWcs(wcs);
                }    
                
                /// Set a new value for the maximum allowed distance between two matching objects (in ra/dec space) 
                void MatchSrcToCatalogue::setDist(afw::geom::Angle dist) {
                    if (dist <= 0) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#fbec21c2">fbec21c2</a> -         throw LSST_EXCEPT(pex::exceptions::InvalidParameterException, "Distance must be > 0");</div>
              ?                                                             ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(pex::exceptions::InvalidParameterError, "Distance must be > 0");</div>
              ?                                                             ^^ ^
                    }
                    _dist = dist;
                }
                
                /// Set a different Wcs solution
                void MatchSrcToCatalogue::setWcs(CONST_PTR(lsst::afw::image::Wcs) wcs) {
                    _wcs = wcs;
                }
                
                /// sourceSet is a vector of pointers to Sources.
                void MatchSrcToCatalogue::setImgSrcSet(afw::table::SourceCatalog const &srcSet) {
                    _imgSet = srcSet;
                }
                
                void MatchSrcToCatalogue::setCatSrcSet(afw::table::SimpleCatalog const &srcSet) {
                    _catSet = srcSet;
                }
                
                void MatchSrcToCatalogue::findMatches() {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#fbec21c2">fbec21c2</a> -     if (!_imgSet.getTable()->getCentroidKey().isValid()) {</div>
              ?                              ^^^        ^^^^^^^^^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#aba3c6c5">aba3c6c5</a> +     if (!_imgSet.getTable()->hasCentroidSlot()) {</div>
              ?                              ^^^        ^ ^^
                        throw LSST_EXCEPT(
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#fbec21c2">fbec21c2</a> -             pex::exceptions::LogicErrorException,</div>
              ?                                        ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#3896b32c">3896b32c</a> +             pex::exceptions::LogicError,</div>
                            "SourceTable passed to MatchSrcToCatalogue does not have its centroid slot set."
                        );
                    }
                
                    for (afw::table::SourceCatalog::const_iterator i = _imgSet.begin(); i != _imgSet.end(); ++i) {
                        i->updateCoord(*_wcs);
                    }
                    
                    _match = afw::table::matchRaDec(_catSet, _imgSet, _dist);
                
                    _removeOneToMany();  
                    _removeManyToOne();  
                }
                
                
                ///We require that out matches be one to one, i.e any element matches no more than once for either 
                ///the catalogue or the image. However, our implementation of findMatches uses afw::table::matchRaDec()
                ///which does not garauntee that. This function does the (slow) search and removal.
                void MatchSrcToCatalogue::_removeOneToMany() {
                    std::size_t size = _match.size();
                    for (std::size_t i=0; i<size; ++i) {
                        for (std::size_t j=i+1; j<size; ++j) {
                            //If the same Source appears twice keep the one with the smaller separation from its match
                            if ( _match[i].first == _match[j].first ) {
                                //Keep the one with the shorter match distance, and disgard the other
                                if (_match[i].distance < _match[j].distance) {
                                    _match.erase(_match.begin() + j);
                                    size--;
                                    j--;
                                } else {
                                    _match.erase(_match.begin() + i);
                                    size--;
                                    i--;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                
                /// This function is identical to
                ///_removeOneToMany() except first is replaced with second for the match structures
                void MatchSrcToCatalogue::_removeManyToOne()  {
                    std::size_t size = _match.size();
                    for (std::size_t i=0; i<size; ++i) {
                        for (std::size_t j=i+1; j<size; ++j) {
                            //If the same Source appears twice
                            if (_match[i].second == _match[j].second) {
                                //Keep the one with the shorter match distance, and disgard the other
                                if (_match[i].distance < _match[j].distance) {
                                    _match.erase(_match.begin() + j);
                                    size--;
                                    j--;
                                } else {
                                    _match.erase(_match.begin() + i);
                                    size--;
                                    i--;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                
                afw::table::ReferenceMatchVector MatchSrcToCatalogue::getMatches() {
                    findMatches();
                    return _match;
                }
                    
                }}}} // namespace lsst::meas::astrom::sip
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="fbec21c2"/></a>fbec21c2</h3>

<pre>
commit fbec21c2ce5a480a636f29e3b8a12448e97bf0ad
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Sat Feb 25 13:41:38 2012 -0500

    updated MatchSrcToCatalogue to use new source/tables
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="aba3c6c5"/></a>aba3c6c5</h3>

<pre>
commit aba3c6c5ea603fac902b9dc1a91f3dcc5e08dc94
Author: pgee <pgee@pgeepc2.physics.ucdavis.edu>
Date:   Tue Jul 15 15:36:03 2014 -0700

    Changed afwTable call hasCentroid to hasCentroidSlot
</pre>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_32"><a name="tests/openFiles.py"/></a>tests/openFiles.py</h1>

<h3 id="toc_33">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2013 Dustin Lang.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#a8e9a305">a8e9a305</a> - import re</div>
                import os
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#a8e9a305">a8e9a305</a> - import sys</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#a8e9a305">a8e9a305</a> - import glob</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#a8e9a305">a8e9a305</a> - import math</div>
                import unittest
                
                import resource
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#a8e9a305">a8e9a305</a> - import eups</div>
                import lsst.meas.astrom as measAstrom
                import lsst.utils.tests as utilsTests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#a8e9a305">a8e9a305</a> - import lsst.afw.math as afwMath</div>
              ?                  ---       ^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#ed649ff6">ed649ff6</a> + import lsst.afw.geom as afwGeom</div>
              ?                 +++        ^^^^
                import lsst.afw.table as afwTable
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#a8e9a305">a8e9a305</a> - import lsst.afw.image as afwImg</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#a8e9a305">a8e9a305</a> - import lsst.pex.logging as pexLog</div>
                
                
                # http://stackoverflow.com/a/7142094/834250
                def getOpenFiles():
                    '''
                    return the filenames for open file descriptors for current process
                
                    .. warning: will only work on UNIX-like os-es.
                    '''
                    import subprocess
                    import os
                
                    pid = os.getpid()
                    output = subprocess.check_output(["/usr/sbin/lsof", '-w', '-Ffn', "-p", str(pid)])
                
                    procs = [out for out in output.split('\n') if out and out[0] in "fn"]
                    assert len(procs) % 2 == 0 # Expect an even number of lines: f and n pairs
                    procs = [(procs[2*i], procs[2*i+1]) for i in range(len(procs)//2)]
                    nameList = [name[1:] for desc,name in procs if desc[0] == 'f' and desc[1:].isdigit()]
                    return nameList
                
                def printOpenFiles():
                    names = getOpenFiles()
                    print "Open files (%d): %s" % (len(names), names)
                
                
                class OpenFilesTest(unittest.TestCase):
                    """This tests that the astrometry functions can run with a greatly reduced open file limit
                
                    There is no specific assert; we're just testing that things can run.  If they can't, then
                    the code will fail (often catastrophically with a segfault), so there's no need to check
                    specific success conditions.
                    """
                
                    def setUp(self):
                        limits = resource.getrlimit(resource.RLIMIT_NOFILE)
                        print 'NOFILE rlimit:', limits
                        resource.setrlimit(resource.RLIMIT_NOFILE, (10, limits[1]))
                        print 'NOFILE rlimit:', resource.getrlimit(resource.RLIMIT_NOFILE)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#c6797ad3">c6797ad3</a> -         self.mypath = os.path.dirname(os.path.dirname(__file__))</div>
              ?                       ----------------                         -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#ed649ff6">ed649ff6</a> +         self.mypath = os.path.dirname(__file__)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#ed649ff6">ed649ff6</a> +         self.srcCat = afwTable.SourceCatalog.readFits(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#ed649ff6">ed649ff6</a> +             os.path.join(self.mypath, "v695833-e0-c000.xy.fits"))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#c6797ad3">c6797ad3</a> -         path = os.path.join(self.mypath, "examples")</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#a8e9a305">a8e9a305</a> -         self.srcCat = afwTable.SourceCatalog.readFits(os.path.join(path, "v695833-e0-c000.xy.fits"))</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#a8e9a305">a8e9a305</a> -         self.srcCat.table.defineApFlux("flux.psf")</div>
                        # The .xy.fits file has sources in the range ~ [0,2000],[0,4500]
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#a8e9a305">a8e9a305</a> -         self.imageSize = (2048, 4612) # approximate</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#ed649ff6">ed649ff6</a> +         self.bbox = afwGeom.Box2I(afwGeom.Point2I(0, 0), afwGeom.Extent2I(2048, 4612)) # approximate</div>
                
                    def getAstrom(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#c6797ad3">c6797ad3</a> -         andpath = os.path.join(self.mypath, 'tests', 'astrometry_net_data', 'photocal')</div>
              ?                                             ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#ed649ff6">ed649ff6</a> +         andpath = os.path.join(self.mypath, 'astrometry_net_data', 'photocal')</div>
                        os.environ['ASTROMETRY_NET_DATA_DIR'] = andpath
                        andcfn = os.path.join(andpath, 'andConfigOpenFiles.py')
                
                        andconfig = measAstrom.AstrometryNetDataConfig()
                        andconfig.load(andcfn)
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#c6797ad3">c6797ad3</a> -         conf = measAstrom.MeasAstromConfig()</div>
              ?                           ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#7c80bc64">7c80bc64</a> +         conf = measAstrom.ANetBasicAstrometryConfig()</div>
              ?                           ^^ ++  ++      ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#c6797ad3">c6797ad3</a> -         return measAstrom.Astrometry(config=conf, andConfig=andconfig,)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#7c80bc64">7c80bc64</a> +         return measAstrom.ANetBasicAstrometryTask(config=conf, andConfig=andconfig,)</div>
              ?                            +++++++++         ++++
                                                            #logLevel=pexLog.Log.DEBUG)
                
                    def tearDown(self):
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#a8e9a305">a8e9a305</a> -         del self.imageSize</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#ed649ff6">ed649ff6</a> +         del self.bbox</div>
                        del self.srcCat
                
                
                    def runDetermineWcs(self):
                        astrom = self.getAstrom()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
106  <a href="#c6797ad3">c6797ad3</a> -         result = astrom.determineWcs2(self.srcCat, imageSize=self.imageSize, filterName='i')</div>
              ?                                                    ^^^^^^^^^      ^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#ed649ff6">ed649ff6</a> +         result = astrom.determineWcs2(self.srcCat, bbox=self.bbox, filterName='i')</div>
              ?                                                    ^^^^      ^^^^
                        print 'Got result from determineWcs:', result
                        #printOpenFiles()
                        return result.wcs
                
                    def runUseKnownWcs(self, wcs):
                        astrom = self.getAstrom()
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
113  <a href="#c6797ad3">c6797ad3</a> -         result = astrom.useKnownWcs(self.srcCat, wcs=wcs, filterName='i', imageSize=self.imageSize)</div>
              ?                                                                           ^^^^^^^^^      ^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
105  <a href="#ed649ff6">ed649ff6</a> +         result = astrom.useKnownWcs(self.srcCat, wcs=wcs, filterName='i', bbox=self.bbox)</div>
              ?                                                                           ^^^^      ^^^^
                        print "Got result from useKnownWcs:", result
                        #printOpenFiles()
                
                    def testDetermineWcs(self):
                        self.runDetermineWcs()
                        self.runDetermineWcs()
                        self.runDetermineWcs()
                
                    def testUseKnownWcs(self):
                        wcs = self.runDetermineWcs()
                        self.runUseKnownWcs(wcs)
                        self.runUseKnownWcs(wcs)
                        self.runUseKnownWcs(wcs)
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(OpenFilesTest)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
                    
                
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="c6797ad3"/></a>c6797ad3</h3>

<pre>
commit c6797ad3909ed0210ff88d7050ba129677e8b167
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu May 30 01:56:33 2013 +0900

    use RAII for index loading/closing (#2879)
    
    When loading indices (when solving, or just reading a catalog)
    one can quickly run out of open file descriptors if not careful.
    To ensure we don't, use an RAII object ("IndexManager") on the
    indices so that files are closed whenever they go out of scope
    (exception, looping, etc).
    
    This replaces the fix to addIndices from #2292 with a more
    complete solution, and applies it also to getCatalogImpl, which
    was discovered to have the same problem in #2879.
</pre>
<h3><a name="a8e9a305"/></a>a8e9a305</h3>

<pre>
commit a8e9a305f06a0912581475467653666ddfd6f83d
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Sat Mar 9 13:56:15 2013 -0500

    add failing unit test demonstrating #2292
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_34"><a name="python/lsst/meas/astrom/__init__.py"/></a>python/lsst/meas/astrom/<strong>init</strong>.py</h1>

<h3 id="toc_35">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#f15b2194">f15b2194</a> - import lsst.utils</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#eb937b8d">eb937b8d</a> + # import lsst.utils</div>
              ? ++
                
                import sip
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#3bf125a0">3bf125a0</a> - from config import MeasAstromConfig, AstrometryNetDataConfig</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#a27ea3e2">a27ea3e2</a> - from . import astrom</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#a27ea3e2">a27ea3e2</a> - from .astrom import Astrometry</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#7c80bc64">7c80bc64</a> + from .astrometryNetDataConfig import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#7c80bc64">7c80bc64</a> + from .anetBasicAstrometry import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#eb937b8d">eb937b8d</a> + from .astrometry import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#eb937b8d">eb937b8d</a> + from .anetAstrometry import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#eb937b8d">eb937b8d</a> + from .loadAstrometryNetObjects import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#eb937b8d">eb937b8d</a> + from .matchOptimisticB import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#9ca8c56c">9ca8c56c</a> + from .setMatchDistance import *</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#1e6b2460">1e6b2460</a> + from .display import *</div>
                
                from . import catalogStarSelector
                
                from .version import *
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="a27ea3e2"/></a>a27ea3e2</h3>

<pre>
commit a27ea3e2a1d30d2fb5aa7a2fe549f6f4d46352c8
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Jul 27 10:18:28 2012 +0900

    register catalog star selector at meas astrom import time
</pre>
<h3><a name="f15b2194"/></a>f15b2194</h3>

<pre>
commit f15b2194ccf900867a7f96254dfe51c23636c3f0
Author: rhl <rhl@git.lsstcorp.org>
Date:   Thu Aug 26 07:18:30 2010 +0000

    Added version() command
</pre>
<h3><a name="3bf125a0"/></a>3bf125a0</h3>

<pre>
commit 3bf125a0d1b49ad96766b50c1ad681d957915181
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Jan 30 09:57:40 2012 -0500

    rename config classes again; convert fields to RangeFields
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="1e6b2460"/></a>1e6b2460</h3>

<pre>
commit 1e6b2460afc9069df6edafa0af6781c9edd962bc
Author: Russell Owen <rowen@uw.edu>
Date:   Wed May 20 16:42:43 2015 -0700

    Consolidate astrometry display code
    
    Renamed showAstrometry to displayAstrometry (ds9) and moved to display.py
    Renamed plotMatches to plotAstrometry (matplotlib) and moved to display.py
    Made plotAstrometry more like the older displayAstrometry by using the same
    symbols and colors.
    Modified displayAstrometry to show the matches by drawing a line connecting
    the source and reference object (like plotAstrometry).
</pre>
<h3><a name="9ca8c56c"/></a>9ca8c56c</h3>

<pre>
commit 9ca8c56c74e73cc69654cd8f24e447aab7b201b7
Author: Russell Owen <rowen@uw.edu>
Date:   Wed May 13 10:47:13 2015 -0700

    Moved setMatchDistance function and test here from meas_algorithms
    
    Added missing files.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_36"><a name="examples/rerun_wcs.py"/></a>examples/rerun_wcs.py</h1>

<h3 id="toc_37">Diff:</h3>

<pre>
                import os
                import sys
                import types
                from optparse import OptionParser
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#e760fc1d">e760fc1d</a> + import lsst.utils</div>
                import lsst.meas.astrom as measAstrom
                import lsst.pex.policy  as pexPolicy
                import lsst.pex.logging as pexLog
                import lsst.daf.persistence              as dafPersist
                import lsst.daf.base                     as dafBase
                import lsst.afw.image                    as afwImage
                import lsst.afw.detection                as afwDet
                
                import lsst.meas.astrom.net as astromNet
                #import lsst.meas.astrom.wcsPlots as wcsPlots
                import lsst.meas.photocal as photocal
                
                from astrometry.util.pyfits_utils import *
                from numpy import array
                
                from sourceset_boost_to_fits import *
                
                class ducky(object):
                    def __str__(self):
                        return 'ducky: ' + '; '.join([''+str(k)+'='+str(v) for k,v in self.__dict__.items()])
                
                class fakeExposure(ducky):
                    def __init__(self):
                        self.wcs = None
                        self.width, self.height = None,None
                        self.xy0 = None
                        self.filterName = None
                
                    def getMaskedImage(self):
                        fakey = ducky()
                        fakey.xy0 = self.xy0
                        fakey.getXY0 = lambda x: x.xy0
                        return fakey
                
                    def getFilter(self):
                        fakey = ducky()
                        fakey.filterName = self.filterName
                        # advanced duck-typing: here we give the duck a member function "getName()"
                        fakey.getName = types.MethodType(lambda x: x.filterName, fakey, fakey.__class__)
                        return fakey
                
                    def getWcs(self):
                        return self.wcs
                    def setWcs(self, wcs):
                        self.wcs = wcs
                    def hasWcs(self):
                        return self.wcs is not None
                
                    def getWidth(self):
                        return self.width
                    def setWidth(self, width):
                        self.width = width
                
                    def getHeight(self):
                        return self.height
                    def setHeight(self, height):
                        self.height = height
                        
                
                
                def rerun(sourceset, policy=None, exposure=None, wcs=None,
                          W=None, H=None, xy0=None, filtername=None, log=None, fieldname=None,
                          plotprefix='', outwcsfn='out.wcs'):
                
                    if exposure is None:
                        # Create a duck of the appropriate quackiness.
                        exposure = fakeExposure()
                        exposure.xy0 = xy0
                        exposure.filterName = filtername
                
                    if wcs is not None:
                        exposure.setWcs(wcs)
                    if W is not None:
                        exposure.setWidth(W)
                    if H is not None:
                        exposure.setHeight(H)
                
                    if policy is None:
                        policy = pexPolicy.Policy.createPolicy(pexPolicy.PolicyString(
                            '''#<?cfg paf policy?>
                            matchThreshold: 30
                            numBrightStars: 1000
                            blindSolve: true
                            distanceForCatalogueMatchinArcsec: 5
                            cleaningParameter: 3
                            calculateSip: True
                            sipOrder: 2'''))
                
                    if exposure.getWidth() is None or exposure.getHeight() is None:
                        print 'Warning: exposure image width or height is None'
                
                    doTrim = False
                
                    print 'Exposure:', exposure
                    print 'Filter:', exposure.getFilter()
                    print 'Filter name:', exposure.getFilter().getName()
                    print
                    print 'determineWcs()...'
                    print
                
                    # *sigh*.
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
107  <a href="#f0f57818">f0f57818</a> -     path=os.path.join(os.environ['ASTROMETRY_NET_DATA_DIR'], "metadata.paf")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
108  <a href="#dca5406d">dca5406d</a> +     anDir = lsst.utils.getPackageDir('astrometry_net_data')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
109  <a href="#dca5406d">dca5406d</a> +     path=os.path.join(anDir, "metadata.paf")</div>
                    solver = astromNet.GlobalAstrometrySolution(path, log)
                    matchThreshold = policy.get('matchThreshold')
                    solver.setMatchThreshold(matchThreshold)
                
                    (matchList,wcs,refstars,plots) = measAstrom.determineWcs(policy, exposure, sourceset, log=log,
                                                                              doTrim=doTrim, solver=solver,
                                                                              returnRefStars=True,
                                                                              returnPlotData=True, plotFormat='png')
                
                    print
                    print 'determineWcs() finished.  Got:'
                    print
                    if wcs is None:
                        print 'WCS determination failed.'
                    else:
                        print '%i matches' % len(matchList)
                
                        for sm in matchList:
                            print '  (%.1f, %.1f) flux %.3g   ---   (%.1f, %.1f) flux %.3g' % (
                                sm.first.getXAstrom(), sm.first.getYAstrom(), sm.first.getPsfFlux(),
                                sm.second.getXAstrom(), sm.second.getYAstrom(), sm.second.getPsfFlux())
                
                        fitshdr = wcs.getFitsMetadata()
                        print 'Found WCS:'
                        print fitshdr.toString()
                
                        # No dice: daf_persistence can't write PropertySets to FITS.
                        if False:
                            loc = dafPersist.LogicalLocation(outfn)
                            storageList = dafPersist.StorageList()
                            additionalData = dafBase.PropertySet()
                            persistence = dafPersist.Persistence.getPersistence(pexPolicy.Policy())
                            storageList.append(persistence.getPersistStorage("FitsStorage", loc))
                            persistence.persist(fitshdr, storageList, additionalData)
                            
                        # Add IMAGEW, IMAGEH header cards.
                        fitshdr.add('IMAGEW', W)
                        fitshdr.add('IMAGEH', H)
                
                        # Create a fake Image in order to abuse its writeFits() method.
                        im = afwImage.ImageF()
                        im.writeFits(outwcsfn, fitshdr)
                
                    # Do photocal too.
                    print 'Doing photocal...'
                    magObj = photocal.calcPhotoCal(matchList, log=log, goodFlagValue=0)
                    print 'got:', magObj
                
                    import lsst.meas.astrom.wcsPlots as wcsPlots
                    wcsPlots.plotPhotometry(sourceset, refstars, matchList, prefix='photocal',
                                            saveplot=True)
                    from pylab import axis,plot,savefig,title
                    ax = axis()
                    zp = magObj.getMag(1.)
                    print 'Zero-point:', zp
                    plot([ax[0], ax[1]], [ax[0]+zp, ax[1]+zp], 'b-')
                    axis(ax)
                    if fieldname is not None:
                        title(fieldname)
                    savefig(plotprefix + 'photocal-zp.png')
                
                    print 'plots:'
                    for k,v in plots.items():
                        print '  ',k,'len', len(v)
                        f = open(plotprefix + k, 'wb')
                        f.write(v)
                        f.close()
                
                
                def rerun_main(sysargs):
                    parser = OptionParser(usage='%prog [options] <*.boost or *.fits SourceSets>')
                    parser.add_option('-W', '--width', dest='width', type='int', help='Image width (pixels)')
                    parser.add_option('-H', '--height', dest='height', type='int', help='Image height (pixels)')
                    parser.add_option('-f', '--filter', dest='filter', help='Filter name')
                    parser.add_option('-p', '--prefix', dest='plotprefix', help='Plot filename prefix')
                    parser.add_option('-v', '--verbose', dest='verb', help='+verbose', action='store_true')
                    #parser.add_option('-x', '--x-column', dest='xcol', help='X column name (for FITS inputs)')
                    parser.set_defaults(width=None, height=None, filter=None, verb=False, plotprefix='')
                    opt,args = parser.parse_args(sysargs)
                    if len(args) == 0:
                        parser.print_help()
                        return -1
                
                    level = pexLog.Log.DEBUG if opt.verb else pexLog.Log.INFO
                    log = pexLog.Log(pexLog.Log.getDefaultLog(), "rerun-wcs", level);
                
                    for fn in args:
                        if fn.endswith('.boost'):
                            print 'Reading boost-format', fn
                            ss = sourceset_read_boost(fn)
                        else:
                            print 'Reading FITS-format', fn
                            T = fits_table(fn)
                            ss = afwDet.SourceSet()
                            C = T.columns()
                            # FITS -> Source.setXXX()
                            columnmap = { #'SourceId':'id',
                                          'XAstrom':'x',
                                          'YAstrom':'y',
                                          'XAstromErr': 'xerr',
                                          'YAstromErr': 'yerr',
                                          'Ra': 'ra',
                                          'Dec': 'dec',
                                          'Ixx': 'ixx',
                                          'Iyy': 'iyy',
                                          'PsfFlux': 'f_psf',
                                          'ApFlux': 'f_ap',
                                          }
                            for k,v in columnmap.items():
                                if not v in C:
                                    print 'Warning, column', v, 'is not in the FITS table -- won\'t set Source\'s', k
                            for i in range(len(T)):
                                src = afwDet.Source()
                                ss.append(src)
                            for k,v in columnmap.items():
                                if not v in C:
                                    continue
                                for src,val in zip(ss, T.getcolumn(v)):
                                    getattr(src, 'set'+k)(val)
                
                        print 'Read %i sources' % (len(ss))
                        #if opt.verb:
                        #    for i in range(100):
                        #        print '  (%.1f, %.1f) psf flux %.1f' % (ss[i].getXAstrom(), ss[i].getYAstrom(), ss[i].getPsfFlux())
                                                
                        rerun(ss, W=opt.width, H=opt.height, filtername=opt.filter, log=log, fieldname=fn,
                              plotprefix=opt.plotprefix)
                        return 0
                    
                if __name__ == '__main__':
                    sys.exit(rerun_main(sys.argv))
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="f0f57818"/></a>f0f57818</h3>

<pre>
commit f0f57818f06badf9d4f764ec728e5b63b3a07e03
Author: dstn <dstn@git.lsstcorp.org>
Date:   Thu Mar 17 20:13:47 2011 +0000

    sourceset to fits: don't write object columns; write columns in sorted order
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="e760fc1d"/></a>e760fc1d</h3>

<pre>
commit e760fc1d89c17be9c8a4beee25b3fca6ac2ca67f
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:34:29 2015 -0700

    skip tests/examples if eups is not present
</pre>
<h3><a name="dca5406d"/></a>dca5406d</h3>

<pre>
commit dca5406d4f69a6ffdec97d87ba9a0c51853991e7
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:29:55 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_38"><a name="include/lsst/meas/astrom/detail/utils.h"/></a>include/lsst/meas/astrom/detail/utils.h</h1>

<h3 id="toc_39">Diff:</h3>

<pre>
                #if !defined(LSST_MEAS_ASTROM_UTILS_H)
                #define LSST_MEAS_ASTROM_UTILS_H 1
                
                #include <string>
                #include <vector>
                
                #include "lsst/afw/table/Source.h"
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
8    <a href="#eb937b8d">eb937b8d</a> + #include "lsst/afw/coord.h"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
9    <a href="#eb937b8d">eb937b8d</a> + #include "lsst/afw/geom.h"</div>
                
                namespace lsst {
                namespace meas {
                namespace astrom {
                namespace detail {
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
14   <a href="#753b5513">753b5513</a> -     typedef struct {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
15   <a href="#753b5513">753b5513</a> -         std::string name;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#753b5513">753b5513</a> -         std::string magcol;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#753b5513">753b5513</a> -         std::string magerrcol;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
16   <a href="#eb937b8d">eb937b8d</a> +     struct MagColInfo {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
17   <a href="#eb937b8d">eb937b8d</a> +         std::string filterName; ///< name of filter</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
18   <a href="#eb937b8d">eb937b8d</a> +         std::string magCol;     ///< name of magnitude column</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
19   <a href="#eb937b8d">eb937b8d</a> +         std::string magErrCol;  ///< name of magnitude sigma column</div>
                
                        bool hasErr() const {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
20   <a href="#9e8b4e03">9e8b4e03</a> -             return (magerrcol.size() > 0);</div>
              ?                    ^   ^  ^   ---  -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#eb937b8d">eb937b8d</a> +             return !magErrCol.empty();</div>
              ?                    ^   ^  ^    ++++
                        }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
22   <a href="#753b5513">753b5513</a> -     } mag_column_t;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#eb937b8d">eb937b8d</a> +     };</div>
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#c6797ad3">c6797ad3</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
27   <a href="#c6797ad3">c6797ad3</a> + /// RAII manager for astrometry.net indices</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#c6797ad3">c6797ad3</a> + ///</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#c6797ad3">c6797ad3</a> + /// Ensures index files are closed when done, to prevent "Too many open files" errors.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#c6797ad3">c6797ad3</a> + /// See also #2292, #2879.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#c6797ad3">c6797ad3</a> + struct IndexManager {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#c6797ad3">c6797ad3</a> +     index_t* index;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#c6797ad3">c6797ad3</a> +     IndexManager(index_t* ind) : index(ind) {}</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#c6797ad3">c6797ad3</a> +     ~IndexManager() {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#c6797ad3">c6797ad3</a> +         // Change once astrometry.net-0.40+ is in...</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#c6797ad3">c6797ad3</a> +         /*</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#c6797ad3">c6797ad3</a> +           if (index_close_fds(ind)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#3896b32c">3896b32c</a> +           throw LSST_EXCEPT(lsst::pex::exceptions::IoError,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#c6797ad3">c6797ad3</a> +           "Failed to index_close_fds() an astrometry_net_data file");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#c6797ad3">c6797ad3</a> +           }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
41   <a href="#c6797ad3">c6797ad3</a> +         */</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
42   <a href="#44de8a4d">44de8a4d</a> +         if (index->quads && index->quads->fb && index->quads->fb->fid) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
43   <a href="#44de8a4d">44de8a4d</a> +             _close(index->quads->fb->fid);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#44de8a4d">44de8a4d</a> +         }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#44de8a4d">44de8a4d</a> +         if (index->codekd && index->codekd->tree && index->codekd->tree->io) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#44de8a4d">44de8a4d</a> +             _close(index->codekd->tree->io);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
47   <a href="#44de8a4d">44de8a4d</a> +         }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
48   <a href="#44de8a4d">44de8a4d</a> +         if (index->starkd && index->starkd->tree && index->starkd->tree->io) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#44de8a4d">44de8a4d</a> +             _close(index->starkd->tree->io);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#44de8a4d">44de8a4d</a> +         }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#c6797ad3">c6797ad3</a> +     }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#c6797ad3">c6797ad3</a> +     void _close(FILE* & fid) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#c6797ad3">c6797ad3</a> +         if (fid) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
54   <a href="#c6797ad3">c6797ad3</a> +             if (fclose(fid)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#c6797ad3">c6797ad3</a> +                 std::cerr << "Error closing an astrometry_net_data quadfile" << std::endl;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#c6797ad3">c6797ad3</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#c6797ad3">c6797ad3</a> +             fid = NULL;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#c6797ad3">c6797ad3</a> +         }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#c6797ad3">c6797ad3</a> +     }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#c6797ad3">c6797ad3</a> +     void _close(void* io) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#c6797ad3">c6797ad3</a> +         _close(reinterpret_cast<kdtree_fits_t*>(io)->fid);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#c6797ad3">c6797ad3</a> +     }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#c6797ad3">c6797ad3</a> + };</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#c6797ad3">c6797ad3</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#22f92e11">22f92e11</a> - /*</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
65   <a href="#eb937b8d">eb937b8d</a> + /**</div>
              ?   +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#82b8e761">82b8e761</a> -  * Implementation for index_t::getCatalog method</div>
              ? ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#eb937b8d">eb937b8d</a> + Implementation for index_t::getCatalog method</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#c6797ad3">c6797ad3</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#eb937b8d">eb937b8d</a> + @param[in] inds  star kd-trees from astrometry.net</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#eb937b8d">eb937b8d</a> + @param[in] ctrCoord  center of search region</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#eb937b8d">eb937b8d</a> + @param[in] radius  search radius</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#eb937b8d">eb937b8d</a> + @param[in] idCol  name of ID column in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#eb937b8d">eb937b8d</a> + @param[in] magColInfoList  list of information about magnitude columns in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#eb937b8d">eb937b8d</a> + @param[in] starGalCol  name of "starGal" column (true if object is a star) in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#eb937b8d">eb937b8d</a> + @param[in] varCol  name of "var" column (true if brightness is variable) in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#eb937b8d">eb937b8d</a> + @param[in] uniqueIds  if true then only return unique IDs (the first of each seen)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
76   <a href="#c6797ad3">c6797ad3</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
77   <a href="#27598add">27598add</a> + Returned schema:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
78   <a href="#eb937b8d">eb937b8d</a> + - id</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
79   <a href="#eb937b8d">eb937b8d</a> + - coord: sky position (an lsst::afw::coord::IcrsCoord)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
80   <a href="#eb937b8d">eb937b8d</a> + - centroid: centroid on some exposure, if relevant (an lsst::afw::geom::Point2D); returned value is not set</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
81   <a href="#eb937b8d">eb937b8d</a> + - hasCentroid: if true then centroid has been set; returned value is false</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
82   <a href="#eb937b8d">eb937b8d</a> + - *filterName*_flux: flux in the specified filter (double)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
83   <a href="#eb937b8d">eb937b8d</a> + - *filterName*_fluxSigma: flux uncertainty in the specified filter (double)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
84   <a href="#eb937b8d">eb937b8d</a> + - resolved (if starGalCol specified): true if object is not resolved</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#eb937b8d">eb937b8d</a> + - variable (if varCol specified): true if brightness is variable</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#eb937b8d">eb937b8d</a> + - photometric: true if not resolved (or starGalCol blank) and not variable (or varCol blank);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
87   <a href="#eb937b8d">eb937b8d</a> +     note that if starGalCol and varCol both blank then all objects are claimed to be photometric</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
26   <a href="#22f92e11">22f92e11</a> -  */</div>
              ? -
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
88   <a href="#eb937b8d">eb937b8d</a> + */</div>
                lsst::afw::table::SimpleCatalog
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#22f92e11">22f92e11</a> - getCatalogImpl(std::vector<index_t*> inds,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#9e8b4e03">9e8b4e03</a> -                double ra, double dec, double radius,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#eb937b8d">eb937b8d</a> + getCatalogImpl(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#eb937b8d">eb937b8d</a> +     std::vector<index_t*> inds,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#eb937b8d">eb937b8d</a> +     lsst::afw::coord::Coord const &ctrCoord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
93   <a href="#eb937b8d">eb937b8d</a> +     lsst::afw::geom::Angle const &radius,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
30   <a href="#9e8b4e03">9e8b4e03</a> -                const char* idcol,</div>
              ? -----------                  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
94   <a href="#eb937b8d">eb937b8d</a> +     const char* idCol,</div>
              ?                   ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
31   <a href="#9e8b4e03">9e8b4e03</a> -                std::vector<mag_column_t> const& magcols,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
95   <a href="#eb937b8d">eb937b8d</a> +     std::vector<MagColInfo> const& magColInfoList,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#9e8b4e03">9e8b4e03</a> -                const char* stargalcol,</div>
              ? -----------                    ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
96   <a href="#eb937b8d">eb937b8d</a> +     const char* starGalCol,</div>
              ?                     ^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#9e8b4e03">9e8b4e03</a> -                const char* varcol,</div>
              ? -----------                   ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
97   <a href="#eb937b8d">eb937b8d</a> +     const char* varCol,</div>
              ?                    ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#9e8b4e03">9e8b4e03</a> -                bool unique_ids);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
98   <a href="#27598add">27598add</a> +     bool uniqueIds=true);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#eb937b8d">eb937b8d</a> + </div>
                }}}}
                #endif
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="22f92e11"/></a>22f92e11</h3>

<pre>
commit 22f92e118c532d1c1fa29d77660b79c4185fad1f
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 09:42:19 2012 -0400

    Restructure things to move getCatalogImpl out of the .i file
</pre>
<h3><a name="753b5513"/></a>753b5513</h3>

<pre>
commit 753b5513d6a07c53a2ac2e431102eaa5e68fe1bc
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Sep 11 15:36:20 2012 -0400

    Add a test for the multi-mag reference source retrieval API.
    
    Clean up the way multi-mags are requested, and make the schema's names match the LSST-canonical filter names,
    rather than the Astrometry.net column names (which usually match, but only by convention)
</pre>
<h3><a name="9e8b4e03"/></a>9e8b4e03</h3>

<pre>
commit 9e8b4e037273308dd79594753c4298079c2617d5
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Tue Aug 6 14:39:02 2013 +0900

    untabify 2 examples, utils.{cc,h} and *.i
</pre>
<h3><a name="82b8e761"/></a>82b8e761</h3>

<pre>
commit 82b8e76170d0e6f87e137205b70c18a17c1353d4
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 16 11:02:13 2014 -0500

    Use multiindex unload/reload; python RAII
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="c6797ad3"/></a>c6797ad3</h3>

<pre>
commit c6797ad3909ed0210ff88d7050ba129677e8b167
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu May 30 01:56:33 2013 +0900

    use RAII for index loading/closing (#2879)
    
    When loading indices (when solving, or just reading a catalog)
    one can quickly run out of open file descriptors if not careful.
    To ensure we don't, use an RAII object ("IndexManager") on the
    indices so that files are closed whenever they go out of scope
    (exception, looping, etc).
    
    This replaces the fix to addIndices from #2292 with a more
    complete solution, and applies it also to getCatalogImpl, which
    was discovered to have the same problem in #2879.
</pre>
<h3><a name="44de8a4d"/></a>44de8a4d</h3>

<pre>
commit 44de8a4dd2f51aacafef812f6e377143475b367f
Author: Paul Price <price@astro.princeton.edu>
Date:   Wed Jul 17 14:15:33 2013 -0400

    IndexManager: guard against null dereference
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
<h3><a name="27598add"/></a>27598add</h3>

<pre>
commit 27598addd6fafc95781ad3a3dcc4dd87ab723470
Author: Russell Owen <rowen@uw.edu>
Date:   Wed Apr 15 05:30:42 2015 -0700

    Remove the getNewSchema argument from getCatalog
    
    Modified getCatalog and getCatalogImpl to always return the new schema.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_40"><a name="include/lsst/meas/astrom/sip/LeastSqFitter1d.h"/></a>include/lsst/meas/astrom/sip/LeastSqFitter1d.h</h1>

<h3 id="toc_41">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                
                /* 
                 * LSST Data Management System
                 * Copyright 2008, 2009, 2010 LSST Corporation.
                 * 
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
                 * 
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
                 * 
                 * You should have received a copy of the LSST License Statement and 
                 * the GNU General Public License along with this program.  If not, 
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
                 
                
                #ifndef LEAST_SQ_FITTER_1D
                #define LEAST_SQ_FITTER_1D
                
                #include <cstdio>
                #include <vector>
                
                #include "boost/shared_ptr.hpp"
                #include "Eigen/Core"
                #include "Eigen/SVD"
                
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/pex/logging/Trace.h"
                #include "lsst/afw/math/FunctionLibrary.h"
                
                namespace except = lsst::pex::exceptions;
                namespace pexLogging = lsst::pex::logging;
                
                
                namespace lsst { 
                namespace meas { 
                namespace astrom { 
                namespace sip {
                
                /**
                \brief Fit an lsst::afw::math::Function1 object to a set of data points in one dimension
                
                The class is templated over the kind of object to fit. 
                
                Input is a list of x ordinates for a set of points, the y coordinate, and the uncertainties, s.
                order is order of the polynomial to fit (e.g if the templated function is 
                lsst::afw::math::PolynomialFunction1, then order=3 => fit a function of the form \f$ax^2+bx+c\f$
                
                \tparam FittingFunc The 1d function to fit in both dimensions. Must inherit from 
                lsst::afw::math::Function1 
                
                \param x Ordinate of points to fit
                \param y Co-ordinate of pionts to fit
                \param s 1\f$\sigma\f$ uncertainties in z
                \param order Polynomial order to fit
                
                \sa LeastSqFitter1d
                */
                
                template <class FittingFunc>class LeastSqFitter1d {
                public:
                    LeastSqFitter1d(const std::vector<double> &x, const std::vector<double> &y, 
                                    const std::vector<double> &s,  
                                    unsigned int order);
                
                    Eigen::VectorXd getParams();
                    Eigen::VectorXd getErrors();
                    FittingFunc getBestFitFunction();
                    double valueAt(double x);
                    std::vector<double> residuals();
                    
                    double getChiSq();
                    double getReducedChiSq();
                
                    
                private:
                    void initFunctions();
                
                    double func1d(double value, int exponent);
                    
                    std::vector<double> _x, _y, _s;
                    int _order;   //Degree of polynomial to fit, e.g 4=> cubic
                    int _nData;   //Number of data points, == _x.size()
                    
                    Eigen::JacobiSVD<Eigen::MatrixXd> _svd;
                    Eigen::VectorXd _par;
                
                    std::vector<boost::shared_ptr<FittingFunc> > _funcArray;
                };
                
                //The .cc part
                
                ///Fit a 1d polynomial to a set of data points z(x, y)
                ///
                ///\tparam FittingFunc  The type of function to fit. This function extends the base
                ///       class of lsst::afw::math::Function1
                ///\param x vector of x positions of data
                ///\param y vector of y positions of data
                ///\param s Vector of measured uncertainties in the values of z
                ///\param order Order of 2d function to fit
                template<class FittingFunc> LeastSqFitter1d<FittingFunc>::LeastSqFitter1d(const std::vector<double> &x, 
                    const std::vector<double> &y, const std::vector<double> &s, unsigned int order) :
                    _x(x), _y(y), _s(s), _order(order) {
                    
                    if (order == 0) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#b17840b5">b17840b5</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "Fit order must be >= 1");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
115  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "Fit order must be >= 1");        </div>
                    }
                    
                    _nData = _x.size();
                    if  (_nData != static_cast<int>(_y.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#b17840b5">b17840b5</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "x and y vectors of different lengths");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
120  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "x and y vectors of different lengths");        </div>
                    }
                    if (_nData != static_cast<int>(_s.size())) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#b17840b5">b17840b5</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "x and s vectors of different lengths");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
123  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "x and s vectors of different lengths");        </div>
                    }
                
                    if (_nData < _order) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#b17840b5">b17840b5</a> -         throw LSST_EXCEPT(except::RuntimeErrorException, "Fewer data points than parameters");        </div>
              ?                                               ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
127  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::RuntimeError, "Fewer data points than parameters");        </div>
                    }
                
                    initFunctions();
                
                    Eigen::MatrixXd design(_nData, _order);
                    Eigen::VectorXd rhs(_nData);
                    for (int i = 0; i < _nData; ++i) {
                        rhs[i] = y[i] / _s[i];
                        for (int j = 0; j < _order; ++j) {
                            design(i, j) = func1d(_x[i], j) / _s[i];
                        }
                    }
                    _svd.compute(design, Eigen::ComputeThinU | Eigen::ComputeThinV);
                    _par = _svd.solve(rhs);
                }
                        
                
                
                ///Return the best fit parameters as an Eigen::Matrix
                template<class FittingFunc> Eigen::VectorXd LeastSqFitter1d<FittingFunc>::getParams() {
                
                    Eigen::VectorXd vec = Eigen::VectorXd::Zero(_order);
                    for (int i = 0; i < _order; ++i) {
                        vec(i) = _par(i);
                    }
                    return vec;
                }
                
                
                ///Return the 1 sigma uncertainties in the best fit parameters as an Eigen::Matrix
                template<class FittingFunc> Eigen::VectorXd LeastSqFitter1d<FittingFunc>::getErrors() {
                    Eigen::ArrayXd variance(_order);
                    for (int i = 0; i < _order; ++i) {
                        variance[i] = _svd.matrixV().row(i).dot(
                            (_svd.singularValues().array().inverse().square() * _svd.matrixV().col(i).array()).matrix()
                        );
                    }
                    return variance.sqrt().matrix();
                }
                
                
                ///Return the best fit polynomial as a lsst::afw::math::Function1 object
                template<class FittingFunc> FittingFunc LeastSqFitter1d<FittingFunc>::getBestFitFunction() {
                
                    //FittingFunc and LeastSqFitter disagree on the definition of order of a function.
                    //LSF says that a linear function is order 2 (two coefficients), FF says only 1
                    FittingFunc func(_order - 1);
                
                    for (int i = 0; i < _order; ++i) {
                        func.setParameter(i, _par(i));
                    }
                    return func;
                }
                
                
                ///Calculate the value of the function at a given point
                template<class FittingFunc> double LeastSqFitter1d<FittingFunc>::valueAt(double x) {
                        FittingFunc f = getBestFitFunction();
                        
                        return f(x);
                }
                
                
                
                ///Return a vector of residuals of the fit (i.e the difference between the input y values, and 
                ///the value of the fitting function at that point.
                template<class FittingFunc>  std::vector<double> LeastSqFitter1d<FittingFunc>::residuals(){
                    std::vector<double> out;
                    out.reserve(_nData);
                    
                    FittingFunc f = getBestFitFunction();
                    
                    for (int i = 0; i < _nData; ++i) {
                        out.push_back(_y[i] - f(_x[i]));
                    }
                    
                    return out;
                }
                
                
                /// \brief Return a measure of the goodness of fit. 
                /// \f[ \chi_r^2 = \sum \left( \frac{y_i - f(x_i)}{s} \right)^2 \f]
                /// 
                template<class FittingFunc> double LeastSqFitter1d<FittingFunc>::getChiSq() {
                    FittingFunc f = getBestFitFunction();
                
                    double chisq = 0;
                    for (int i = 0; i < _nData; ++i) {
                        double val = _y[i] - f(_x[i]);
                        val /= _s[i];
                        chisq += pow(val, 2);
                    }
                
                    return chisq;
                }
                
                
                /// \brief Return a measure of the goodness of fit. 
                /// \f[ \chi_r^2 = \sum \left( \frac{y_i - f(x_i)}{s} \right)^2 \div (N-p) \f]
                /// Where \f$ N \f$ is the number of data points, and \f$ p \f$ is the number 
                /// of parameters in the fit
                /// 
                template<class FittingFunc> double LeastSqFitter1d<FittingFunc>::getReducedChiSq() {
                    return getChiSq()/(double) (_nData - _order);
                }
                
                
                
                /// Initialise the array of functions. _funcArray[i] is a object of type math::Function1 of order 
                ///_norder
                template<class FittingFunc> void LeastSqFitter1d<FittingFunc>::initFunctions() {
                
                    _funcArray.reserve(_order);
                    
                    std::vector<double> coeff;
                    coeff.reserve( _order);
                    
                    coeff.push_back(1.0);
                    for (int i = 0; i < _order; ++i) {
                        boost::shared_ptr<FittingFunc> p(new FittingFunc(coeff));
                        _funcArray.push_back(p);
                        coeff[i] = 0.0;
                        coeff.push_back(1.0);  //coeff now looks like [0,0,...,0,1]
                    }
                }
                    
                template<class FittingFunc> double LeastSqFitter1d<FittingFunc>::func1d(double value, int exponent) {
                    return (*_funcArray[exponent])(value);
                }
                
                }}}}
                
                #endif
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="b17840b5"/></a>b17840b5</h3>

<pre>
commit b17840b596eb15b55971904d9864365ff95c9005
Author: fergal <fergal@git.lsstcorp.org>
Date:   Wed Sep 30 18:55:35 2009 +0000

    get functions now return the things they should return instead of boost::shared_ptrs to those things, making the code easier to understand .
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_42"><a name="tests/ticket1979.py"/></a>tests/ticket1979.py</h1>

<h3 id="toc_43">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
25   <a href="#ee9b87c5">ee9b87c5</a> - import re</div>
                import os
                import sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
28   <a href="#ee9b87c5">ee9b87c5</a> - import glob</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#ee9b87c5">ee9b87c5</a> - import math</div>
                import unittest
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#7c80bc64">7c80bc64</a> + from lsst.afw.coord import IcrsCoord</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#ee9b87c5">ee9b87c5</a> - import numpy as np</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
33   <a href="#ee9b87c5">ee9b87c5</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#ee9b87c5">ee9b87c5</a> - import eups</div>
                import lsst.meas.astrom            as measAstrom
                import lsst.utils.tests            as utilsTests
                import lsst.afw.geom as afwGeom
                from lsst.pex.logging import Log
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#e760fc1d">e760fc1d</a> + try:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#e760fc1d">e760fc1d</a> +     import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#e760fc1d">e760fc1d</a> + except ImportError:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
38   <a href="#e760fc1d">e760fc1d</a> +     print "warning: import of eups failed; tests will be skipped"</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
39   <a href="#e760fc1d">e760fc1d</a> +     sys.exit(0)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
40   <a href="#e760fc1d">e760fc1d</a> + </div>
                class MultipleCatalogStarsTest(unittest.TestCase):
                
                    def setUp(self):
                        # Set up local astrometry_net_data
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
44   <a href="#ee9b87c5">ee9b87c5</a> -         mypath = eups.productDir("meas_astrom")</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#ed649ff6">ed649ff6</a> +         testDir=os.path.dirname(__file__)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
45   <a href="#ee9b87c5">ee9b87c5</a> -         datapath = os.path.join(mypath, 'tests', 'astrometry_net_data', 'photocal')</div>
              ?                                 ---------    ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
46   <a href="#ed649ff6">ed649ff6</a> +         datapath = os.path.join(testDir, 'astrometry_net_data', 'photocal')</div>
              ?                                     ^^^
                        eupsObj = eups.Eups(root=datapath)
                        ok, version, reason = eupsObj.setup('astrometry_net_data')
                        if not ok:
                            raise ValueError("Need photocal version of astrometry_net_data (from path: %s): %s" %
                                             (datapath, reason))
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#ee9b87c5">ee9b87c5</a> -         self.conf = measAstrom.MeasAstromConfig()</div>
              ?                                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
53   <a href="#7c80bc64">7c80bc64</a> +         self.conf = measAstrom.ANetBasicAstrometryConfig()</div>
              ?                                ^^ ++  ++      ++++
                        # Load andConfig2.py rather than the default.
                        confpath = os.path.join(datapath, 'andConfig2.py')
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#ee9b87c5">ee9b87c5</a> -         self.andconf = measAstrom.AstrometryNetDataConfig()</div>
              ?                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#ed649ff6">ed649ff6</a> +         self.andConfig = measAstrom.AstrometryNetDataConfig()</div>
              ?                 ^   ++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
56   <a href="#ee9b87c5">ee9b87c5</a> -         self.andconf.load(confpath)</div>
              ?                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#ed649ff6">ed649ff6</a> +         self.andConfig.load(confpath)</div>
              ?                 ^   ++
                
                    def tearDown(self):
                        del self.conf
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#f67a51eb">f67a51eb</a> -         import lsst.meas.astrom.astrometry_net as an</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
61   <a href="#f67a51eb">f67a51eb</a> -         an.finalize()</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#ee9b87c5">ee9b87c5</a> -     def testGetCatalog(self, loglvl=Log.DEBUG):</div>
              ?                                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
62   <a href="#ed649ff6">ed649ff6</a> +     def testGetCatalog(self, logLevel=Log.DEBUG):</div>
              ?                                 ^^ +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#ee9b87c5">ee9b87c5</a> -         astrom = measAstrom.Astrometry(self.conf, andConfig=self.andconf, logLevel=loglvl)</div>
              ?                                                                     ^   ^^^^ ------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
63   <a href="#ed649ff6">ed649ff6</a> +         astrom = measAstrom.ANetBasicAstrometryTask(self.conf, andConfig=self.andConfig)</div>
              ?                              +++++++++         ++++                              ^   ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
64   <a href="#ed649ff6">ed649ff6</a> +         astrom.log.setThreshold(logLevel)</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#ee9b87c5">ee9b87c5</a> -         cat = astrom.getReferenceSources(215.6 * afwGeom.degrees,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#ee9b87c5">ee9b87c5</a> -                                          53.0 * afwGeom.degrees,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#ee9b87c5">ee9b87c5</a> -                                          0.1 * afwGeom.degrees,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#ee9b87c5">ee9b87c5</a> -                                          'z')</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
66   <a href="#7c80bc64">7c80bc64</a> +         ctrCoord = IcrsCoord(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
67   <a href="#7c80bc64">7c80bc64</a> +             215.6 * afwGeom.degrees,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
68   <a href="#7c80bc64">7c80bc64</a> +             53.0 * afwGeom.degrees,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
69   <a href="#7c80bc64">7c80bc64</a> +         )</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
70   <a href="#7c80bc64">7c80bc64</a> +         cat = astrom.refObjLoader.loadSkyCircle(</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#7c80bc64">7c80bc64</a> +             ctrCoord = ctrCoord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#7c80bc64">7c80bc64</a> +             radius = 0.1 * afwGeom.degrees,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#7c80bc64">7c80bc64</a> +             filterName = 'z',</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#7c80bc64">7c80bc64</a> +         ).refCat</div>
                        print 'Got', len(cat), 'reference sources'
                
                        ids = set(s.getId() for s in cat)
                        print len(ids), 'unique IDs'
                        ras = set(s.getRa() for s in cat)
                        print len(ras), 'unique RAs'
                        
                
                        ids = set()
                        for src in cat:
                            sid = src.getId()
                            if sid in ids:
                                print 'Source id', sid, 'is duplicated'
                            self.assertFalse(sid in ids)
                            ids.add(sid)
                            
                            
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(MultipleCatalogStarsTest)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="ee9b87c5"/></a>ee9b87c5</h3>

<pre>
commit ee9b87c5cece459380b24afaf925ddf0d9f7b441
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Mon Mar 12 16:22:15 2012 -0500

    add failing test
</pre>
<h3><a name="f67a51eb"/></a>f67a51eb</h3>

<pre>
commit f67a51eb469d3c88b43eea936d66cc6195d33cb0
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Dec 5 13:44:35 2012 -0500

    Rather than a global struct, just make a global PTR(Log); rename stop_an_logging() to finalize()
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
<h3><a name="ed649ff6"/></a>ed649ff6</h3>

<pre>
commit ed649ff66faa3f972f01da91718fe32e077f21f9
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Apr 16 08:19:54 2015 -0700

    Refactored ANetBasicAstrometry
    
    ANetBasicAstrometryTask cleanups:
    - removed a lot of code that was duplicated in refObjLoader
    - make it a Task, since it was acting just like one anyway;
      one side effect is that the constructor no longer takes logLevel as an argument,
      so I had to change a few unit tests acccordingly.
    - use bbox as an argument instead of x0, y0, imageSize
    - _getImageParams returns wcs (as it surely must have done earlier,
        since wcs was an argument)
    - standardize formatting of config parameters
    - clean up some of the documentation
    
    Also set ANetBasicAstrometryConfig.badFlags to a useful default,
    though naturally it is one that requires the new source table schema.
    
    Test cleanups:
    - Updated unit tests so all tables have the new schema, including
      a CR flag that was missing (though it is alway set False).
    - One set of test data was in examples, rather than tests; I moved that
      and updated the one example that used it.
    - Removed several test data files that were not being used
    - Added a test of AstrometryTask for config.forceKnownWcs True
    - Updated unit tests to handle log level differently (since ordinary tasks
      do not accept that as a constructor argument).
    
    Fix a bug in AstrometryTask triggered by forceKnownWcs
    
    AstrometryTask's iteration was incorrect if forceKnownWcs True,
    and a log message would raise an exception because scatterOnSky unknown.
    Also I adde config parameter maxIter to control iteration.
    
    Set ANetBasicAstrometryConfig.badFlags to a useful default
    
    Add base_PixelFlags_flag_crCenter to test source catalogs
    
    Update test catalogs to include field base_PixelFlags_flag_crCenter
    (since it is used, by default, for astrometry).
    Also move some test files from examples
    and update the way tests find data files.
    
    Remove a few unused test data files
    
    Fix a bug with forceKnownWcs and test that case
</pre>
<h3><a name="e760fc1d"/></a>e760fc1d</h3>

<pre>
commit e760fc1d89c17be9c8a4beee25b3fca6ac2ca67f
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:34:29 2015 -0700

    skip tests/examples if eups is not present
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_44"><a name="examples/getSourceSet.py"/></a>examples/getSourceSet.py</h1>

<h3 id="toc_45">Diff:</h3>

<pre>
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import math, os, sys
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#63f12d6f">63f12d6f</a> - import eups</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
24   <a href="#a7e1c214">a7e1c214</a> + import lsst.utils</div>
                import lsst.pex.policy as policy
                import lsst.afw.detection as afwDetection
                import lsst.afw.geom as afwGeom
                import lsst.afw.image as afwImage
                import lsst.afw.math as afwMath
                import lsst.afw.display.ds9 as ds9
                import lsst.meas.algorithms as algorithms
                
                try:
                    type(display)
                except NameError:
                    display = False
                
                def detectFootprints(exposure, positiveThreshold, psf=None, negativeThreshold=None, npixMin=1):
                    """Detect sources above positiveThreshold in the provided exposure returning the
                    detectionSet.  Only sources with at least npixMin are considered
                
                    If negativeThreshold, return a pair of detectionSets, dsPositive, dsNegative
                    """
                
                    assert positiveThreshold or negativeThreshold # or both
                
                    if positiveThreshold:
                        positiveThreshold = afwDetection.Threshold(positiveThreshold)
                    if negativeThreshold:
                        negativeThreshold = afwDetection.Threshold(negativeThreshold)
                    #
                    # Unpack variables
                    #
                    maskedImage = exposure.getMaskedImage()
                
                    if not psf:                         # no need to convolve if we don't know the PSF
                        convolvedImage = maskedImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#a88a6910">a88a6910</a> -         goodBBox = maskedImage.getBBox(afwImage.PARENT)</div>
              ?                                        ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#77ecbec7">77ecbec7</a> +         goodBBox = maskedImage.getBBox()</div>
                    else:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#a88a6910">a88a6910</a> -         convolvedImage = maskedImage.Factory(maskedImage.getBBox(afwImage.PARENT))</div>
              ?                                                                  ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#77ecbec7">77ecbec7</a> +         convolvedImage = maskedImage.Factory(maskedImage.getBBox())</div>
                        
                        if display:
                            ds9.mtv(maskedImage)
                        # 
                        # Smooth the Image
                        #
                        psf.convolve(convolvedImage, 
                                     maskedImage, 
                                     convolvedImage.getMask().getMaskPlane("EDGE"))
                        #
                        # Only search psf-smooth part of frame
                        #
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#a88a6910">a88a6910</a> -         goodBBox = psf.getKernel().shrinkBBox(maskedImage.getBBox(afwImage.PARENT))</div>
              ?                                                                   ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#77ecbec7">77ecbec7</a> +         goodBBox = psf.getKernel().shrinkBBox(maskedImage.getBBox())</div>
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#a88a6910">a88a6910</a> -     middle = convolvedImage.Factory(convolvedImage, goodBBox, afwImage.PARENT)</div>
              ?                                                             -----------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
75   <a href="#77ecbec7">77ecbec7</a> +     middle = convolvedImage.Factory(convolvedImage, goodBBox)</div>
                
                    dsNegative = None 
                    if negativeThreshold != None:
                        #detect negative sources
                        dsNegative = afwDetection.makeDetectionSet(middle, negativeThreshold, "DETECTED_NEGATIVE", npixMin)
                        if not ds9.getMaskPlaneColor("DETECTED_NEGATIVE"):
                            ds9.setMaskPlaneColor("DETECTED_NEGATIVE", ds9.CYAN)
                
                    dsPositive = None
                    if positiveThreshold != None:
                        dsPositive = afwDetection.makeFootprintSet(middle, positiveThreshold, "DETECTED", npixMin)
                    #
                    # ds only searched the middle but it belongs to the entire MaskedImage
                    #
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#a88a6910">a88a6910</a> -     dsPositive.setRegion(maskedImage.getBBox(afwImage.PARENT))</div>
              ?                                              ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
90   <a href="#77ecbec7">77ecbec7</a> +     dsPositive.setRegion(maskedImage.getBBox())</div>
                    if dsNegative:
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#a88a6910">a88a6910</a> -         dsNegative.setRegion(maskedImage.getBBox(afwImage.PARENT))</div>
              ?                                                  ---------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#77ecbec7">77ecbec7</a> +         dsNegative.setRegion(maskedImage.getBBox())</div>
                    #
                    # We want to grow the detections into the edge by at least one pixel so that it sees the EDGE bit
                    #
                    grow, isotropic = 1, False
                    dsPositive = afwDetection.FootprintSetF(dsPositive, grow, isotropic)
                    dsPositive.setMask(maskedImage.getMask(), "DETECTED")
                
                    if dsNegative:
                        dsNegative = afwDetection.FootprintSetF(dsNegative, grow, isotropic)
                        dsNegative.setMask(maskedImage.getMask(), "DETECTED_NEGATIVE")
                    #
                    # clean up
                    #
                    del middle
                
                    if negativeThreshold:
                        if positiveThreshold:
                            return dsPositive, dsNegative
                        return dsPositive, dsNegative
                    else:
                        return dsPositive
                
                def detectSources(exposure, threshold, psf=None):
                    """Detect sources above positiveThreshold in the provided exposure returning the sourceList
                    """
                
                    if not psf:
                        FWHM = 5
                        psf = algorithms.createPSF("DoubleGaussian", 15, 15, FWHM/(2*math.sqrt(2*math.log(2))))
                
                    #
                    # Subtract background
                    #
                    mi = exposure.getMaskedImage()
                    bctrl = afwMath.BackgroundControl(afwMath.NATURAL_SPLINE);
                    bctrl.setNxSample(int(mi.getWidth()/256) + 1);
                    bctrl.setNySample(int(mi.getHeight()/256) + 1);
                    backobj = afwMath.makeBackground(mi.getImage(), bctrl)
                
                    img = mi.getImage(); img -= backobj.getImageF(); del img
                
                    if display:
                        ds9.mtv(exposure)
                
                    ds = detectFootprints(exposure, threshold)
                
                    objects = ds.getFootprints()
                    #
                    # Time to actually measure
                    #
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#dca5406d">dca5406d</a> +     measPipelineDir = lsst.utils.getPackageDir('meas_pipeline')</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
143  <a href="#76953e89">76953e89</a> -     moPolicy = policy.Policy.createPolicy(os.path.join(eups.productDir("meas_pipeline"),</div>
              ?                                                        -----------------    ^^       ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
144  <a href="#dca5406d">dca5406d</a> +     moPolicy = policy.Policy.createPolicy(os.path.join(measPipelineDir,</div>
              ?                                                            ^       ^^^
                                                                       "policy", "MeasureSources.paf"))
                    moPolicy = moPolicy.getPolicy("measureObjects")
                
                    measureSources = algorithms.makeMeasureSources(exposure, moPolicy, psf)
                
                    sourceList = afwDetection.SourceSet()
                    for i in range(len(objects)):
                        source = afwDetection.Source()
                        sourceList.append(source)
                
                        source.setId(i)
                        source.setFlagForDetection(source.getFlagForDetection() | algorithms.Flags.BINNED1);
                
                        try:
                            measureSources.apply(source, objects[i])
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
159  <a href="#63f12d6f">63f12d6f</a> -         except Exception, e:</div>
              ?                         ---
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#77ecbec7">77ecbec7</a> +         except Exception:</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
160  <a href="#63f12d6f">63f12d6f</a> -             #print e</div>
                            pass
                
                        if source.getFlagForDetection() & algorithms.Flags.EDGE:
                            continue
                
                        if display:
                            xc, yc = source.getXAstrom() - mi.getX0(), source.getYAstrom() - mi.getY0()
                            if False:
                                ds9.dot("%.1f %d" % (source.getPsfFlux(), source.getId()), xc, yc+1)
                
                            ds9.dot("+", xc, yc, size=1)
                
                    return sourceList
                
                def mergeSourceSets(sourceSetList):
                    """Return the union of all the SourceSet in sourceSetList"""
                    outlist = afwDetection.SourceSet()
                    for sl in sourceSetList:
                        for s in sl:
                            outlist.append(s)
                
                    return outlist
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def makeSourceList(dir, basename, e, c, aList, threshold, verbose=0):
                    """Return the sources detected above threshold in all the amplifiers, aList, of the given field
                
                    E.g. sl = makeSourceList("/lsst/DC3root/rlp1173", "v704897", 0, 3, range(8), 500)
                    """
                
                    try:
                        aList[0]
                    except TypeError:
                        aList = [aList]
                
                    sourceSets = []
                    for a in aList:
                        filename = "%s-e%d-c%03d-a%02d.sci" % (basename, e, c, a)
                        if dir:
                            filename = os.path.join(dir, "IPSD", "output", "sci", "%s-e%d" % (basename, e), filename)
                
                        if verbose:
                            print filename
                
                        exp = afwImage.ExposureF(filename)
                
                        sourceSets.append(detectSources(exp, threshold))
                
                    return mergeSourceSets(sourceSets)
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def makeCcdMosaic(dir, basename, e, c, aList, imageFactory=afwImage.MaskedImageF, verbose=0):
                    """Return an image of all the specified amplifiers, aList, for the given CCD
                
                    E.g. sl = makeCcdMosaic("/lsst/DC3root/rlp1173", "v704897", 0, 3, range(8))
                    """
                
                    try:
                        aList[0]
                    except TypeError:
                        aList = [aList]
                
                    for what in ("header", "data"):
                        if what == "header":
                            bbox = afwGeom.Box2I()
                            ampBBox = {}
                            wcs = {}
                        else:
                            ccdImage = imageFactory(bbox.getWidth(), bbox.getHeight())
                            ccdImage.set(0)
                            ccdImage.setXY0(bbox.getLLC())
                
                        for a in aList:
                            filename = os.path.join(dir, "IPSD", "output", "sci", "%s-e%d" % (basename, e),
                                                    "%s-e%d-c%03d-a%02d.sci" % (basename, e, c, a))
                            if verbose and what == "header":
                                print filename
                
                            if what == "header":
                                md = afwImage.readMetadata(filename + "_img.fits")
                                xy0 = afwGeom.Point2I(md.get("CRVAL1A"), md.get("CRVAL2A"))
                                xy1 = xy0 + afwGeom.Extent2I(md.get("NAXIS1") - 1, md.get("NAXIS2") - 1)
                                bbox.grow(xy0)
                                bbox.grow(xy1)
                
                                ampBBox[a] = afwGeom.Box2I(xy0, xy1)
                                wcs[a] = afwImage.Wcs(md)
                            else:
                                try:
                                    data = imageFactory(filename + "_img.fits")
                                except:
                                    data = imageFactory(filename)
                                    
                                ampImage = ccdImage.Factory(ccdImage, ampBBox[a])
                                ampImage <<= data
                                del ampImage
                
                    try:
                        ccdImage.getMask()
                        if wcs.has_key(0):
                            ccdImage = afwImage.ExposureF(ccdImage, wcs[0])
                    except AttributeError:
                        pass
                
                    return ccdImage
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                def readStandards(filename):
                    fd = file(filename, "r")
                
                    sourceSet = afwDetection.SourceSet()
                    lineno = 0
                    for line in fd.readlines():
                        lineno += 1
                        try:
                            id, flags, ra, dec, cts = line.split()
                        except Exception, e:
                            print "Line %d: %s: %s" % (lineno, e, line),
                
                        s = afwDetection.Source()
                        sourceSet.append(s)
                
                        s.setId(int(id))
                        s.setFlagForDetection(int(flags))
                        s.setRa(float(ra))
                        s.setDec(float(dec))
                        s.setPsfFlux(float(cts))
                
                    return sourceSet
                
                def showStandards(standardStarSet, exp, frame, countsMin=None, flagMask=None, rmsMax=None, ctype=ds9.RED):
                    """Show all the standards that are visible on this exposure
                
                    If countsMin is not None, only show brighter Sources
                
                    If flagMask is not None, ignore sources that have (flags & ~flagMask) != 0
                    """
                
                    wcs = exp.getWcs()
                    width, height = exp.getMaskedImage().getWidth(), exp.getMaskedImage().getHeight()
                    
                    for s in standardStarSet:
                        x,y = wcs.skyToPixel(s.getRaDec())
                
                        if x < 0 or x >= width or y < 0 or y >= height:
                            continue
                
                        counts = s.getPsfFlux()
                
                        if counts < countsMin and countsMin is not None:
                            continue
                
                        if flagMask is not None:
                            if (s.getFlagForDetection() & ~flagMask) != 0:
                                continue
                
                        rms = math.sqrt(s.getIxx() + s.getIyy())
                        if rmsMax is not None and rms > rmsMax:
                            continue
                
                        if False:
                            pt = "%.1f" % (rms)
                        else:
                            pt = "+"
                        ds9.dot(pt, x, y, frame=frame, ctype=ctype)
                
                def setRaDec(wcs, sourceSet):
                    """Set the ra/dec fields in a sourceSet from [XY]Astrom"""
                    
                    for s in sourceSet:
                        s.setRaDec(wcs.pixelToSky(s.getXAstrom(), s.getYAstrom()))
                
                def writeSourceSet(sourceSet, outfile="-"):
                    if outfile == "-":
                        fd = sys.stdout
                    else:
                        fd = open(outfile, "w")
                    
                    for s in sourceSet:
                        print >> fd, s.getId(), s.getXAstrom(), s.getYAstrom(), s.getRa(), s.getDec(), s.getPsfFlux(), s.getFlagForDetection()
                
                def readSourceSet(fileName):
                    fd = open(fileName, "r")
                
                    sourceSet = afwDetection.SourceSet()
                    lineno = 0
                    for line in fd.readlines():
                        lineno += 1
                        try:
                            id, x, y, ra, dec, cts, flags = line.split()
                        except Exception, e:
                            print "Line %d: %s: %s" % (lineno, e, line),
                
                        s = afwDetection.Source()
                        sourceSet.append(s)
                
                        s.setId(int(id))
                        s.setFlagForDetection(int(flags))
                        s.setRa(float(ra))
                        s.setXAstrom(float(x))
                        s.setYAstrom(float(y))
                        s.setDec(float(dec))
                        s.setPsfFlux(float(cts))
                
                    return sourceSet
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="63f12d6f"/></a>63f12d6f</h3>

<pre>
commit 63f12d6f4f8fef6cc3b512f7fb285d9c11565e80
Author: fergal <fergal@git.lsstcorp.org>
Date:   Fri Dec 4 17:11:46 2009 +0000

    cfhtdata is a script that will extract sourcesets for a CFHT ccd, including all amplifiers it finds.
</pre>
<h3><a name="76953e89"/></a>76953e89</h3>

<pre>
commit 76953e8943454903d8d6f7df6b15f37f92498787
Author: fergal <fergal@git.lsstcorp.org>
Date:   Thu Feb 18 19:22:08 2010 +0000

    Now look for policy file for measureObjects in meas_pipeline instead of
    meas_algorithms
</pre>
<h3><a name="a88a6910"/></a>a88a6910</h3>

<pre>
commit a88a6910f1e2fb3f1352b20e8b9ad5ea7d9c02f1
Author: rowen <rowen@git.lsstcorp.org>
Date:   Mon Apr 11 23:54:26 2011 +0000

    First cut.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="dca5406d"/></a>dca5406d</h3>

<pre>
commit dca5406d4f69a6ffdec97d87ba9a0c51853991e7
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:29:55 2015 -0700

    replace eups.productDir() calls with lsst.utils.getPackageDir()
</pre>
<h3><a name="a7e1c214"/></a>a7e1c214</h3>

<pre>
commit a7e1c2144449e63c6619d6ea68476f47b4eeaee0
Author: Joshua Hoblitt <josh@hoblitt.com>
Date:   Fri May 22 11:28:57 2015 -0700

    remove unnecessary imports of eups
</pre>
<h3><a name="77ecbec7"/></a>77ecbec7</h3>

<pre>
commit 77ecbec74263b3d02d79005b1377e95cc36ed8dd
Author: Russell Owen <rowen@uw.edu>
Date:   Thu Sep 11 17:53:04 2014 -0700

    Use default image origin of PARENT when possible.
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_46"><a name="python/lsst/meas/astrom/astrometry_net.i"/></a>python/lsst/meas/astrom/astrometry_net.i</h1>

<h3 id="toc_47">Diff:</h3>

<pre>
                // -*- lsst-C++ -*-
                %define astrometry_net_DOCSTRING
                "
                Python interface to Astrometry.net
                "
                %enddef
                
                %feature("autodoc", "1");
                %module(package="lsst.meas.astrom.astrometry_net",
                        docstring=astrometry_net_DOCSTRING) astrometry_net
                
                %pythonnondynamic;
                %naturalvar;  // use const reference typemaps
                
                %include "std_string.i"
                %include "std_vector.i"
                
                %{
                    // Astrometry.net include files...
                    extern "C" {
                #include "astrometry/solver.h"
                #include "astrometry/index.h"
                #include "astrometry/multiindex.h"
                #include "astrometry/starkd.h"
                #include "astrometry/fitsioutils.h"
                #include "astrometry/fitstable.h"
                #include "astrometry/log.h"
                #include "astrometry/tic.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
29   <a href="#284f989a">284f989a</a> - #include "astrometry/healpix.h"</div>
                
                #undef ATTRIB_FORMAT
                #undef FALSE
                #undef TRUE
                
                #undef logdebug
                #undef debug
                    }
                
                #include <vector>
                #include <set>
                #include "boost/cstdint.hpp"
                #include "boost/shared_ptr.hpp"
                #include "boost/format.hpp"
                
                #include "lsst/meas/astrom/detail/utils.h"
                #include "lsst/base.h"
                #include "lsst/pex/logging.h"
                #include "lsst/daf/persistence.h"
                #include "lsst/daf/base/Persistable.h"
                #include "lsst/daf/base/PropertyList.h"
                #include "lsst/afw/table.h"
                #include "lsst/afw/image/Wcs.h"
                #include "lsst/afw/image/TanWcs.h"
                #include "lsst/afw/geom.h"
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
55   <a href="#284f989a">284f989a</a> - #include "lsst/afw/coord.h"</div>
                
                namespace afwCoord = lsst::afw::coord;
                namespace afwTable = lsst::afw::table;
                namespace afwGeom  = lsst::afw::geom;
                namespace afwImage = lsst::afw::image;
                namespace dafBase  = lsst::daf::base;
                namespace pexLog   = lsst::pex::logging;
                
                struct timer_baton {
                    solver_t* s;
                    double timelimit;
                };
                
                static time_t timer_callback(void* baton) {
                    struct timer_baton* tt = static_cast<struct timer_baton*>(baton);
                    solver_t* solver = tt->s;
                    //printf("Timer callback; time used %f, limit %f\n",
                    //       solver->timeused, tt->timelimit);
                    if (solver->timeused > tt->timelimit)
                        solver->quit_now = 1;
                    return 1;
                }
                
                // Global logger to which Astrometry.net will go.
                static PTR(pexLog::Log) an_log;
                
                PTR(pexLog::Log) get_an_log() {
                    return an_log;
                }
                void set_an_log(PTR(pexLog::Log) newlog) {
                    an_log = newlog;
                }
                
                static void an_log_callback(void* baton, enum log_level level,
                                            const char* file,
                                            int line, const char* func, const char* format,
                                            va_list va) {
                    // translate between logging levels
                    int levelmap[5];
                    levelmap[LOG_NONE ] = pexLog::Log::FATAL;
                    levelmap[LOG_ERROR] = pexLog::Log::FATAL;
                    levelmap[LOG_MSG  ] = pexLog::Log::INFO;
                    levelmap[LOG_VERB ] = pexLog::Log::DEBUG;
                    levelmap[LOG_ALL  ] = pexLog::Log::DEBUG;
                    int lsstlevel = levelmap[level];
                
                    va_list vb;
                    // find out how long the formatted string will be
                    va_copy(vb, va);
                    const int len = vsnprintf(NULL, 0, format, va) + 1; // "+ 1" for the '\0'
                    va_end(va);
                    // allocate a string of the appropriate length
                    char msg[len];
                    (void)vsnprintf(msg, len, format, vb);
                    va_end(vb);
                
                    // trim trailing \n
                    if (msg[len-2] == '\n') {
                        msg[len-2] = '\0';
                    }
                
                    dafBase::PropertySet ps;
                    ps.set("an_file", file);
                    ps.set("an_line", line);
                    ps.set("an_func", func);
                
                    an_log->log(lsstlevel, std::string(msg), ps);
                }
                
                static void start_an_logging() {
                    an_log = PTR(pexLog::Log)(new pexLog::Log(pexLog::Log::getDefaultLog(),
                                                              "meas.astrom.astrometry_net"));
                    an_log->markPersistent();
                    // NOTE, this has to happen before the log_use_function!
                    log_init(LOG_VERB);
                    log_use_function(an_log_callback, NULL);
                    log_to(NULL);
                }
                
                static void stop_an_logging() {
                    log_use_function(NULL, NULL);
                    log_to(stdout);
                    an_log.reset();
                }
                
                void finalize() {
                    stop_an_logging();
                }
                    %}
                
                %init %{
                    // Astrometry.net logging
                    fits_use_error_system();
                    start_an_logging();
                    %}
                
                %include "boost_shared_ptr.i"
                %include "lsst/p_lsstSwig.i"
                %include "lsst/base.h"
                %import "lsst/daf/base/baseLib.i"
                
                void finalize();
                PTR(pexLog::Log) get_an_log();
                void set_an_log(PTR(pexLog::Log) newlog);
                
                %lsst_exceptions();
                
                %template(VectorOfString) std::vector<std::string>;
                
                %import "lsst/afw/table/Source.i"
                
                %shared_ptr(lsst::afw::image::Wcs);
                %import "lsst/afw/image/Wcs.h"
                
                %template(VectorOfIndexPtr) std::vector<index_t*>;
                
                %newobject solver_new;
                %newobject multiindex_new;
                
                %include "astrometry/solver.h"
                %include "astrometry/index.h"
                %include "astrometry/multiindex.h"
                
                %inline %{
                    void an_log_init(int level) {
                        log_init((log_level)level);
                    }
                    int an_log_get_level() {
                        return (int)log_get_level();
                    }
                    void an_log_set_level(int lvl) {
                        log_set_level((log_level)lvl);
                    }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
189  <a href="#284f989a">284f989a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
190  <a href="#284f989a">284f989a</a> -     // This is what you SHOULD use...</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
191  <a href="#284f989a">284f989a</a> -     lsst::afw::geom::Angle healpixDistance(int hp, int Nside, lsst::afw::coord::Coord const& coord) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
192  <a href="#284f989a">284f989a</a> -         return lsst::afw::geom::Angle(healpix_distance_to_radec(hp, Nside, coord.getLongitude().asDegrees(),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
193  <a href="#284f989a">284f989a</a> -                                                                 coord.getLatitude().asDegrees(), NULL),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
194  <a href="#284f989a">284f989a</a> -                                       lsst::afw::geom::degrees);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
195  <a href="#284f989a">284f989a</a> -     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
196  <a href="#284f989a">284f989a</a> -     // Convenience overload, since everything in here already works in terms of ra,dec rather than Coord...</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
197  <a href="#284f989a">284f989a</a> -     lsst::afw::geom::Angle healpixDistance(int hp, int Nside, double ra, double dec) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
198  <a href="#284f989a">284f989a</a> -         return lsst::afw::geom::Angle(healpix_distance_to_radec(hp, Nside, ra, dec, NULL),</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
199  <a href="#284f989a">284f989a</a> -                                       lsst::afw::geom::degrees);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
200  <a href="#284f989a">284f989a</a> -     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
201  <a href="#284f989a">284f989a</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
202  <a href="#284f989a">284f989a</a> - </div>
                %}
                
                %extend multiindex_t {
                    // An index being within range is a property of the star kd-tree, hence of
                    // the multi-index as a whole
                    int isWithinRange(double ra, double dec, double radius) {
                        return index_is_within_range(multiindex_get($self, 0), ra, dec, radius);
                    }
                
                    void unload() {
                        multiindex_unload($self);
                    }
                
                    ~multiindex_t() {
                        multiindex_free($self);
                    }
                
                    char* get_name() {
                        return $self->fits->filename;
                    }
                
                    %pythoncode %{
                    def reload(self):
                        if multiindex_reload_starkd(self):
                            raise RuntimeError('Failed to reload multi-index star file %s' % self.name)
                    __swig_getmethods__['name'] = get_name
                    if _newclass: x = property(get_name)
                
                    def __len__(self):
                        return multiindex_n(self)
                    def __getitem__(self, i):
                        if i < 0 or i > multiindex_n(self):
                            raise IndexError('Index %i out of bound for multiindex_t' % i)
                        return multiindex_get(self, i)
                    %}
                }
                
                %extend index_t {
                    int overlapsScaleRange(double qlo, double qhi) {
                        return index_overlaps_scale_range($self, qlo, qhi);
                    }
                
                    %pythoncode %{
                    def reload(self):
                        if index_reload(self):
                            raise RuntimeError('Failed to reload multi-index file %s' % self.indexname)
                    %}
                }
                
                %extend solver_t {
                    ~solver_t() {
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#48c5a987">48c5a987</a> +         // Working around a bug in Astrometry.net: doesn't take ownership of the</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#48c5a987">48c5a987</a> +         // field.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#48c5a987">48c5a987</a> +         // unseemly familiarity with the innards... but valgrind-clean.</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#48c5a987">48c5a987</a> +         starxy_free($self->fieldxy);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
242  <a href="#48c5a987">48c5a987</a> +         $self->fieldxy = NULL;</div>
                        solver_free($self);
                    }
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
246  <a href="#eb937b8d">eb937b8d</a> +     /**</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
247  <a href="#eb937b8d">eb937b8d</a> +     Load reference objects in a region of the sky described by a center coordinate and a radius</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
248  <a href="#eb937b8d">eb937b8d</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
249  <a href="#eb937b8d">eb937b8d</a> +     @param[in] inds  list of star kd-trees from astrometry.net</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
250  <a href="#eb937b8d">eb937b8d</a> +     @param[in] ctrCoord  center of search region</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
251  <a href="#eb937b8d">eb937b8d</a> +     @param[in] radius  search radius</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
252  <a href="#eb937b8d">eb937b8d</a> +     @param[in] idCol  name of ID column in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
253  <a href="#eb937b8d">eb937b8d</a> +     @param[in] filterNameList  names of filters in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
254  <a href="#eb937b8d">eb937b8d</a> +     @param[in] magColList  names of magnitude columns in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
255  <a href="#eb937b8d">eb937b8d</a> +     @param[in] magErrColList  names of magnitude uncertainty (sigma) columns in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
256  <a href="#eb937b8d">eb937b8d</a> +     @param[in] starGalCol  name of "starGal" column (true if object is a star) in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#eb937b8d">eb937b8d</a> +     @param[in] varCol  name of "var" column (true if brightness is variable) in astrometry.net data</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#eb937b8d">eb937b8d</a> +     @param[in] uniqueIds  if true then only return unique IDs (the first of each seen)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#27598add">27598add</a> + </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#27598add">27598add</a> +     Returned schema:</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#eb937b8d">eb937b8d</a> +     - id</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#eb937b8d">eb937b8d</a> +     - coord: sky position (an lsst::afw::coord::IcrsCoord)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#eb937b8d">eb937b8d</a> +     - centroid: centroid on some exposure, if relevant (an lsst::afw::geom::Point2D); returned value is not set</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#eb937b8d">eb937b8d</a> +     - hasCentroid: if true then centroid has been set; returned value is false</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#eb937b8d">eb937b8d</a> +     - <filterName>_flux: flux in the specified filter (double)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#eb937b8d">eb937b8d</a> +     - <filterName>_fluxSigma: flux uncertainty in the specified filter (double)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
267  <a href="#eb937b8d">eb937b8d</a> +     - resolved (if starGalCol specified): true if object is not resolved</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#eb937b8d">eb937b8d</a> +     - variable (if varCol specified): true if brightness is variable</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#eb937b8d">eb937b8d</a> +     - photometric: true if not resolved (or starGalCol blank) and not variable (or varCol blank);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#eb937b8d">eb937b8d</a> +         note that if starGalCol and varCol both blank then all objects are claimed to be photometric</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#eb937b8d">eb937b8d</a> +     */</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
257  <a href="#0252ec5c">0252ec5c</a> -     lsst::afw::table::SimpleCatalog</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#eb937b8d">eb937b8d</a> +     lsst::afw::table::SimpleCatalog getCatalog(</div>
              ?                                    ++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
258  <a href="#82b8e761">82b8e761</a> -        getCatalog(std::vector<index_t*> inds,</div>
              ?        ^^^^^^^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#eb937b8d">eb937b8d</a> +         std::vector<index_t*> inds,</div>
              ?        ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
259  <a href="#9e8b4e03">9e8b4e03</a> -                   double ra, double dec, double radius,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#eb937b8d">eb937b8d</a> +         lsst::afw::coord::Coord const &ctrCoord,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#eb937b8d">eb937b8d</a> +         lsst::afw::geom::Angle const &radius,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
260  <a href="#9e8b4e03">9e8b4e03</a> -                   const char* idcol,</div>
              ? ----------                      ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#eb937b8d">eb937b8d</a> +         const char* idCol,</div>
              ?                       ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
261  <a href="#9e8b4e03">9e8b4e03</a> -                   std::vector<std::string> const& magnameVec,</div>
              ? ----------                                        ^^^^   ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#eb937b8d">eb937b8d</a> +         std::vector<std::string> const& filterNameList,</div>
              ?                                         ^^^^^^^   ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
262  <a href="#9e8b4e03">9e8b4e03</a> -                   std::vector<std::string> const& magcolVec,</div>
              ? ----------                                           ^  ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#eb937b8d">eb937b8d</a> +         std::vector<std::string> const& magColList,</div>
              ?                                            ^  ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
263  <a href="#9e8b4e03">9e8b4e03</a> -                   std::vector<std::string> const& magerrcolVec,</div>
              ? ----------                                           ^  ^  ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
279  <a href="#eb937b8d">eb937b8d</a> +         std::vector<std::string> const& magErrColList,</div>
              ?                                            ^  ^  ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
264  <a href="#9e8b4e03">9e8b4e03</a> -                   const char* stargalcol,</div>
              ? ----------                        ^  ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#eb937b8d">eb937b8d</a> +         const char* starGalCol,</div>
              ?                         ^  ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
265  <a href="#9e8b4e03">9e8b4e03</a> -                   const char* varcol,</div>
              ? ----------                       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#eb937b8d">eb937b8d</a> +         const char* varCol,</div>
              ?                        ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
266  <a href="#9e8b4e03">9e8b4e03</a> -                   bool unique_ids=true)</div>
              ? ----------                   ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#27598add">27598add</a> +         bool uniqueIds=true)</div>
              ?                    ^
                    {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
268  <a href="#753b5513">753b5513</a> -         if ((magnameVec.size() != magcolVec.size()) || (magnameVec.size() != magerrcolVec.size())) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#eb937b8d">eb937b8d</a> +         if ((filterNameList.size() != magColList.size()) || (filterNameList.size() != magErrColList.size())) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
269  <a href="#753b5513">753b5513</a> -             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterException,</div>
              ?                                                                       ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#3896b32c">3896b32c</a> +             throw LSST_EXCEPT(lsst::pex::exceptions::InvalidParameterError,</div>
              ?                                                                       ^^ ^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
270  <a href="#753b5513">753b5513</a> -                               "Mag name, mag column, and mag error column vectors must be the same length.");</div>
              ? --------------                 ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#eb937b8d">eb937b8d</a> +                 "Filter name, mag column, and mag error column vectors must be the same length.");</div>
              ?                  ^^^^^^
                        }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#753b5513">753b5513</a> -         std::vector<lsst::meas::astrom::detail::mag_column_t> magcols;</div>
              ?                                                    ^^  ^^ ^ ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#eb937b8d">eb937b8d</a> +         std::vector<lsst::meas::astrom::detail::MagColInfo> magColInfoList;</div>
              ?                                                 ++++++++++++   ^  ^ ^^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#753b5513">753b5513</a> -         for (size_t i=0; i<magnameVec.size(); ++i) {</div>
              ?                            ^^^^   ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#eb937b8d">eb937b8d</a> +         for (size_t i=0; i<filterNameList.size(); ++i) {</div>
              ?                            ^^^^^^^   ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#753b5513">753b5513</a> -             lsst::meas::astrom::detail::mag_column_t mc;</div>
              ?                                         ^  ^^  ^^ ^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#eb937b8d">eb937b8d</a> +             lsst::meas::astrom::detail::MagColInfo mc;</div>
              ?                                         ^  ^  ^ ^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
275  <a href="#753b5513">753b5513</a> -             mc.name = magnameVec[i];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#eb937b8d">eb937b8d</a> +             mc.filterName = filterNameList[i];</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
276  <a href="#753b5513">753b5513</a> -             mc.magcol = magcolVec[i];</div>
              ?                   ^        ^  ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#eb937b8d">eb937b8d</a> +             mc.magCol = magColList[i];</div>
              ?                   ^        ^  ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
277  <a href="#753b5513">753b5513</a> -             mc.magerrcol = magerrcolVec[i];</div>
              ?                   ^  ^        ^  ^  ^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#eb937b8d">eb937b8d</a> +             mc.magErrCol = magErrColList[i];</div>
              ?                   ^  ^        ^  ^  ^^^^
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
278  <a href="#753b5513">753b5513</a> -             magcols.push_back(mc);</div>
              ?                ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#eb937b8d">eb937b8d</a> +             magColInfoList.push_back(mc);</div>
              ?                ^  ++++++ +
                        }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
280  <a href="#22f92e11">22f92e11</a> -         return lsst::meas::astrom::detail::getCatalogImpl(inds, ra, dec, radius,</div>
              ?                                                                  ^ -----
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#eb937b8d">eb937b8d</a> +         return lsst::meas::astrom::detail::getCatalogImpl(inds, ctrCoord, radius,</div>
              ?                                                                 ++ ^^^^^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#27598add">27598add</a> +             idCol, magColInfoList, starGalCol, varCol, uniqueIds);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
281  <a href="#753b5513">753b5513</a> -                                                           idcol, magcols, stargalcol, varcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
282  <a href="#22f92e11">22f92e11</a> -                                                           unique_ids);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
283  <a href="#81011bdf">81011bdf</a> -     }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
284  <a href="#81011bdf">81011bdf</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
285  <a href="#81011bdf">81011bdf</a> -     lsst::afw::table::SimpleCatalog</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
286  <a href="#82b8e761">82b8e761</a> -         getCatalog(std::vector<index_t*> inds,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
287  <a href="#0252ec5c">0252ec5c</a> -                    double ra, double dec, double radius,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
288  <a href="#0252ec5c">0252ec5c</a> -                    const char* idcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
289  <a href="#0252ec5c">0252ec5c</a> -                    const char* magcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
290  <a href="#0252ec5c">0252ec5c</a> -                    const char* magerrcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
291  <a href="#0252ec5c">0252ec5c</a> -                    const char* stargalcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
292  <a href="#0252ec5c">0252ec5c</a> -                    const char* varcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
293  <a href="#81011bdf">81011bdf</a> -                    bool unique_ids=true)</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
294  <a href="#81011bdf">81011bdf</a> -     {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
295  <a href="#753b5513">753b5513</a> -         std::vector<lsst::meas::astrom::detail::mag_column_t> cols;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
296  <a href="#753b5513">753b5513</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
297  <a href="#753b5513">753b5513</a> -         if (magcol || magerrcol) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
298  <a href="#753b5513">753b5513</a> -             lsst::meas::astrom::detail::mag_column_t mc;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
299  <a href="#753b5513">753b5513</a> -             mc.name = (magcol ? magcol : magerrcol);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
300  <a href="#753b5513">753b5513</a> -             mc.magcol = (magcol ? magcol : "");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
301  <a href="#753b5513">753b5513</a> -             mc.magerrcol = (magerrcol ? magerrcol : "");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
302  <a href="#753b5513">753b5513</a> -             cols.push_back(mc);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
303  <a href="#753b5513">753b5513</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
304  <a href="#753b5513">753b5513</a> -             // Also add plain old "flux"/"flux.err" schema entries.</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
305  <a href="#753b5513">753b5513</a> -             if (magcol) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
306  <a href="#753b5513">753b5513</a> -                 mc.name = "flux";</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
307  <a href="#753b5513">753b5513</a> -                 mc.magcol = magcol;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
308  <a href="#753b5513">753b5513</a> -                 mc.magerrcol = (magerrcol ? magerrcol : "");</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
309  <a href="#753b5513">753b5513</a> -                 cols.push_back(mc);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
310  <a href="#753b5513">753b5513</a> -             }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
311  <a href="#753b5513">753b5513</a> -         }</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
312  <a href="#753b5513">753b5513</a> -         return lsst::meas::astrom::detail::getCatalogImpl(inds, ra, dec, radius,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
313  <a href="#753b5513">753b5513</a> -                                                           idcol, cols, stargalcol, varcol,</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
314  <a href="#753b5513">753b5513</a> -                                                           unique_ids);</div>
                    }
                
                    PTR(lsst::daf::base::PropertyList) getSolveStats() {
                        // Gather solve stats...
                        PTR(dafBase::PropertyList) qa = boost::make_shared<dafBase::PropertyList>();
                        // FIXME -- Ticket #1875 prevents dotted-names from working with toString().
                        qa->set("meas_astrom*an*n_tried", $self->numtries);
                        qa->set("meas_astrom*an*n_matched", $self->nummatches);
                        qa->set("meas_astrom*an*n_scaleok", $self->numscaleok);
                        qa->set("meas_astrom*an*n_cxdxcut", $self->num_cxdx_skipped);
                        qa->set("meas_astrom*an*n_meanxcut", $self->num_meanx_skipped);
                        qa->set("meas_astrom*an*n_radeccut", $self->num_radec_skipped);
                        qa->set("meas_astrom*an*n_scalecut", $self->num_abscale_skipped);
                        qa->set("meas_astrom*an*n_verified", $self->num_verified);
                        qa->set("meas_astrom*an*time_used", $self->timeused);
                        qa->set("meas_astrom*an*best_logodds", $self->best_logodds);
                        if ($self->best_index) {
                            index_t* ind = $self->best_index;
                            qa->set("meas_astrom*an*best_index*id", ind->indexid);
                            qa->set("meas_astrom*an*best_index*hp", ind->healpix);
                            qa->set("meas_astrom*an*best_index*nside", ind->hpnside);
                            qa->set("meas_astrom*an*best_index*name", std::string(ind->indexname));
                        }
                        if ($self->have_best_match) {
                            MatchObj* mo = &($self->best_match);
                            std::string s = boost::str(boost::format("%i") % mo->star[0]);
                            for (int i=1; i<mo->dimquads; i++)
                                s = s + boost::str(boost::format(", %i") % mo->star[i]);
                            qa->set("meas_astrom*an*best_match*starinds", s);
                            qa->set("meas_astrom*an*best_match*coderr", std::sqrt(mo->code_err));
                            qa->set("meas_astrom*an*best_match*nmatch", mo->nmatch);
                            qa->set("meas_astrom*an*best_match*ndistract", mo->ndistractor);
                            qa->set("meas_astrom*an*best_match*nconflict", mo->nconflict);
                            qa->set("meas_astrom*an*best_match*nfield", mo->nfield);
                            qa->set("meas_astrom*an*best_match*nindex", mo->nindex);
                            qa->set("meas_astrom*an*best_match*nbest", mo->nbest);
                            qa->set("meas_astrom*an*best_match*logodds", mo->logodds);
                            qa->set("meas_astrom*an*best_match*parity", mo->parity ? 0 : 1);
                            qa->set("meas_astrom*an*best_match*nobjs", mo->objs_tried);
                        }
                        return qa;
                    }
                
                    PTR(lsst::afw::image::Wcs) getWcs() {
                        MatchObj* match = solver_get_best_match($self);
                        if (!match)
                            return PTR(afwImage::Wcs)();
                        tan_t* wcs = &(match->wcstan);
                
                        afwGeom::Point2D crpix(wcs->crpix[0], wcs->crpix[1]);
                        afwCoord::Coord::ConstPtr crval
                            (new afwCoord::Coord(wcs->crval[0] * afwGeom::degrees,
                                                 wcs->crval[1] * afwGeom::degrees));
                        return afwImage::makeWcs(*crval, crpix,
                                                 wcs->cd[0][0], wcs->cd[0][1],
                                                 wcs->cd[1][0], wcs->cd[1][1]);
                    }
                
                    bool didSolve() {
                        return solver_did_solve($self);
                    }
                
                    void run(double cpulimit) {
                        solver_log_params($self);
                        struct timer_baton tt;
                        if (cpulimit > 0.) {
                            tt.s = $self;
                            tt.timelimit = cpulimit;
                            $self->userdata = &tt;
                            $self->timer_callback = timer_callback;
                        }
                        solver_run($self);
                        if (cpulimit > 0.) {
                            $self->timer_callback = NULL;
                            $self->userdata = NULL;
                        }
                    }
                
                    double getQuadSizeLow() {
                        double qlo,qhi;
                        solver_get_quad_size_range_arcsec($self, &qlo, &qhi);
                        return qlo;
                    }
                    double getQuadSizeHigh() {
                        double qlo,qhi;
                        solver_get_quad_size_range_arcsec($self, &qlo, &qhi);
                        return qhi;
                    }
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
404  <a href="#82b8e761">82b8e761</a> -     void addIndex(index_t* ind) {</div>
              ?                 ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
387  <a href="#bdcef269">bdcef269</a> +     void addIndices(std::vector<index_t*> inds) {</div>
              ?                ++ ^ ++++++++++++        +    +
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
388  <a href="#bdcef269">bdcef269</a> +         for (std::vector<index_t*>::iterator pind = inds.begin();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
389  <a href="#0252ec5c">0252ec5c</a> +              pind != inds.end(); ++pind) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
390  <a href="#c6797ad3">c6797ad3</a> +             lsst::meas::astrom::detail::IndexManager man(*pind);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
391  <a href="#c6797ad3">c6797ad3</a> + //            printf("Checking index \"%s\"\n", man.index->indexname);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
392  <a href="#0252ec5c">0252ec5c</a> +             if ($self->use_radec) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
393  <a href="#0252ec5c">0252ec5c</a> +                 double ra,dec,radius;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
394  <a href="#0252ec5c">0252ec5c</a> +                 xyzarr2radecdeg($self->centerxyz, &ra, &dec);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
395  <a href="#0252ec5c">0252ec5c</a> +                 radius = distsq2deg($self->r2);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
396  <a href="#c6797ad3">c6797ad3</a> +                 if (!index_is_within_range(man.index, ra, dec, radius)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
397  <a href="#135ccb8a">135ccb8a</a> +                                      //printf("Not within RA,Dec range\n");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
398  <a href="#0252ec5c">0252ec5c</a> +                     continue;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
399  <a href="#0252ec5c">0252ec5c</a> +                 }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
400  <a href="#0252ec5c">0252ec5c</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
401  <a href="#0252ec5c">0252ec5c</a> +             // qlo,qhi in arcsec</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
402  <a href="#0252ec5c">0252ec5c</a> +             double qlo, qhi;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
403  <a href="#0252ec5c">0252ec5c</a> +             solver_get_quad_size_range_arcsec($self, &qlo, &qhi);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
404  <a href="#c6797ad3">c6797ad3</a> +             if (!index_overlaps_scale_range(man.index, qlo, qhi)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
405  <a href="#0252ec5c">0252ec5c</a> + //                printf("Not within quad scale range\n");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
406  <a href="#0252ec5c">0252ec5c</a> +                 continue;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
407  <a href="#0252ec5c">0252ec5c</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
408  <a href="#0252ec5c">0252ec5c</a> + //            printf("Adding index.\n");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
409  <a href="#c6797ad3">c6797ad3</a> +             if (index_reload(man.index)) {</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
410  <a href="#3896b32c">3896b32c</a> +                 throw LSST_EXCEPT(lsst::pex::exceptions::IoError,</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
411  <a href="#a8e9a305">a8e9a305</a> +                                   "Failed to index_reload() an astrometry_net_data index file -- out of file descriptors?");</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
412  <a href="#0252ec5c">0252ec5c</a> +             }</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
413  <a href="#a8e9a305">a8e9a305</a> + </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
405  <a href="#82b8e761">82b8e761</a> -         solver_add_index($self, ind);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
414  <a href="#c6797ad3">c6797ad3</a> +             solver_add_index($self, man.index);</div>
              ? ++++                                ++++   ++
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
415  <a href="#0252ec5c">0252ec5c</a> +         }</div>
                    }
                
                    void setParity(bool p) {
                        if (p)
                            $self->parity = PARITY_FLIP;
                        else
                            $self->parity = PARITY_NORMAL;
                    }
                
                    void setMatchThreshold(double t) {
                        solver_set_keep_logodds($self, t);
                    }
                
                    void setPixelScaleRange(double lo, double hi) {
                        $self->funits_lower = lo;
                        $self->funits_upper = hi;
                    }
                
                    void setRaDecRadius(double ra, double dec, double rad) {
                        solver_set_radec($self, ra, dec, rad);
                    }
                
                    void setImageSize(int W, int H) {
                        solver_set_field_bounds($self, 0, W, 0, H);
                        double hi = hypot(W,H);
                        double lo = 0.1 * std::min(W,H);
                        solver_set_quad_size_range($self, lo, hi);
                    }
                
                    void setMaxStars(int N) {
                        $self->endobj = N;
                    }
                
                    void setStars(lsst::afw::table::SourceCatalog const & srcs, int x0, int y0) {
                        // convert to Astrometry.net "starxy_t"
                        starxy_free($self->fieldxy);
                        const size_t N = srcs.size();
                        starxy_t *starxy = starxy_new(N, true, false);
                        for (size_t i=0; i<N; ++i) {
                            double const x    = srcs[i].getX();
                            double const y    = srcs[i].getY();
                            double const flux = srcs[i].getPsfFlux();
                            starxy_set(starxy, i, x - x0, y - y0);
                            starxy_set_flux(starxy, i, flux);
                        }
                        // Sort the array
                        starxy_sort_by_flux(starxy);
                
                        starxy_free(solver_get_field($self));
                        solver_free_field($self);
                        solver_set_field($self, starxy);
                        solver_reset_field_size($self);
                        // Find field boundaries and precompute kdtree
                        solver_preprocess_field($self);
                    }
                
                 }
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="0252ec5c"/></a>0252ec5c</h3>

<pre>
commit 0252ec5cf128bb19735d4a53d0f9c3cffb6a47fd
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Mon Apr 16 17:16:19 2012 -0400

    Expanded physical tabs to 4 spaces, which is apparently the setting Dustin uses
</pre>
<h3><a name="753b5513"/></a>753b5513</h3>

<pre>
commit 753b5513d6a07c53a2ac2e431102eaa5e68fe1bc
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Tue Sep 11 15:36:20 2012 -0400

    Add a test for the multi-mag reference source retrieval API.
    
    Clean up the way multi-mags are requested, and make the schema's names match the LSST-canonical filter names,
    rather than the Astrometry.net column names (which usually match, but only by convention)
</pre>
<h3><a name="81011bdf"/></a>81011bdf</h3>

<pre>
commit 81011bdf4d8273374f99b46bdc72ca2569b7ff71
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Mon Apr 16 22:35:00 2012 -0400

    Add getCatalog interface acception lists of strings; currently only first element is read
</pre>
<h3><a name="9e8b4e03"/></a>9e8b4e03</h3>

<pre>
commit 9e8b4e037273308dd79594753c4298079c2617d5
Author: Steven Bickerton <steven.bickerton@gmail.com>
Date:   Tue Aug 6 14:39:02 2013 +0900

    untabify 2 examples, utils.{cc,h} and *.i
</pre>
<h3><a name="82b8e761"/></a>82b8e761</h3>

<pre>
commit 82b8e76170d0e6f87e137205b70c18a17c1353d4
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Fri May 16 11:02:13 2014 -0500

    Use multiindex unload/reload; python RAII
</pre>
<h3><a name="22f92e11"/></a>22f92e11</h3>

<pre>
commit 22f92e118c532d1c1fa29d77660b79c4185fad1f
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Tue Apr 17 09:42:19 2012 -0400

    Restructure things to move getCatalogImpl out of the .i file
</pre>
<h3><a name="284f989a"/></a>284f989a</h3>

<pre>
commit 284f989a39d87634cc7a9cf0bdd4e6f91092f33d
Author: Paul Price <price@astro.princeton.edu>
Date:   Tue Dec 2 22:27:51 2014 -0500

    Add interface for astrometry_net's healpix_distance_to_radec
    
    This will be useful for optimising the loading of multiindex files
    through a cache.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="0252ec5c"/></a>0252ec5c</h3>

<pre>
commit 0252ec5cf128bb19735d4a53d0f9c3cffb6a47fd
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Mon Apr 16 17:16:19 2012 -0400

    Expanded physical tabs to 4 spaces, which is apparently the setting Dustin uses
</pre>
<h3><a name="48c5a987"/></a>48c5a987</h3>

<pre>
commit 48c5a98730ae50aec10477ee1704ed06c9773593
Author: Dustin Lang <dstn@astro.princeton.edu>
Date:   Wed Jan 18 13:48:50 2012 -0600

    valgrind-clean!
</pre>
<h3><a name="c6797ad3"/></a>c6797ad3</h3>

<pre>
commit c6797ad3909ed0210ff88d7050ba129677e8b167
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu May 30 01:56:33 2013 +0900

    use RAII for index loading/closing (#2879)
    
    When loading indices (when solving, or just reading a catalog)
    one can quickly run out of open file descriptors if not careful.
    To ensure we don't, use an RAII object ("IndexManager") on the
    indices so that files are closed whenever they go out of scope
    (exception, looping, etc).
    
    This replaces the fix to addIndices from #2292 with a more
    complete solution, and applies it also to getCatalogImpl, which
    was discovered to have the same problem in #2879.
</pre>
<h3><a name="a8e9a305"/></a>a8e9a305</h3>

<pre>
commit a8e9a305f06a0912581475467653666ddfd6f83d
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Sat Mar 9 13:56:15 2013 -0500

    add failing unit test demonstrating #2292
</pre>
<h3><a name="27598add"/></a>27598add</h3>

<pre>
commit 27598addd6fafc95781ad3a3dcc4dd87ab723470
Author: Russell Owen <rowen@uw.edu>
Date:   Wed Apr 15 05:30:42 2015 -0700

    Remove the getNewSchema argument from getCatalog
    
    Modified getCatalog and getCatalogImpl to always return the new schema.
</pre>
<h3><a name="135ccb8a"/></a>135ccb8a</h3>

<pre>
commit 135ccb8a74940e81f0885d2b50514822c289e157
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri Feb 10 14:46:42 2012 -0500

    Comment out debugging printf.
</pre>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
<h3><a name="bdcef269"/></a>bdcef269</h3>

<pre>
commit bdcef269d9c91ab76396e04e7584dc91db533a25
Author: Robyn Allsman <robyn@LSST.org>
Date:   Wed Jul 30 13:13:26 2014 -0500

    Additional updates to make meas_astrom compatible with the new
    astrometry.net-050 .
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_48"><a name="examples/ticket2710.py"/></a>examples/ticket2710.py</h1>

<h3 id="toc_49">Diff:</h3>

<pre>
                import matplotlib
                matplotlib.use('Agg')
                import pylab as plt
                import numpy as np
                
                import os
                
                import lsst.meas.astrom as measAstrom
                import lsst.afw.table as afwTable
                import lsst.afw.image as afwImage
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
11   <a href="#ac5b43c6">ac5b43c6</a> - import lsst.afw.geom as afwGeom</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
12   <a href="#6b4d4ff5">6b4d4ff5</a> - import lsst.daf.base  as dafBase</div>
                import lsst.pex.logging as pexLog
                
                import pyfits
                
                '''
                This file was produced by dstn trying to reproduce and diagnose the
                error reported in ticket #2710, ie, that computing SIP polynomials
                wasn't working for sources with positions very far from the origin.
                
                The how-to-reproduce data included a "coaddSources.fits" table of
                source positions produced by the standard afwTable tools, and a 1 GB
                exposure containing a STG WCS.  I extracted the x,y, and flux columns
                from the source table into xy2710.fits; I was also testing with stock
                astrometry.net tools.  I pulled out the original WCS header into
                t2710.wcs to avoid adding a 1 GB file here.  I also pulled out the
                image offset x0,y0 size W,H, and filter.
                
                One gotcha: you need an astrometry_net more recent than 0.30, because
                I'm using the "spherematch" module there to match up sources.
                '''
                
                def showSipSolutions(srcs, wcs0, andDir, x0, y0, W, H, filterName,
                                     plotPrefix):
                                     
                    '''
                    srcs: afw Catalog of sources
                    wcs0: original WCS
                    andDir: astrometry_net_data directory
                    '''
                    imargs = dict(imageSize=(W,H), filterName=filterName, x0=x0, y0=y0)
                
                    # Set up astrometry_net_data
                    os.environ['ASTROMETRY_NET_DATA_DIR'] = andDir
                    andConfig = measAstrom.AstrometryNetDataConfig()
                    fn = os.path.join(andDir, 'andConfig.py')
                    andConfig.load(fn)
                
                    # Set up meas_astrom
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
51   <a href="#82f887fc">82f887fc</a> -     conf = measAstrom.MeasAstromConfig(sipOrder=4)</div>
              ?                       ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
49   <a href="#7c80bc64">7c80bc64</a> +     conf = measAstrom.ANetBasicAstrometryConfig(sipOrder=4)</div>
              ?                       ^^ ++  ++      ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
52   <a href="#ae4149f5">ae4149f5</a> -     ast = measAstrom.Astrometry(conf, andConfig, logLevel=pexLog.Log.DEBUG)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
50   <a href="#7c80bc64">7c80bc64</a> +     ast = measAstrom.ANetBasicAstrometryTask(conf, andConfig, logLevel=pexLog.Log.DEBUG)</div>
              ?                       +++++++++         ++++
                
                    # What reference sources are in the original WCS
                    refs = ast.getReferenceSourcesForWcs(wcs0, **imargs)
                    print 'Got', len(refs), 'reference objects for initial WCS'
                
                    # How does a straight TAN solution look?
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#f4fc7d83">f4fc7d83</a> -     conf2 = measAstrom.MeasAstromConfig(sipOrder=4, calculateSip=False)</div>
              ?                        ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
57   <a href="#7c80bc64">7c80bc64</a> +     conf2 = measAstrom.ANetBasicAstrometryConfig(sipOrder=4, calculateSip=False)</div>
              ?                        ^^ ++  ++      ++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
60   <a href="#f4fc7d83">f4fc7d83</a> -     ast2 = measAstrom.Astrometry(conf2, andConfig, logLevel=pexLog.Log.DEBUG)</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#7c80bc64">7c80bc64</a> +     ast2 = measAstrom.ANetBasicAstrometryTask(conf2, andConfig, logLevel=pexLog.Log.DEBUG)</div>
              ?                        +++++++++         ++++
                    solve = ast2.determineWcs2(srcs, **imargs)
                    tanwcs = solve.tanWcs
                
                    # How about if we fit a SIP WCS using the *original* WCS?
                    wcs2 = ast.getSipWcsFromWcs(wcs0, (W,H), x0=x0, y0=y0)
                
                    # (We determineWcs() for a SIP solution below...)
                    
                    # Make some plots in pixel space by pushing ref sources through WCSes
                    rx0,ry0 = [],[]
                    rx2,ry2 = [],[]
                    rx3,ry3 = [],[]
                    for src in refs:
                        xy = wcs0.skyToPixel(src.getCoord())
                        rx0.append(xy[0])
                        ry0.append(xy[1])
                
                        xy = tanwcs.skyToPixel(src.getCoord())
                        rx2.append(xy[0])
                        ry2.append(xy[1])
                
                        xy = wcs2.skyToPixel(src.getCoord())
                        rx3.append(xy[0])
                        ry3.append(xy[1])
                        
                    rx0 = np.array(rx0)
                    ry0 = np.array(ry0)
                    rx2 = np.array(rx2)
                    ry2 = np.array(ry2)
                    rx3 = np.array(rx3)
                    ry3 = np.array(ry3)
                
                    x = np.array([src.getX() for src in srcs])
                    y = np.array([src.getY() for src in srcs])
                    
                    from astrometry.libkd.spherematch import match
                    from astrometry.util.plotutils import plothist,PlotSequence
                
                    ps = PlotSequence(plotPrefix)
                
                    # Match up various sources...
                    R = 2.
                    
                    II,d = match(np.vstack((x,y)).T, np.vstack((rx0,ry0)).T, R)
                    I = II[:,0]
                    J = II[:,1]
                
                    pa = dict(range=((-R,R),(-R,R)))
                    
                    plt.clf()
                    plothist(x[I]-rx0[J], y[I]-ry0[J], 200, **pa)
                    plt.title('Source positions - Reference positions (initial WCS)')
                    plt.xlabel('delta-X (pixels)')
                    plt.ylabel('delta-Y (pixels)')
                    ps.savefig()
                
                    II,d = match(np.vstack((x,y)).T, np.vstack((rx2,ry2)).T, R)
                    I = II[:,0]
                    J = II[:,1]
                    
                    plt.clf()
                    plothist(x[I]-rx2[J], y[I]-ry2[J], 200, **pa)
                    plt.title('Source positions - Reference positions (TAN WCS)')
                    plt.xlabel('delta-X (pixels)')
                    plt.ylabel('delta-Y (pixels)')
                    ps.savefig()
                
                    II,d = match(np.vstack((x,y)).T, np.vstack((rx3,ry3)).T, R)
                    I = II[:,0]
                    J = II[:,1]
                    plt.clf()
                    plothist(x[I]-rx3[J], y[I]-ry3[J], 200, **pa)
                    plt.title('Source positions - Reference positions (SIP WCS #2)')
                    plt.xlabel('delta-X (pixels)')
                    plt.ylabel('delta-Y (pixels)')
                    ps.savefig()
                
                    II,d = match(np.vstack((rx0,ry0)).T, np.vstack((rx3,ry3)).T, R)
                    I = II[:,0]
                    J = II[:,1]
                    plt.clf()
                    plothist(rx0[I]-rx3[J], ry0[I]-ry3[J], 200, **pa)
                    plt.title('Reference positions (Original WCS) - Reference positions (SIP WCS #2)')
                    plt.xlabel('delta-X (pixels)')
                    plt.ylabel('delta-Y (pixels)')
                    ps.savefig()
                
                    
                    matches = solve.tanMatches
                    msx,msy = [],[]
                    mrx,mry = [],[]
                    for m in matches:
                        ref,src = m.first, m.second
                        xy = tanwcs.skyToPixel(ref.getCoord())
                        mrx.append(xy[0])
                        mry.append(xy[1])
                        msx.append(src.getX())
                        msy.append(src.getY())
                    
                    plt.clf()
                    #plt.plot(x, y, 'o', mec='r', mfc='none', ms=4)
                    plt.plot(x, y, 'r.')
                    plt.plot(msx, msy, 'o', mec='r')
                    #plt.plot(rx0, ry0, 'o', mec='g', mfc='none', ms=4)
                    plt.plot(rx0, ry0, 'g.')
                    plt.plot(mrx, mry, 'gx')
                    plt.title('TAN matches')
                    ps.savefig()
                
                    # Get SIP solution (4th order)
                    
                    solve = ast.determineWcs2(srcs, **imargs)
                    wcs1 = solve.sipWcs
                    #print 'wcs1:', wcs1.getFitsMetadata().toString()
                
                    matches = solve.sipMatches
                    msx,msy = [],[]
                    mrx,mry = [],[]
                    for m in matches:
                        ref,src = m.first, m.second
                        xy = tanwcs.skyToPixel(ref.getCoord())
                        mrx.append(xy[0])
                        mry.append(xy[1])
                        msx.append(src.getX())
                        msy.append(src.getY())
                    
                    plt.clf()
                    plt.plot(x, y, 'r.')
                    plt.plot(msx, msy, 'o', mec='r')
                    plt.plot(rx0, ry0, 'g.')
                    plt.plot(mrx, mry, 'gx')
                    plt.title('SIP matches')
                    ps.savefig()
                    
                    rx1,ry1 = [],[]
                    for src in refs:
                        xy = wcs1.skyToPixel(src.getCoord())
                        rx1.append(xy[0])
                        ry1.append(xy[1])
                    rx1 = np.array(rx1)
                    ry1 = np.array(ry1)
                
                    plt.clf()
                    plt.plot(x, y, 'o', mec='r', mfc='none')
                    plt.plot(rx0, ry0, 'bx')
                    plt.plot(rx1, ry1, 'g+')
                    plt.plot(rx2, ry2, 'mx')
                    plt.plot(rx3, ry3, 'r+')
                    ps.savefig()
                
                    plt.axis([x0, x0+500, y0, y0+500])
                    ps.savefig()
                
                    II,d = match(np.vstack((x,y)).T, np.vstack((rx1,ry1)).T, R)
                    I = II[:,0]
                    J = II[:,1]
                    
                    plt.clf()
                    plothist(x[I]-rx1[J], y[I]-ry1[J], 200, **pa)
                    plt.title('Source positions - Reference positions (SIP WCS)')
                    plt.xlabel('delta-X (pixels)')
                    plt.ylabel('delta-Y (pixels)')
                    ps.savefig()
                
                
                def readSourcesFromXyTable(xyfn):
                    '''
                    Read sources from a plain FITS table of x,y,flux and put
                    into an afw Catalog.
                    '''
                    P = pyfits.open(xyfn)[1].data
                    x = P['x']
                    y = P['y']
                    f = P['flux']
                    srcSchema = afwTable.SourceTable.makeMinimalSchema()
                    key = srcSchema.addField("centroid", type="PointD")
                    srcSchema.addField("centroid.flags", type="Flag")
                    srcSchema.addField("centroid.err", type="CovPointF")
                    fkey = srcSchema.addField("flux", type=float)
                    srcTable = afwTable.SourceTable.make(srcSchema)
                    srcTable.defineCentroid("centroid")
                    srcTable.definePsfFlux("flux")
                    srcs = afwTable.SourceCatalog(srcTable)
                    for xi,yi,fi in zip(x,y,f):
                        src = srcs.addNew()
                        if not (np.isfinite(xi) and np.isfinite(yi)):
                            continue
                        src.set(key.getX(), xi)
                        src.set(key.getY(), yi)
                        src.set(fkey, fi)
                    return srcs
                    
                if __name__ == '__main__':
                    mydir = os.path.dirname(__file__)
                    # fitscopy coaddSources.fits"[col x=centroid_sdss[1]; y=centroid_sdss[2]; flux=flux_psf]" xy.fits
                    xyfn = os.path.join(mydir, 'xy2710.fits')
                    sources = readSourcesFromXyTable(xyfn)
                
                    x0,y0 = 335750, 223750
                    W,H = 8500, 12500
                    filterName = 'i'    
                
                    # Read original WCS
                    fn = os.path.join(mydir, 't2710.wcs')
                    hdr = afwImage.readMetadata(fn)
                    wcs0 = afwImage.makeWcs(hdr)
                
                    anddir = os.path.join(mydir, 'astrometry_net_data', 'ticket2710')
                
                    plotPrefix = 't2710'
                
                    showSipSolutions(sources, wcs0, anddir, x0, y0, W, H, filterName,
                                     plotPrefix)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="ac5b43c6"/></a>ac5b43c6</h3>

<pre>
commit ac5b43c6ec85b6579195df58b85c2458974fc208
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Mar 1 14:20:42 2013 -0500

    add a function to create a SIP from a grid of correspondences
</pre>
<h3><a name="82f887fc"/></a>82f887fc</h3>

<pre>
commit 82f887fcf1fe72d3fe569699fea2829962129c41
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Wed Mar 13 16:36:12 2013 -0400

    refactor and add comments to examples/ticket2710.py
</pre>
<h3><a name="f4fc7d83"/></a>f4fc7d83</h3>

<pre>
commit f4fc7d831ccd11a80701a5cfd2f33fa6c4f37a83
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Mar 1 14:41:56 2013 -0500

    tweak the plots
</pre>
<h3><a name="6b4d4ff5"/></a>6b4d4ff5</h3>

<pre>
commit 6b4d4ff5c6f741e62a7aca10c484cf874de9fc7f
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Mar 1 12:13:27 2013 -0500

    start building test case for Andy's issue
</pre>
<h3><a name="ae4149f5"/></a>ae4149f5</h3>

<pre>
commit ae4149f505e851b3a2888984cc34418b86182e97
Author: Dustin Lang <dstndstn@gmail.com>
Date:   Fri Mar 1 13:38:39 2013 -0500

    plot matches found by TAN and SIP solutions
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="7c80bc64"/></a>7c80bc64</h3>

<pre>
commit 7c80bc64e3f110a0e0225885dc4452b7f4e6d3d2
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Apr 14 16:28:37 2015 -0700

    Made ANetAstrometryTask return reference stars using the new schema
    
    Renamed Astrometry to ANetAstrometryBasicTask and renamed the module accordingly.
    Renamed MeasAstromConfig to ANetAstrometryBasicConfig and moved it into the same file.
    Stopped importing the module astrom into lsst.meas.astrom (its symbols were
    and still are imported into lsst.meas.astrom).
    Modified ANetAstrometryBasicTask to use LoadAstrometryNetObjectsTask,
    thus getting rid of a lot of duplicate code.
    Modified LoadAstrometryNetObjectsTask to use the new interface:
    loadPixelBox and loadSkyCircle instead of loadObjectsInBBox and _loadObjectsInCircle.
    Updated the unit tests accordingly.
    Removed deprecated method ANetAstrometryBasicTask.getCatalogFilterName.
    Removed redundant unit tests.
    Removed unused imports from unit tests.
    
    Bug fix
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_50"><a name="src/sip/CreateWcsWithSip.cc"/></a>src/sip/CreateWcsWithSip.cc</h1>

<h3 id="toc_51">Diff:</h3>

<pre>
                // -*- LSST-C++ -*-
                
                /* 
                 * LSST Data Management System
                 * Copyright 2008, 2009, 2010 LSST Corporation.
                 * 
                 * This product includes software developed by the
                 * LSST Project (http://www.lsst.org/).
                 *
                 * This program is free software: you can redistribute it and/or modify
                 * it under the terms of the GNU General Public License as published by
                 * the Free Software Foundation, either version 3 of the License, or
                 * (at your option) any later version.
                 * 
                 * This program is distributed in the hope that it will be useful,
                 * but WITHOUT ANY WARRANTY; without even the implied warranty of
                 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                 * GNU General Public License for more details.
                 * 
                 * You should have received a copy of the LSST License Statement and 
                 * the GNU General Public License along with this program.  If not, 
                 * see <http://www.lsstcorp.org/LegalNotices/>.
                 */
                 
                
                #include "Eigen/SVD"
                #include "Eigen/Cholesky"
                #include "Eigen/LU"
                
                #include "lsst/pex/exceptions/Runtime.h"
                #include "lsst/meas/astrom/sip/CreateWcsWithSip.h"
                #include "lsst/afw/math/Statistics.h"
                #include "lsst/afw/image/TanWcs.h"
                #include "lsst/pex/logging/Log.h"
                
                namespace lsst { 
                namespace meas { 
                namespace astrom { 
                namespace sip {
                
                namespace except   = lsst::pex::exceptions;
                namespace afwCoord = lsst::afw::coord;
                namespace afwGeom  = lsst::afw::geom;
                namespace afwImg   = lsst::afw::image;
                namespace afwDet   = lsst::afw::detection;
                namespace afwMath  = lsst::afw::math;
                namespace afwTable = lsst::afw::table;
                namespace pexLog   = lsst::pex::logging;
                
                namespace {
                /*
                 * Given an index and a SIP order, calculate p and q for the index'th term u^p v^q
                 * (Cf. Eqn 2 in http://fits.gsfc.nasa.gov/registry/sip/SIP_distortion_v1_0.pdf)
                 */
                std::pair<int, int>
                indexToPQ(int const index, int const order)
                {
                    int p = 0, q = index;
                    
                    for (int decrement = order; q >= decrement && decrement > 0; --decrement) {
                        q -= decrement;
                        p++;
                    }
                    
                    return std::make_pair(p, q);
                }
                
                Eigen::MatrixXd
                calculateCMatrix(Eigen::VectorXd const& axis1, Eigen::VectorXd const& axis2, int const order)
                {
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#792ba440">792ba440</a> +     int nTerms = 0.5*order*(order+1);</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
71   <a href="#6b967273">6b967273</a> -     int nTerms = 0;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#6b967273">6b967273</a> -     for (int i = 1; i <= order; ++i) {</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#6b967273">6b967273</a> -         nTerms += i;</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
74   <a href="#6b967273">6b967273</a> -     }</div>
                
                    int const n = axis1.size();
                    Eigen::MatrixXd C = Eigen::MatrixXd::Zero(n, nTerms);
                    for (int i = 0; i < n; ++i) {
                        for (int j = 0; j < nTerms; ++j) {
                            std::pair<int, int> pq = indexToPQ(j, order);
                            int p = pq.first, q = pq.second;
                
                            assert(p + q < order);
                            C(i, j) = ::pow(axis1[i], p)*::pow(axis2[i], q);
                        }
                    }
                    
                    return C;
                }
                    
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
91   <a href="#e444d849">e444d849</a> - </div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
92   <a href="#e444d849">e444d849</a> - </div>
                ///Given a vector b and a matrix A, solve b - Ax = 0
                /// b is an m x 1 vector, A is an n x m matrix, and x, the output is a 
                ///\param b An m x 1 vector, where m is the number of parameters in the fit
                ///\param A An n x m vecotr, where n is the number of equations in the solution
                ///
                ///\returns x, an m x 1 vector of best fit params
                Eigen::VectorXd
                leastSquaresSolve(Eigen::VectorXd b, Eigen::MatrixXd A) {
                    assert(A.rows() == b.rows());
                    Eigen::VectorXd par = A.jacobiSvd(Eigen::ComputeThinU | Eigen::ComputeThinV).solve(b);
                    return par;
                }
                
                } // anonymous namespace
                
                ///Constructor
                template<class MatchT>
                CreateWcsWithSip<MatchT>::CreateWcsWithSip(
                    std::vector<MatchT> const & matches,
                    afwImg::Wcs const& linearWcs,
                    int const order,
                    afwGeom::Box2I const& bbox,
                    int const ngrid
                ):
                    _log(pexLog::Log(pexLog::Log::getDefaultLog(), "meas.astrom.sip")),
                    _matches(matches),
                    _bbox(bbox),
                    _ngrid(ngrid),
                    _linearWcs(linearWcs.clone()),
                    _sipOrder(order+1),
                    _reverseSipOrder(order+2), //Higher order for reverse transform
                    _sipA(Eigen::MatrixXd::Zero(_sipOrder, _sipOrder)),
                    _sipB(Eigen::MatrixXd::Zero(_sipOrder, _sipOrder)),
                    _sipAp(Eigen::MatrixXd::Zero(_reverseSipOrder, _reverseSipOrder)),
                    _sipBp(Eigen::MatrixXd::Zero(_reverseSipOrder, _reverseSipOrder)),
                    _newWcs()
                {
                    if  (order < 2) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
131  <a href="#4d3b19ee">4d3b19ee</a> -         throw LSST_EXCEPT(except::OutOfRangeException, "SIP must be at least 2nd order");        </div>
              ?                                              ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
126  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::OutOfRangeError, "SIP must be at least 2nd order");        </div>
              ?                                              ^^ ^
                    }
                    if (_sipOrder > 9) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#4d3b19ee">4d3b19ee</a> -         throw LSST_EXCEPT(except::OutOfRangeException,</div>
              ?                                              ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
129  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::OutOfRangeError,</div>
              ?                                              ^^ ^
                                          str(boost::format("SIP forward order %d exceeds the convention limit of 9") %
                                              _sipOrder));
                    }
                    if (_reverseSipOrder > 9) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
139  <a href="#4d3b19ee">4d3b19ee</a> -         throw LSST_EXCEPT(except::OutOfRangeException,</div>
              ?                                              ^^^^^^ ^
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
134  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::OutOfRangeError,</div>
              ?                                              ^^ ^
                                          str(boost::format("SIP reverse order %d exceeds the convention limit of 9") %
                                              _reverseSipOrder));
                    }
                    
                    if (_matches.size() < std::size_t(_sipOrder)) {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
145  <a href="#4d3b19ee">4d3b19ee</a> -         throw LSST_EXCEPT(except::LengthErrorException, "Number of matches less than requested sip order");</div>
              ?                                              ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
140  <a href="#3896b32c">3896b32c</a> +         throw LSST_EXCEPT(except::LengthError, "Number of matches less than requested sip order");</div>
                    }
                
                    if (_ngrid <= 0) {
                        _ngrid = 5*_sipOrder;           // should be plenty
                    }
                
                    /*
                     * We need a bounding box to define the region over which:
                     *    The forward transformation should be valid
                     *    We calculate the reverse transformartion
                     * If no BBox is provided, guess one from the input points (extrapolated a bit to allow for fact
                     * that a finite number of points won't reach to the edge of the image)
                     */
                    if (_bbox.isEmpty() && !_matches.empty() > 0) {
                        for (
                            typename std::vector<MatchT>::const_iterator ptr = _matches.begin();
                            ptr != _matches.end();
                            ++ptr
                        ) {
                            afwTable::SourceRecord const & src = *ptr->second;
                            _bbox.include(afwGeom::PointI(src.getX(), src.getY()));
                        }
                        float const borderFrac = 1/::sqrt(_matches.size()); // fractional border to add to exact BBox
                        afwGeom::Extent2I border(borderFrac*_bbox.getWidth(), borderFrac*_bbox.getHeight());
                
                        _bbox.grow(border);
                    }
                    // Calculate the forward part of the SIP distortion
                    _calculateForwardMatrices();
                
                    //Build a new wcs incorporating the forward sip matrix, it's all we know so far
                    afwGeom::Point2D crval = _getCrvalAsGeomPoint();
                    afwGeom::Point2D crpix = _linearWcs->getPixelOrigin();
                    Eigen::MatrixXd CD = _linearWcs->getCDMatrix();
                    
                    _newWcs = PTR(afwImg::TanWcs)(new afwImg::TanWcs(crval, crpix, CD, _sipA, _sipB, _sipAp, _sipBp));
                    // Use _newWcs to calculate the forward transformation on a grid, and derive the back transformation
                    _calculateReverseMatrices();
                
                    //Build a new wcs incorporating both of the sip matrices
                    _newWcs = PTR(afwImg::TanWcs)(new afwImg::TanWcs(crval, crpix, CD, _sipA, _sipB, _sipAp, _sipBp));
                
                }
                
                template<class MatchT>
                void
                CreateWcsWithSip<MatchT>::_calculateForwardMatrices()
                {
                    // Assumes FITS (1-indexed) coordinates.
                    afwGeom::Point2D crpix = _linearWcs->getPixelOrigin();
                
                    // Calculate u, v and intermediate world coordinates
                    int const nPoints = _matches.size();
                    Eigen::VectorXd u(nPoints), v(nPoints), iwc1(nPoints), iwc2(nPoints);
                
                    int i = 0;
                    for (
                        typename std::vector<MatchT>::const_iterator ptr = _matches.begin();
                        ptr != _matches.end();
                        ++ptr, ++i
                    ) {
                        afwTable::ReferenceMatch const & match = *ptr;
                
                        // iwc: intermediate world coordinate positions of catalogue objects
                        afwCoord::IcrsCoord c = match.first->getCoord();
                        afwGeom::Point2D p = _linearWcs->skyToIntermediateWorldCoord(c);
                        iwc1[i] = p[0];
                        iwc2[i] = p[1];
                        // u and v are intermediate pixel coordinates of observed (distorted) positions
                        u[i] = match.second->getX() - crpix[0];
                        v[i] = match.second->getY() - crpix[1];
                    }
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#011279a7">011279a7</a> -     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
213  <a href="#792ba440">792ba440</a> +     // Scale u and v down to [-1,,+1] in order to avoid too large numbers in the polynomials</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
214  <a href="#792ba440">792ba440</a> +     double uMax = u.cwiseAbs().maxCoeff();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
215  <a href="#792ba440">792ba440</a> +     double vMax = v.cwiseAbs().maxCoeff();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
216  <a href="#792ba440">792ba440</a> +     double norm = std::max(uMax, vMax);</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
217  <a href="#792ba440">792ba440</a> +     u = u/norm;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
218  <a href="#792ba440">792ba440</a> +     v = v/norm;</div>
                   
                    // Forward transform
                    int ord = _sipOrder;
                    Eigen::MatrixXd forwardC = calculateCMatrix(u, v, ord);
                    Eigen::VectorXd mu = leastSquaresSolve(iwc1, forwardC);
                    Eigen::VectorXd nu = leastSquaresSolve(iwc2, forwardC);
                
                    // Use mu and nu to refine CD
                
                    // Given the implementation of indexToPQ(), the refined values
                    // of the elements of the CD matrices are in elements 1 and "_sipOrder" of mu and nu
                    // If the implementation of indexToPQ() changes, these assertions
                    // will catch that change.
                    assert ((indexToPQ(0,   ord) == std::pair<int, int>(0, 0)));
                    assert ((indexToPQ(1,   ord) == std::pair<int, int>(0, 1)));
                    assert ((indexToPQ(ord, ord) == std::pair<int, int>(1, 0)));
                
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
236  <a href="#792ba440">792ba440</a> +     // Scale back CD matrix</div>
                    Eigen::Matrix2d CD;
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
237  <a href="#c5b66ebb">c5b66ebb</a> -     CD(1,0) = nu[ord];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#792ba440">792ba440</a> +     CD(1,0) = nu[ord]/norm;</div>
              ?                      +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
238  <a href="#011279a7">011279a7</a> -     CD(1,1) = nu[1];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#792ba440">792ba440</a> +     CD(1,1) = nu[1]/norm;</div>
              ?                    +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
239  <a href="#011279a7">011279a7</a> -     CD(0,0) = mu[ord];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#792ba440">792ba440</a> +     CD(0,0) = mu[ord]/norm;</div>
              ?                      +++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
240  <a href="#c5b66ebb">c5b66ebb</a> -     CD(0,1) = mu[1];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
241  <a href="#792ba440">792ba440</a> +     CD(0,1) = mu[1]/norm;</div>
              ?                    +++++
                
                    Eigen::Matrix2d CDinv = CD.inverse();   //Direct inverse OK for 2x2 matrix in Eigen
                
                    // The zeroth elements correspond to a shift in crpix
                    crpix[0] -= mu[0]*CDinv(0,0) + nu[0]*CDinv(0,1); 
                    crpix[1] -= mu[0]*CDinv(1,0) + nu[0]*CDinv(1,1);
                
                    afwGeom::Point2D crval = _getCrvalAsGeomPoint();
                
                    _linearWcs = afwImg::Wcs::Ptr( new afwImg::Wcs(crval, crpix, CD));
                
                    //Get Sip terms
                    
                    //The rest of the elements correspond to
                    //mu[i] == CD11*Apq + CD12*Bpq and
                    //nu[i] == CD21*Apq + CD22*Bpq and
                    //
                    //We solve for Apq and Bpq with the equation
                    // (Apq)  = (CD11 CD12)-1  * (mu[i])  
                    // (Bpq)    (CD21 CD22)      (nu[i])
                    
                    for(int i=1; i< mu.rows(); ++i) {
                        std::pair<int, int> pq = indexToPQ(i, ord);
                        int p = pq.first, q = pq.second;
                
                        if(p + q > 1 && p + q < ord) {    
                            Eigen::Vector2d munu(2,1);
                            munu(0) = mu(i);
                            munu(1) = nu(i);
                            Eigen::Vector2d AB = CDinv*munu;
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#792ba440">792ba440</a> +             // Scale back sip coefficients</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
271  <a href="#011279a7">011279a7</a> -             _sipA(p,q) = AB[0];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
273  <a href="#792ba440">792ba440</a> +             _sipA(p,q) = AB[0]/::pow(norm,p+q);</div>
              ?                               ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
272  <a href="#011279a7">011279a7</a> -             _sipB(p,q) = AB[1];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
274  <a href="#792ba440">792ba440</a> +             _sipB(p,q) = AB[1]/::pow(norm,p+q);</div>
              ?                               ++++++++++++++++
                        }
                    }
                }
                
                template<class MatchT>
                void CreateWcsWithSip<MatchT>::_calculateReverseMatrices() {
                    int const ngrid2 = _ngrid*_ngrid;
                
                    Eigen::VectorXd U(ngrid2), V(ngrid2);
                    Eigen::VectorXd delta1(ngrid2), delta2(ngrid2);
                    
                    int const x0 = _bbox.getMinX();
                    double const dx = _bbox.getWidth()/(double)(_ngrid - 1);
                    int const y0 = _bbox.getMinY();
                    double const dy = _bbox.getHeight()/(double)(_ngrid - 1);
                
                    // wcs->getPixelOrigin() returns LSST-style (0-indexed) pixel coords.
                    afwGeom::Point2D crpix = _newWcs->getPixelOrigin();
                
                    _log.debugf("_calcReverseMatrices: x0,y0 %i,%i, W,H %i,%i, ngrid %i, dx,dy %g,%g, CRPIX %g,%g",
                                x0, y0, _bbox.getWidth(), _bbox.getHeight(), _ngrid, dx, dy, crpix[0], crpix[1]);
                
                    int k = 0;
                    for (int i = 0; i < _ngrid; ++i) {
                        double const y = y0 + i*dy;
                        for (int j = 0; j < _ngrid; ++j, ++k) {
                            double const x = x0 + j*dx;
                            double u,v;
                            // u and v are intermediate pixel coordinates on a grid of positions
                            u = x - crpix[0];
                            v = y - crpix[1];
                
                            // U and V are the result of applying the "forward" (A,B) SIP coefficients
                            // NOTE that the "undistortPixel()" function accepts 1-indexed (FITS-style)
                            // coordinates, and here we are treating "x" and "y" as LSST-style.
                            afwGeom::Point2D xy = _newWcs->undistortPixel(afwGeom::Point2D(x + 1, y + 1));
                            // "crpix", on the other hand, is LSST-style 0-indexed, so we have to remove
                            // the FITS-style 1-index from "xy"
                            U[k] = xy[0] - 1 - crpix[0];
                            V[k] = xy[1] - 1 - crpix[1];
                
                            if ((i == 0 || i == (_ngrid-1) || i == (_ngrid/2)) &&
                                (j == 0 || j == (_ngrid-1) || j == (_ngrid/2))) {
                                _log.debugf("  x,y (%.1f, %.1f), u,v (%.1f, %.1f), U,V (%.1f, %.1f)", x, y, u, v, U[k], V[k]);
                            }
                
                            delta1[k] = u - U[k];
                            delta2[k] = v - V[k];
                        }
                    }
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
325  <a href="#792ba440">792ba440</a> +     </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
326  <a href="#792ba440">792ba440</a> +     // Scale down U and V in order to avoid too large numbers in the polynomials</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
327  <a href="#792ba440">792ba440</a> +     double UMax = U.cwiseAbs().maxCoeff();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
328  <a href="#792ba440">792ba440</a> +     double VMax = V.cwiseAbs().maxCoeff();</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
329  <a href="#792ba440">792ba440</a> +     double norm = (UMax > VMax) ? UMax : VMax;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
330  <a href="#792ba440">792ba440</a> +     U = U/norm;</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
331  <a href="#792ba440">792ba440</a> +     V = V/norm;</div>
                
                    // Reverse transform
                    int const ord = _reverseSipOrder;
                    Eigen::MatrixXd reverseC = calculateCMatrix(U, V, ord); 
                    Eigen::VectorXd tmpA = leastSquaresSolve(delta1, reverseC);
                    Eigen::VectorXd tmpB = leastSquaresSolve(delta2, reverseC);
                    
                    assert(tmpA.rows() == tmpB.rows());
                    for(int j=0; j< tmpA.rows(); ++j) {
                        std::pair<int, int> pq = indexToPQ(j, ord);
                        int p = pq.first, q = pq.second;
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
343  <a href="#792ba440">792ba440</a> +         // Scale back sip coefficients</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
334  <a href="#6b967273">6b967273</a> -         _sipAp(p, q) = tmpA[j];</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
344  <a href="#792ba440">792ba440</a> +         _sipAp(p, q) = tmpA[j]/::pow(norm,p+q);</div>
              ?                               ++++++++++++++++
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
335  <a href="#6b967273">6b967273</a> -         _sipBp(p, q) = tmpB[j];   </div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
345  <a href="#792ba440">792ba440</a> +         _sipBp(p, q) = tmpB[j]/::pow(norm,p+q);   </div>
              ?                               ++++++++++++++++
                    } 
                }
                
                template<class MatchT>
                double CreateWcsWithSip<MatchT>::getScatterInPixels() {
                    assert(_newWcs.get());
                    return _getScatterPixels(*_newWcs, _matches);
                }
                
                template<class MatchT>
                double CreateWcsWithSip<MatchT>::getLinearScatterInPixels() {
                    assert(_linearWcs.get());
                    return _getScatterPixels(*_linearWcs, _matches);
                }
                
                template<class MatchT>
                double CreateWcsWithSip<MatchT>::_getScatterPixels(
                    afwImg::Wcs const& wcs,
                    std::vector<MatchT> const & matches) {
                    std::vector<double> val;
                    val.reserve(matches.size());
                
                    for (
                        typename std::vector<MatchT>::const_iterator ptr = matches.begin();
                        ptr != matches.end();
                        ++ptr
                    ) {
                        afwTable::ReferenceMatch const & match = *ptr;
                        PTR(afwTable::SimpleRecord) cat = match.first;
                        PTR(afwTable::SourceRecord) src = match.second;
                        double imgX = src->getX();
                        double imgY = src->getY();
                        afwGeom::Point2D xy = wcs.skyToPixel(cat->getCoord());
                        double catX = xy[0];
                        double catY = xy[1];
                        val.push_back(::hypot(imgX - catX, imgY - catY));
                   }
                    return afwMath::makeStatistics(val, afwMath::MEDIAN).getValue();
                }
                    
                
                template<class MatchT>
                afwGeom::Angle CreateWcsWithSip<MatchT>::getScatterOnSky() {
                    assert(_newWcs.get());
                    return _getScatterSky(*_newWcs, _matches);
                }
                
                template<class MatchT>
                afwGeom::Angle CreateWcsWithSip<MatchT>::getLinearScatterOnSky() {
                    assert(_linearWcs.get());
                    return _getScatterSky(*_linearWcs, _matches);
                }
                
                template<class MatchT>
                afwGeom::Angle CreateWcsWithSip<MatchT>::_getScatterSky(
                    afwImg::Wcs const & wcs,
                    std::vector<MatchT> const & matches) {
                    std::vector<double> val;
                    val.reserve(matches.size());
                
                    for (
                        typename std::vector<MatchT>::const_iterator ptr = matches.begin();
                        ptr != matches.end();
                        ++ptr
                    ) {
                        afwTable::ReferenceMatch const & match = *ptr;
                        PTR(afwTable::SimpleRecord) cat = match.first;
                        PTR(afwTable::SourceRecord) src = match.second;
                        afwCoord::IcrsCoord catRadec = cat->getCoord();
                        CONST_PTR(afwCoord::Coord) imgRadec = wcs.pixelToSky(src->getCentroid());
                        afwGeom::Angle sep = catRadec.angularSeparation(*imgRadec);
                        val.push_back(sep.asDegrees());
                    }
                    assert(val.size() > 0);
                    return afwMath::makeStatistics(val, afwMath::MEDIAN).getValue()*afwGeom::degrees;
                }
                
                
                template<class MatchT>
                afwGeom::Point2D CreateWcsWithSip<MatchT>::_getCrvalAsGeomPoint() {
                    afwCoord::Fk5Coord coo = _linearWcs->getSkyOrigin()->toFk5();
                    return coo.getPosition(afwGeom::degrees);
                }
                
                
                #define INSTANTIATE(MATCH) \
                    template class CreateWcsWithSip<MATCH>;
                
                INSTANTIATE(afwTable::ReferenceMatch);
                INSTANTIATE(afwTable::SourceMatch);
                
                }}}}
                
                
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="6b967273"/></a>6b967273</h3>

<pre>
commit 6b9672730d96308bceb3356c7c8a6e1636f05983
Author: Robert Lupton the Good <rhl@astro.princeton.edu>
Date:   Thu Jan 26 14:56:19 2012 -0500

    Cleaned up code, removing things from class scope where possible.
    
    Made C++ more idiomatic and removed some duplication
</pre>
<h3><a name="e444d849"/></a>e444d849</h3>

<pre>
commit e444d849b448a728d422da66e34fd76c35f28305
Author: fergal <fergal@git.lsstcorp.org>
Date:   Thu Oct 29 15:48:40 2009 +0000

    Scratch code to create a Wcs with sip terms. Eventually this should become a class
</pre>
<h3><a name="c5b66ebb"/></a>c5b66ebb</h3>

<pre>
commit c5b66ebba1f30702d8060bf8188388e2a7760918
Author: taxelrod <taxelrod@git.lsstcorp.org>
Date:   Sat Jun 19 22:30:42 2010 +0000

    Fixed bug in CreateWcsWithSip; made test testCreateWcsWithSip sane
</pre>
<h3><a name="011279a7"/></a>011279a7</h3>

<pre>
commit 011279a704fc6d5a0a19426a15332e4897431eb1
Author: fergal <fergal@git.lsstcorp.org>
Date:   Wed Jun 16 23:51:40 2010 +0000

    CreateWcsWithSip now returns a reverse matrix one order greater than forward
</pre>
<h3><a name="4d3b19ee"/></a>4d3b19ee</h3>

<pre>
commit 4d3b19ee19440ade6a8d2d4e96832268765d1299
Author: Paul Price <price@astro.princeton.edu>
Date:   Fri Aug 2 11:18:18 2013 -0400

    CreateWcsWithSip: sytematize exceptions
    
    Choice of exception classes wasn't indicative of what's going on.
    * One RuntimeErrorException should be an assert (should never happen,
      indicates misuse of internal interface).
    * Made exceptions that indicate bad input parameters into
      OutOfRangeException.
    * Made exceptions that indicate problem with the data (insufficient
      to solve) into LengthErrorException.
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="792ba440"/></a>792ba440</h3>

<pre>
commit 792ba440d2c48aeea682948aafbb6fb29e356029
Author: Dominique Boutigny <boutigny@in2p3.fr>
Date:   Mon May 11 15:14:12 2015 -0700

    Scale pixel values to [-1,+1] in order to avoid too large values in polynomials, then scale back SIP coefficients after ftting
    
    response to review - minor change
    
    new unit test to check TAN-SIP fitter stability with high order polynomials
</pre>
<h3><a name="3896b32c"/></a>3896b32c</h3>

<pre>
commit 3896b32c251699b470ff0df37c13ab013fce21b6
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jun 17 16:17:01 2014 -0700

    Renamed exceptions
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_52"><a name="tests/lsf2d.py"/></a>tests/lsf2d.py</h1>

<h3 id="toc_53">Diff:</h3>

<pre>
                #!/usr/bin/env python
                
                # 
                # LSST Data Management System
                # Copyright 2008, 2009, 2010 LSST Corporation.
                # 
                # This product includes software developed by the
                # LSST Project (http://www.lsst.org/).
                #
                # This program is free software: you can redistribute it and/or modify
                # it under the terms of the GNU General Public License as published by
                # the Free Software Foundation, either version 3 of the License, or
                # (at your option) any later version.
                # 
                # This program is distributed in the hope that it will be useful,
                # but WITHOUT ANY WARRANTY; without even the implied warranty of
                # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                # GNU General Public License for more details.
                # 
                # You should have received a copy of the LSST License Statement and 
                # the GNU General Public License along with this program.  If not, 
                # see <http://www.lsstcorp.org/LegalNotices/>.
                #
                
                import re
                import os
                import glob
                import math
                import pdb                          # we may want to say pdb.set_trace()
                import unittest
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
32   <a href="#4e00bea4">4e00bea4</a> - import eups</div>
                import lsst.afw.image as afwImage
                import lsst.utils.tests as utilsTests
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#4e00bea4">4e00bea4</a> - import lsst.afw.image.imageLib as img</div>
              ?                      ---------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
34   <a href="#c6b97345">c6b97345</a> + import lsst.afw.image as img</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#4e00bea4">4e00bea4</a> - import lsst.afw.detection.detectionLib as detect</div>
              ?                          -------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
35   <a href="#c6b97345">c6b97345</a> + import lsst.afw.detection as detect</div>
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
37   <a href="#4e00bea4">4e00bea4</a> - import lsst.pex.exceptions.exceptionsLib as exception</div>
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
36   <a href="#c6b97345">c6b97345</a> + import lsst.pex.exceptions</div>
                
                import lsst.meas.astrom.sip as sip
                
                
                class Lsf2dTestCase(unittest.TestCase):
                    def setUp(self):
                        pass
                
                    def tearDown(self):
                        pass
                
                    def testBadArgs1(self):
                        """Check that code fails when order is too low"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [535, 929, 623, 602]
                        z = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=0
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
59   <a href="#4e00bea4">4e00bea4</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
58   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                        
                
                    def testBadArgs2(self):
                        """Check that code fails when not len(x) != len(y)"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [535, 929, 623]
                        z = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=2
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
73   <a href="#4e00bea4">4e00bea4</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
72   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                    def testBadArgs3(self):
                        """Check that code fails when not len(x) != len(s)"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [535, 929, 623, 602]
                        z = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1,1]
                        
                        order=0
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
86   <a href="#4e00bea4">4e00bea4</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
85   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                
                    def testBadArgs4(self):
                        """Check that code fails when not order > number data points"""
                        
                        x = [630, 1000, 1205, 1427]
                        y = [535, 929, 623, 602]
                        z = [.622, 1.109, 1.198, 1.429]
                        s = [1,1,1,1]
                        
                        order=5
                
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
100  <a href="#4e00bea4">4e00bea4</a> -         self.assertRaises(exception.LsstCppException,</div>
              ?                                     -------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
99   <a href="#c6b97345">c6b97345</a> +         self.assertRaises(lsst.pex.exceptions.Exception,</div>
              ?                           +++++++++         +
                            sip.LeastSqFitter1dPoly, x, y,s,order )
                
                    def testFitLinearXSurface2(self):
                        """Python equivalent of C++ test case"""
                        
                        x=[599.59899999999993, 1172.7726619709097, 512.51199999999994, 1083.6078436082901]
                        y=[512.0, 539.77214401699996, 541.0, 562.09371856300004]
                        z=[0.5989999999999327, 1.1716010609097793, 0.51199999999994361, 1.0825253182899814]
                        s=[.1,.1,.1,.1]
                        
                        print " "
                        lsf = sip.LeastSqFitter2dPoly(x, y, z, s, 2)
                        print lsf.getParams()
                        
                        print "Output:"
                        for i in range(len(x)):
                            print x[i], y[i], z[i], lsf.valueAt(x[i], y[i])
                            self.assertAlmostEqual(z[i], lsf.valueAt(x[i], y[i]))
                                
                
                #-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
                
                
                
                def suite():
                    """Returns a suite containing all the test cases in this module."""
                    utilsTests.init()
                
                    suites = []
                    suites += unittest.makeSuite(Lsf2dTestCase)
                    suites += unittest.makeSuite(utilsTests.MemoryTestCase)
                
                    return unittest.TestSuite(suites)
                
                def run(exit=False):
                    """Run the tests"""
                    utilsTests.run(suite(), exit)
                 
                if __name__ == "__main__":
                    run(True)
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="4e00bea4"/></a>4e00bea4</h3>

<pre>
commit 4e00bea4a7f86f01dae98288b89a3fc4f6b9419a
Author: fergal <fergal@git.lsstcorp.org>
Date:   Tue Oct 6 18:24:28 2009 +0000

    Some tests for LeastSqFitter2d
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="c6b97345"/></a>c6b97345</h3>

<pre>
commit c6b973451ae948d29b6fb9418d17ed232eda1a0f
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Fri Jul 18 13:16:44 2014 -0400

    Adapt to changes in exception Python wrappers (DM-827)
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<h1 id="toc_54"><a name="ups/meas_astrom.cfg"/></a>ups/meas_astrom.cfg</h1>

<h3 id="toc_55">Diff:</h3>

<pre>
                # -*- python -*-
                
                import lsst.sconsUtils
                
                dependencies = {
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#4212a154">4212a154</a> -     "required": ["utils", "cfitsio", "wcslib", "xpa", "minuit2", "afw", "astrometry_net", "eigen",</div>
              ?                           ---------------------------------------
<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
6    <a href="#eb937b8d">eb937b8d</a> +     "required": ["utils", "afw", "astrometry_net", "eigen"],</div>
              ?                                                           +
<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">
7    <a href="#27ffb28c">27ffb28c</a> -                  "pex_config", "pipe_base"],</div>
                    "buildRequired": ["boost_test", "swig"],
                }
                
                config = lsst.sconsUtils.Configuration(
                    __file__,
                    headers=["lsst/meas/astrom.h"],
                    hasDoxygenInclude=False,
                    hasSwigFiles=True,
                )
</pre>

<p><a href="#homelist">Return to list</a></p>

<div style="background-color:Khaki; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_hsc/meas_astrom/</h2>
<h3><a name="27ffb28c"/></a>27ffb28c</h3>

<pre>
commit 27ffb28c6b34229abbba7dbbddd84ca437ec1669
Author: Jim Bosch <jbosch@astro.princeton.edu>
Date:   Mon Feb 27 12:36:07 2012 -0500

    rewrote photocal to work with new source; tests are not as complete as they once were, but fixing the old ones would have been harder than writing new ones
</pre>
<h3><a name="4212a154"/></a>4212a154</h3>

<pre>
commit 4212a154857e5476940347a7ab1e52235b6ebaaa
Author: Paul Price <price@astro.princeton.edu>
Date:   Thu Feb 9 10:26:57 2012 -0500

    Require pex_config
</pre>
</div>

<div style="background-color:LightBlue; margin-left: 20px; margin-right: 20px; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;">

<h2>Commits in /Users/nate/repos_lsst/meas_astrom/</h2>
<h3><a name="eb937b8d"/></a>eb937b8d</h3>

<pre>
commit eb937b8de2fc2c5809f2acd3fe092daf4685093f
Author: Russell Owen <rowen@uw.edu>
Date:   Tue Jan 27 10:17:13 2015 -0800

    Implement new astrometry, loader, matcher and fitter tasks
    
    Implement new astrometry task that uses three subtasks:
    - a reference object loader
    - a reference object to source matcher
    - a WCS fitter
    Implement an abstract base class for reference object loaders
    Implement a reference object loader using astrometry.net
    Implement a matcher using hscAstrom's matcher, which is, in turn,
      base on Tabur's Optimistic Pattern Matching B
    Implement a WCS fitter wrapper around the existing TAN-SIP WCS fitter
    Implement unit tests
    Apply simple improvments based on Jim's review
    
    Fix a bug in tests/testFitTanSipWcsTask.py
    
    Clean up the code as per Jim's review comments.
    
    Remove unused method of test class
    
    Add a plotter to testMatchOpimisticB.py
    
    Remove doTest=True
    
    Stop using assertWcsEqual from afw, since it's not yet merged.
    
    Other tweaks to unit test
    
    Undo Janskys change (should be a separate commit)
    
    Some cleanups
    
    Import AnetAstrometryTask, fix a bug and standardize names
    
    Switch to Janskys for flux returned by reference object loaders
    
    Revert run signatures and matchList->matches
    
    Change stargal to resolved
    
    Switch to flux<->mag functions in afw.image
    
    Also overhaul the way flux fields are looked up in reference catalogs;
    the reference loader now adds aliases for camera filters
    and there are two free functions to look up the fields based on filter name.
    
    Update matchOptimisticB.py to handle version 0 source catalogs
    
    Update PhotoCal to use new afwImage flux<->mag converter functions
    tests/testPhotoCal still fails, but it's getting closer
    
    More work converting PhotoCal task to using Jy; more to be done
    
    Tweak test to use centroid key
    
    Fix PhotoCal's use of AB magnitudes
    
    Tweak a comment about scaling
    
    Modify PhotoCalTask to use afwMath statistics to estimate src/ref scaling.
    
    Made source flux type configurable in matcher
    
    Fixed examples/photoCalTask
</pre>
</div>

<p><a href="#homelist">Return to list</a></p>

<script type="text/javascript">
self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{};var Prism=function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={util:{encode:function(e){return e instanceof n?new n(e.type,t.util.encode(e.content),e.alias):"Array"===t.util.type(e)?e.map(t.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},clone:function(e){var n=t.util.type(e);switch(n){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=t.util.clone(e[r]));return a;case"Array":return e.map(function(e){return t.util.clone(e)})}return e}},languages:{extend:function(e,n){var a=t.util.clone(t.languages[e]);for(var r in n)a[r]=n[r];return a},insertBefore:function(e,n,a,r){r=r||t.languages;var i=r[e];if(2==arguments.length){a=arguments[1];for(var l in a)a.hasOwnProperty(l)&&(i[l]=a[l]);return i}var s={};for(var o in i)if(i.hasOwnProperty(o)){if(o==n)for(var l in a)a.hasOwnProperty(l)&&(s[l]=a[l]);s[o]=i[o]}return t.languages.DFS(t.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=s)}),r[e]=s},DFS:function(e,n,a){for(var r in e)e.hasOwnProperty(r)&&(n.call(e,r,e[r],a||r),"Object"===t.util.type(e[r])?t.languages.DFS(e[r],n):"Array"===t.util.type(e[r])&&t.languages.DFS(e[r],n,r))}},highlightAll:function(e,n){for(var a,r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'),i=0;a=r[i++];)t.highlightElement(a,e===!0,n)},highlightElement:function(a,r,i){for(var l,s,o=a;o&&!e.test(o.className);)o=o.parentNode;if(o&&(l=(o.className.match(e)||[,""])[1],s=t.languages[l]),s){a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=a.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var u=a.textContent;if(u){u=u.replace(/^(?:\r?\n|\r)/,"");var g={element:a,language:l,grammar:s,code:u};if(t.hooks.run("before-highlight",g),r&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){g.highlightedCode=n.stringify(JSON.parse(e.data),l),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(g.element),t.hooks.run("after-highlight",g)},c.postMessage(JSON.stringify({language:g.language,code:g.code}))}else g.highlightedCode=t.highlight(g.code,g.grammar,g.language),t.hooks.run("before-insert",g),g.element.innerHTML=g.highlightedCode,i&&i.call(a),t.hooks.run("after-highlight",g)}}},highlight:function(e,a,r){var i=t.tokenize(e,a);return n.stringify(t.util.encode(i),r)},tokenize:function(e,n){var a=t.Token,r=[e],i=n.rest;if(i){for(var l in i)n[l]=i[l];delete n.rest}e:for(var l in n)if(n.hasOwnProperty(l)&&n[l]){var s=n[l];s="Array"===t.util.type(s)?s:[s];for(var o=0;o<s.length;++o){var u=s[o],g=u.inside,c=!!u.lookbehind,f=0,h=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var d=r[p];if(r.length>e.length)break e;if(!(d instanceof a)){u.lastIndex=0;var m=u.exec(d);if(m){c&&(f=m[1].length);var y=m.index-1+f,m=m[0].slice(f),v=m.length,k=y+v,b=d.slice(0,y+1),w=d.slice(k+1),N=[p,1];b&&N.push(b);var O=new a(l,g?t.tokenize(m,g):m,h);N.push(O),w&&N.push(w),Array.prototype.splice.apply(r,N)}}}}}return r},hooks:{all:{},add:function(e,n){var a=t.hooks.all;a[e]=a[e]||[],a[e].push(n)},run:function(e,n){var a=t.hooks.all[e];if(a&&a.length)for(var r,i=0;r=a[i++];)r(n)}}},n=t.Token=function(e,t,n){this.type=e,this.content=t,this.alias=n};if(n.stringify=function(e,a,r){if("string"==typeof e)return e;if("Array"===t.util.type(e))return e.map(function(t){return n.stringify(t,a,e)}).join("");var i={type:e.type,content:n.stringify(e.content,a,r),tag:"span",classes:["token",e.type],attributes:{},language:a,parent:r};if("comment"==i.type&&(i.attributes.spellcheck="true"),e.alias){var l="Array"===t.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(i.classes,l)}t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"},!self.document)return self.addEventListener?(self.addEventListener("message",function(e){var n=JSON.parse(e.data),a=n.language,r=n.code;self.postMessage(JSON.stringify(t.util.encode(t.tokenize(r,t.languages[a])))),self.close()},!1),self.Prism):self.Prism;var a=document.getElementsByTagName("script");return a=a[a.length-1],a&&(t.filename=a.src,document.addEventListener&&!a.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)),self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism);
</script>
</body>

</html>
